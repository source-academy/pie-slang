class e{constructor(e,t){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.monaco=e,this.editor=t}async start(){this.worker=new Worker(new URL("./pie-lsp-worker-bundle.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("LSP Worker error:",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce((()=>{if(!this.worker)return;const t=e.getValue();this.worker.postMessage({type:"validate",source:t})}),220);const t=this.editor?.onDidChangeModelContent?.((()=>{this.debouncedValidate&&this.debouncedValidate()}));t&&this.disposables.push(t);const n=this.monaco.languages.registerHoverProvider("pie",{provideHover:(e,t)=>this.provideHover(e,t)});this.disposables.push(n);const i=this.monaco.languages.registerCompletionItemProvider("pie",{provideCompletionItems:(e,t)=>this.provideCompletionItems(e,t)});this.disposables.push(i);const s=this.monaco.languages.registerDefinitionProvider("pie",{provideDefinition:(e,t)=>this.provideDefinition(e,t)});this.disposables.push(s),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach((e=>{e&&"function"==typeof e.dispose&&e.dispose()})),this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&("validation-result"===e.type?this.updateDiagnostics(e.diagnostics??[]):"validation-error"===e.type&&this.updateDiagnostics([{severity:"error",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]))}updateDiagnostics(e){this.diagnostics=e;const t=this.editor?.getModel?.();if(!t)return;const n=e.map((e=>{const t=this.ensurePositiveNumber(e.startLine,1),n=this.ensurePositiveNumber(e.endLine,t),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:t,startColumn:i,endLineNumber:n,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:"warning"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}}));this.monaco.editor.setModelMarkers(t,"pie-lsp",n)}async provideHover(e,t){if(!this.worker)return null;const n=this.diagnostics.find((e=>{const n=this.ensurePositiveNumber(e.startLine,t.lineNumber),i=this.ensurePositiveNumber(e.endLine,n),s=this.ensurePositiveNumber(e.startColumn,1),o=this.ensurePositiveNumber(e.endColumn,s+1);return!(t.lineNumber<n||t.lineNumber>i)&&(!(t.lineNumber===n&&t.column<s)&&!(t.lineNumber===i&&t.column>o))}));if(n){const e=this.ensurePositiveNumber(n.startLine,t.lineNumber),i=this.ensurePositiveNumber(n.endLine,e),s=this.ensurePositiveNumber(n.startColumn,1),o=this.ensurePositiveNumber(n.endColumn,s+1);return{contents:[{value:`**${"warning"===n.severity?"Warning":"Error"}**\n\n${n.message}`}],range:{startLineNumber:e,startColumn:s,endLineNumber:i,endColumn:o}}}return new Promise((n=>{const i=e=>{const t=e.data;if("hover-result"===t.type){if(this.worker?.removeEventListener("message",i),!t.hoverInfo)return void n(null);const e=t.hoverInfo;let s=`**${e.title}**\n\n${e.summary}`;e.details&&(s+=`\n\n${e.details}`),e.examples&&(s+=`\n\n**Examples:**\n\`\`\`pie\n${e.examples}\n\`\`\``),n({contents:[{value:s}]})}};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"hover",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout((()=>{this.worker?.removeEventListener("message",i),n(null)}),1e3)}))}async provideCompletionItems(e,t){return this.worker?new Promise((n=>{const i=e=>{const s=e.data;if("completion-result"===s.type){this.worker?.removeEventListener("message",i);const e=s.wordRange,o=e?{startLineNumber:t.lineNumber,startColumn:e.start+1,endLineNumber:t.lineNumber,endColumn:e.end+1}:{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber,endColumn:t.column},a=s.completions.map((e=>{let t=this.monaco.languages.CompletionItemKind.Text;switch(e.kind){case"Keyword":t=this.monaco.languages.CompletionItemKind.Keyword;break;case"Function":t=this.monaco.languages.CompletionItemKind.Function;break;case"Variable":t=this.monaco.languages.CompletionItemKind.Variable;break;case"TypeParameter":t=this.monaco.languages.CompletionItemKind.Class;break;case"Value":t=this.monaco.languages.CompletionItemKind.Value;break;case"Snippet":t=this.monaco.languages.CompletionItemKind.Snippet}return{label:e.label,kind:t,detail:e.detail,insertText:e.label,range:o}}));n({suggestions:a})}};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"completion",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout((()=>{this.worker?.removeEventListener("message",i),n({suggestions:[]})}),1e3)})):{suggestions:[]}}async provideDefinition(e,t){return this.worker?new Promise((n=>{const i=t=>{const s=t.data;"definition-result"===s.type&&(this.worker?.removeEventListener("message",i),s.location?n({uri:e.uri,range:{startLineNumber:s.location.line+1,startColumn:s.location.startColumn+1,endLineNumber:s.location.line+1,endColumn:s.location.endColumn+1}}):n(null))};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"definition",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout((()=>{this.worker?.removeEventListener("message",i),n(null)}),1e3)})):null}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,"pie-lsp",[])}ensurePositiveNumber(e,t){return"number"!=typeof e||Number.isNaN(e)||e<1?t:e}debounce(e,t){let n=null;return()=>{null!==n&&window.clearTimeout(n),n=window.setTimeout((()=>{n=null,e()}),t)}}}const t={nodeWidth:180,nodeHeight:60,horizontalSpacing:40,verticalSpacing:80,colors:{current:"#f59e0b",completed:"#34d399",pending:"#64748b",edge:"#475569",tacticLabel:"#94a3b8",background:"#0f172a"}};class n{constructor(e,n){this.svg=null,this.onGoalSelect=null,this.currentData=null,this.container=e,this.config={...t,...n}}setOnGoalSelect(e){this.onGoalSelect=e}render(e){this.currentData=e,this.clear();const t=this.calculateLayout(e.root);let n=1/0,i=-1/0,s=0;t.forEach((e=>{n=Math.min(n,e.x),i=Math.max(i,e.x+e.width),s=Math.max(s,e.y+this.config.nodeHeight)}));const o=i-n+40,a=s+40,r=20-n;this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",String(o)),this.svg.setAttribute("height",String(a)),this.svg.style.display="block";const l=document.createElementNS("http://www.w3.org/2000/svg","g"),c=document.createElementNS("http://www.w3.org/2000/svg","g");this.svg.appendChild(l),this.svg.appendChild(c),this.renderNodeRecursive(e.root,t,r,20,l,c),this.container.appendChild(this.svg)}renderNodeRecursive(e,t,n,i,s,o){const a=t.get(e.goal.id);if(!a)return;const r=a.x+n,l=a.y+i;for(const o of e.children){const a=t.get(o.goal.id);if(a){const t=a.x+n,o=a.y+i;this.renderEdge(s,r,l,t,o,e.appliedTactic)}}e.completedBy&&0===e.children.length&&this.renderSelfLoop(s,r,l,e.completedBy),this.renderNode(o,e.goal,r,l);for(const a of e.children)this.renderNodeRecursive(a,t,n,i,s,o)}renderNode(e,t,n,i){const{nodeWidth:s,nodeHeight:o,colors:a}=this.config,r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("class","goal-node"),r.setAttribute("data-goal-id",t.id),r.style.cursor="pointer";let l=a.pending,c="0.1";t.isCurrent?(l=a.current,c="0.2"):t.isComplete&&(l=a.completed,c="0.15");const d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",String(n)),d.setAttribute("y",String(i)),d.setAttribute("width",String(s)),d.setAttribute("height",String(o)),d.setAttribute("rx","8"),d.setAttribute("ry","8"),d.setAttribute("fill",l),d.setAttribute("fill-opacity",c),d.setAttribute("stroke",l),d.setAttribute("stroke-width",t.isCurrent?"3":"2"),r.appendChild(d);const p=document.createElementNS("http://www.w3.org/2000/svg","text");p.setAttribute("x",String(n+10)),p.setAttribute("y",String(i+18)),p.setAttribute("fill",l),p.setAttribute("font-size","11"),p.setAttribute("font-family","monospace"),p.textContent=t.id,r.appendChild(p);const u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",String(n+s-10)),u.setAttribute("y",String(i+18)),u.setAttribute("text-anchor","end"),u.setAttribute("fill",l),u.setAttribute("font-size","12"),console.log(`Goal ${t.id}: isComplete=${t.isComplete}, isCurrent=${t.isCurrent}`),t.isComplete?u.textContent="✓":t.isCurrent?u.textContent="→":u.textContent="○",r.appendChild(u);const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",String(n+10)),h.setAttribute("y",String(i+40)),h.setAttribute("fill","#e2e8f0"),h.setAttribute("font-size","12"),h.setAttribute("font-family","monospace");const m=this.truncateText(t.type,s-20);h.textContent=m,r.appendChild(h),r.addEventListener("click",(()=>{this.onGoalSelect&&this.onGoalSelect(t)})),r.addEventListener("mouseenter",(()=>{d.setAttribute("fill-opacity",String(parseFloat(c)+.1))})),r.addEventListener("mouseleave",(()=>{d.setAttribute("fill-opacity",c)})),e.appendChild(r)}renderEdge(e,t,n,i,s,o){const{nodeWidth:a,nodeHeight:r,colors:l}=this.config,c=t+a/2,d=n+r,p=i+a/2,u=s,h=document.createElementNS("http://www.w3.org/2000/svg","path"),m=(d+u)/2,g=`M ${c} ${d} C ${c} ${m}, ${p} ${m}, ${p} ${u}`;if(h.setAttribute("d",g),h.setAttribute("fill","none"),h.setAttribute("stroke",l.edge),h.setAttribute("stroke-width","2"),e.appendChild(h),o){const t=(c+p)/2,n=m,i=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=this.truncateText(o,100),a=Math.min(7*s.length+10,110);i.setAttribute("x",String(t-a/2)),i.setAttribute("y",String(n-10)),i.setAttribute("width",String(a)),i.setAttribute("height","20"),i.setAttribute("rx","4"),i.setAttribute("fill",l.background),i.setAttribute("fill-opacity","0.9"),e.appendChild(i);const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",String(t)),r.setAttribute("y",String(n+4)),r.setAttribute("text-anchor","middle"),r.setAttribute("fill",l.tacticLabel),r.setAttribute("font-size","11"),r.setAttribute("font-family","monospace"),r.textContent=s,e.appendChild(r)}}renderSelfLoop(e,t,n,i){const{nodeWidth:s,nodeHeight:o,colors:a}=this.config,r=t+s/2,l=n+o,c=document.createElementNS("http://www.w3.org/2000/svg","path"),d=`M ${r-15} ${l}\n               C ${r-50} ${l+35},\n                 ${r+50} ${l+35},\n                 ${r+15} ${l}`;c.setAttribute("d",d),c.setAttribute("fill","none"),c.setAttribute("stroke",a.completed),c.setAttribute("stroke-width","2"),e.appendChild(c);const p=document.createElementNS("http://www.w3.org/2000/svg","polygon"),u=r+15,h=l;p.setAttribute("points",`${u},${h} ${u+6},${h+6} ${u-6},${h+6}`),p.setAttribute("fill",a.completed),e.appendChild(p);const m=l+35+5,g=this.truncateText(i,120),f=Math.min(6.5*g.length+12,130),y=document.createElementNS("http://www.w3.org/2000/svg","rect");y.setAttribute("x",String(r-f/2)),y.setAttribute("y",String(m-10)),y.setAttribute("width",String(f)),y.setAttribute("height","18"),y.setAttribute("rx","4"),y.setAttribute("fill",a.background),y.setAttribute("fill-opacity","0.9"),e.appendChild(y);const k=document.createElementNS("http://www.w3.org/2000/svg","text");k.setAttribute("x",String(r)),k.setAttribute("y",String(m+3)),k.setAttribute("text-anchor","middle"),k.setAttribute("fill",a.completed),k.setAttribute("font-size","10"),k.setAttribute("font-family","monospace"),k.textContent=g,e.appendChild(k)}calculateLayout(e){const t=new Map,n=new Map;return this.calculateSubtreeWidths(e,n),this.assignPositions(e,0,0,n,t),t}calculateSubtreeWidths(e,t){const{nodeWidth:n,horizontalSpacing:i}=this.config;if(0===e.children.length)return t.set(e.goal.id,n),n;let s=0;for(const n of e.children)s+=this.calculateSubtreeWidths(n,t);s+=(e.children.length-1)*i;const o=Math.max(n,s);return t.set(e.goal.id,o),o}assignPositions(e,t,n,i,s){const{nodeWidth:o,nodeHeight:a,horizontalSpacing:r,verticalSpacing:l}=this.config,c=t+((i.get(e.goal.id)||o)-o)/2;if(s.set(e.goal.id,{x:c,y:n,width:o}),e.children.length>0){const c=n+a+l;let d=t;for(const t of e.children){const e=i.get(t.goal.id)||o;this.assignPositions(t,d,c,i,s),d+=e+r}}}truncateText(e,t){const n=Math.floor(t/7);return e.length<=n?e:e.substring(0,n-3)+"..."}clear(){this.svg&&this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svg=null}highlightGoal(e){if(!this.svg)return;this.svg.querySelectorAll(".goal-node").forEach((e=>{e.classList.remove("highlighted")}));const t=this.svg.querySelector(`[data-goal-id="${e}"]`);t&&t.classList.add("highlighted")}}class i{constructor(e){this.currentGoal=null,this.container=e,this.clear()}display(e){this.currentGoal=e,this.container.innerHTML="";const t=document.createElement("div");t.className="panel-header";const n=document.createElement("div");n.className="panel-label",n.textContent="Context",t.appendChild(n),this.container.appendChild(t);const i=document.createElement("div");if(i.className="panel-content",e.contextEntries.length>0){const t=document.createElement("div");t.className="context-list";for(const n of e.contextEntries){const e=document.createElement("div");e.className="context-entry";const i=document.createElement("span");i.className="context-entry-name",i.textContent=n.name,e.appendChild(i);const s=document.createElement("span");s.className="context-entry-colon",s.textContent=" : ",e.appendChild(s);const o=document.createElement("span");o.className="context-entry-type",o.textContent=n.type,e.appendChild(o),t.appendChild(e)}i.appendChild(t)}else{const e=document.createElement("div");e.className="panel-empty",e.textContent="(empty)",i.appendChild(e)}this.container.appendChild(i)}clear(){this.currentGoal=null,this.container.innerHTML='\n      <div class="panel-placeholder">\n        Select a goal\n      </div>\n    '}getCurrentGoal(){return this.currentGoal}}class s{constructor(e){this.pos=0,this.tokens=e}current(){return this.tokens[this.pos]||{type:"EOF"}}advance(){const e=this.current();return this.pos++,e}expect(e){const t=this.current();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return this.advance()}parse(){const e=this.current();if("LPAREN"===e.type)return this.parseList();if("ATOM"===e.type)return this.parseAtom();if("EOF"===e.type)return{kind:"",value:"",children:[],isAtom:!0,sourceText:"",abbreviation:""};throw new Error(`Unexpected token: ${e.type}`)}parseAtom(){const e=this.expect("ATOM");return{kind:e.value,value:e.value,children:[],isAtom:!0,sourceText:e.value,abbreviation:e.value}}parseList(){this.expect("LPAREN");const e=[],t=["("];for(;"RPAREN"!==this.current().type&&"EOF"!==this.current().type;){const n=this.parse();e.push(n),t.push(n.sourceText)}this.expect("RPAREN"),t.push(")");const n=e.length>0&&e[0].isAtom?e[0].kind:"list",i=t.join(" ").replace(/\( /g,"(").replace(/ \)/g,")"),s=function(e){const t=e.kind,n=e.children;switch(t){case"Π":case"Pi":if(n.length>=3){const e=n[1];if(!e.isAtom&&e.children.length>=2){return`Π (${e.children[0].abbreviation} : ${e.children[1].abbreviation}) ...`}}return"Π ...";case"Σ":case"Sigma":if(n.length>=3){const e=n[1];if(!e.isAtom&&e.children.length>=2){return`Σ (${e.children[0].abbreviation} : ${e.children[1].abbreviation}) ...`}}return"Σ ...";case"Either":return n.length>=3?`Either ${n[1].abbreviation} ${n[2].abbreviation}`:"Either ...";case"left":case"Left":return n.length>=2?`left ${n[1].abbreviation}`:"left ...";case"right":case"Right":return n.length>=2?`right ${n[1].abbreviation}`:"right ...";case"=":return n.length>=4?`= ${n[1].abbreviation} ...`:"= ...";case"λ":case"lambda":if(n.length>=3){const e=n[1];if(!e.isAtom&&e.children.length>=1)return`λ (${e.children[0].abbreviation}) ...`}return"λ ...";case"List":return n.length>=2?`List ${n[1].abbreviation}`:"List ...";case"Vec":return n.length>=3?`Vec ${n[1].abbreviation} ${n[2].abbreviation}`:"Vec ...";case"Pair":return n.length>=3?`Pair ${n[1].abbreviation} ${n[2].abbreviation}`:"Pair ...";case"cons":case"::":return":: ...";case"add1":return n.length>=2?`add1 ${n[1].abbreviation}`:"add1 ...";default:if(n.length>0){const e=n[0].isAtom?n[0].abbreviation:"?";return 1===n.length?`(${e})`:`(${e} ...)`}return"(...)"}}({kind:n,children:e});return{kind:n,children:e,isAtom:!1,sourceText:i,abbreviation:s}}}function o(e){const t=e.toLowerCase();return"Π"===e||"Pi"===e||"→"===e||"->"===e?"pi":"Σ"===e||"Sigma"===e?"sigma":"either"===t||"left"===t||"right"===t?"either":"="===e||"same"===t||"cong"===t||"symm"===t||"trans"===t||"replace"===t?"equality":"list"===t||"::"===e||"nil"===t||"cons"===t?"list":"vec"===t||"vec::"===t||"vecnil"===t||"head"===t||"tail"===t?"vec":"nat"===t||"zero"===t||"add1"===t?"nat":"U"===e||"atom"===t||"trivial"===t||"absurd"===t||"sole"===t?"universe":"λ"===e||"lambda"===t?"lambda":/^[a-z][a-z0-9_-]*$/i.test(e)&&e.length<=10&&e===e.toLowerCase()?"variable":"default"}class a{constructor(e){this.rootNode=null,this.nodeStates=new Map,this.nodeIdCounter=0,this.container=e,this.container.classList.add("type-tree")}render(e){this.clear(),this.nodeIdCounter=0;const t=e.trim();if(t)try{if(this.rootNode=function(e){const t=e.trim();if(!t)return{kind:"",value:"",children:[],isAtom:!0,sourceText:"",abbreviation:""};try{const e=function(e){const t=[];let n=0;for(;n<e.length;){const i=e[n];if(/\s/.test(i)){n++;continue}if("("===i){t.push({type:"LPAREN"}),n++;continue}if(")"===i){t.push({type:"RPAREN"}),n++;continue}let s="";for(;n<e.length&&!/[\s()]/.test(e[n]);)s+=e[n],n++;s&&t.push({type:"ATOM",value:s})}return t.push({type:"EOF"}),t}(t);return new s(e).parse()}catch(e){return{kind:"error",value:t,children:[],isAtom:!0,sourceText:t,abbreviation:t.length>20?t.slice(0,20)+"...":t}}}(t),"error"===this.rootNode.kind)return void this.showPlainText(t);const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}catch(e){this.showPlainText(t)}else this.showPlaceholder("No type to display")}clear(){this.container.innerHTML="",this.rootNode=null,this.nodeStates.clear(),this.nodeIdCounter=0}expandAll(){if(this.nodeStates.forEach(((e,t)=>this.nodeStates.set(t,!0))),this.rootNode){this.container.innerHTML="";const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}}collapseAll(){if(this.nodeStates.forEach(((e,t)=>this.nodeStates.set(t,!1))),this.rootNode){this.container.innerHTML="";const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}}showPlaceholder(e){const t=document.createElement("div");t.className="type-tree__placeholder",t.textContent=e,this.container.appendChild(t)}showPlainText(e){const t=document.createElement("pre");t.className="type-tree__fallback",t.textContent=e,this.container.appendChild(t)}renderNode(e,t){const n="n"+this.nodeIdCounter++;this.nodeStates.has(n)||this.nodeStates.set(n,t<3);const i=this.nodeStates.get(n)??!0;return e.isAtom?this.renderAtom(e):this.renderListNode(e,n,t,i)}renderAtom(e){const t=document.createElement("span");t.className="type-node type-node--atom";const n=document.createElement("span"),i=o(e.kind);return n.className=`type-node__kind type-kind--${i}`,n.textContent=e.value||e.kind,t.appendChild(n),t}renderListNode(e,t,n,i){const s=document.createElement("div");s.className="type-node type-node--list",s.dataset.nodeId=t;const a=e.children,r=a.length>0&&a[0].isAtom&&a[0].kind===e.kind?a.slice(1):a,l=r.length>0,c=document.createElement("div");if(c.className="type-node__header",l){const e=document.createElement("span");e.className="type-node__toggle",e.textContent=i?"▼":"▶",e.addEventListener("click",(e=>{e.stopPropagation(),this.toggleNode(t)})),c.appendChild(e)}else{const e=document.createElement("span");e.className="type-node__toggle-spacer",c.appendChild(e)}const d=document.createElement("span"),p=o(e.kind);if(d.className=`type-node__kind type-kind--${p}`,d.textContent=e.kind,c.appendChild(d),this.isBindingType(e.kind)&&r.length>=2){const e=r[0];if(!e.isAtom&&e.children.length>=2){const t=document.createElement("span");t.className="type-node__binding";const n=e.children[0].value||e.children[0].kind,i=e.children[1].abbreviation;t.textContent=` (${n} : ${i})`,c.appendChild(t)}else if(!e.isAtom&&1===e.children.length){const t=document.createElement("span");t.className="type-node__binding";const n=e.children[0].value||e.children[0].kind;t.textContent=` (${n})`,c.appendChild(t)}}if(!i&&l){const t=document.createElement("span");t.className="type-node__abbrev",t.textContent=" "+this.getCollapsedHint(e,r),c.appendChild(t)}if(s.appendChild(c),l&&i){const t=document.createElement("div");t.className="type-node__children";const i=this.getChildrenToRender(e,r);for(const e of i){const i=this.renderNode(e,n+1);t.appendChild(i)}s.appendChild(t)}return s}isBindingType(e){return"Π"===e||"Pi"===e||"Σ"===e||"Sigma"===e||"λ"===e||"lambda"===e}getChildrenToRender(e,t){return this.isBindingType(e.kind)&&t.length>=2?t.slice(1):t}getCollapsedHint(e,t){if(0===t.length)return"";if(this.isBindingType(e.kind)&&t.length>=2){const e=t[1];return e.isAtom?e.kind:`→ ${e.kind} ...`}return"..."}toggleNode(e){const t=this.nodeStates.get(e)??!0;if(this.nodeStates.set(e,!t),this.rootNode){this.nodeIdCounter=0,this.container.innerHTML="";const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}}}class r{constructor(e){this.currentGoal=null,this.goalTypeTree=null,this.container=e,this.clear()}display(e){this.currentGoal=e,this.container.innerHTML="";const t=document.createElement("div");t.className="panel-header";const n=document.createElement("div");n.className="panel-title-row";const i=document.createElement("div");i.className="panel-label",i.textContent="Goal",n.appendChild(i);const s=document.createElement("span");s.className="panel-goal-id",s.textContent=e.id,n.appendChild(s),t.appendChild(n);const o=document.createElement("span");o.className="panel-status",e.isComplete?(o.textContent="Completed",o.classList.add("status-completed")):e.isCurrent?(o.textContent="Ongoing",o.classList.add("status-ongoing")):(o.textContent="Pending",o.classList.add("status-pending")),t.appendChild(o),this.container.appendChild(t);const r=document.createElement("div");r.className="panel-content";const l=document.createElement("div");l.className="goal-type-tree",this.goalTypeTree=new a(l),this.goalTypeTree.render(e.type),r.appendChild(l),this.container.appendChild(r)}clear(){this.currentGoal=null,this.goalTypeTree=null,this.container.innerHTML='\n      <div class="panel-placeholder">\n        Select a goal\n      </div>\n    '}getCurrentGoal(){return this.currentGoal}}const l="#4ade80",c="#60a5fa",d="#a3e635",p="#fb923c",u="#f59e0b",h="#22d3ee";let m=null;function g(){return m||(m=new Blockly.Generator("Pie"),m.scrub_=function(e,t,n){const i=e.nextConnection&&e.nextConnection.targetBlock();return i&&!n?t+"\n"+m.blockToCode(i):t},m.scrubNakedValue=function(e){return e+"\n"},(e=m).forBlock.pie_nat=function(){return["Nat",0]},e.forBlock.pie_atom=function(){return["Atom",0]},e.forBlock.pie_trivial=function(){return["Trivial",0]},e.forBlock.pie_absurd=function(){return["Absurd",0]},e.forBlock.pie_u=function(){return["U",0]},e.forBlock.pie_list_type=function(t){return[`(List ${y(e,t,"ELEM_TYPE")||"Nat"})`,0]},e.forBlock.pie_vec_type=function(t){return[`(Vec ${y(e,t,"ELEM_TYPE")||"Nat"} ${y(e,t,"LENGTH")||"0"})`,0]},e.forBlock.pie_pair_type=function(t){return[`(Pair ${y(e,t,"LEFT_TYPE")||"Nat"} ${y(e,t,"RIGHT_TYPE")||"Nat"})`,0]},e.forBlock.pie_sigma_type=function(t){return[`(Sigma ((${t.getFieldValue("BINDING")||"x"} ${y(e,t,"BINDING_TYPE")||"Nat"})) ${y(e,t,"BODY_TYPE")||"Nat"})`,0]},e.forBlock.pie_either_type=function(t){return[`(Either ${y(e,t,"LEFT_TYPE")||"Nat"} ${y(e,t,"RIGHT_TYPE")||"Nat"})`,0]},e.forBlock.pie_arrow_type=function(t){return[`(-> ${y(e,t,"FROM_TYPE")||"Nat"} ${y(e,t,"TO_TYPE")||"Nat"})`,0]},e.forBlock.pie_pi_type=function(t){return[`(Pi ((${t.getFieldValue("BINDING")||"x"} ${y(e,t,"BINDING_TYPE")||"Nat"})) ${y(e,t,"BODY_TYPE")||"Nat"})`,0]},e.forBlock.pie_equal_type=function(t){return[`(= ${y(e,t,"BASE_TYPE")||"Nat"} ${y(e,t,"FROM")||"0"} ${y(e,t,"TO")||"0"})`,0]},e.forBlock.pie_zero=function(){return["zero",0]},e.forBlock.pie_add1=function(t){return[`(add1 ${y(e,t,"N")||"zero"})`,0]},e.forBlock.pie_nat_literal=function(e){const t=e.getFieldValue("VALUE")||0;return[String(t),0]},e.forBlock.pie_cons=function(t){return[`(cons ${y(e,t,"LEFT")||"zero"} ${y(e,t,"RIGHT")||"zero"})`,0]},e.forBlock.pie_car=function(t){return[`(car ${y(e,t,"PAIR")||"p"})`,0]},e.forBlock.pie_cdr=function(t){return[`(cdr ${y(e,t,"PAIR")||"p"})`,0]},e.forBlock.pie_same=function(t){return[`(same ${y(e,t,"VALUE")||"zero"})`,0]},e.forBlock.pie_sole=function(){return["sole",0]},e.forBlock.pie_nil=function(){return["nil",0]},e.forBlock.pie_list_cons=function(t){return[`(:: ${y(e,t,"HEAD")||"zero"} ${y(e,t,"TAIL")||"nil"})`,0]},e.forBlock.pie_vecnil=function(){return["vecnil",0]},e.forBlock.pie_vec_cons=function(t){return[`(vec:: ${y(e,t,"HEAD")||"zero"} ${y(e,t,"TAIL")||"vecnil"})`,0]},e.forBlock.pie_left=function(t){return[`(left ${y(e,t,"VALUE")||"zero"})`,0]},e.forBlock.pie_right=function(t){return[`(right ${y(e,t,"VALUE")||"zero"})`,0]},e.forBlock.pie_quote=function(e){return[`'${e.getFieldValue("SYMBOL")||"symbol"}`,0]},e.forBlock.pie_variable=function(e){return[e.getFieldValue("NAME")||"x",0]},e.forBlock.pie_lambda=function(t){return[`(lambda (${t.getFieldValue("PARAM")||"x"}) ${y(e,t,"BODY")||"x"})`,0]},e.forBlock.pie_lambda_multi=function(t){return[`(lambda (${t.getFieldValue("PARAMS")||"x"}) ${y(e,t,"BODY")||"x"})`,0]},e.forBlock.pie_application=function(t){return[`(${y(e,t,"FUNC")||"f"} ${y(e,t,"ARG")||"x"})`,0]},e.forBlock.pie_application_multi=function(t){return[`(${y(e,t,"FUNC")||"f"} ${y(e,t,"ARG1")||"x"} ${y(e,t,"ARG2")||"y"})`,0]},e.forBlock.pie_the=function(t){return[`(the ${y(e,t,"TYPE")||"Nat"} ${y(e,t,"VALUE")||"zero"})`,0]},e.forBlock.pie_cong=function(t){return[`(cong ${y(e,t,"PROOF")||"eq"} ${y(e,t,"FUNC")||"f"})`,0]},e.forBlock.pie_claim=function(t){return`(claim ${t.getFieldValue("NAME")||"name"} ${y(e,t,"TYPE")||"Nat"})`},e.forBlock.pie_define=function(t){return`(define ${t.getFieldValue("NAME")||"name"} ${y(e,t,"VALUE")||"zero"})`},e.forBlock.pie_define_tactically=function(t){const n=t.getFieldValue("NAME")||"name",i=function(e,t,n){return e.statementToCode(t,n)}(e,t,"TACTICS")||"";return`(define-tactically ${n}\n  (\n${i.split("\n").filter((e=>e.trim())).map((e=>"  "+e.trim())).join("\n")}\n  ))`},e.forBlock.pie_check_same=function(t){return`(check-same ${y(e,t,"TYPE")||"Nat"} ${y(e,t,"LEFT")||"zero"} ${y(e,t,"RIGHT")||"zero"})`},e.forBlock.pie_tactic_intro=function(e){return`(intro ${e.getFieldValue("NAME")||"x"})`},e.forBlock.pie_tactic_exact=function(t){return`(exact ${y(e,t,"EXPR")||"x"})`},e.forBlock.pie_tactic_exists=function(t){return`(exists ${y(e,t,"WITNESS")||"x"})`},e.forBlock.pie_tactic_left=function(e){return"(left)"},e.forBlock.pie_tactic_right=function(e){return"(right)"},e.forBlock.pie_tactic_split=function(e){return"(split)"},e.forBlock.pie_tactic_elimNat=function(e){return`(elimNat ${e.getFieldValue("TARGET")||"n"})`},e.forBlock.pie_tactic_elimList=function(e){return`(elimList ${e.getFieldValue("TARGET")||"xs"})`},e.forBlock.pie_tactic_elimVec=function(e){return`(elimVec ${e.getFieldValue("TARGET")||"vs"})`},e.forBlock.pie_tactic_elimEqual=function(e){return`(elimEqual ${e.getFieldValue("TARGET")||"eq"})`},e.forBlock.pie_tactic_elimEither=function(e){return`(elimEither ${e.getFieldValue("TARGET")||"e"})`},e.forBlock.pie_tactic_elimAbsurd=function(e){return`(elimAbsurd ${e.getFieldValue("TARGET")||"x"})`},e.forBlock.pie_which_nat=function(t){return[`(which-Nat ${y(e,t,"TARGET")||"n"} ${y(e,t,"BASE")||"zero"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_iter_nat=function(t){return[`(iter-Nat ${y(e,t,"TARGET")||"n"} ${y(e,t,"BASE")||"zero"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_rec_nat=function(t){return[`(rec-Nat ${y(e,t,"TARGET")||"n"} ${y(e,t,"BASE")||"zero"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_ind_nat=function(t){return[`(ind-Nat ${y(e,t,"TARGET")||"n"} ${y(e,t,"MOTIVE")||"mot"} ${y(e,t,"BASE")||"zero"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_rec_list=function(t){return[`(rec-List ${y(e,t,"TARGET")||"xs"} ${y(e,t,"BASE")||"nil"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_ind_list=function(t){return[`(ind-List ${y(e,t,"TARGET")||"xs"} ${y(e,t,"MOTIVE")||"mot"} ${y(e,t,"BASE")||"nil"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_ind_vec=function(t){return[`(ind-Vec ${y(e,t,"LENGTH")||"n"} ${y(e,t,"TARGET")||"vs"} ${y(e,t,"MOTIVE")||"mot"} ${y(e,t,"BASE")||"vecnil"} ${y(e,t,"STEP")||"f"})`,0]},e.forBlock.pie_ind_either=function(t){return[`(ind-Either ${y(e,t,"TARGET")||"e"} ${y(e,t,"MOTIVE")||"mot"} ${y(e,t,"LEFT_CASE")||"fl"} ${y(e,t,"RIGHT_CASE")||"fr"})`,0]},e.forBlock.pie_ind_equal=function(t){return[`(ind-= ${y(e,t,"TARGET")||"eq"} ${y(e,t,"MOTIVE")||"mot"} ${y(e,t,"BASE")||"b"})`,0]},e.forBlock.pie_ind_absurd=function(t){return[`(ind-Absurd ${y(e,t,"TARGET")||"x"} ${y(e,t,"MOTIVE")||"Nat"})`,0]},e.forBlock.pie_head=function(t){return[`(head ${y(e,t,"LIST")||"vs"})`,0]},e.forBlock.pie_tail=function(t){return[`(tail ${y(e,t,"LIST")||"vs"})`,0]},m);var e}const f={get instance(){return g()},workspaceToCode:e=>g().workspaceToCode(e)};function y(e,t,n){return e.valueToCode(t,n,0)||""}const k={kind:"categoryToolbox",contents:[{kind:"category",name:"Definitions",colour:p,contents:[{kind:"label",text:"Top-level declarations"},{kind:"block",type:"pie_claim"},{kind:"block",type:"pie_define"},{kind:"sep",gap:"16"},{kind:"label",text:"Tactical proofs"},{kind:"block",type:"pie_define_tactically"},{kind:"sep",gap:"16"},{kind:"label",text:"Assertions"},{kind:"block",type:"pie_check_same"}]},{kind:"category",name:"Types",colour:l,contents:[{kind:"label",text:"Basic Types"},{kind:"block",type:"pie_nat"},{kind:"block",type:"pie_atom"},{kind:"block",type:"pie_trivial"},{kind:"block",type:"pie_absurd"},{kind:"block",type:"pie_u"},{kind:"sep",gap:"16"},{kind:"label",text:"Collection Types"},{kind:"block",type:"pie_list_type"},{kind:"block",type:"pie_vec_type"},{kind:"sep",gap:"16"},{kind:"label",text:"Product Types"},{kind:"block",type:"pie_pair_type"},{kind:"block",type:"pie_sigma_type"},{kind:"sep",gap:"16"},{kind:"label",text:"Sum Types"},{kind:"block",type:"pie_either_type"},{kind:"sep",gap:"16"},{kind:"label",text:"Function Types"},{kind:"block",type:"pie_arrow_type"},{kind:"block",type:"pie_pi_type"},{kind:"sep",gap:"16"},{kind:"label",text:"Equality Type"},{kind:"block",type:"pie_equal_type"}]},{kind:"category",name:"Values",colour:c,contents:[{kind:"label",text:"Natural Numbers"},{kind:"block",type:"pie_zero"},{kind:"block",type:"pie_add1"},{kind:"block",type:"pie_nat_literal"},{kind:"sep",gap:"16"},{kind:"label",text:"Pairs"},{kind:"block",type:"pie_cons"},{kind:"block",type:"pie_car"},{kind:"block",type:"pie_cdr"},{kind:"sep",gap:"16"},{kind:"label",text:"Lists"},{kind:"block",type:"pie_nil"},{kind:"block",type:"pie_list_cons"},{kind:"sep",gap:"16"},{kind:"label",text:"Vectors"},{kind:"block",type:"pie_vecnil"},{kind:"block",type:"pie_vec_cons"},{kind:"sep",gap:"16"},{kind:"label",text:"Either"},{kind:"block",type:"pie_left"},{kind:"block",type:"pie_right"},{kind:"sep",gap:"16"},{kind:"label",text:"Other Values"},{kind:"block",type:"pie_sole"},{kind:"block",type:"pie_same"},{kind:"block",type:"pie_quote"},{kind:"block",type:"pie_variable"}]},{kind:"category",name:"Functions",colour:d,contents:[{kind:"label",text:"Lambda Expressions"},{kind:"block",type:"pie_lambda"},{kind:"block",type:"pie_lambda_multi"},{kind:"sep",gap:"16"},{kind:"label",text:"Application"},{kind:"block",type:"pie_application"},{kind:"block",type:"pie_application_multi"},{kind:"sep",gap:"16"},{kind:"label",text:"Type Annotation"},{kind:"block",type:"pie_the"},{kind:"sep",gap:"16"},{kind:"label",text:"Equality"},{kind:"block",type:"pie_cong"}]},{kind:"category",name:"Eliminators",colour:h,contents:[{kind:"label",text:"Natural Number Eliminators"},{kind:"block",type:"pie_which_nat"},{kind:"block",type:"pie_iter_nat"},{kind:"block",type:"pie_rec_nat"},{kind:"block",type:"pie_ind_nat"},{kind:"sep",gap:"16"},{kind:"label",text:"List Eliminators"},{kind:"block",type:"pie_rec_list"},{kind:"block",type:"pie_ind_list"},{kind:"sep",gap:"16"},{kind:"label",text:"Vector Eliminators"},{kind:"block",type:"pie_ind_vec"},{kind:"block",type:"pie_head"},{kind:"block",type:"pie_tail"},{kind:"sep",gap:"16"},{kind:"label",text:"Either Eliminator"},{kind:"block",type:"pie_ind_either"},{kind:"sep",gap:"16"},{kind:"label",text:"Equality Eliminator"},{kind:"block",type:"pie_ind_equal"},{kind:"sep",gap:"16"},{kind:"label",text:"Absurd Eliminator"},{kind:"block",type:"pie_ind_absurd"}]},{kind:"category",name:"Tactics",colour:u,contents:[{kind:"label",text:"Basic Tactics"},{kind:"block",type:"pie_tactic_intro"},{kind:"block",type:"pie_tactic_exact"},{kind:"block",type:"pie_tactic_exists"},{kind:"sep",gap:"16"},{kind:"label",text:"Either Tactics"},{kind:"block",type:"pie_tactic_left"},{kind:"block",type:"pie_tactic_right"},{kind:"sep",gap:"16"},{kind:"label",text:"Split"},{kind:"block",type:"pie_tactic_split"},{kind:"sep",gap:"16"},{kind:"label",text:"Elimination Tactics"},{kind:"block",type:"pie_tactic_elimNat"},{kind:"block",type:"pie_tactic_elimList"},{kind:"block",type:"pie_tactic_elimVec"},{kind:"block",type:"pie_tactic_elimEqual"},{kind:"block",type:"pie_tactic_elimEither"},{kind:"block",type:"pie_tactic_elimAbsurd"}]}]};class b{constructor(e){this.workspace=null,this.lastGeneratedCode="",this.changeListener=null,this.initialized=!1,this.codePreview=e.codePreview,this.onCodeChange=e.onCodeChange,Blockly.Blocks.pie_nat={init:function(){this.appendDummyInput().appendField("Nat"),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Natural number type")}},Blockly.Blocks.pie_atom={init:function(){this.appendDummyInput().appendField("Atom"),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Atom (symbol) type")}},Blockly.Blocks.pie_trivial={init:function(){this.appendDummyInput().appendField("Trivial"),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Trivial type (unit type)")}},Blockly.Blocks.pie_absurd={init:function(){this.appendDummyInput().appendField("Absurd"),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Absurd type (empty type)")}},Blockly.Blocks.pie_u={init:function(){this.appendDummyInput().appendField("U"),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Universe type (type of types)")}},Blockly.Blocks.pie_list_type={init:function(){this.appendValueInput("ELEM_TYPE").setCheck("Type").appendField("List"),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("List type")}},Blockly.Blocks.pie_vec_type={init:function(){this.appendValueInput("ELEM_TYPE").setCheck("Type").appendField("Vec"),this.appendValueInput("LENGTH").setCheck(["Expression","Type"]).appendField("length"),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Vector type with fixed length")}},Blockly.Blocks.pie_pair_type={init:function(){this.appendValueInput("LEFT_TYPE").setCheck("Type").appendField("Pair"),this.appendValueInput("RIGHT_TYPE").setCheck("Type"),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Pair type (non-dependent product)")}},Blockly.Blocks.pie_sigma_type={init:function(){this.appendDummyInput().appendField("Sigma (").appendField(new Blockly.FieldTextInput("x"),"BINDING").appendField(":"),this.appendValueInput("BINDING_TYPE").setCheck("Type"),this.appendDummyInput().appendField(")"),this.appendValueInput("BODY_TYPE").setCheck("Type"),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Sigma type (dependent pair)")}},Blockly.Blocks.pie_either_type={init:function(){this.appendValueInput("LEFT_TYPE").setCheck("Type").appendField("Either"),this.appendValueInput("RIGHT_TYPE").setCheck("Type"),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Either type (sum type)")}},Blockly.Blocks.pie_arrow_type={init:function(){this.appendValueInput("FROM_TYPE").setCheck("Type").appendField("->"),this.appendValueInput("TO_TYPE").setCheck("Type"),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Arrow type (function type)")}},Blockly.Blocks.pie_pi_type={init:function(){this.appendDummyInput().appendField("Pi (").appendField(new Blockly.FieldTextInput("x"),"BINDING").appendField(":"),this.appendValueInput("BINDING_TYPE").setCheck("Type"),this.appendDummyInput().appendField(")"),this.appendValueInput("BODY_TYPE").setCheck("Type"),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Pi type (dependent function type)")}},Blockly.Blocks.pie_equal_type={init:function(){this.appendValueInput("BASE_TYPE").setCheck("Type").appendField("="),this.appendValueInput("FROM").setCheck(["Expression","Type"]),this.appendValueInput("TO").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Type"),this.setColour(l),this.setTooltip("Equality type")}},Blockly.Blocks.pie_zero={init:function(){this.appendDummyInput().appendField("zero"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Natural number zero")}},Blockly.Blocks.pie_add1={init:function(){this.appendValueInput("N").setCheck(["Expression","Type"]).appendField("add1"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Successor of a natural number")}},Blockly.Blocks.pie_nat_literal={init:function(){this.appendDummyInput().appendField(new Blockly.FieldNumber(0,0,1/0,1),"VALUE"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Natural number literal")}},Blockly.Blocks.pie_cons={init:function(){this.appendValueInput("LEFT").setCheck(["Expression","Type"]).appendField("cons"),this.appendValueInput("RIGHT").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Pair constructor")}},Blockly.Blocks.pie_car={init:function(){this.appendValueInput("PAIR").setCheck(["Expression","Type"]).appendField("car"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("First element of a pair")}},Blockly.Blocks.pie_cdr={init:function(){this.appendValueInput("PAIR").setCheck(["Expression","Type"]).appendField("cdr"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Second element of a pair")}},Blockly.Blocks.pie_same={init:function(){this.appendValueInput("VALUE").setCheck(["Expression","Type"]).appendField("same"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Reflexivity proof")}},Blockly.Blocks.pie_sole={init:function(){this.appendDummyInput().appendField("sole"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("The sole element of Trivial")}},Blockly.Blocks.pie_nil={init:function(){this.appendDummyInput().appendField("nil"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Empty list")}},Blockly.Blocks.pie_list_cons={init:function(){this.appendValueInput("HEAD").setCheck(["Expression","Type"]).appendField("::"),this.appendValueInput("TAIL").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("List constructor")}},Blockly.Blocks.pie_vecnil={init:function(){this.appendDummyInput().appendField("vecnil"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Empty vector")}},Blockly.Blocks.pie_vec_cons={init:function(){this.appendValueInput("HEAD").setCheck(["Expression","Type"]).appendField("vec::"),this.appendValueInput("TAIL").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Vector constructor")}},Blockly.Blocks.pie_left={init:function(){this.appendValueInput("VALUE").setCheck(["Expression","Type"]).appendField("left"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Left injection into Either")}},Blockly.Blocks.pie_right={init:function(){this.appendValueInput("VALUE").setCheck(["Expression","Type"]).appendField("right"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Right injection into Either")}},Blockly.Blocks.pie_quote={init:function(){this.appendDummyInput().appendField("'").appendField(new Blockly.FieldTextInput("symbol"),"SYMBOL"),this.setOutput(!0,"Expression"),this.setColour(c),this.setTooltip("Atom literal (quoted symbol)")}},Blockly.Blocks.pie_variable={init:function(){this.appendDummyInput().appendField(new Blockly.FieldTextInput("x"),"NAME"),this.setOutput(!0,["Expression","Type"]),this.setColour(c),this.setTooltip("Variable reference")}},Blockly.Blocks.pie_lambda={init:function(){this.appendDummyInput().appendField("lambda (").appendField(new Blockly.FieldTextInput("x"),"PARAM").appendField(")"),this.appendValueInput("BODY").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(d),this.setTooltip("Lambda expression")}},Blockly.Blocks.pie_lambda_multi={init:function(){this.appendDummyInput().appendField("lambda (").appendField(new Blockly.FieldTextInput("x y"),"PARAMS").appendField(")"),this.appendValueInput("BODY").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(d),this.setTooltip("Lambda expression with multiple parameters (space-separated)")}},Blockly.Blocks.pie_application={init:function(){this.appendValueInput("FUNC").setCheck(["Expression","Type"]).appendField("("),this.appendValueInput("ARG").setCheck(["Expression","Type"]),this.appendDummyInput().appendField(")"),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(d),this.setTooltip("Function application")}},Blockly.Blocks.pie_application_multi={init:function(){this.appendValueInput("FUNC").setCheck(["Expression","Type"]).appendField("("),this.appendValueInput("ARG1").setCheck(["Expression","Type"]),this.appendValueInput("ARG2").setCheck(["Expression","Type"]),this.appendDummyInput().appendField(")"),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(d),this.setTooltip("Function application with two arguments")}},Blockly.Blocks.pie_the={init:function(){this.appendValueInput("TYPE").setCheck("Type").appendField("the"),this.appendValueInput("VALUE").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(d),this.setTooltip("Type annotation")}},Blockly.Blocks.pie_cong={init:function(){this.appendValueInput("PROOF").setCheck(["Expression","Type"]).appendField("cong"),this.appendValueInput("FUNC").setCheck(["Expression","Type"]),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(d),this.setTooltip("Congruence (apply function to both sides of equality)")}},Blockly.Blocks.pie_claim={init:function(){this.appendDummyInput().appendField("claim").appendField(new Blockly.FieldTextInput("name"),"NAME"),this.appendValueInput("TYPE").setCheck("Type").appendField(":"),this.setPreviousStatement(!0,"Statement"),this.setNextStatement(!0,"Statement"),this.setColour(p),this.setTooltip("Declare a type for a name")}},Blockly.Blocks.pie_define={init:function(){this.appendDummyInput().appendField("define").appendField(new Blockly.FieldTextInput("name"),"NAME"),this.appendValueInput("VALUE").setCheck(["Expression","Type"]).appendField("="),this.setPreviousStatement(!0,"Statement"),this.setNextStatement(!0,"Statement"),this.setColour(p),this.setTooltip("Define a value for a claimed name")}},Blockly.Blocks.pie_define_tactically={init:function(){this.appendDummyInput().appendField("define-tactically").appendField(new Blockly.FieldTextInput("name"),"NAME"),this.appendStatementInput("TACTICS").setCheck("Tactic"),this.setPreviousStatement(!0,"Statement"),this.setNextStatement(!0,"Statement"),this.setColour(p),this.setTooltip("Define using tactics")}},Blockly.Blocks.pie_check_same={init:function(){this.appendValueInput("TYPE").setCheck("Type").appendField("check-same"),this.appendValueInput("LEFT").setCheck(["Expression","Type"]),this.appendValueInput("RIGHT").setCheck(["Expression","Type"]),this.setPreviousStatement(!0,"Statement"),this.setNextStatement(!0,"Statement"),this.setColour(p),this.setTooltip("Check that two expressions are the same")}},Blockly.Blocks.pie_tactic_intro={init:function(){this.appendDummyInput().appendField("intro").appendField(new Blockly.FieldTextInput("x"),"NAME"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Introduce a variable")}},Blockly.Blocks.pie_tactic_exact={init:function(){this.appendValueInput("EXPR").setCheck(["Expression","Type"]).appendField("exact"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Provide exact proof term")}},Blockly.Blocks.pie_tactic_exists={init:function(){this.appendValueInput("WITNESS").setCheck(["Expression","Type"]).appendField("exists"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Provide witness for existential")}},Blockly.Blocks.pie_tactic_left={init:function(){this.appendDummyInput().appendField("left"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Choose left branch of Either")}},Blockly.Blocks.pie_tactic_right={init:function(){this.appendDummyInput().appendField("right"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Choose right branch of Either")}},Blockly.Blocks.pie_tactic_split={init:function(){this.appendDummyInput().appendField("split"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Split a goal into subgoals")}},Blockly.Blocks.pie_tactic_elimNat={init:function(){this.appendDummyInput().appendField("elimNat").appendField(new Blockly.FieldTextInput("n"),"TARGET"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Eliminate (induct on) a natural number")}},Blockly.Blocks.pie_tactic_elimList={init:function(){this.appendDummyInput().appendField("elimList").appendField(new Blockly.FieldTextInput("xs"),"TARGET"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Eliminate (induct on) a list")}},Blockly.Blocks.pie_tactic_elimVec={init:function(){this.appendDummyInput().appendField("elimVec").appendField(new Blockly.FieldTextInput("vs"),"TARGET"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Eliminate (induct on) a vector")}},Blockly.Blocks.pie_tactic_elimEqual={init:function(){this.appendDummyInput().appendField("elimEqual").appendField(new Blockly.FieldTextInput("eq"),"TARGET"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Eliminate an equality proof")}},Blockly.Blocks.pie_tactic_elimEither={init:function(){this.appendDummyInput().appendField("elimEither").appendField(new Blockly.FieldTextInput("e"),"TARGET"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Eliminate an Either value")}},Blockly.Blocks.pie_tactic_elimAbsurd={init:function(){this.appendDummyInput().appendField("elimAbsurd").appendField(new Blockly.FieldTextInput("x"),"TARGET"),this.setPreviousStatement(!0,"Tactic"),this.setNextStatement(!0,"Tactic"),this.setColour(u),this.setTooltip("Eliminate an Absurd value (ex falso)")}},Blockly.Blocks.pie_which_nat={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("which-Nat"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Case analysis on Nat (zero or add1)")}},Blockly.Blocks.pie_iter_nat={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("iter-Nat"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Iterate over Nat")}},Blockly.Blocks.pie_rec_nat={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("rec-Nat"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Recursion over Nat with predecessor")}},Blockly.Blocks.pie_ind_nat={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("ind-Nat"),this.appendValueInput("MOTIVE").setCheck(["Expression","Type"]).appendField("motive"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Induction over Nat")}},Blockly.Blocks.pie_rec_list={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("rec-List"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Recursion over List")}},Blockly.Blocks.pie_ind_list={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("ind-List"),this.appendValueInput("MOTIVE").setCheck(["Expression","Type"]).appendField("motive"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Induction over List")}},Blockly.Blocks.pie_ind_vec={init:function(){this.appendValueInput("LENGTH").setCheck(["Expression","Type"]).appendField("ind-Vec"),this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("vec"),this.appendValueInput("MOTIVE").setCheck(["Expression","Type"]).appendField("motive"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.appendValueInput("STEP").setCheck(["Expression","Type"]).appendField("step"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Induction over Vec")}},Blockly.Blocks.pie_ind_either={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("ind-Either"),this.appendValueInput("MOTIVE").setCheck(["Expression","Type"]).appendField("motive"),this.appendValueInput("LEFT_CASE").setCheck(["Expression","Type"]).appendField("left"),this.appendValueInput("RIGHT_CASE").setCheck(["Expression","Type"]).appendField("right"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Induction over Either")}},Blockly.Blocks.pie_ind_equal={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("ind-="),this.appendValueInput("MOTIVE").setCheck(["Expression","Type"]).appendField("motive"),this.appendValueInput("BASE").setCheck(["Expression","Type"]).appendField("base"),this.setInputsInline(!1),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Induction over equality")}},Blockly.Blocks.pie_ind_absurd={init:function(){this.appendValueInput("TARGET").setCheck(["Expression","Type"]).appendField("ind-Absurd"),this.appendValueInput("MOTIVE").setCheck("Type").appendField("motive"),this.setInputsInline(!0),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Eliminate Absurd (ex falso quodlibet)")}},Blockly.Blocks.pie_head={init:function(){this.appendValueInput("LIST").setCheck(["Expression","Type"]).appendField("head"),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("First element of a vector")}},Blockly.Blocks.pie_tail={init:function(){this.appendValueInput("LIST").setCheck(["Expression","Type"]).appendField("tail"),this.setOutput(!0,"Expression"),this.setColour(h),this.setTooltip("Tail of a vector")}},this.workspace=Blockly.inject(e.container,{toolbox:k,theme:this.createDarkTheme(),grid:{spacing:20,length:3,colour:"#1a2520",snap:!0},zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.3,scaleSpeed:1.2},trashcan:!0,move:{scrollbars:!0,drag:!0,wheel:!0},renderer:"zelos"}),this.setupChangeListener(),this.initialized=!0}createDarkTheme(){return Blockly.Theme.defineTheme("pie-dark",{name:"pie-dark",base:Blockly.Themes.Classic,componentStyles:{workspaceBackgroundColour:"#1a2520",toolboxBackgroundColour:"#0f1a14",toolboxForegroundColour:"#e8f4ed",flyoutBackgroundColour:"#152119",flyoutForegroundColour:"#e8f4ed",flyoutOpacity:.95,scrollbarColour:"#3d8b5f",scrollbarOpacity:.5,insertionMarkerColour:"#4ade80",insertionMarkerOpacity:.5,markerColour:"#4ade80",cursorColour:"#4ade80"},fontStyle:{family:"Menlo, 'Fira Code', 'JetBrains Mono', monospace",weight:"500",size:12},startHats:!1})}setupChangeListener(){this.workspace&&(this.changeListener=()=>{this.generateCode()},this.workspace.addChangeListener(this.changeListener))}generateCode(){if(this.workspace)try{const e=f.instance.workspaceToCode(this.workspace);this.lastGeneratedCode=e,this.updateCodePreview(e),this.onCodeChange&&this.onCodeChange(e)}catch(e){console.error("Error generating code:",e),this.updateCodePreview(`; Error generating code: ${e}`)}}updateCodePreview(e){this.codePreview&&(this.codePreview.textContent=e||"; (empty workspace)")}getCode(){return this.lastGeneratedCode}clear(){this.workspace&&this.workspace.clear()}resize(){this.workspace&&Blockly.svgResize(this.workspace)}isInitialized(){return this.initialized}loadStarterExample(){if(!this.workspace)return;this.clear();const e=this.workspace.newBlock("pie_claim");e.setFieldValue("myZero","NAME"),e.initSvg(),e.render(),e.moveBy(50,50);const t=this.workspace.newBlock("pie_nat");t.initSvg(),t.render();const n=e.getInput("TYPE");n&&n.connection&&t.outputConnection&&n.connection.connect(t.outputConnection);const i=this.workspace.newBlock("pie_define");i.setFieldValue("myZero","NAME"),i.initSvg(),i.render(),e.nextConnection&&i.previousConnection&&e.nextConnection.connect(i.previousConnection);const s=this.workspace.newBlock("pie_zero");s.initSvg(),s.render();const o=i.getInput("VALUE");o&&o.connection&&s.outputConnection&&o.connection.connect(s.outputConnection),this.generateCode()}dispose(){this.workspace&&(this.changeListener&&this.workspace.removeChangeListener(this.changeListener),this.workspace.dispose(),this.workspace=null),this.initialized=!1}getWorkspace(){return this.workspace}serializeToXml(){if(!this.workspace)return"";const e=Blockly.Xml.workspaceToDom(this.workspace);return Blockly.Xml.domToText(e)}loadFromXml(e){if(!this.workspace)return;this.clear();const t=Blockly.utils.xml.textToDom(e);Blockly.Xml.domToWorkspace(t,this.workspace)}serializeToJson(){return this.workspace?Blockly.serialization.workspaces.save(this.workspace):{}}loadFromJson(e){this.workspace&&Blockly.serialization.workspaces.load(e,this.workspace)}}const v={intro:{type:"intro",displayName:"intro",description:"Introduce a variable from a Pi/Arrow type",applicablePatterns:["Pi","Arrow","->"],requiresInput:"name",color:"#f59e0b"},exact:{type:"exact",displayName:"exact",description:"Provide an exact proof term",applicablePatterns:["*"],requiresInput:"expression",color:"#f59e0b"},exists:{type:"exists",displayName:"exists",description:"Provide a witness for a Sigma type",applicablePatterns:["Sigma","Pair"],requiresInput:"expression",color:"#f59e0b"},left:{type:"left",displayName:"left",description:"Choose the left side of an Either type",applicablePatterns:["Either"],requiresInput:"none",color:"#f59e0b"},right:{type:"right",displayName:"right",description:"Choose the right side of an Either type",applicablePatterns:["Either"],requiresInput:"none",color:"#f59e0b"},split:{type:"split",displayName:"split",description:"Split a Pair/Sigma goal into two subgoals",applicablePatterns:["Pair","Sigma"],requiresInput:"none",color:"#f59e0b"},elimNat:{type:"elimNat",displayName:"elimNat",description:"Induction on a natural number",applicablePatterns:["*"],requiresInput:"name",color:"#f59e0b"},elimList:{type:"elimList",displayName:"elimList",description:"Induction on a list",applicablePatterns:["*"],requiresInput:"name",color:"#f59e0b"},elimVec:{type:"elimVec",displayName:"elimVec",description:"Induction on a vector",applicablePatterns:["*"],requiresInput:"name",color:"#f59e0b"},elimEqual:{type:"elimEqual",displayName:"elimEqual",description:"Eliminate an equality proof",applicablePatterns:["*"],requiresInput:"name",color:"#f59e0b"},elimEither:{type:"elimEither",displayName:"elimEither",description:"Case analysis on an Either value",applicablePatterns:["*"],requiresInput:"name",color:"#f59e0b"},elimAbsurd:{type:"elimAbsurd",displayName:"elimAbsurd",description:"Eliminate an Absurd value (ex falso)",applicablePatterns:["*"],requiresInput:"name",color:"#f59e0b"}};function E(e){const t=e.trim();if(!t)return{kind:"Unknown",sourceText:e};try{return function(e,t){let n=0;function i(){return e[n]}function s(){return e[n++]}function o(){const e=i();if(!e)return{kind:"Unknown",sourceText:t};if("("===e){s();const e=i();if(!e||")"===e)return s(),{kind:"Unknown",sourceText:t};switch(e){case"Pi":case"Π":{if(s(),"("===i()&&(s(),"("===i())){s();const e=s(),n=o();")"===i()&&s(),")"===i()&&s();const a=o();return")"===i()&&s(),{kind:"Pi",bindingName:e,bindingType:n,codomain:a,sourceText:t}}const e=o();return")"===i()&&s(),{kind:"Pi",codomain:e,sourceText:t}}case"->":case"→":{s();const e=[];for(;i()&&")"!==i();)e.push(o());if(")"===i()&&s(),e.length>=2){let n=e[e.length-1];for(let i=e.length-2;i>=0;i--)n={kind:"Arrow",domain:e[i],codomain:n,sourceText:t};return n}return{kind:"Arrow",sourceText:t}}case"Sigma":case"Σ":{if(s(),"("===i()&&(s(),"("===i())){s();const e=s(),n=o();")"===i()&&s(),")"===i()&&s();const a=o();return")"===i()&&s(),{kind:"Sigma",bindingName:e,bindingType:n,codomain:a,sourceText:t}}const e=o();return")"===i()&&s(),{kind:"Sigma",codomain:e,sourceText:t}}case"Pair":{s();const e=o(),n=o();return")"===i()&&s(),{kind:"Pair",left:e,right:n,sourceText:t}}case"Either":{s();const e=o(),n=o();return")"===i()&&s(),{kind:"Either",left:e,right:n,sourceText:t}}case"List":{s();const e=o();return")"===i()&&s(),{kind:"List",elementType:e,sourceText:t}}case"Vec":{s();const e=o(),n=o();return")"===i()&&s(),{kind:"Vec",elementType:e,length:n,sourceText:t}}case"=":{s();const e=o(),n=o(),a=o();return")"===i()&&s(),{kind:"Equal",baseType:e,from:n,to:a,sourceText:t}}default:{const e=s(),n=[];for(;i()&&")"!==i();)n.push(o());")"===i()&&s();const a=T(e);return"Unknown"!==a?{kind:a,sourceText:t}:{kind:"Application",sourceText:t}}}}return{kind:T(s()),sourceText:t}}return o()}(function(e){const t=[];let n=0;for(;n<e.length;){const i=e[n];if(/\s/.test(i)){n++;continue}if("("===i||")"===i){t.push(i),n++;continue}let s="";for(;n<e.length&&!/[\s()]/.test(e[n]);)s+=e[n],n++;s&&t.push(s)}return t}(t),e)}catch{return{kind:"Unknown",sourceText:e}}}function T(e){switch(e){case"Nat":return"Nat";case"Atom":return"Atom";case"Trivial":return"Trivial";case"Absurd":return"Absurd";case"U":return"U";case"Pi":case"Π":return"Pi";case"->":case"→":return"Arrow";case"Sigma":case"Σ":return"Sigma";case"Pair":return"Pair";case"Either":return"Either";case"List":return"List";case"Vec":return"Vec";case"=":return"Equal";default:return"Variable"}}function C(e){switch(e){case"Pi":return"dependent function type (Π)";case"Arrow":return"function type (→)";case"Sigma":return"dependent pair type (Σ)";case"Pair":return"pair type";case"Either":return"sum type (Either)";case"Nat":return"natural number";case"List":return"list type";case"Vec":return"vector type";case"Equal":return"equality type (=)";case"Atom":return"atom type";case"Trivial":return"trivial type";case"Absurd":return"absurd type";case"U":return"universe type";case"Application":return"type application";case"Variable":return"type variable";default:return"unknown type"}}class x{validateTactic(e,t){if(t.isComplete)return{valid:!1,reason:"Goal is already complete"};const n=E(t.type);switch(e.type,e.type){case"intro":return this.validateIntro(e,t,n);case"exact":return this.validateExact(e,t,n);case"exists":return this.validateExists(e,t,n);case"left":case"right":return this.validateLeftRight(e,t,n);case"split":return this.validateSplit(e,t,n);case"elimNat":return this.validateElimNat(e,t);case"elimList":return this.validateElimList(e,t);case"elimVec":return this.validateElimVec(e,t);case"elimEqual":return this.validateElimEqual(e,t);case"elimEither":return this.validateElimEither(e,t);case"elimAbsurd":return this.validateElimAbsurd(e,t);default:return{valid:!0}}}getSuggestedTactics(e){if(e.isComplete)return[];const t=E(e.type),n=[];switch(n.push("exact"),t.kind){case"Pi":case"Arrow":n.unshift("intro");break;case"Sigma":case"Pair":n.unshift("split","exists");break;case"Either":n.unshift("left","right")}for(const t of e.contextEntries){switch(E(t.type).kind){case"Nat":n.includes("elimNat")||n.push("elimNat");break;case"List":n.includes("elimList")||n.push("elimList");break;case"Vec":n.includes("elimVec")||n.push("elimVec");break;case"Equal":n.includes("elimEqual")||n.push("elimEqual");break;case"Either":n.includes("elimEither")||n.push("elimEither");break;case"Absurd":n.includes("elimAbsurd")||n.push("elimAbsurd")}}return n}canApplyAnyTactic(e){return!e.isComplete}validateIntro(e,t,n){if("Pi"!==n.kind&&"Arrow"!==n.kind)return{valid:!1,reason:`intro requires a function type (Π or →), but goal is ${C(n.kind)}`,suggestions:this.getSuggestedTactics(t)};if(!e.name||""===e.name.trim())return{valid:!1,reason:"intro requires a variable name"};return t.contextEntries.some((t=>t.name===e.name))?{valid:!1,reason:`Variable name '${e.name}' already exists in context`}:{valid:!0}}validateExact(e,t,n){return e.expression&&""!==e.expression.trim()?{valid:!0}:{valid:!1,reason:"exact requires a proof term"}}validateExists(e,t,n){return"Sigma"!==n.kind&&"Pair"!==n.kind?{valid:!1,reason:`exists requires a pair/sigma type, but goal is ${C(n.kind)}`,suggestions:this.getSuggestedTactics(t)}:e.expression&&""!==e.expression.trim()?{valid:!0}:{valid:!1,reason:"exists requires a witness expression"}}validateLeftRight(e,t,n){return"Either"!==n.kind?{valid:!1,reason:`${e.type} requires an Either type, but goal is ${C(n.kind)}`,suggestions:this.getSuggestedTactics(t)}:{valid:!0}}validateSplit(e,t,n){return"Pair"!==n.kind&&"Sigma"!==n.kind?{valid:!1,reason:`split requires a pair/sigma type, but goal is ${C(n.kind)}`,suggestions:this.getSuggestedTactics(t)}:{valid:!0}}validateElimNat(e,t){if(!e.name)return{valid:!1,reason:"elimNat requires a target variable name"};const n=t.contextEntries.find((t=>t.name===e.name));if(!n)return{valid:!1,reason:`Variable '${e.name}' not found in context`};return"Nat"!==E(n.type).kind?{valid:!1,reason:`'${e.name}' has type ${n.type}, not Nat`}:{valid:!0}}validateElimList(e,t){if(!e.name)return{valid:!1,reason:"elimList requires a target variable name"};const n=t.contextEntries.find((t=>t.name===e.name));if(!n)return{valid:!1,reason:`Variable '${e.name}' not found in context`};return"List"!==E(n.type).kind?{valid:!1,reason:`'${e.name}' has type ${n.type}, not List`}:{valid:!0}}validateElimVec(e,t){if(!e.name)return{valid:!1,reason:"elimVec requires a target variable name"};const n=t.contextEntries.find((t=>t.name===e.name));if(!n)return{valid:!1,reason:`Variable '${e.name}' not found in context`};return"Vec"!==E(n.type).kind?{valid:!1,reason:`'${e.name}' has type ${n.type}, not Vec`}:{valid:!0}}validateElimEqual(e,t){if(!e.name)return{valid:!1,reason:"elimEqual requires a target variable name"};const n=t.contextEntries.find((t=>t.name===e.name));if(!n)return{valid:!1,reason:`Variable '${e.name}' not found in context`};return"Equal"!==E(n.type).kind?{valid:!1,reason:`'${e.name}' has type ${n.type}, not an equality type`}:{valid:!0}}validateElimEither(e,t){if(!e.name)return{valid:!1,reason:"elimEither requires a target variable name"};const n=t.contextEntries.find((t=>t.name===e.name));if(!n)return{valid:!1,reason:`Variable '${e.name}' not found in context`};return"Either"!==E(n.type).kind?{valid:!1,reason:`'${e.name}' has type ${n.type}, not Either`}:{valid:!0}}validateElimAbsurd(e,t){if(!e.name)return{valid:!1,reason:"elimAbsurd requires a target variable name"};const n=t.contextEntries.find((t=>t.name===e.name));if(!n)return{valid:!1,reason:`Variable '${e.name}' not found in context`};return"Absurd"!==E(n.type).kind?{valid:!1,reason:`'${e.name}' has type ${n.type}, not Absurd`}:{valid:!0}}}function w(e){e.classList.remove("drop-zone--valid","drop-zone--invalid")}function _(e,t){const n=document.createElement("div");n.className="confetti-particle",n.style.cssText=`\n    position: absolute;\n    width: 8px;\n    height: 8px;\n    background: hsl(${360*Math.random()}, 70%, 60%);\n    border-radius: 2px;\n    pointer-events: none;\n    left: 50%;\n    top: 50%;\n    animation: confetti-fall 1.5s ease-out ${t}ms forwards;\n    transform: translate(-50%, -50%);\n  `,e.appendChild(n),setTimeout((()=>{n.remove()}),2e3+t)}class N{constructor(e){this.state={isDragging:!1,tacticData:null,sourceElement:null,ghostElement:null,validDropTargets:[]},this.dropZones=new Map,this.goals=new Map,this.config=e,this.validationService=e.validationService,this.boundMouseMove=this.handleMouseMove.bind(this),this.boundMouseUp=this.handleMouseUp.bind(this),this.boundKeyDown=this.handleKeyDown.bind(this)}registerDropZone(e,t){const n=t.getBoundingClientRect();this.dropZones.set(e,{goalId:e,element:t,bounds:n}),t.addEventListener("mouseenter",(()=>this.handleDropZoneEnter(e))),t.addEventListener("mouseleave",(()=>this.handleDropZoneLeave(e)))}clearDropZones(){this.dropZones.clear()}setGoals(e){this.goals=e}startDrag(e,t,n){if(this.state.isDragging)return;const i=v[e.type],s=function(e,t){const n=document.createElement("div");return n.className="tactic-drag-ghost",n.textContent=e,n.style.cssText=`\n    position: fixed;\n    padding: 8px 16px;\n    background: ${t};\n    color: white;\n    border-radius: 6px;\n    font-family: Menlo, 'Fira Code', monospace;\n    font-size: 13px;\n    font-weight: 600;\n    pointer-events: none;\n    z-index: 10000;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n    transform: translate(-50%, -50%);\n    opacity: 0.9;\n  `,n}(i.displayName,i.color);document.body.appendChild(s),s.style.left=`${n.clientX}px`,s.style.top=`${n.clientY}px`;const o=[];for(const[e,t]of this.goals)t.isComplete||o.push(e);this.state={isDragging:!0,tacticData:e,sourceElement:t,ghostElement:s,validDropTargets:o},document.addEventListener("mousemove",this.boundMouseMove),document.addEventListener("mouseup",this.boundMouseUp),document.addEventListener("keydown",this.boundKeyDown),this.updateDropZoneHighlights(),this.config.onDragStart?.(e)}cancelDrag(){this.state.isDragging&&(this.cleanup(),this.config.onDragEnd?.())}isDragging(){return this.state.isDragging}getDragState(){return this.state}updateDropZoneBounds(){for(const[e,t]of this.dropZones)t.bounds=t.element.getBoundingClientRect()}handleMouseMove(e){if(!this.state.isDragging||!this.state.ghostElement)return;this.state.ghostElement.style.left=`${e.clientX}px`,this.state.ghostElement.style.top=`${e.clientY}px`;const t=this.findDropZoneAt(e.clientX,e.clientY);t&&this.handleDropZoneEnter(t.goalId)}handleMouseUp(e){if(!this.state.isDragging||!this.state.tacticData)return;const t=this.findDropZoneAt(e.clientX,e.clientY);if(t&&this.state.validDropTargets.includes(t.goalId)){const e=this.goals.get(t.goalId);if(e){const n=this.validationService.validateTactic(this.state.tacticData,e);n.valid?this.config.onDrop?.(t.goalId,this.state.tacticData):console.warn("Invalid tactic drop:",n.reason)}}this.cleanup(),this.config.onDragEnd?.()}handleKeyDown(e){"Escape"===e.key&&this.cancelDrag()}handleDropZoneEnter(e){if(!this.state.isDragging||!this.state.tacticData)return;const t=this.goals.get(e);if(!t)return;const n=this.validationService.validateTactic(this.state.tacticData,t),i=this.dropZones.get(e);var s,o;i&&(s=i.element,o=n.valid,s.classList.remove("drop-zone--valid","drop-zone--invalid"),s.classList.add(o?"drop-zone--valid":"drop-zone--invalid")),this.config.onDragOver?.({goalId:e,isValid:n.valid,tacticData:this.state.tacticData})}handleDropZoneLeave(e){if(!this.state.isDragging)return;const t=this.dropZones.get(e);t&&w(t.element)}findDropZoneAt(e,t){for(const[,n]of this.dropZones){const{bounds:i}=n;if(e>=i.left&&e<=i.right&&t>=i.top&&t<=i.bottom)return n}return null}updateDropZoneHighlights(){for(const[e,t]of this.dropZones)this.state.validDropTargets.includes(e)?t.element.classList.add("drop-zone--active"):t.element.classList.remove("drop-zone--active")}cleanup(){this.state.ghostElement&&this.state.ghostElement.remove();for(const[,e]of this.dropZones)w(e.element),e.element.classList.remove("drop-zone--active");document.removeEventListener("mousemove",this.boundMouseMove),document.removeEventListener("mouseup",this.boundMouseUp),document.removeEventListener("keydown",this.boundKeyDown),this.state={isDragging:!1,tacticData:null,sourceElement:null,ghostElement:null,validDropTargets:[]}}dispose(){this.cancelDrag(),this.clearDropZones(),this.goals.clear()}}const A=[{name:"Introduction",description:"Introduce variables and structure",tactics:["intro","exists","split"]},{name:"Direct Proof",description:"Provide proof terms directly",tactics:["exact"]},{name:"Case Analysis",description:"Choose branches",tactics:["left","right"]},{name:"Elimination",description:"Induction and case analysis",tactics:["elimNat","elimList","elimVec","elimEqual","elimEither","elimAbsurd"]}];class S{constructor(e){this.selectedGoal=null,this.tacticElements=new Map,this.inputModal=null,this.config=e,this.container=e.container,this.validationService=e.validationService,this.dragManager=e.dragManager,this.render()}setSelectedGoal(e){this.selectedGoal=e,this.updateTacticStates()}getSelectedGoal(){return this.selectedGoal}refresh(){this.updateTacticStates()}render(){this.container.innerHTML="",this.container.className="tactic-palette";const e=document.createElement("div");e.className="tactic-palette__header",e.innerHTML='\n      <h3 class="tactic-palette__title">Tactics</h3>\n      <p class="tactic-palette__hint">Drag a tactic onto a goal</p>\n    ',this.container.appendChild(e);const t=document.createElement("div");t.className="tactic-palette__categories";for(const e of A){const n=this.renderCategory(e);t.appendChild(n)}this.container.appendChild(t);const n=document.createElement("div");n.className="tactic-palette__suggestions",n.id="tactic-suggestions",n.innerHTML='\n      <div class="tactic-palette__suggestions-header">\n        <span class="suggestions-icon">💡</span>\n        <span>Suggested tactics will appear here</span>\n      </div>\n    ',this.container.appendChild(n)}renderCategory(e){const t=document.createElement("div");t.className="tactic-palette__category";const n=document.createElement("div");n.className="tactic-palette__category-header",n.innerHTML=`\n      <span class="category-name">${e.name}</span>\n      <span class="category-description">${e.description}</span>\n    `,t.appendChild(n);const i=document.createElement("div");i.className="tactic-palette__category-tactics";for(const t of e.tactics){const e=v[t],n=this.renderTacticBlock(t,e);i.appendChild(n),this.tacticElements.set(t,n)}return t.appendChild(i),t}renderTacticBlock(e,t){const n=document.createElement("div");return n.className="tactic-block",n.dataset.tacticType=e,n.draggable=!0,n.innerHTML=`\n      <div class="tactic-block__header" style="background: ${t.color}">\n        <span class="tactic-block__name">${t.displayName}</span>\n        ${"none"!==t.requiresInput?'<span class="tactic-block__input-indicator">...</span>':""}\n      </div>\n      <div class="tactic-block__description">${t.description}</div>\n    `,n.addEventListener("mousedown",(n=>this.handleTacticMouseDown(n,e,t))),n.addEventListener("click",(()=>this.handleTacticClick(e,t))),n}handleTacticMouseDown(e,t,n){if(e.preventDefault(),"none"!==n.requiresInput)return;const i={type:t};this.dragManager.startDrag(i,e.target,e)}handleTacticClick(e,t){"none"!==t.requiresInput&&this.showInputModal(e,t)}showInputModal(e,t){this.inputModal&&this.inputModal.remove();const n=this.selectedGoal,i=document.createElement("div");i.className="tactic-input-modal";const s="name"===t.requiresInput?"Variable name:":"Expression:",o="name"===t.requiresInput?"e.g., x":"e.g., (cons 0 (same 0))";i.innerHTML=`\n      <div class="tactic-input-modal__content">\n        <div class="tactic-input-modal__header">\n          <span class="tactic-name" style="color: ${t.color}">${t.displayName}</span>\n          <button class="tactic-input-modal__close">&times;</button>\n        </div>\n        <div class="tactic-input-modal__body">\n          <label class="tactic-input-modal__label">${s}</label>\n          <input type="text" class="tactic-input-modal__input" placeholder="${o}" autofocus>\n        </div>\n        <div class="tactic-input-modal__footer">\n          <button class="tactic-input-modal__cancel">Cancel</button>\n          <button class="tactic-input-modal__apply" style="background: ${t.color}">Apply</button>\n        </div>\n      </div>\n    `;const a=i.querySelector(".tactic-input-modal__close"),r=i.querySelector(".tactic-input-modal__cancel"),l=i.querySelector(".tactic-input-modal__apply"),c=i.querySelector(".tactic-input-modal__input");a.addEventListener("click",(()=>i.remove())),r.addEventListener("click",(()=>i.remove())),l.addEventListener("click",(()=>{const s=c.value.trim();if(!s)return void c.classList.add("error");const o={type:e,["name"===t.requiresInput?"name":"expression"]:s};console.log("[TacticPalette] Apply clicked",{tacticData:o,capturedGoal:n?.id,currentSelectedGoal:this.selectedGoal?.id}),i.remove(),this.config.onTacticSelect?.(o,n?.id)})),c.addEventListener("keydown",(e=>{"Enter"===e.key?l.click():"Escape"===e.key&&i.remove()})),i.addEventListener("click",(e=>{e.target===i&&i.remove()})),this.container.appendChild(i),this.inputModal=i,setTimeout((()=>c.focus()),0)}updateTacticStates(){const e=document.getElementById("tactic-suggestions");if(!this.selectedGoal){for(const[,e]of this.tacticElements)e.classList.add("tactic-block--disabled"),e.classList.remove("tactic-block--suggested");return void(e&&(e.innerHTML='\n          <div class="tactic-palette__suggestions-header">\n            <span class="suggestions-icon">💡</span>\n            <span>Select a goal to see suggestions</span>\n          </div>\n        '))}const t=this.validationService.getSuggestedTactics(this.selectedGoal);for(const[e,n]of this.tacticElements){const i=t.includes(e);n.classList.remove("tactic-block--disabled","tactic-block--suggested"),this.selectedGoal.isComplete?n.classList.add("tactic-block--disabled"):i&&n.classList.add("tactic-block--suggested")}if(e&&t.length>0){const n=t.slice(0,3);e.innerHTML=`\n        <div class="tactic-palette__suggestions-header">\n          <span class="suggestions-icon">💡</span>\n          <span>Try these tactics:</span>\n        </div>\n        <div class="tactic-palette__suggestions-list">\n          ${n.map((e=>{const t=v[e];return`\n              <div class="suggestion-chip" style="border-color: ${t.color}">\n                ${t.displayName}\n              </div>\n            `})).join("")}\n        </div>\n      `}}dispose(){this.inputModal&&this.inputModal.remove(),this.tacticElements.clear(),this.container.innerHTML=""}}const I={nodeWidth:200,nodeHeight:70,horizontalSpacing:40,verticalSpacing:100,dropZoneHeight:24,colors:{current:"#f59e0b",completed:"#34d399",pending:"#64748b",edge:"#475569",tacticLabel:"#94a3b8",background:"#0f172a",dropZone:"rgba(245, 158, 11, 0.1)",dropZoneValid:"rgba(52, 211, 153, 0.3)",dropZoneInvalid:"rgba(239, 68, 68, 0.3)"}};class B{constructor(e){this.svg=null,this.onGoalSelect=null,this.onGoalDoubleClick=null,this.currentData=null,this.goalElements=new Map,this.dropZoneElements=new Map,this.container=e.container,this.dragManager=e.dragManager,this.onGoalSelect=e.onGoalSelect||null,this.onGoalDoubleClick=e.onGoalDoubleClick||null,this.config={...I,...e.config}}render(e){this.currentData=e,this.clear();const t=this.calculateLayout(e.root);let n=1/0,i=-1/0,s=0;t.forEach((e=>{n=Math.min(n,e.x),i=Math.max(i,e.x+e.width),s=Math.max(s,e.y+this.config.nodeHeight+this.config.dropZoneHeight)}));const o=i-n+60,a=s+60,r=30-n;this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("viewBox",`0 0 ${o} ${a}`),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height",String(a)),this.svg.style.display="block",this.svg.style.maxWidth="100%",this.svg.classList.add("interactive-proof-tree");const l=document.createElementNS("http://www.w3.org/2000/svg","g");l.classList.add("edges-layer");const c=document.createElementNS("http://www.w3.org/2000/svg","g");c.classList.add("drop-zones-layer");const d=document.createElementNS("http://www.w3.org/2000/svg","g");d.classList.add("nodes-layer"),this.svg.appendChild(l),this.svg.appendChild(c),this.svg.appendChild(d),this.renderNodeRecursive(e.root,t,r,30,l,c,d),this.container.appendChild(this.svg),this.registerDropZones(),this.container.addEventListener("scroll",(()=>{this.dragManager.updateDropZoneBounds()}))}clear(){this.svg&&this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svg=null,this.goalElements.clear(),this.dropZoneElements.clear(),this.dragManager.clearDropZones()}highlightGoal(e){for(const[,e]of this.goalElements)e.classList.remove("goal-node--selected");const t=this.goalElements.get(e);t&&t.classList.add("goal-node--selected")}getGoalElement(e){return this.goalElements.get(e)||null}dispose(){this.clear()}renderNodeRecursive(e,t,n,i,s,o,a){const r=t.get(e.goal.id);if(!r)return;const l=r.x+n,c=r.y+i;for(const o of e.children){const a=t.get(o.goal.id);if(a){const t=a.x+n,o=a.y+i;this.renderEdge(s,l,c,t,o,e.appliedTactic)}}e.completedBy&&0===e.children.length&&this.renderSelfLoop(s,l,c,e.completedBy),e.goal.isComplete||this.renderDropZone(o,e.goal,l,c),this.renderNode(a,e.goal,l,c);for(const r of e.children)this.renderNodeRecursive(r,t,n,i,s,o,a)}renderNode(e,t,n,i){const{nodeWidth:s,nodeHeight:o,colors:a}=this.config,r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("class","goal-node"),r.setAttribute("data-goal-id",t.id),r.style.cursor="pointer";let l=a.pending,c="0.1";t.isCurrent?(l=a.current,c="0.2"):t.isComplete&&(l=a.completed,c="0.15");const d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",String(n)),d.setAttribute("y",String(i)),d.setAttribute("width",String(s)),d.setAttribute("height",String(o)),d.setAttribute("rx","10"),d.setAttribute("ry","10"),d.setAttribute("fill",l),d.setAttribute("fill-opacity",c),d.setAttribute("stroke",l),d.setAttribute("stroke-width",t.isCurrent?"3":"2"),r.appendChild(d);const p=document.createElementNS("http://www.w3.org/2000/svg","text");p.setAttribute("x",String(n+12)),p.setAttribute("y",String(i+20)),p.setAttribute("fill",l),p.setAttribute("font-size","12"),p.setAttribute("font-family","monospace"),p.setAttribute("font-weight","600"),p.textContent=t.id,r.appendChild(p);const u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",String(n+s-12)),u.setAttribute("y",String(i+20)),u.setAttribute("text-anchor","end"),u.setAttribute("fill",l),u.setAttribute("font-size","14"),t.isComplete?u.textContent="✓":t.isCurrent?u.textContent="→":u.textContent="○",r.appendChild(u);const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",String(n+12)),h.setAttribute("y",String(i+45)),h.setAttribute("fill","#e2e8f0"),h.setAttribute("font-size","11"),h.setAttribute("font-family","monospace");const m=this.truncateText(t.type,s-24);if(h.textContent=m,r.appendChild(h),t.contextEntries.length>0){const e=document.createElementNS("http://www.w3.org/2000/svg","text");e.setAttribute("x",String(n+12)),e.setAttribute("y",String(i+o-8)),e.setAttribute("fill",a.tacticLabel),e.setAttribute("font-size","10"),e.setAttribute("font-family","monospace"),e.textContent=`${t.contextEntries.length} var${1!==t.contextEntries.length?"s":""} in context`,r.appendChild(e)}r.addEventListener("click",(()=>{this.onGoalSelect&&this.onGoalSelect(t)})),r.addEventListener("dblclick",(()=>{this.onGoalDoubleClick&&this.onGoalDoubleClick(t)})),r.addEventListener("mouseenter",(()=>{d.setAttribute("fill-opacity",String(parseFloat(c)+.1))})),r.addEventListener("mouseleave",(()=>{d.setAttribute("fill-opacity",c)})),e.appendChild(r),this.goalElements.set(t.id,r)}renderDropZone(e,t,n,i){const{nodeWidth:s,nodeHeight:o,dropZoneHeight:a,colors:r}=this.config,l=document.createElementNS("http://www.w3.org/2000/svg","g");l.setAttribute("class","drop-zone"),l.setAttribute("data-goal-id",t.id);const c=i+o+4,d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",String(n)),d.setAttribute("y",String(c)),d.setAttribute("width",String(s)),d.setAttribute("height",String(a)),d.setAttribute("rx","6"),d.setAttribute("ry","6"),d.setAttribute("fill",r.dropZone),d.setAttribute("stroke",r.current),d.setAttribute("stroke-width","1"),d.setAttribute("stroke-dasharray","4,4"),l.appendChild(d);const p=document.createElementNS("http://www.w3.org/2000/svg","text");p.setAttribute("x",String(n+s/2)),p.setAttribute("y",String(c+a/2+4)),p.setAttribute("text-anchor","middle"),p.setAttribute("fill",r.tacticLabel),p.setAttribute("font-size","10"),p.setAttribute("font-family","monospace"),p.textContent="Drop tactic here",l.appendChild(p),e.appendChild(l),this.dropZoneElements.set(t.id,l)}renderEdge(e,t,n,i,s,o){const{nodeWidth:a,nodeHeight:r,dropZoneHeight:l,colors:c}=this.config,d=t+a/2,p=n+r+l+8,u=i+a/2,h=s,m=document.createElementNS("http://www.w3.org/2000/svg","path"),g=(p+h)/2,f=`M ${d} ${p} C ${d} ${g}, ${u} ${g}, ${u} ${h}`;if(m.setAttribute("d",f),m.setAttribute("fill","none"),m.setAttribute("stroke",c.edge),m.setAttribute("stroke-width","2"),e.appendChild(m),o){const t=(d+u)/2,n=g,i=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=this.truncateText(o,100),a=Math.min(7*s.length+12,120);i.setAttribute("x",String(t-a/2)),i.setAttribute("y",String(n-10)),i.setAttribute("width",String(a)),i.setAttribute("height","20"),i.setAttribute("rx","4"),i.setAttribute("fill",c.background),i.setAttribute("fill-opacity","0.9"),e.appendChild(i);const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",String(t)),r.setAttribute("y",String(n+4)),r.setAttribute("text-anchor","middle"),r.setAttribute("fill",c.tacticLabel),r.setAttribute("font-size","11"),r.setAttribute("font-family","monospace"),r.textContent=s,e.appendChild(r)}}renderSelfLoop(e,t,n,i){const{nodeWidth:s,nodeHeight:o,dropZoneHeight:a,colors:r}=this.config,l=t+s/2,c=n+o+a+8,d=document.createElementNS("http://www.w3.org/2000/svg","path"),p=`M ${l-15} ${c}\n               C ${l-45} ${c+30},\n                 ${l+45} ${c+30},\n                 ${l+15} ${c}`;d.setAttribute("d",p),d.setAttribute("fill","none"),d.setAttribute("stroke",r.completed),d.setAttribute("stroke-width","2"),e.appendChild(d);const u=document.createElementNS("http://www.w3.org/2000/svg","polygon"),h=l+15,m=c;u.setAttribute("points",`${h},${m} ${h+6},${m+6} ${h-6},${m+6}`),u.setAttribute("fill",r.completed),e.appendChild(u);const g=c+30+5,f=this.truncateText(i,120),y=Math.min(6.5*f.length+12,130),k=document.createElementNS("http://www.w3.org/2000/svg","rect");k.setAttribute("x",String(l-y/2)),k.setAttribute("y",String(g-10)),k.setAttribute("width",String(y)),k.setAttribute("height","18"),k.setAttribute("rx","4"),k.setAttribute("fill",r.background),k.setAttribute("fill-opacity","0.9"),e.appendChild(k);const b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("x",String(l)),b.setAttribute("y",String(g+3)),b.setAttribute("text-anchor","middle"),b.setAttribute("fill",r.completed),b.setAttribute("font-size","10"),b.setAttribute("font-family","monospace"),b.textContent=f,e.appendChild(b)}calculateLayout(e){const t=new Map,n=new Map;return this.calculateSubtreeWidths(e,n),this.assignPositions(e,0,0,n,t),t}calculateSubtreeWidths(e,t){const{nodeWidth:n,horizontalSpacing:i}=this.config;if(0===e.children.length)return t.set(e.goal.id,n),n;let s=0;for(const n of e.children)s+=this.calculateSubtreeWidths(n,t);s+=(e.children.length-1)*i;const o=Math.max(n,s);return t.set(e.goal.id,o),o}assignPositions(e,t,n,i,s){const{nodeWidth:o,nodeHeight:a,horizontalSpacing:r,verticalSpacing:l,dropZoneHeight:c}=this.config,d=t+((i.get(e.goal.id)||o)-o)/2;if(s.set(e.goal.id,{x:d,y:n,width:o}),e.children.length>0){const d=n+a+c+l;let p=t;for(const t of e.children){const e=i.get(t.goal.id)||o;this.assignPositions(t,p,d,i,s),p+=e+r}}}truncateText(e,t){const n=Math.floor(t/7);return e.length<=n?e:e.substring(0,n-3)+"..."}registerDropZones(){for(const[e,t]of this.dropZoneElements)this.dragManager.registerDropZone(e,t);for(const[e,t]of this.goalElements){const n=this.findGoalById(e);n&&!n.isComplete&&this.dragManager.registerDropZone(e,t)}}findGoalById(e){if(!this.currentData)return null;const t=n=>{if(n.goal.id===e)return n.goal;for(const e of n.children){const n=t(e);if(n)return n}return null};return t(this.currentData.root)}}class L{constructor(e){this.tacticPalette=null,this.proofVisualizer=null,this.worker=null,this.pendingCallbacks=new Map,this.callbackId=0,this.sourceContext="",this.config=e,this.state={proofTree:null,selectedGoalId:null,history:[],historyPosition:0,isComplete:!1,claimName:null},this.validationService=new x,this.dragManager=new N({validationService:this.validationService,onDragStart:e=>this.handleDragStart(e),onDragEnd:()=>this.handleDragEnd(),onDrop:(e,t)=>this.handleDrop(e,t),onDragOver:e=>this.handleDragOver(e)})}initialize(e){this.worker=e,e.addEventListener("message",(e=>this.handleWorkerMessage(e))),this.tacticPalette=new S({container:this.config.paletteContainer,validationService:this.validationService,dragManager:this.dragManager,onTacticSelect:(e,t)=>this.handleTacticSelect(e,t)}),this.proofVisualizer=new B({container:this.config.treeContainer,dragManager:this.dragManager,onGoalSelect:e=>this.handleGoalSelect(e),onGoalDoubleClick:e=>this.handleGoalDoubleClick(e)})}startProof(e,t){this.sourceContext=t,this.state.claimName=e,this.sendWorkerMessage("startInteractiveProof",{claimName:e,sourceContext:t})}applyTacticToSelectedGoal(e){this.state.selectedGoalId?this.applyTacticToGoal(this.state.selectedGoalId,e):this.config.onError?.("No goal selected")}applyTacticToGoal(e,t){console.log("[Controller] applyTacticToGoal",{goalId:e,tactic:t});const n=this.findGoal(e);if(!n)return console.log("[Controller] Goal not found:",e),void this.config.onError?.(`Goal ${e} not found`);const i=this.validationService.validateTactic(t,n);if(!i.valid)return console.log("[Controller] Validation failed:",i.reason),this.config.onError?.(i.reason||"Invalid tactic"),void this.showErrorFeedback(e);this.state.proofTree&&(this.state.history=this.state.history.slice(0,this.state.historyPosition),this.state.history.push({goalId:e,tactic:t,previousState:JSON.parse(JSON.stringify(this.state.proofTree))}),this.state.historyPosition=this.state.history.length);const s=this.formatTactic(t);console.log("[Controller] Formatted tactic:",s),console.log("[Controller] Source context length:",this.sourceContext.length);const o=this.insertTacticIntoSource(s);console.log("[Controller] Modified source:",o?`${o.length} chars`:"null"),o&&this.config.onModifySource?(console.log("[Controller] Calling onModifySource"),this.config.onModifySource(o),this.sourceContext=o,this.showSuccessFeedback(e)):(console.log("[Controller] Failed to insert tactic",{modifiedSource:!!o,hasCallback:!!this.config.onModifySource}),this.config.onError?.("Failed to insert tactic into source"),this.showErrorFeedback(e))}formatTactic(e){return e.name?`(${e.type} ${e.name})`:e.expression?`(${e.type} ${e.expression})`:`(${e.type})`}insertTacticIntoSource(e){const t=this.sourceContext,n=t.match(/\(define-tactically\s+(\w+)/);if(!n||void 0===n.index)return null;let i=0,s=n.index,o=-1,a=!1;for(;s<t.length;){const e=t[s];if(";"!==e||a)if("\n"===e&&a)a=!1,s++;else if(a)s++;else{if("("===e)i++;else if(")"===e&&(i--,1===i&&(o=s),0===i))break;s++}else a=!0,s++}if(-1===o)return console.log("[Controller] Could not find tactic list end"),null;let r=t.lastIndexOf("\n",o-1);-1===r?r=0:r++;const l=t.substring(r,o).match(/^(\s*)/),c=`${e}\n${l&&l[1].length>0?l[1]:"    "}`;return t.substring(0,o)+c+t.substring(o)}undo(){if(this.state.historyPosition<=0)return;this.state.historyPosition--;const e=this.state.history[this.state.historyPosition];this.updateProofTree(e.previousState),this.config.onStateChange?.(this.state)}redo(){if(this.state.historyPosition>=this.state.history.length)return;const e=this.state.history[this.state.historyPosition];this.state.historyPosition++,this.sendWorkerMessage("applyTactic",{goalId:e.goalId,tactic:e.tactic,sourceContext:this.sourceContext})}getState(){return this.state}generateCode(){if(!this.state.proofTree||!this.state.claimName)return"";const e=this.collectTacticsFromTree(this.state.proofTree.root).map((e=>`  ${this.tacticToCode(e)}`)).join("\n");return`(define-tactically ${this.state.claimName}\n  (\n${e}\n  ))`}updateSourceContext(e){this.sourceContext=e}setProofTree(e){this.updateProofTree(e)}dispose(){this.tacticPalette?.dispose(),this.proofVisualizer?.dispose(),this.dragManager.dispose(),this.pendingCallbacks.clear(),this.worker=null}handleWorkerMessage(e){const{type:t,payload:n,callbackId:i}=e.data;if(i&&this.pendingCallbacks.has(i)){const e=this.pendingCallbacks.get(i);return this.pendingCallbacks.delete(i),void e(n)}switch(t){case"proofStarted":this.handleProofStarted(n);break;case"tacticResult":this.handleTacticResult(n);break;case"proofComplete":this.handleProofComplete(n);break;case"error":this.handleError(n)}}handleProofStarted(e){this.updateProofTree(e.proofTree),e.proofTree?.currentGoalId&&this.selectGoal(e.proofTree.currentGoalId),this.config.onStateChange?.(this.state)}handleTacticResult(e){e.success?(this.updateProofTree(e.proofTree),this.state.selectedGoalId&&this.showSuccessFeedback(this.state.selectedGoalId),e.proofTree?.currentGoalId?this.selectGoal(e.proofTree.currentGoalId):e.proofTree?.isComplete&&this.handleProofComplete(e)):(this.state.historyPosition>0&&(this.state.historyPosition--,this.state.history.pop()),this.config.onError?.(e.message||"Tactic failed"),this.state.selectedGoalId&&this.showErrorFeedback(this.state.selectedGoalId)),this.config.onStateChange?.(this.state)}handleProofComplete(e){this.state.isComplete=!0;const t=e.generatedCode||this.generateCode();var n;this.config.treeContainer&&(n=this.config.treeContainer,new Promise((e=>{n.classList.add("proof-complete-celebration");for(let e=0;e<20;e++)_(n,50*e);setTimeout((()=>{n.classList.remove("proof-complete-celebration"),e()}),2e3)}))),this.config.onProofComplete?.(t),this.config.onStateChange?.(this.state)}handleError(e){this.config.onError?.(e.message||"An error occurred")}handleGoalSelect(e){this.selectGoal(e.id)}handleGoalDoubleClick(e){const t=this.validationService.getSuggestedTactics(e);console.log("Suggested tactics for",e.id,":",t)}handleTacticSelect(e,t){console.log("[Controller] handleTacticSelect called",{tactic:e,goalId:t,selectedGoalId:this.state.selectedGoalId});const n=t||this.state.selectedGoalId;if(!n)return console.log("[Controller] No target goal ID"),void this.config.onError?.("No goal selected");console.log("[Controller] Applying tactic to goal:",n),this.applyTacticToGoal(n,e)}handleDragStart(e){if(this.state.proofTree){const e=new Map;this.collectGoals(this.state.proofTree.root,e),this.dragManager.setGoals(e)}}handleDragEnd(){}handleDrop(e,t){this.applyTacticToGoal(e,t)}handleDragOver(e){}selectGoal(e){this.state.selectedGoalId=e;const t=this.findGoal(e);t&&(this.tacticPalette?.setSelectedGoal(t),this.proofVisualizer?.highlightGoal(e),this.updateDetailsPanel(t)),this.config.onStateChange?.(this.state)}updateProofTree(e){if(this.state.proofTree=e,e){this.state.isComplete=e.isComplete,this.proofVisualizer?.render(e);const t=new Map;this.collectGoals(e.root,t),this.dragManager.setGoals(t),this.state.selectedGoalId&&!t.has(this.state.selectedGoalId)&&(this.state.selectedGoalId=null,this.tacticPalette?.setSelectedGoal(null))}else this.proofVisualizer?.clear(),this.state.selectedGoalId=null,this.state.isComplete=!1,this.tacticPalette?.setSelectedGoal(null)}updateDetailsPanel(e){const t=this.config.detailsContainer;t&&(t.innerHTML=`\n      <div class="goal-details">\n        <div class="goal-details__header">\n          <span class="goal-details__id">${e.id}</span>\n          <span class="goal-details__status ${e.isComplete?"status-completed":e.isCurrent?"status-current":"status-pending"}">\n            ${e.isComplete?"Completed":e.isCurrent?"Current":"Pending"}\n          </span>\n        </div>\n        <div class="goal-details__type">\n          <div class="goal-details__label">Goal Type</div>\n          <pre class="goal-details__type-content">${e.type}</pre>\n        </div>\n        ${e.contextEntries.length>0?`\n          <div class="goal-details__context">\n            <div class="goal-details__label">Context</div>\n            <div class="goal-details__context-list">\n              ${e.contextEntries.map((e=>`\n                <div class="context-entry">\n                  <span class="context-entry__name">${e.name}</span>\n                  <span class="context-entry__colon">:</span>\n                  <span class="context-entry__type">${e.type}</span>\n                </div>\n              `)).join("")}\n            </div>\n          </div>\n        `:""}\n      </div>\n    `)}findGoal(e){if(!this.state.proofTree)return null;const t=n=>{if(n.goal.id===e)return n.goal;for(const e of n.children){const n=t(e);if(n)return n}return null};return t(this.state.proofTree.root)}collectGoals(e,t){t.set(e.goal.id,e.goal);for(const n of e.children)this.collectGoals(n,t)}collectTacticsFromTree(e){const t=[];e.appliedTactic&&t.push(e.appliedTactic),e.completedBy&&t.push(e.completedBy);for(const n of e.children)t.push(...this.collectTacticsFromTree(n));return t}tacticToCode(e){return`(${e})`}showSuccessFeedback(e){const t=this.proofVisualizer?.getGoalElement(e);t&&function(e,t=500){new Promise((n=>{const i=e.querySelector("rect")||e;i.getAttribute?.("fill")||i.style.backgroundColor,e.classList.add("success-pulse"),setTimeout((()=>{e.classList.remove("success-pulse"),n()}),t)}))}(t)}showErrorFeedback(e){const t=this.proofVisualizer?.getGoalElement(e);t&&function(e,t=400){new Promise((n=>{e.classList.add("error-shake"),setTimeout((()=>{e.classList.remove("error-shake"),n()}),t)}))}(t)}sendWorkerMessage(e,t){return new Promise((n=>{if(!this.worker)return void n(null);const i="callback-"+this.callbackId++;this.pendingCallbacks.set(i,n),this.worker.postMessage({type:e,payload:t,callbackId:i}),setTimeout((()=>{this.pendingCallbacks.has(i)&&(this.pendingCallbacks.delete(i),n(null))}),1e4)}))}}const $={"Hello World":"(claim zero Nat)\n(define zero zero)\n\n(claim add1zero Nat)\n(define add1zero (add1 zero))","Tactics: Simple Identity":';; A simple proof using tactics\n;; Goal: prove that for any Nat n, we can produce a Nat (identity function)\n\n(claim identity\n  (Π ((n Nat))\n    Nat))\n\n;; Complete this proof by dragging tactics:\n;; 1. Use "intro" to introduce the variable n\n;; 2. Use "exact n" to provide n as the result\n(define-tactically identity\n  ( (intro n)\n    ;; Add (exact n) here to complete the proof\n  ))',"Tactics: Simple Pair":';; Prove we can construct a pair of Nats\n;; Goal type: (Pair Nat Nat)\n\n(claim my-pair (Pair Nat Nat))\n\n;; Complete this proof:\n;; 1. Use "split" to split the pair goal into two subgoals\n;; 2. Use "exact 1" for the first Nat\n;; 3. Use "exact 2" for the second Nat\n(define-tactically my-pair\n  ( (split)\n    ;; Add (exact 1) and (exact 2) here to complete\n  ))',"Natural Number Addition":"(claim +\n  (→ Nat Nat Nat))\n\n(claim step-plus\n  (→ Nat Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1)))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus)))\n\n(claim result Nat)\n(define result (+ 2 3))","List Length":"(claim length\n  (Π ((E U))\n    (→ (List E) Nat)))\n\n(claim step-length\n  (Π ((E U))\n    (→ E (List E) Nat Nat)))\n\n(define step-length\n  (λ (E)\n    (λ (e es length-es)\n      (add1 length-es))))\n\n(define length\n  (λ (E)\n    (λ (es)\n      (rec-List es\n        0\n        (step-length E)))))\n\n(claim my-list (List Nat))\n(define my-list (:: 1 (:: 2 (:: 3 nil))))\n\n(claim list-len Nat)\n(define list-len (length Nat my-list))","Either Type":"(claim either-swap\n  (Pi ((A U) (B U))\n    (-> (Either A B)\n        (Either B A))))\n\n(define either-swap\n  (lambda (A B)\n    (lambda (e)\n      (ind-Either e\n        (lambda (x) (Either B A))\n        (lambda (a) (right a))\n        (lambda (b) (left b))))))\n\n(claim test-either (Either Nat Nat))\n(define test-either (left zero))\n\n(claim swapped (Either Nat Nat))\n(define swapped (either-swap Nat Nat test-either))","Vector Map":"(claim vec-map\n  (Π ((A U) (B U) (n Nat))\n     (-> (-> A B) (Vec A n)\n         (Vec B n))))\n\n(define vec-map\n  (λ (A B n)\n    (λ (f vs)\n      (ind-Vec n vs\n        (λ (k xs) (Vec B k))\n        vecnil\n        (λ (k x xs ih) (vec:: (f x) ih))))))\n\n(claim nat-vec (Vec Nat 3))\n(define nat-vec (vec:: 1 (vec:: 2 (vec:: 3 vecnil))))\n\n(claim add1-fn (-> Nat Nat))\n(define add1-fn (λ (n) (add1 n)))\n\n(claim incremented-vec (Vec Nat 3))\n(define incremented-vec (vec-map Nat Nat 3 add1-fn nat-vec))","Tactics: Even or Odd":'\n(claim +\n  (→ Nat Nat\n    Nat))\n\n(claim step-plus\n  (→ Nat\n    Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1 ) ))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus )))\n\n(claim double\n  (→ Nat\n    Nat))\n\n(define double\n  (λ (n)\n    (iter-Nat n\n      0\n      (+ 2))))\n\n(claim Even\n  (→ Nat\n    U ))\n\n(define Even\n  (λ (n)\n    (Σ ((half Nat))\n      (= Nat n (double half )))))\n\n(claim Odd\n  (→ Nat\n    U ))\n\n(define Odd\n  (λ (n)\n    (Σ ((haf Nat))\n      (= Nat n (add1 (double haf )))))) \n\n(claim zero-is-even\n  (Even 0))\n\n(define zero-is-even\n  (cons 0\n    (same 0)))\n\n(claim add1-even->odd\n  (Π ((n Nat))\n    (→ (Even n)\n    (Odd (add1 n)))))\n\n(define add1-even->odd\n  (λ (n en)\n    (cons (car en)\n    (cong (cdr en) (+ 1)))))\n\n(claim add1-odd->even\n  (Π ((n Nat))\n    (→ (Odd n)\n      (Even (add1 n)))))\n\n(define add1-odd->even\n  (λ (n on)\n    (cons (add1 (car on))\n      (cong (cdr on) (+ 1)))))\n\n(claim even-or-odd\n  (Π ((n Nat))\n    (Either (Even n) (Odd n))))\n\n;; This is the proof in The Little Typer\n;; (claim mot-even-or-odd\n;;   (→ Nat U )) \n\n;; (define mot-even-or-odd\n;;   (λ (k) (Either (Even k) (Odd k))))\n\n;; (claim step-even-or-odd\n;;   (Π ((n-1 Nat))\n;;      (→ (mot-even-or-odd n-1)\n;;      (mot-even-or-odd (add1 n-1)))))\n\n;; (define step-even-or-odd\n;;   (λ (n-1)\n;;     (λ (e-or-on-1)\n;;        (ind-Either e-or-on-1\n;;     (λ (e-or-on-1)\n;;        (mot-even-or-odd (add1 n-1)))\n;;        (λ (en-1)\n;;          (right\n;;            (add1-even->odd\n;;              n-1 en-1)))\n;;        (λ (on-1)\n;;          (left\n;;            (add1-odd->even\n;;              n-1 on-1)))))))\n\n;; (define even-or-odd\n;;   (λ (n)\n;;     (ind-Nat n\n;;        mot-even-or-odd\n;;        (left zero-is-even)\n;;        step-even-or-odd)))\n\n\n;; This is the proof using our new tactic system\n(define-tactically even-or-odd\n  ( (intro n)\n    (elimNat n)\n    (left)\n    (exact zero-is-even)\n    (intro n-1)\n    (intro e-or-on-1)\n    (elimEither e-or-on-1)\n    (intro xr)\n    (right)\n    (exact ((add1-even->odd n-1) xr))\n    (intro x1)\n    (left)\n    ;; finish the proof with "(exact ((add1-odd->even n-1) x1))"\n   ))',"Inductive Type: Less Than":";; Define Less Than relation using our new inductive type definiton\n    (data Less-Than () ((j Nat) (k Nat))\n      (zero-smallest ((n Nat)) (Less-Than () (zero (add1 n))))\n      (add1-smaller ((j Nat) (k Nat) (j<k (Less-Than () (j k)))) (Less-Than () ((add1 j) (add1 k))))\n      ind-Less-Than)\n\n    (claim proof-0<1 (Less-Than () (zero (add1 zero))))\n    (define proof-0<1 (zero-smallest zero))\n\n    (claim proof-1<2 (Less-Than () ((add1 zero) (add1 (add1 zero)))))\n    (define proof-1<2 (add1-smaller zero (add1 zero) proof-0<1))\n\n    (claim extract-smaller\n      (Pi ((j Nat) (k Nat))\n        (-> (Less-Than () (j k)) Nat)))\n    (define extract-smaller\n      (lambda (j k proof)\n        (ind-Less-Than proof\n          (lambda (j-idx k-idx p) Nat)\n          (lambda (n) zero)\n          (lambda (j-arg k-arg j<k-arg ih) (add1 ih)))))\n\n    (claim result Nat)\n    (define result (extract-smaller zero (add1 zero) proof-0<1))\n    ","Inductive Type: Subtype":"\n(data Subtype () ((T1 U) (T2 U))\n  (refl ((T U))\n    (Subtype () (T T)))\n  (trans ((T1 U) (T2 U) (T3 U)\n          (p1 (Subtype () (T1 T2)))\n          (p2 (Subtype () (T2 T3))))\n    (Subtype () (T1 T3)))\n  ;; Generic injection: if there exists a function A -> B, then A <: B\n  (inject ((A U) (B U) (f (-> A B)))\n    (Subtype () (A B)))\n  ind-Subtype)\n\n(claim coerce\n  (Pi ((A U) (B U))\n    (-> (Subtype () (A B)) A B)))\n(define coerce\n  (lambda (A B proof val)\n    ((ind-Subtype proof\n      (lambda (t1 t2 sub) (-> t1 t2))\n      (lambda (TT x) x)\n      (lambda (T11 T22 T33 p1 p2 ih1 ih2 x)\n        (ih2 (ih1 x)))\n      (lambda (AA BB ff x) (ff x))\n      )\n      val)))\n\n(data Even () ((n Nat))\n  (zero-even ()\n    (Even () (zero)))\n  (add2-even ((k Nat) (k-even (Even () (k))))\n    (Even () ((add1 (add1 k)))))\n  ind-Even)\n\n(claim even-to-nat\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define even-to-nat\n  (lambda (n proof)\n    (ind-Even proof\n      (lambda (m ev) Nat)\n      zero\n      (lambda (k prev ih) (add1 (add1 ih))))))\n\n(claim even-subtype-nat\n  (Pi ((n Nat))\n    (Subtype () ((Even () (n)) Nat))))\n(define even-subtype-nat\n  (lambda (n)\n    (inject (Even () (n)) Nat (even-to-nat n))))\n\n(claim + (-> Nat Nat Nat))\n(define +\n  (lambda (a b)\n    (rec-Nat a\n      b\n      (lambda (pred ih) (add1 ih)))))\n\n(claim double (-> Nat Nat))\n(define double\n  (lambda (n)\n    (+ n n)))\n\n;; Use Even with double\n(claim double-even\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define double-even\n  (lambda (n ev)\n    (double (coerce (Even () (n)) Nat\n                    (even-subtype-nat n)\n                    ev))))\n\n\n(claim even-four (Even () ((add1 (add1 (add1 (add1 zero)))))))\n(define even-four\n  (add2-even (add1 (add1 zero))\n    (add2-even zero\n      (zero-even))))\n\n(claim result2 Nat)\n(define result2 (double-even (add1 (add1 (add1 (add1 zero)))) even-four))\n        "},P=$["Hello World"],V=document.getElementById("preview-summary"),F=document.getElementById("preview-output");let M,D=null,G=null,z=null,O=null,R=null,q=null,H=null,U=null,Z="text";function W(e,t="neutral"){V&&(V.textContent=e,V.dataset.tone=t)}function Y(e,t){t?F.dataset.tone=t:delete F.dataset.tone,F.textContent=void 0===e?"Program is empty.":e}function j(e,t,n){const{diagnostics:i,pretty:s,proofTree:o}=n,a=t.getModel();if(M=o,!a)return;const r=i.map((t=>({startLineNumber:t.startLineNumber,startColumn:t.startColumn,endLineNumber:t.endLineNumber,endColumn:t.endColumn,message:t.message,severity:"warning"===t.severity?e.MarkerSeverity.Warning:e.MarkerSeverity.Error})));if(e.editor.setModelMarkers(a,"pie-playground",r),"interactive"!==Z&&function(e){const t=document.getElementById("proof-tree-container");if(t){if(!e)return t.style.display="none",O&&O.clear(),R&&R.clear(),void(q&&q.clear());t.style.display="flex",O&&O.render(e),R&&R.clear(),q&&q.clear()}}(o),"interactive"===Z&&U&&o&&U.setProofTree(o),0===i.length)return void("interactive"!==Z&&(W("SUCCESS","success"),Y(s?.trim()??void 0,"success")));const l=i[0],c="warning"===l.severity?"warning":"error";if("interactive"!==Z){W("warning"===c?"WARNING":"ERROR",c);Y(`${`Line ${l.startLineNumber}, Col ${l.startColumn}`}\n${l.message}`,c)}}function K(e){const t=document.getElementById("mode-text"),n=document.getElementById("mode-blocks"),i=document.getElementById("mode-interactive"),s=document.getElementById("editor"),o=document.getElementById("blockly-container"),a=document.getElementById("interactive-container"),r=document.getElementById("example-picker");function l(e){t.classList.toggle("mode-btn--active","text"===e),n.classList.toggle("mode-btn--active","blocks"===e),i&&i.classList.toggle("mode-btn--active","interactive"===e)}t&&n&&s&&o?(t.addEventListener("click",(function(){if("text"!==Z&&(Z="text",l("text"),s.style.display="",o.style.display="none",a&&(a.style.display="none"),r&&(r.style.display=""),D)){const t=e.getValue();0===t.trim().length?(W("Waiting for input…","neutral"),Y(void 0)):(W("Running checks…","warning"),D.postMessage({type:"analyze",payload:{source:t}}))}})),n.addEventListener("click",(function(){if("blocks"!==Z&&(Z="blocks",l("blocks"),s.style.display="none",o.style.display="",a&&(a.style.display="none"),r&&(r.style.display="none"),H||(H=function(){const e=document.getElementById("blockly-workspace"),t=document.getElementById("blockly-code-preview");if(!e||!t)return console.error("Blockly container elements not found"),null;const n=new b({container:e,codePreview:t,onCodeChange:e=>{"blocks"===Z&&D&&(0===e.trim().length?(W("Waiting for blocks…","neutral"),Y("; (empty workspace)")):(W("Running checks…","warning"),D.postMessage({type:"analyze",payload:{source:e}})))}});return n.loadStarterExample(),n}()),H)){H.resize();const e=H.getCode();D&&(0===e.trim().length?(W("Waiting for blocks…","neutral"),Y("; (empty workspace)")):(W("Running checks…","warning"),D.postMessage({type:"analyze",payload:{source:e}})))}})),i&&i.addEventListener("click",(function(){"interactive"!==Z&&(Z="interactive",l("interactive"),s.style.display="none",o.style.display="none",a&&(a.style.display=""),r&&(r.style.display="none"),!U&&a&&function(e){const t=document.getElementById("interactive-tree"),n=document.getElementById("interactive-palette"),i=document.getElementById("interactive-details");t&&n&&i?(U=new L({treeContainer:t,paletteContainer:n,detailsContainer:i,onStateChange:e=>{e.isComplete?W("PROOF COMPLETE","success"):e.selectedGoalId&&W(`Goal: ${e.selectedGoalId}`,"neutral")},onProofComplete:e=>{Y(e,"success")},onError:e=>{W("ERROR","error"),Y(e,"error")},onModifySource:t=>{e.setValue(t)}}),D&&U.initialize(D),U.updateSourceContext(e.getValue()),e.onDidChangeModelContent((()=>{U&&U.updateSourceContext(e.getValue())}))):console.error("Interactive proof containers not found")}(e),U&&M&&U.setProofTree(M),W("Interactive Proof Mode","neutral"),Y("Select a claim to prove interactively.\n\nDrag tactics from the palette onto goal nodes to build your proof."))}))):console.error("Mode toggle elements not found")}function X(e,t){let n;return function(...i){window.clearTimeout(n),n=window.setTimeout((()=>e.apply(this,i)),t)}}!async function(){window.require?(window.require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs"}}),window.require(["vs/editor/editor.main"],(async()=>{z=window.monaco;const t=function(e){!function(e){e.languages.register({id:"pie"}),e.languages.setLanguageConfiguration("pie",{comments:{lineComment:";",blockComment:["#|","|#"]},brackets:[["(",")"],["[","]"],["{","}"]],autoClosingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}],surroundingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}]}),e.languages.setMonarchTokensProvider("pie",{defaultToken:"",tokenPostfix:".pie",keywords:["lambda","λ","Pi","Π","Sigma","Σ","define","claim","the","check-same","define-tactically","TODO","U","Universe","Nat","Atom","List","Vec","Either","zero","add1","nil","cons","car","cdr","ind-Nat","rec-Nat","iter-Nat","ind-List","rec-List","ind-Vec","rec-Vec","ind-Either","replace","trans","cong","symm","same","left","right","ind-Either","vecnil","vec::"],operators:["->","→","=","::"],symbols:/[=><!~?:&|+\-*/^%]+/,tokenizer:{root:[{include:"@whitespace"},[/\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\b/,"keyword"],[/[a-zA-Z][a-zA-Z0-9\-_!?*+=<>λΠΣ→]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d+/,"number"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string"],[/'[a-zA-Z][a-zA-Z0-9\-_!?*+=<>]*/,"string.quoted"],[/[()[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}]],whitespace:[[/[ \t\r\n]+/,"white"],[/;.*$/,"comment"],[/#\|/,"comment","@comment"]],comment:[[/[^#|]+/,"comment"],[/\|#/,"comment","@pop"],[/[#|]/,"comment"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]]}})}(e);const t=e.editor.create(document.getElementById("editor"),{value:P,language:"pie",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},scrollbar:{vertical:"auto",horizontal:"auto",useShadows:!1,verticalScrollbarSize:6,verticalSliderSize:4},padding:{top:16},fontSize:14,fontFamily:"Menlo, 'Fira Code', 'JetBrains Mono', monospace",smoothScrolling:!0});Y(P.trim()),W("Ready for analysis.","neutral");const n=X((e=>{0===e.trim().length?(W("Waiting for input…","neutral"),Y(void 0)):(W("Running checks…","warning"),Y("Analyzing…"))}),120),i=X((e=>{W("Running checks…","warning"),D&&D.postMessage({type:"analyze",payload:{source:e}})}),220);return t.onDidChangeModelContent((()=>{const e=t.getValue();n(e),i(e)})),t}(z);D=function(e){if(!("Worker"in window))return W("Diagnostics unavailable in this browser.","warning"),null;const t=new Worker("diagnostics-worker.js",{type:"module"});return t.onmessage=t=>{const{type:n,payload:i}=t.data;"diagnostics"===n&&z&&j(z,e,i)},t.onerror=e=>{console.error("Worker error event:",e),console.error("Error details:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno}),W("Diagnostics worker crashed.","error"),Y(`Worker failed to load. Check browser console for details.\nError: ${e.message||"Unknown error"}`,"error")},t}(t),function(e){const t=document.getElementById("example-picker");t&&(Object.keys($).forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)})),t.value="Hello World",t.addEventListener("change",(t=>{const n=t.target.value;n&&$[n]&&e.setValue($[n])})))}(t),function(e){const t=document.getElementById("copy-btn");t&&t.addEventListener("click",(async()=>{const n=e.getValue();try{await navigator.clipboard.writeText(n),t.textContent="Copied!",t.dataset.copied="true",setTimeout((()=>{t.textContent="Copy",delete t.dataset.copied}),1500)}catch(e){console.error("Failed to copy:",e),t.textContent="Failed",setTimeout((()=>{t.textContent="Copy"}),1500)}}))}(t),function(){const e=document.getElementById("proof-tree-canvas"),t=document.getElementById("proof-context-panel"),s=document.getElementById("proof-goal-panel"),o=document.getElementById("proof-tree-toggle"),a=document.getElementById("proof-tree-container");e&&t&&s?(O=new n(e),R=new i(t),q=new r(s),O.setOnGoalSelect((e=>{R&&R.display(e),q&&q.display(e),O&&O.highlightGoal(e.id)})),o&&a&&o.addEventListener("click",(()=>{const e=a.querySelector(".proof-tree-content");e&&("none"===e.style.display?(e.style.display="flex",o.textContent="Hide"):(e.style.display="none",o.textContent="Show"))}))):console.warn("Proof tree containers not found")}(),K(t),z&&await async function(t,n){try{G&&G.isRunning()&&await G.stop(),G=new e(t,n),await G.start(),console.log("LSP client initialized successfully")}catch(e){console.error("Failed to initialize LSP client:",e),W("LSP features unavailable","warning")}}(z,t),D&&D.postMessage({type:"analyze",payload:{source:t.getValue()}}),window.__pieEditor=t}))):console.error("Monaco loader not available")}();
//# sourceMappingURL=app.bundle.js.map
