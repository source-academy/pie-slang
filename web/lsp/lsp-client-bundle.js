class e{constructor(e,t){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.monaco=e,this.editor=t}async start(){this.worker=new Worker(new URL("./pie-lsp-worker-bundle.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("LSP Worker error:",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce(()=>{if(!this.worker)return;const t=e.getValue();this.worker.postMessage({type:"validate",source:t})},220);const t=this.editor?.onDidChangeModelContent?.(()=>{this.debouncedValidate&&this.debouncedValidate()});t&&this.disposables.push(t);const s=this.monaco.languages.registerHoverProvider("pie",{provideHover:(e,t)=>this.provideHover(t)});this.disposables.push(s),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}),this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&("validation-result"===e.type?this.updateDiagnostics(e.diagnostics??[]):"validation-error"===e.type&&this.updateDiagnostics([{severity:"error",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]))}updateDiagnostics(e){this.diagnostics=e;const t=this.editor?.getModel?.();if(!t)return;const s=e.map(e=>{const t=this.ensurePositiveNumber(e.startLine,1),s=this.ensurePositiveNumber(e.endLine,t),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:t,startColumn:i,endLineNumber:s,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:"warning"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}});this.monaco.editor.setModelMarkers(t,"pie-lsp",s)}provideHover(e){const t=this.diagnostics.find(t=>{const s=this.ensurePositiveNumber(t.startLine,e.lineNumber),i=this.ensurePositiveNumber(t.endLine,s),r=this.ensurePositiveNumber(t.startColumn,1),n=this.ensurePositiveNumber(t.endColumn,r+1);return!(e.lineNumber<s||e.lineNumber>i)&&(!(e.lineNumber===s&&e.column<r)&&!(e.lineNumber===i&&e.column>n))});if(!t)return null;const s=this.ensurePositiveNumber(t.startLine,e.lineNumber),i=this.ensurePositiveNumber(t.endLine,s),r=this.ensurePositiveNumber(t.startColumn,1),n=this.ensurePositiveNumber(t.endColumn,r+1);return{contents:[{value:`**${"warning"===t.severity?"Warning":"Error"}**\\n\\n${t.message}`}],range:{startLineNumber:s,startColumn:r,endLineNumber:i,endColumn:n}}}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,"pie-lsp",[])}ensurePositiveNumber(e,t){return"number"!=typeof e||Number.isNaN(e)||e<1?t:e}debounce(e,t){let s=null;return()=>{null!==s&&window.clearTimeout(s),s=window.setTimeout(()=>{s=null,e()},t)}}}function t(e){e.languages.register({id:"pie"}),e.languages.setLanguageConfiguration("pie",{comments:{lineComment:";",blockComment:["#|","|#"]},brackets:[["(",")"],["[","]"],["{","}"]],autoClosingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}],surroundingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}]}),e.languages.setMonarchTokensProvider("pie",{defaultToken:"",tokenPostfix:".pie",keywords:["lambda","λ","Pi","Π","Sigma","Σ","define","claim","the","check-same","define-tactically","TODO","U","Universe","Nat","Atom","List","Vec","Either","zero","add1","nil","cons","car","cdr","ind-Nat","rec-Nat","iter-Nat","ind-List","rec-List","ind-Vec","rec-Vec","ind-Either","replace","trans","cong","symm","same","left","right","ind-Either","vecnil","vec::"],operators:["->","→","=","::"],symbols:/[=><!~?:&|+\-*\/^%]+/,tokenizer:{root:[{include:"@whitespace"},[/\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\b/,"keyword"],[/[a-zA-Z][a-zA-Z0-9\-_!?*+=<>λΠΣ→]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d+/,"number"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string"],[/'[a-zA-Z][a-zA-Z0-9\-_!?*+=<>]*/,"string.quoted"],[/[()[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}]],whitespace:[[/[ \t\r\n]+/,"white"],[/;.*$/,"comment"],[/#\|/,"comment","@comment"]],comment:[[/[^#|]+/,"comment"],[/\|#/,"comment","@pop"],[/[#|]/,"comment"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]]}})}export{e as PieLanguageClient,t as registerPieLanguage};
//# sourceMappingURL=lsp-client-bundle.js.map
