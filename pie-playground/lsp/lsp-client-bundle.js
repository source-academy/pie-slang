class e{constructor(e,t){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.monaco=e,this.editor=t}async start(){this.worker=new Worker(new URL("./pie-lsp-worker-bundle.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("LSP Worker error:",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce(()=>{if(!this.worker)return;const t=e.getValue();this.worker.postMessage({type:"validate",source:t})},220);const t=this.editor?.onDidChangeModelContent?.(()=>{this.debouncedValidate&&this.debouncedValidate()});t&&this.disposables.push(t);const n=this.monaco.languages.registerHoverProvider("pie",{provideHover:(e,t)=>this.provideHover(e,t)});this.disposables.push(n);const i=this.monaco.languages.registerCompletionItemProvider("pie",{provideCompletionItems:(e,t)=>this.provideCompletionItems(e,t)});this.disposables.push(i);const s=this.monaco.languages.registerDefinitionProvider("pie",{provideDefinition:(e,t)=>this.provideDefinition(e,t)});this.disposables.push(s),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}),this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&("validation-result"===e.type?this.updateDiagnostics(e.diagnostics??[]):"validation-error"===e.type&&this.updateDiagnostics([{severity:"error",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]))}updateDiagnostics(e){this.diagnostics=e;const t=this.editor?.getModel?.();if(!t)return;const n=e.map(e=>{const t=this.ensurePositiveNumber(e.startLine,1),n=this.ensurePositiveNumber(e.endLine,t),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:t,startColumn:i,endLineNumber:n,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:"warning"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}});this.monaco.editor.setModelMarkers(t,"pie-lsp",n)}async provideHover(e,t){if(!this.worker)return null;const n=this.diagnostics.find(e=>{const n=this.ensurePositiveNumber(e.startLine,t.lineNumber),i=this.ensurePositiveNumber(e.endLine,n),s=this.ensurePositiveNumber(e.startColumn,1),r=this.ensurePositiveNumber(e.endColumn,s+1);return!(t.lineNumber<n||t.lineNumber>i)&&(!(t.lineNumber===n&&t.column<s)&&!(t.lineNumber===i&&t.column>r))});if(n){const e=this.ensurePositiveNumber(n.startLine,t.lineNumber),i=this.ensurePositiveNumber(n.endLine,e),s=this.ensurePositiveNumber(n.startColumn,1),r=this.ensurePositiveNumber(n.endColumn,s+1);return{contents:[{value:`**${"warning"===n.severity?"Warning":"Error"}**\n\n${n.message}`}],range:{startLineNumber:e,startColumn:s,endLineNumber:i,endColumn:r}}}return new Promise(n=>{const i=e=>{const t=e.data;if("hover-result"===t.type){if(this.worker?.removeEventListener("message",i),!t.hoverInfo)return void n(null);const e=t.hoverInfo;let s=`**${e.title}**\n\n${e.summary}`;e.details&&(s+=`\n\n${e.details}`),e.examples&&(s+=`\n\n**Examples:**\n\`\`\`pie\n${e.examples}\n\`\`\``),n({contents:[{value:s}]})}};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"hover",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),n(null)},1e3)})}async provideCompletionItems(e,t){return this.worker?new Promise(n=>{const i=e=>{const s=e.data;if("completion-result"===s.type){this.worker?.removeEventListener("message",i);const e=s.wordRange,r=e?{startLineNumber:t.lineNumber,startColumn:e.start+1,endLineNumber:t.lineNumber,endColumn:e.end+1}:{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber,endColumn:t.column},o=s.completions.map(e=>{let t=this.monaco.languages.CompletionItemKind.Text;switch(e.kind){case"Keyword":t=this.monaco.languages.CompletionItemKind.Keyword;break;case"Function":t=this.monaco.languages.CompletionItemKind.Function;break;case"Variable":t=this.monaco.languages.CompletionItemKind.Variable;break;case"TypeParameter":t=this.monaco.languages.CompletionItemKind.Class;break;case"Value":t=this.monaco.languages.CompletionItemKind.Value;break;case"Snippet":t=this.monaco.languages.CompletionItemKind.Snippet}return{label:e.label,kind:t,detail:e.detail,insertText:e.label,range:r}});n({suggestions:o})}};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"completion",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),n({suggestions:[]})},1e3)}):{suggestions:[]}}async provideDefinition(e,t){return this.worker?new Promise(n=>{const i=t=>{const s=t.data;"definition-result"===s.type&&(this.worker?.removeEventListener("message",i),s.location?n({uri:e.uri,range:{startLineNumber:s.location.line+1,startColumn:s.location.startColumn+1,endLineNumber:s.location.line+1,endColumn:s.location.endColumn+1}}):n(null))};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"definition",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),n(null)},1e3)}):null}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,"pie-lsp",[])}ensurePositiveNumber(e,t){return"number"!=typeof e||Number.isNaN(e)||e<1?t:e}debounce(e,t){let n=null;return()=>{null!==n&&window.clearTimeout(n),n=window.setTimeout(()=>{n=null,e()},t)}}}function t(e){e.languages.register({id:"pie"}),e.languages.setLanguageConfiguration("pie",{comments:{lineComment:";",blockComment:["#|","|#"]},brackets:[["(",")"]],autoClosingPairs:[{open:"(",close:")"}],surroundingPairs:[{open:"(",close:")"}],indentationRules:{increaseIndentPattern:/^\s*\(.*[^)]$/,decreaseIndentPattern:/^\s*\)/},onEnterRules:[{beforeText:/^\s*\(.*[^)]$/,action:{indentAction:e.languages.IndentAction.Indent}},{beforeText:/^\s*\(.*$/,afterText:/^\s*\)/,action:{indentAction:e.languages.IndentAction.IndentOutdent}},{beforeText:/^.*$/,afterText:/^\s*\)/,action:{indentAction:e.languages.IndentAction.Outdent}}]}),e.languages.setMonarchTokensProvider("pie",{defaultToken:"",tokenPostfix:".pie",keywords:["lambda","λ","Pi","Π","Sigma","Σ","define","claim","the","check-same","define-tactically","TODO","U","Nat","Atom","List","Vec","Either","zero","add1","nil","cons","car","cdr","ind-Nat","rec-Nat","iter-Nat","ind-List","rec-List","ind-Vec","rec-Vec","ind-=","replace","trans","cong","symm","same","left","right","ind-Either","vecnil","vec::","which-Nat","quote","Pair","Trivial","sole","::","Absurd","ind-Absurd","=","head","tail","Either","->","→"],operators:[],symbols:/[=><!~?:&|+\-*/^%]+/,tokenizer:{root:[{include:"@whitespace"},[/\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\b/,"keyword"],[/[a-zA-Z][a-zA-Z0-9\-_!?*+=<>λΠΣ→]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d+/,"number"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string"],[/'[a-zA-Z][a-zA-Z0-9\-_!?*+=<>]*/,"string.quoted"],[/[()[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}]],whitespace:[[/[ \t\r\n]+/,"white"],[/;.*$/,"comment"],[/#\|/,"comment","@comment"]],comment:[[/[^#|]+/,"comment"],[/\|#/,"comment","@pop"],[/[#|]/,"comment"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]]}})}export{e as PieLanguageClient,t as registerPieLanguage};
//# sourceMappingURL=lsp-client-bundle.js.map
