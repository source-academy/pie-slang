!function(t,e,n){"use strict";var r;!function(t){t[t.INTEGER=1]="INTEGER",t[t.RATIONAL=2]="RATIONAL",t[t.REAL=3]="REAL",t[t.COMPLEX=4]="COMPLEX"}(r||(r={}));class s{result;constructor(t){this.result=t}}class i extends s{result;value;constructor(t,e){super(t),this.result=t,this.value=e}isSigned(){return!!this.result&&("+"===this.value[0]||"-"===this.value[0])}build(){return l.build(this.value)}}class a extends s{result;numerator;denominator;constructor(t,e,n){super(t),this.result=t,this.numerator=e,this.denominator=n}build(){return p.build(this.numerator,this.denominator)}}class o extends s{result;integer;decimal;exponent;constructor(t,e,n,r){super(t),this.result=t,this.integer=e,this.decimal=n,this.exponent=r}build(){if(this.integer?.includes("inf"))return this.integer.includes("-")?w.NEG_INFINITY:w.INFINITY;if(this.integer?.includes("nan"))return w.NAN;let t=(this.exponent?this.exponent.build():w.INEXACT_ZERO).coerce(),e=Number((this.integer?this.integer:"0")+"."+(this.decimal?this.decimal:"0"));return e*=Math.pow(10,t),w.build(e)}}class c extends s{result;real;sign;imaginary;constructor(t,e,n,r){super(t),this.result=t,this.real=e,this.sign=n,this.imaginary=r}build(){const t=this.real?this.real.build():l.EXACT_ZERO,e=this.imaginary.build();return this.sign&&"-"===this.sign?f.build(t,e.negate()):f.build(t,e)}}function u(t){const e=new RegExp("^([+-]?)(\\d+)$").exec(t);return e?new i(!0,e[0]):new i(!1)}function h(t,e){const n=u(t);if(n.result&&e>=r.INTEGER)return n;const s=function(t){if(1!==(t.match(/\//g)||[]).length)return new a(!1);const e=t.split("/");if(2!==e.length)return new a(!1);const[n,r]=e,s=u(n),i=u(r);return s.result&&i.result?new a(!0,n,r):new a(!1)}(t);if(s.result&&e>=r.RATIONAL)return s;const l=function(t){function e(t){if(function(t){return"+inf.0"===t||"-inf.0"===t||"+nan.0"===t||"-nan.0"===t}(t))return new o(!0,t);const e=(t.match(/\./g)||[]).length;if(e>1)return new o(!1);if(0===e){const e=u(t);return new o(e.result,e.value)}const[n,r]=t.split("."),s=u(n),i=u(r),a=s.result||""===n,c=i.result||""===r;return"+"===n||"-"===n?""===r?new o(!1):new o(!0,`${n}0`,t):s.result&&c||a&&i.result?i.result&&i.isSigned()?new o(!1):new o(!0,s.value,i.value):new o(!1)}return 0===(t.match(/[eE]/g)||[]).length?e(t):function(t){const n=t.indexOf("e"),s=t.indexOf("E");if(-1===n&&-1===s)return new o(!1);const i=-1===n?s:n,a=t.substring(0,i),c=t.substring(i+1);if(""===a||""==c)return new o(!1);const u=e(a);if(!u.result)return new o(!1);const l=h(c,r.REAL);return l.result?new o(!0,u.integer,u.decimal,l):new o(!1)}(t)}(t);if(l.result&&e>=r.REAL)return l;const p=function(t){if((t.match(/i/g)||[]).length<1)return new c(!1);if("i"!==t[t.length-1])return new c(!1);const e=t.search(/(?<!^)[+-]/);if(-1===e){const e=h(t.slice(0,-1),r.REAL);return e.result?new c(!0,void 0,void 0,e):new c(!1)}const n=t.slice(0,e);let s=t.slice(e+1,-1);"+"!==s[0]&&"-"!==s[0]&&(s="+"+s);const i=h(n,r.REAL),a=h(s,r.REAL);return i.result&&a.result?new c(!0,i,t[e],a):new c(!1)}(t);return p.result&&e>=r.COMPLEX?p:new i(!1)}class l{numberType=r.INTEGER;value;static EXACT_ZERO=new l(0n);constructor(t){this.value=t}static build(t,e=!1){const n=BigInt(t);return 0n===n?l.EXACT_ZERO:new l(n)}promote(t){switch(t){case r.INTEGER:return this;case r.RATIONAL:return p.build(this.value,1n,!0);case r.REAL:return w.build(this.coerce(),!0);case r.COMPLEX:return f.build(this,l.EXACT_ZERO,!0)}}equals(t){return t instanceof l&&this.value===t.value}greaterThan(t){return this.value>t.value}negate(){return this===l.EXACT_ZERO?this:l.build(-this.value)}multiplicativeInverse(){if(this===l.EXACT_ZERO)throw new Error("Division by zero");return p.build(1n,this.value,!1)}add(t){return l.build(this.value+t.value)}multiply(t){return l.build(this.value*t.value)}getBigInt(){return this.value}coerce(){return this.value>Number.MAX_SAFE_INTEGER?1/0:this.value<Number.MIN_SAFE_INTEGER?-1/0:Number(this.value)}toString(){return this.value.toString()}}class p{numberType=r.RATIONAL;numerator;denominator;constructor(t,e){this.numerator=t,this.denominator=e}static build(t,e,n=!1){return p.simplify(BigInt(t),BigInt(e),n)}static simplify(t,e,n=!1){const r=(t,e)=>0n===e?t:r(e,t.valueOf()%e.valueOf()),s=r(t,e),i=t<0n?-1n:1n,a=e<0n?-1n:1n,o=i*a;return t*=i,1n!==(e*=a)||n?new p(o*t/s,e/s):l.build(o*t)}getNumerator(){return this.numerator}getDenominator(){return this.denominator}promote(t){switch(t){case r.RATIONAL:return this;case r.REAL:return w.build(this.coerce(),!0);case r.COMPLEX:return f.build(this,l.EXACT_ZERO,!0);default:throw new Error("Unable to demote rational")}}equals(t){return t instanceof p&&this.numerator===t.numerator&&this.denominator===t.denominator}greaterThan(t){return this.numerator*t.denominator>t.numerator*this.denominator}negate(){return p.build(-this.numerator,this.denominator)}multiplicativeInverse(){if(0n===this.numerator)throw new Error("Division by zero");return p.build(this.denominator,this.numerator)}add(t){const e=this.numerator*t.denominator+t.numerator*this.denominator,n=this.denominator*t.denominator;return p.build(e,n)}multiply(t){const e=this.numerator*t.numerator,n=this.denominator*t.denominator;return p.build(e,n)}coerce(){const t=this.numerator<0n?-this.numerator:this.numerator;let e=this.denominator;const n=Number(t/e);if(n>Number.MAX_VALUE)return this.numerator<0n?-1/0:1/0;let r=t%e;for(;r>Number.MAX_SAFE_INTEGER||e>Number.MAX_SAFE_INTEGER;)r/=2n,e/=2n;const s=Number(r)/Number(e);return this.numerator<0n?-(n+s):n+s}toString(){return`${this.numerator}/${this.denominator}`}}class w{numberType=r.REAL;value;static INEXACT_ZERO=new w(0);static INEXACT_NEG_ZERO=new w(-0);static INFINITY=new w(1/0);static NEG_INFINITY=new w(-1/0);static NAN=new w(NaN);static build(t,e=!1){return t===1/0?w.INFINITY:t===-1/0?w.NEG_INFINITY:isNaN(t)?w.NAN:0===t?w.INEXACT_ZERO:-0===t?w.INEXACT_NEG_ZERO:new w(t)}constructor(t){this.value=t}promote(t){switch(t){case r.REAL:return this;case r.COMPLEX:return f.build(this,l.EXACT_ZERO,!0);default:throw new Error("Unable to demote real")}}equals(t){return t instanceof w&&this.value===t.value}greaterThan(t){return this.value>t.value}negate(){return w.build(-this.value)}multiplicativeInverse(){if(this===w.INEXACT_ZERO||this===w.INEXACT_NEG_ZERO)throw new Error("Division by zero");return w.build(1/this.value)}add(t){return w.build(this.value+t.value)}multiply(t){return w.build(this.value*t.value)}coerce(){return this.value}toString(){return this===w.INFINITY?"+inf.0":this===w.NEG_INFINITY?"-inf.0":this===w.NAN?"+nan.0":this.value.toString()}}class f{numberType=r.COMPLEX;real;imaginary;static build(t,e,n=!1){return f.simplify(new f(t,e),n)}constructor(t,e){this.real=t,this.imaginary=e}static simplify(t,e){return!e&&g(t.imaginary,l.EXACT_ZERO)?t.real:t}promote(t){if(t===r.COMPLEX)return this;throw new Error("Unable to demote complex")}negate(){return f.build(this.real.negate(),this.imaginary.negate())}equals(t){return g(this.real,t.real)&&g(this.imaginary,t.imaginary)}greaterThan(t){return v(this.real,t.real)&&v(this.imaginary,t.imaginary)}multiplicativeInverse(){const t=E(T(this.real,this.real),T(this.imaginary,this.imaginary));return f.build(T(t.multiplicativeInverse(),this.real),T(t.multiplicativeInverse(),this.imaginary.negate()))}add(t){return f.build(E(this.real,t.real),E(this.imaginary,t.imaginary))}multiply(t){const e=(n=T(this.real,t.real),r=T(this.imaginary,t.imaginary),E(n,function(t){return t.negate()}(r)));var n,r;const s=E(T(this.real,t.imaginary),T(this.imaginary,t.real));return f.build(e,s)}getReal(){return this.real}getImaginary(){return this.imaginary}coerce(){throw new Error("Cannot coerce a complex number to a javascript number")}toPolar(){const t=this.real.promote(r.REAL),e=this.imaginary.promote(r.REAL),n=w.build(Math.sqrt(t.coerce()*t.coerce()+e.coerce()*e.coerce())),s=w.build(Math.atan2(e.coerce(),t.coerce()));return y.build(n,s)}toString(){return`${this.real}+${this.imaginary}i`}}class y{magnitude;angle;constructor(t,e){this.magnitude=t,this.angle=e}static build(t,e){return new y(t,e)}toCartesian(){const t=w.build(this.magnitude.coerce()*Math.cos(this.angle.coerce())),e=w.build(this.magnitude.coerce()*Math.sin(this.angle.coerce()));return f.build(t,e)}}function d(t){switch(t.numberType){case r.INTEGER:return t;case r.RATIONAL:return 1n===t.getDenominator()?l.build(t.getNumerator()):t;case r.REAL:return t;case r.COMPLEX:return f.build(d(t.getReal()),d(t.getImaginary()))}}function m(t,e){return t.numberType>e.numberType?[t,e.promote(t.numberType)]:t.numberType<e.numberType?[t.promote(e.numberType),e]:[t,e]}function g(t,e){const[n,r]=m(t,e);return n.equals(r)}function v(t,e){const[n,r]=m(t,e);return n.greaterThan(r)}function E(t,e){const[n,r]=m(t,e);return d(n.add(r))}function T(t,e){const[n,r]=m(t,e);return d(n.multiply(r))}let N=class t{start;end;constructor(t,e){this.start=t,this.end=e}merge(e){return new t(this.start,e.end)}};class P{line;column;constructor(t,e){this.line=t,this.column=e}}var x;function b(t,e){return t.split("\n")[e.line-1]}function k(t){return"^".padStart(t.column," ")}!function(t){t[t.LEFT_PAREN=0]="LEFT_PAREN",t[t.RIGHT_PAREN=1]="RIGHT_PAREN",t[t.LEFT_BRACKET=2]="LEFT_BRACKET",t[t.RIGHT_BRACKET=3]="RIGHT_BRACKET",t[t.DOT=4]="DOT",t[t.HASH_SEMICOLON=5]="HASH_SEMICOLON",t[t.IDENTIFIER=6]="IDENTIFIER",t[t.NUMBER=7]="NUMBER",t[t.BOOLEAN=8]="BOOLEAN",t[t.STRING=9]="STRING",t[t.IF=10]="IF",t[t.LET=11]="LET",t[t.COND=12]="COND",t[t.ELSE=13]="ELSE",t[t.DEFINE=14]="DEFINE",t[t.LAMBDA=15]="LAMBDA",t[t.APOSTROPHE=16]="APOSTROPHE",t[t.BACKTICK=17]="BACKTICK",t[t.COMMA=18]="COMMA",t[t.COMMA_AT=19]="COMMA_AT",t[t.QUOTE=20]="QUOTE",t[t.QUASIQUOTE=21]="QUASIQUOTE",t[t.UNQUOTE=22]="UNQUOTE",t[t.UNQUOTE_SPLICING=23]="UNQUOTE_SPLICING",t[t.SET=24]="SET",t[t.BEGIN=25]="BEGIN",t[t.DELAY=26]="DELAY",t[t.IMPORT=27]="IMPORT",t[t.EXPORT=28]="EXPORT",t[t.DEFINE_SYNTAX=29]="DEFINE_SYNTAX",t[t.SYNTAX_RULES=30]="SYNTAX_RULES",t[t.HASH_VECTOR=31]="HASH_VECTOR",t[t.VECTOR=32]="VECTOR",t[t.EOF=33]="EOF"}(x||(x={}));class $ extends SyntaxError{loc;constructor(t,e){super(`Syntax error at (${e.line}:${e.column})\n${t}`),this.loc=e}toString(){return this.message}}let S=class extends ${constructor(t,e){super(b(t,e)+"\nUnexpected EOF",e),this.name="UnexpectedEOFError"}};class L extends ${form;constructor(t,e,n){super(b(t,e)+"\n"+k(e)+"\n"+`Unexpected '${n}'`,e),this.form=n,this.name="UnexpectedTokenError"}}class O extends ${form;expected;constructor(t,e,n,r){super(b(t,e)+"\n"+k(e)+"\n"+`Expected '${r}' but got '${n}'`,e),this.form=n,this.expected=r,this.name="ExpectedTokenError"}}class A extends ${token;constructor(t,e,n,r){super(b(t,e)+"\n"+k(e)+"\n"+`Syntax '${n}' not allowed at Scheme §${r}`,e),this.token=n,this.name="DisallowedTokenError"}}class I extends ${token;constructor(t,e,n){super(b(t,e)+"\n"+k(e)+"\n"+`Syntax '${n}' not supported yet`,e),this.token=n,this.name="UnsupportedTokenError"}}class B{elements;location;constructor(t){this.elements=t,this.location=new N(this.firstPos(),this.lastPos())}static build(t){if(0===t.length)throw new Error("Illegal empty group. This should never happen.");if(1===t.length){const n=t[0];if(R(n))return n;if((e=n).type!==x.IDENTIFIER&&e.type!==x.NUMBER&&e.type!==x.STRING&&e.type!==x.BOOLEAN)throw new O("",n.pos,n,"<data>");return new B(t)}var e;if(2===t.length){const e=t[0];if(C(e)&&function(t){return t.type===x.APOSTROPHE||t.type===x.BACKTICK||t.type===x.HASH_VECTOR||t.type===x.COMMA||t.type===x.COMMA_AT}(e))return new B(t)}const n=t[0],r=t[t.length-1];if(C(n)&&C(r)&&(i=r,(s=n).type===x.LEFT_PAREN&&i.type===x.RIGHT_PAREN||s.type===x.LEFT_BRACKET&&i.type===x.RIGHT_BRACKET))return new B(t);var s,i;const a=new B(t);throw new O("",a.location.start,a,"matching parentheses")}first(){return this.elements[0]}firstToken(){const t=this.first();return C(t)?t:t.firstToken()}firstPos(){return this.firstToken().pos}last(){return this.elements[this.elements.length-1]}lastToken(){const t=this.last();return C(t)?t:t.lastToken()}lastPos(){return this.lastToken().pos}isParenthesized(){const t=this.first();return C(t)&&(t.type===x.LEFT_PAREN||t.type===x.LEFT_BRACKET)}isSingleIdentifier(){return!this.isParenthesized()&&1===this.length()}unwrap(){return this.isParenthesized()?this.elements.slice(1,this.elements.length-1):this.elements}length(){return this.unwrap().length}toString(){return this.elements.map((t=>t.toString())).join(" ")}}function C(t){return t instanceof q}function R(t){return t instanceof B}class q{type;lexeme;literal;start;end;pos;endPos;constructor(t,e,n,r,s,i,a){this.type=t,this.lexeme=e,this.literal=n,this.start=r,this.end=s,this.pos=new P(i,a),this.endPos=new P(i,a+e.length-1)}convertToken(){switch(this.type){case x.APOSTROPHE:return new q(x.QUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case x.BACKTICK:return new q(x.QUASIQUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case x.HASH_VECTOR:return new q(x.VECTOR,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case x.COMMA:return new q(x.UNQUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case x.COMMA_AT:return new q(x.UNQUOTE_SPLICING,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);default:return this}}toString(){return`${this.lexeme}`}}class M extends SyntaxError{loc;constructor(t,e,n){super(t),this.loc={line:e,column:n}}toString(){return this.message}}class _ extends M{char;constructor(t,e,n){super(`Unexpected character '${n}' (${t}:${e})`,t,e),this.char=n,this.name="UnexpectedCharacterError"}}class G extends M{constructor(t,e){super(`Unexpected EOF (${t}:${e})`,t,e),this.name="UnexpectedEOFError"}}let z=new Map([[".",x.DOT],["if",x.IF],["let",x.LET],["cond",x.COND],["else",x.ELSE],["set!",x.SET],["begin",x.BEGIN],["delay",x.DELAY],["quote",x.QUOTE],["export",x.EXPORT],["import",x.IMPORT],["define",x.DEFINE],["lambda",x.LAMBDA],["define-syntax",x.DEFINE_SYNTAX],["syntax-rules",x.SYNTAX_RULES]]);class U{source;tokens;start=0;current=0;line=1;col=0;constructor(t){this.source=t,this.tokens=[]}isAtEnd(){return this.current>=this.source.length}advance(){return this.col++,this.source.charAt(this.current++)}jump(){this.start=this.current,this.col++,this.current++}addToken(t,e=null){const n=this.source.substring(this.start,this.current);this.tokens.push(new q(t,n,e,this.start,this.current,this.line,this.col))}scanTokens(){for(;!this.isAtEnd();)this.start=this.current,this.scanToken();return this.tokens.push(new q(x.EOF,"",null,this.start,this.current,this.line,this.col)),this.tokens}scanToken(){const t=this.advance();switch(t){case"(":this.addToken(x.LEFT_PAREN);break;case")":this.addToken(x.RIGHT_PAREN);break;case"[":this.addToken(x.LEFT_BRACKET);break;case"]":this.addToken(x.RIGHT_BRACKET);break;case"'":this.addToken(x.APOSTROPHE);break;case"`":this.addToken(x.BACKTICK);break;case",":if(this.match("@")){this.addToken(x.COMMA_AT);break}this.addToken(x.COMMA);break;case"#":if(this.match("t")||this.match("f"))this.booleanToken();else if(this.match("|"))this.comment();else if(this.match(";"))this.addToken(x.HASH_SEMICOLON);else{if("("!==this.peek()&&"["!==this.peek())throw new _(this.line,this.col,t);this.addToken(x.HASH_VECTOR)}break;case";":for(;"\n"!=this.peek()&&!this.isAtEnd();)this.advance();break;case" ":case"\r":case"\t":break;case"\n":this.line++,this.col=0;break;case'"':this.stringToken();break;case"|":this.identifierTokenLoose();break;default:if(this.isDigit(t)||"-"===t||"+"===t||"."===t||"i"===t||"n"===t)this.identifierNumberToken();else{if(!this.isValidIdentifier(t))throw new _(this.line,this.col,t);this.identifierToken()}}}comment(){for(;("|"!=this.peek()||"#"!=this.peekNext())&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new G(this.line,this.col);this.jump(),this.jump()}identifierToken(){for(;this.isValidIdentifier(this.peek());)this.advance();this.addToken(this.checkKeyword())}identifierTokenLoose(){for(this.advance();"|"!=this.peek()&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new G(this.line,this.col);this.advance(),this.addToken(this.checkKeyword())}identifierNumberToken(){for(;this.isValidIdentifier(this.peek());)this.advance();const t=this.source.substring(this.start,this.current);h(t,r.COMPLEX).result?this.addToken(x.NUMBER,t):this.addToken(this.checkKeyword())}checkKeyword(){var t=this.source.substring(this.start,this.current);return z.has(t)?z.get(t):x.IDENTIFIER}stringToken(){for(;'"'!=this.peek()&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new G(this.line,this.col);this.advance();const t=this.source.substring(this.start+1,this.current-1);this.addToken(x.STRING,t)}booleanToken(){this.addToken(x.BOOLEAN,"t"===this.peekPrev())}match(t){return!this.isAtEnd()&&(this.source.charAt(this.current)==t&&(this.current++,!0))}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}peekPrev(){return this.current-1<0?"\0":this.source.charAt(this.current-1)}isDigit(t){return t>="0"&&t<="9"}isSpecialSyntax(t){return"("===t||")"===t||"["===t||"]"===t||";"===t||"|"===t}isValidIdentifier(t){return!this.isWhitespace(t)&&!this.isSpecialSyntax(t)}isWhitespace(t){return" "===t||"\0"===t||"\n"===t||"\r"===t||"\t"===t}}var H,D;!function(t){class e{location;expressions;constructor(t,e){this.location=t,this.expressions=e}accept(t){return t.visitSequence(this)}equals(t){if(t instanceof e){if(this.expressions.length!==t.expressions.length)return!1;for(let e=0;e<this.expressions.length;e++)if(!this.expressions[e].equals(t.expressions[e]))return!1;return!0}return!1}}t.Sequence=e;class n{location;value;constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitNumericLiteral(this)}equals(t){return t instanceof n&&this.value===t.value}}t.NumericLiteral=n;class r{location;value;constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitBooleanLiteral(this)}equals(t){return t instanceof r&&this.value===t.value}}t.BooleanLiteral=r;class s{location;value;constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitStringLiteral(this)}equals(t){return t instanceof s&&this.value===t.value}}t.StringLiteral=s;class i{location;params;rest;body;constructor(t,e,n,r=void 0){this.location=t,this.params=n,this.rest=r,this.body=e}accept(t){return t.visitLambda(this)}equals(t){if(t instanceof i){if(this.params.length!==t.params.length)return!1;for(let e=0;e<this.params.length;e++)if(!this.params[e].equals(t.params[e]))return!1;if(this.rest&&t.rest){if(!this.rest.equals(t.rest))return!1}else if(this.rest||t.rest)return!1;return this.body.equals(t.body)}return!1}}t.Lambda=i;class a{location;name;constructor(t,e){this.location=t,this.name=e}accept(t){return t.visitIdentifier(this)}equals(t){return t instanceof a&&this.name===t.name}}t.Identifier=a;class o{location;name;value;constructor(t,e,n){this.location=t,this.name=e,this.value=n}accept(t){return t.visitDefinition(this)}equals(t){return t instanceof o&&(this.name.equals(t.name)&&this.value.equals(t.value))}}t.Definition=o;class c{location;operator;operands;constructor(t,e,n){this.location=t,this.operator=e,this.operands=n}accept(t){return t.visitApplication(this)}equals(t){if(t instanceof c){if(!this.operator.equals(t.operator))return!1;if(this.operands.length!==t.operands.length)return!1;for(let e=0;e<this.operands.length;e++)if(!this.operands[e].equals(t.operands[e]))return!1;return!0}return!1}}t.Application=c;class u{location;test;consequent;alternate;constructor(t,e,n,r){this.location=t,this.test=e,this.consequent=n,this.alternate=r}accept(t){return t.visitConditional(this)}equals(t){return t instanceof u&&(this.test.equals(t.test)&&this.consequent.equals(t.consequent)&&this.alternate.equals(t.alternate))}}t.Conditional=u;class h{location;car;cdr;constructor(t,e,n){this.location=t,this.car=e,this.cdr=n}accept(t){return t.visitPair(this)}equals(t){return t instanceof h&&(this.car.equals(t.car)&&this.cdr.equals(t.cdr))}}t.Pair=h;class l{location;constructor(t){this.location=t}accept(t){return t.visitNil(this)}equals(t){return t instanceof l}}t.Nil=l;class p{location;value;constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitSymbol(this)}equals(t){return t instanceof p&&this.value===t.value}}t.Symbol=p;class w{location;value;constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitSpliceMarker(this)}equals(t){return t instanceof w&&this.value.equals(t.value)}}t.SpliceMarker=w;class f{location;name;value;constructor(t,e,n){this.location=t,this.name=e,this.value=n}accept(t){return t.visitReassignment(this)}equals(t){return t instanceof f&&(this.name.equals(t.name)&&this.value.equals(t.value))}}t.Reassignment=f;class y{location;source;identifiers;constructor(t,e,n){this.location=t,this.source=e,this.identifiers=n}accept(t){return t.visitImport(this)}equals(t){if(t instanceof y){if(!this.source.equals(t.source))return!1;if(this.identifiers.length!==t.identifiers.length)return!1;for(let e=0;e<this.identifiers.length;e++)if(!this.identifiers[e].equals(t.identifiers[e]))return!1;return!0}return!1}}t.Import=y;class d{location;definition;constructor(t,e){this.location=t,this.definition=e}accept(t){return t.visitExport(this)}equals(t){return t instanceof d&&this.definition.equals(t.definition)}}t.Export=d;class m{location;elements;constructor(t,e){this.location=t,this.elements=e}accept(t){return t.visitVector(this)}equals(t){if(t instanceof m){if(this.elements.length!==t.elements.length)return!1;for(let e=0;e<this.elements.length;e++)if(!this.elements[e].equals(t.elements[e]))return!1;return!0}return!1}}t.Vector=m;class g{location;name;transformer;constructor(t,e,n){this.location=t,this.name=e,this.transformer=n}accept(t){return t.visitDefineSyntax(this)}equals(t){return t instanceof g&&(this.name.equals(t.name)&&this.transformer.equals(t.transformer))}}t.DefineSyntax=g;class v{location;literals;rules;constructor(t,e,n){this.location=t,this.literals=e,this.rules=n}accept(t){return t.visitSyntaxRules(this)}equals(t){if(t instanceof v){if(this.literals.length!==t.literals.length)return!1;for(let e=0;e<this.literals.length;e++)if(!this.literals[e].equals(t.literals[e]))return!1;if(this.rules.length!==t.rules.length)return!1;for(let e=0;e<this.rules.length;e++)if(!this.rules[e][0].equals(t.rules[e][0])||!this.rules[e][1].equals(t.rules[e][1]))return!1;return!0}return!1}}t.SyntaxRules=v}(H||(H={})),function(t){class e{location;name;params;rest;body;constructor(t,e,n,r,s=void 0){this.location=t,this.name=e,this.body=n,this.params=r,this.rest=s}accept(t){return t.visitFunctionDefinition(this)}equals(t){if(t instanceof e){if(this.params.length!==t.params.length)return!1;for(let e=0;e<this.params.length;e++)if(!this.params[e].equals(t.params[e]))return!1;if(this.rest&&t.rest){if(!this.rest.equals(t.rest))return!1}else if(this.rest||t.rest)return!1;return this.body.equals(t.body)}return!1}}t.FunctionDefinition=e;class n{location;identifiers;values;body;constructor(t,e,n,r){this.location=t,this.identifiers=e,this.values=n,this.body=r}accept(t){return t.visitLet(this)}equals(t){if(t instanceof n){if(this.identifiers.length!==t.identifiers.length)return!1;for(let e=0;e<this.identifiers.length;e++)if(!this.identifiers[e].equals(t.identifiers[e]))return!1;if(this.values.length!==t.values.length)return!1;for(let e=0;e<this.values.length;e++)if(!this.values[e].equals(t.values[e]))return!1;return this.body.equals(t.body)}return!1}}t.Let=n;class r{location;predicates;consequents;catchall;constructor(t,e,n,r){this.location=t,this.predicates=e,this.consequents=n,this.catchall=r}accept(t){return t.visitCond(this)}equals(t){if(t instanceof r){if(this.predicates.length!==t.predicates.length)return!1;for(let e=0;e<this.predicates.length;e++)if(!this.predicates[e].equals(t.predicates[e]))return!1;if(this.consequents.length!==t.consequents.length)return!1;for(let e=0;e<this.consequents.length;e++)if(!this.consequents[e].equals(t.consequents[e]))return!1;return this.catchall&&t.catchall?this.catchall.equals(t.catchall):!this.catchall&&!t.catchall}return!1}}t.Cond=r;class s{location;elements;terminator;constructor(t,e,n=void 0){this.location=t,this.elements=e,this.terminator=n}accept(t){return t.visitList(this)}equals(t){if(t instanceof s){if(this.elements.length!==t.elements.length)return!1;for(let e=0;e<this.elements.length;e++)if(!this.elements[e].equals(t.elements[e]))return!1;return this.terminator&&t.terminator?this.terminator.equals(t.terminator):!this.terminator&&!t.terminator}return!1}}t.List=s;class i{location;expressions;constructor(t,e){this.location=t,this.expressions=e}accept(t){return t.visitBegin(this)}equals(t){if(t instanceof i){if(this.expressions.length!==t.expressions.length)return!1;for(let e=0;e<this.expressions.length;e++)if(!this.expressions[e].equals(t.expressions[e]))return!1;return!0}return!1}}t.Begin=i;class a{location;expression;constructor(t,e){this.location=t,this.expression=e}accept(t){return t.visitDelay(this)}equals(t){return t instanceof a&&this.expression.equals(t.expression)}}t.Delay=a}(D||(D={}));var F;!function(t){t[t.NONE=0]="NONE",t[t.QUOTE=1]="QUOTE",t[t.QUASIQUOTE=2]="QUASIQUOTE"}(F||(F={}));class V{source;tokens;chapter;current=0;quoteMode=F.NONE;constructor(t,e,n=1/0){this.source=t,this.tokens=e,this.chapter=n}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.current>=this.tokens.length}previous(){return this.tokens[this.current-1]}peek(){return this.tokens[this.current]}validateChapter(t,e){if(this.chapter<e)throw new A(this.source,t.pos,t,this.chapter)}toLocation(t){return new N(t.pos,t.endPos)}destructureList(t,e=t=>{}){if(0===t.length)return[[],void 0];if(1===t.length)return e(t[0]),[[this.parseExpression(t[0])],void 0];const n=t.at(-2);if(C(n)&&n.type===x.DOT){const n=t.at(-1),r=t.slice(0,-2);return e(n),r.forEach(e),[r.map(this.parseExpression.bind(this)),this.parseExpression(n)]}const r=t;return r.forEach(e),[r.map(this.parseExpression.bind(this)),void 0]}grouping(t){const e=[];let n=!1;t&&(n=!0,e.push(t));do{let t=this.advance();switch(t.type){case x.LEFT_PAREN:case x.LEFT_BRACKET:const r=this.grouping(t);e.push(r);break;case x.RIGHT_PAREN:case x.RIGHT_BRACKET:if(!n)throw new L(this.source,t.pos,t);e.push(t),n=!1;break;case x.APOSTROPHE:case x.BACKTICK:case x.COMMA:case x.COMMA_AT:case x.HASH_VECTOR:let s;do{s=this.grouping()}while(!s);e.push(this.affect(t,s));break;case x.QUOTE:case x.QUASIQUOTE:case x.UNQUOTE:case x.UNQUOTE_SPLICING:case x.IDENTIFIER:case x.NUMBER:case x.BOOLEAN:case x.STRING:case x.DOT:case x.DEFINE:case x.IF:case x.ELSE:case x.COND:case x.LAMBDA:case x.LET:case x.SET:case x.BEGIN:case x.DELAY:case x.IMPORT:case x.EXPORT:case x.DEFINE_SYNTAX:case x.SYNTAX_RULES:e.push(t);break;case x.HASH_SEMICOLON:for(;!this.grouping(););break;case x.EOF:throw new S(this.source,t.pos);default:throw new L(this.source,t.pos,t)}}while(n);if(0!==e.length)try{return B.build(e)}catch(t){if(t instanceof O)throw new O(this.source,t.loc,t.form,t.expected);throw t}}affect(t,e){return B.build([t,e])}parseExpression(t){return C(t)?this.parseToken(t):t.isSingleIdentifier()?this.parseToken(t.unwrap()[0]):this.parseGroup(t)}parseToken(t){switch(t.type){case x.IDENTIFIER:return this.quoteMode===F.NONE?new H.Identifier(this.toLocation(t),t.lexeme):new H.Symbol(this.toLocation(t),t.lexeme);case x.NUMBER:return new H.NumericLiteral(this.toLocation(t),t.literal);case x.BOOLEAN:return new H.BooleanLiteral(this.toLocation(t),t.literal);case x.STRING:return new H.StringLiteral(this.toLocation(t),t.literal);default:if(this.quoteMode!==F.NONE||this.chapter>=5)return new H.Symbol(this.toLocation(t),t.lexeme);throw new L(this.source,t.pos,t)}}parseGroup(t){if(!t.isParenthesized())return this.parseAffectorGroup(t);switch(this.quoteMode){case F.NONE:return this.parseNormalGroup(t);case F.QUOTE:case F.QUASIQUOTE:return this.parseQuotedGroup(t)}}parseAffectorGroup(t){const[e,n]=t.unwrap();switch(e.type){case x.APOSTROPHE:case x.QUOTE:if(this.validateChapter(e,2),this.quoteMode!==F.NONE){const t=this.parseExpression(n),r=new H.Symbol(this.toLocation(e),"quote"),s=r.location.merge(t.location);return new D.List(s,[r,t])}this.quoteMode=F.QUOTE;const r=this.parseExpression(n);return this.quoteMode=F.NONE,r;case x.BACKTICK:case x.QUASIQUOTE:if(this.validateChapter(e,2),this.quoteMode!==F.NONE){const t=this.parseExpression(n),r=new H.Symbol(this.toLocation(e),"quasiquote"),s=r.location.merge(t.location);return new D.List(s,[r,t])}this.quoteMode=F.QUASIQUOTE;const s=this.parseExpression(n);return this.quoteMode=F.NONE,s;case x.COMMA:case x.UNQUOTE:this.validateChapter(e,2);let i=this.quoteMode;if(i===F.NONE)throw new I(this.source,e.pos,e);if(i===F.QUOTE){const t=this.parseExpression(n),r=new H.Symbol(this.toLocation(e),"unquote"),s=r.location.merge(t.location);return new D.List(s,[r,t])}this.quoteMode=F.NONE;const a=this.parseExpression(n);return this.quoteMode=i,a;case x.COMMA_AT:case x.UNQUOTE_SPLICING:this.validateChapter(e,2);let o=this.quoteMode;if(o===F.NONE)throw new L(this.source,e.pos,e);if(o===F.QUOTE){const t=this.parseExpression(n),r=new H.Symbol(this.toLocation(e),"unquote-splicing"),s=r.location.merge(t.location);return new D.List(s,[r,t])}this.quoteMode=F.NONE;const c=this.parseExpression(n);this.quoteMode=o;const u=this.toLocation(e).merge(c.location);return new H.SpliceMarker(u,c);case x.HASH_VECTOR:this.validateChapter(e,3);let h=this.quoteMode;this.quoteMode=F.QUOTE;const l=this.parseVector(t);return this.quoteMode=h,l;default:throw new L(this.source,e.pos,e)}}parseNormalGroup(t){if(0===t.length()){if(this.chapter>=5)return new H.Nil(t.location);throw new O(this.source,t.location.start,t,"non-empty group")}const e=t.unwrap()[0];if(C(e))switch(e.type){case x.LAMBDA:return this.validateChapter(e,1),this.parseLambda(t);case x.DEFINE:return this.validateChapter(e,1),this.parseDefinition(t);case x.IF:return this.validateChapter(e,1),this.parseConditional(t);case x.LET:return this.validateChapter(e,1),this.parseLet(t);case x.COND:return this.validateChapter(e,1),this.parseExtendedCond(t);case x.QUOTE:case x.APOSTROPHE:case x.QUASIQUOTE:case x.BACKTICK:case x.UNQUOTE:case x.COMMA:case x.UNQUOTE_SPLICING:case x.COMMA_AT:return this.validateChapter(e,2),this.parseAffectorGroup(t);case x.BEGIN:return this.validateChapter(e,3),this.parseBegin(t);case x.DELAY:return this.validateChapter(e,3),this.parseDelay(t);case x.SET:return this.validateChapter(e,3),this.parseSet(t);case x.DEFINE_SYNTAX:return this.validateChapter(e,5),this.parseDefineSyntax(t);case x.SYNTAX_RULES:throw new L(this.source,e.pos,e);case x.IMPORT:return this.validateChapter(e,1),this.parseImport(t);case x.EXPORT:return this.validateChapter(e,1),this.parseExport(t);case x.VECTOR:return this.validateChapter(e,3),this.parseAffectorGroup(t);default:return this.parseApplication(t)}return this.parseApplication(t)}parseQuotedGroup(t){if(0===t.length())return new H.Nil(t.location);if(1===t.length()){const e=[this.parseExpression(t.unwrap()[0])];return new D.List(t.location,e)}const e=t.unwrap(),[n,r]=this.destructureList(e);return new D.List(t.location,n,r)}parseLambda(t){if(t.length()<3)throw new O(this.source,t.location.start,t,"(lambda (<identifier>* . <rest-identifier>?) <body>+) | (lambda <rest-identifer> <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);let s,i=[];if(C(n)){if(n.type!==x.IDENTIFIER)throw new O(this.source,n.pos,n,"<rest-identifier>");s=new H.Identifier(this.toLocation(n),n.lexeme)}else{const t=n.unwrap();[i,s]=this.destructureList(t,(t=>{if(!C(t))throw new O(this.source,t.pos,t,"<identifier>");if(t.type!==x.IDENTIFIER)throw new O(this.source,t.pos,t,"<identifier>")}))}const a=r.map(this.parseExpression.bind(this));if(a.length<1)throw new O(this.source,t.location.start,t,"(lambda ... <body>+)");if(1===a.length)return new H.Lambda(t.location,a[0],i,s);const o=a.at(0).location.merge(a.at(-1).location),c=new H.Sequence(o,a);return new H.Lambda(t.location,c,i,s)}parseDefinition(t){if(t.length()<3)throw new O(this.source,t.location.start,t,"(define <identifier> <expr>) | (define (<identifier> <formals>) <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);let s,i,a=[],o=!1;if(R(n)){o=!0;const t=n.unwrap(),e=t[0],r=t.splice(1);if(!C(e))throw new O(this.source,e.location.start,e,"<identifier>");if(e.type!==x.IDENTIFIER)throw new O(this.source,e.pos,e,"<identifier>");s=new H.Identifier(this.toLocation(e),e.lexeme),[a,i]=this.destructureList(r,(t=>{if(!C(t))throw new O(this.source,t.pos,t,"<identifier>");if(t.type!==x.IDENTIFIER)throw new O(this.source,t.pos,t,"<identifier>")}))}else{if(n.type!==x.IDENTIFIER)throw new O(this.source,n.pos,n,"<identifier>");s=new H.Identifier(this.toLocation(n),n.lexeme),o=!1}if(r.length<1)throw new O(this.source,t.location.start,t,"(define ... <body>+)");if(o){const e=r.map(this.parseExpression.bind(this));if(1===e.length)return new D.FunctionDefinition(t.location,s,e[0],a,i);const n=e.at(0).location.merge(e.at(-1).location),o=new H.Sequence(n,e);return new D.FunctionDefinition(t.location,s,o,a,i)}if(r.length>1)throw new O(this.source,t.location.start,t,"(define <identifier> <expr>)");const c=this.parseExpression(r[0]);return new H.Definition(t.location,s,c)}parseConditional(t){if(t.length()<3||t.length()>4)throw new O(this.source,t.location.start,t,"(if <pred> <cons> <alt>?)");const e=t.unwrap(),n=e[1],r=e[2],s=t.length()>3?e[3]:void 0,i=this.parseExpression(n),a=this.parseExpression(r),o=s?this.parseExpression(s):new H.Identifier(t.location,"undefined");return new H.Conditional(t.location,i,a,o)}parseApplication(t){if(t.length()<1)throw new O(this.source,t.location.start,t,"(<func> <args>*)");const e=t.unwrap(),n=e[0],r=e.splice(1),s=this.parseExpression(n),i=[];for(const t of r)i.push(this.parseExpression(t));return new H.Application(t.location,s,i)}parseLet(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach((t=>{this.parseExpression(t)})),new D.Let(t.location,[],[],new H.Identifier(t.location,"undefined"))}if(t.length()<3)throw new O(this.source,t.location.start,t,"(let ((<identifier> <value>)*) <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);if(!R(n))throw new O(this.source,n.pos,n,"((<identifier> <value>)*)");const s=[],i=[],a=n.unwrap();for(const t of a){if(!R(t))throw new O(this.source,t.pos,t,"(<identifier> <value>)");if(2!==t.length())throw new O(this.source,t.location.start,t,"(<identifier> <value>)");const[e,n]=t.unwrap();if(!C(e))throw new O(this.source,e.location.start,e,"<identifier>");if(e.type!==x.IDENTIFIER)throw new O(this.source,e.pos,e,"<identifier>");s.push(new H.Identifier(this.toLocation(e),e.lexeme)),i.push(this.parseExpression(n))}const o=r.map(this.parseExpression.bind(this));if(o.length<1)throw new O(this.source,t.location.start,t,"(let ... <body>+)");if(1===o.length)return new D.Let(t.location,s,i,o[0]);const c=o.at(0).location.merge(o.at(-1).location),u=new H.Sequence(c,o);return new D.Let(t.location,s,i,u)}parseExtendedCond(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach((t=>{this.parseExpression(t)})),new D.Cond(t.location,[],[],new H.Identifier(t.location,"undefined"))}if(t.length()<2)throw new O(this.source,t.location.start,t,"(cond (<pred> <body>*)* (else <val>)?)");const e=t.unwrap().splice(1),n=e.pop(),r=[],s=[];for(const t of e){if(!R(t))throw new O(this.source,t.pos,t,"(<pred> <body>*)");if(t.length()<1)throw new O(this.source,t.firstToken().pos,t.firstToken(),"(<pred> <body>*)");const[e,...n]=t.unwrap();if(C(e)&&e.type===x.ELSE)throw new O(this.source,e.pos,e,"<predicate>");const i=this.parseExpression(e),a=n.map(this.parseExpression.bind(this)),o=n.length<1?i.location:a.at(0).location.merge(a.at(-1).location),c=n.length<1?i:n.length<2?a[0]:new H.Sequence(o,a);r.push(i),s.push(c)}if(!R(n))throw new O(this.source,n.pos,n,"(<pred> <body>+) | (else <val>)");if(n.length()<2)throw new O(this.source,n.firstToken().pos,n.firstToken(),"(<pred> <body>+) | (else <val>)");const[i,...a]=n.unwrap();let o=!1;if(C(i)&&i.type===x.ELSE&&(o=!0,1!==a.length))throw new O(this.source,n.location.start,n,"(else <val>)");if(a.length<1)throw new O(this.source,n.location.start,n,"(<pred> <body>+)");const c=a.map(this.parseExpression.bind(this)),u=c.at(0).location.merge(c.at(-1).location),h=1===a.length?c[0]:new H.Sequence(u,c);if(o)return new D.Cond(t.location,r,s,h);const l=this.parseExpression(i);return r.push(l),s.push(h),new D.Cond(t.location,r,s)}parseSet(t){if(3!==t.length())throw new O(this.source,t.location.start,t,"(set! <identifier> <expr>)");const e=t.unwrap(),n=e[1],r=e[2];if(R(n))throw new O(this.source,n.location.start,n,"<identifier>");if(n.type!==x.IDENTIFIER)throw new O(this.source,n.pos,n,"<identifier>");const s=new H.Identifier(this.toLocation(n),n.lexeme),i=this.parseExpression(r);return new H.Reassignment(t.location,s,i)}parseBegin(t){if(t.length()<2)throw new O(this.source,t.location.start,t,"(begin <body>+)");const e=t.unwrap().slice(1),n=[];for(const t of e)n.push(this.parseExpression(t));return new D.Begin(t.location,n)}parseDelay(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach((t=>{this.parseExpression(t)})),new D.Delay(t.location,new H.Identifier(t.location,"undefined"))}if(2!==t.length())throw new O(this.source,t.location.start,t,"(delay <expr>)");const e=t.unwrap()[1],n=this.parseExpression(e);return new D.Delay(t.location,n)}parseDefineSyntax(t){if(3!==t.length())throw new O(this.source,t.location.start,t,"(define-syntax <identifier> <transformer>)");const e=t.unwrap(),n=e[1],r=e[2];this.quoteMode=F.QUOTE;const s=this.parseExpression(n);if(this.quoteMode=F.NONE,!(s instanceof H.Symbol))throw new O(this.source,s.location.start,n,"<identifier>");if(!R(r))throw new O(this.source,r.pos,r,"<transformer>");if(r.length()<2)throw new O(this.source,r.firstToken().pos,r,"(syntax-rules ...)");const i=r.unwrap()[0];if(!C(r.unwrap()[0]))throw new O(this.source,r.firstToken().pos,i,"syntax-rules");if(i.type!==x.SYNTAX_RULES)throw new O(this.source,i.pos,i,"syntax-rules");const a=this.parseSyntaxRules(r);return new H.DefineSyntax(t.location,s,a)}isValidPattern(t){if(t instanceof D.List){if(void 0===t.terminator){if(t.elements.filter((t=>t instanceof H.Symbol&&"..."===t.value)).length>1)return!1;const e=t.elements.findIndex((t=>t instanceof H.Symbol&&"..."===t.value));if(-1!=e&&0===e)return!1;for(const e of t.elements)if(!this.isValidPattern(e))return!1;return!0}{if(t.elements.filter((t=>t instanceof H.Symbol&&"..."===t.value)).length>1)return!1;const e=t.elements.findIndex((t=>t instanceof H.Symbol&&"..."===t.value));if(-1!=e){if(0===e)return!1;if(e===t.elements.length-1)return!1}for(const e of t.elements)if(!this.isValidPattern(e))return!1;return this.isValidPattern(t.terminator)}}return t instanceof H.Symbol||t instanceof H.BooleanLiteral||t instanceof H.NumericLiteral||t instanceof H.StringLiteral||t instanceof H.Nil}isValidTemplate(t){if(t instanceof D.List){if(void 0===t.terminator){if(0===t.elements.length)return!1;if(2===t.elements.length&&t.elements[0]instanceof H.Symbol&&"..."===t.elements[0].value)return this.isValidTemplate(t.elements[1]);let e=!1;for(let n=0;n<t.elements.length;n++){const r=t.elements[n];if(r instanceof H.Symbol&&"..."===r.value){if(e){e=!1;continue}return!1}if(!this.isValidTemplate(r))return!1;e=!0}return!0}{if(0===t.elements.length)return!1;let e=!1;for(let n=0;n<t.elements.length;n++){const r=t.elements[n];if(r instanceof H.Symbol&&"..."===r.value){if(e){e=!1;continue}return!1}if(!this.isValidTemplate(r))return!1;e=!0}return this.isValidTemplate(t.terminator)}}return t instanceof H.Symbol||t instanceof H.BooleanLiteral||t instanceof H.NumericLiteral||t instanceof H.StringLiteral||t instanceof H.Nil}parseSyntaxRules(t){if(t.length()<3)throw new O(this.source,t.location.start,t,"(syntax-rules (<literal>*) <syntax-rule>+)");const e=t.unwrap(),n=e[1],r=e.slice(2),s=[];if(!R(n))throw new O(this.source,n.pos,n,"(<literal>*)");this.quoteMode=F.QUOTE;for(const t of n.unwrap()){if(!C(t))throw new O(this.source,t.location.start,t,"<literal>");const e=this.parseExpression(t);if(!(e instanceof H.Symbol))throw new O(this.source,t.pos,t,"<literal>");s.push(e)}const i=[];for(const t of r){if(!R(t))throw new O(this.source,t.pos,t,"(<pattern> <template>)");if(2!==t.length())throw new O(this.source,t.location.start,t,"(<pattern> <template>)");const[e,n]=t.unwrap(),r=this.parseExpression(e),s=this.parseExpression(n);if(!this.isValidPattern(r))throw new O(this.source,r.location.start,e,"<symbol> | <literal> | (<pattern>+) | (<pattern>+ ... <pattern>*) | (<pattern>+ ... <pattern>+ . <pattern>)");if(!this.isValidTemplate(s))throw new O(this.source,s.location.start,n,"<symbol> | <literal> | (<element>+) | (<element>+ . <template>) | (... <template>)");i.push([r,s])}return this.quoteMode=F.NONE,new H.SyntaxRules(t.location,s,i)}parseImport(t){if(3!==t.length())throw new O(this.source,t.firstToken().pos,t.firstToken(),'(import "<source>" (<identifier>*))');const e=t.unwrap(),n=e[1],r=e[2];if(!C(n))throw new O(this.source,n.location.start,n,'"<source>"');if(n.type!==x.STRING)throw new O(this.source,n.pos,n,'"<source>"');if(!R(r))throw new O(this.source,r.pos,r,"(<identifier>*)");const s=r.unwrap(),i=[];for(const t of s){if(!C(t))throw new O(this.source,t.location.start,t,"<identifier>");if(t.type!==x.IDENTIFIER)throw new O(this.source,t.pos,t,"<identifier>");i.push(new H.Identifier(this.toLocation(t),t.lexeme))}const a=new H.StringLiteral(this.toLocation(n),n.literal);return new H.Import(t.location,a,i)}parseExport(t){if(2!==t.length())throw new O(this.source,t.firstToken().pos,t.firstToken(),"(export (<definition>))");const e=t.unwrap()[1];if(!R(e))throw new O(this.source,e.pos,e,"(<definition>)");const n=this.parseExpression(e);if(!(n instanceof H.Definition||n instanceof D.FunctionDefinition))throw new O(this.source,e.location.start,e,"(<definition>)");return new H.Export(t.location,n)}parseVector(t){const e=t.unwrap()[1].unwrap().map(this.parseExpression.bind(this));return new H.Vector(t.location,e)}parse(t=!1){t&&(this.quoteMode=F.QUOTE,this.current=0);const e=[];for(;!this.isAtEnd()&&this.peek().type!==x.EOF;){const t=this.grouping();if(!t)continue;const n=this.parseExpression(t);e.push(n)}if(this.chapter>=5&&!t){return[...e.filter((t=>t instanceof H.Import)),...this.parse(!0).filter((t=>!(t instanceof D.List&&t.elements&&t.elements[0]instanceof H.Symbol&&"import"===t.elements[0].value)))]}return e}}class Q{source;startLine;startColumn;endLine;endColumn;constructor(t,e,n,r,s){this.source=t,this.startLine=e,this.startColumn=n,this.endLine=r,this.endColumn=s}}class X{start;end;source;constructor(t,e,n){this.start=t,this.end=e,this.source=n}}class K{syntax;forInfo;constructor(t,e){this.syntax=t,this.forInfo=e}locationToSrcLoc(){return new Q(this.syntax.source,this.syntax.start.line,this.syntax.start.column,this.syntax.end.line,this.syntax.end.column)}toString(){return`${this.syntax.source}:${this.syntax.start.line}:${this.syntax.start.column}`}}function Y(t){return new K(t.syntax,!1)}const Z={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},j={"₀":"0","₁":"1","₂":"2","₃":"3","₄":"4","₅":"5","₆":"6","₇":"7","₈":"8","₉":"9"};function W(t,e){if(t.some((t=>t===e))){return J(t,function(t){const[e,n]=et(t,t.length-1);return[e,n]}(e))}return e}function J(t,e){const n=function([t,e]){const n=function(t){const e=t.toString().split("").map((t=>Z[t]||t)).join("");return e}(e);return t+n}(e);return t.map((t=>t.toString())).includes(n.toString())?J(t,function(t){return[t[0],t[1]+1]}(e)):n}function tt(t){const e=t.split("").map((t=>j[t]||t)).join("");return parseInt(e,10)||1}function et(t,e){return e<0?[t,0]:(n=t[e],Object.keys(j).includes(n)?et(t,e-1):[t.substring(0,e+1),tt(t.substring(e+1))]);var n}class nt{location;varName;constructor(t,e){this.location=t,this.varName=e}prettyPrint(){return`${this.varName}`}}class rt{binder;type;constructor(t,e){this.binder=t,this.type=e}prettyPrint(){return`${this.binder.prettyPrint()} : ${this.type.prettyPrint()}`}findNames(){return this.binder.varName}}class st{message;constructor(t){this.message=t}toString(){return this.message.map((t=>"string"==typeof t?t:t.prettyPrint())).join(" ")}}class it{}class at extends it{result;constructor(t){super(),this.result=t}}class ot extends it{where;message;constructor(t,e){super(),this.where=t,this.message=e}}class ct{name;value;constructor(t,e=null){this.name=t,this.value=e}}function ut(t,e){for(const[e,n]of t){const r=n();if(!(r instanceof at))throw new Error(`Encountered stop when evaluating the sequence ${t}. Error message: ${r.message.message} at ${r.where}`);e.value=r.result}return e()}class ht{constructor(){}}class lt extends ht{env;varName;expr;constructor(t,e,n){super(),this.env=t,this.varName=e,this.expr=n}valOfClosure(t){return this.expr.valOf((e=this.env,n=this.varName,r=t,new Map([...e,[n,r]])));var e,n,r}prettyPrint(){return`(CLOS ${this.varName} ${this.expr.prettyPrint()})`}toString(){return this.prettyPrint()}}class pt extends ht{proc;constructor(t){super(),this.proc=t}valOfClosure(t){return this.proc(t)}prettyPrint(){return this.proc.toString()}toString(){return this.prettyPrint()}}function wt(t){return!("U"===(e=t)||"Nat"===e||"zero"===e||"add1"===e||"which-Nat"===e||"iter-Nat"===e||"rec-Nat"===e||"ind-Nat"===e||"->"===e||"→"===e||"Π"===e||"λ"===e||"Pi"===e||"∏"===e||"lambda"===e||"quote"===e||"Atom"===e||"car"===e||"cdr"===e||"cons"===e||"Σ"===e||"Sigma"===e||"Pair"===e||"Trivial"===e||"sole"===e||"List"===e||"::"===e||"nil"===e||"rec-List"===e||"ind-List"===e||"Absurd"===e||"ind-Absurd"===e||"="===e||"same"===e||"replace"===e||"trans"===e||"cong"===e||"symm"===e||"ind-="===e||"Vec"===e||"vecnil"===e||"vec::"===e||"head"===e||"tail"===e||"ind-Vec"===e||"Either"===e||"left"===e||"right"===e||"ind-Either"===e||"TODO"===e||"the"===e)&&isNaN(Number(t));var e}function ft(t){return Array.from(t.keys())}function yt(t,e){return W(ft(t),e)}function dt(t,e,n){return W(ft(t).concat(e.findNames()),n)}function mt(t){return[t.binder.varName].concat(t.type.findNames())}function gt(t,e,n){return new Map([...t,[e,n]])}function vt(t,e){return e.valOf(Pt(t))}function Et(t){const e=new Map;for(const[n,r]of t)r instanceof St?e.set(n,["free",r.type.readBackType(t)]):r instanceof $t?e.set(n,["def",r.type.readBackType(t),Qt(t,r.type,r.value)]):r instanceof kt&&e.set(n,["claim",r.type.readBackType(t)]);return e}function Tt(t,e,n,r){const s=new ct("typeOut");return ut([[new ct("_"),()=>function(t,e,n){return t.has(n)?new ot(e,new st([`The name "${n}" is already in use in the context.`])):new at(!0)}(t,n,e)],[s,()=>r.isType(t,new Map)]],(()=>new at(gt(t,e,new kt(vt(t,s.value))))))}function Nt(t,e,n,r){const s=new ct("typeOut"),i=new ct("exprOut");return ut([[s,()=>function(t,e,n){for(const[r,s]of t)if(r===n){if(s instanceof $t)return new ot(e,new st([`The name "${n}" is already defined.`]));if(s instanceof kt)return new at(s.type)}return new ot(e,new st([`No claim: ${n}`]))}(t,n,e)],[i,()=>r.check(t,new Map,s.value)]],(()=>new at(function(t,e,n,r){return gt(t,e,new $t(n,r))}(function(t,e){return t.delete(e),t}(t,e),e,s.value,vt(t,i.value)))))}function Pt(t){if(0===t.size)return new Map;const e=t.entries(),n=new Map;for(const[t,r]of e)r instanceof $t?n.set(t,r.value):r instanceof St&&n.set(t,new De(r.type,new Yt(t)));return n}const xt=new Map;class bt{}let kt=class extends bt{type;constructor(t){super(),this.type=t}};class $t extends bt{type;value;constructor(t,e){super(),this.type=t,this.value=e}}class St extends bt{type;constructor(t){super(),this.type=t}}class Lt extends bt{name;type;constructor(t,e){super(),this.name=t,this.type=e}}class Ot extends bt{name;type;constructorType;constructor(t,e,n){super(),this.name=t,this.type=e,this.constructorType=n}}function At(t,e,n){if(0===t.size)throw new Error(`The context ${JSON.stringify(t)} is empty, but we are looking for ${n}`);for(const[e,r]of t.entries())if(!(r instanceof kt)&&n===e)return new at(r.type);throw new Error(`Unknown variable ${n}`)}function It(t,e,n){if(t.has(e)){for(const[r,s]of t)if(r===e)return gt(t,e,new St(n));throw new Error(`\n      ${e} is already bound in ${JSON.stringify(t)}\n    `)}return gt(t,e,new St(n))}function Bt(t,e){const n=t.now();if(n instanceof Le)return n.body.valOfClosure(e);if(n instanceof De){const t=n.type.now();if(t instanceof Se)return new De(t.resultType.valOfClosure(e),new ve(n.neutral,new Xt(t.argType,e)))}throw new Error(`doApp: invalid input ${[n,e]}`)}function Ct(t,e,n,r){const s=t.now();if(s instanceof ke)return n;if(s instanceof $e)return Bt(r,Ct(s.smaller,e,n,r));if(s instanceof De){if(s.type.now()instanceof be)return new De(e,new Wt(s.neutral,new Xt(e,n),new Xt(new Se("n",new be,new pt((t=>e))),r)))}throw new Error(`invalid input for iterNat ${[t,e,n,r]}`)}function Rt(t,e,n,r){const s=t.now();if(s instanceof ke)return n;if(s instanceof $e)return Bt(Bt(r,s.smaller),Rt(s.smaller,e,n,r));if(s instanceof De){if(s.type.now()instanceof be)return new De(e,new Jt(s.neutral,new Xt(e,n),new Xt(new Se("n-1",new be,new pt((t=>new Se("ih",e,new pt((t=>e)))))),r)))}throw new Error(`invalid input for recNat ${[t,e,n,r]}`)}function qt(t,e,n,r){const s=t.now();if(s instanceof ke)return n;if(s instanceof $e)return Bt(Bt(r,s.smaller),qt(s.smaller,e,n,r));if(s instanceof De){if(s.type.now()instanceof be)return new De(Bt(e,t),new te(s.neutral,new Xt(new Se("x",new be,new pt((t=>new Fe))),e),new Xt(Bt(e,new ke),n),new Xt(new Se("n-1",new be,new pt((t=>new Se("ih",Bt(e,t),new pt((n=>Bt(e,new $e(t)))))))),r)))}throw new Error(`invalid input for indNat ${[t,e,n,r]}`)}function Mt(t){const e=t.now();if(e instanceof Ae)return e.car;if(e instanceof De){const t=e.type.now();if(t instanceof Oe){const n=t,r=e.neutral;return new De(n.carType,new ee(r))}}throw new Error(`invalid input for car ${t}`)}function _t(t){const e=t.now();if(e instanceof Ae)return e.cdr;if(e instanceof De){const n=e.type.now();if(n instanceof Oe){const r=n,s=e.neutral;return new De(r.cdrType.valOfClosure(Mt(t)),new ne(s))}}throw new Error(`invalid input for cdr ${t}`)}function Gt(t,e,n,r){const s=t.now();if(s instanceof Be)return n;if(s instanceof Ce)return Bt(Bt(Bt(r,s.head),s.tail),Gt(s.tail,e,n,r));if(s instanceof De){const i=s.type.now();if(i instanceof Ie){const a=i.entryType,o=s.neutral,c=new Se("xs",new Ie(a),new pt((t=>new Fe)));return new De(Bt(e,t),new se(o,new Xt(c,e),new Xt(Bt(e,new Be),n),new Xt(new Se("h",a,new pt((t=>new Se("t",new Ie(a),new pt((n=>new Se("ih",Bt(e,n),new pt((r=>Bt(e,new Ce(t,n))))))))))),r)))}}throw new Error(`invalid input for indList ${[s,e,n,r]}`)}function zt(t,e,n,r){const s=t.now();if(s instanceof Be)return n;if(s instanceof Ce){const t=s.head,i=s.tail;return Bt(Bt(Bt(r,t),i),zt(i,e,n,r))}if(s instanceof De){const t=s.type.now();if(t instanceof Ie){const i=t.entryType,a=s.neutral;return new De(e,new re(a,new Xt(e,n),new Xt(new Se("h",i,new pt((t=>new Se("t",new Ie(i),new pt((t=>new Se("ih",e,new pt((t=>e))))))))),r)))}}throw new Error(`invalid input for recList ${[s,e,n,r]}`)}function Ut(t){const e=t.now();if(e instanceof Ge)return e.tail;if(e instanceof De&&e.type.now()instanceof Me&&e.type.now().length.now()instanceof $e){const t=e.type.now();if(t instanceof Me){if(t.length.now()instanceof $e)return new De(new Me(e.type.now().entryType,e.type.now().length.now().smaller),new fe(e.neutral))}}throw new Error(`invalid input for tail ${t.prettyPrint()}`)}function Ht(t,e){return new Se("k",new be,new pt((n=>new Se("e",t,new pt((r=>new Se("es",new Me(t,n),new pt((t=>new Se("ih",Bt(Bt(e,n),t),new pt((s=>Bt(Bt(e,new $e(n)),new Ge(r,t))))))))))))))}function Dt(t,e,n,r,s){const i=t.now(),a=e.now();if(i instanceof ke&&a instanceof _e)return r;if(i instanceof $e&&a instanceof Ge)return Bt(Bt(Bt(Bt(s,i.smaller),a.head),Ut(e)),Dt(i.smaller,a.tail,n,r,s));if(i instanceof De&&a instanceof De&&i.type.now()instanceof be&&a.type.now()instanceof Me){const o=a.type.now().entryType;return new De(Bt(Bt(n,t),e),new de(i.neutral,a.neutral,new Xt(new Se("k",new be,new pt((t=>new Se("es",new Me(o,t),new pt((t=>new Fe)))))),n),new Xt(Bt(Bt(n,new ke),new _e),r),new Xt(Ht(a.type.now().entryType,n),s)))}if(Vt(i,t)&&a instanceof De&&a.type.now()instanceof Me){const i=a.type.now().entryType;return new De(Bt(Bt(n,t),e),new ye(new Xt(new be,t),a.neutral,new Xt(new Se("k",new be,new pt((t=>new Se("es",new Me(i,t),new pt((t=>new Fe)))))),n),new Xt(Bt(Bt(n,new be),new _e),r),new Xt(Ht(i,n),s)))}throw new Error(`invalid input for indVec ${[t,e,n,r,s]}`)}function Ft(t,e,n,r){const s=e.now();if(s instanceof Ze){if(s.type!=t)throw new Error(`doEliminator: wrong eliminator used. Got constructor of type: ${s.type}; Expected: ${t}`);const e=s.index;if(e>=0&&e<r.length){let i=r[e];for(let t=0;t<s.args.length;t++){i=Bt(i,s.args[t])}for(let e=0;e<s.recursive_args.length;e++){i=Bt(i,Ft(t,s.recursive_args[e],n,r))}return i}}else if(s instanceof De){const i=s.type.now();if(i instanceof Ye&&i.name===t)return new De(Bt(n,e),new ge(t,s.neutral,new Xt(new Se("x",i,new pt((t=>new Fe))),n),r.map(((t,e)=>new Xt(i,t)))))}throw new Error(`doEliminator: invalid input for ${t}: ${[e,n,r]}`)}function Vt(t,e){const n=t.now(),r=e.now();return n instanceof ke&&r instanceof ke||n instanceof $e&&r instanceof $e&&Vt(n.smaller,r.smaller)}function Qt(t,e,n){const r=e.now(),s=n.now();if(r instanceof Fe)return n.readBackType(t);if(r instanceof be&&s instanceof ke)return new en;if(r instanceof be&&s instanceof $e)return new nn(Qt(t,new be,s.smaller));if(r instanceof Se){const e=yt(t,s instanceof Le?s.argName:r.argName);return new un(e,Qt(It(t,e,r.argType),r.resultType.valOfClosure(new De(r.argType,new Yt(e))),Bt(s,new De(r.argType,new Yt(e)))))}if(r instanceof Oe){const e=Mt(n),s=_t(n);return new wn(Qt(t,r.carType,e),Qt(t,r.cdrType.valOfClosure(e),s))}if(r instanceof Ve&&s instanceof xe)return new ln(s.name);if(r instanceof Qe)return new Nn;if(r instanceof Ie&&s instanceof Be)return new mn;if(r instanceof Ie&&s instanceof Ce)return new wn(Qt(t,r.entryType,s.head),Qt(t,new Ie(r.entryType),s.tail));if(r instanceof Ke&&s instanceof De)return new We(new Pn,s.neutral.readBackNeutral(t));if(r instanceof Re&&s instanceof qe)return new kn(Qt(t,r.type,s.value));if(r instanceof Me&&r.length.now()instanceof ke&&s instanceof _e)return new Cn;if(r instanceof Me&&r.length.now()instanceof $e&&s instanceof Ge)return r.length.now(),new Bn(Qt(t,r.entryType,s.head),Qt(t,new Me(r.entryType,r.length.now().smaller),s.tail));if(r instanceof ze&&s instanceof Ue)return new Gn(Qt(t,r.leftType,s.value));if(r instanceof ze&&s instanceof He)return new zn(Qt(t,r.rightType,s.value));if(s instanceof De)return s.neutral.readBackNeutral(t);throw new Error(`Cannot read back ${s.prettyPrint()} : ${r.prettyPrint()}`)}class Xt{type;value;constructor(t,e){this.type=t,this.value=e}}let Kt=class{constructor(){}toString(){return this.prettyPrint()}};class Yt extends Kt{name;constructor(t){super(),this.name=t}readBackNeutral(t){return new Fn(this.name)}prettyPrint(){return`N-${this.name}`}}let Zt=class extends Kt{where;type;constructor(t,e){super(),this.where=t,this.type=e}readBackNeutral(t){return new Hn(this.where,this.type.readBackType(t))}prettyPrint(){return"N-TODO"}},jt=class extends Kt{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new rn(this.target.readBackNeutral(t),new We(this.base.type.readBackType(t),Qt(t,this.base.type,this.base.value)),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-WhichNat"}},Wt=class extends Kt{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new sn(this.target.readBackNeutral(t),new We(this.base.type.readBackType(t),Qt(t,this.base.type,this.base.value)),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IterNat"}},Jt=class extends Kt{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new an(this.target.readBackNeutral(t),new We(this.base.type.readBackType(t),Qt(t,this.base.type,this.base.value)),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-RecNat"}},te=class extends Kt{target;motive;base;step;constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}readBackNeutral(t){return new on(this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.base.type,this.base.value),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndNat"}},ee=class extends Kt{target;constructor(t){super(),this.target=t}readBackNeutral(t){return new fn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Car"}},ne=class extends Kt{target;constructor(t){super(),this.target=t}readBackNeutral(t){return new yn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Cdr"}},re=class extends Kt{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new vn(this.target.readBackNeutral(t),new We(this.base.type.readBackType(t),Qt(t,this.base.type,this.base.value)),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-RecList"}},se=class extends Kt{target;motive;base;step;constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}readBackNeutral(t){return new En(this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.base.type,this.base.value),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndList"}},ie=class extends Kt{target;motive;constructor(t,e){super(),this.target=t,this.motive=e}readBackNeutral(t){return new xn(new We(new Pn,this.target.readBackNeutral(t)),Qt(t,this.motive.type,this.motive.value))}prettyPrint(){return"N-IndAbsurd"}},ae=class extends Kt{target;motive;base;constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}readBackNeutral(t){return new $n(this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.base.type,this.base.value))}prettyPrint(){return"N-Replace"}};class oe extends Kt{target1;target2;constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new Sn(this.target1.readBackNeutral(t),Qt(t,this.target2.type,this.target2.value))}prettyPrint(){return"N-Trans1"}}class ce extends Kt{target1;target2;constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new Sn(Qt(t,this.target1.type,this.target1.value),this.target2.readBackNeutral(t))}prettyPrint(){return"N-Trans2"}}class ue extends Kt{target1;target2;constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new Sn(this.target1.readBackNeutral(t),this.target2.readBackNeutral(t))}prettyPrint(){return"N-Trans12"}}let he=class extends Kt{target;func;constructor(t,e){super(),this.target=t,this.func=e}readBackNeutral(t){const e=this.func.type;if(e instanceof Se){const n=e.resultType;return new Ln(this.target.readBackNeutral(t),n.valOfClosure(new Ke).readBackType(t),Qt(t,this.func.type,this.func.value))}throw new Error("Cong applied to non-Pi type.")}prettyPrint(){return"N-Cong"}},le=class extends Kt{target;constructor(t){super(),this.target=t}readBackNeutral(t){return new On(this.target.readBackNeutral(t))}prettyPrint(){return"N-Symm"}},pe=class extends Kt{target;motive;base;constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}readBackNeutral(t){return new An(this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.base.type,this.base.value))}prettyPrint(){return"N-IndEqual"}},we=class extends Kt{target;constructor(t){super(),this.target=t}readBackNeutral(t){return new Rn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Head"}},fe=class extends Kt{target;constructor(t){super(),this.target=t}readBackNeutral(t){return new qn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Tail"}};class ye extends Kt{length;target;motive;base;step;constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}readBackNeutral(t){return new Mn(Qt(t,this.length.type,this.length.value),this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.base.type,this.base.value),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndVec2"}}class de extends Kt{length;target;motive;base;step;constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}readBackNeutral(t){return new Mn(this.length.readBackNeutral(t),this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.base.type,this.base.value),Qt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndVec12"}}let me=class extends Kt{target;motive;baseLeft;baseRight;constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.baseLeft=n,this.baseRight=r}readBackNeutral(t){return new Un(this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),Qt(t,this.baseLeft.type,this.baseLeft.value),Qt(t,this.baseRight.type,this.baseRight.value))}prettyPrint(){return"N-IndEither"}};class ge extends Kt{typeName;target;motive;methods;constructor(t,e,n,r){super(),this.typeName=t,this.target=e,this.motive=n,this.methods=r}readBackNeutral(t){return new Xn(this.typeName,this.target.readBackNeutral(t),Qt(t,this.motive.type,this.motive.value),this.methods.map((e=>Qt(t,e.type,e.value))))}prettyPrint(){return`N-GenericEliminator-${this.typeName}`}}let ve=class extends Kt{operator;operand;constructor(t,e){super(),this.operator=t,this.operand=e}readBackNeutral(t){return new Dn(this.operator.readBackNeutral(t),Qt(t,this.operand.type,this.operand.value))}prettyPrint(){return"N-Application"}};class Ee{now(){return this}}class Te{env;expr;constructor(t,e){this.env=t,this.expr=e}undelay(){return this.expr.valOf(this.env).now()}toString(){return`DelayClosure(${this.env}, ${this.expr})`}}class Ne{content;constructor(t){this.content=t}get(){return this.content}set(t){this.content=t}}class Pe extends Ee{val;constructor(t){super(),this.val=t}now(){const t=this.val.get();if(t instanceof Te){let e=t.undelay();return this.val.set(e),e}return t}readBackType(t){return this.now().readBackType(t)}prettyPrint(){return this.now().prettyPrint()}toString(){return`Delay(${this.val})`}}let xe=class extends Ee{name;constructor(t){super(),this.name=t}readBackType(t){throw new Error("No readBackType for Quote.")}prettyPrint(){return`'${this.name}`}toString(){return this.prettyPrint()}},be=class extends Ee{constructor(){super()}readBackType(t){return new tn}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}},ke=class extends Ee{constructor(){super()}readBackType(t){throw new Error("No readBackType for Zero.")}prettyPrint(){return"zero"}toString(){return this.prettyPrint()}},$e=class extends Ee{smaller;constructor(t){super(),this.smaller=t}readBackType(t){throw new Error("No readBackType for Add1.")}prettyPrint(){return`(add1 ${this.smaller.prettyPrint()})`}toString(){return this.prettyPrint()}},Se=class extends Ee{argName;argType;resultType;constructor(t,e,n){super(),this.argName=t,this.argType=e,this.resultType=n}readBackType(t){const e=this.argType.readBackType(t),n=yt(t,this.argName),r=It(t,n,this.argType);return new cn(n,e,this.resultType.valOfClosure(new De(this.argType,new Yt(n))).readBackType(r))}prettyPrint(){return`(Π ${this.argName} ${this.argType.prettyPrint()} ${this.resultType.prettyPrint()})`}toString(){return this.prettyPrint()}},Le=class extends Ee{argName;body;constructor(t,e){super(),this.argName=t,this.body=e}readBackType(t){throw new Error("No readBackType for Lambda.")}prettyPrint(){return`(lambda ${this.argName} ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},Oe=class extends Ee{carName;carType;cdrType;constructor(t,e,n){super(),this.carName=t,this.carType=e,this.cdrType=n}readBackType(t){const e=this.carType.readBackType(t),n=yt(t,this.carName),r=It(t,n,this.carType);return new pn(n,e,this.cdrType.valOfClosure(new De(this.carType,new Yt(n))).readBackType(r))}prettyPrint(){return`(Σ ${this.carName} ${this.carType.prettyPrint()} ${this.cdrType.prettyPrint()})`}toString(){return this.prettyPrint()}},Ae=class extends Ee{car;cdr;constructor(t,e){super(),this.car=t,this.cdr=e}readBackType(t){throw new Error("No readBackType for Cons.")}prettyPrint(){return`(cons ${this.car.prettyPrint()} ${this.cdr.prettyPrint()})`}toString(){return this.prettyPrint()}},Ie=class extends Ee{entryType;constructor(t){super(),this.entryType=t}readBackType(t){return new gn(this.entryType.readBackType(t))}prettyPrint(){return`(List ${this.entryType.prettyPrint()})`}toString(){return this.prettyPrint()}},Be=class extends Ee{constructor(){super()}readBackType(t){throw new Error("No readBackType for Nil.")}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}},Ce=class extends Ee{head;tail;constructor(t,e){super(),this.head=t,this.tail=e}readBackType(t){throw new Error("No readBackType for ListCons.")}prettyPrint(){return`(:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},Re=class extends Ee{type;from;to;constructor(t,e,n){super(),this.type=t,this.from=e,this.to=n}readBackType(t){return new bn(this.type.readBackType(t),Qt(t,this.type,this.from),Qt(t,this.type,this.to))}prettyPrint(){return`(= ${this.type.prettyPrint()} ${this.from.prettyPrint()} ${this.to.prettyPrint()})`}toString(){return this.prettyPrint()}},qe=class extends Ee{value;constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Same.")}prettyPrint(){return`(same ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Me=class extends Ee{entryType;length;constructor(t,e){super(),this.entryType=t,this.length=e}readBackType(t){return new In(this.entryType.readBackType(t),Qt(t,new be,this.length))}prettyPrint(){return`(Vec ${this.entryType.prettyPrint()} ${this.length.prettyPrint()})`}},_e=class extends Ee{constructor(){super()}readBackType(t){throw new Error("No readBackType for VecNil.")}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}},Ge=class extends Ee{head;tail;constructor(t,e){super(),this.head=t,this.tail=e}readBackType(t){throw new Error("No readBackType for VecCons.")}prettyPrint(){return`(vec:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},ze=class extends Ee{leftType;rightType;constructor(t,e){super(),this.leftType=t,this.rightType=e}readBackType(t){return new _n(this.leftType.readBackType(t),this.rightType.readBackType(t))}prettyPrint(){return`(Either ${this.leftType.prettyPrint()} ${this.rightType.prettyPrint()})`}toString(){return this.prettyPrint()}},Ue=class extends Ee{value;constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Left.")}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},He=class extends Ee{value;constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Right.")}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}};class De extends Ee{type;neutral;constructor(t,e){super(),this.type=t,this.neutral=e}readBackType(t){return this.neutral.readBackNeutral(t)}prettyPrint(){return`(Neutral ${this.type.prettyPrint()} ${this.neutral.prettyPrint()})`}toString(){return this.prettyPrint()}}let Fe=class extends Ee{constructor(){super()}readBackType(t){return new Je}prettyPrint(){return"U"}toString(){return this.prettyPrint()}},Ve=class extends Ee{constructor(){super()}readBackType(t){return new hn}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}},Qe=class extends Ee{constructor(){super()}readBackType(t){return new Tn}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}},Xe=class extends Ee{constructor(){super()}readBackType(t){throw new Error("No readBackType for Sole.")}prettyPrint(){return"sole"}toString(){return this.prettyPrint()}},Ke=class extends Ee{constructor(){super()}readBackType(t){return new Pn}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}},Ye=class extends Ee{name;parameters;indices;constructor(t,e,n){super(),this.name=t,this.parameters=e,this.indices=n}readBackType(t){return new Vn(this.name,this.parameters.map((e=>e.readBackType(t))),this.indices.map((e=>e.readBackType(t))))}prettyPrint(){return`InductiveType ${this.name}`}toString(){return this.prettyPrint()}},Ze=class extends Ee{name;type;args;index;recursive_args;constructor(t,e,n,r,s){super(),this.name=t,this.type=e,this.args=n,this.index=r,this.recursive_args=s}readBackType(t){throw new Error("No readBackType for Constructor.")}prettyPrint(){const t=this.args.map((t=>t.prettyPrint())).join(" ");return`(${this.name}${t.length>0?" "+t:""})`}toString(){return this.prettyPrint()}};class je{toLazy(t){return new Pe(new Ne(new Te(t,this)))}}let We=class extends je{type;expr;constructor(t,e){super(),this.type=t,this.expr=e}valOf(t){return this.expr.valOf(t)}prettyPrint(){return`(the ${this.type.prettyPrint()} ${this.expr.prettyPrint()})`}toString(){return this.prettyPrint()}},Je=class extends je{valOf(t){return new Fe}prettyPrint(){return"U"}toString(){return this.prettyPrint()}},tn=class extends je{valOf(t){return new be}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}},en=class extends je{valOf(t){return new ke}prettyPrint(){return"0"}toString(){return this.prettyPrint()}},nn=class extends je{n;constructor(t){super(),this.n=t}valOf(t){return new $e(this.n.toLazy(t))}prettyPrint(){return isNaN(Number(this.n.prettyPrint()))?`(add1 ${this.n.prettyPrint()})`:`${Number(this.n.prettyPrint())+1}`}toString(){return this.prettyPrint()}},rn=class extends je{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return function(t,e,n,r){const s=t.now();if(s instanceof ke)return n;if(s instanceof $e)return Bt(r,s.smaller);if(s instanceof De&&s.type.now()instanceof be)return new De(e,new jt(s.neutral,new Xt(e,n),new Xt(new Se("n",new be,new pt((t=>e))),r)));throw new Error(`invalid input for whichNat ${[t,e,n,r]}`)}(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(which-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},sn=class extends je{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return Ct(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(iter-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},an=class extends je{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return Rt(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(rec-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},on=class extends je{target;motive;base;step;constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}valOf(t){return qt(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(ind-Nat ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},cn=class extends je{name;type;body;constructor(t,e,n){super(),this.name=t,this.type=e,this.body=n}valOf(t){const e=this.type.toLazy(t);return new Se(this.name,e,new lt(t,this.name,this.body))}prettyPrint(){return`(Π (${this.name} ${this.type.prettyPrint()}) \n          ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},un=class extends je{param;body;constructor(t,e){super(),this.param=t,this.body=e}valOf(t){return new Le(this.param,new lt(t,this.param,this.body))}prettyPrint(){return`(λ (${this.param}) ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},hn=class extends je{valOf(t){return new Ve}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}},ln=class extends je{sym;constructor(t){super(),this.sym=t}valOf(t){return new xe(this.sym)}prettyPrint(){return`'${this.sym}`}toString(){return this.prettyPrint()}},pn=class extends je{name;type;body;constructor(t,e,n){super(),this.name=t,this.type=e,this.body=n}valOf(t){const e=this.type.toLazy(t);return new Oe(this.name,e,new lt(t,this.name,this.body))}prettyPrint(){return`(Σ (${this.name} ${this.type.prettyPrint()}) \n              ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},wn=class extends je{first;second;constructor(t,e){super(),this.first=t,this.second=e}valOf(t){const e=this.first.toLazy(t),n=this.second.toLazy(t);return new Ae(e,n)}prettyPrint(){return`(cons ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}},fn=class extends je{pair;constructor(t){super(),this.pair=t}valOf(t){return Mt(this.pair.toLazy(t))}prettyPrint(){return`(car ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}},yn=class extends je{pair;constructor(t){super(),this.pair=t}valOf(t){return _t(this.pair.toLazy(t))}prettyPrint(){return`(cdr ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}},dn=class extends je{head;tail;constructor(t,e){super(),this.head=t,this.tail=e}valOf(t){const e=this.head.toLazy(t),n=this.tail.toLazy(t);return new Ce(e,n)}prettyPrint(){return`(:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},mn=class extends je{valOf(t){return new Be}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}},gn=class extends je{elemType;constructor(t){super(),this.elemType=t}valOf(t){return new Ie(this.elemType.toLazy(t))}prettyPrint(){return`(List ${this.elemType.prettyPrint()})`}toString(){return this.prettyPrint()}},vn=class extends je{target;base;step;constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return zt(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(rec-List ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},En=class extends je{target;motive;base;step;constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}valOf(t){return Gt(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(ind-List ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Tn=class extends je{valOf(t){return new Qe}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}},Nn=class extends je{valOf(t){return new Xe}prettyPrint(){return"sole"}toString(){return this.prettyPrint()}},Pn=class extends je{valOf(t){return new Ke}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}},xn=class extends je{target;motive;constructor(t,e){super(),this.target=t,this.motive=e}valOf(t){return function(t,e){const n=t.now();if(n instanceof De&&n.type.now()instanceof Ke)return new De(e,new ie(n.neutral,new Xt(new Fe,e)));throw new Error(`invalid input for indAbsurd ${[t,e]}`)}(this.target.toLazy(t),this.motive.toLazy(t))}prettyPrint(){return`(ind-Absurd \n              ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()})`}toString(){return this.prettyPrint()}},bn=class extends je{type;left;right;constructor(t,e,n){super(),this.type=t,this.left=e,this.right=n}valOf(t){return new Re(this.type.toLazy(t),this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(= ${this.type.prettyPrint()} \n              ${this.left.prettyPrint()} \n              ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},kn=class extends je{type;constructor(t){super(),this.type=t}valOf(t){return new qe(this.type.toLazy(t))}prettyPrint(){return`(same ${this.type.prettyPrint()})`}toString(){return this.prettyPrint()}},$n=class extends je{target;motive;base;constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof qe)return n;if(r instanceof De){const t=r.type.now();if(t instanceof Re){const s=r.neutral,i=t.type,a=t.from,o=t.to;return new De(Bt(e,o),new ae(s,new Xt(new Se("x",i,new pt((t=>new Fe))),e),new Xt(Bt(e,a),n)))}}throw new Error(`invalid input for replace ${[t,e,n]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t))}prettyPrint(){return`(replace ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}},Sn=class extends je{left;right;constructor(t,e){super(),this.left=t,this.right=e}valOf(t){return function(t,e){const n=t.now(),r=e.now();if(n instanceof qe&&r instanceof qe)return new qe(n.value);if(n instanceof qe&&r instanceof De){const t=r.type.now();if(t instanceof Re){const e=n.value,s=t.to,i=t.type,a=r.neutral;return new De(new Re(i,e,s),new ce(new Xt(new Re(i,e,e),new qe(e)),a))}}else if(n instanceof De&&r instanceof qe){const t=n.type.now();if(t instanceof Re){const e=t.from,s=r.value,i=t.type,a=n.neutral;return new De(new Re(i,e,s),new oe(a,new Xt(new Re(i,s,s),new qe(s))))}}else if(n instanceof De&&r instanceof De){const t=n.type.now(),e=r.type.now();if(t instanceof Re&&e instanceof Re){const s=t.from,i=e.to,a=t.type,o=n.neutral,c=r.neutral;return new De(new Re(a,s,i),new ue(o,c))}}throw new Error(`invalid input for do-trans: ${[t,e]}`)}(this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(trans ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},Ln=class extends je{target;base;fun;constructor(t,e,n){super(),this.target=t,this.base=e,this.fun=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof qe)return new qe(Bt(n,r.value));if(r instanceof De){const t=r.type.now();if(t instanceof Re){const s=t.type,i=t.from,a=t.to,o=r.neutral;return new De(new Re(e,Bt(n,i),Bt(n,a)),new he(o,new Xt(new Se("x",s,new pt((t=>e))),n)))}}throw new Error(`invalid input for cong ${[t,e,n]}`)}(this.target.toLazy(t),this.base.toLazy(t),this.fun.toLazy(t))}prettyPrint(){return`(cong ${this.target.prettyPrint()} ${this.fun.prettyPrint()})`}toString(){return this.prettyPrint()}},On=class extends je{equality;constructor(t){super(),this.equality=t}valOf(t){return function(t){const e=t.now();if(e instanceof qe)return new qe(e.value);if(e instanceof De){const t=e.type.now();if(t instanceof Re)return new De(new Re(t.type,t.to,t.from),new le(e.neutral))}throw new Error(`invalid input for symm ${t}`)}(this.equality.toLazy(t))}prettyPrint(){return`(symm ${this.equality.prettyPrint()})`}toString(){return this.prettyPrint()}},An=class extends je{target;motive;base;constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof qe)return n;if(r instanceof De){const s=r.type.now();if(s instanceof Re){const i=s.type,a=s.from,o=s.to,c=r.neutral;return new De(Bt(Bt(e,o),t),new pe(c,new Xt(new Se("to",i,new pt((t=>new Se("p",new Re(i,a,t),new pt((t=>new Fe)))))),e),new Xt(Bt(Bt(e,a),new qe(a)),n)))}}throw new Error(`invalid input for indEqual ${[t,e,n]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t))}prettyPrint(){return`(ind-= ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}},In=class extends je{type;length;constructor(t,e){super(),this.type=t,this.length=e}valOf(t){return new Me(this.type.toLazy(t),this.length.toLazy(t))}prettyPrint(){return`(Vec ${this.type.prettyPrint()} ${this.length.prettyPrint()})`}toString(){return this.prettyPrint()}},Bn=class extends je{head;tail;constructor(t,e){super(),this.head=t,this.tail=e}valOf(t){return new Ge(this.head.toLazy(t),this.tail.toLazy(t))}prettyPrint(){return`(vec:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},Cn=class extends je{valOf(t){return new _e}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}},Rn=class extends je{vec;constructor(t){super(),this.vec=t}valOf(t){return function(t){const e=t.now();if(e instanceof Ge)return e.head;if(e instanceof De){const t=e.type.now();if(t instanceof Me&&t.length.now()instanceof $e)return new De(t.entryType,new we(e.neutral))}throw new Error(`invalid input for head ${t}`)}(this.vec.toLazy(t))}prettyPrint(){return`(head ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}},qn=class extends je{vec;constructor(t){super(),this.vec=t}valOf(t){return Ut(this.vec.toLazy(t))}prettyPrint(){return`(tail ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}},Mn=class extends je{length;target;motive;base;step;constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}valOf(t){return Dt(this.length.toLazy(t),this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`ind-Vec ${this.length.prettyPrint()}\n              ${this.target.prettyPrint()}\n              ${this.motive.prettyPrint()}\n              ${this.base.prettyPrint()}\n              ${this.step.prettyPrint()}`}toString(){return this.prettyPrint()}},_n=class extends je{left;right;constructor(t,e){super(),this.left=t,this.right=e}valOf(t){return new ze(this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(Either ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},Gn=class extends je{value;constructor(t){super(),this.value=t}valOf(t){return new Ue(this.value.toLazy(t))}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},zn=class extends je{value;constructor(t){super(),this.value=t}valOf(t){return new He(this.value.toLazy(t))}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Un=class extends je{target;motive;baseLeft;baseRight;constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.baseLeft=n,this.baseRight=r}valOf(t){return function(t,e,n,r){const s=t.now();if(s instanceof Ue)return Bt(n,s.value);if(s instanceof He)return Bt(r,s.value);if(s instanceof De){const i=s.type.now();if(i instanceof ze){const a=i.leftType,o=i.rightType,c=new Se("x",new ze(a,o),new pt((t=>new Fe)));return new De(Bt(e,t),new me(s.neutral,new Xt(c,e),new Xt(new Se("x",a,new pt((t=>Bt(e,new Ue(t))))),n),new Xt(new Se("x",o,new pt((t=>Bt(e,new He(t))))),r)))}}throw new Error(`invalid input for indEither: ${[t,e,n,r]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.baseLeft.toLazy(t),this.baseRight.toLazy(t))}prettyPrint(){return`(ind-Either ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.baseLeft.prettyPrint()} \n              ${this.baseRight.prettyPrint()})`}toString(){return this.prettyPrint()}},Hn=class extends je{loc;type;constructor(t,e){super(),this.loc=t,this.type=e}valOf(t){return new De(this.type.toLazy(t),new Zt(this.loc,this.type.toLazy(t)))}prettyPrint(){return`TODO ${this.type.prettyPrint()}`}toString(){return this.prettyPrint()}},Dn=class extends je{fun;arg;constructor(t,e){super(),this.fun=t,this.arg=e}valOf(t){return Bt(this.fun.toLazy(t),this.arg.toLazy(t))}prettyPrint(){return`(${this.fun.prettyPrint()} ${this.arg.prettyPrint()})`}toString(){return this.prettyPrint()}};class Fn extends je{name;constructor(t){super(),this.name=t}valOf(t){if(wt(this.name))return function(t,e){if(t.has(e))return t.get(e);throw new Error(`Variable ${e} not found in environment`)}(t,this.name);throw new Error("{this.name} is not a valid variable name")}prettyPrint(){return this.name}toString(){return this.prettyPrint()}}let Vn=class extends je{typeName;parameters;indices;valOf(t){return new Ye(this.typeName,this.parameters.map((e=>e.toLazy(t))),this.indices.map((e=>e.toLazy(t))))}constructor(t,e,n){super(),this.typeName=t,this.parameters=e,this.indices=n}prettyPrint(){return`${this.typeName}${this.parameters.length>0?" "+this.parameters.map((t=>t.prettyPrint())).join(" "):""}${this.indices.length>0?" "+this.indices.map((t=>t.prettyPrint())).join(" "):""}`}};class Qn extends je{name;index;type;args;recursive_args;constructor(t,e,n,r,s){super(),this.name=t,this.index=e,this.type=n,this.args=r,this.recursive_args=s}valOf(t){return new Ze(this.name,this.type,this.args.map((e=>e.toLazy(t))),this.index,this.recursive_args.map((e=>e.toLazy(t))))}prettyPrint(){const t=this.args.map((t=>t.prettyPrint())).join(" ");return`(${this.name}${t.length>0?" "+t:""})`}}class Xn extends je{typeName;target;motive;methods;constructor(t,e,n,r){super(),this.typeName=t,this.target=e,this.motive=n,this.methods=r}valOf(t){return Ft(this.typeName,this.target.toLazy(t),this.motive.toLazy(t),this.methods.map((e=>e.toLazy(t))))}prettyPrint(){const t=this.methods.map((t=>t.prettyPrint())).join(" ");return`(elim-${this.typeName} ${this.target.prettyPrint()} ${this.motive.prettyPrint()} ${t})`}}function Kn(t,e){return Wn(0,new Map,new Map,t,e)}const Yn=-1;function Zn(t,e,n){return t.set(e,n)}function jn(t,e){return e.has(t)?e.get(t):Yn}function Wn(t,e,n,r,s){if(r instanceof Fn&&s instanceof Fn){const t=r.name,i=s.name;if(wt(t)&&wt(i)){const r=jn(t,e),s=jn(i,n);return r!==Yn&&s!==Yn?r===s:r===Yn&&s===Yn&&t===i}return!1}return r instanceof ln&&s instanceof ln?r.sym===s.sym:r instanceof cn&&s instanceof cn||r instanceof pn&&s instanceof pn?Wn(t,e,n,r.type,s.type)&&Wn(t+1,Zn(e,r.name,t),Zn(n,s.name,t),r.body,s.body):r instanceof un&&s instanceof un?Wn(t+1,Zn(e,r.param,t),Zn(n,s.param,t),r.body,s.body):r instanceof We&&s instanceof We&&r.type instanceof Pn&&s.type instanceof Pn||(r instanceof Dn&&s instanceof Dn?Wn(t,e,n,r.fun,s.fun)&&Wn(t,e,n,r.arg,s.arg):r instanceof Je&&s instanceof Je||r instanceof tn&&s instanceof tn||r instanceof en&&s instanceof en||r instanceof hn&&s instanceof hn||r instanceof Pn&&s instanceof Pn||r instanceof Nn&&s instanceof Nn||r instanceof mn&&s instanceof mn||r instanceof Cn&&s instanceof Cn||r instanceof Tn&&s instanceof Tn||(r instanceof We&&s instanceof We?Wn(t,e,n,r.type,s.type)&&Wn(t,e,n,r.expr,s.expr):r instanceof gn&&s instanceof gn?Wn(t,e,n,r.elemType,s.elemType):r instanceof nn&&s instanceof nn?Wn(t,e,n,r.n,s.n):r instanceof rn&&s instanceof rn||r instanceof sn&&s instanceof sn||r instanceof an&&s instanceof an?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.base,s.base)&&Wn(t,e,n,r.step,s.step):r instanceof on&&s instanceof on?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive)&&Wn(t,e,n,r.base,s.base)&&Wn(t,e,n,r.step,s.step):r instanceof wn&&s instanceof wn?Wn(t,e,n,r.first,s.first)&&Wn(t,e,n,r.second,s.second):r instanceof fn&&s instanceof fn||r instanceof yn&&s instanceof yn?Wn(t,e,n,r.pair,s.pair):r instanceof dn&&s instanceof dn?Wn(t,e,n,r.head,s.head)&&Wn(t,e,n,r.tail,s.tail):r instanceof vn&&s instanceof vn?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.base,s.base)&&Wn(t,e,n,r.step,s.step):r instanceof En&&s instanceof En?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive)&&Wn(t,e,n,r.base,s.base)&&Wn(t,e,n,r.step,s.step):r instanceof xn&&s instanceof xn?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive):r instanceof bn&&s instanceof bn?Wn(t,e,n,r.type,s.type)&&Wn(t,e,n,r.left,s.left)&&Wn(t,e,n,r.right,s.right):r instanceof kn&&s instanceof kn?Wn(t,e,n,r.type,s.type):r instanceof $n&&s instanceof $n?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive)&&Wn(t,e,n,r.base,s.base):r instanceof Sn&&s instanceof Sn?Wn(t,e,n,r.left,s.left)&&Wn(t,e,n,r.right,s.right):r instanceof Ln&&s instanceof Ln?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.base,s.base)&&Wn(t,e,n,r.fun,s.fun):r instanceof On&&s instanceof On?Wn(t,e,n,r.equality,s.equality):r instanceof An&&s instanceof An?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive)&&Wn(t,e,n,r.base,s.base):r instanceof In&&s instanceof In?Wn(t,e,n,r.type,s.type)&&Wn(t,e,n,r.length,s.length):r instanceof Bn&&s instanceof Bn?Wn(t,e,n,r.head,s.head)&&Wn(t,e,n,r.tail,s.tail):r instanceof Rn&&s instanceof Rn||r instanceof qn&&s instanceof qn?Wn(t,e,n,r.vec,s.vec):r instanceof Mn&&s instanceof Mn?Wn(t,e,n,r.length,s.length)&&Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive)&&Wn(t,e,n,r.base,s.base)&&Wn(t,e,n,r.step,s.step):r instanceof _n&&s instanceof _n?Wn(t,e,n,r.left,s.left)&&Wn(t,e,n,r.right,s.right):r instanceof Gn&&s instanceof Gn||r instanceof zn&&s instanceof zn?Wn(t,e,n,r.value,s.value):r instanceof Un&&s instanceof Un?Wn(t,e,n,r.target,s.target)&&Wn(t,e,n,r.motive,s.motive)&&Wn(t,e,n,r.baseLeft,s.baseLeft)&&Wn(t,e,n,r.baseRight,s.baseRight):r instanceof Hn&&s instanceof Hn&&(function(t,e){return t.startLine===e.startLine&&t.startColumn===e.startColumn&&t.endLine===e.endLine&&t.endColumn===e.endColumn}(r.loc,s.loc)&&Wn(t,e,n,r.type,s.type))))}function Jn(t,e){t.forInfo}function tr(t,e){const n=t.get(e);return n||e}function er(t,e,n){return new Map([[e,n],...t])}function nr(t,e,n,r){const s=n.readBackType(t),i=r.readBackType(t);return Kn(s,i)?new at(void 0):new ot(e,new st([`Expected ${i} but got ${s}`]))}function rr(t,e,n,r,s){return Kn(Qt(t,n,r),Qt(t,n,s))?new at(void 0):new ot(e,new st([`The terms ${r.prettyPrint()} and ${s.prettyPrint()} are not the same ${n.prettyPrint()}.`]))}function sr(t){return ir(t.split(""))}function ir(t){return 0===t.length||(e=t[0],!(!/^[a-zA-Z]$/.test(e)&&"-"!==t[0])&&ir(t.slice(1)));var e}function ar(t,e,n){return new ss(t.location,t,e,n)}class or{static synthNat(t,e){return new at(new We(new Je,new tn))}static synthUniverse(t,e,n){return new ot(n,new st(["U is a type, but it does not have a type."]))}static synthArrow(t,e,n,r,s,i){if(0===i.length){const n=dt(t,s,"x"),i=new ct("Aout"),a=new ct("Bout");return ut([[i,()=>r.check(t,e,new Fe)],[a,()=>s.check(It(t,n,vt(t,i.value)),e,new Fe)]],(()=>new at(new We(new Je,new cn(n,i.value,a.value)))))}{const[a,...o]=i,c=dt(t,ar(s,a,o),"x"),u=new ct("Aout"),h=new ct("tout");return ut([[u,()=>r.check(t,e,new Fe)],[h,()=>new vr(Y(n),s,a,o).check(It(t,c,vt(t,u.value)),e,new Fe)]],(()=>new at(new We(new Je,new cn(c,u.value,h.value)))))}}static synthPi(t,e,n,r,s){if(1===r.length){const[n,i]=[r[0].binder,r[0].type],a=yt(t,n.varName),o=(n.location,new ct("Aout")),c=new ct("Bout");return ut([[o,()=>i.check(t,e,new Fe)],[c,()=>s.check(It(t,a,vt(t,o.value)),er(e,n.varName,a),new Fe)]],(()=>(o.value,new at(new We(new Je,new cn(a,o.value,c.value))))))}if(r.length>1){const[i,...a]=r,[o,c]=[i.binder,i.type],u=(o.location,o.varName),h=yt(t,u),l=new ct("Aout"),p=new ct("Bout");return ut([[l,()=>c.check(t,e,new Fe)],[p,()=>new Er(Y(n),a,s).check(It(t,h,vt(t,l.value)),er(e,u,h),new Fe)]],(()=>(l.value,new at(new We(new Je,new cn(h,l.value,p.value))))))}throw new Error("Invalid number of binders in Pi type")}static synthZero(t,e){return new at(new We(new tn,new en))}static synthAdd1(t,e,n){const r=new ct("nout");return ut([[r,()=>n.check(t,e,new be)]],(()=>new at(new We(new tn,new nn(r.value)))))}static synthWhichNat(t,e,n,r,s){const i=new ct("tgtout"),a=new ct("bout"),o=new ct("sout");let c=yt(t,"n_minus_1");return ut([[i,()=>n.check(t,e,new be)],[a,()=>r.synth(t,e)],[o,()=>s.check(t,e,new Se(c,new be,new lt(Pt(t),c,a.value.type)))]],(()=>new at(new We(a.value.type,new rn(i.value,new We(a.value.type,a.value.expr),o.value)))))}static synthIterNat(t,e,n,r,s){const i=new ct("tgtout"),a=new ct("bout"),o=new ct("sout");return ut([[i,()=>n.check(t,e,new be)],[a,()=>r.synth(t,e)],[o,()=>s.check(t,e,(()=>{const e=yt(t,"old");return vt(t,new cn(e,a.value.type,a.value.type))})())]],(()=>new at(new We(a.value.type,new sn(i.value,new We(a.value.type,a.value.expr),o.value)))))}static synthRecNat(t,e,n,r,s){const i=new ct("tgtout"),a=new ct("bout"),o=new ct("sout");return ut([[i,()=>n.check(t,e,new be)],[a,()=>r.synth(t,e)],[o,()=>s.check(t,e,(()=>{const e=yt(t,"n_minus_1"),n=yt(t,"old");return vt(t,new cn(e,new tn,new cn(n,a.value.type,a.value.type)))})())]],(()=>new at(new We(a.value.type,new an(i.value,new We(a.value.type,a.value.expr),o.value)))))}static synthIndNat(t,e,n,r,s,i){const a=new ct("tgtout"),o=new ct("motout"),c=new ct("motval"),u=new ct("bout"),h=new ct("sout");return ut([[a,()=>n.check(t,e,new be)],[o,()=>r.check(t,e,new Se("n",new be,new pt((t=>new Fe))))],[c,()=>new at(vt(t,o.value))],[u,()=>s.check(t,e,Bt(c.value,new ke))],[h,()=>i.check(t,e,new Se("n-1",new be,new pt((t=>new Se("x",Bt(c.value,t),new pt((e=>Bt(c.value,new $e(t)))))))))]],(()=>new at(new We(new Dn(o.value,a.value),new on(a.value,o.value,u.value,h.value)))))}static synthAtom(t,e){return new at(new We(new Je,new hn))}static synthPair(t,e,n,r){const s=yt(t,"a"),i=new ct("Aout"),a=new ct("Dout");return ut([[i,()=>n.check(t,e,new Fe)],[a,()=>r.check(It(t,s,vt(t,i.value)),e,new Fe)]],(()=>new at(new We(new Je,new pn(s,i.value,a.value)))))}static synthSigma(t,e,n,r,s){if(1===r.length){const[n,i]=[r[0].binder,r[0].type],a=yt(t,n.varName),o=(n.location,new ct("Aout")),c=new ct("Dout");return ut([[o,()=>i.check(t,e,new Fe)],[c,()=>s.check(It(t,a,vt(t,o.value)),er(e,n.varName,a),new Fe)]],(()=>(o.value,new at(new We(new Je,new pn(a,o.value,c.value))))))}if(r.length>1){const[i,...a]=r,[o,c]=[i.binder,i.type],u=(o.location,o.varName),h=yt(t,u),l=new ct("Aout"),p=new ct("Dout");return ut([[l,()=>c.check(t,e,new Fe)],[p,()=>new Nr(Y(n),a,s).check(It(t,h,vt(t,l.value)),er(e,u,h),new Fe)]],(()=>(l.value,new at(new We(new Je,new pn(h,l.value,p.value))))))}throw new Error("Invalid number of binders in Sigma type")}static synthCar(t,e,n,r){const s=new ct("p_rst");return ut([[s,()=>r.synth(t,e)]],(()=>{const e=vt(t,s.value.type);return e instanceof Oe?new at(new We(e.carType.readBackType(t),new fn(s.value.expr))):new ot(n,new st([`car requires a Pair type, but was used as a: ${e}.`]))}))}static synthCdr(t,e,n,r){const s=new ct("pout");return ut([[s,()=>r.synth(t,e)]],(()=>{const e=vt(t,s.value.type);if(e instanceof Oe){const[n,r,i]=[e.carName,e.carType,e.cdrType];return new at(new We(i.valOfClosure(Mt(vt(t,s.value.expr))).readBackType(t),new yn(s.value.expr)))}return new ot(n,new st([`cdr requires a Pair type, but was used as a: ${e}.`]))}))}static synthQuote(t,e,n,r){return sr(r)?new at(new We(new hn,new ln(r))):new ot(n,new st([`Invalid atom: ${r}. Atoms consist of letters and hyphens.`]))}static synthTrivial(t,e){return new at(new We(new Je,new Tn))}static synthSole(t,e){return new at(new We(new Tn,new Nn))}static synthIndList(t,e,n,r,s,i,a){const o=new ct("tgtout"),c=new ct("motout"),u=new ct("motval"),h=new ct("bout"),l=new ct("sout");return ut([[o,()=>r.synth(t,e)]],(()=>{const[r,p]=[o.value.type,o.value.expr],w=vt(t,r);if(w instanceof Ie){const n=w.entryType;return ut([[c,()=>s.check(t,e,new Se("xs",new Ie(n),new lt(Pt(t),"xs",new Je)))],[u,()=>new at(vt(t,c.value))],[h,()=>i.check(t,e,Bt(u.value,new Be))],[l,()=>a.check(t,e,new Se("e",n,new pt((t=>new Se("es",new Ie(n),new pt((e=>new Se("ih",Bt(u.value,e),new pt((n=>Bt(u.value,new Ce(t,e))))))))))))]],(()=>new at(new We(new Dn(c.value,p),new En(p,c.value,h.value,l.value)))))}return new ot(n,new st([`Not a List: ${w.readBackType(t)}.`]))}))}static synthRecList(t,e,n,r,s,i){const a=new ct("tgtout");return ut([[a,()=>r.synth(t,e)]],(()=>{const[r,o]=[a.value.type,a.value.expr],c=vt(t,r);if(c instanceof Ie){const n=c.entryType,r=new ct("bout"),a=new ct("btval"),u=new ct("sout");return ut([[r,()=>s.synth(t,e)],[a,()=>new at(vt(t,r.value.type))],[u,()=>i.check(t,e,new Se("e",n,new pt((t=>new Se("es",new Ie(n),new pt((t=>new Se("ih",a.value,new pt((t=>a.value))))))))))]],(()=>new at(new We(r.value.type,new vn(o,new We(r.value.type,r.value.expr),u.value)))))}return new ot(n,new st([`Not a List: ${c.readBackType(t)}.`]))}))}static synthList(t,e,n){const r=new ct("Eout");return ut([[r,()=>n.entryType.check(t,e,new Fe)]],(()=>new at(new We(new Je,new gn(r.value)))))}static synthListCons(t,e,n,r){const s=new ct("eout"),i=new ct("esout");return ut([[s,()=>n.synth(t,e)],[i,()=>r.check(t,e,vt(t,new gn(s.value.type)))]],(()=>new at(new We(new gn(s.value.type),new dn(s.value.expr,i.value)))))}static synthAbsurd(t,e,n){return new at(new We(new Je,new Pn))}static synthIndAbsurd(t,e,n){const r=new ct("tgtout"),s=new ct("motout");return ut([[r,()=>n.target.check(t,e,new Ke)],[s,()=>n.motive.check(t,e,new Fe)]],(()=>new at(new We(s.value,new xn(r.value,s.value)))))}static synthEqual(t,e,n,r,s){const i=new ct("Aout"),a=new ct("Av"),o=new ct("from_out"),c=new ct("to_out");return ut([[i,()=>n.check(t,e,new Fe)],[a,()=>new at(vt(t,i.value))],[o,()=>r.check(t,e,a.value)],[c,()=>s.check(t,e,a.value)]],(()=>new at(new We(new Je,new bn(i.value,o.value,c.value)))))}static synthReplace(t,e,n,r,s,i){const a=new ct("tgt_rst"),o=new ct("motout"),c=new ct("bout");return ut([[a,()=>r.synth(t,e)]],(()=>{const r=vt(t,a.value.type);if(r instanceof Re){const[n,u,h]=[r.type,r.from,r.to];return ut([[o,()=>s.check(t,e,new Se("x",n,new pt((t=>new Fe))))],[c,()=>i.check(t,e,Bt(vt(t,o.value),u))]],(()=>new at(new We(Bt(vt(t,o.value),h).readBackType(t),new $n(a.value.expr,o.value,c.value)))))}return new ot(n,new st([`Expected an expression with = type, but the type was: ${a.value.type}.`]))}))}static synthTrans(t,e,n,r,s){const i=new ct("p1_rst"),a=new ct("p2_rst");return ut([[i,()=>r.synth(t,e)],[a,()=>s.synth(t,e)]],(()=>{const e=vt(t,i.value.type),r=vt(t,a.value.type);if(e instanceof Re&&r instanceof Re){const[s,o,c]=[e.type,e.from,e.to],[u,h,l]=[r.type,r.from,r.to];return ut([[new ct("_"),()=>nr(t,n,s,u)],[new ct("_"),()=>rr(t,n,s,c,h)]],(()=>new at(new We(new Re(s,o,l).readBackType(t),new Sn(i.value.expr,a.value.expr)))))}return new ot(n,new st([`Expected =, got ${e} and ${r}.`]))}))}static synthCong(t,e,n,r,s){const i=new ct("bout"),a=new ct("f_rst");return ut([[i,()=>r.synth(t,e)],[a,()=>s.synth(t,e)]],(()=>{const e=vt(t,i.value.type),r=vt(t,a.value.type);if(e instanceof Re){const[s,o,c]=[e.type,e.from,e.to];if(r instanceof Se){const[e,u,h]=[r.argName,r.argType,r.resultType],l=new ct("ph"),p=new ct("Cv"),w=new ct("fv");return ut([[l,()=>nr(t,n,s,u)],[p,()=>new at(h.valOfClosure(o))],[w,()=>new at(vt(t,a.value.expr))]],(()=>new at(new We(new bn(p.value.readBackType(t),Qt(t,p.value,Bt(w.value,o)),Qt(t,p.value,Bt(w.value,c))),new Ln(i.value.expr,p.value.readBackType(t),a.value.expr)))))}return new ot(n,new st([`Expected a function type, got ${r.readBackType(t)}.`]))}return new ot(n,new st([`Expected an = type, got ${e.readBackType(t)}.`]))}))}static synthSymm(t,e,n,r){const s=new ct("eout");return ut([[s,()=>r.synth(t,e)]],(()=>{const e=vt(t,s.value.type);if(e instanceof Re){const[n,r,i]=[e.type,e.from,e.to];return new at(new We(new Re(n,i,r).readBackType(t),new On(s.value.expr)))}return new ot(n,new st([`Expected an = type, got ${e.readBackType(t)}.`]))}))}static synthIndEqual(t,e,n,r,s,i){const a=new ct("tgtout"),o=new ct("motout"),c=new ct("motv"),u=new ct("baseout");return ut([[a,()=>r.synth(t,e)]],(()=>{const r=vt(t,a.value.type);if(r instanceof Re){const[n,h,l]=[r.type,r.from,r.to];return ut([[o,()=>s.check(t,e,new Se("to",n,new pt((t=>new Se("p",new Re(n,h,t),new pt((t=>new Fe)))))))],[c,()=>new at(vt(t,o.value))],[u,()=>i.check(t,e,Bt(Bt(c.value,h),new qe(h)))]],(()=>new at(new We(Bt(Bt(c.value,l),vt(t,a.value.expr)).readBackType(t),new An(a.value.expr,o.value,u.value)))))}return new ot(n,new st([`Expected evidence of equality, got ${r.readBackType(t)}.`]))}))}static synthVec(t,e,n,r){const s=new ct("tout"),i=new ct("lenout");return ut([[s,()=>n.check(t,e,new Fe)],[i,()=>r.check(t,e,new be)]],(()=>new at(new We(new Je,new In(s.value,i.value)))))}static synthHead(t,e,n,r){const s=new ct("vout");return ut([[s,()=>r.synth(t,e)]],(()=>{const e=vt(t,s.value.type).now();if(e instanceof Me){const[r,i]=[e.entryType,e.length];return i.now()instanceof $e?new at(new We(r.readBackType(t),new Rn(s.value.expr))):new ot(n,new st([`Expected a Vec with add1 at the top of the length, got ${Qt(t,new be,i)}.`]))}return new ot(n,new st([`Expected a Vec, got ${e.readBackType(t)}.`]))}))}static synthTail(t,e,n,r){const s=new ct("vout");return ut([[s,()=>r.synth(t,e)]],(()=>{const e=vt(t,s.value.type).now();if(e instanceof Me){const[r,i]=[e.entryType,e.length],a=i.now();if(a instanceof $e){const e=a.smaller;return new at(new We(new In(r.readBackType(t),Qt(t,new be,e)),new qn(s.value.expr)))}return new ot(n,new st([`Expected a Vec with add1 at the top of the length, got ${Qt(t,new be,i)}.`]))}return new ot(n,new st([`Expected a Vec, got ${e.readBackType(t)}.`]))}))}static synthIndVec(t,e,n,r,s,i,a,o){const c=new ct("lenout"),u=new ct("lenv"),h=new ct("vecout"),l=new ct("motout"),p=new ct("motval"),w=new ct("bout"),f=new ct("sout");return ut([[c,()=>r.check(t,e,new be)],[u,()=>new at(vt(t,c.value))],[h,()=>s.synth(t,e)]],(()=>{const r=vt(t,h.value.type);if(r instanceof Me){const[s,y]=[r.entryType,r.length];return ut([[new ct("_"),()=>rr(t,n,new be,u.value,y)],[l,()=>i.check(t,e,new Se("k",new be,new pt((t=>new Se("es",new Me(s,t),new pt((t=>new Fe)))))))],[p,()=>new at(vt(t,l.value))],[w,()=>a.check(t,e,Bt(Bt(p.value,new ke),new _e))],[f,()=>o.check(t,e,Ht(s,p.value))]],(()=>new at(new We(new Dn(new Dn(l.value,c.value),h.value.expr),new Mn(c.value,h.value.expr,l.value,w.value,f.value)))))}return new ot(n,new st([`Expected a Vec, got ${r.readBackType(t)}.`]))}))}static synthEither(t,e,n,r){const s=new ct("Lout"),i=new ct("Rout");return ut([[s,()=>n.check(t,e,new Fe)],[i,()=>r.check(t,e,new Fe)]],(()=>new at(new We(new Je,new _n(s.value,i.value)))))}static synthIndEither(t,e,n,r,s,i,a){const o=new ct("tgtout"),c=new ct("motout"),u=new ct("motval"),h=new ct("lout"),l=new ct("rout");return ut([[o,()=>r.synth(t,e)]],(()=>{const r=vt(t,o.value.type);if(r instanceof ze){const[n,p]=[r.leftType,r.rightType];return ut([[c,()=>s.check(t,e,new Se("x",new ze(n,p),new pt((t=>new Fe))))],[u,()=>new at(vt(t,c.value))],[h,()=>i.check(t,e,new Se("x",n,new pt((t=>Bt(u.value,new Ue(t))))))],[l,()=>a.check(t,e,new Se("x",p,new pt((t=>Bt(u.value,new He(t))))))]],(()=>new at(new We(new Dn(c.value,o.value.expr),new Un(o.value.expr,c.value,h.value,l.value)))))}return new ot(n,new st([`Expected an Either, but got a ${r.readBackType(t)}.`]))}))}static synthThe(t,e,n,r){const s=new ct("t_out"),i=new ct("e_out");return ut([[s,()=>n.isType(t,e)],[i,()=>r.check(t,e,vt(t,s.value))]],(()=>new at(new We(s.value,i.value))))}static synthApplication(t,e,n,r,s,i){if(0===i.length){const i=new ct("fout");return ut([[i,()=>r.synth(t,e)]],(()=>{const r=vt(t,i.value.type);if(r instanceof Se){const[n,a,o]=[r.argName,r.argType,r.resultType],c=new ct("argout");return ut([[c,()=>s.check(t,e,a)]],(()=>new at(new We(o.valOfClosure(vt(t,c.value)).readBackType(t),new Dn(i.value.expr,c.value)))))}return new ot(n,new st([`Not a function type: ${r.readBackType(t)}.`]))}))}{const a=new ct("appout");return ut([[a,()=>new ss(Y(n),r,s,i.slice(0,i.length-1)).synth(t,e)]],(()=>{const r=vt(t,a.value.type);if(r instanceof Se){const[n,s,o]=[r.argName,r.argType,r.resultType],c=new ct("fout");return ut([[c,()=>i[i.length-1].check(t,e,s)]],(()=>new at(new We(o.valOfClosure(vt(t,c.value)).readBackType(t),new Dn(a.value.expr,c.value)))))}return new ot(n,new st([`Not a function type: ${r.readBackType(t)}.`]))}))}}static synthName(t,e,n,r){const s=tr(e,r),i=new ct("x_tv");return ut([[i,()=>At(t,0,s)]],(()=>(t.get(s),new at(new We(i.value.readBackType(t),new Fn(s))))))}static synthNumber(t,e,n,r){if(0===r)return new at(new We(new tn,new en));if(r>0){const s=new ct("n_1_out");return ut([[s,()=>new Br(n,r-1).check(t,e,new be)]],(()=>new at(new We(new tn,new nn(s.value)))))}return new ot(n,new st([`Expected a positive number, got ${r}.`]))}static synthConstructorApplication(t,e,n){const r=t.get(n.constructorName);if(!(r&&r instanceof Ot))throw new Error(`Unknown constructor: ${n.constructorName}`);const s=r.type,i=s.argTypes.concat(s.rec_argTypes);let a=t,o=e;if(i.length!==n.args.length)return new ot(n.location,new st([`Expected ${i.length} arguments, got ${n.args.length}`]));const c=[];for(let e=0;e<n.args.length;e++){const r=n.args[e].check(a,o,vt(t,i[e]));if(r instanceof ot)return r;c.push(r.result)}let u=t;s.argTypes.concat(s.rec_argTypes);for(let t=0;t<c.length;t++){u=It(u,yt(u,`arg${t}`),vt(u,c[t]))}const h=vt(u,s.resultType);return new at(new We(h.readBackType(t),new Qn(n.constructorName,s.index,s.type,c.slice(0,s.argTypes.length),c.slice(s.argTypes.length))))}static synthGeneralEliminator(t,e,n){const r=function(t,e,n){for(const[e,r]of t)if(r instanceof Lt&&e===n)return new at(r);return new ot(e,new st([`No inductive type found for ${n} at ${e}`]))}(t,n.location,n.typeName);if(r instanceof ot)return r;const s=r.result.type,i=n.target.synth(t,e);if(i instanceof ot)return i;const a=i.result,o=vt(t,a.type);if(!(o instanceof Ye)||o.name!==n.typeName)return new ot(n.location,new st([`Expected type ${n.typeName}, got ${o.readBackType(t)}`]));let c=s.indexTypes;const u=(e,n)=>{if(e>=c.length)return new Se("target",new Ye(o.name,o.parameters,n),new pt((t=>new Fe)));const r=c[e];return new Se(yt(t,"idx"),r,new pt((t=>u(e+1,[...n,t]))))},h=u(0,[]),l=n.motive.check(t,e,h);if(l instanceof ot)return l;const p=l.result,w=vt(t,p),f=this.getConstructorTypesForDatatype(t,n.typeName);if(n.methods.length!==f.length)return new ot(n.location,new st([`Expected ${f.length} methods, got ${n.methods.length}`]));const y=[];for(let r=0;r<n.methods.length;r++){const s=this.generateMethodTypeForConstructor(t,f[r],w),i=n.methods[r].check(t,e,s);if(i instanceof ot)return i;y.push(i.result)}const d=Bt(w,vt(t,a.expr)),m=new Xn(n.typeName,a.expr,p,y);return new at(new We(d.readBackType(t),m))}static getConstructorTypesForDatatype(t,e){const n=[];for(const[r,s]of t)if(s instanceof Ot){s.type.type===e&&n.push(s.type)}return n.sort(((t,e)=>t.index-e.index))}static generateMethodTypeForConstructor(t,e,n){const r=[...e.argTypes.map((e=>vt(t,e))),...e.rec_argTypes.map((e=>vt(t,e)))],s=(i,a)=>{if(i>=r.length){let s;const i=new Ze(e.name,e.type,a,e.index,[]),o=cr(vt(t,e.resultType));s=n;for(let t=o.length-1;t>=0;t--)s=Bt(s,o[t]);s=Bt(s,i);const c=e.argTypes.length;for(let t=e.rec_argTypes.length-1;t>=0;t--){const e=c+t,i=a[e],o=cr(r[e]);let u=n;for(const t of o)u=Bt(u,t);u=Bt(u,i);const h=s;s=new Se(`ih${t}`,u,new pt((t=>h)))}return s}return new Se(`arg${i}`,r[i],new pt((t=>s(i+1,[...a,t]))))};return s(0,[])}}function cr(t){return t instanceof Ye?t.indices:[]}class ur{location;constructor(t){this.location=t}isType(t,e){const n=new ct("ok"),r=this.getType(t,e);return ut([[n,()=>r]],(()=>(Jn(this.location,n.value),new at(n.value))))}getType(t,e){const n=this.check(t,e,new Fe);if(n instanceof at)return n;if(n instanceof ot){if(this instanceof Pr&&wt(this.name)){const e=new ct("other-tv");return new ut([[e,()=>At(t,this.location,this.name)]],(()=>{new ot(this.location,new st([`Expected U, but given ${e.value.readBackType(t)}`]))}))}return new ot(this.location,new st(["not a type"]))}throw new Error("Invalid checkType")}check(t,e,n){const r=new ct("ok"),s=this.checkOut(t,e,n);return ut([[r,()=>s]],(()=>new at(r.value)))}synth(t,e){const n=new ct("ok");return ut([[n,()=>this.synthHelper(t,e)]],(()=>(Jn(this.location,n.value.type),new at(n.value))))}checkOut(t,e,n){const r=new ct("theT");return ut([[r,()=>this.synth(t,e)],[new ct("_"),()=>nr(t,this.location,vt(t,r.value.type),n)]],(()=>new at(r.value.expr)))}}class hr extends ur{location;type;value;constructor(t,e,n){super(t),this.location=t,this.type=e,this.value=n}synthHelper(t,e){return or.synthThe(t,e,this.type,this.value)}findNames(){return this.type.findNames().concat(this.value.findNames())}prettyPrint(){return`(the ${this.type.prettyPrint()} ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class lr extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthUniverse(t,e,this.location)}findNames(){return[]}getType(t,e){return new at(new Je)}prettyPrint(){return"U"}toString(){return this.prettyPrint()}}class pr extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthNat(t,e)}findNames(){return[]}getType(t,e){return new at(new tn)}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}}class wr extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthZero(t,e)}findNames(){return[]}prettyPrint(){return"zero"}toString(){return this.prettyPrint()}}class fr extends ur{location;base;constructor(t,e){super(t),this.location=t,this.base=e}synthHelper(t,e){return or.synthAdd1(t,e,this.base)}findNames(){return this.base.findNames()}prettyPrint(){return`(add1 ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class yr extends ur{location;target;base;step;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return or.synthWhichNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(which-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class dr extends ur{location;target;base;step;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return or.synthIterNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(iter-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class mr extends ur{location;target;base;step;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return or.synthRecNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(rec-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class gr extends ur{location;target;motive;base;step;constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.base=r,this.step=s}synthHelper(t,e){return or.synthIndNat(t,e,this.target,this.motive,this.base,this.step)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(ind-nat ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class vr extends ur{location;arg1;arg2;args;constructor(t,e,n,r){super(t),this.location=t,this.arg1=e,this.arg2=n,this.args=r}synthHelper(t,e){return or.synthArrow(t,e,this.location,this.arg1,this.arg2,this.args)}findNames(){return this.arg1.findNames().concat(this.arg2.findNames()).concat(this.args.flatMap((t=>t.findNames())))}getType(t,e){const[n,r,s]=[this.arg1,this.arg2,this.args];if(0===s.length){const s=dt(t,r,"x"),i=new ct("Aout"),a=new ct("Bout");return ut([[i,()=>n.isType(t,e)],[a,()=>r.isType(It(t,s,vt(t,i.value)),e)]],(()=>new at(new cn(s,i.value,a.value))))}{const[i,...a]=s,o=dt(t,ar(r,i,a),"x"),c=new ct("Aout"),u=new ct("tout");return ut([[c,()=>n.isType(t,e)],[u,()=>new vr(Y(this.location),r,i,a).isType(It(t,o,vt(t,c.value)),e)]],(()=>new at(new cn(o,c.value,u.value))))}}prettyPrint(){return`(-> ${this.arg1.prettyPrint()} ${this.arg2.prettyPrint()} ${this.args.map((t=>t.prettyPrint())).join(" ")})`}toString(){return this.prettyPrint()}}class Er extends ur{location;binders;body;constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){return or.synthPi(t,e,this.location,this.binders,this.body)}findNames(){return this.binders.flatMap((t=>mt(t))).concat(this.body.findNames())}getType(t,e){const[n,r]=[this.binders,this.body];if(1===n.length){const[s,i]=[n[0].binder,n[0].type],a=yt(t,s.varName),o=(s.location,new ct("Aout")),c=new ct("Aoutv"),u=new ct("Bout");return ut([[o,()=>i.isType(t,e)],[c,()=>new at(vt(t,o.value))],[u,()=>r.isType(It(t,a,c.value),er(e,s.varName,a))]],(()=>(o.value,new at(new cn(a,o.value,u.value)))))}if(n.length>1){const[s,...i]=n,[a,o]=[s.binder.varName,s.type],c=yt(t,a),u=(s.binder.location,new ct("Aout")),h=new ct("Aoutv"),l=new ct("Bout");return ut([[u,()=>o.isType(t,e)],[h,()=>new at(vt(t,u.value))],[l,()=>new Er(Y(this.location),i,r).isType(It(t,c,h.value),er(e,s.binder.varName,c))]],(()=>(u.value,new at(new cn(c,u.value,l.value)))))}throw new Error("Invalid number of binders in Pi type")}prettyPrint(){return`(Π ${this.binders.map((t=>`(${t.binder.varName} ${t.type.prettyPrint()})`)).join(" ")} \n            ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Tr extends ur{location;binders;body;constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.binders.map((t=>t.varName)).concat(this.body.findNames())}checkOut(t,e,n){if(1===this.binders.length){const r=this.body,s=this.binders[0],i=s.varName,a=s.location,o=n.now();if(o instanceof Se){const n=o.argType,s=o.resultType,a=tr(e,i),c=new ct("bout");return ut([[c,()=>r.check(It(t,a,n),er(e,i,a),s.valOfClosure(new De(n,new Yt(a))))]],(()=>(n.readBackType(t),new at(new un(a,c.value)))))}return new ot(a,new st([`Not a function type: ${o.readBackType(t)}.`]))}return new Tr(this.location,[this.binders[0]],new Tr(Y(this.location),this.binders.slice(1),this.body)).check(t,e,n)}prettyPrint(){return`(lambda ${this.binders.map((t=>t.varName)).join(" ")} ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Nr extends ur{location;binders;body;constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){return or.synthSigma(t,e,this.location,this.binders,this.body)}findNames(){return this.binders.flatMap((t=>mt(t))).concat(this.body.findNames())}getType(t,e){const[n,r]=[this.binders,this.body];if(1===n.length){const[s,i]=[n[0].binder,n[0].type],a=s.varName,o=yt(t,a),c=(s.location,new ct("Aout")),u=new ct("Aoutv"),h=new ct("Dout");return ut([[c,()=>i.isType(t,e)],[u,()=>new at(vt(t,c.value))],[h,()=>r.isType(It(t,o,u.value),er(e,a,o))]],(()=>(c.value,new at(new pn(o,c.value,h.value)))))}if(n.length>1){const[[s,i],...a]=[[n[0].binder,n[0].type],n[1],...n.slice(2)],o=s.varName,c=yt(t,o),u=(s.location,new ct("Aout")),h=new ct("Aoutv"),l=new ct("Dout");return ut([[u,()=>i.isType(t,e)],[h,()=>new at(vt(t,u.value))],[l,()=>new Nr(this.location,a,r).isType(It(t,o,h.value),er(e,o,c))]],(()=>(u.value,new at(new pn(c,u.value,l.value)))))}throw new Error("Invalid number of binders in Sigma type")}prettyPrint(){return`(Σ ${this.binders.map((t=>`(${t.binder.varName} ${t.type.prettyPrint()})`)).join(" ")} \n            ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Pr extends ur{location;name;constructor(t,e){super(t),this.location=t,this.name=e}synthHelper(t,e){return or.synthName(t,e,this.location,this.name)}findNames(){return[this.name]}prettyPrint(){return this.name}toString(){return this.prettyPrint()}}class xr extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthAtom(t,e)}findNames(){return[]}getType(t,e){return new at(new hn)}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}}class br extends ur{location;name;constructor(t,e){super(t),this.location=t,this.name=e}synthHelper(t,e){return or.synthQuote(t,e,this.location,this.name)}findNames(){return[]}prettyPrint(){return`'${this.name}`}toString(){return this.prettyPrint()}}class kr extends ur{location;first;second;constructor(t,e,n){super(t),this.location=t,this.first=e,this.second=n}synthHelper(t,e){return or.synthPair(t,e,this.first,this.second)}findNames(){return this.first.findNames().concat(this.second.findNames())}getType(t,e){const n=new ct("Aout"),r=new ct("Dout"),s=dt(t,this.second,"x");return ut([[n,()=>this.first.isType(t,e)],[r,()=>this.second.isType(It(t,s,vt(t,n.value)),e)]],(()=>new at(new pn(s,n.value,r.value))))}prettyPrint(){return`(Pair ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}}class $r extends ur{location;first;second;constructor(t,e,n){super(t),this.location=t,this.first=e,this.second=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.first.findNames().concat(this.second.findNames())}checkOut(t,e,n){const r=n.now();if(r instanceof Oe){const n=r.carType,s=r.cdrType,i=new ct("aout"),a=new ct("dout");return ut([[i,()=>this.first.check(t,e,n)],[a,()=>this.second.check(t,e,s.valOfClosure(vt(t,i.value)))]],(()=>new at(new wn(i.value,a.value))))}return new ot(this.location,new st([`cons requires a Pair or Σ type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(cons ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}}class Sr extends ur{location;pair;constructor(t,e){super(t),this.location=t,this.pair=e}synthHelper(t,e){return or.synthCar(t,e,this.location,this.pair)}findNames(){return this.pair.findNames()}prettyPrint(){return`(car ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}}class Lr extends ur{location;pair;constructor(t,e){super(t),this.location=t,this.pair=e}synthHelper(t,e){return or.synthCdr(t,e,this.location,this.pair)}findNames(){return this.pair.findNames()}prettyPrint(){return`(cdr ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}}class Or extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthTrivial(t,e)}findNames(){return[]}getType(t,e){return new at(new Tn)}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}}class Ar extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthSole(t,e)}findNames(){return[]}prettyPrint(){return"Sole"}}class Ir extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.now();return r instanceof Ie?new at(new mn):new ot(this.location,new st([`nil requires a List type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}}let Br=class extends ur{location;value;constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){return or.synthNumber(t,e,this.location,this.value)}findNames(){return[]}prettyPrint(){return`${this.value}`}toString(){return this.prettyPrint()}};class Cr extends ur{location;entryType;constructor(t,e){super(t),this.location=t,this.entryType=e}synthHelper(t,e){return or.synthList(t,e,this)}findNames(){return this.entryType.findNames()}getType(t,e){const n=new ct("Eout");return ut([[n,()=>this.entryType.isType(t,e)]],(()=>new at(new gn(n.value))))}prettyPrint(){return`(List ${this.entryType.prettyPrint()})`}toString(){return this.prettyPrint()}}class Rr extends ur{location;x;xs;constructor(t,e,n){super(t),this.location=t,this.x=e,this.xs=n}synthHelper(t,e){return or.synthListCons(t,e,this.x,this.xs)}findNames(){return this.x.findNames().concat(this.xs.findNames())}prettyPrint(){return`(:: ${this.x.prettyPrint()} ${this.xs.prettyPrint()})`}toString(){return this.prettyPrint()}}class qr extends ur{location;target;base;step;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return or.synthRecList(t,e,this.location,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(rec-list ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Mr extends ur{location;target;motive;base;step;constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.base=r,this.step=s}synthHelper(t,e){return or.synthIndList(t,e,this.location,this.target,this.motive,this.base,this.step)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(ind-list ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class _r extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){return or.synthAbsurd(t,e,this)}findNames(){return[]}getType(t,e){return new at(new Pn)}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}}class Gr extends ur{location;target;motive;constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}synthHelper(t,e){return or.synthIndAbsurd(t,e,this)}findNames(){return this.target.findNames().concat(this.motive.findNames())}prettyPrint(){return`(ind-Absurd \n              ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()})`}toString(){return this.prettyPrint()}}class zr extends ur{location;type;left;right;constructor(t,e,n,r){super(t),this.location=t,this.type=e,this.left=n,this.right=r}synthHelper(t,e){return or.synthEqual(t,e,this.type,this.left,this.right)}findNames(){return this.type.findNames().concat(this.left.findNames()).concat(this.right.findNames())}getType(t,e){const[n,r,s]=[this.type,this.left,this.right],i=new ct("Aout"),a=new ct("Av"),o=new ct("from_out"),c=new ct("to_out");return ut([[i,()=>n.isType(t,e)],[a,()=>new at(vt(t,i.value))],[o,()=>r.check(t,e,a.value)],[c,()=>s.check(t,e,a.value)]],(()=>new at(new bn(i.value,o.value,c.value))))}prettyPrint(){return`(= ${this.type.prettyPrint()} \n              ${this.left.prettyPrint()} \n              ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class Ur extends ur{location;type;constructor(t,e){super(t),this.location=t,this.type=e}findNames(){return this.type.findNames()}synthHelper(t,e){throw new Error("Method not implemented.")}checkOut(t,e,n){const r=n.now();if(r instanceof Re){const n=r.type,s=r.from,i=r.to,a=new ct("cout"),o=new ct("val");return ut([[a,()=>this.type.check(t,e,n)],[o,()=>new at(vt(t,a.value))],[new ct("_"),()=>rr(t,this.type.location,n,s,o.value)],[new ct("_"),()=>rr(t,this.type.location,n,i,o.value)]],(()=>new at(new kn(a.value))))}return new ot(this.location,new st([`same requires an Equal type, but encounter: ${r.readBackType(t)}.`]))}prettyPrint(){return`(same ${this.type.prettyPrint()})`}toString(){return this.prettyPrint()}}class Hr extends ur{location;target;motive;base;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.base=r}synthHelper(t,e){return or.synthReplace(t,e,this.location,this.target,this.motive,this.base)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames())}prettyPrint(){return`(replace ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class Dr extends ur{location;left;right;synthHelper(t,e){return or.synthTrans(t,e,this.location,this.left,this.right)}constructor(t,e,n){super(t),this.location=t,this.left=e,this.right=n}findNames(){return this.left.findNames().concat(this.right.findNames())}prettyPrint(){return`(trans ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class Fr extends ur{location;target;fun;constructor(t,e,n){super(t),this.location=t,this.target=e,this.fun=n}synthHelper(t,e){return or.synthCong(t,e,this.location,this.target,this.fun)}findNames(){return this.target.findNames().concat(this.fun.findNames())}prettyPrint(){return`(cong ${this.target.prettyPrint()} ${this.fun.prettyPrint()})`}toString(){return this.prettyPrint()}}class Vr extends ur{location;equality;constructor(t,e){super(t),this.location=t,this.equality=e}synthHelper(t,e){return or.synthSymm(t,e,this.location,this.equality)}findNames(){return this.equality.findNames()}prettyPrint(){return`(symm ${this.equality.prettyPrint()})`}toString(){return this.prettyPrint()}}class Qr extends ur{location;target;motive;base;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.base=r}synthHelper(t,e){return or.synthIndEqual(t,e,this.location,this.target,this.motive,this.base)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames())}prettyPrint(){return`(ind-= ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class Xr extends ur{location;type;length;constructor(t,e,n){super(t),this.location=t,this.type=e,this.length=n}synthHelper(t,e){return or.synthVec(t,e,this.type,this.length)}findNames(){return this.type.findNames().concat(this.length.findNames())}getType(t,e){const n=new ct("Eout"),r=new ct("lenout");return ut([[n,()=>this.type.isType(t,e)],[r,()=>this.length.check(t,e,new be)]],(()=>new at(new In(n.value,r.value))))}prettyPrint(){return`(Vec ${this.type.prettyPrint()} ${this.length.prettyPrint()})`}toString(){return this.prettyPrint()}}class Kr extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.now();if(r instanceof Me){return r.length.now()instanceof ke?new at(new Cn):new ot(this.location,new st([`vecnil requires a Vec type with length ZERO, but was used as a: \n          ${Qt(t,new be,r.length)}.`]))}return new ot(this.location,new st([`vecnil requires a Vec type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}}class Yr extends ur{location;x;xs;constructor(t,e,n){super(t),this.location=t,this.x=e,this.xs=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.x.findNames().concat(this.xs.findNames())}checkOut(t,e,n){const r=n.now();if(r instanceof Me){const n=r.length.now();if(n instanceof $e){const s=new ct("hout"),i=new ct("tout"),a=n.smaller;return ut([[s,()=>this.x.check(t,e,r.entryType)],[i,()=>this.xs.check(t,e,new Me(r.entryType,a))]],(()=>new at(new Bn(s.value,i.value))))}return new ot(this.location,new st([`vec:: requires a Vec type with length Add1, but was used with a: \n          ${Qt(t,new be,r.length)}.`]))}return new ot(this.location,new st([`vec:: requires a Vec type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(vec:: ${this.x.prettyPrint()} ${this.xs.prettyPrint()})`}toString(){return this.prettyPrint()}}class Zr extends ur{location;vec;constructor(t,e){super(t),this.location=t,this.vec=e}synthHelper(t,e){return or.synthHead(t,e,this.location,this.vec)}findNames(){return this.vec.findNames()}prettyPrint(){return`(head ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}}class jr extends ur{location;vec;constructor(t,e){super(t),this.location=t,this.vec=e}synthHelper(t,e){return or.synthTail(t,e,this.location,this.vec)}findNames(){return this.vec.findNames()}prettyPrint(){return`(tail ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}}class Wr extends ur{location;length;target;motive;base;step;constructor(t,e,n,r,s,i){super(t),this.location=t,this.length=e,this.target=n,this.motive=r,this.base=s,this.step=i}synthHelper(t,e){return or.synthIndVec(t,e,this.location,this.length,this.target,this.motive,this.base,this.step)}findNames(){return this.length.findNames().concat(this.target.findNames()).concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`ind-Vec ${this.length.prettyPrint()}\n              ${this.target.prettyPrint()}\n              ${this.motive.prettyPrint()}\n              ${this.base.prettyPrint()}\n              ${this.step.prettyPrint()}`}toString(){return this.prettyPrint()}}class Jr extends ur{location;left;right;constructor(t,e,n){super(t),this.location=t,this.left=e,this.right=n}synthHelper(t,e){return or.synthEither(t,e,this.left,this.right)}findNames(){return this.left.findNames().concat(this.right.findNames())}getType(t,e){const n=new ct("Lout"),r=new ct("Rout");return ut([[n,()=>this.left.isType(t,e)],[r,()=>this.right.isType(t,e)]],(()=>new at(new _n(n.value,r.value))))}prettyPrint(){return`(Either ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class ts extends ur{location;value;constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.value.findNames()}checkOut(t,e,n){const r=n.now();if(r instanceof ze){const n=new ct("lout");return ut([[n,()=>this.value.check(t,e,r.leftType)]],(()=>new at(new Gn(n.value))))}return new ot(this.location,new st([`left requires an Either type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class es extends ur{location;value;constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.value.findNames()}checkOut(t,e,n){const r=n.now();if(r instanceof ze){const n=new ct("rout");return ut([[n,()=>this.value.check(t,e,r.rightType)]],(()=>new at(new zn(n.value))))}return new ot(this.location,new st([`right requires an Either type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class ns extends ur{location;target;motive;baseLeft;baseRight;constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.baseLeft=r,this.baseRight=s}synthHelper(t,e){return or.synthIndEither(t,e,this.location,this.target,this.motive,this.baseLeft,this.baseRight)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.baseLeft.findNames()).concat(this.baseRight.findNames())}prettyPrint(){return`(ind-Either ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.baseLeft.prettyPrint()} \n              ${this.baseRight.prettyPrint()})`}toString(){return this.prettyPrint()}}class rs extends ur{location;constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.readBackType(t);return Jn(this.location,Et(t)),new at(new Hn(this.location.locationToSrcLoc(),r))}prettyPrint(){return"TODO"}toString(){return this.prettyPrint()}}class ss extends ur{location;func;arg;args;constructor(t,e,n,r){super(t),this.location=t,this.func=e,this.arg=n,this.args=r}synthHelper(t,e){return or.synthApplication(t,e,this.location,this.func,this.arg,this.args)}findNames(){return this.func.findNames().concat(this.arg.findNames()).concat(this.args.flatMap((t=>t.findNames())))}prettyPrint(){return`(${this.func.prettyPrint()} ${this.arg.prettyPrint()} ${this.args.map((t=>t.prettyPrint())).join(" ")})`}toString(){return this.prettyPrint()}}class is{id;type;context;renaming;term;constructor(t,e,n,r,s){this.id=t,this.type=e,this.context=n,this.renaming=r,this.term=s}clone(t={}){return new is(t.id??this.id,t.type??this.type,t.context??new Map(this.context),t.renaming??new Map(this.renaming),t.term??this.term)}addHypothesis(t,e){const n=yt(this.context,t);gt(this.context,n,new kt(e))}getVariableType(t){const e=this.context.get(t);return e?.type}prettyPrintWithContext(){const t=Array.from(this.context.entries()).map((([t,e])=>`${t} : ${e.type.readBackType(this.context).prettyPrint()}`)).join("\n  "),e=this.type.readBackType(this.context).prettyPrint();return t?`Context:\n  ${t}\n────────────────\nGoal: ${e}`:`Goal: ${e}`}}class as{goal;children=[];parent=null;isComplete=!1;childFocusIndex=-1;constructor(t){this.goal=t}addChildren(t){t.forEach((t=>{t.parent=this})),this.children=t}findById(t){if(this.goal.id===t)return this;for(const e of this.children){const n=e.findById(t);if(n)return n}return null}}class os{location;goalTree;currentGoal;proofHistory=[];goalIdCounter=0;constructor(t,e){this.location=t,this.goalTree=e,this.currentGoal=this.goalTree}static initialize(t,e,n){const r=new is("goal_0",e,new Map(t),new Map),s=new os(n,new as(r));return s.currentGoal=s.goalTree,s}generateGoalId(){return"goal_"+ ++this.goalIdCounter}isComplete(){return this.goalTree.isComplete}getCurrentGoal(){if(null===this.currentGoal)throw new Error("No current goal available.");return new at(this.currentGoal.goal)}visualizeTree(){return this.visualizeNode(this.goalTree,"",!0)}visualizeNode(t,e,n){let r=e+(n?"└── ":"├── ")+`${t.isComplete?"✓":t===this.currentGoal?"→":"○"} ${t.goal.id}`+"\n";const s=e+(n?"    ":"│   ");for(let e=0;e<t.children.length;e++){const n=e===t.children.length-1;r+=this.visualizeNode(t.children[e],s,n)}return r}addGoal(t){this.currentGoal.addChildren(t),this.currentGoal.childFocusIndex=0,this.currentGoal=t[0]}nextGoal(){if(null===this.currentGoal.parent)return!0;let t=this.currentGoal.parent;const e=this.nextGoalAux(t);return null===e||(this.currentGoal=e,!1)}nextGoalAux(t){return-1===t.childFocusIndex||t.childFocusIndex>=t.children.length-1?(t.isComplete=!0,null===t.parent?null:this.nextGoalAux(t.parent)):(t.childFocusIndex+=1,t.children[t.childFocusIndex])}previousGoal(){if(null===this.currentGoal.parent)throw new Error("No previous goal available at the root level.");const t=this.PreviousGoalAux(this.currentGoal);if(null===t)throw new Error("No previous goal found.");this.currentGoal=t}PreviousGoalAux(t){if(0===t.childFocusIndex)return t;{let e=!1,n=t.children[t.childFocusIndex-1];for(;!e;){if(-1===n.childFocusINdex)return e=!0,n;n=n.children[n.childFocusIndex]}}}}class cs{location;constructor(t){this.location=t}}class us extends cs{location;varName;constructor(t,e){super(t),this.location=t,this.varName=e}getName(){return"intro"}toString(){return`intro ${this.varName||""}`}apply(t){const e=t.currentGoal.goal,n=e.type;if(!(n instanceof Se))return new ot(t.location,new st([`Cannot introduce a variable for non-function type: ${n.prettyPrint()}`]));const r=this.varName||n.argName||yt(e.context,"x");let s=e.renaming;r!==n.argName&&er(s,n.argName,r);const i=gt(e.context,r,new St(n.argType)),a=n.resultType.valOfClosure(new De(n.argType,new Yt(r))),o=new as(new is(t.generateGoalId(),a,i,s));return t.addGoal([o]),new at(t)}}class hs extends cs{location;term;constructor(t,e){super(t),this.location=t,this.term=e}toString(){return`exact ${this.term.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.type;console.log("goalType:",n.prettyPrint()),console.log("term:",this.term.prettyPrint());const r=this.term.check(e.context,e.renaming,n);return r instanceof ot?r:(t.currentGoal.isComplete=!0,t.nextGoal(),new at(t))}}class ls extends cs{location;value;varName;constructor(t,e,n){super(t),this.location=t,this.value=e,this.varName=n}toString(){return`exists ${this.varName||""}`}apply(t){const e=t.getCurrentGoal().result,n=e.type;if(!(n instanceof Oe))return new ot(t.location,new st([`Cannot use exists on non-product type: ${n.prettyPrint()}`]));const r=this.varName||n.carName||yt(e.context,"x");let s=e.renaming;r!==n.carName&&er(s,n.carName,r);const i=this.value.check(e.context,e.renaming,n.carType);if(i instanceof ot)return i;const a=i.result.valOf(Pt(e.context)),o=gt(e.context,r,new $t(n.carType,a)),c=n.cdrType.valOfClosure(a),u=new as(new is(t.generateGoalId(),c,o,s));return t.addGoal([u]),new at(t)}}class ps extends cs{location;target;motive;constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return`elim-nat ${this.target} to prove ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new ot(t.location,new st([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof St))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof be))return new ot(t.location,new st([`Cannot eliminate non-Nat type: ${r.prettyPrint()}`]));const s=yt(e.context,"n"),i=this.motive.check(e.context,e.renaming,new Se(s,new be,new pt((t=>new Fe))));if(i instanceof ot)return i;{const n=this.eliminateNat(e.context,e.renaming,i.result.valOf(Pt(e.context)));return t.addGoal(n.map((n=>new as(new is(t.generateGoalId(),n,e.context,e.renaming))))),new at(t)}}eliminateNat(t,e,n){return[Bt(n,new ke),new Se(yt(t,"n-1"),new be,new pt((e=>new Se(yt(t,"ih"),Bt(n,e),new pt((t=>Bt(n,new $e(e))))))))]}}class ws extends cs{location;target;motive;constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return`elim-list ${this.target} to prove ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,r=e.context.get(this.target);if(!r)return new ot(t.location,new st([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof St))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof Ie))return new ot(t.location,new st([`Cannot eliminate non-List type: ${s.prettyPrint()}`]));yt(e.context,"motive");const i=s.entryType,a=this.motive.check(e.context,e.renaming,new Se("xs",new Ie(i),new lt(Pt(e.context),"xs",new Je)));if(a instanceof ot)return a;{const r=a.result.valOf(Pt(e.context)),s=this.eliminateList(e.context,e.renaming,r,i);return console.log("Eliminating List with motive:",n.inspect(s,!0,null,!0)),t.addGoal(s.map((n=>new as(new is(t.generateGoalId(),n,e.context,e.renaming))))),new at(t)}}eliminateList(t,e,n,r){return[Bt(n,new Be),new Se(yt(t,"x"),r,new pt((e=>new Se(yt(t,"xs"),new Ie(r),new pt((r=>new Se(yt(t,"ih"),Bt(n,r),new pt((t=>Bt(n,new Ce(e,r)))))))))))]}}class fs extends cs{location;target;motive;length;constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.length=r}toString(){return`elim-list ${this.target} to prove ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new ot(t.location,new st([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof St))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof Me))return new ot(t.location,new st([`Cannot eliminate non-Vec type: ${r.prettyPrint()}`]));const s=this.length.check(e.context,e.renaming,new be);if(s instanceof ot)return s;const[i,a]=[r.entryType,r.length];rr(e.context,this.location,new be,vt(e.context,s.result),a),yt(e.context,"motive");const o=this.motive.check(e.context,e.renaming,new Se("k",new be,new pt((t=>new Se("es",new Me(i,t),new pt((t=>new Fe)))))));if(o instanceof ot)return o;{const n=o.result.valOf(Pt(e.context)),r=this.eliminateVec(e.context,e.renaming,n,i);return t.addGoal(r.map((n=>new as(new is(t.generateGoalId(),n,e.context,e.renaming))))),new at(t)}}eliminateVec(t,e,n,r){return[Bt(Bt(n,new ke),new _e),Ht(r,n)]}}class ys extends cs{location;target;motive;constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return`elim-equal ${this.target} with motive ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new ot(t.location,new st([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof St))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof Re))return new ot(t.location,new st([`Cannot eliminate non-Equal type: ${r.prettyPrint()}`]));const[s,i,a]=[r.type,r.from,r.to],o=this.motive.check(e.context,e.renaming,new Se("to",s,new pt((t=>new Se("p",new Re(s,i,t),new pt((t=>new Fe)))))));if(o instanceof ot)return o;{const n=[Bt(Bt(o.result.valOf(Pt(e.context)),i),new qe(i))];return t.addGoal(n.map((n=>new as(new is(t.generateGoalId(),n,e.context,e.renaming))))),new at(t)}}}class ds extends cs{location;constructor(t){super(t),this.location=t}toString(){return"left"}apply(t){const e=t.getCurrentGoal().result;if(!(e.type.now()instanceof ze))return new ot(t.location,new st([`"left" expected goal type to be Either, but got: ${e.type.prettyPrint()}`]));const n=e.type.leftType.now();return t.addGoal([new as(new is(t.generateGoalId(),n,e.context,e.renaming))]),new at(t)}}class ms extends cs{location;constructor(t){super(t),this.location=t}toString(){return"right"}apply(t){const e=t.getCurrentGoal().result;if(!(e.type.now()instanceof ze))return new ot(t.location,new st([`"right" expected goal type to be Either, but got: ${e.type.prettyPrint()}`]));const n=e.type.rightType.now();return t.addGoal([new as(new is(t.generateGoalId(),n,e.context,e.renaming))]),new at(t)}}class gs extends cs{location;target;motive;constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return`elim-either ${this.target} with motive ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new ot(t.location,new st([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof St))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof ze))return new ot(t.location,new st([`Cannot eliminate non-Either type: ${r.prettyPrint()}`]));const[s,i]=[r.leftType,r.rightType],a=this.motive.check(e.context,e.renaming,new Se("x",new ze(s,i),new pt((t=>new Fe))));if(a instanceof ot)return a;{const n=a.result.valOf(Pt(e.context)),r=new Se("x",s,new pt((t=>Bt(n,new Ue(t))))),o=new Se("x",i,new pt((t=>Bt(n,new He(t)))));return t.addGoal([new as(new is(t.generateGoalId(),r,e.context,e.renaming)),new as(new is(t.generateGoalId(),o,e.context,e.renaming))]),new at(t)}}}class vs extends cs{constructor(t){super(t)}toString(){return"split"}apply(t){const e=t.getCurrentGoal().result;if(!(e.type.now()instanceof Oe))return new ot(t.location,new st([`"split" expected goal type to be Sigma, but got: ${e.type.prettyPrint()}`]));const n=e.type.now(),r=n.carType.now(),s=n.cdrType.valOfClosure(n);return t.addGoal([new as(new is(t.generateGoalId(),r,e.context,e.renaming)),new as(new is(t.generateGoalId(),s,e.context,e.renaming))]),new at(t)}}class Es extends cs{location;target;motive;constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return`elim-absurd ${this.target} with motive ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new ot(t.location,new st([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof St))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof Ke))return new ot(t.location,new st([`Cannot eliminate non-Absurd type: ${r.prettyPrint()}`]));const s=this.motive.check(e.context,e.renaming,new Fe);return s instanceof ot?s:(t.currentGoal.isComplete=!0,t.nextGoal(),new at(t))}}function Ts(t,e){return[t,...e]}function Ns(t){return new K(t,!0)}function Ps(t){return new nt(Ns(t),t.source)}function xs(t){if(t instanceof H.Symbol)return t.value;if(t instanceof H.NumericLiteral)return t.value;if(t instanceof D.List)return xs(t.elements[0]);throw new Error("Expected a Element, but got: "+t)}function bs(t,e){return new X(e.start,e.end,t)}function ks(t,e){return bs(xs(t),e)}function $s(t){const e=new U(t);return new V("",e.scanTokens()).parse()}class Ss{static parsePie(t){return Ss.parseElements($s(t)[0])}static parseElements(t){const e=xs(t);if("U"===e)return n=bs("U",t.location),new lr(Ns(n));if("the"===e){let e=t.elements;return function(t,e,n){return new hr(Ns(t),e,n)}(bs("the",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("Nat"===e)return function(t){return new pr(Ns(t))}(bs("Nat",t.location));if("zero"===e)return function(t){return new wr(Ns(t))}(bs("zero",t.location));if("add1"===e)return function(t,e){return new fr(Ns(t),e)}(bs("add1",t.location),this.parseElements(t.elements[1]));if("->"===e||"→"===e){let e=t.elements;return function(t,e){return new vr(Ns(t),e[0],e[1],e[2])}(bs("->",t.location),[this.parseElements(e[1]),this.parseElements(e[2]),e.slice(3).map((t=>this.parseElements(t)))])}if("lambda"===e||"λ"===e){let e=t.elements,n=t.location,r=e[1],s=e[2];return function(t,e,n){return new Tr(Ns(t),e,n)}(bs("λ",n),r.elements.map((e=>Ps(ks(e,t.location)))),this.parseElements(s))}if("Pi"===e||"Π"===e){let e=t.elements,n=e[1],r=e[2],s=n.elements[0],i=s.elements[0],a=s.elements[1],o=n.elements.slice(1).map((t=>{let e=t.elements[0],n=t.elements[1];return new rt(Ps(ks(e,t.location)),this.parseElements(n))}));return function(t,e,n){return new Er(Ns(t),e,n)}(bs("Π",t.location),Ts(new rt(Ps(ks(i,s.location)),this.parseElements(a)),o),this.parseElements(r))}if("Sigma"===e||"Σ"===e){let e=t.elements,n=e[1],r=e[2],s=n.elements[0],i=s.elements[0],a=s.elements[1],o=n.elements.slice(1).map((t=>{let e=t.elements[0],n=t.elements[1];return new rt(Ps(ks(e,t.location)),this.parseElements(n))}));return function(t,e,n){return new Nr(Ns(t),e,n)}(bs("Π",t.location),Ts(new rt(Ps(ks(i,s.location)),this.parseElements(a)),o),this.parseElements(r))}if("Pair"===e){let e=t.elements;return function(t,e,n){return new kr(Ns(t),e,n)}(bs("Pair",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("cons"===e){let e=t.elements;return function(t,e,n){return new $r(Ns(t),e,n)}(bs("Cons",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("car"===e)return function(t,e){return new Sr(Ns(t),e)}(bs("car",t.location),this.parseElements(t.elements[1]));if("cdr"===e)return function(t,e){return new Lr(Ns(t),e)}(bs("cdr",t.location),this.parseElements(t.elements[1]));if("which-Nat"===e){let e=t.elements;return function(t,e,n,r){return new yr(Ns(t),e,n,r)}(bs("which-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("iter-Nat"===e){let e=t.elements;return function(t,e,n,r){return new dr(Ns(t),e,n,r)}(bs("iter-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("rec-Nat"===e){let e=t.elements;return function(t,e,n,r){return new mr(Ns(t),e,n,r)}(bs("rec-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("ind-Nat"===e){let e=t.elements;return function(t,e,n,r,s){return new gr(Ns(t),e,n,r,s)}(bs("ind-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("Atom"===e)return function(t){return new xr(Ns(t))}(bs("Atom",t.location));if("quote"===e)return function(t,e){return new br(Ns(t),e)}(bs("Quote",t.location),xs(t.elements[1]));if("Trivial"===e)return function(t){return new Or(Ns(t))}(bs("Trivial",t.location));if("sole"===e)return function(t){return new Ar(Ns(t))}(bs("sole",t.location));if("List"===e)return function(t,e){return new Cr(Ns(t),e)}(bs("List",t.location),this.parseElements(t.elements[1]));if("nil"===e)return function(t){return new Ir(Ns(t))}(bs("nil",t.location));if("::"===e){let e=t.elements;return function(t,e,n){return new Rr(Ns(t),e,n)}(bs("::",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("rec-List"===e){let e=t.elements;return function(t,e,n,r){return new qr(Ns(t),e,n,r)}(bs("rec-List",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("ind-List"===e){let e=t.elements;return function(t,e,n,r,s){return new Mr(Ns(t),e,n,r,s)}(bs("ind-List",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("="===e){let e=t.elements;return function(t,e,n,r){return new zr(Ns(t),e,n,r)}(bs("=",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("same"===e)return function(t,e){return new Ur(Ns(t),e)}(bs("same",t.location),this.parseElements(t.elements[1]));if("replace"===e){let e=t.elements;return function(t,e,n,r){return new Hr(Ns(t),e,n,r)}(bs("replace",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("trans"===e){let e=t.elements;return function(t,e,n){return new Dr(Ns(t),e,n)}(bs("trans",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("cong"===e){let e=t.elements;return function(t,e,n){return new Fr(Ns(t),e,n)}(bs("cong",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("ind-="===e){let e=t.elements;return function(t,e,n,r){return new Qr(Ns(t),e,n,r)}(bs("ind-=",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("symm"===e)return function(t,e){return new Vr(Ns(t),e)}(bs("symm",t.location),this.parseElements(t.elements[1]));if("Vec"===e){let e=t.elements;return function(t,e,n){return new Xr(Ns(t),e,n)}(bs("Vec",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("vecnil"===e)return function(t){return new Kr(Ns(t))}(bs("vecnil",t.location));if("vec::"===e){let e=t.elements;return function(t,e,n){return new Yr(Ns(t),e,n)}(bs("vec::",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("head"===e)return function(t,e){return new Zr(Ns(t),e)}(bs("head",t.location),this.parseElements(t.elements[1]));if("tail"===e)return function(t,e){return new jr(Ns(t),e)}(bs("tail",t.location),this.parseElements(t.elements[1]));if("ind-Vec"===e){let e=t.elements;return function(t,e,n,r,s,i){return new Wr(Ns(t),e,n,r,s,i)}(bs("ind-Vec",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]),this.parseElements(e[5]))}if("Either"===e){let e=t.elements;return function(t,e,n){return new Jr(Ns(t),e,n)}(bs("Either",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("left"===e)return function(t,e){return new ts(Ns(t),e)}(bs("left",t.location),this.parseElements(t.elements[1]));if("right"===e)return function(t,e){return new es(Ns(t),e)}(bs("right",t.location),this.parseElements(t.elements[1]));if("ind-Either"===e){let e=t.elements;return function(t,e,n,r,s){return new ns(Ns(t),e,n,r,s)}(bs("ind-Either",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("Absurd"===e)return function(t){return new _r(Ns(t))}(bs("Absurd",t.location));if("ind-Absurd"===e){let e=t.elements;return function(t,e,n){return new Gr(Ns(t),e,n)}(bs("ind-Absurd",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("TODO"===e)return function(t){return new rs(Ns(t))}(bs("TODO",t.location));if(t instanceof D.List&&t.elements.length>1){let e=t.elements;return function(t,e,n,r){return new ss(Ns(t),e,n,r)}(bs("App",t.location),this.parseElements(e[0]),this.parseElements(e[1]),e.slice(2).map((t=>this.parseElements(t))))}if(wt(e))return function(t,e){return new Pr(Ns(t),e)}(bs(e,t.location),e);if(!isNaN(Number(e)))return function(t,e){return new Br(Ns(t),Number(e))}(bs(e,t.location),e);var n;throw new Error("Unexpected element: "+t)}static parseToTactics(t){const e=xs(t);if("exact"===e)return n=bs("exact",t.location),r=this.parseElements(t.elements[1]),new hs(Ns(n),r);if("intro"===e)return function(t,e){return new us(Ns(t),e)}(bs("intro",t.location),t.elements[1].value);if("exists"===e)return function(t,e,n){return new ls(Ns(t),e,n)}(bs("exists",t.location),this.parseElements(t.elements[1]),t.elements[2].value);if("elimNat"===e)return function(t,e,n){return new ps(Ns(t),e,n)}(bs("elimNat",t.location),t.elements[1].value,this.parseElements(t.elements[2]));if("elimList"===e)return function(t,e,n){return new ws(Ns(t),e,n)}(bs("elimList",t.location),t.elements[1].value,this.parseElements(t.elements[2]));if("elimVec"===e)return function(t,e,n,r){return new fs(Ns(t),e,n,r)}(bs("elimVec",t.location),t.elements[1].value,this.parseElements(t.elements[2]),this.parseElements(t.elements[3]));if("elimEqual"===e)return function(t,e,n){return new ys(Ns(t),e,n)}(bs("elimEqual",t.location),t.elements[1].value,this.parseElements(t.elements[2]));if("left"===e)return function(t){return new ds(Ns(t))}(bs("left",t.location));if("right"===e)return function(t){return new ms(Ns(t))}(bs("right",t.location));if("elimEither"===e)return function(t,e,n){return new gs(Ns(t),e,n)}(bs("elimEither",t.location),t.elements[1].value,this.parseElements(t.elements[2]));if("split"===e)return function(t){return new vs(Ns(t))}(bs("split",t.location));if("elimAbsurd"===e)return function(t,e,n){return new Es(Ns(t),e,n)}(bs("elimAbsurd",t.location),t.elements[1].value,this.parseElements(t.elements[2]));var n,r;throw new Error("Unexpected tactic: "+t)}}class Ls{location;name;type;constructor(t,e,n){this.location=t,this.name=e,this.type=n}}class Os{location;name;expr;constructor(t,e,n){this.location=t,this.name=e,this.expr=n}}class As{location;type;left;right;constructor(t,e,n,r){this.location=t,this.type=e,this.left=n,this.right=r}}class Is{location;name;tactics;constructor(t,e,n){this.location=t,this.name=e,this.tactics=n}}class Bs{static parseDeclaration(t){const e=xs(t);if("claim"===e){let e=t.elements;return new Ls(Ns(ks(e[0],t.location)),xs(e[1]),Ss.parseElements(e[2]))}if("define"===e){let e=t.elements;return new Os(Ns(ks(e[0],t.location)),xs(e[1]),Ss.parseElements(e[2]))}if("check-same"===e){let e=t.elements;return new As(Ns(ks(e[0],t.location)),Ss.parseElements(e[1]),Ss.parseElements(e[2]),Ss.parseElements(e[3]))}if("define-tactically"===e){let e=t.elements;return new Is(Ns(ks(e[0],t.location)),xs(e[1]),e[2].elements.map((t=>Ss.parseToTactics(t))))}return Ss.parseElements(t)}}function Cs(t,e){const n=new ct("outmeta");return ut([[n,()=>e.synth(t,new Map)]],(()=>{const e=vt(t,n.value.type),r=vt(t,n.value.expr);return new at(new We(e.readBackType(t),Qt(t,e,r)))}))}function Rs(t,e,n,r,s){const i=new ct("tOut"),a=new ct("tv"),o=new ct("aOut"),c=new ct("bOut"),u=new ct("av"),h=new ct("bv");return ut([[i,()=>n.isType(t,new Map)],[a,()=>vt(t,i.value).readBackType(t)],[o,()=>r.check(t,new Map,a.value)],[c,()=>s.check(t,new Map,a.value)],[u,()=>vt(t,o.value)],[h,()=>vt(t,c.value)]],(()=>rr(t,e,a.value,u.value,h.value)))}function qs(t){return t.prettyPrint()}class Ms{currentState=null;startProof(t,e,n){const r=e.get(t);return r instanceof kt?(this.currentState=os.initialize(e,r.type,n),new at(`Started proof of ${t}\nCurrent goal: \n${r.type.readBackType(e).prettyPrint()}`)):new ot(n,new st([`${t} is not a valid type or has already been proved`]))}applyTactic(t){if(!this.currentState)return new ot(t.location,new st(["No proof has been initialized"]));const e=t.apply(this.currentState);if(e instanceof ot)return e;this.currentState=e.result;let n=`\nApplied tactic: ${t}`;const r=this.currentState.getCurrentGoal();if(this.currentState.isComplete())n+="\nAll goals have been solved!";else{const t=r.result;n+="\nCurrent goal: \n"+t.type.readBackType(t.context).prettyPrint()}return new at(n)}}class _s extends e.BasicEvaluator{executionCount;constructor(t){super(t),this.executionCount=0}async evaluateChunk(t){this.executionCount++;try{let e=function(t){const e=$s(t);let n=xt,r="";for(const t of e){const e=Bs.parseDeclaration(t);if(e instanceof Ls){const t=Tt(n,e.name,e.location,e.type);if(t instanceof at)n=t.result;else if(t instanceof ot)throw new Error(""+t.where+t.message)}else if(e instanceof Os){const t=Nt(n,e.name,e.location,e.expr);if(t instanceof at)n=t.result;else if(t instanceof ot)throw new Error(""+t.where+t.message)}else if(e instanceof As){const t=Rs(n,e.location,e.type,e.left,e.right);if(t instanceof at)n=t.result;else if(t instanceof ot)throw new Error(""+t.where+t.message)}else{if(e instanceof Is){const t=new Ms;let r="";const s=t.startProof(e.name,n,e.location);if(s instanceof at)r+=s.result+"\n";else if(s instanceof ot)throw new Error(""+s.where+s.message);for(const n of e.tactics){const e=t.applyTactic(n);if(e instanceof at)r+=e.result;else if(e instanceof ot)throw new Error(""+e.where+e.message)}return r}{const t=Cs(n,e);if(t instanceof at){const e=t.result;r+=`${qs(e.expr)}: ${qs(e.type)}\n`}else if(t instanceof ot)throw new Error(`${t.message} at ${t.where}`)}}}for(const[t,e]of n)e instanceof $t?(r+=t+" : "+qs(e.type.readBackType(n))+"\n",r+=t+" = "+qs(Qt(n,e.type,e.value))+"\n"):r+=t+" : "+qs(e.type.readBackType(n))+"\n";return r}(t);this.conductor.sendOutput(`Result of expression: execution ${e}`)}catch(t){t instanceof Error?this.conductor.sendOutput(`Error: ${t.message}`):this.conductor.sendOutput(`Error: ${String(t)}`)}}}const{runnerPlugin:Gs,conduit:zs}=t.initialise(_s)}(_,runner,util);
//# sourceMappingURL=index.js.map
