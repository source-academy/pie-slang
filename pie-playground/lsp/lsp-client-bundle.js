class e{constructor(e,t){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.monaco=e,this.editor=t}async start(){this.worker=new Worker(new URL("./pie-lsp-worker-bundle.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("LSP Worker error:",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce(()=>{if(!this.worker)return;const t=e.getValue();this.worker.postMessage({type:"validate",source:t})},220);const t=this.editor?.onDidChangeModelContent?.(()=>{this.debouncedValidate&&this.debouncedValidate()});t&&this.disposables.push(t);const s=this.monaco.languages.registerHoverProvider("pie",{provideHover:(e,t)=>this.provideHover(e,t)});this.disposables.push(s);const i=this.monaco.languages.registerCompletionItemProvider("pie",{provideCompletionItems:(e,t)=>this.provideCompletionItems(e,t)});this.disposables.push(i);const n=this.monaco.languages.registerDefinitionProvider("pie",{provideDefinition:(e,t)=>this.provideDefinition(e,t)});this.disposables.push(n),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}),this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&("validation-result"===e.type?this.updateDiagnostics(e.diagnostics??[]):"validation-error"===e.type&&this.updateDiagnostics([{severity:"error",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]))}updateDiagnostics(e){this.diagnostics=e;const t=this.editor?.getModel?.();if(!t)return;const s=e.map(e=>{const t=this.ensurePositiveNumber(e.startLine,1),s=this.ensurePositiveNumber(e.endLine,t),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:t,startColumn:i,endLineNumber:s,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:"warning"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}});this.monaco.editor.setModelMarkers(t,"pie-lsp",s)}async provideHover(e,t){if(!this.worker)return null;const s=this.diagnostics.find(e=>{const s=this.ensurePositiveNumber(e.startLine,t.lineNumber),i=this.ensurePositiveNumber(e.endLine,s),n=this.ensurePositiveNumber(e.startColumn,1),o=this.ensurePositiveNumber(e.endColumn,n+1);return!(t.lineNumber<s||t.lineNumber>i)&&(!(t.lineNumber===s&&t.column<n)&&!(t.lineNumber===i&&t.column>o))});if(s){const e=this.ensurePositiveNumber(s.startLine,t.lineNumber),i=this.ensurePositiveNumber(s.endLine,e),n=this.ensurePositiveNumber(s.startColumn,1),o=this.ensurePositiveNumber(s.endColumn,n+1);return{contents:[{value:`**${"warning"===s.severity?"Warning":"Error"}**\n\n${s.message}`}],range:{startLineNumber:e,startColumn:n,endLineNumber:i,endColumn:o}}}return new Promise(s=>{const i=e=>{const t=e.data;if("hover-result"===t.type){if(this.worker?.removeEventListener("message",i),!t.hoverInfo)return void s(null);const e=t.hoverInfo;let n=`**${e.title}**\n\n${e.summary}`;e.details&&(n+=`\n\n${e.details}`),e.examples&&(n+=`\n\n**Examples:**\n\`\`\`pie\n${e.examples}\n\`\`\``),s({contents:[{value:n}]})}};if(this.worker){this.worker.addEventListener("message",i);const s=e.getValue();this.worker.postMessage({type:"hover",source:s,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),s(null)},1e3)})}async provideCompletionItems(e,t){return this.worker?new Promise(s=>{const i=e=>{const n=e.data;if("completion-result"===n.type){this.worker?.removeEventListener("message",i);const e=n.wordRange,o=e?{startLineNumber:t.lineNumber,startColumn:e.start+1,endLineNumber:t.lineNumber,endColumn:e.end+1}:{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber,endColumn:t.column},r=n.completions.map(e=>{let t=this.monaco.languages.CompletionItemKind.Text;switch(e.kind){case"Keyword":t=this.monaco.languages.CompletionItemKind.Keyword;break;case"Function":t=this.monaco.languages.CompletionItemKind.Function;break;case"Variable":t=this.monaco.languages.CompletionItemKind.Variable;break;case"TypeParameter":t=this.monaco.languages.CompletionItemKind.Class;break;case"Value":t=this.monaco.languages.CompletionItemKind.Value;break;case"Snippet":t=this.monaco.languages.CompletionItemKind.Snippet}return{label:e.label,kind:t,detail:e.detail,insertText:e.label,range:o}});s({suggestions:r})}};if(this.worker){this.worker.addEventListener("message",i);const s=e.getValue();this.worker.postMessage({type:"completion",source:s,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),s({suggestions:[]})},1e3)}):{suggestions:[]}}async provideDefinition(e,t){return this.worker?new Promise(s=>{const i=t=>{const n=t.data;"definition-result"===n.type&&(this.worker?.removeEventListener("message",i),n.location?s({uri:e.uri,range:{startLineNumber:n.location.line+1,startColumn:n.location.startColumn+1,endLineNumber:n.location.line+1,endColumn:n.location.endColumn+1}}):s(null))};if(this.worker){this.worker.addEventListener("message",i);const s=e.getValue();this.worker.postMessage({type:"definition",source:s,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),s(null)},1e3)}):null}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,"pie-lsp",[])}ensurePositiveNumber(e,t){return"number"!=typeof e||Number.isNaN(e)||e<1?t:e}debounce(e,t){let s=null;return()=>{null!==s&&window.clearTimeout(s),s=window.setTimeout(()=>{s=null,e()},t)}}}function t(e){e.languages.register({id:"pie"}),e.languages.setLanguageConfiguration("pie",{comments:{lineComment:";",blockComment:["#|","|#"]},brackets:[["(",")"],["[","]"],["{","}"]],autoClosingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}],surroundingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}]}),e.languages.setMonarchTokensProvider("pie",{defaultToken:"",tokenPostfix:".pie",keywords:["lambda","λ","Pi","Π","Sigma","Σ","define","claim","the","check-same","define-tactically","TODO","U","Universe","Nat","Atom","List","Vec","Either","zero","add1","nil","cons","car","cdr","ind-Nat","rec-Nat","iter-Nat","ind-List","rec-List","ind-Vec","rec-Vec","ind-Either","replace","trans","cong","symm","same","left","right","ind-Either","vecnil","vec::"],operators:["->","→","=","::"],symbols:/[=><!~?:&|+\-*/^%]+/,tokenizer:{root:[{include:"@whitespace"},[/\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\b/,"keyword"],[/[a-zA-Z][a-zA-Z0-9\-_!?*+=<>λΠΣ→]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d+/,"number"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string"],[/'[a-zA-Z][a-zA-Z0-9\-_!?*+=<>]*/,"string.quoted"],[/[()[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}]],whitespace:[[/[ \t\r\n]+/,"white"],[/;.*$/,"comment"],[/#\|/,"comment","@comment"]],comment:[[/[^#|]+/,"comment"],[/\|#/,"comment","@pop"],[/[#|]/,"comment"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]]}})}export{e as PieLanguageClient,t as registerPieLanguage};
//# sourceMappingURL=lsp-client-bundle.js.map
