class e{constructor(e,t){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.monaco=e,this.editor=t}async start(){this.worker=new Worker(new URL("./pie-lsp-worker-bundle.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("LSP Worker error:",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce((()=>{if(!this.worker)return;const t=e.getValue();this.worker.postMessage({type:"validate",source:t})}),220);const t=this.editor?.onDidChangeModelContent?.((()=>{this.debouncedValidate&&this.debouncedValidate()}));t&&this.disposables.push(t);const n=this.monaco.languages.registerHoverProvider("pie",{provideHover:(e,t)=>this.provideHover(e,t)});this.disposables.push(n);const i=this.monaco.languages.registerCompletionItemProvider("pie",{provideCompletionItems:(e,t)=>this.provideCompletionItems(e,t)});this.disposables.push(i);const o=this.monaco.languages.registerDefinitionProvider("pie",{provideDefinition:(e,t)=>this.provideDefinition(e,t)});this.disposables.push(o),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach((e=>{e&&"function"==typeof e.dispose&&e.dispose()})),this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&("validation-result"===e.type?this.updateDiagnostics(e.diagnostics??[]):"validation-error"===e.type&&this.updateDiagnostics([{severity:"error",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]))}updateDiagnostics(e){this.diagnostics=e;const t=this.editor?.getModel?.();if(!t)return;const n=e.map((e=>{const t=this.ensurePositiveNumber(e.startLine,1),n=this.ensurePositiveNumber(e.endLine,t),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:t,startColumn:i,endLineNumber:n,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:"warning"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}}));this.monaco.editor.setModelMarkers(t,"pie-lsp",n)}async provideHover(e,t){if(!this.worker)return null;const n=this.diagnostics.find((e=>{const n=this.ensurePositiveNumber(e.startLine,t.lineNumber),i=this.ensurePositiveNumber(e.endLine,n),o=this.ensurePositiveNumber(e.startColumn,1),r=this.ensurePositiveNumber(e.endColumn,o+1);return!(t.lineNumber<n||t.lineNumber>i)&&(!(t.lineNumber===n&&t.column<o)&&!(t.lineNumber===i&&t.column>r))}));if(n){const e=this.ensurePositiveNumber(n.startLine,t.lineNumber),i=this.ensurePositiveNumber(n.endLine,e),o=this.ensurePositiveNumber(n.startColumn,1),r=this.ensurePositiveNumber(n.endColumn,o+1);return{contents:[{value:`**${"warning"===n.severity?"Warning":"Error"}**\n\n${n.message}`}],range:{startLineNumber:e,startColumn:o,endLineNumber:i,endColumn:r}}}return new Promise((n=>{const i=e=>{const t=e.data;if("hover-result"===t.type){if(this.worker?.removeEventListener("message",i),!t.hoverInfo)return void n(null);const e=t.hoverInfo;let o=`**${e.title}**\n\n${e.summary}`;e.details&&(o+=`\n\n${e.details}`),e.examples&&(o+=`\n\n**Examples:**\n\`\`\`pie\n${e.examples}\n\`\`\``),n({contents:[{value:o}]})}};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"hover",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout((()=>{this.worker?.removeEventListener("message",i),n(null)}),1e3)}))}async provideCompletionItems(e,t){return this.worker?new Promise((n=>{const i=e=>{const o=e.data;if("completion-result"===o.type){this.worker?.removeEventListener("message",i);const e=o.wordRange,r=e?{startLineNumber:t.lineNumber,startColumn:e.start+1,endLineNumber:t.lineNumber,endColumn:e.end+1}:{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber,endColumn:t.column},s=o.completions.map((e=>{let t=this.monaco.languages.CompletionItemKind.Text;switch(e.kind){case"Keyword":t=this.monaco.languages.CompletionItemKind.Keyword;break;case"Function":t=this.monaco.languages.CompletionItemKind.Function;break;case"Variable":t=this.monaco.languages.CompletionItemKind.Variable;break;case"TypeParameter":t=this.monaco.languages.CompletionItemKind.Class;break;case"Value":t=this.monaco.languages.CompletionItemKind.Value;break;case"Snippet":t=this.monaco.languages.CompletionItemKind.Snippet}return{label:e.label,kind:t,detail:e.detail,insertText:e.label,range:r}}));n({suggestions:s})}};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"completion",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout((()=>{this.worker?.removeEventListener("message",i),n({suggestions:[]})}),1e3)})):{suggestions:[]}}async provideDefinition(e,t){return this.worker?new Promise((n=>{const i=t=>{const o=t.data;"definition-result"===o.type&&(this.worker?.removeEventListener("message",i),o.location?n({uri:e.uri,range:{startLineNumber:o.location.line+1,startColumn:o.location.startColumn+1,endLineNumber:o.location.line+1,endColumn:o.location.endColumn+1}}):n(null))};if(this.worker){this.worker.addEventListener("message",i);const n=e.getValue();this.worker.postMessage({type:"definition",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout((()=>{this.worker?.removeEventListener("message",i),n(null)}),1e3)})):null}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,"pie-lsp",[])}ensurePositiveNumber(e,t){return"number"!=typeof e||Number.isNaN(e)||e<1?t:e}debounce(e,t){let n=null;return()=>{null!==n&&window.clearTimeout(n),n=window.setTimeout((()=>{n=null,e()}),t)}}}const t={nodeWidth:180,nodeHeight:60,horizontalSpacing:40,verticalSpacing:80,colors:{current:"#f59e0b",completed:"#34d399",pending:"#64748b",edge:"#475569",tacticLabel:"#94a3b8",background:"#0f172a"}};class n{constructor(e,n){this.svg=null,this.onGoalSelect=null,this.currentData=null,this.container=e,this.config={...t,...n}}setOnGoalSelect(e){this.onGoalSelect=e}render(e){this.currentData=e,this.clear();const t=this.calculateLayout(e.root);let n=1/0,i=-1/0,o=0;t.forEach((e=>{n=Math.min(n,e.x),i=Math.max(i,e.x+e.width),o=Math.max(o,e.y+this.config.nodeHeight)}));const r=i-n+40,s=o+40,a=20-n;this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",String(r)),this.svg.setAttribute("height",String(s)),this.svg.style.display="block";const d=document.createElementNS("http://www.w3.org/2000/svg","g"),l=document.createElementNS("http://www.w3.org/2000/svg","g");this.svg.appendChild(d),this.svg.appendChild(l),this.renderNodeRecursive(e.root,t,a,20,d,l),this.container.appendChild(this.svg)}renderNodeRecursive(e,t,n,i,o,r){const s=t.get(e.goal.id);if(!s)return;const a=s.x+n,d=s.y+i;for(const r of e.children){const s=t.get(r.goal.id);if(s){const t=s.x+n,r=s.y+i;this.renderEdge(o,a,d,t,r,e.appliedTactic)}}e.completedBy&&0===e.children.length&&this.renderSelfLoop(o,a,d,e.completedBy),this.renderNode(r,e.goal,a,d);for(const s of e.children)this.renderNodeRecursive(s,t,n,i,o,r)}renderNode(e,t,n,i){const{nodeWidth:o,nodeHeight:r,colors:s}=this.config,a=document.createElementNS("http://www.w3.org/2000/svg","g");a.setAttribute("class","goal-node"),a.setAttribute("data-goal-id",t.id),a.style.cursor="pointer";let d=s.pending,l="0.1";t.isCurrent?(d=s.current,l="0.2"):t.isComplete&&(d=s.completed,l="0.15");const c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",String(n)),c.setAttribute("y",String(i)),c.setAttribute("width",String(o)),c.setAttribute("height",String(r)),c.setAttribute("rx","8"),c.setAttribute("ry","8"),c.setAttribute("fill",d),c.setAttribute("fill-opacity",l),c.setAttribute("stroke",d),c.setAttribute("stroke-width",t.isCurrent?"3":"2"),a.appendChild(c);const u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",String(n+10)),u.setAttribute("y",String(i+18)),u.setAttribute("fill",d),u.setAttribute("font-size","11"),u.setAttribute("font-family","monospace"),u.textContent=t.id,a.appendChild(u);const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",String(n+o-10)),h.setAttribute("y",String(i+18)),h.setAttribute("text-anchor","end"),h.setAttribute("fill",d),h.setAttribute("font-size","12"),console.log(`Goal ${t.id}: isComplete=${t.isComplete}, isCurrent=${t.isCurrent}`),t.isComplete?h.textContent="✓":t.isCurrent?h.textContent="→":h.textContent="○",a.appendChild(h);const m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",String(n+10)),m.setAttribute("y",String(i+40)),m.setAttribute("fill","#e2e8f0"),m.setAttribute("font-size","12"),m.setAttribute("font-family","monospace");const p=this.truncateText(t.type,o-20);m.textContent=p,a.appendChild(m),a.addEventListener("click",(()=>{this.onGoalSelect&&this.onGoalSelect(t)})),a.addEventListener("mouseenter",(()=>{c.setAttribute("fill-opacity",String(parseFloat(l)+.1))})),a.addEventListener("mouseleave",(()=>{c.setAttribute("fill-opacity",l)})),e.appendChild(a)}renderEdge(e,t,n,i,o,r){const{nodeWidth:s,nodeHeight:a,colors:d}=this.config,l=t+s/2,c=n+a,u=i+s/2,h=o,m=document.createElementNS("http://www.w3.org/2000/svg","path"),p=(c+h)/2,g=`M ${l} ${c} C ${l} ${p}, ${u} ${p}, ${u} ${h}`;if(m.setAttribute("d",g),m.setAttribute("fill","none"),m.setAttribute("stroke",d.edge),m.setAttribute("stroke-width","2"),e.appendChild(m),r){const t=(l+u)/2,n=p,i=document.createElementNS("http://www.w3.org/2000/svg","rect"),o=this.truncateText(r,100),s=Math.min(7*o.length+10,110);i.setAttribute("x",String(t-s/2)),i.setAttribute("y",String(n-10)),i.setAttribute("width",String(s)),i.setAttribute("height","20"),i.setAttribute("rx","4"),i.setAttribute("fill",d.background),i.setAttribute("fill-opacity","0.9"),e.appendChild(i);const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",String(t)),a.setAttribute("y",String(n+4)),a.setAttribute("text-anchor","middle"),a.setAttribute("fill",d.tacticLabel),a.setAttribute("font-size","11"),a.setAttribute("font-family","monospace"),a.textContent=o,e.appendChild(a)}}renderSelfLoop(e,t,n,i){const{nodeWidth:o,nodeHeight:r,colors:s}=this.config,a=t+o/2,d=n+r,l=document.createElementNS("http://www.w3.org/2000/svg","path"),c=`M ${a-15} ${d}\n               C ${a-50} ${d+35},\n                 ${a+50} ${d+35},\n                 ${a+15} ${d}`;l.setAttribute("d",c),l.setAttribute("fill","none"),l.setAttribute("stroke",s.completed),l.setAttribute("stroke-width","2"),e.appendChild(l);const u=document.createElementNS("http://www.w3.org/2000/svg","polygon"),h=a+15,m=d;u.setAttribute("points",`${h},${m} ${h+6},${m+6} ${h-6},${m+6}`),u.setAttribute("fill",s.completed),e.appendChild(u);const p=d+35+5,g=this.truncateText(i,120),v=Math.min(6.5*g.length+12,130),b=document.createElementNS("http://www.w3.org/2000/svg","rect");b.setAttribute("x",String(a-v/2)),b.setAttribute("y",String(p-10)),b.setAttribute("width",String(v)),b.setAttribute("height","18"),b.setAttribute("rx","4"),b.setAttribute("fill",s.background),b.setAttribute("fill-opacity","0.9"),e.appendChild(b);const f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",String(a)),f.setAttribute("y",String(p+3)),f.setAttribute("text-anchor","middle"),f.setAttribute("fill",s.completed),f.setAttribute("font-size","10"),f.setAttribute("font-family","monospace"),f.textContent=g,e.appendChild(f)}calculateLayout(e){const t=new Map,n=new Map;return this.calculateSubtreeWidths(e,n),this.assignPositions(e,0,0,n,t),t}calculateSubtreeWidths(e,t){const{nodeWidth:n,horizontalSpacing:i}=this.config;if(0===e.children.length)return t.set(e.goal.id,n),n;let o=0;for(const n of e.children)o+=this.calculateSubtreeWidths(n,t);o+=(e.children.length-1)*i;const r=Math.max(n,o);return t.set(e.goal.id,r),r}assignPositions(e,t,n,i,o){const{nodeWidth:r,nodeHeight:s,horizontalSpacing:a,verticalSpacing:d}=this.config,l=t+((i.get(e.goal.id)||r)-r)/2;if(o.set(e.goal.id,{x:l,y:n,width:r}),e.children.length>0){const l=n+s+d;let c=t;for(const t of e.children){const e=i.get(t.goal.id)||r;this.assignPositions(t,c,l,i,o),c+=e+a}}}truncateText(e,t){const n=Math.floor(t/7);return e.length<=n?e:e.substring(0,n-3)+"..."}clear(){this.svg&&this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svg=null}highlightGoal(e){if(!this.svg)return;this.svg.querySelectorAll(".goal-node").forEach((e=>{e.classList.remove("highlighted")}));const t=this.svg.querySelector(`[data-goal-id="${e}"]`);t&&t.classList.add("highlighted")}}class i{constructor(e){this.currentGoal=null,this.container=e,this.clear()}display(e){this.currentGoal=e,this.container.innerHTML="";const t=document.createElement("div");t.className="panel-header";const n=document.createElement("div");n.className="panel-label",n.textContent="Context",t.appendChild(n),this.container.appendChild(t);const i=document.createElement("div");if(i.className="panel-content",e.contextEntries.length>0){const t=document.createElement("div");t.className="context-list";for(const n of e.contextEntries){const e=document.createElement("div");e.className="context-entry";const i=document.createElement("span");i.className="context-entry-name",i.textContent=n.name,e.appendChild(i);const o=document.createElement("span");o.className="context-entry-colon",o.textContent=" : ",e.appendChild(o);const r=document.createElement("span");r.className="context-entry-type",r.textContent=n.type,e.appendChild(r),t.appendChild(e)}i.appendChild(t)}else{const e=document.createElement("div");e.className="panel-empty",e.textContent="(empty)",i.appendChild(e)}this.container.appendChild(i)}clear(){this.currentGoal=null,this.container.innerHTML='\n      <div class="panel-placeholder">\n        Select a goal\n      </div>\n    '}getCurrentGoal(){return this.currentGoal}}class o{constructor(e){this.pos=0,this.tokens=e}current(){return this.tokens[this.pos]||{type:"EOF"}}advance(){const e=this.current();return this.pos++,e}expect(e){const t=this.current();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return this.advance()}parse(){const e=this.current();if("LPAREN"===e.type)return this.parseList();if("ATOM"===e.type)return this.parseAtom();if("EOF"===e.type)return{kind:"",value:"",children:[],isAtom:!0,sourceText:"",abbreviation:""};throw new Error(`Unexpected token: ${e.type}`)}parseAtom(){const e=this.expect("ATOM");return{kind:e.value,value:e.value,children:[],isAtom:!0,sourceText:e.value,abbreviation:e.value}}parseList(){this.expect("LPAREN");const e=[],t=["("];for(;"RPAREN"!==this.current().type&&"EOF"!==this.current().type;){const n=this.parse();e.push(n),t.push(n.sourceText)}this.expect("RPAREN"),t.push(")");const n=e.length>0&&e[0].isAtom?e[0].kind:"list",i=t.join(" ").replace(/\( /g,"(").replace(/ \)/g,")"),o=function(e){const t=e.kind,n=e.children;switch(t){case"Π":case"Pi":if(n.length>=3){const e=n[1];if(!e.isAtom&&e.children.length>=2){return`Π (${e.children[0].abbreviation} : ${e.children[1].abbreviation}) ...`}}return"Π ...";case"Σ":case"Sigma":if(n.length>=3){const e=n[1];if(!e.isAtom&&e.children.length>=2){return`Σ (${e.children[0].abbreviation} : ${e.children[1].abbreviation}) ...`}}return"Σ ...";case"Either":return n.length>=3?`Either ${n[1].abbreviation} ${n[2].abbreviation}`:"Either ...";case"left":case"Left":return n.length>=2?`left ${n[1].abbreviation}`:"left ...";case"right":case"Right":return n.length>=2?`right ${n[1].abbreviation}`:"right ...";case"=":return n.length>=4?`= ${n[1].abbreviation} ...`:"= ...";case"λ":case"lambda":if(n.length>=3){const e=n[1];if(!e.isAtom&&e.children.length>=1)return`λ (${e.children[0].abbreviation}) ...`}return"λ ...";case"List":return n.length>=2?`List ${n[1].abbreviation}`:"List ...";case"Vec":return n.length>=3?`Vec ${n[1].abbreviation} ${n[2].abbreviation}`:"Vec ...";case"Pair":return n.length>=3?`Pair ${n[1].abbreviation} ${n[2].abbreviation}`:"Pair ...";case"cons":case"::":return":: ...";case"add1":return n.length>=2?`add1 ${n[1].abbreviation}`:"add1 ...";default:if(n.length>0){const e=n[0].isAtom?n[0].abbreviation:"?";return 1===n.length?`(${e})`:`(${e} ...)`}return"(...)"}}({kind:n,children:e});return{kind:n,children:e,isAtom:!1,sourceText:i,abbreviation:o}}}function r(e){const t=e.toLowerCase();return"Π"===e||"Pi"===e||"→"===e||"->"===e?"pi":"Σ"===e||"Sigma"===e?"sigma":"either"===t||"left"===t||"right"===t?"either":"="===e||"same"===t||"cong"===t||"symm"===t||"trans"===t||"replace"===t?"equality":"list"===t||"::"===e||"nil"===t||"cons"===t?"list":"vec"===t||"vec::"===t||"vecnil"===t||"head"===t||"tail"===t?"vec":"nat"===t||"zero"===t||"add1"===t?"nat":"U"===e||"atom"===t||"trivial"===t||"absurd"===t||"sole"===t?"universe":"λ"===e||"lambda"===t?"lambda":/^[a-z][a-z0-9_-]*$/i.test(e)&&e.length<=10&&e===e.toLowerCase()?"variable":"default"}class s{constructor(e){this.rootNode=null,this.nodeStates=new Map,this.nodeIdCounter=0,this.container=e,this.container.classList.add("type-tree")}render(e){this.clear(),this.nodeIdCounter=0;const t=e.trim();if(t)try{if(this.rootNode=function(e){const t=e.trim();if(!t)return{kind:"",value:"",children:[],isAtom:!0,sourceText:"",abbreviation:""};try{const e=function(e){const t=[];let n=0;for(;n<e.length;){const i=e[n];if(/\s/.test(i)){n++;continue}if("("===i){t.push({type:"LPAREN"}),n++;continue}if(")"===i){t.push({type:"RPAREN"}),n++;continue}let o="";for(;n<e.length&&!/[\s()]/.test(e[n]);)o+=e[n],n++;o&&t.push({type:"ATOM",value:o})}return t.push({type:"EOF"}),t}(t);return new o(e).parse()}catch(e){return{kind:"error",value:t,children:[],isAtom:!0,sourceText:t,abbreviation:t.length>20?t.slice(0,20)+"...":t}}}(t),"error"===this.rootNode.kind)return void this.showPlainText(t);const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}catch(e){this.showPlainText(t)}else this.showPlaceholder("No type to display")}clear(){this.container.innerHTML="",this.rootNode=null,this.nodeStates.clear(),this.nodeIdCounter=0}expandAll(){if(this.nodeStates.forEach(((e,t)=>this.nodeStates.set(t,!0))),this.rootNode){this.container.innerHTML="";const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}}collapseAll(){if(this.nodeStates.forEach(((e,t)=>this.nodeStates.set(t,!1))),this.rootNode){this.container.innerHTML="";const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}}showPlaceholder(e){const t=document.createElement("div");t.className="type-tree__placeholder",t.textContent=e,this.container.appendChild(t)}showPlainText(e){const t=document.createElement("pre");t.className="type-tree__fallback",t.textContent=e,this.container.appendChild(t)}renderNode(e,t){const n="n"+this.nodeIdCounter++;this.nodeStates.has(n)||this.nodeStates.set(n,t<3);const i=this.nodeStates.get(n)??!0;return e.isAtom?this.renderAtom(e):this.renderListNode(e,n,t,i)}renderAtom(e){const t=document.createElement("span");t.className="type-node type-node--atom";const n=document.createElement("span"),i=r(e.kind);return n.className=`type-node__kind type-kind--${i}`,n.textContent=e.value||e.kind,t.appendChild(n),t}renderListNode(e,t,n,i){const o=document.createElement("div");o.className="type-node type-node--list",o.dataset.nodeId=t;const s=e.children,a=s.length>0&&s[0].isAtom&&s[0].kind===e.kind?s.slice(1):s,d=a.length>0,l=document.createElement("div");if(l.className="type-node__header",d){const e=document.createElement("span");e.className="type-node__toggle",e.textContent=i?"▼":"▶",e.addEventListener("click",(e=>{e.stopPropagation(),this.toggleNode(t)})),l.appendChild(e)}else{const e=document.createElement("span");e.className="type-node__toggle-spacer",l.appendChild(e)}const c=document.createElement("span"),u=r(e.kind);if(c.className=`type-node__kind type-kind--${u}`,c.textContent=e.kind,l.appendChild(c),this.isBindingType(e.kind)&&a.length>=2){const e=a[0];if(!e.isAtom&&e.children.length>=2){const t=document.createElement("span");t.className="type-node__binding";const n=e.children[0].value||e.children[0].kind,i=e.children[1].abbreviation;t.textContent=` (${n} : ${i})`,l.appendChild(t)}else if(!e.isAtom&&1===e.children.length){const t=document.createElement("span");t.className="type-node__binding";const n=e.children[0].value||e.children[0].kind;t.textContent=` (${n})`,l.appendChild(t)}}if(!i&&d){const t=document.createElement("span");t.className="type-node__abbrev",t.textContent=" "+this.getCollapsedHint(e,a),l.appendChild(t)}if(o.appendChild(l),d&&i){const t=document.createElement("div");t.className="type-node__children";const i=this.getChildrenToRender(e,a);for(const e of i){const i=this.renderNode(e,n+1);t.appendChild(i)}o.appendChild(t)}return o}isBindingType(e){return"Π"===e||"Pi"===e||"Σ"===e||"Sigma"===e||"λ"===e||"lambda"===e}getChildrenToRender(e,t){return this.isBindingType(e.kind)&&t.length>=2?t.slice(1):t}getCollapsedHint(e,t){if(0===t.length)return"";if(this.isBindingType(e.kind)&&t.length>=2){const e=t[1];return e.isAtom?e.kind:`→ ${e.kind} ...`}return"..."}toggleNode(e){const t=this.nodeStates.get(e)??!0;if(this.nodeStates.set(e,!t),this.rootNode){this.nodeIdCounter=0,this.container.innerHTML="";const e=this.renderNode(this.rootNode,0);this.container.appendChild(e)}}}class a{constructor(e){this.currentGoal=null,this.goalTypeTree=null,this.container=e,this.clear()}display(e){this.currentGoal=e,this.container.innerHTML="";const t=document.createElement("div");t.className="panel-header";const n=document.createElement("div");n.className="panel-title-row";const i=document.createElement("div");i.className="panel-label",i.textContent="Goal",n.appendChild(i);const o=document.createElement("span");o.className="panel-goal-id",o.textContent=e.id,n.appendChild(o),t.appendChild(n);const r=document.createElement("span");r.className="panel-status",e.isComplete?(r.textContent="Completed",r.classList.add("status-completed")):e.isCurrent?(r.textContent="Ongoing",r.classList.add("status-ongoing")):(r.textContent="Pending",r.classList.add("status-pending")),t.appendChild(r),this.container.appendChild(t);const a=document.createElement("div");a.className="panel-content";const d=document.createElement("div");d.className="goal-type-tree",this.goalTypeTree=new s(d),this.goalTypeTree.render(e.type),a.appendChild(d),this.container.appendChild(a)}clear(){this.currentGoal=null,this.goalTypeTree=null,this.container.innerHTML='\n      <div class="panel-placeholder">\n        Select a goal\n      </div>\n    '}getCurrentGoal(){return this.currentGoal}}const d={"Hello World":"(claim zero Nat)\n(define zero zero)\n\n(claim add1zero Nat)\n(define add1zero (add1 zero))","Natural Number Addition":"(claim +\n  (→ Nat Nat Nat))\n\n(claim step-plus\n  (→ Nat Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1)))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus)))\n\n(claim result Nat)\n(define result (+ 2 3))","List Length":"(claim length\n  (Π ((E U))\n    (→ (List E) Nat)))\n\n(claim step-length\n  (Π ((E U))\n    (→ E (List E) Nat Nat)))\n\n(define step-length\n  (λ (E)\n    (λ (e es length-es)\n      (add1 length-es))))\n\n(define length\n  (λ (E)\n    (λ (es)\n      (rec-List es\n        0\n        (step-length E)))))\n\n(claim my-list (List Nat))\n(define my-list (:: 1 (:: 2 (:: 3 nil))))\n\n(claim list-len Nat)\n(define list-len (length Nat my-list))","Either Type":"(claim either-swap\n  (Pi ((A U) (B U))\n    (-> (Either A B)\n        (Either B A))))\n\n(define either-swap\n  (lambda (A B)\n    (lambda (e)\n      (ind-Either e\n        (lambda (x) (Either B A))\n        (lambda (a) (right a))\n        (lambda (b) (left b))))))\n\n(claim test-either (Either Nat Nat))\n(define test-either (left zero))\n\n(claim swapped (Either Nat Nat))\n(define swapped (either-swap Nat Nat test-either))","Vector Map":"(claim vec-map\n  (Π ((A U) (B U) (n Nat))\n     (-> (-> A B) (Vec A n)\n         (Vec B n))))\n\n(define vec-map\n  (λ (A B n)\n    (λ (f vs)\n      (ind-Vec n vs\n        (λ (k xs) (Vec B k))\n        vecnil\n        (λ (k x xs ih) (vec:: (f x) ih))))))\n\n(claim nat-vec (Vec Nat 3))\n(define nat-vec (vec:: 1 (vec:: 2 (vec:: 3 vecnil))))\n\n(claim add1-fn (-> Nat Nat))\n(define add1-fn (λ (n) (add1 n)))\n\n(claim incremented-vec (Vec Nat 3))\n(define incremented-vec (vec-map Nat Nat 3 add1-fn nat-vec))","Tactics: Even or Odd":'\n(claim +\n  (→ Nat Nat\n    Nat))\n\n(claim step-plus\n  (→ Nat\n    Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1 ) ))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus )))\n\n(claim double\n  (→ Nat\n    Nat))\n\n(define double\n  (λ (n)\n    (iter-Nat n\n      0\n      (+ 2))))\n\n(claim Even\n  (→ Nat\n    U ))\n\n(define Even\n  (λ (n)\n    (Σ ((half Nat))\n      (= Nat n (double half )))))\n\n(claim Odd\n  (→ Nat\n    U ))\n\n(define Odd\n  (λ (n)\n    (Σ ((haf Nat))\n      (= Nat n (add1 (double haf )))))) \n\n(claim zero-is-even\n  (Even 0))\n\n(define zero-is-even\n  (cons 0\n    (same 0)))\n\n(claim add1-even->odd\n  (Π ((n Nat))\n    (→ (Even n)\n    (Odd (add1 n)))))\n\n(define add1-even->odd\n  (λ (n en)\n    (cons (car en)\n    (cong (cdr en) (+ 1)))))\n\n(claim add1-odd->even\n  (Π ((n Nat))\n    (→ (Odd n)\n      (Even (add1 n)))))\n\n(define add1-odd->even\n  (λ (n on)\n    (cons (add1 (car on))\n      (cong (cdr on) (+ 1)))))\n\n(claim even-or-odd\n  (Π ((n Nat))\n    (Either (Even n) (Odd n))))\n\n;; This is the proof in The Little Typer\n;; (claim mot-even-or-odd\n;;   (→ Nat U )) \n\n;; (define mot-even-or-odd\n;;   (λ (k) (Either (Even k) (Odd k))))\n\n;; (claim step-even-or-odd\n;;   (Π ((n-1 Nat))\n;;      (→ (mot-even-or-odd n-1)\n;;      (mot-even-or-odd (add1 n-1)))))\n\n;; (define step-even-or-odd\n;;   (λ (n-1)\n;;     (λ (e-or-on-1)\n;;        (ind-Either e-or-on-1\n;;     (λ (e-or-on-1)\n;;        (mot-even-or-odd (add1 n-1)))\n;;        (λ (en-1)\n;;          (right\n;;            (add1-even->odd\n;;              n-1 en-1)))\n;;        (λ (on-1)\n;;          (left\n;;            (add1-odd->even\n;;              n-1 on-1)))))))\n\n;; (define even-or-odd\n;;   (λ (n)\n;;     (ind-Nat n\n;;        mot-even-or-odd\n;;        (left zero-is-even)\n;;        step-even-or-odd)))\n\n\n;; This is the proof using our new tactic system\n(define-tactically even-or-odd\n  ( (intro n)\n    (elimNat n)\n    (left)\n    (exact zero-is-even)\n    (intro n-1)\n    (intro e-or-on-1)\n    (elimEither e-or-on-1)\n    (intro xr)\n    (right)\n    (exact ((add1-even->odd n-1) xr))\n    (intro x1)\n    (left)\n    ;; finish the proof with "(exact ((add1-odd->even n-1) x1))"\n   ))',"Inductive Type: Less Than":";; Define Less Than relation using our new inductive type definiton\n    (data Less-Than () ((j Nat) (k Nat))\n      (zero-smallest ((n Nat)) (Less-Than () (zero (add1 n))))\n      (add1-smaller ((j Nat) (k Nat) (j<k (Less-Than () (j k)))) (Less-Than () ((add1 j) (add1 k))))\n      ind-Less-Than)\n\n    (claim proof-0<1 (Less-Than () (zero (add1 zero))))\n    (define proof-0<1 (zero-smallest zero))\n\n    (claim proof-1<2 (Less-Than () ((add1 zero) (add1 (add1 zero)))))\n    (define proof-1<2 (add1-smaller zero (add1 zero) proof-0<1))\n\n    (claim extract-smaller\n      (Pi ((j Nat) (k Nat))\n        (-> (Less-Than () (j k)) Nat)))\n    (define extract-smaller\n      (lambda (j k proof)\n        (ind-Less-Than proof\n          (lambda (j-idx k-idx p) Nat)\n          (lambda (n) zero)\n          (lambda (j-arg k-arg j<k-arg ih) (add1 ih)))))\n\n    (claim result Nat)\n    (define result (extract-smaller zero (add1 zero) proof-0<1))\n    ","Inductive Type: Subtype":"\n(data Subtype () ((T1 U) (T2 U))\n  (refl ((T U))\n    (Subtype () (T T)))\n  (trans ((T1 U) (T2 U) (T3 U)\n          (p1 (Subtype () (T1 T2)))\n          (p2 (Subtype () (T2 T3))))\n    (Subtype () (T1 T3)))\n  ;; Generic injection: if there exists a function A -> B, then A <: B\n  (inject ((A U) (B U) (f (-> A B)))\n    (Subtype () (A B)))\n  ind-Subtype)\n\n(claim coerce\n  (Pi ((A U) (B U))\n    (-> (Subtype () (A B)) A B)))\n(define coerce\n  (lambda (A B proof val)\n    ((ind-Subtype proof\n      (lambda (t1 t2 sub) (-> t1 t2))\n      (lambda (TT x) x)\n      (lambda (T11 T22 T33 p1 p2 ih1 ih2 x)\n        (ih2 (ih1 x)))\n      (lambda (AA BB ff x) (ff x))\n      )\n      val)))\n\n(data Even () ((n Nat))\n  (zero-even ()\n    (Even () (zero)))\n  (add2-even ((k Nat) (k-even (Even () (k))))\n    (Even () ((add1 (add1 k)))))\n  ind-Even)\n\n(claim even-to-nat\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define even-to-nat\n  (lambda (n proof)\n    (ind-Even proof\n      (lambda (m ev) Nat)\n      zero\n      (lambda (k prev ih) (add1 (add1 ih))))))\n\n(claim even-subtype-nat\n  (Pi ((n Nat))\n    (Subtype () ((Even () (n)) Nat))))\n(define even-subtype-nat\n  (lambda (n)\n    (inject (Even () (n)) Nat (even-to-nat n))))\n\n(claim + (-> Nat Nat Nat))\n(define +\n  (lambda (a b)\n    (rec-Nat a\n      b\n      (lambda (pred ih) (add1 ih)))))\n\n(claim double (-> Nat Nat))\n(define double\n  (lambda (n)\n    (+ n n)))\n\n;; Use Even with double\n(claim double-even\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define double-even\n  (lambda (n ev)\n    (double (coerce (Even () (n)) Nat\n                    (even-subtype-nat n)\n                    ev))))\n\n\n(claim even-four (Even () ((add1 (add1 (add1 (add1 zero)))))))\n(define even-four\n  (add2-even (add1 (add1 zero))\n    (add2-even zero\n      (zero-even))))\n\n(claim result2 Nat)\n(define result2 (double-even (add1 (add1 (add1 (add1 zero)))) even-four))\n        "},l=d["Hello World"],c=document.getElementById("preview-summary"),u=document.getElementById("preview-output");let h=null,m=null,p=null,g=null,v=null,b=null;function f(e,t="neutral"){c&&(c.textContent=e,c.dataset.tone=t)}function y(e,t){t?u.dataset.tone=t:delete u.dataset.tone,u.textContent=void 0===e?"Program is empty.":e}function N(e,t,n){const{diagnostics:i,pretty:o,proofTree:r}=n,s=t.getModel();if(!s)return;const a=i.map((t=>({startLineNumber:t.startLineNumber,startColumn:t.startColumn,endLineNumber:t.endLineNumber,endColumn:t.endColumn,message:t.message,severity:"warning"===t.severity?e.MarkerSeverity.Warning:e.MarkerSeverity.Error})));if(e.editor.setModelMarkers(s,"pie-playground",a),function(e){const t=document.getElementById("proof-tree-container");if(t){if(!e)return t.style.display="none",g&&g.clear(),v&&v.clear(),void(b&&b.clear());t.style.display="flex",g&&g.render(e),v&&v.clear(),b&&b.clear()}}(r),0===i.length)return f("SUCCESS","success"),void y(o?.trim()??void 0,"success");const d=i[0],l="warning"===d.severity?"warning":"error";f("warning"===l?"WARNING":"ERROR",l);y(`${`Line ${d.startLineNumber}, Col ${d.startColumn}`}\n${d.message}`,l)}function w(e,t){let n;return function(...i){window.clearTimeout(n),n=window.setTimeout((()=>e.apply(this,i)),t)}}!async function(){window.require?(window.require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs"}}),window.require(["vs/editor/editor.main"],(async()=>{p=window.monaco;const t=function(e){!function(e){e.languages.register({id:"pie"}),e.languages.setLanguageConfiguration("pie",{comments:{lineComment:";",blockComment:["#|","|#"]},brackets:[["(",")"],["[","]"],["{","}"]],autoClosingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}],surroundingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"{",close:"}"},{open:'"',close:'"'}]}),e.languages.setMonarchTokensProvider("pie",{defaultToken:"",tokenPostfix:".pie",keywords:["lambda","λ","Pi","Π","Sigma","Σ","define","claim","the","check-same","define-tactically","TODO","U","Universe","Nat","Atom","List","Vec","Either","zero","add1","nil","cons","car","cdr","ind-Nat","rec-Nat","iter-Nat","ind-List","rec-List","ind-Vec","rec-Vec","ind-Either","replace","trans","cong","symm","same","left","right","ind-Either","vecnil","vec::"],operators:["->","→","=","::"],symbols:/[=><!~?:&|+\-*/^%]+/,tokenizer:{root:[{include:"@whitespace"},[/\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\b/,"keyword"],[/[a-zA-Z][a-zA-Z0-9\-_!?*+=<>λΠΣ→]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d+/,"number"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string"],[/'[a-zA-Z][a-zA-Z0-9\-_!?*+=<>]*/,"string.quoted"],[/[()[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}]],whitespace:[[/[ \t\r\n]+/,"white"],[/;.*$/,"comment"],[/#\|/,"comment","@comment"]],comment:[[/[^#|]+/,"comment"],[/\|#/,"comment","@pop"],[/[#|]/,"comment"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]]}})}(e);const t=e.editor.create(document.getElementById("editor"),{value:l,language:"pie",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},scrollbar:{vertical:"auto",horizontal:"auto",useShadows:!1,verticalScrollbarSize:6,verticalSliderSize:4},padding:{top:16},fontSize:14,fontFamily:"Menlo, 'Fira Code', 'JetBrains Mono', monospace",smoothScrolling:!0});y(l.trim()),f("Ready for analysis.","neutral");const n=w((e=>{0===e.trim().length?(f("Waiting for input…","neutral"),y(void 0)):(f("Running checks…","warning"),y("Analyzing…"))}),120),i=w((e=>{f("Running checks…","warning"),h&&h.postMessage({type:"analyze",payload:{source:e}})}),220);return t.onDidChangeModelContent((()=>{const e=t.getValue();n(e),i(e)})),t}(p);h=function(e){if(!("Worker"in window))return f("Diagnostics unavailable in this browser.","warning"),null;const t=new Worker("diagnostics-worker.js",{type:"module"});return t.onmessage=t=>{const{type:n,payload:i}=t.data;"diagnostics"===n&&p&&N(p,e,i)},t.onerror=e=>{console.error("Worker error event:",e),console.error("Error details:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno}),f("Diagnostics worker crashed.","error"),y(`Worker failed to load. Check browser console for details.\nError: ${e.message||"Unknown error"}`,"error")},t}(t),function(e){const t=document.getElementById("example-picker");t&&(Object.keys(d).forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)})),t.value="Hello World",t.addEventListener("change",(t=>{const n=t.target.value;n&&d[n]&&e.setValue(d[n])})))}(t),function(e){const t=document.getElementById("copy-btn");t&&t.addEventListener("click",(async()=>{const n=e.getValue();try{await navigator.clipboard.writeText(n),t.textContent="Copied!",t.dataset.copied="true",setTimeout((()=>{t.textContent="Copy",delete t.dataset.copied}),1500)}catch(e){console.error("Failed to copy:",e),t.textContent="Failed",setTimeout((()=>{t.textContent="Copy"}),1500)}}))}(t),function(){const e=document.getElementById("proof-tree-canvas"),t=document.getElementById("proof-context-panel"),o=document.getElementById("proof-goal-panel"),r=document.getElementById("proof-tree-toggle"),s=document.getElementById("proof-tree-container");e&&t&&o?(g=new n(e),v=new i(t),b=new a(o),g.setOnGoalSelect((e=>{v&&v.display(e),b&&b.display(e),g&&g.highlightGoal(e.id)})),r&&s&&r.addEventListener("click",(()=>{const e=s.querySelector(".proof-tree-content");e&&("none"===e.style.display?(e.style.display="flex",r.textContent="Hide"):(e.style.display="none",r.textContent="Show"))}))):console.warn("Proof tree containers not found")}(),p&&await async function(t,n){try{m&&m.isRunning()&&await m.stop(),m=new e(t,n),await m.start(),console.log("LSP client initialized successfully")}catch(e){console.error("Failed to initialize LSP client:",e),f("LSP features unavailable","warning")}}(p,t),h&&h.postMessage({type:"analyze",payload:{source:t.getValue()}}),window.__pieEditor=t}))):console.error("Monaco loader not available")}();
//# sourceMappingURL=app.bundle.js.map
