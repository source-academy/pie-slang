var t;!function(t){t[t.INTEGER=1]="INTEGER",t[t.RATIONAL=2]="RATIONAL",t[t.REAL=3]="REAL",t[t.COMPLEX=4]="COMPLEX"}(t||(t={}));class e{constructor(t){this.result=t}}class n extends e{constructor(t,e){super(t),this.result=t,this.value=e}isSigned(){return!!this.result&&("+"===this.value[0]||"-"===this.value[0])}build(){return c.build(this.value)}}class r extends e{constructor(t,e,n){super(t),this.result=t,this.numerator=e,this.denominator=n}build(){return u.build(this.numerator,this.denominator)}}class s extends e{constructor(t,e,n,r){super(t),this.result=t,this.integer=e,this.decimal=n,this.exponent=r}build(){if(this.integer?.includes("inf"))return this.integer.includes("-")?h.NEG_INFINITY:h.INFINITY;if(this.integer?.includes("nan"))return h.NAN;const t=(this.exponent?this.exponent.build():h.INEXACT_ZERO).coerce();let e=Number((this.integer?this.integer:"0")+"."+(this.decimal?this.decimal:"0"));return e*=Math.pow(10,t),h.build(e)}}class i extends e{constructor(t,e,n,r){super(t),this.result=t,this.real=e,this.sign=n,this.imaginary=r}build(){const t=this.real?this.real.build():c.EXACT_ZERO,e=this.imaginary.build();return this.sign&&"-"===this.sign?l.build(t,e.negate()):l.build(t,e)}}function a(t){const e=new RegExp("^([+-]?)(\\d+)$").exec(t);return e?new n(!0,e[0]):new n(!1)}function o(e,c){const u=a(e);if(u.result&&c>=t.INTEGER)return u;const h=function(t){if(1!==(t.match(/\//g)||[]).length)return new r(!1);const e=t.split("/");if(2!==e.length)return new r(!1);const[n,s]=e,i=a(n),o=a(s);return i.result&&o.result?new r(!0,n,s):new r(!1)}(e);if(h.result&&c>=t.RATIONAL)return h;const l=function(e){function n(t){if(function(t){return"+inf.0"===t||"-inf.0"===t||"+nan.0"===t||"-nan.0"===t}(t))return new s(!0,t);const e=(t.match(/\./g)||[]).length;if(e>1)return new s(!1);if(0===e){const e=a(t);return new s(e.result,e.value)}const[n,r]=t.split("."),i=a(n),o=a(r),c=i.result||""===n,u=o.result||""===r;return"+"===n||"-"===n?""===r?new s(!1):new s(!0,`${n}0`,t):i.result&&u||c&&o.result?o.result&&o.isSigned()?new s(!1):new s(!0,i.value,o.value):new s(!1)}return 0===(e.match(/[eE]/g)||[]).length?n(e):function(e){const r=e.indexOf("e"),i=e.indexOf("E");if(-1===r&&-1===i)return new s(!1);const a=-1===r?i:r,c=e.substring(0,a),u=e.substring(a+1);if(""===c||""==u)return new s(!1);const h=n(c);if(!h.result)return new s(!1);const l=o(u,t.REAL);return l.result?new s(!0,h.integer,h.decimal,l):new s(!1)}(e)}(e);if(l.result&&c>=t.REAL)return l;const p=function(e){if((e.match(/i/g)||[]).length<1)return new i(!1);if("i"!==e[e.length-1])return new i(!1);const n=e.search(/(?<!^)[+-]/);if(-1===n){const n=o(e.slice(0,-1),t.REAL);return n.result?new i(!0,void 0,void 0,n):new i(!1)}const r=e.slice(0,n);let s=e.slice(n+1,-1);"+"!==s[0]&&"-"!==s[0]&&(s="+"+s);const a=o(r,t.REAL),c=o(s,t.REAL);return a.result&&c.result?new i(!0,a,e[n],c):new i(!1)}(e);return p.result&&c>=t.COMPLEX?p:new n(!1)}class c{constructor(e){this.numberType=t.INTEGER,this.value=e}static build(t,e=!1){const n=BigInt(t);return 0n===n?c.EXACT_ZERO:new c(n)}promote(e){switch(e){case t.INTEGER:return this;case t.RATIONAL:return u.build(this.value,1n,!0);case t.REAL:return h.build(this.coerce(),!0);case t.COMPLEX:return l.build(this,c.EXACT_ZERO,!0)}}equals(t){return t instanceof c&&this.value===t.value}greaterThan(t){return this.value>t.value}negate(){return this===c.EXACT_ZERO?this:c.build(-this.value)}multiplicativeInverse(){if(this===c.EXACT_ZERO)throw new Error("Division by zero");return u.build(1n,this.value,!1)}add(t){return c.build(this.value+t.value)}multiply(t){return c.build(this.value*t.value)}getBigInt(){return this.value}coerce(){return this.value>Number.MAX_SAFE_INTEGER?1/0:this.value<Number.MIN_SAFE_INTEGER?-1/0:Number(this.value)}toString(){return this.value.toString()}}c.EXACT_ZERO=new c(0n);class u{constructor(e,n){this.numberType=t.RATIONAL,this.numerator=e,this.denominator=n}static build(t,e,n=!1){return u.simplify(BigInt(t),BigInt(e),n)}static simplify(t,e,n=!1){const r=(t,e)=>0n===e?t:r(e,t.valueOf()%e.valueOf()),s=r(t,e),i=t<0n?-1n:1n,a=e<0n?-1n:1n,o=i*a;return t*=i,1n!==(e*=a)||n?new u(o*t/s,e/s):c.build(o*t)}getNumerator(){return this.numerator}getDenominator(){return this.denominator}promote(e){switch(e){case t.RATIONAL:return this;case t.REAL:return h.build(this.coerce(),!0);case t.COMPLEX:return l.build(this,c.EXACT_ZERO,!0);default:throw new Error("Unable to demote rational")}}equals(t){return t instanceof u&&this.numerator===t.numerator&&this.denominator===t.denominator}greaterThan(t){return this.numerator*t.denominator>t.numerator*this.denominator}negate(){return u.build(-this.numerator,this.denominator)}multiplicativeInverse(){if(0n===this.numerator)throw new Error("Division by zero");return u.build(this.denominator,this.numerator)}add(t){const e=this.numerator*t.denominator+t.numerator*this.denominator,n=this.denominator*t.denominator;return u.build(e,n)}multiply(t){const e=this.numerator*t.numerator,n=this.denominator*t.denominator;return u.build(e,n)}coerce(){const t=this.numerator<0n?-this.numerator:this.numerator;let e=this.denominator;const n=Number(t/e);if(n>Number.MAX_VALUE)return this.numerator<0n?-1/0:1/0;let r=t%e;for(;r>Number.MAX_SAFE_INTEGER||e>Number.MAX_SAFE_INTEGER;)r/=2n,e/=2n;const s=Number(r)/Number(e);return this.numerator<0n?-(n+s):n+s}toString(){return`${this.numerator}/${this.denominator}`}}class h{static build(t,e=!1){return t===1/0?h.INFINITY:t===-1/0?h.NEG_INFINITY:isNaN(t)?h.NAN:0===t?h.INEXACT_ZERO:-0===t?h.INEXACT_NEG_ZERO:new h(t)}constructor(e){this.numberType=t.REAL,this.value=e}promote(e){switch(e){case t.REAL:return this;case t.COMPLEX:return l.build(this,c.EXACT_ZERO,!0);default:throw new Error("Unable to demote real")}}equals(t){return t instanceof h&&this.value===t.value}greaterThan(t){return this.value>t.value}negate(){return h.build(-this.value)}multiplicativeInverse(){if(this===h.INEXACT_ZERO||this===h.INEXACT_NEG_ZERO)throw new Error("Division by zero");return h.build(1/this.value)}add(t){return h.build(this.value+t.value)}multiply(t){return h.build(this.value*t.value)}coerce(){return this.value}toString(){return this===h.INFINITY?"+inf.0":this===h.NEG_INFINITY?"-inf.0":this===h.NAN?"+nan.0":this.value.toString()}}h.INEXACT_ZERO=new h(0),h.INEXACT_NEG_ZERO=new h(-0),h.INFINITY=new h(1/0),h.NEG_INFINITY=new h(-1/0),h.NAN=new h(NaN);class l{static build(t,e,n=!1){return l.simplify(new l(t,e),n)}constructor(e,n){this.numberType=t.COMPLEX,this.real=e,this.imaginary=n}static simplify(t,e){return!e&&y(t.imaginary,c.EXACT_ZERO)?t.real:t}promote(e){if(e===t.COMPLEX)return this;throw new Error("Unable to demote complex")}negate(){return l.build(this.real.negate(),this.imaginary.negate())}equals(t){return y(this.real,t.real)&&y(this.imaginary,t.imaginary)}greaterThan(t){return d(this.real,t.real)&&d(this.imaginary,t.imaginary)}multiplicativeInverse(){const t=m(g(this.real,this.real),g(this.imaginary,this.imaginary));return l.build(g(t.multiplicativeInverse(),this.real),g(t.multiplicativeInverse(),this.imaginary.negate()))}add(t){return l.build(m(this.real,t.real),m(this.imaginary,t.imaginary))}multiply(t){const e=(n=g(this.real,t.real),r=g(this.imaginary,t.imaginary),m(n,function(t){return t.negate()}(r)));var n,r;const s=m(g(this.real,t.imaginary),g(this.imaginary,t.real));return l.build(e,s)}getReal(){return this.real}getImaginary(){return this.imaginary}coerce(){throw new Error("Cannot coerce a complex number to a javascript number")}toPolar(){const e=this.real.promote(t.REAL),n=this.imaginary.promote(t.REAL),r=h.build(Math.sqrt(e.coerce()*e.coerce()+n.coerce()*n.coerce())),s=h.build(Math.atan2(n.coerce(),e.coerce()));return p.build(r,s)}toString(){return`${this.real}+${this.imaginary}i`}}class p{constructor(t,e){this.magnitude=t,this.angle=e}static build(t,e){return new p(t,e)}toCartesian(){const t=h.build(this.magnitude.coerce()*Math.cos(this.angle.coerce())),e=h.build(this.magnitude.coerce()*Math.sin(this.angle.coerce()));return l.build(t,e)}}function f(e){switch(e.numberType){case t.INTEGER:return e;case t.RATIONAL:return 1n===e.getDenominator()?c.build(e.getNumerator()):e;case t.REAL:return e;case t.COMPLEX:return l.build(f(e.getReal()),f(e.getImaginary()))}}function w(t,e){return t.numberType>e.numberType?[t,e.promote(t.numberType)]:t.numberType<e.numberType?[t.promote(e.numberType),e]:[t,e]}function y(t,e){const[n,r]=w(t,e);return n.equals(r)}function d(t,e){const[n,r]=w(t,e);return n.greaterThan(r)}function m(t,e){const[n,r]=w(t,e);return f(n.add(r))}function g(t,e){const[n,r]=w(t,e);return f(n.multiply(r))}h.build(Math.PI),h.build(Math.E),h.build(Math.SQRT2),h.build(Math.LN2),h.build(Math.LN10),h.build(Math.LOG2E),h.build(Math.LOG10E),h.build(Math.SQRT1_2);let v=class t{constructor(t,e){this.start=t,this.end=e}merge(e){return new t(this.start,e.end)}};class T{constructor(t,e){this.line=t,this.column=e}}var E;function N(t,e){return t.split("\n")[e.line-1]}function P(t){return"^".padStart(t.column," ")}!function(t){t[t.LEFT_PAREN=0]="LEFT_PAREN",t[t.RIGHT_PAREN=1]="RIGHT_PAREN",t[t.LEFT_BRACKET=2]="LEFT_BRACKET",t[t.RIGHT_BRACKET=3]="RIGHT_BRACKET",t[t.DOT=4]="DOT",t[t.HASH_SEMICOLON=5]="HASH_SEMICOLON",t[t.IDENTIFIER=6]="IDENTIFIER",t[t.NUMBER=7]="NUMBER",t[t.BOOLEAN=8]="BOOLEAN",t[t.STRING=9]="STRING",t[t.IF=10]="IF",t[t.LET=11]="LET",t[t.COND=12]="COND",t[t.ELSE=13]="ELSE",t[t.DEFINE=14]="DEFINE",t[t.LAMBDA=15]="LAMBDA",t[t.APOSTROPHE=16]="APOSTROPHE",t[t.BACKTICK=17]="BACKTICK",t[t.COMMA=18]="COMMA",t[t.COMMA_AT=19]="COMMA_AT",t[t.QUOTE=20]="QUOTE",t[t.QUASIQUOTE=21]="QUASIQUOTE",t[t.UNQUOTE=22]="UNQUOTE",t[t.UNQUOTE_SPLICING=23]="UNQUOTE_SPLICING",t[t.SET=24]="SET",t[t.BEGIN=25]="BEGIN",t[t.DELAY=26]="DELAY",t[t.IMPORT=27]="IMPORT",t[t.EXPORT=28]="EXPORT",t[t.DEFINE_SYNTAX=29]="DEFINE_SYNTAX",t[t.SYNTAX_RULES=30]="SYNTAX_RULES",t[t.HASH_VECTOR=31]="HASH_VECTOR",t[t.VECTOR=32]="VECTOR",t[t.EOF=33]="EOF"}(E||(E={}));class x extends SyntaxError{constructor(t,e){super(`Syntax error at (${e.line}:${e.column})\n${t}`),this.loc=e}toString(){return this.message}}let b=class extends x{constructor(t,e){super(N(t,e)+"\nUnexpected EOF",e),this.name="UnexpectedEOFError"}};class k extends x{constructor(t,e,n){super(N(t,e)+"\n"+P(e)+"\n"+`Unexpected '${n}'`,e),this.form=n,this.name="UnexpectedTokenError"}}class $ extends x{constructor(t,e,n,r){super(N(t,e)+"\n"+P(e)+"\n"+`Expected '${r}' but got '${n}'`,e),this.form=n,this.expected=r,this.name="ExpectedTokenError"}}class S extends x{constructor(t,e,n,r){super(N(t,e)+"\n"+P(e)+"\n"+`Syntax '${n}' not allowed at Scheme ยง${r}`,e),this.token=n,this.name="DisallowedTokenError"}}class L extends x{constructor(t,e,n){super(N(t,e)+"\n"+P(e)+"\n"+`Syntax '${n}' not supported yet`,e),this.token=n,this.name="UnsupportedTokenError"}}class O{constructor(t){this.elements=t,this.location=new v(this.firstPos(),this.lastPos())}static build(t){if(0===t.length)throw new Error("Illegal empty group. This should never happen.");if(1===t.length){const n=t[0];if(I(n))return n;if((e=n).type!==E.IDENTIFIER&&e.type!==E.NUMBER&&e.type!==E.STRING&&e.type!==E.BOOLEAN)throw new $("",n.pos,n,"<data>");return new O(t)}var e;if(2===t.length){const e=t[0];if(A(e)&&function(t){return t.type===E.APOSTROPHE||t.type===E.BACKTICK||t.type===E.HASH_VECTOR||t.type===E.COMMA||t.type===E.COMMA_AT}(e))return new O(t)}const n=t[0],r=t[t.length-1];if(A(n)&&A(r)&&(i=r,(s=n).type===E.LEFT_PAREN&&i.type===E.RIGHT_PAREN||s.type===E.LEFT_BRACKET&&i.type===E.RIGHT_BRACKET))return new O(t);var s,i;const a=new O(t);throw new $("",a.location.start,a,"matching parentheses")}first(){return this.elements[0]}firstToken(){const t=this.first();return A(t)?t:t.firstToken()}firstPos(){return this.firstToken().pos}last(){return this.elements[this.elements.length-1]}lastToken(){const t=this.last();return A(t)?t:t.lastToken()}lastPos(){return this.lastToken().pos}isParenthesized(){const t=this.first();return A(t)&&(t.type===E.LEFT_PAREN||t.type===E.LEFT_BRACKET)}isSingleIdentifier(){return!this.isParenthesized()&&1===this.length()}unwrap(){return this.isParenthesized()?this.elements.slice(1,this.elements.length-1):this.elements}length(){return this.unwrap().length}toString(){return this.elements.map(t=>t.toString()).join(" ")}}function A(t){return t instanceof B}function I(t){return t instanceof O}class B{constructor(t,e,n,r,s,i,a){this.type=t,this.lexeme=e,this.literal=n,this.start=r,this.end=s,this.pos=new T(i,a),this.endPos=new T(i,a+e.length-1)}convertToken(){switch(this.type){case E.APOSTROPHE:return new B(E.QUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case E.BACKTICK:return new B(E.QUASIQUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case E.HASH_VECTOR:return new B(E.VECTOR,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case E.COMMA:return new B(E.UNQUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case E.COMMA_AT:return new B(E.UNQUOTE_SPLICING,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);default:return this}}toString(){return`${this.lexeme}`}}class C extends SyntaxError{constructor(t,e,n){super(t),this.loc={line:e,column:n}}toString(){return this.message}}class R extends C{constructor(t,e,n){super(`Unexpected character '${n}' (${t}:${e})`,t,e),this.char=n,this.name="UnexpectedCharacterError"}}class M extends C{constructor(t,e){super(`Unexpected EOF (${t}:${e})`,t,e),this.name="UnexpectedEOFError"}}const q=new Map([[".",E.DOT],["if",E.IF],["let",E.LET],["cond",E.COND],["else",E.ELSE],["set!",E.SET],["begin",E.BEGIN],["delay",E.DELAY],["quote",E.QUOTE],["export",E.EXPORT],["import",E.IMPORT],["define",E.DEFINE],["lambda",E.LAMBDA],["define-syntax",E.DEFINE_SYNTAX],["syntax-rules",E.SYNTAX_RULES]]);class _{constructor(t){this.start=0,this.current=0,this.line=1,this.col=0,this.source=t,this.tokens=[]}isAtEnd(){return this.current>=this.source.length}advance(){return this.col++,this.source.charAt(this.current++)}jump(){this.start=this.current,this.col++,this.current++}addToken(t,e=null){const n=this.source.substring(this.start,this.current);this.tokens.push(new B(t,n,e,this.start,this.current,this.line,this.col))}scanTokens(){for(;!this.isAtEnd();)this.start=this.current,this.scanToken();return this.tokens.push(new B(E.EOF,"",null,this.start,this.current,this.line,this.col)),this.tokens}scanToken(){const t=this.advance();switch(t){case"(":this.addToken(E.LEFT_PAREN);break;case")":this.addToken(E.RIGHT_PAREN);break;case"[":this.addToken(E.LEFT_BRACKET);break;case"]":this.addToken(E.RIGHT_BRACKET);break;case"'":this.addToken(E.APOSTROPHE);break;case"`":this.addToken(E.BACKTICK);break;case",":if(this.match("@")){this.addToken(E.COMMA_AT);break}this.addToken(E.COMMA);break;case"#":if(this.match("t")||this.match("f"))this.booleanToken();else if(this.match("|"))this.comment();else if(this.match(";"))this.addToken(E.HASH_SEMICOLON);else{if("("!==this.peek()&&"["!==this.peek())throw new R(this.line,this.col,t);this.addToken(E.HASH_VECTOR)}break;case";":for(;"\n"!=this.peek()&&!this.isAtEnd();)this.advance();break;case" ":case"\r":case"\t":break;case"\n":this.line++,this.col=0;break;case'"':this.stringToken();break;case"|":this.identifierTokenLoose();break;default:if(this.isDigit(t)||"-"===t||"+"===t||"."===t||"i"===t||"n"===t)this.identifierNumberToken();else{if(!this.isValidIdentifier(t))throw new R(this.line,this.col,t);this.identifierToken()}}}comment(){for(;("|"!=this.peek()||"#"!=this.peekNext())&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new M(this.line,this.col);this.jump(),this.jump()}identifierToken(){for(;this.isValidIdentifier(this.peek());)this.advance();this.addToken(this.checkKeyword())}identifierTokenLoose(){for(this.advance();"|"!=this.peek()&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new M(this.line,this.col);this.advance(),this.addToken(this.checkKeyword())}identifierNumberToken(){for(;this.isValidIdentifier(this.peek());)this.advance();const e=this.source.substring(this.start,this.current);o(e,t.COMPLEX).result?this.addToken(E.NUMBER,e):this.addToken(this.checkKeyword())}checkKeyword(){const t=this.source.substring(this.start,this.current);return q.has(t)?q.get(t):E.IDENTIFIER}stringToken(){for(;'"'!=this.peek()&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new M(this.line,this.col);this.advance();const t=this.source.substring(this.start+1,this.current-1);this.addToken(E.STRING,t)}booleanToken(){this.addToken(E.BOOLEAN,"t"===this.peekPrev())}match(t){return!this.isAtEnd()&&(this.source.charAt(this.current)==t&&(this.current++,!0))}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}peekPrev(){return this.current-1<0?"\0":this.source.charAt(this.current-1)}isDigit(t){return t>="0"&&t<="9"}isSpecialSyntax(t){return"("===t||")"===t||"["===t||"]"===t||";"===t||"|"===t}isValidIdentifier(t){return!this.isWhitespace(t)&&!this.isSpecialSyntax(t)}isWhitespace(t){return" "===t||"\0"===t||"\n"===t||"\r"===t||"\t"===t}}var G,z;!function(t){class e{constructor(t,e){this.location=t,this.expressions=e}accept(t){return t.visitSequence(this)}equals(t){if(t instanceof e){if(this.expressions.length!==t.expressions.length)return!1;for(let e=0;e<this.expressions.length;e++)if(!this.expressions[e].equals(t.expressions[e]))return!1;return!0}return!1}}t.Sequence=e;class n{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitNumericLiteral(this)}equals(t){return t instanceof n&&this.value===t.value}}t.NumericLiteral=n;class r{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitBooleanLiteral(this)}equals(t){return t instanceof r&&this.value===t.value}}t.BooleanLiteral=r;class s{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitStringLiteral(this)}equals(t){return t instanceof s&&this.value===t.value}}t.StringLiteral=s;class i{constructor(t,e,n,r=void 0){this.location=t,this.params=n,this.rest=r,this.body=e}accept(t){return t.visitLambda(this)}equals(t){if(t instanceof i){if(this.params.length!==t.params.length)return!1;for(let e=0;e<this.params.length;e++)if(!this.params[e].equals(t.params[e]))return!1;if(this.rest&&t.rest){if(!this.rest.equals(t.rest))return!1}else if(this.rest||t.rest)return!1;return this.body.equals(t.body)}return!1}}t.Lambda=i;class a{constructor(t,e){this.location=t,this.name=e}accept(t){return t.visitIdentifier(this)}equals(t){return t instanceof a&&this.name===t.name}}t.Identifier=a;class o{constructor(t,e,n){this.location=t,this.name=e,this.value=n}accept(t){return t.visitDefinition(this)}equals(t){return t instanceof o&&(this.name.equals(t.name)&&this.value.equals(t.value))}}t.Definition=o;class c{constructor(t,e,n){this.location=t,this.operator=e,this.operands=n}accept(t){return t.visitApplication(this)}equals(t){if(t instanceof c){if(!this.operator.equals(t.operator))return!1;if(this.operands.length!==t.operands.length)return!1;for(let e=0;e<this.operands.length;e++)if(!this.operands[e].equals(t.operands[e]))return!1;return!0}return!1}}t.Application=c;class u{constructor(t,e,n,r){this.location=t,this.test=e,this.consequent=n,this.alternate=r}accept(t){return t.visitConditional(this)}equals(t){return t instanceof u&&(this.test.equals(t.test)&&this.consequent.equals(t.consequent)&&this.alternate.equals(t.alternate))}}t.Conditional=u;class h{constructor(t,e,n){this.location=t,this.car=e,this.cdr=n}accept(t){return t.visitPair(this)}equals(t){return t instanceof h&&(this.car.equals(t.car)&&this.cdr.equals(t.cdr))}}t.Pair=h;class l{constructor(t){this.location=t}accept(t){return t.visitNil(this)}equals(t){return t instanceof l}}t.Nil=l;class p{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitSymbol(this)}equals(t){return t instanceof p&&this.value===t.value}}t.Symbol=p;class f{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitSpliceMarker(this)}equals(t){return t instanceof f&&this.value.equals(t.value)}}t.SpliceMarker=f;class w{constructor(t,e,n){this.location=t,this.name=e,this.value=n}accept(t){return t.visitReassignment(this)}equals(t){return t instanceof w&&(this.name.equals(t.name)&&this.value.equals(t.value))}}t.Reassignment=w;class y{constructor(t,e,n){this.location=t,this.source=e,this.identifiers=n}accept(t){return t.visitImport(this)}equals(t){if(t instanceof y){if(!this.source.equals(t.source))return!1;if(this.identifiers.length!==t.identifiers.length)return!1;for(let e=0;e<this.identifiers.length;e++)if(!this.identifiers[e].equals(t.identifiers[e]))return!1;return!0}return!1}}t.Import=y;class d{constructor(t,e){this.location=t,this.definition=e}accept(t){return t.visitExport(this)}equals(t){return t instanceof d&&this.definition.equals(t.definition)}}t.Export=d;class m{constructor(t,e){this.location=t,this.elements=e}accept(t){return t.visitVector(this)}equals(t){if(t instanceof m){if(this.elements.length!==t.elements.length)return!1;for(let e=0;e<this.elements.length;e++)if(!this.elements[e].equals(t.elements[e]))return!1;return!0}return!1}}t.Vector=m;class g{constructor(t,e,n){this.location=t,this.name=e,this.transformer=n}accept(t){return t.visitDefineSyntax(this)}equals(t){return t instanceof g&&(this.name.equals(t.name)&&this.transformer.equals(t.transformer))}}t.DefineSyntax=g;class v{constructor(t,e,n){this.location=t,this.literals=e,this.rules=n}accept(t){return t.visitSyntaxRules(this)}equals(t){if(t instanceof v){if(this.literals.length!==t.literals.length)return!1;for(let e=0;e<this.literals.length;e++)if(!this.literals[e].equals(t.literals[e]))return!1;if(this.rules.length!==t.rules.length)return!1;for(let e=0;e<this.rules.length;e++)if(!this.rules[e][0].equals(t.rules[e][0])||!this.rules[e][1].equals(t.rules[e][1]))return!1;return!0}return!1}}t.SyntaxRules=v}(G||(G={})),function(t){class e{constructor(t,e,n,r,s=void 0){this.location=t,this.name=e,this.body=n,this.params=r,this.rest=s}accept(t){return t.visitFunctionDefinition(this)}equals(t){if(t instanceof e){if(this.params.length!==t.params.length)return!1;for(let e=0;e<this.params.length;e++)if(!this.params[e].equals(t.params[e]))return!1;if(this.rest&&t.rest){if(!this.rest.equals(t.rest))return!1}else if(this.rest||t.rest)return!1;return this.body.equals(t.body)}return!1}}t.FunctionDefinition=e;class n{constructor(t,e,n,r){this.location=t,this.identifiers=e,this.values=n,this.body=r}accept(t){return t.visitLet(this)}equals(t){if(t instanceof n){if(this.identifiers.length!==t.identifiers.length)return!1;for(let e=0;e<this.identifiers.length;e++)if(!this.identifiers[e].equals(t.identifiers[e]))return!1;if(this.values.length!==t.values.length)return!1;for(let e=0;e<this.values.length;e++)if(!this.values[e].equals(t.values[e]))return!1;return this.body.equals(t.body)}return!1}}t.Let=n;class r{constructor(t,e,n,r){this.location=t,this.predicates=e,this.consequents=n,this.catchall=r}accept(t){return t.visitCond(this)}equals(t){if(t instanceof r){if(this.predicates.length!==t.predicates.length)return!1;for(let e=0;e<this.predicates.length;e++)if(!this.predicates[e].equals(t.predicates[e]))return!1;if(this.consequents.length!==t.consequents.length)return!1;for(let e=0;e<this.consequents.length;e++)if(!this.consequents[e].equals(t.consequents[e]))return!1;return this.catchall&&t.catchall?this.catchall.equals(t.catchall):!this.catchall&&!t.catchall}return!1}}t.Cond=r;class s{constructor(t,e,n=void 0){this.location=t,this.elements=e,this.terminator=n}accept(t){return t.visitList(this)}equals(t){if(t instanceof s){if(this.elements.length!==t.elements.length)return!1;for(let e=0;e<this.elements.length;e++)if(!this.elements[e].equals(t.elements[e]))return!1;return this.terminator&&t.terminator?this.terminator.equals(t.terminator):!this.terminator&&!t.terminator}return!1}}t.List=s;class i{constructor(t,e){this.location=t,this.expressions=e}accept(t){return t.visitBegin(this)}equals(t){if(t instanceof i){if(this.expressions.length!==t.expressions.length)return!1;for(let e=0;e<this.expressions.length;e++)if(!this.expressions[e].equals(t.expressions[e]))return!1;return!0}return!1}}t.Begin=i;class a{constructor(t,e){this.location=t,this.expression=e}accept(t){return t.visitDelay(this)}equals(t){return t instanceof a&&this.expression.equals(t.expression)}}t.Delay=a}(z||(z={}));var U;!function(t){t[t.NONE=0]="NONE",t[t.QUOTE=1]="QUOTE",t[t.QUASIQUOTE=2]="QUASIQUOTE"}(U||(U={}));class H{constructor(t,e,n=1/0){this.current=0,this.quoteMode=U.NONE,this.source=t,this.tokens=e,this.chapter=n}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.current>=this.tokens.length}previous(){return this.tokens[this.current-1]}peek(){return this.tokens[this.current]}validateChapter(t,e){if(this.chapter<e)throw new S(this.source,t.pos,t,this.chapter)}toLocation(t){return new v(t.pos,t.endPos)}destructureList(t,e=t=>{}){if(0===t.length)return[[],void 0];if(1===t.length)return e(t[0]),[[this.parseExpression(t[0])],void 0];const n=t.at(-2);if(A(n)&&n.type===E.DOT){const n=t.at(-1),r=t.slice(0,-2);return e(n),r.forEach(e),[r.map(this.parseExpression.bind(this)),this.parseExpression(n)]}const r=t;return r.forEach(e),[r.map(this.parseExpression.bind(this)),void 0]}grouping(t){const e=[];let n=!1;t&&(n=!0,e.push(t));do{const t=this.advance();switch(t.type){case E.LEFT_PAREN:case E.LEFT_BRACKET:const r=this.grouping(t);e.push(r);break;case E.RIGHT_PAREN:case E.RIGHT_BRACKET:if(!n)throw new k(this.source,t.pos,t);e.push(t),n=!1;break;case E.APOSTROPHE:case E.BACKTICK:case E.COMMA:case E.COMMA_AT:case E.HASH_VECTOR:let s;do{s=this.grouping()}while(!s);e.push(this.affect(t,s));break;case E.QUOTE:case E.QUASIQUOTE:case E.UNQUOTE:case E.UNQUOTE_SPLICING:case E.IDENTIFIER:case E.NUMBER:case E.BOOLEAN:case E.STRING:case E.DOT:case E.DEFINE:case E.IF:case E.ELSE:case E.COND:case E.LAMBDA:case E.LET:case E.SET:case E.BEGIN:case E.DELAY:case E.IMPORT:case E.EXPORT:case E.DEFINE_SYNTAX:case E.SYNTAX_RULES:e.push(t);break;case E.HASH_SEMICOLON:for(;!this.grouping(););break;case E.EOF:throw new b(this.source,t.pos);default:throw new k(this.source,t.pos,t)}}while(n);if(0!==e.length)try{return O.build(e)}catch(t){if(t instanceof $)throw new $(this.source,t.loc,t.form,t.expected);throw t}}affect(t,e){return O.build([t,e])}parseExpression(t){return A(t)?this.parseToken(t):t.isSingleIdentifier()?this.parseToken(t.unwrap()[0]):this.parseGroup(t)}parseToken(t){switch(t.type){case E.IDENTIFIER:return this.quoteMode===U.NONE?new G.Identifier(this.toLocation(t),t.lexeme):new G.Symbol(this.toLocation(t),t.lexeme);case E.NUMBER:return new G.NumericLiteral(this.toLocation(t),t.literal);case E.BOOLEAN:return new G.BooleanLiteral(this.toLocation(t),t.literal);case E.STRING:return new G.StringLiteral(this.toLocation(t),t.literal);default:if(this.quoteMode!==U.NONE||this.chapter>=5)return new G.Symbol(this.toLocation(t),t.lexeme);throw new k(this.source,t.pos,t)}}parseGroup(t){if(!t.isParenthesized())return this.parseAffectorGroup(t);switch(this.quoteMode){case U.NONE:return this.parseNormalGroup(t);case U.QUOTE:case U.QUASIQUOTE:return this.parseQuotedGroup(t)}}parseAffectorGroup(t){const[e,n]=t.unwrap();switch(e.type){case E.APOSTROPHE:case E.QUOTE:if(this.validateChapter(e,2),this.quoteMode!==U.NONE){const t=this.parseExpression(n),r=new G.Symbol(this.toLocation(e),"quote"),s=r.location.merge(t.location);return new z.List(s,[r,t])}this.quoteMode=U.QUOTE;const r=this.parseExpression(n);return this.quoteMode=U.NONE,r;case E.BACKTICK:case E.QUASIQUOTE:if(this.validateChapter(e,2),this.quoteMode!==U.NONE){const t=this.parseExpression(n),r=new G.Symbol(this.toLocation(e),"quasiquote"),s=r.location.merge(t.location);return new z.List(s,[r,t])}this.quoteMode=U.QUASIQUOTE;const s=this.parseExpression(n);return this.quoteMode=U.NONE,s;case E.COMMA:case E.UNQUOTE:this.validateChapter(e,2);const i=this.quoteMode;if(i===U.NONE)throw new L(this.source,e.pos,e);if(i===U.QUOTE){const t=this.parseExpression(n),r=new G.Symbol(this.toLocation(e),"unquote"),s=r.location.merge(t.location);return new z.List(s,[r,t])}this.quoteMode=U.NONE;const a=this.parseExpression(n);return this.quoteMode=i,a;case E.COMMA_AT:case E.UNQUOTE_SPLICING:this.validateChapter(e,2);const o=this.quoteMode;if(o===U.NONE)throw new k(this.source,e.pos,e);if(o===U.QUOTE){const t=this.parseExpression(n),r=new G.Symbol(this.toLocation(e),"unquote-splicing"),s=r.location.merge(t.location);return new z.List(s,[r,t])}this.quoteMode=U.NONE;const c=this.parseExpression(n);this.quoteMode=o;const u=this.toLocation(e).merge(c.location);return new G.SpliceMarker(u,c);case E.HASH_VECTOR:this.validateChapter(e,3);const h=this.quoteMode;this.quoteMode=U.QUOTE;const l=this.parseVector(t);return this.quoteMode=h,l;default:throw new k(this.source,e.pos,e)}}parseNormalGroup(t){if(0===t.length()){if(this.chapter>=5)return new G.Nil(t.location);throw new $(this.source,t.location.start,t,"non-empty group")}const e=t.unwrap()[0];if(A(e))switch(e.type){case E.LAMBDA:return this.validateChapter(e,1),this.parseLambda(t);case E.DEFINE:return this.validateChapter(e,1),this.parseDefinition(t);case E.IF:return this.validateChapter(e,1),this.parseConditional(t);case E.LET:return this.validateChapter(e,1),this.parseLet(t);case E.COND:return this.validateChapter(e,1),this.parseExtendedCond(t);case E.QUOTE:case E.APOSTROPHE:case E.QUASIQUOTE:case E.BACKTICK:case E.UNQUOTE:case E.COMMA:case E.UNQUOTE_SPLICING:case E.COMMA_AT:return this.validateChapter(e,2),this.parseAffectorGroup(t);case E.BEGIN:return this.validateChapter(e,3),this.parseBegin(t);case E.DELAY:return this.validateChapter(e,3),this.parseDelay(t);case E.SET:return this.validateChapter(e,3),this.parseSet(t);case E.DEFINE_SYNTAX:return this.validateChapter(e,5),this.parseDefineSyntax(t);case E.SYNTAX_RULES:throw new k(this.source,e.pos,e);case E.IMPORT:return this.validateChapter(e,1),this.parseImport(t);case E.EXPORT:return this.validateChapter(e,1),this.parseExport(t);case E.VECTOR:return this.validateChapter(e,3),this.parseAffectorGroup(t);default:return this.parseApplication(t)}return this.parseApplication(t)}parseQuotedGroup(t){if(0===t.length())return new G.Nil(t.location);if(1===t.length()){const e=[this.parseExpression(t.unwrap()[0])];return new z.List(t.location,e)}const e=t.unwrap(),[n,r]=this.destructureList(e);return new z.List(t.location,n,r)}parseLambda(t){if(t.length()<3)throw new $(this.source,t.location.start,t,"(lambda (<identifier>* . <rest-identifier>?) <body>+) | (lambda <rest-identifer> <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);let s,i=[];if(A(n)){if(n.type!==E.IDENTIFIER)throw new $(this.source,n.pos,n,"<rest-identifier>");s=new G.Identifier(this.toLocation(n),n.lexeme)}else{const t=n.unwrap();[i,s]=this.destructureList(t,t=>{if(!A(t))throw new $(this.source,t.pos,t,"<identifier>");if(t.type!==E.IDENTIFIER)throw new $(this.source,t.pos,t,"<identifier>")})}const a=r.map(this.parseExpression.bind(this));if(a.length<1)throw new $(this.source,t.location.start,t,"(lambda ... <body>+)");if(1===a.length)return new G.Lambda(t.location,a[0],i,s);const o=a.at(0).location.merge(a.at(-1).location),c=new G.Sequence(o,a);return new G.Lambda(t.location,c,i,s)}parseDefinition(t){if(t.length()<3)throw new $(this.source,t.location.start,t,"(define <identifier> <expr>) | (define (<identifier> <formals>) <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);let s,i,a=[],o=!1;if(I(n)){o=!0;const t=n.unwrap(),e=t[0],r=t.splice(1);if(!A(e))throw new $(this.source,e.location.start,e,"<identifier>");if(e.type!==E.IDENTIFIER)throw new $(this.source,e.pos,e,"<identifier>");s=new G.Identifier(this.toLocation(e),e.lexeme),[a,i]=this.destructureList(r,t=>{if(!A(t))throw new $(this.source,t.pos,t,"<identifier>");if(t.type!==E.IDENTIFIER)throw new $(this.source,t.pos,t,"<identifier>")})}else{if(n.type!==E.IDENTIFIER)throw new $(this.source,n.pos,n,"<identifier>");s=new G.Identifier(this.toLocation(n),n.lexeme),o=!1}if(r.length<1)throw new $(this.source,t.location.start,t,"(define ... <body>+)");if(o){const e=r.map(this.parseExpression.bind(this));if(1===e.length)return new z.FunctionDefinition(t.location,s,e[0],a,i);const n=e.at(0).location.merge(e.at(-1).location),o=new G.Sequence(n,e);return new z.FunctionDefinition(t.location,s,o,a,i)}if(r.length>1)throw new $(this.source,t.location.start,t,"(define <identifier> <expr>)");const c=this.parseExpression(r[0]);return new G.Definition(t.location,s,c)}parseConditional(t){if(t.length()<3||t.length()>4)throw new $(this.source,t.location.start,t,"(if <pred> <cons> <alt>?)");const e=t.unwrap(),n=e[1],r=e[2],s=t.length()>3?e[3]:void 0,i=this.parseExpression(n),a=this.parseExpression(r),o=s?this.parseExpression(s):new G.Identifier(t.location,"undefined");return new G.Conditional(t.location,i,a,o)}parseApplication(t){if(t.length()<1)throw new $(this.source,t.location.start,t,"(<func> <args>*)");const e=t.unwrap(),n=e[0],r=e.splice(1),s=this.parseExpression(n),i=[];for(const t of r)i.push(this.parseExpression(t));return new G.Application(t.location,s,i)}parseLet(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach(t=>{this.parseExpression(t)}),new z.Let(t.location,[],[],new G.Identifier(t.location,"undefined"))}if(t.length()<3)throw new $(this.source,t.location.start,t,"(let ((<identifier> <value>)*) <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);if(!I(n))throw new $(this.source,n.pos,n,"((<identifier> <value>)*)");const s=[],i=[],a=n.unwrap();for(const t of a){if(!I(t))throw new $(this.source,t.pos,t,"(<identifier> <value>)");if(2!==t.length())throw new $(this.source,t.location.start,t,"(<identifier> <value>)");const[e,n]=t.unwrap();if(!A(e))throw new $(this.source,e.location.start,e,"<identifier>");if(e.type!==E.IDENTIFIER)throw new $(this.source,e.pos,e,"<identifier>");s.push(new G.Identifier(this.toLocation(e),e.lexeme)),i.push(this.parseExpression(n))}const o=r.map(this.parseExpression.bind(this));if(o.length<1)throw new $(this.source,t.location.start,t,"(let ... <body>+)");if(1===o.length)return new z.Let(t.location,s,i,o[0]);const c=o.at(0).location.merge(o.at(-1).location),u=new G.Sequence(c,o);return new z.Let(t.location,s,i,u)}parseExtendedCond(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach(t=>{this.parseExpression(t)}),new z.Cond(t.location,[],[],new G.Identifier(t.location,"undefined"))}if(t.length()<2)throw new $(this.source,t.location.start,t,"(cond (<pred> <body>*)* (else <val>)?)");const e=t.unwrap().splice(1),n=e.pop(),r=[],s=[];for(const t of e){if(!I(t))throw new $(this.source,t.pos,t,"(<pred> <body>*)");if(t.length()<1)throw new $(this.source,t.firstToken().pos,t.firstToken(),"(<pred> <body>*)");const[e,...n]=t.unwrap();if(A(e)&&e.type===E.ELSE)throw new $(this.source,e.pos,e,"<predicate>");const i=this.parseExpression(e),a=n.map(this.parseExpression.bind(this)),o=n.length<1?i.location:a.at(0).location.merge(a.at(-1).location),c=n.length<1?i:n.length<2?a[0]:new G.Sequence(o,a);r.push(i),s.push(c)}if(!I(n))throw new $(this.source,n.pos,n,"(<pred> <body>+) | (else <val>)");if(n.length()<2)throw new $(this.source,n.firstToken().pos,n.firstToken(),"(<pred> <body>+) | (else <val>)");const[i,...a]=n.unwrap();let o=!1;if(A(i)&&i.type===E.ELSE&&(o=!0,1!==a.length))throw new $(this.source,n.location.start,n,"(else <val>)");if(a.length<1)throw new $(this.source,n.location.start,n,"(<pred> <body>+)");const c=a.map(this.parseExpression.bind(this)),u=c.at(0).location.merge(c.at(-1).location),h=1===a.length?c[0]:new G.Sequence(u,c);if(o)return new z.Cond(t.location,r,s,h);const l=this.parseExpression(i);return r.push(l),s.push(h),new z.Cond(t.location,r,s)}parseSet(t){if(3!==t.length())throw new $(this.source,t.location.start,t,"(set! <identifier> <expr>)");const e=t.unwrap(),n=e[1],r=e[2];if(I(n))throw new $(this.source,n.location.start,n,"<identifier>");if(n.type!==E.IDENTIFIER)throw new $(this.source,n.pos,n,"<identifier>");const s=new G.Identifier(this.toLocation(n),n.lexeme),i=this.parseExpression(r);return new G.Reassignment(t.location,s,i)}parseBegin(t){if(t.length()<2)throw new $(this.source,t.location.start,t,"(begin <body>+)");const e=t.unwrap().slice(1),n=[];for(const t of e)n.push(this.parseExpression(t));return new z.Begin(t.location,n)}parseDelay(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach(t=>{this.parseExpression(t)}),new z.Delay(t.location,new G.Identifier(t.location,"undefined"))}if(2!==t.length())throw new $(this.source,t.location.start,t,"(delay <expr>)");const e=t.unwrap()[1],n=this.parseExpression(e);return new z.Delay(t.location,n)}parseDefineSyntax(t){if(3!==t.length())throw new $(this.source,t.location.start,t,"(define-syntax <identifier> <transformer>)");const e=t.unwrap(),n=e[1],r=e[2];this.quoteMode=U.QUOTE;const s=this.parseExpression(n);if(this.quoteMode=U.NONE,!(s instanceof G.Symbol))throw new $(this.source,s.location.start,n,"<identifier>");if(!I(r))throw new $(this.source,r.pos,r,"<transformer>");if(r.length()<2)throw new $(this.source,r.firstToken().pos,r,"(syntax-rules ...)");const i=r.unwrap()[0];if(!A(r.unwrap()[0]))throw new $(this.source,r.firstToken().pos,i,"syntax-rules");if(i.type!==E.SYNTAX_RULES)throw new $(this.source,i.pos,i,"syntax-rules");const a=this.parseSyntaxRules(r);return new G.DefineSyntax(t.location,s,a)}isValidPattern(t){if(t instanceof z.List){if(void 0===t.terminator){if(t.elements.filter(t=>t instanceof G.Symbol&&"..."===t.value).length>1)return!1;const e=t.elements.findIndex(t=>t instanceof G.Symbol&&"..."===t.value);if(-1!=e&&0===e)return!1;for(const e of t.elements)if(!this.isValidPattern(e))return!1;return!0}{if(t.elements.filter(t=>t instanceof G.Symbol&&"..."===t.value).length>1)return!1;const e=t.elements.findIndex(t=>t instanceof G.Symbol&&"..."===t.value);if(-1!=e){if(0===e)return!1;if(e===t.elements.length-1)return!1}for(const e of t.elements)if(!this.isValidPattern(e))return!1;return this.isValidPattern(t.terminator)}}return t instanceof G.Symbol||t instanceof G.BooleanLiteral||t instanceof G.NumericLiteral||t instanceof G.StringLiteral||t instanceof G.Nil}isValidTemplate(t){if(t instanceof z.List){if(void 0===t.terminator){if(0===t.elements.length)return!1;if(2===t.elements.length&&t.elements[0]instanceof G.Symbol&&"..."===t.elements[0].value)return this.isValidTemplate(t.elements[1]);let e=!1;for(let n=0;n<t.elements.length;n++){const r=t.elements[n];if(r instanceof G.Symbol&&"..."===r.value){if(e){e=!1;continue}return!1}if(!this.isValidTemplate(r))return!1;e=!0}return!0}{if(0===t.elements.length)return!1;let e=!1;for(let n=0;n<t.elements.length;n++){const r=t.elements[n];if(r instanceof G.Symbol&&"..."===r.value){if(e){e=!1;continue}return!1}if(!this.isValidTemplate(r))return!1;e=!0}return this.isValidTemplate(t.terminator)}}return t instanceof G.Symbol||t instanceof G.BooleanLiteral||t instanceof G.NumericLiteral||t instanceof G.StringLiteral||t instanceof G.Nil}parseSyntaxRules(t){if(t.length()<3)throw new $(this.source,t.location.start,t,"(syntax-rules (<literal>*) <syntax-rule>+)");const e=t.unwrap(),n=e[1],r=e.slice(2),s=[];if(!I(n))throw new $(this.source,n.pos,n,"(<literal>*)");this.quoteMode=U.QUOTE;for(const t of n.unwrap()){if(!A(t))throw new $(this.source,t.location.start,t,"<literal>");const e=this.parseExpression(t);if(!(e instanceof G.Symbol))throw new $(this.source,t.pos,t,"<literal>");s.push(e)}const i=[];for(const t of r){if(!I(t))throw new $(this.source,t.pos,t,"(<pattern> <template>)");if(2!==t.length())throw new $(this.source,t.location.start,t,"(<pattern> <template>)");const[e,n]=t.unwrap(),r=this.parseExpression(e),s=this.parseExpression(n);if(!this.isValidPattern(r))throw new $(this.source,r.location.start,e,"<symbol> | <literal> | (<pattern>+) | (<pattern>+ ... <pattern>*) | (<pattern>+ ... <pattern>+ . <pattern>)");if(!this.isValidTemplate(s))throw new $(this.source,s.location.start,n,"<symbol> | <literal> | (<element>+) | (<element>+ . <template>) | (... <template>)");i.push([r,s])}return this.quoteMode=U.NONE,new G.SyntaxRules(t.location,s,i)}parseImport(t){if(3!==t.length())throw new $(this.source,t.firstToken().pos,t.firstToken(),'(import "<source>" (<identifier>*))');const e=t.unwrap(),n=e[1],r=e[2];if(!A(n))throw new $(this.source,n.location.start,n,'"<source>"');if(n.type!==E.STRING)throw new $(this.source,n.pos,n,'"<source>"');if(!I(r))throw new $(this.source,r.pos,r,"(<identifier>*)");const s=r.unwrap(),i=[];for(const t of s){if(!A(t))throw new $(this.source,t.location.start,t,"<identifier>");if(t.type!==E.IDENTIFIER)throw new $(this.source,t.pos,t,"<identifier>");i.push(new G.Identifier(this.toLocation(t),t.lexeme))}const a=new G.StringLiteral(this.toLocation(n),n.literal);return new G.Import(t.location,a,i)}parseExport(t){if(2!==t.length())throw new $(this.source,t.firstToken().pos,t.firstToken(),"(export (<definition>))");const e=t.unwrap()[1];if(!I(e))throw new $(this.source,e.pos,e,"(<definition>)");const n=this.parseExpression(e);if(!(n instanceof G.Definition||n instanceof z.FunctionDefinition))throw new $(this.source,e.location.start,e,"(<definition>)");return new G.Export(t.location,n)}parseVector(t){const e=t.unwrap()[1].unwrap().map(this.parseExpression.bind(this));return new G.Vector(t.location,e)}parse(t=!1){t&&(this.quoteMode=U.QUOTE,this.current=0);const e=[];for(;!this.isAtEnd()&&this.peek().type!==E.EOF;){const t=this.grouping();if(!t)continue;const n=this.parseExpression(t);e.push(n)}if(this.chapter>=5&&!t){return[...e.filter(t=>t instanceof G.Import),...this.parse(!0).filter(t=>!(t instanceof z.List&&t.elements&&t.elements[0]instanceof G.Symbol&&"import"===t.elements[0].value))]}return e}}class D{constructor(t,e,n,r,s){this.source=t,this.startLine=e,this.startColumn=n,this.endLine=r,this.endColumn=s}}class F{constructor(t,e,n){this.start=t,this.end=e,this.source=n}}class V{constructor(t,e){this.syntax=t,this.forInfo=e}locationToSrcLoc(){return new D(this.syntax.source,this.syntax.start.line,this.syntax.start.column,this.syntax.end.line,this.syntax.end.column)}toString(){return`${this.syntax.source}:${this.syntax.start.line}:${this.syntax.start.column}`}}function Q(t){return new V(t.syntax,!1)}function X(t,e,n){return new Map([...t,[e,n]])}function K(t,e){return e.valOf(W(t))}function j(t){const e=new Map;for(const[n,r]of t)r instanceof st?e.set(n,["free",r.type.readBackType(t)]):r instanceof rt?e.set(n,["def",r.type.readBackType(t),xt(t,r.type,r.value)]):r instanceof nt&&e.set(n,["claim",r.type.readBackType(t)]);return e}function Y(t,e,n,r){const s=new Hn("typeOut");return Dn([[new Hn("_"),()=>function(t,e,n){return t.has(n)?new Un(e,new _n([`The name "${n}" is already in use in the context.`])):new zn(!0)}(t,n,e)],[s,()=>r.isType(t,new Map)]],()=>new zn(X(t,e,new nt(K(t,s.value)))))}function Z(t,e,n,r){const s=new Hn("typeOut"),i=new Hn("exprOut");return Dn([[s,()=>function(t,e,n){for(const[r,s]of t)if(r===n){if(s instanceof rt)return new Un(e,new _n([`The name "${n}" is already defined.`]));if(s instanceof nt)return new zn(s.type)}return new Un(e,new _n([`No claim: ${n}`]))}(t,n,e)],[i,()=>r.check(t,new Map,s.value)]],()=>new zn(ut(function(t,e){return t.delete(e),t}(t,e),e,s.value,K(t,i.value))))}function W(t){if(0===t.size)return new Map;const e=t.entries(),n=new Map;for(const[t,r]of e)r instanceof rt?n.set(t,r.value):r instanceof st?n.set(t,new Ee(r.type,new $t(t))):r instanceof it&&n.set(t,r.type);return n}function J(t,e,n){for(const[e,r]of t)if(r instanceof it&&e===n)return new zn(r);return new Un(e,new _n([`No inductive type found for ${n} at ${e}`]))}const tt=new Map;class et{}let nt=class extends et{constructor(t){super(),this.type=t}};class rt extends et{constructor(t,e){super(),this.type=t,this.value=e}}class st extends et{constructor(t){super(),this.type=t}}class it extends et{constructor(t,e){super(),this.name=t,this.type=e}}class at extends et{constructor(t,e,n){super(),this.name=t,this.constructorType=e,this.type=n}}function ot(t,e,n){if(0===t.size)throw new Error(`The context ${JSON.stringify(t)} is empty, but we are looking for ${n}`);for(const[e,r]of t.entries())if(!(r instanceof nt)&&n===e)return new zn(r instanceof it?new Ne:r.type);throw new Error(`Unknown variable ${n}`)}function ct(t,e,n){if(t.has(e)){for(const[r]of t)if(r===e)return X(t,e,new st(n));throw new Error(`\n      ${e} is already bound in ${JSON.stringify(t)}\n    `)}return X(t,e,new st(n))}function ut(t,e,n,r){return X(t,e,new rt(n,r))}function ht(t,e,n){return new Map([...t,[e,n]])}function lt(t,e){const n=t.now();if(n instanceof oe)return n.body.valOfClosure(e);if(n instanceof Ee){const t=n.type.now();if(t instanceof ae)return new Ee(t.resultType.valOfClosure(e),new Zt(n.neutral,new bt(t.argType,e)))}throw new Error(`doApp: invalid input ${[n,e.now()]}`)}function pt(t,e,n,r){const s=t.now();if(s instanceof se)return n;if(s instanceof ie)return lt(r,pt(s.smaller,e,n,r));if(s instanceof Ee){if(s.type.now()instanceof re)return new Ee(e,new Ot(s.neutral,new bt(e,n),new bt(new ae("n",new re,new Qn(t=>e)),r)))}throw new Error(`invalid input for iterNat ${[t,e,n,r]}`)}function ft(t,e,n,r){const s=t.now();if(s instanceof se)return n;if(s instanceof ie)return lt(lt(r,s.smaller),ft(s.smaller,e,n,r));if(s instanceof Ee){if(s.type.now()instanceof re)return new Ee(e,new At(s.neutral,new bt(e,n),new bt(new ae("n-1",new re,new Qn(t=>new ae("ih",e,new Qn(t=>e)))),r)))}throw new Error(`invalid input for recNat ${[t,e,n,r]}`)}function wt(t,e,n,r){const s=t.now();if(s instanceof se)return n;if(s instanceof ie)return lt(lt(r,s.smaller),wt(s.smaller,e,n,r));if(s instanceof Ee){if(s.type.now()instanceof re)return new Ee(lt(e,t),new It(s.neutral,new bt(new ae("x",new re,new Qn(t=>new Ne)),e),new bt(lt(e,new se),n),new bt(new ae("n-1",new re,new Qn(t=>new ae("ih",lt(e,t),new Qn(n=>lt(e,new ie(t)))))),r)))}throw new Error(`invalid input for indNat ${[t,e,n,r]}`)}function yt(t){const e=t.now();if(e instanceof ue)return e.car;if(e instanceof Ee){const t=e.type.now();if(t instanceof ce){const n=t,r=e.neutral;return new Ee(n.carType,new Bt(r))}}throw new Error(`invalid input for car ${t}`)}function dt(t){const e=t.now();if(e instanceof ue)return e.cdr;if(e instanceof Ee){const n=e.type.now();if(n instanceof ce){const r=n,s=e.neutral;return new Ee(r.cdrType.valOfClosure(yt(t)),new Ct(s))}}throw new Error(`invalid input for cdr ${t}`)}function mt(t,e,n,r){const s=t.now();if(s instanceof le)return n;if(s instanceof pe)return lt(lt(lt(r,s.head),s.tail),mt(s.tail,e,n,r));if(s instanceof Ee){const i=s.type.now();if(i instanceof he){const a=i.entryType,o=s.neutral,c=new ae("xs",new he(a),new Qn(t=>new Ne));return new Ee(lt(e,t),new Mt(o,new bt(c,e),new bt(lt(e,new le),n),new bt(new ae("h",a,new Qn(t=>new ae("t",new he(a),new Qn(n=>new ae("ih",lt(e,n),new Qn(r=>lt(e,new pe(t,n)))))))),r)))}}throw new Error(`invalid input for indList ${[s,e,n,r]}`)}function gt(t,e,n,r){const s=t.now();if(s instanceof le)return n;if(s instanceof pe){const t=s.head,i=s.tail;return lt(lt(lt(r,t),i),gt(i,e,n,r))}if(s instanceof Ee){const t=s.type.now();if(t instanceof he){const i=t.entryType,a=s.neutral;return new Ee(e,new Rt(a,new bt(e,n),new bt(new ae("h",i,new Qn(t=>new ae("t",new he(i),new Qn(t=>new ae("ih",e,new Qn(t=>e)))))),r)))}}throw new Error(`invalid input for recList ${[s,e,n,r]}`)}function vt(t){const e=t.now();if(e instanceof me)return e.tail;if(e instanceof Ee&&e.type.now()instanceof ye&&e.type.now().length.now()instanceof ie){const t=e.type.now();if(t instanceof ye){if(t.length.now()instanceof ie)return new Ee(new ye(e.type.now().entryType,e.type.now().length.now().smaller),new Qt(e.neutral))}}throw new Error(`invalid input for tail ${t.prettyPrint()}`)}function Tt(t,e){return new ae("k",new re,new Qn(n=>new ae("e",t,new Qn(r=>new ae("es",new ye(t,n),new Qn(t=>new ae("ih",lt(lt(e,n),t),new Qn(s=>lt(lt(e,new ie(n)),new me(r,t))))))))))}function Et(t,e,n,r,s){const i=t.now(),a=e.now();if(i instanceof se&&a instanceof de)return r;if(i instanceof ie&&a instanceof me)return lt(lt(lt(lt(s,i.smaller),a.head),vt(e)),Et(i.smaller,a.tail,n,r,s));if(i instanceof Ee&&a instanceof Ee&&i.type.now()instanceof re&&a.type.now()instanceof ye){const o=a.type.now().entryType;return new Ee(lt(lt(n,t),e),new Kt(i.neutral,a.neutral,new bt(new ae("k",new re,new Qn(t=>new ae("es",new ye(o,t),new Qn(t=>new Ne)))),n),new bt(lt(lt(n,new se),new de),r),new bt(Tt(a.type.now().entryType,n),s)))}if(Pt(i,t)&&a instanceof Ee&&a.type.now()instanceof ye){const i=a.type.now().entryType;return new Ee(lt(lt(n,t),e),new Xt(new bt(new re,t),a.neutral,new bt(new ae("k",new re,new Qn(t=>new ae("es",new ye(i,t),new Qn(t=>new Ne)))),n),new bt(lt(lt(n,new re),new de),r),new bt(Tt(i,n),s)))}throw new Error(`invalid input for indVec ${[t,e,n,r,s]}`)}function Nt(t,e,n,r,s,i){const a=e.now();if(a instanceof Le){if(a.type!=t)throw new Error(`doEliminator: wrong eliminator used. Got constructor of type: ${a.type}; Expected: ${t}`);const e=a.index;if(e>=0&&e<r.length){let o=r[e];for(let t=0;t<a.args.length;t++){o=lt(o,a.args[t].now())}for(let e=0;e<a.recursive_args.length;e++){const c=a.recursive_args[e].now();o=lt(o,c);o=lt(o,Nt(t,c,n,r,s,i))}return o}}else if(a instanceof Ee){const o=a.type.now();if(o instanceof $e&&o.name===t){let c=n;for(const t of o.indices)c=lt(c,t);return c=lt(c,e),new Ee(c,new Yt(t,a.neutral,new bt(i||new ae("x",o,new Qn(t=>new Ne)),n),r.map((t,e)=>new bt(s&&s[e]?s[e]:o,t))))}}throw new Error(`doEliminator: invalid input for ${t}: ${[e,n,r]}`)}function Pt(t,e){const n=t.now(),r=e.now();return n instanceof se&&r instanceof se||n instanceof ie&&r instanceof ie&&Pt(n.smaller,r.smaller)}function xt(t,e,n){const r=e.now(),s=n.now();if(r instanceof Ne)return n.readBackType(t);if(r instanceof re&&s instanceof se)return new Re;if(r instanceof re&&s instanceof ie)return new Me(xt(t,new re,s.smaller));if(r instanceof ae){const e=jn(t,s instanceof oe?s.argName:r.argName);return new He(e,xt(ct(t,e,r.argType),r.resultType.valOfClosure(new Ee(r.argType,new $t(e))),lt(s,new Ee(r.argType,new $t(e)))))}if(r instanceof ce){const e=yt(n),s=dt(n);return new Qe(xt(t,r.carType,e),xt(t,r.cdrType.valOfClosure(e),s))}if(r instanceof Pe&&s instanceof ne)return new Fe(s.name);if(r instanceof xe)return new en;if(r instanceof he&&s instanceof le)return new Ye;if(r instanceof he&&s instanceof pe)return new Qe(xt(t,r.entryType,s.head),xt(t,new he(r.entryType),s.tail));if(r instanceof ke&&s instanceof Ee)return new Ie(new nn,s.neutral.readBackNeutral(t));if(r instanceof fe&&s instanceof we)return new an(xt(t,r.type,s.value));if(r instanceof ye&&r.length.now()instanceof se&&s instanceof de)return new wn;if(r instanceof ye&&r.length.now()instanceof ie&&s instanceof me)return r.length.now(),new fn(xt(t,r.entryType,s.head),xt(t,new ye(r.entryType,r.length.now().smaller),s.tail));if(r instanceof ge&&s instanceof ve)return new vn(xt(t,r.leftType,s.value));if(r instanceof ge&&s instanceof Te)return new Tn(xt(t,r.rightType,s.value));if(r instanceof $e&&s instanceof Le){let e;for(const[n,r]of t)if(n===s.name&&r instanceof at){e=r;break}if(!e)throw new Error(`Constructor ${s.name} not found in context`);const n=e.constructorType,i=n.resultType;let a=W(t);for(let t=0;t<i.parameters.length;t++){const e=i.parameters[t];if(e instanceof xn){a=ht(a,e.name,r.parameters[t].now())}}for(let t=0;t<i.indices.length;t++){const e=i.indices[t];if(e instanceof xn){a=ht(a,e.name,r.indices[t].now())}}const o=e.type,c=[];o.indices.forEach(t=>{c.push(...Wn(t))});const u=[];for(let e=0;e<s.args.length;e++){const r=xt(t,n.argTypes[e].valOf(a).now(),s.args[e]);if(u.push(r),e<c.length){a=ht(a,c[e],s.args[e].now())}}const h=[],l=s.args.length;for(let e=0;e<s.recursive_args.length;e++){const r=xt(t,n.rec_argTypes[e].valOf(a).now(),s.recursive_args[e]);h.push(r);const i=l+e;if(i<c.length){a=ht(a,c[i],s.recursive_args[e].now())}}return new $n(s.name,s.index,s.type,u,h)}if(s instanceof Ee)return s.neutral.readBackNeutral(t);throw new Error(`Cannot read back ${s.prettyPrint()} : ${r.prettyPrint()}`)}class bt{constructor(t,e){this.type=t,this.value=e}}let kt=class{constructor(){}toString(){return this.prettyPrint()}};class $t extends kt{constructor(t){super(),this.name=t}readBackNeutral(t){return new xn(this.name)}prettyPrint(){return`N-${this.name}`}}let St=class extends kt{constructor(t,e){super(),this.where=t,this.type=e}readBackNeutral(t){return new Nn(this.where,this.type.readBackType(t))}prettyPrint(){return"N-TODO"}},Lt=class extends kt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new qe(this.target.readBackNeutral(t),new Ie(this.base.type.readBackType(t),xt(t,this.base.type,this.base.value)),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-WhichNat"}},Ot=class extends kt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new _e(this.target.readBackNeutral(t),new Ie(this.base.type.readBackType(t),xt(t,this.base.type,this.base.value)),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IterNat"}},At=class extends kt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new Ge(this.target.readBackNeutral(t),new Ie(this.base.type.readBackType(t),xt(t,this.base.type,this.base.value)),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-RecNat"}},It=class extends kt{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}readBackNeutral(t){return new ze(this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.base.type,this.base.value),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndNat"}},Bt=class extends kt{constructor(t){super(),this.target=t}readBackNeutral(t){return new Xe(this.target.readBackNeutral(t))}prettyPrint(){return"N-Car"}},Ct=class extends kt{constructor(t){super(),this.target=t}readBackNeutral(t){return new Ke(this.target.readBackNeutral(t))}prettyPrint(){return"N-Cdr"}},Rt=class extends kt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new We(this.target.readBackNeutral(t),new Ie(this.base.type.readBackType(t),xt(t,this.base.type,this.base.value)),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-RecList"}},Mt=class extends kt{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}readBackNeutral(t){return new Je(this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.base.type,this.base.value),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndList"}},qt=class extends kt{constructor(t,e){super(),this.target=t,this.motive=e}readBackNeutral(t){return new rn(new Ie(new nn,this.target.readBackNeutral(t)),xt(t,this.motive.type,this.motive.value))}prettyPrint(){return"N-IndAbsurd"}},_t=class extends kt{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}readBackNeutral(t){return new on(this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.base.type,this.base.value))}prettyPrint(){return"N-Replace"}};class Gt extends kt{constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new cn(this.target1.readBackNeutral(t),xt(t,this.target2.type,this.target2.value))}prettyPrint(){return"N-Trans1"}}class zt extends kt{constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new cn(xt(t,this.target1.type,this.target1.value),this.target2.readBackNeutral(t))}prettyPrint(){return"N-Trans2"}}class Ut extends kt{constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new cn(this.target1.readBackNeutral(t),this.target2.readBackNeutral(t))}prettyPrint(){return"N-Trans12"}}let Ht=class extends kt{constructor(t,e){super(),this.target=t,this.func=e}readBackNeutral(t){const e=this.func.type;if(e instanceof ae){const n=e.resultType;return new un(this.target.readBackNeutral(t),n.valOfClosure(new ke).readBackType(t),xt(t,this.func.type,this.func.value))}throw new Error("Cong applied to non-Pi type.")}prettyPrint(){return"N-Cong"}},Dt=class extends kt{constructor(t){super(),this.target=t}readBackNeutral(t){return new hn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Symm"}},Ft=class extends kt{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}readBackNeutral(t){return new ln(this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.base.type,this.base.value))}prettyPrint(){return"N-IndEqual"}},Vt=class extends kt{constructor(t){super(),this.target=t}readBackNeutral(t){return new yn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Head"}},Qt=class extends kt{constructor(t){super(),this.target=t}readBackNeutral(t){return new dn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Tail"}};class Xt extends kt{constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}readBackNeutral(t){return new mn(xt(t,this.length.type,this.length.value),this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.base.type,this.base.value),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndVec2"}}class Kt extends kt{constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}readBackNeutral(t){return new mn(this.length.readBackNeutral(t),this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.base.type,this.base.value),xt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndVec12"}}let jt=class extends kt{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.baseLeft=n,this.baseRight=r}readBackNeutral(t){return new En(this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),xt(t,this.baseLeft.type,this.baseLeft.value),xt(t,this.baseRight.type,this.baseRight.value))}prettyPrint(){return"N-IndEither"}};class Yt extends kt{constructor(t,e,n,r){super(),this.typeName=t,this.target=e,this.motive=n,this.methods=r}readBackNeutral(t){return new Ln(this.typeName,this.target.readBackNeutral(t),xt(t,this.motive.type,this.motive.value),this.methods.map(e=>xt(t,e.type,e.value)))}prettyPrint(){return`N-GenericEliminator-${this.typeName}`}}let Zt=class extends kt{constructor(t,e){super(),this.operator=t,this.operand=e}readBackNeutral(t){return new Pn(this.operator.readBackNeutral(t),xt(t,this.operand.type,this.operand.value))}prettyPrint(){return"N-Application"}};class Wt{now(){return this}}class Jt{constructor(t,e){this.env=t,this.expr=e}undelay(){return this.expr.valOf(this.env).now()}toString(){return`DelayClosure(${this.env}, ${this.expr})`}}class te{constructor(t){this.content=t}get(){return this.content}set(t){this.content=t}}class ee extends Wt{constructor(t){super(),this.val=t}now(){const t=this.val.get();if(t instanceof Jt){const e=t.undelay();return this.val.set(e),e}return t}readBackType(t){return this.now().readBackType(t)}prettyPrint(){return this.now().prettyPrint()}toString(){return`Delay(${this.val})`}}let ne=class extends Wt{constructor(t){super(),this.name=t}readBackType(t){throw new Error("No readBackType for Quote.")}prettyPrint(){return`'${this.name}`}toString(){return this.prettyPrint()}},re=class extends Wt{constructor(){super()}readBackType(t){return new Ce}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}},se=class extends Wt{constructor(){super()}readBackType(t){throw new Error("No readBackType for Zero.")}prettyPrint(){return"zero"}toString(){return this.prettyPrint()}},ie=class extends Wt{constructor(t){super(),this.smaller=t}readBackType(t){throw new Error("No readBackType for Add1.")}prettyPrint(){return`(add1 ${this.smaller.prettyPrint()})`}toString(){return this.prettyPrint()}},ae=class extends Wt{constructor(t,e,n){super(),this.argName=t,this.argType=e,this.resultType=n}readBackType(t){const e=this.argType.readBackType(t),n=jn(t,this.argName),r=ct(t,n,this.argType);return new Ue(n,e,this.resultType.valOfClosure(new Ee(this.argType,new $t(n))).readBackType(r))}prettyPrint(){return`(ฮ ${this.argName} ${this.argType.prettyPrint()} ${this.resultType.prettyPrint()})`}toString(){return this.prettyPrint()}},oe=class extends Wt{constructor(t,e){super(),this.argName=t,this.body=e}readBackType(t){throw new Error("No readBackType for Lambda.")}prettyPrint(){return`(lambda ${this.argName} ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},ce=class extends Wt{constructor(t,e,n){super(),this.carName=t,this.carType=e,this.cdrType=n}readBackType(t){const e=this.carType.readBackType(t),n=jn(t,this.carName),r=ct(t,n,this.carType);return new Ve(n,e,this.cdrType.valOfClosure(new Ee(this.carType,new $t(n))).readBackType(r))}prettyPrint(){return`(ฮฃ ${this.carName} ${this.carType.prettyPrint()} ${this.cdrType.prettyPrint()})`}toString(){return this.prettyPrint()}},ue=class extends Wt{constructor(t,e){super(),this.car=t,this.cdr=e}readBackType(t){throw new Error("No readBackType for Cons.")}prettyPrint(){return`(cons ${this.car.prettyPrint()} ${this.cdr.prettyPrint()})`}toString(){return this.prettyPrint()}},he=class extends Wt{constructor(t){super(),this.entryType=t}readBackType(t){return new Ze(this.entryType.readBackType(t))}prettyPrint(){return`(List ${this.entryType.prettyPrint()})`}toString(){return this.prettyPrint()}},le=class extends Wt{constructor(){super()}readBackType(t){throw new Error("No readBackType for Nil.")}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}},pe=class extends Wt{constructor(t,e){super(),this.head=t,this.tail=e}readBackType(t){throw new Error("No readBackType for ListCons.")}prettyPrint(){return`(:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},fe=class extends Wt{constructor(t,e,n){super(),this.type=t,this.from=e,this.to=n}readBackType(t){return new sn(this.type.readBackType(t),xt(t,this.type,this.from),xt(t,this.type,this.to))}prettyPrint(){return`(= ${this.type.prettyPrint()} ${this.from.prettyPrint()} ${this.to.prettyPrint()})`}toString(){return this.prettyPrint()}},we=class extends Wt{constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Same.")}prettyPrint(){return`(same ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},ye=class extends Wt{constructor(t,e){super(),this.entryType=t,this.length=e}readBackType(t){return new pn(this.entryType.readBackType(t),xt(t,new re,this.length))}prettyPrint(){return`(Vec ${this.entryType.prettyPrint()} ${this.length.prettyPrint()})`}},de=class extends Wt{constructor(){super()}readBackType(t){throw new Error("No readBackType for VecNil.")}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}},me=class extends Wt{constructor(t,e){super(),this.head=t,this.tail=e}readBackType(t){throw new Error("No readBackType for VecCons.")}prettyPrint(){return`(vec:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},ge=class extends Wt{constructor(t,e){super(),this.leftType=t,this.rightType=e}readBackType(t){return new gn(this.leftType.readBackType(t),this.rightType.readBackType(t))}prettyPrint(){return`(Either ${this.leftType.prettyPrint()} ${this.rightType.prettyPrint()})`}toString(){return this.prettyPrint()}},ve=class extends Wt{constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Left.")}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Te=class extends Wt{constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Right.")}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}};class Ee extends Wt{constructor(t,e){super(),this.type=t,this.neutral=e}readBackType(t){return this.neutral.readBackNeutral(t)}prettyPrint(){return`(Neutral ${this.type.prettyPrint()} ${this.neutral.prettyPrint()})`}toString(){return this.prettyPrint()}}let Ne=class extends Wt{constructor(){super()}readBackType(t){return new Be}prettyPrint(){return"U"}toString(){return this.prettyPrint()}},Pe=class extends Wt{constructor(){super()}readBackType(t){return new De}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}},xe=class extends Wt{constructor(){super()}readBackType(t){return new tn}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}},be=class extends Wt{constructor(){super()}readBackType(t){throw new Error("No readBackType for Sole.")}prettyPrint(){return"sole"}toString(){return this.prettyPrint()}},ke=class extends Wt{constructor(){super()}readBackType(t){return new nn}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}},$e=class extends Wt{constructor(t,e,n){super(),this.name=t,this.parameters=e,this.indices=n}readBackType(t){const e=require("../evaluator/utils").readBack,{InductiveDatatypeBinder:n}=require("../utils/context"),r=t.get(this.name);let s=[];if(r&&r instanceof n){const t=r.type;t instanceof Se&&(s=t.indexTypes)}return new bn(this.name,this.parameters.map(e=>e.readBackType(t)),this.indices.map((n,r)=>{const i=s[r]?.now();if(!(n instanceof ee)){const r=n.now();if(i)return e(t,i,r);if(r instanceof Ee)return r.neutral.readBackNeutral(t);throw new Error(`Cannot read back index without type: ${r.prettyPrint()}`)}{const r=n.val.get();if(!(r instanceof Jt)){const n=r;if(i)return e(t,i,n);if(n instanceof Ee)return n.neutral.readBackNeutral(t);throw new Error(`Cannot read back index without type: ${n.prettyPrint()}`)}try{const s=n.now();return i?e(t,i,s):s instanceof Ee?s.neutral.readBackNeutral(t):r.expr}catch(t){return r.expr}}}))}prettyPrint(){return`InductiveType ${this.name}`}toString(){return this.prettyPrint()}},Se=class extends Wt{constructor(t,e,n){super(),this.name=t,this.parameterTypes=e,this.indexTypes=n}readBackType(t){return new kn(this.name,this.parameterTypes.map(e=>e.readBackType(t)),this.indexTypes.map(e=>e.readBackType(t)))}prettyPrint(){return`InductiveType ${this.name}`}toString(){return this.prettyPrint()}},Le=class extends Wt{constructor(t,e,n,r,s){super(),this.name=t,this.type=e,this.args=n,this.index=r,this.recursive_args=s}readBackType(t){throw new Error("No readBackType for Constructor.")}prettyPrint(){const t=this.args.map(t=>t.prettyPrint()).join(" ");return`(${this.name}${t.length>0?" "+t:""})`}toString(){return this.prettyPrint()}},Oe=class extends Wt{constructor(t,e,n,r,s,i,a,o){super(),this.name=t,this.index=e,this.type=n,this.argTypes=r,this.rec_argTypes=s,this.resultType=i,this.argNames=a,this.rec_argNames=o}readBackType(t){throw Error("Method not implemented")}prettyPrint(){return`ConstructorType (${this.argTypes.map(t=>t.prettyPrint()).join(" ")})`}};class Ae{toLazy(t){return new ee(new te(new Jt(t,this)))}}let Ie=class extends Ae{constructor(t,e){super(),this.type=t,this.expr=e}valOf(t){return this.expr.valOf(t)}prettyPrint(){return`(the ${this.type.prettyPrint()} ${this.expr.prettyPrint()})`}toString(){return this.prettyPrint()}},Be=class extends Ae{valOf(t){return new Ne}prettyPrint(){return"U"}toString(){return this.prettyPrint()}},Ce=class extends Ae{valOf(t){return new re}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}},Re=class extends Ae{valOf(t){return new se}prettyPrint(){return"0"}toString(){return this.prettyPrint()}},Me=class extends Ae{constructor(t){super(),this.n=t}valOf(t){return new ie(this.n.toLazy(t))}prettyPrint(){const t=Number(this.n.prettyPrint());return isNaN(t)?`(add1 ${this.n.prettyPrint()})`:`${t+1}`}toString(){return this.prettyPrint()}},qe=class extends Ae{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return function(t,e,n,r){const s=t.now();if(s instanceof se)return n;if(s instanceof ie)return lt(r,s.smaller);if(s instanceof Ee&&s.type.now()instanceof re)return new Ee(e,new Lt(s.neutral,new bt(e,n),new bt(new ae("n",new re,new Qn(t=>e)),r)));throw new Error(`invalid input for whichNat ${[t,e,n,r]}`)}(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(which-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},_e=class extends Ae{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return pt(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(iter-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Ge=class extends Ae{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return ft(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(rec-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},ze=class extends Ae{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}valOf(t){return wt(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(ind-Nat ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Ue=class extends Ae{constructor(t,e,n){super(),this.name=t,this.type=e,this.body=n}valOf(t){const e=this.type.toLazy(t);return new ae(this.name,e,new Vn(t,this.name,this.body))}prettyPrint(){return`(ฮ (${this.name} ${this.type.prettyPrint()}) \n          ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},He=class extends Ae{constructor(t,e){super(),this.param=t,this.body=e}valOf(t){return new oe(this.param,new Vn(t,this.param,this.body))}prettyPrint(){return`(ฮป (${this.param}) ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},De=class extends Ae{valOf(t){return new Pe}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}},Fe=class extends Ae{constructor(t){super(),this.sym=t}valOf(t){return new ne(this.sym)}prettyPrint(){return`'${this.sym}`}toString(){return this.prettyPrint()}},Ve=class extends Ae{constructor(t,e,n){super(),this.name=t,this.type=e,this.body=n}valOf(t){const e=this.type.toLazy(t);return new ce(this.name,e,new Vn(t,this.name,this.body))}prettyPrint(){return`(ฮฃ (${this.name} ${this.type.prettyPrint()}) \n              ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},Qe=class extends Ae{constructor(t,e){super(),this.first=t,this.second=e}valOf(t){const e=this.first.toLazy(t),n=this.second.toLazy(t);return new ue(e,n)}prettyPrint(){return`(cons ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}},Xe=class extends Ae{constructor(t){super(),this.pair=t}valOf(t){return yt(this.pair.toLazy(t))}prettyPrint(){return`(car ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}},Ke=class extends Ae{constructor(t){super(),this.pair=t}valOf(t){return dt(this.pair.toLazy(t))}prettyPrint(){return`(cdr ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}},je=class extends Ae{constructor(t,e){super(),this.head=t,this.tail=e}valOf(t){const e=this.head.toLazy(t),n=this.tail.toLazy(t);return new pe(e,n)}prettyPrint(){return`(:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},Ye=class extends Ae{valOf(t){return new le}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}},Ze=class extends Ae{constructor(t){super(),this.elemType=t}valOf(t){return new he(this.elemType.toLazy(t))}prettyPrint(){return`(List ${this.elemType.prettyPrint()})`}toString(){return this.prettyPrint()}},We=class extends Ae{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return gt(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(rec-List ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Je=class extends Ae{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}valOf(t){return mt(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(ind-List ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},tn=class extends Ae{valOf(t){return new xe}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}},en=class extends Ae{valOf(t){return new be}prettyPrint(){return"sole"}toString(){return this.prettyPrint()}},nn=class extends Ae{valOf(t){return new ke}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}},rn=class extends Ae{constructor(t,e){super(),this.target=t,this.motive=e}valOf(t){return function(t,e){const n=t.now();if(n instanceof Ee&&n.type.now()instanceof ke)return new Ee(e,new qt(n.neutral,new bt(new Ne,e)));throw new Error(`invalid input for indAbsurd ${[t,e]}`)}(this.target.toLazy(t),this.motive.toLazy(t))}prettyPrint(){return`(ind-Absurd \n              ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()})`}toString(){return this.prettyPrint()}},sn=class extends Ae{constructor(t,e,n){super(),this.type=t,this.left=e,this.right=n}valOf(t){return new fe(this.type.toLazy(t),this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(= ${this.type.prettyPrint()} \n              ${this.left.prettyPrint()} \n              ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},an=class extends Ae{constructor(t){super(),this.type=t}valOf(t){return new we(this.type.toLazy(t))}prettyPrint(){return`(same ${this.type.prettyPrint()})`}toString(){return this.prettyPrint()}},on=class extends Ae{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof we)return n;if(r instanceof Ee){const t=r.type.now();if(t instanceof fe){const s=r.neutral,i=t.type,a=t.from,o=t.to;return new Ee(lt(e,o),new _t(s,new bt(new ae("x",i,new Qn(t=>new Ne)),e),new bt(lt(e,a),n)))}}throw new Error(`invalid input for replace ${[t,e,n]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t))}prettyPrint(){return`(replace ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}},cn=class extends Ae{constructor(t,e){super(),this.left=t,this.right=e}valOf(t){return function(t,e){const n=t.now(),r=e.now();if(n instanceof we&&r instanceof we)return new we(n.value);if(n instanceof we&&r instanceof Ee){const t=r.type.now();if(t instanceof fe){const e=n.value,s=t.to,i=t.type,a=r.neutral;return new Ee(new fe(i,e,s),new zt(new bt(new fe(i,e,e),new we(e)),a))}}else if(n instanceof Ee&&r instanceof we){const t=n.type.now();if(t instanceof fe){const e=t.from,s=r.value,i=t.type,a=n.neutral;return new Ee(new fe(i,e,s),new Gt(a,new bt(new fe(i,s,s),new we(s))))}}else if(n instanceof Ee&&r instanceof Ee){const t=n.type.now(),e=r.type.now();if(t instanceof fe&&e instanceof fe){const s=t.from,i=e.to,a=t.type,o=n.neutral,c=r.neutral;return new Ee(new fe(a,s,i),new Ut(o,c))}}throw new Error(`invalid input for do-trans: ${[t,e]}`)}(this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(trans ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},un=class extends Ae{constructor(t,e,n){super(),this.target=t,this.base=e,this.fun=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof we)return new we(lt(n,r.value));if(r instanceof Ee){const t=r.type.now();if(t instanceof fe){const s=t.type,i=t.from,a=t.to,o=r.neutral;return new Ee(new fe(e,lt(n,i),lt(n,a)),new Ht(o,new bt(new ae("x",s,new Qn(t=>e)),n)))}}throw new Error(`invalid input for cong ${[t,e,n]}`)}(this.target.toLazy(t),this.base.toLazy(t),this.fun.toLazy(t))}prettyPrint(){return`(cong ${this.target.prettyPrint()} ${this.fun.prettyPrint()})`}toString(){return this.prettyPrint()}},hn=class extends Ae{constructor(t){super(),this.equality=t}valOf(t){return function(t){const e=t.now();if(e instanceof we)return new we(e.value);if(e instanceof Ee){const t=e.type.now();if(t instanceof fe)return new Ee(new fe(t.type,t.to,t.from),new Dt(e.neutral))}throw new Error(`invalid input for symm ${t}`)}(this.equality.toLazy(t))}prettyPrint(){return`(symm ${this.equality.prettyPrint()})`}toString(){return this.prettyPrint()}},ln=class extends Ae{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof we)return n;if(r instanceof Ee){const s=r.type.now();if(s instanceof fe){const i=s.type,a=s.from,o=s.to,c=r.neutral;return new Ee(lt(lt(e,o),t),new Ft(c,new bt(new ae("to",i,new Qn(t=>new ae("p",new fe(i,a,t),new Qn(t=>new Ne)))),e),new bt(lt(lt(e,a),new we(a)),n)))}}throw new Error(`invalid input for indEqual ${[t,e,n]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t))}prettyPrint(){return`(ind-= ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}},pn=class extends Ae{constructor(t,e){super(),this.type=t,this.length=e}valOf(t){return new ye(this.type.toLazy(t),this.length.toLazy(t))}prettyPrint(){return`(Vec ${this.type.prettyPrint()} ${this.length.prettyPrint()})`}toString(){return this.prettyPrint()}},fn=class extends Ae{constructor(t,e){super(),this.head=t,this.tail=e}valOf(t){return new me(this.head.toLazy(t),this.tail.toLazy(t))}prettyPrint(){return`(vec:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},wn=class extends Ae{valOf(t){return new de}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}},yn=class extends Ae{constructor(t){super(),this.vec=t}valOf(t){return function(t){const e=t.now();if(e instanceof me)return e.head;if(e instanceof Ee){const t=e.type.now();if(t instanceof ye&&t.length.now()instanceof ie)return new Ee(t.entryType,new Vt(e.neutral))}throw new Error(`invalid input for head ${t}`)}(this.vec.toLazy(t))}prettyPrint(){return`(head ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}},dn=class extends Ae{constructor(t){super(),this.vec=t}valOf(t){return vt(this.vec.toLazy(t))}prettyPrint(){return`(tail ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}},mn=class extends Ae{constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}valOf(t){return Et(this.length.toLazy(t),this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`ind-Vec ${this.length.prettyPrint()}\n              ${this.target.prettyPrint()}\n              ${this.motive.prettyPrint()}\n              ${this.base.prettyPrint()}\n              ${this.step.prettyPrint()}`}toString(){return this.prettyPrint()}},gn=class extends Ae{constructor(t,e){super(),this.left=t,this.right=e}valOf(t){return new ge(this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(Either ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},vn=class extends Ae{constructor(t){super(),this.value=t}valOf(t){return new ve(this.value.toLazy(t))}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Tn=class extends Ae{constructor(t){super(),this.value=t}valOf(t){return new Te(this.value.toLazy(t))}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},En=class extends Ae{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.baseLeft=n,this.baseRight=r}valOf(t){return function(t,e,n,r){const s=t.now();if(s instanceof ve)return lt(n,s.value);if(s instanceof Te)return lt(r,s.value);if(s instanceof Ee){const i=s.type.now();if(i instanceof ge){const a=i.leftType,o=i.rightType,c=new ae("x",new ge(a,o),new Qn(t=>new Ne));return new Ee(lt(e,t),new jt(s.neutral,new bt(c,e),new bt(new ae("x",a,new Qn(t=>lt(e,new ve(t)))),n),new bt(new ae("x",o,new Qn(t=>lt(e,new Te(t)))),r)))}}throw new Error(`invalid input for indEither: ${[t,e,n,r]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.baseLeft.toLazy(t),this.baseRight.toLazy(t))}prettyPrint(){return`(ind-Either ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.baseLeft.prettyPrint()} \n              ${this.baseRight.prettyPrint()})`}toString(){return this.prettyPrint()}},Nn=class extends Ae{constructor(t,e){super(),this.loc=t,this.type=e}valOf(t){return new Ee(this.type.toLazy(t),new St(this.loc,this.type.toLazy(t)))}prettyPrint(){return`TODO ${this.type.prettyPrint()}`}toString(){return this.prettyPrint()}},Pn=class extends Ae{constructor(t,e){super(),this.fun=t,this.arg=e}valOf(t){return lt(this.fun.toLazy(t),this.arg.toLazy(t))}prettyPrint(){return`(${this.fun.prettyPrint()} ${this.arg.prettyPrint()})`}toString(){return this.prettyPrint()}};class xn extends Ae{constructor(t){super(),this.name=t}valOf(t){if(Xn(this.name))return function(t,e){if(t.has(e))return t.get(e);throw new Error(`Variable ${e} not found in environment`)}(t,this.name);throw new Error(`${this.name} is not a valid variable name`)}prettyPrint(){return this.name}toString(){return this.prettyPrint()}}let bn=class extends Ae{valOf(t){return new $e(this.typeName,this.parameters.map(e=>e.toLazy(t)),this.indices.map(e=>e.toLazy(t)))}constructor(t,e,n){super(),this.typeName=t,this.parameters=e,this.indices=n}prettyPrint(){return`${this.typeName}${this.parameters.length>0?" "+this.parameters.map(t=>t.prettyPrint()).join(" "):""}${this.indices.length>0?" "+this.indices.map(t=>t.prettyPrint()).join(" "):""}`}toString(){return this.prettyPrint()}},kn=class extends Ae{valOf(t){return new Se(this.typeName,this.parameterTypes.map(e=>e.toLazy(t)),this.indexTypes.map(e=>e.toLazy(t)))}constructor(t,e,n){super(),this.typeName=t,this.parameterTypes=e,this.indexTypes=n}prettyPrint(){return`${this.typeName}${this.parameterTypes.length>0?" "+this.parameterTypes.map(t=>t.prettyPrint()).join(" "):""}${this.indexTypes.length>0?" "+this.indexTypes.map(t=>t.prettyPrint()).join(" "):""}`}};class $n extends Ae{constructor(t,e,n,r,s){super(),this.name=t,this.index=e,this.type=n,this.args=r,this.recursive_args=s}valOf(t){return new Le(this.name,this.type,this.args.map(e=>e.toLazy(t)),this.index,this.recursive_args.map(e=>e.toLazy(t)))}prettyPrint(){const t=this.args.map(t=>t.prettyPrint()).join(" ");return`(${this.name}${t.length>0?" "+t:""})`}}class Sn extends Ae{constructor(t,e,n,r,s,i,a,o){super(),this.name=t,this.index=e,this.type=n,this.argTypes=r,this.rec_argTypes=s,this.resultType=i,this.argNames=a,this.rec_argNames=o}valOf(t){return new Oe(this.name,this.index,this.type,this.argTypes.map(e=>e.toLazy(t)),this.rec_argTypes.map(e=>e.toLazy(t)),this.resultType.toLazy(t),this.argNames,this.rec_argNames)}prettyPrint(){return`ConstructorType ${this.name} : ${this.argTypes.map(t=>t.prettyPrint()).join(" -> ")} -> ${this.resultType.prettyPrint()}`}}class Ln extends Ae{constructor(t,e,n,r,s,i){super(),this.typeName=t,this.target=e,this.motive=n,this.methods=r,this.methodTypes=s,this.motiveType=i}valOf(t){return Nt(this.typeName,this.target.toLazy(t),this.motive.toLazy(t),this.methods.map(e=>e.toLazy(t)),this.methodTypes?this.methodTypes.map(e=>e.toLazy(t)):void 0,this.motiveType?this.motiveType.toLazy(t):void 0)}prettyPrint(){const t=this.methods.map(t=>t.prettyPrint()).join(" ");return`(ind-${this.typeName} ${this.target.prettyPrint()} ${this.motive.prettyPrint()} ${t})`}}const On={0:"โ",1:"โ",2:"โ",3:"โ",4:"โ",5:"โ",6:"โ",7:"โ",8:"โ",9:"โ"},An={"โ":"0","โ":"1","โ":"2","โ":"3","โ":"4","โ":"5","โ":"6","โ":"7","โ":"8","โ":"9"};function In(t,e){if(t.some(t=>t===e)){return Bn(t,function(t){const[e,n]=Rn(t,t.length-1);return[e,n]}(e))}return e}function Bn(t,e){const n=function([t,e]){const n=function(t){const e=t.toString().split("").map(t=>On[t]||t).join("");return e}(e);return t+n}(e);return t.map(t=>t.toString()).includes(n.toString())?Bn(t,function(t){return[t[0],t[1]+1]}(e)):n}function Cn(t){const e=t.split("").map(t=>An[t]||t).join("");return parseInt(e,10)||1}function Rn(t,e){return e<0?[t,0]:(n=t[e],Object.keys(An).includes(n)?Rn(t,e-1):[t.substring(0,e+1),Cn(t.substring(e+1))]);var n}class Mn{constructor(t,e){this.location=t,this.varName=e}prettyPrint(){return`${this.varName}`}}class qn{constructor(t,e){this.binder=t,this.type=e}prettyPrint(){return`${this.binder.prettyPrint()} : ${this.type.prettyPrint()}`}findNames(){return this.binder.varName}}class _n{constructor(t){this.message=t}toString(){return this.message.map(t=>"string"==typeof t?t:t.prettyPrint()).join(" ")}}class Gn{}class zn extends Gn{constructor(t){super(),this.result=t}}class Un extends Gn{constructor(t,e){super(),this.where=t,this.message=e}}class Hn{constructor(t,e=null){this.name=t,this.value=e}}function Dn(t,e){for(const[e,n]of t){const t=n();if(!(t instanceof zn)){if(t instanceof Un)throw new Error(`Error: ${t.message.toString()} at ${t.where}`);throw new Error("Internal error: expected go/stop, got "+typeof t)}e.value=t.result}return e()}class Fn{constructor(){}}class Vn extends Fn{constructor(t,e,n){super(),this.env=t,this.varName=e,this.expr=n}valOfClosure(t){return this.expr.valOf(ht(this.env,this.varName,t))}prettyPrint(){return`(CLOS ${this.varName} ${this.expr.prettyPrint()})`}toString(){return this.prettyPrint()}}class Qn extends Fn{constructor(t){super(),this.proc=t}valOfClosure(t){return this.proc(t)}prettyPrint(){return this.proc.toString()}toString(){return this.prettyPrint()}}function Xn(t){return!("U"===(e=t)||"Nat"===e||"zero"===e||"add1"===e||"which-Nat"===e||"iter-Nat"===e||"rec-Nat"===e||"ind-Nat"===e||"->"===e||"โ"===e||"ฮ"===e||"ฮป"===e||"Pi"===e||"โ"===e||"lambda"===e||"quote"===e||"Atom"===e||"car"===e||"cdr"===e||"cons"===e||"ฮฃ"===e||"Sigma"===e||"Pair"===e||"Trivial"===e||"sole"===e||"List"===e||"::"===e||"nil"===e||"rec-List"===e||"ind-List"===e||"Absurd"===e||"ind-Absurd"===e||"="===e||"same"===e||"replace"===e||"trans"===e||"cong"===e||"symm"===e||"ind-="===e||"Vec"===e||"vecnil"===e||"vec::"===e||"head"===e||"tail"===e||"ind-Vec"===e||"Either"===e||"left"===e||"right"===e||"ind-Either"===e||"TODO"===e||"the"===e)&&isNaN(Number(t));var e}function Kn(t){return Array.from(t.keys())}function jn(t,e){return In(Kn(t),e)}function Yn(t,e,n){return In(Kn(t).concat(e.findNames()),n)}function Zn(t){return[t.binder.varName].concat(t.type.findNames())}function Wn(t){const e=[];return Jn(t,e),e}function Jn(t,e){if(t instanceof ee){const n=t.val.get();if(n instanceof Jt)return void tr(n.expr,e);t=n}const n=t.now();n instanceof Ee&&n.neutral instanceof $t?e.includes(n.neutral.name)||e.push(n.neutral.name):n instanceof ie?Jn(n.smaller,e):n instanceof $e&&(n.parameters.forEach(t=>Jn(t,e)),n.indices.forEach(t=>Jn(t,e)))}function tr(t,e){t instanceof xn?e.includes(t.name)||e.push(t.name):t instanceof Me?tr(t.n,e):t instanceof bn&&(t.parameters.forEach(t=>tr(t,e)),t.indices.forEach(t=>tr(t,e)))}function er(t,e){return ir(0,new Map,new Map,t,e)}const nr=-1;function rr(t,e,n){return t.set(e,n)}function sr(t,e){return e.has(t)?e.get(t):nr}function ir(t,e,n,r,s){if(r instanceof xn&&s instanceof xn){const t=r.name,i=s.name;if(Xn(t)&&Xn(i)){const r=sr(t,e),s=sr(i,n);return r!==nr&&s!==nr?r===s:r===nr&&s===nr&&t===i}return!1}if(r instanceof Fe&&s instanceof Fe)return r.sym===s.sym;if(r instanceof Ue&&s instanceof Ue)return ir(t,e,n,r.type,s.type)&&ir(t+1,rr(e,r.name,t),rr(n,s.name,t),r.body,s.body);if(r instanceof Ve&&s instanceof Ve)return ir(t,e,n,r.type,s.type)&&ir(t+1,rr(e,r.name,t),rr(n,s.name,t),r.body,s.body);if(r instanceof He&&s instanceof He)return ir(t+1,rr(e,r.param,t),rr(n,s.param,t),r.body,s.body);if(r instanceof Ie&&s instanceof Ie&&r.type instanceof nn&&s.type instanceof nn)return!0;if(r instanceof Pn&&s instanceof Pn)return ir(t,e,n,r.fun,s.fun)&&ir(t,e,n,r.arg,s.arg);if(r instanceof Be&&s instanceof Be||r instanceof Ce&&s instanceof Ce||r instanceof Re&&s instanceof Re||r instanceof De&&s instanceof De||r instanceof nn&&s instanceof nn||r instanceof en&&s instanceof en||r instanceof Ye&&s instanceof Ye||r instanceof wn&&s instanceof wn||r instanceof tn&&s instanceof tn)return!0;if(r instanceof Ie&&s instanceof Ie)return ir(t,e,n,r.type,s.type)&&ir(t,e,n,r.expr,s.expr);if(r instanceof Ze&&s instanceof Ze)return ir(t,e,n,r.elemType,s.elemType);if(r instanceof Me&&s instanceof Me)return ir(t,e,n,r.n,s.n);if(r instanceof qe&&s instanceof qe)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof _e&&s instanceof _e)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof Ge&&s instanceof Ge)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof ze&&s instanceof ze)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof Qe&&s instanceof Qe)return ir(t,e,n,r.first,s.first)&&ir(t,e,n,r.second,s.second);if(r instanceof Xe&&s instanceof Xe)return ir(t,e,n,r.pair,s.pair);if(r instanceof Ke&&s instanceof Ke)return ir(t,e,n,r.pair,s.pair);if(r instanceof je&&s instanceof je)return ir(t,e,n,r.head,s.head)&&ir(t,e,n,r.tail,s.tail);if(r instanceof We&&s instanceof We)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof Je&&s instanceof Je)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof rn&&s instanceof rn)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive);if(r instanceof sn&&s instanceof sn)return ir(t,e,n,r.type,s.type)&&ir(t,e,n,r.left,s.left)&&ir(t,e,n,r.right,s.right);if(r instanceof an&&s instanceof an)return ir(t,e,n,r.type,s.type);if(r instanceof on&&s instanceof on)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive)&&ir(t,e,n,r.base,s.base);if(r instanceof cn&&s instanceof cn)return ir(t,e,n,r.left,s.left)&&ir(t,e,n,r.right,s.right);if(r instanceof un&&s instanceof un)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.fun,s.fun);if(r instanceof hn&&s instanceof hn)return ir(t,e,n,r.equality,s.equality);if(r instanceof ln&&s instanceof ln)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive)&&ir(t,e,n,r.base,s.base);if(r instanceof pn&&s instanceof pn)return ir(t,e,n,r.type,s.type)&&ir(t,e,n,r.length,s.length);if(r instanceof fn&&s instanceof fn)return ir(t,e,n,r.head,s.head)&&ir(t,e,n,r.tail,s.tail);if(r instanceof yn&&s instanceof yn)return ir(t,e,n,r.vec,s.vec);if(r instanceof dn&&s instanceof dn)return ir(t,e,n,r.vec,s.vec);if(r instanceof mn&&s instanceof mn)return ir(t,e,n,r.length,s.length)&&ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive)&&ir(t,e,n,r.base,s.base)&&ir(t,e,n,r.step,s.step);if(r instanceof gn&&s instanceof gn)return ir(t,e,n,r.left,s.left)&&ir(t,e,n,r.right,s.right);if(r instanceof vn&&s instanceof vn)return ir(t,e,n,r.value,s.value);if(r instanceof Tn&&s instanceof Tn)return ir(t,e,n,r.value,s.value);if(r instanceof En&&s instanceof En)return ir(t,e,n,r.target,s.target)&&ir(t,e,n,r.motive,s.motive)&&ir(t,e,n,r.baseLeft,s.baseLeft)&&ir(t,e,n,r.baseRight,s.baseRight);if(r instanceof Nn&&s instanceof Nn)return function(t,e){return t.startLine===e.startLine&&t.startColumn===e.startColumn&&t.endLine===e.endLine&&t.endColumn===e.endColumn}(r.loc,s.loc)&&ir(t,e,n,r.type,s.type);if(r instanceof bn&&s instanceof bn){if(r.typeName!==s.typeName)return!1;if(r.parameters.length!==s.parameters.length)return!1;if(r.indices.length!==s.indices.length)return!1;for(let i=0;i<r.parameters.length;i++)if(!ir(t,e,n,r.parameters[i],s.parameters[i]))return!1;for(let i=0;i<r.indices.length;i++)if(!ir(t,e,n,r.indices[i],s.indices[i]))return!1;return!0}return!1}function ar(t,e){if(Array.isArray(e)&&"TODO"===e[0]){const[t,n,r,s]=e;r.valOf(new Map)}}function or(t,e){t.forInfo&&ar(0,e)}function cr(t,e){const n=t.get(e);return n||e}function ur(t,e,n){return new Map([[e,n],...t])}function hr(t,e,n,r){const s=n.readBackType(t),i=r.readBackType(t);return er(s,i)?new zn(void 0):new Un(e,new _n([`Expected ${i} but got ${s}`]))}function lr(t,e,n,r,s){return er(xt(t,n,r),xt(t,n,s))?new zn(void 0):new Un(e,new _n([`The terms ${r.prettyPrint()} and ${s.prettyPrint()} are not the same ${n.prettyPrint()}.`]))}function pr(t){return fr(t.split(""))}function fr(t){return 0===t.length||(e=t[0],!(!/^[a-zA-Z]$/.test(e)&&"-"!==t[0])&&fr(t.slice(1)));var e}function wr(t,e,n){return new ls(t.location,t,e,n)}class yr{static synthNat(t,e){return new zn(new Ie(new Be,new Ce))}static synthUniverse(t,e,n){return new Un(n,new _n(["U is a type, but it does not have a type."]))}static synthArrow(t,e,n,r,s,i){if(0===i.length){const n=Yn(t,s,"x"),i=new Hn("Aout"),a=new Hn("Bout");return Dn([[i,()=>r.check(t,e,new Ne)],[a,()=>s.check(ct(t,n,K(t,i.value)),e,new Ne)]],()=>new zn(new Ie(new Be,new Ue(n,i.value,a.value))))}{const[a,...o]=i,c=Yn(t,wr(s,a,o),"x"),u=new Hn("Aout"),h=new Hn("tout");return Dn([[u,()=>r.check(t,e,new Ne)],[h,()=>new kr(Q(n),s,a,o).check(ct(t,c,K(t,u.value)),e,new Ne)]],()=>new zn(new Ie(new Be,new Ue(c,u.value,h.value))))}}static synthPi(t,e,n,r,s){if(1===r.length){const[n,i]=[r[0].binder,r[0].type],a=jn(t,n.varName),o=(n.location,new Hn("Aout")),c=new Hn("Bout");return Dn([[o,()=>i.check(t,e,new Ne)],[c,()=>s.check(ct(t,a,K(t,o.value)),ur(e,n.varName,a),new Ne)]],()=>(ar(0,["binding-site",o.value]),new zn(new Ie(new Be,new Ue(a,o.value,c.value)))))}if(r.length>1){const[i,...a]=r,[o,c]=[i.binder,i.type],u=(o.location,o.varName),h=jn(t,u),l=new Hn("Aout"),p=new Hn("Bout");return Dn([[l,()=>c.check(t,e,new Ne)],[p,()=>new $r(Q(n),a,s).check(ct(t,h,K(t,l.value)),ur(e,u,h),new Ne)]],()=>(ar(0,["binding-site",l.value]),new zn(new Ie(new Be,new Ue(h,l.value,p.value)))))}throw new Error("Invalid number of binders in Pi type")}static synthZero(t,e){return new zn(new Ie(new Ce,new Re))}static synthAdd1(t,e,n){const r=new Hn("nout");return Dn([[r,()=>n.check(t,e,new re)]],()=>new zn(new Ie(new Ce,new Me(r.value))))}static synthWhichNat(t,e,n,r,s){const i=new Hn("tgtout"),a=new Hn("bout"),o=new Hn("sout"),c=jn(t,"n_minus_1");return Dn([[i,()=>n.check(t,e,new re)],[a,()=>r.synth(t,e)],[o,()=>s.check(t,e,new ae(c,new re,new Vn(W(t),c,a.value.type)))]],()=>new zn(new Ie(a.value.type,new qe(i.value,new Ie(a.value.type,a.value.expr),o.value))))}static synthIterNat(t,e,n,r,s){const i=new Hn("tgtout"),a=new Hn("bout"),o=new Hn("sout");return Dn([[i,()=>n.check(t,e,new re)],[a,()=>r.synth(t,e)],[o,()=>s.check(t,e,(()=>{const e=jn(t,"old");return K(t,new Ue(e,a.value.type,a.value.type))})())]],()=>new zn(new Ie(a.value.type,new _e(i.value,new Ie(a.value.type,a.value.expr),o.value))))}static synthRecNat(t,e,n,r,s){const i=new Hn("tgtout"),a=new Hn("bout"),o=new Hn("sout");return Dn([[i,()=>n.check(t,e,new re)],[a,()=>r.synth(t,e)],[o,()=>s.check(t,e,(()=>{const e=jn(t,"n_minus_1"),n=jn(t,"old");return K(t,new Ue(e,new Ce,new Ue(n,a.value.type,a.value.type)))})())]],()=>new zn(new Ie(a.value.type,new Ge(i.value,new Ie(a.value.type,a.value.expr),o.value))))}static synthIndNat(t,e,n,r,s,i){const a=new Hn("tgtout"),o=new Hn("motout"),c=new Hn("motval"),u=new Hn("bout"),h=new Hn("sout");return Dn([[a,()=>n.check(t,e,new re)],[o,()=>r.check(t,e,new ae("n",new re,new Qn(t=>new Ne)))],[c,()=>new zn(K(t,o.value))],[u,()=>s.check(t,e,lt(c.value,new se))],[h,()=>i.check(t,e,new ae("n-1",new re,new Qn(t=>new ae("x",lt(c.value,t),new Qn(e=>lt(c.value,new ie(t)))))))]],()=>new zn(new Ie(new Pn(o.value,a.value),new ze(a.value,o.value,u.value,h.value))))}static synthAtom(t,e){return new zn(new Ie(new Be,new De))}static synthPair(t,e,n,r){const s=jn(t,"a"),i=new Hn("Aout"),a=new Hn("Dout");return Dn([[i,()=>n.check(t,e,new Ne)],[a,()=>r.check(ct(t,s,K(t,i.value)),e,new Ne)]],()=>new zn(new Ie(new Be,new Ve(s,i.value,a.value))))}static synthSigma(t,e,n,r,s){if(1===r.length){const[n,i]=[r[0].binder,r[0].type],a=jn(t,n.varName),o=(n.location,new Hn("Aout")),c=new Hn("Dout");return Dn([[o,()=>i.check(t,e,new Ne)],[c,()=>s.check(ct(t,a,K(t,o.value)),ur(e,n.varName,a),new Ne)]],()=>(ar(0,["binding-site",o.value]),new zn(new Ie(new Be,new Ve(a,o.value,c.value)))))}if(r.length>1){const[i,...a]=r,[o,c]=[i.binder,i.type],u=(o.location,o.varName),h=jn(t,u),l=new Hn("Aout"),p=new Hn("Dout");return Dn([[l,()=>c.check(t,e,new Ne)],[p,()=>new Lr(Q(n),a,s).check(ct(t,h,K(t,l.value)),ur(e,u,h),new Ne)]],()=>(ar(0,["binding-site",l.value]),new zn(new Ie(new Be,new Ve(h,l.value,p.value)))))}throw new Error("Invalid number of binders in Sigma type")}static synthCar(t,e,n,r){const s=new Hn("p_rst");return Dn([[s,()=>r.synth(t,e)]],()=>{const e=K(t,s.value.type);return e instanceof ce?new zn(new Ie(e.carType.readBackType(t),new Xe(s.value.expr))):new Un(n,new _n([`car requires a Pair type, but was used as a: ${e}.`]))})}static synthCdr(t,e,n,r){const s=new Hn("pout");return Dn([[s,()=>r.synth(t,e)]],()=>{const e=K(t,s.value.type);if(e instanceof ce){const[n,r,i]=[e.carName,e.carType,e.cdrType];return new zn(new Ie(i.valOfClosure(yt(K(t,s.value.expr))).readBackType(t),new Ke(s.value.expr)))}return new Un(n,new _n([`cdr requires a Pair type, but was used as a: ${e}.`]))})}static synthQuote(t,e,n,r){return pr(r)?new zn(new Ie(new De,new Fe(r))):new Un(n,new _n([`Invalid atom: ${r}. Atoms consist of letters and hyphens.`]))}static synthTrivial(t,e){return new zn(new Ie(new Be,new tn))}static synthSole(t,e){return new zn(new Ie(new tn,new en))}static synthIndList(t,e,n,r,s,i,a){const o=new Hn("tgtout"),c=new Hn("motout"),u=new Hn("motval"),h=new Hn("bout"),l=new Hn("sout");return Dn([[o,()=>r.synth(t,e)]],()=>{const[r,p]=[o.value.type,o.value.expr],f=K(t,r);if(f instanceof he){const n=f.entryType;return Dn([[c,()=>s.check(t,e,new ae("xs",new he(n),new Vn(W(t),"xs",new Be)))],[u,()=>new zn(K(t,c.value))],[h,()=>i.check(t,e,lt(u.value,new le))],[l,()=>a.check(t,e,new ae("e",n,new Qn(t=>new ae("es",new he(n),new Qn(e=>new ae("ih",lt(u.value,e),new Qn(n=>lt(u.value,new pe(t,e)))))))))]],()=>new zn(new Ie(new Pn(c.value,p),new Je(p,c.value,h.value,l.value))))}return new Un(n,new _n([`Not a List: ${f.readBackType(t)}.`]))})}static synthRecList(t,e,n,r,s,i){const a=new Hn("tgtout");return Dn([[a,()=>r.synth(t,e)]],()=>{const[r,o]=[a.value.type,a.value.expr],c=K(t,r);if(c instanceof he){const n=c.entryType,r=new Hn("bout"),a=new Hn("btval"),u=new Hn("sout");return Dn([[r,()=>s.synth(t,e)],[a,()=>new zn(K(t,r.value.type))],[u,()=>i.check(t,e,new ae("e",n,new Qn(t=>new ae("es",new he(n),new Qn(t=>new ae("ih",a.value,new Qn(t=>a.value)))))))]],()=>new zn(new Ie(r.value.type,new We(o,new Ie(r.value.type,r.value.expr),u.value))))}return new Un(n,new _n([`Not a List: ${c.readBackType(t)}.`]))})}static synthList(t,e,n){const r=new Hn("Eout");return Dn([[r,()=>n.entryType.check(t,e,new Ne)]],()=>new zn(new Ie(new Be,new Ze(r.value))))}static synthListCons(t,e,n,r){const s=new Hn("eout"),i=new Hn("esout");return Dn([[s,()=>n.synth(t,e)],[i,()=>r.check(t,e,K(t,new Ze(s.value.type)))]],()=>new zn(new Ie(new Ze(s.value.type),new je(s.value.expr,i.value))))}static synthAbsurd(t,e,n){return new zn(new Ie(new Be,new nn))}static synthIndAbsurd(t,e,n){const r=new Hn("tgtout"),s=new Hn("motout");return Dn([[r,()=>n.target.check(t,e,new ke)],[s,()=>n.motive.check(t,e,new Ne)]],()=>new zn(new Ie(s.value,new rn(r.value,s.value))))}static synthEqual(t,e,n,r,s){const i=new Hn("Aout"),a=new Hn("Av"),o=new Hn("from_out"),c=new Hn("to_out");return Dn([[i,()=>n.check(t,e,new Ne)],[a,()=>new zn(K(t,i.value))],[o,()=>r.check(t,e,a.value)],[c,()=>s.check(t,e,a.value)]],()=>new zn(new Ie(new Be,new sn(i.value,o.value,c.value))))}static synthReplace(t,e,n,r,s,i){const a=new Hn("tgt_rst"),o=new Hn("motout"),c=new Hn("bout");return Dn([[a,()=>r.synth(t,e)]],()=>{const r=K(t,a.value.type);if(r instanceof fe){const[n,u,h]=[r.type,r.from,r.to];return Dn([[o,()=>s.check(t,e,new ae("x",n,new Qn(t=>new Ne)))],[c,()=>i.check(t,e,lt(K(t,o.value),u))]],()=>new zn(new Ie(lt(K(t,o.value),h).readBackType(t),new on(a.value.expr,o.value,c.value))))}return new Un(n,new _n([`Expected an expression with = type, but the type was: ${a.value.type}.`]))})}static synthTrans(t,e,n,r,s){const i=new Hn("p1_rst"),a=new Hn("p2_rst");return Dn([[i,()=>r.synth(t,e)],[a,()=>s.synth(t,e)]],()=>{const e=K(t,i.value.type),r=K(t,a.value.type);if(e instanceof fe&&r instanceof fe){const[s,o,c]=[e.type,e.from,e.to],[u,h,l]=[r.type,r.from,r.to];return Dn([[new Hn("_"),()=>hr(t,n,s,u)],[new Hn("_"),()=>lr(t,n,s,c,h)]],()=>new zn(new Ie(new fe(s,o,l).readBackType(t),new cn(i.value.expr,a.value.expr))))}return new Un(n,new _n([`Expected =, got ${e} and ${r}.`]))})}static synthCong(t,e,n,r,s){const i=new Hn("bout"),a=new Hn("f_rst");return Dn([[i,()=>r.synth(t,e)],[a,()=>s.synth(t,e)]],()=>{const e=K(t,i.value.type),r=K(t,a.value.type);if(e instanceof fe){const[s,o,c]=[e.type,e.from,e.to];if(r instanceof ae){const[e,u,h]=[r.argName,r.argType,r.resultType],l=new Hn("ph"),p=new Hn("Cv"),f=new Hn("fv");return Dn([[l,()=>hr(t,n,s,u)],[p,()=>new zn(h.valOfClosure(o))],[f,()=>new zn(K(t,a.value.expr))]],()=>new zn(new Ie(new sn(p.value.readBackType(t),xt(t,p.value,lt(f.value,o)),xt(t,p.value,lt(f.value,c))),new un(i.value.expr,p.value.readBackType(t),a.value.expr))))}return new Un(n,new _n([`Expected a function type, got ${r.readBackType(t)}.`]))}return new Un(n,new _n([`Expected an = type, got ${e.readBackType(t)}.`]))})}static synthSymm(t,e,n,r){const s=new Hn("eout");return Dn([[s,()=>r.synth(t,e)]],()=>{const e=K(t,s.value.type);if(e instanceof fe){const[n,r,i]=[e.type,e.from,e.to];return new zn(new Ie(new fe(n,i,r).readBackType(t),new hn(s.value.expr)))}return new Un(n,new _n([`Expected an = type, got ${e.readBackType(t)}.`]))})}static synthIndEqual(t,e,n,r,s,i){const a=new Hn("tgtout"),o=new Hn("motout"),c=new Hn("motv"),u=new Hn("baseout");return Dn([[a,()=>r.synth(t,e)]],()=>{const r=K(t,a.value.type);if(r instanceof fe){const[n,h,l]=[r.type,r.from,r.to];return Dn([[o,()=>s.check(t,e,new ae("to",n,new Qn(t=>new ae("p",new fe(n,h,t),new Qn(t=>new Ne)))))],[c,()=>new zn(K(t,o.value))],[u,()=>i.check(t,e,lt(lt(c.value,h),new we(h)))]],()=>new zn(new Ie(lt(lt(c.value,l),K(t,a.value.expr)).readBackType(t),new ln(a.value.expr,o.value,u.value))))}return new Un(n,new _n([`Expected evidence of equality, got ${r.readBackType(t)}.`]))})}static synthVec(t,e,n,r){const s=new Hn("tout"),i=new Hn("lenout");return Dn([[s,()=>n.check(t,e,new Ne)],[i,()=>r.check(t,e,new re)]],()=>new zn(new Ie(new Be,new pn(s.value,i.value))))}static synthHead(t,e,n,r){const s=new Hn("vout");return Dn([[s,()=>r.synth(t,e)]],()=>{const e=K(t,s.value.type).now();if(e instanceof ye){const[r,i]=[e.entryType,e.length];return i.now()instanceof ie?new zn(new Ie(r.readBackType(t),new yn(s.value.expr))):new Un(n,new _n([`Expected a Vec with add1 at the top of the length, got ${xt(t,new re,i)}.`]))}return new Un(n,new _n([`Expected a Vec, got ${e.readBackType(t)}.`]))})}static synthTail(t,e,n,r){const s=new Hn("vout");return Dn([[s,()=>r.synth(t,e)]],()=>{const e=K(t,s.value.type).now();if(e instanceof ye){const[r,i]=[e.entryType,e.length],a=i.now();if(a instanceof ie){const e=a.smaller;return new zn(new Ie(new pn(r.readBackType(t),xt(t,new re,e)),new dn(s.value.expr)))}return new Un(n,new _n([`Expected a Vec with add1 at the top of the length, got ${xt(t,new re,i)}.`]))}return new Un(n,new _n([`Expected a Vec, got ${e.readBackType(t)}.`]))})}static synthIndVec(t,e,n,r,s,i,a,o){const c=new Hn("lenout"),u=new Hn("lenv"),h=new Hn("vecout"),l=new Hn("motout"),p=new Hn("motval"),f=new Hn("bout"),w=new Hn("sout");return Dn([[c,()=>r.check(t,e,new re)],[u,()=>new zn(K(t,c.value))],[h,()=>s.synth(t,e)]],()=>{const r=K(t,h.value.type);if(r instanceof ye){const[s,y]=[r.entryType,r.length];return Dn([[new Hn("_"),()=>lr(t,n,new re,u.value,y)],[l,()=>i.check(t,e,new ae("k",new re,new Qn(t=>new ae("es",new ye(s,t),new Qn(t=>new Ne)))))],[p,()=>new zn(K(t,l.value))],[f,()=>a.check(t,e,lt(lt(p.value,new se),new de))],[w,()=>o.check(t,e,Tt(s,p.value))]],()=>new zn(new Ie(new Pn(new Pn(l.value,c.value),h.value.expr),new mn(c.value,h.value.expr,l.value,f.value,w.value))))}return new Un(n,new _n([`Expected a Vec, got ${r.readBackType(t)}.`]))})}static synthEither(t,e,n,r){const s=new Hn("Lout"),i=new Hn("Rout");return Dn([[s,()=>n.check(t,e,new Ne)],[i,()=>r.check(t,e,new Ne)]],()=>new zn(new Ie(new Be,new gn(s.value,i.value))))}static synthIndEither(t,e,n,r,s,i,a){const o=new Hn("tgtout"),c=new Hn("motout"),u=new Hn("motval"),h=new Hn("lout"),l=new Hn("rout");return Dn([[o,()=>r.synth(t,e)]],()=>{const r=K(t,o.value.type);if(r instanceof ge){const[n,p]=[r.leftType,r.rightType];return Dn([[c,()=>s.check(t,e,new ae("x",new ge(n,p),new Qn(t=>new Ne)))],[u,()=>new zn(K(t,c.value))],[h,()=>i.check(t,e,new ae("x",n,new Qn(t=>lt(u.value,new ve(t)))))],[l,()=>a.check(t,e,new ae("x",p,new Qn(t=>lt(u.value,new Te(t)))))]],()=>new zn(new Ie(new Pn(c.value,o.value.expr),new En(o.value.expr,c.value,h.value,l.value))))}return new Un(n,new _n([`Expected an Either, but got a ${r.readBackType(t)}.`]))})}static synthThe(t,e,n,r){const s=new Hn("t_out"),i=new Hn("e_out");return Dn([[s,()=>n.isType(t,e)],[i,()=>r.check(t,e,K(t,s.value))]],()=>new zn(new Ie(s.value,i.value)))}static synthApplication(t,e,n,r,s,i){if(r instanceof Or){if(t.get(r.name)instanceof at)return new ys(n,r.name,[s,...i]),new Un(n,new _n([`Constructor ${r.name} requires a type annotation. Use (the Type (${r.name} ...))`]))}if(0===i.length){const i=new Hn("fout");return Dn([[i,()=>r.synth(t,e)]],()=>{const r=K(t,i.value.type);if(r instanceof ae){const[n,a,o]=[r.argName,r.argType,r.resultType],c=new Hn("argout");return Dn([[c,()=>s.check(t,e,a)]],()=>new zn(new Ie(o.valOfClosure(K(t,c.value)).readBackType(t),new Pn(i.value.expr,c.value))))}return new Un(n,new _n([`Not a function type: ${r.readBackType(t)}.`]))})}{const a=new Hn("appout");return Dn([[a,()=>new ls(Q(n),r,s,i.slice(0,i.length-1)).synth(t,e)]],()=>{const r=K(t,a.value.type);if(r instanceof ae){const[n,s,o]=[r.argName,r.argType,r.resultType],c=new Hn("fout");return Dn([[c,()=>i[i.length-1].check(t,e,s)]],()=>new zn(new Ie(o.valOfClosure(K(t,c.value)).readBackType(t),new Pn(a.value.expr,c.value))))}return new Un(n,new _n([`Not a function type: ${r.readBackType(t)}.`]))})}}static synthName(t,e,n,r){const s=cr(e,r),i=new Hn("x_tv");return Dn([[i,()=>ot(t,0,s)]],()=>{const e=t.get(s);if(e instanceof rt&&ar(0,"definition"),e instanceof it){const n=e.type;return new zn(new Ie(new Be,new bn(n.name,n.parameterTypes.map(e=>e.readBackType(t)),n.indexTypes.map(e=>e.readBackType(t)))))}return new zn(new Ie(i.value.readBackType(t),new xn(s)))})}static synthNumber(t,e,n,r){if(0===r)return new zn(new Ie(new Ce,new Re));if(r>0){const s=new Hn("n_1_out");return Dn([[s,()=>new zr(n,r-1).check(t,e,new re)]],()=>new zn(new Ie(new Ce,new Me(s.value))))}return new Un(n,new _n([`Expected a positive number, got ${r}.`]))}static synthGeneralEliminator(t,e,n){const r=J(t,n.location,n.typeName);if(r instanceof Un)return r;const s=r.result.type,i=n.target.synth(t,e);if(i instanceof Un)return i;const a=i.result,o=K(t,a.type);if(!(o instanceof $e)||o.name!==n.typeName)return new Un(n.location,new _n([`Expected type ${n.typeName}, got ${o.readBackType(t)}`]));let c=s.indexTypes;const u=(e,n)=>{if(e>=c.length)return new ae("target",new $e(o.name,o.parameters,n),new Qn(t=>new Ne));const r=c[e];return new ae(jn(t,"idx"),r,new Qn(t=>u(e+1,[...n,t])))},h=u(0,[]),l=n.motive.check(t,e,h);if(l instanceof Un)return l;const p=l.result,f=K(t,p),w=h.readBackType(t),y=this.getConstructorTypesForDatatype(t,n.typeName);if(n.methods.length!==y.length)return new Un(n.location,new _n([`Expected ${y.length} methods, got ${n.methods.length}`]));let d=t;if(y.length>0){const t=y[0].core;for(let e=0;e<t.resultType.parameters.length&&e<o.parameters.length;e++){const n=t.resultType.parameters[e];n instanceof xn&&(d=ct(d,n.name,o.parameters[e]))}}const m=[],g=[];for(let r=0;r<n.methods.length;r++){const s=this.generateMethodTypeForConstructor(d,y[r].core,xt(t,h,f),o.parameters);g.push(s);const i=n.methods[r].check(t,e,K(d,s));if(i instanceof Un)return i;m.push(i.result)}let v=f;for(const t of o.indices)v=lt(v,t);v=lt(v,K(t,a.expr));const T=new Ln(n.typeName,a.expr,p,m,g,w);return new zn(new Ie(v.readBackType(t),T))}static getConstructorTypesForDatatype(t,e){const n=[];for(const[r,s]of t)if(s instanceof at){s.constructorType.type===e&&n.push({core:s.constructorType,resultTypeValue:s.type})}return n.sort((t,e)=>t.core.index-e.core.index)}static generateMethodTypeForConstructor(t,e,n,r){let s=n;for(const t of e.resultType.indices)s=new Pn(s,t);const i=new $n(e.name,e.index,e.type,e.argNames.map(t=>new xn(t)),e.rec_argNames.map(t=>new xn(t)));s=new Pn(s,i);for(let r=e.rec_argTypes.length-1;r>=0;r--){const i=e.rec_argTypes[r];if(!(i instanceof bn))throw new Error("not recursive arg");{let a=n;for(const t of i.indices){a=new Pn(a,t)}const o=e.rec_argNames[r],c=new xn(o);a=new Pn(a,c);const u=jn(t,"ih");s=new Ue(u,a,s)}}for(let t=e.rec_argTypes.length-1;t>=0;t--){const n=e.rec_argTypes[t],r=e.rec_argNames[t];s=new Ue(r,n,s)}for(let t=e.argTypes.length-1;t>=0;t--){const n=e.argTypes[t],r=e.argNames[t];s=new Ue(r,n,s)}return s}}class dr{constructor(t){this.location=t}isType(t,e){const n=new Hn("ok"),r=this.getType(t,e);return Dn([[n,()=>r]],()=>(or(this.location,["is-type",n.value]),new zn(n.value)))}getType(t,e){const n=this.check(t,e,new Ne);if(n instanceof zn)return n;if(n instanceof Un){if(this instanceof Or&&Xn(this.name)){const e=new Hn("other-tv");return Dn([[e,()=>ot(t,this.location,this.name)]],()=>new Un(this.location,new _n([`Expected U, but given ${e.value.readBackType(t)}`])))}return new Un(this.location,new _n(["not a type"]))}throw new Error("Invalid checkType")}check(t,e,n){const r=new Hn("ok"),s=this.checkOut(t,e,n);return Dn([[r,()=>s]],()=>new zn(r.value))}synth(t,e){const n=new Hn("ok");return Dn([[n,()=>this.synthHelper(t,e)]],()=>(or(this.location,["is-type",n.value.type]),new zn(n.value)))}checkOut(t,e,n){const r=new Hn("theT");return Dn([[r,()=>this.synth(t,e)],[new Hn("_"),()=>hr(t,this.location,K(t,r.value.type),n)]],()=>new zn(r.value.expr))}}class mr extends dr{constructor(t,e,n){super(t),this.location=t,this.type=e,this.value=n}synthHelper(t,e){return yr.synthThe(t,e,this.type,this.value)}findNames(){return this.type.findNames().concat(this.value.findNames())}prettyPrint(){return`(the ${this.type.prettyPrint()} ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class gr extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthUniverse(t,e,this.location)}findNames(){return[]}getType(t,e){return new zn(new Be)}prettyPrint(){return"U"}toString(){return this.prettyPrint()}}class vr extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthNat(t,e)}findNames(){return[]}getType(t,e){return new zn(new Ce)}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}}class Tr extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthZero(t,e)}findNames(){return[]}prettyPrint(){return"zero"}toString(){return this.prettyPrint()}}class Er extends dr{constructor(t,e){super(t),this.location=t,this.base=e}synthHelper(t,e){return yr.synthAdd1(t,e,this.base)}findNames(){return this.base.findNames()}prettyPrint(){return`(add1 ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class Nr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return yr.synthWhichNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(which-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Pr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return yr.synthIterNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(iter-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class xr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return yr.synthRecNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(rec-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class br extends dr{constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.base=r,this.step=s}synthHelper(t,e){return yr.synthIndNat(t,e,this.target,this.motive,this.base,this.step)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(ind-nat ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class kr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.arg1=e,this.arg2=n,this.args=r}synthHelper(t,e){return yr.synthArrow(t,e,this.location,this.arg1,this.arg2,this.args)}findNames(){return this.arg1.findNames().concat(this.arg2.findNames()).concat(this.args.flatMap(t=>t.findNames()))}getType(t,e){const[n,r,s]=[this.arg1,this.arg2,this.args];if(0===s.length){const s=Yn(t,r,"x"),i=new Hn("Aout"),a=new Hn("Bout");return Dn([[i,()=>n.isType(t,e)],[a,()=>r.isType(ct(t,s,K(t,i.value)),e)]],()=>new zn(new Ue(s,i.value,a.value)))}{const[i,...a]=s,o=Yn(t,wr(r,i,a),"x"),c=new Hn("Aout"),u=new Hn("tout");return Dn([[c,()=>n.isType(t,e)],[u,()=>new kr(Q(this.location),r,i,a).isType(ct(t,o,K(t,c.value)),e)]],()=>new zn(new Ue(o,c.value,u.value)))}}prettyPrint(){return`(-> ${this.arg1.prettyPrint()} ${this.arg2.prettyPrint()} ${this.args.map(t=>t.prettyPrint()).join(" ")})`}toString(){return this.prettyPrint()}}class $r extends dr{constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){return yr.synthPi(t,e,this.location,this.binders,this.body)}findNames(){return this.binders.flatMap(t=>Zn(t)).concat(this.body.findNames())}getType(t,e){const[n,r]=[this.binders,this.body];if(1===n.length){const[s,i]=[n[0].binder,n[0].type],a=jn(t,s.varName),o=(s.location,new Hn("Aout")),c=new Hn("Aoutv"),u=new Hn("Bout");return Dn([[o,()=>i.isType(t,e)],[c,()=>new zn(K(t,o.value))],[u,()=>r.isType(ct(t,a,c.value),ur(e,s.varName,a))]],()=>(ar(0,["binding-site",o.value]),new zn(new Ue(a,o.value,u.value))))}if(n.length>1){const[s,...i]=n,[a,o]=[s.binder.varName,s.type],c=jn(t,a),u=(s.binder.location,new Hn("Aout")),h=new Hn("Aoutv"),l=new Hn("Bout");return Dn([[u,()=>o.isType(t,e)],[h,()=>new zn(K(t,u.value))],[l,()=>new $r(Q(this.location),i,r).isType(ct(t,c,h.value),ur(e,s.binder.varName,c))]],()=>(ar(0,["binding-site",u.value]),new zn(new Ue(c,u.value,l.value))))}throw new Error("Invalid number of binders in Pi type")}prettyPrint(){return`(ฮ ${this.binders.map(t=>`(${t.binder.varName} ${t.type.prettyPrint()})`).join(" ")} \n            ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Sr extends dr{constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.binders.map(t=>t.varName).concat(this.body.findNames())}checkOut(t,e,n){if(1===this.binders.length){const r=this.body,s=this.binders[0],i=s.varName,a=s.location,o=n.now();if(o instanceof ae){const n=o.argType,s=o.resultType,a=cr(e,i),c=new Hn("bout");return Dn([[c,()=>r.check(ct(t,a,n),ur(e,i,a),s.valOfClosure(new Ee(n,new $t(a))))]],()=>(ar(0,["binding-site",n.readBackType(t)]),new zn(new He(a,c.value))))}return new Un(a,new _n([`Not a function type: ${o.readBackType(t)}.`]))}return new Sr(this.location,[this.binders[0]],new Sr(Q(this.location),this.binders.slice(1),this.body)).check(t,e,n)}prettyPrint(){return`(lambda ${this.binders.map(t=>t.varName).join(" ")} ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Lr extends dr{constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){return yr.synthSigma(t,e,this.location,this.binders,this.body)}findNames(){return this.binders.flatMap(t=>Zn(t)).concat(this.body.findNames())}getType(t,e){const[n,r]=[this.binders,this.body];if(1===n.length){const[s,i]=[n[0].binder,n[0].type],a=s.varName,o=jn(t,a),c=(s.location,new Hn("Aout")),u=new Hn("Aoutv"),h=new Hn("Dout");return Dn([[c,()=>i.isType(t,e)],[u,()=>new zn(K(t,c.value))],[h,()=>r.isType(ct(t,o,u.value),ur(e,a,o))]],()=>(ar(0,["binding-site",c.value]),new zn(new Ve(o,c.value,h.value))))}if(n.length>1){const[[s,i],...a]=[[n[0].binder,n[0].type],n[1],...n.slice(2)],o=s.varName,c=jn(t,o),u=(s.location,new Hn("Aout")),h=new Hn("Aoutv"),l=new Hn("Dout");return Dn([[u,()=>i.isType(t,e)],[h,()=>new zn(K(t,u.value))],[l,()=>new Lr(this.location,a,r).isType(ct(t,o,h.value),ur(e,o,c))]],()=>(ar(0,["binding-site",u.value]),new zn(new Ve(c,u.value,l.value))))}throw new Error("Invalid number of binders in Sigma type")}prettyPrint(){return`(ฮฃ ${this.binders.map(t=>`(${t.binder.varName} ${t.type.prettyPrint()})`).join(" ")} \n            ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Or extends dr{constructor(t,e){super(t),this.location=t,this.name=e}synthHelper(t,e){return yr.synthName(t,e,this.location,this.name)}findNames(){return[this.name]}prettyPrint(){return this.name}toString(){return this.prettyPrint()}}class Ar extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthAtom(t,e)}findNames(){return[]}getType(t,e){return new zn(new De)}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}}class Ir extends dr{constructor(t,e){super(t),this.location=t,this.name=e}synthHelper(t,e){return yr.synthQuote(t,e,this.location,this.name)}findNames(){return[]}prettyPrint(){return`'${this.name}`}toString(){return this.prettyPrint()}}class Br extends dr{constructor(t,e,n){super(t),this.location=t,this.first=e,this.second=n}synthHelper(t,e){return yr.synthPair(t,e,this.first,this.second)}findNames(){return this.first.findNames().concat(this.second.findNames())}getType(t,e){const n=new Hn("Aout"),r=new Hn("Dout"),s=Yn(t,this.second,"x");return Dn([[n,()=>this.first.isType(t,e)],[r,()=>this.second.isType(ct(t,s,K(t,n.value)),e)]],()=>new zn(new Ve(s,n.value,r.value)))}prettyPrint(){return`(Pair ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}}class Cr extends dr{constructor(t,e,n){super(t),this.location=t,this.first=e,this.second=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.first.findNames().concat(this.second.findNames())}checkOut(t,e,n){const r=n.now();if(r instanceof ce){const n=r.carType,s=r.cdrType,i=new Hn("aout"),a=new Hn("dout");return Dn([[i,()=>this.first.check(t,e,n)],[a,()=>this.second.check(t,e,s.valOfClosure(K(t,i.value)))]],()=>new zn(new Qe(i.value,a.value)))}return new Un(this.location,new _n([`cons requires a Pair or ฮฃ type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(cons ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}}class Rr extends dr{constructor(t,e){super(t),this.location=t,this.pair=e}synthHelper(t,e){return yr.synthCar(t,e,this.location,this.pair)}findNames(){return this.pair.findNames()}prettyPrint(){return`(car ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}}class Mr extends dr{constructor(t,e){super(t),this.location=t,this.pair=e}synthHelper(t,e){return yr.synthCdr(t,e,this.location,this.pair)}findNames(){return this.pair.findNames()}prettyPrint(){return`(cdr ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}}class qr extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthTrivial(t,e)}findNames(){return[]}getType(t,e){return new zn(new tn)}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}}class _r extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthSole(t,e)}findNames(){return[]}prettyPrint(){return"Sole"}}class Gr extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.now();return r instanceof he?new zn(new Ye):new Un(this.location,new _n([`nil requires a List type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}}let zr=class extends dr{constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){return yr.synthNumber(t,e,this.location,this.value)}findNames(){return[]}prettyPrint(){return`${this.value}`}toString(){return this.prettyPrint()}};class Ur extends dr{constructor(t,e){super(t),this.location=t,this.entryType=e}synthHelper(t,e){return yr.synthList(t,e,this)}findNames(){return this.entryType.findNames()}getType(t,e){const n=new Hn("Eout");return Dn([[n,()=>this.entryType.isType(t,e)]],()=>new zn(new Ze(n.value)))}prettyPrint(){return`(List ${this.entryType.prettyPrint()})`}toString(){return this.prettyPrint()}}class Hr extends dr{constructor(t,e,n){super(t),this.location=t,this.x=e,this.xs=n}synthHelper(t,e){return yr.synthListCons(t,e,this.x,this.xs)}findNames(){return this.x.findNames().concat(this.xs.findNames())}prettyPrint(){return`(:: ${this.x.prettyPrint()} ${this.xs.prettyPrint()})`}toString(){return this.prettyPrint()}}class Dr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return yr.synthRecList(t,e,this.location,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(rec-list ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Fr extends dr{constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.base=r,this.step=s}synthHelper(t,e){return yr.synthIndList(t,e,this.location,this.target,this.motive,this.base,this.step)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(ind-list ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Vr extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){return yr.synthAbsurd(t,e,this)}findNames(){return[]}getType(t,e){return new zn(new nn)}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}}class Qr extends dr{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}synthHelper(t,e){return yr.synthIndAbsurd(t,e,this)}findNames(){return this.target.findNames().concat(this.motive.findNames())}prettyPrint(){return`(ind-Absurd \n              ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()})`}toString(){return this.prettyPrint()}}class Xr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.type=e,this.left=n,this.right=r}synthHelper(t,e){return yr.synthEqual(t,e,this.type,this.left,this.right)}findNames(){return this.type.findNames().concat(this.left.findNames()).concat(this.right.findNames())}getType(t,e){const[n,r,s]=[this.type,this.left,this.right],i=new Hn("Aout"),a=new Hn("Av"),o=new Hn("from_out"),c=new Hn("to_out");return Dn([[i,()=>n.isType(t,e)],[a,()=>new zn(K(t,i.value))],[o,()=>r.check(t,e,a.value)],[c,()=>s.check(t,e,a.value)]],()=>new zn(new sn(i.value,o.value,c.value)))}prettyPrint(){return`(= ${this.type.prettyPrint()} \n              ${this.left.prettyPrint()} \n              ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class Kr extends dr{constructor(t,e){super(t),this.location=t,this.type=e}findNames(){return this.type.findNames()}synthHelper(t,e){throw new Error("Method not implemented.")}checkOut(t,e,n){const r=n.now();if(r instanceof fe){const n=r.type,s=r.from,i=r.to,a=new Hn("cout"),o=new Hn("val");return Dn([[a,()=>this.type.check(t,e,n)],[o,()=>new zn(K(t,a.value))],[new Hn("_"),()=>lr(t,this.type.location,n,s,o.value)],[new Hn("_"),()=>lr(t,this.type.location,n,i,o.value)]],()=>new zn(new an(a.value)))}return new Un(this.location,new _n([`same requires an Equal type, but encounter: ${r.readBackType(t)}.`]))}prettyPrint(){return`(same ${this.type.prettyPrint()})`}toString(){return this.prettyPrint()}}class jr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.base=r}synthHelper(t,e){return yr.synthReplace(t,e,this.location,this.target,this.motive,this.base)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames())}prettyPrint(){return`(replace ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class Yr extends dr{synthHelper(t,e){return yr.synthTrans(t,e,this.location,this.left,this.right)}constructor(t,e,n){super(t),this.location=t,this.left=e,this.right=n}findNames(){return this.left.findNames().concat(this.right.findNames())}prettyPrint(){return`(trans ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class Zr extends dr{constructor(t,e,n){super(t),this.location=t,this.target=e,this.fun=n}synthHelper(t,e){return yr.synthCong(t,e,this.location,this.target,this.fun)}findNames(){return this.target.findNames().concat(this.fun.findNames())}prettyPrint(){return`(cong ${this.target.prettyPrint()} ${this.fun.prettyPrint()})`}toString(){return this.prettyPrint()}}class Wr extends dr{constructor(t,e){super(t),this.location=t,this.equality=e}synthHelper(t,e){return yr.synthSymm(t,e,this.location,this.equality)}findNames(){return this.equality.findNames()}prettyPrint(){return`(symm ${this.equality.prettyPrint()})`}toString(){return this.prettyPrint()}}class Jr extends dr{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.base=r}synthHelper(t,e){return yr.synthIndEqual(t,e,this.location,this.target,this.motive,this.base)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames())}prettyPrint(){return`(ind-= ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class ts extends dr{constructor(t,e,n){super(t),this.location=t,this.type=e,this.length=n}synthHelper(t,e){return yr.synthVec(t,e,this.type,this.length)}findNames(){return this.type.findNames().concat(this.length.findNames())}getType(t,e){const n=new Hn("Eout"),r=new Hn("lenout");return Dn([[n,()=>this.type.isType(t,e)],[r,()=>this.length.check(t,e,new re)]],()=>new zn(new pn(n.value,r.value)))}prettyPrint(){return`(Vec ${this.type.prettyPrint()} ${this.length.prettyPrint()})`}toString(){return this.prettyPrint()}}class es extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.now();if(r instanceof ye){return r.length.now()instanceof se?new zn(new wn):new Un(this.location,new _n([`vecnil requires a Vec type with length ZERO, but was used as a: \n          ${xt(t,new re,r.length)}.`]))}return new Un(this.location,new _n([`vecnil requires a Vec type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}}class ns extends dr{constructor(t,e,n){super(t),this.location=t,this.x=e,this.xs=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.x.findNames().concat(this.xs.findNames())}checkOut(t,e,n){const r=n.now();if(r instanceof ye){const n=r.length.now();if(n instanceof ie){const s=new Hn("hout"),i=new Hn("tout"),a=n.smaller;return Dn([[s,()=>this.x.check(t,e,r.entryType)],[i,()=>this.xs.check(t,e,new ye(r.entryType,a))]],()=>new zn(new fn(s.value,i.value)))}return new Un(this.location,new _n([`vec:: requires a Vec type with length Add1, but was used with a: \n          ${xt(t,new re,r.length)}.`]))}return new Un(this.location,new _n([`vec:: requires a Vec type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(vec:: ${this.x.prettyPrint()} ${this.xs.prettyPrint()})`}toString(){return this.prettyPrint()}}class rs extends dr{constructor(t,e){super(t),this.location=t,this.vec=e}synthHelper(t,e){return yr.synthHead(t,e,this.location,this.vec)}findNames(){return this.vec.findNames()}prettyPrint(){return`(head ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}}class ss extends dr{constructor(t,e){super(t),this.location=t,this.vec=e}synthHelper(t,e){return yr.synthTail(t,e,this.location,this.vec)}findNames(){return this.vec.findNames()}prettyPrint(){return`(tail ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}}class is extends dr{constructor(t,e,n,r,s,i){super(t),this.location=t,this.length=e,this.target=n,this.motive=r,this.base=s,this.step=i}synthHelper(t,e){return yr.synthIndVec(t,e,this.location,this.length,this.target,this.motive,this.base,this.step)}findNames(){return this.length.findNames().concat(this.target.findNames()).concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`ind-Vec ${this.length.prettyPrint()}\n              ${this.target.prettyPrint()}\n              ${this.motive.prettyPrint()}\n              ${this.base.prettyPrint()}\n              ${this.step.prettyPrint()}`}toString(){return this.prettyPrint()}}class as extends dr{constructor(t,e,n){super(t),this.location=t,this.left=e,this.right=n}synthHelper(t,e){return yr.synthEither(t,e,this.left,this.right)}findNames(){return this.left.findNames().concat(this.right.findNames())}getType(t,e){const n=new Hn("Lout"),r=new Hn("Rout");return Dn([[n,()=>this.left.isType(t,e)],[r,()=>this.right.isType(t,e)]],()=>new zn(new gn(n.value,r.value)))}prettyPrint(){return`(Either ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class os extends dr{constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.value.findNames()}checkOut(t,e,n){const r=n.now();if(r instanceof ge){const n=new Hn("lout");return Dn([[n,()=>this.value.check(t,e,r.leftType)]],()=>new zn(new vn(n.value)))}return new Un(this.location,new _n([`left requires an Either type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class cs extends dr{constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.value.findNames()}checkOut(t,e,n){const r=n.now();if(r instanceof ge){const n=new Hn("rout");return Dn([[n,()=>this.value.check(t,e,r.rightType)]],()=>new zn(new Tn(n.value)))}return new Un(this.location,new _n([`right requires an Either type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class us extends dr{constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.baseLeft=r,this.baseRight=s}synthHelper(t,e){return yr.synthIndEither(t,e,this.location,this.target,this.motive,this.baseLeft,this.baseRight)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.baseLeft.findNames()).concat(this.baseRight.findNames())}prettyPrint(){return`(ind-Either ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.baseLeft.prettyPrint()} \n              ${this.baseRight.prettyPrint()})`}toString(){return this.prettyPrint()}}class hs extends dr{constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.readBackType(t);return or(this.location,["TODO",j(t),r,e]),new zn(new Nn(this.location.locationToSrcLoc(),r))}prettyPrint(){return"TODO"}toString(){return this.prettyPrint()}}class ls extends dr{constructor(t,e,n,r){super(t),this.location=t,this.func=e,this.arg=n,this.args=r}synthHelper(t,e){return yr.synthApplication(t,e,this.location,this.func,this.arg,this.args)}findNames(){return this.func.findNames().concat(this.arg.findNames()).concat(this.args.flatMap(t=>t.findNames()))}prettyPrint(){return`(${this.func.prettyPrint()} ${this.arg.prettyPrint()} ${this.args.map(t=>t.prettyPrint()).join(" ")})`}toString(){return this.prettyPrint()}getType(t,e){if(this.func instanceof Or){const n=this.func.name;if(t.get(n)instanceof it){const r=[this.arg,...this.args];return new fs(this.location,n,[],r).getType(t,e)}}return super.getType(t,e)}checkOut(t,e,n){if(this.func instanceof Or){const r=this.func.name;if(t.get(r)instanceof at){return new ys(this.location,r,[this.arg,...this.args]).checkOut(t,e,n)}}return super.checkOut(t,e,n)}}class ps extends dr{constructor(t,e,n,r){super(t),this.location=t,this.name=e,this.paramType=n,this.indicesType=r}findNames(){throw new Error("Method not implemented.")}prettyPrint(){throw new Error("Method not implemented.")}synthHelper(t,e){throw new Error("Method not implemented.")}getType(t,e){let n=t,r=e;const s=[],i=[];for(let t=0;t<this.paramType.length;t++){const e=jn(n,this.paramType[t].binder.varName),i=this.paramType[t].type.isType(n,r);if(r=ur(r,this.paramType[t].binder.varName,e),i instanceof Un)return i;n=ct(n,e,K(n,i.result)),s.push(i.result)}for(let t=0;t<this.indicesType.length;t++){const e=jn(n,this.indicesType[t].binder.varName),s=this.indicesType[t].type.isType(n,r);if(r=ur(r,this.indicesType[t].binder.varName,e),s instanceof Un)return s;n=ct(n,e,K(n,s.result)),i.push(s.result)}return new zn(new kn(this.name,s,i))}}class fs extends dr{findNames(){throw new Error("Method not implemented.")}prettyPrint(){throw new Error("Method not implemented.")}synthHelper(t,e){throw new Error("Method not implemented.")}constructor(t,e,n,r){super(t),this.location=t,this.name=e,this.params=n,this.indices=r}getType(t,e){const n=J(t,this.location,this.name);if(n instanceof Un)return n;const r=n.result.type;if(this.params.length!==r.parameterTypes.length||this.indices.length!==r.indexTypes.length)return new Un(this.location,new _n(["Parameter/index count mismatch for type "+this.name]));const s=[];for(let n=0;n<this.params.length;n++){const i=this.params[n].check(t,e,r.parameterTypes[n].now());if(i instanceof Un)return i;s.push(i.result)}const i=[];for(let n=0;n<this.indices.length;n++){const s=this.indices[n].check(t,e,r.indexTypes[n].now());if(s instanceof Un)return s;i.push(s.result)}return new zn(new bn(this.name,s,i))}checkOut(t,e,n){const r=n.now();if(r instanceof Ne)return this.getType(t,e);const s=[],i=[];if(!(r instanceof Se))return new Un(this.location,new _n(["target type is not user defined inductive type, or use the wrong type"]));const a=r,o=a.parameterTypes,c=a.indexTypes;if(this.params.length!=o.length||this.indices.length!=c.length)return new Un(this.location,new _n(["the number of parameters/indices is inconsistent in constructor"]));for(let n=0;n<this.params.length;n++){const r=this.params[n].check(t,e,o[n].now());if(r instanceof Un)return Un;s.push(r.result)}for(let n=0;n<this.indices.length;n++){const r=this.indices[n].check(t,e,c[n].now());if(r instanceof Un)return Un;i.push(r.result)}return new zn(new bn(this.name,s,i))}}class ws extends dr{constructor(t,e,n,r,s){super(t),this.location=t,this.typeName=e,this.target=n,this.motive=r,this.methods=s}findNames(){return[this.typeName].concat(this.target.findNames()).concat(this.motive.findNames()).concat(this.methods.flatMap(t=>t.findNames()))}prettyPrint(){const t=this.methods.map(t=>t.prettyPrint()).join(" ");return`(ind-${this.typeName} ${this.target.prettyPrint()} ${this.motive.prettyPrint()} ${t})`}synthHelper(t,e){return yr.synthGeneralEliminator(t,e,this)}}class ys extends dr{constructor(t,e,n){super(t),this.location=t,this.constructorName=e,this.args=n}findNames(){return[this.constructorName].concat(this.args.flatMap(t=>t.findNames()))}prettyPrint(){const t=this.args.map(t=>t.prettyPrint()).join(" ");return`(${this.constructorName}${t.length>0?" "+t:""})`}synthHelper(t,e){throw new Error("Method not implemented.")}checkOut(t,e,n){const r=t.get(this.constructorName);if(!(r&&r instanceof at))return new Un(this.location,new _n([`Unknown constructor: ${this.constructorName}`]));const s=r.constructorType,i=n.now();if(!(i instanceof $e))return new Un(this.location,new _n(["Expected inductive type constructor"]));const a=t.get(s.type);if(!(a&&a instanceof it))return new Un(this.location,new _n([`Unknown inductive type: ${s.type}`]));const o=s.resultType;let c=t;for(let t=0;t<o.parameters.length;t++){const e=o.parameters[t];if(e instanceof xn){const n=e.name,r=i.parameters[t].now();c=ut(c,n,new Ne,r)}}for(let t=0;t<o.indices.length;t++){const e=o.indices[t];if(e instanceof xn){const n=e.name,r=i.indices[t].now();c=ut(c,n,a.type.indexTypes[t].now(),r)}}const u=r.type,h=[];u.indices.forEach(t=>{h.push(...Wn(t))});const l=[],p=[],f=[...s.argTypes,...s.rec_argTypes];if(this.args.length!==f.length)return new Un(this.location,new _n([`Constructor ${this.constructorName} expects ${f.length} arguments, but got ${this.args.length}`]));for(let t=0;t<s.argTypes.length;t++){const n=K(c,s.argTypes[t]),r=this.args[t].check(c,e,n);if(r instanceof Un)return r;const i=r.result;if(l.push(i),t<h.length){c=ut(c,h[t],n,K(c,i))}}const w=s.argTypes.length;for(let t=0;t<s.rec_argTypes.length;t++){const n=K(c,s.rec_argTypes[t]),r=this.args[t+w].check(c,e,n);if(r instanceof Un)return r;const i=r.result;p.push(i);const a=w+t;if(a<h.length){c=ut(c,h[a],n,K(c,i))}}return new zn(new $n(this.constructorName,s.index,s.type,l,p))}}function ds(t,e){return t instanceof Or&&t.name===e||t instanceof fs&&t.name===e}class ms{constructor(t,e,n,r,s,i){this.location=t,this.name=e,this.parameters=n,this.indices=r,this.constructors=s,this.eliminatorName=i}normalizeConstructor(t,e){const n=new ps(this.location,this.name,this.parameters,this.indices).isType(t,e);if(n instanceof Un)throw new Error(n.message.toString());const r=n.result;let s=t,i=e;for(const t of this.parameters){const e=t.binder.varName,n=t.type.isType(s,i);if(n instanceof Un)throw new Error(n.message.toString());const r=n.result,a=jn(s,e);s=ct(s,a,K(s,r)),i=ur(i,e,a)}const a=K(s,r);s=X(s,this.name,new it(this.name,a));const o=[];for(let t=0;t<this.constructors.length;t++)o.push(this.constructors[t].checkValid(s,i,a,t));let c=t,u=e;return c=X(c,this.name,new it(this.name,a)),o.forEach(t=>{const e=jn(c,t.name),n=K(s,t.resultType);c=X(c,e,new at(e,t,n)),u=ur(u,t.name,e)}),[c,u]}}class gs{constructor(t,e,n,r){this.location=t,this.name=e,this.args=n,this.returnType=r}checkValid(t,e,n,r){let s=t,i=e;const a=[],o=[],c=[],u=[];for(let t=0;t<this.args.length;t++){const e=this.args[t].binder.varName,n=jn(s,e),r=this.args[t].type.isType(s,i);if(r instanceof Un)throw new Error(r.message.toString());const h=r.result;ds(this.args[t].type,this.returnType.name)?(o.push(h),u.push(n)):(a.push(h),c.push(n)),s=ct(s,n,K(s,h)),i=ur(i,e,n)}const h=this.returnType.check(s,i,n);if(h instanceof Un)throw new Error(h.message.toString());const l=h.result;return new Sn(this.name,r,this.returnType.name,a,o,l,c,u)}}class vs{constructor(t,e,n,r,s){this.id=t,this.type=e,this.context=n,this.renaming=r,this.term=s}clone(t={}){return new vs(t.id??this.id,t.type??this.type,t.context??new Map(this.context),t.renaming??new Map(this.renaming),t.term??this.term)}addHypothesis(t,e){const n=jn(this.context,t);X(this.context,n,new nt(e))}getVariableType(t){const e=this.context.get(t);return e?.type}prettyPrintWithContext(){const t=Array.from(this.context.entries()).map(([t,e])=>`${t} : ${e.type.readBackType(this.context).prettyPrint()}`).join("\n  "),e=this.type.readBackType(this.context).prettyPrint();return t?`Context:\n  ${t}\nโโโโโโโโโโโโโโโโ\nGoal: ${e}`:`Goal: ${e}`}}class Ts{constructor(t){this.goal=t,this.children=[],this.parent=null,this.isComplete=!1,this.childFocusIndex=-1}addChildren(t){t.forEach(t=>{t.parent=this}),this.children=t}findById(t){if(this.goal.id===t)return this;for(const e of this.children){const n=e.findById(t);if(n)return n}return null}}class Es{constructor(t,e){this.location=t,this.goalTree=e,this.proofHistory=[],this.goalIdCounter=0,this.currentGoal=this.goalTree}static initialize(t,e,n){const r=new vs("goal_0",e,new Map(t),new Map),s=new Es(n,new Ts(r));return s.currentGoal=s.goalTree,s}generateGoalId(){return"goal_"+ ++this.goalIdCounter}isComplete(){return this.goalTree.isComplete}getCurrentGoal(){if(null===this.currentGoal)throw new Error("No current goal available.");return new zn(this.currentGoal.goal)}visualizeTree(){return this.visualizeNode(this.goalTree,"",!0)}visualizeNode(t,e,n){let r=e+(n?"โโโ ":"โโโ ")+`${t.isComplete?"โ":t===this.currentGoal?"โ":"โ"} ${t.goal.id}`+"\n";const s=e+(n?"    ":"โ   ");for(let e=0;e<t.children.length;e++){const n=e===t.children.length-1;r+=this.visualizeNode(t.children[e],s,n)}return r}addGoal(t){this.currentGoal.addChildren(t),this.currentGoal.childFocusIndex=0,this.currentGoal=t[0]}nextGoal(){if(null===this.currentGoal.parent)return!0;const t=this.currentGoal.parent,e=this.nextGoalAux(t);return null===e||(this.currentGoal=e,!1)}nextGoalAux(t){return-1===t.childFocusIndex||t.childFocusIndex>=t.children.length-1?(t.isComplete=!0,null===t.parent?null:this.nextGoalAux(t.parent)):(t.childFocusIndex+=1,t.children[t.childFocusIndex])}previousGoal(){if(null===this.currentGoal.parent)throw new Error("No previous goal available at the root level.");const t=this.PreviousGoalAux(this.currentGoal);if(null===t)throw new Error("No previous goal found.");this.currentGoal=t}PreviousGoalAux(t){if(0===t.childFocusIndex)return t;{let e=!1,n=t.children[t.childFocusIndex-1];for(;!e;){if(-1===n.childFocusINdex)return e=!0,n;n=n.children[n.childFocusIndex]}}return null}}class Ns{constructor(t){this.location=t}}class Ps extends Ns{constructor(t,e){super(t),this.location=t,this.varName=e}getName(){return"intro"}toString(){return`intro ${this.varName||""}`}apply(t){const e=t.currentGoal.goal,n=e.type;if(!(n instanceof ae))return new Un(t.location,new _n([`Cannot introduce a variable for non-function type: ${n.prettyPrint()}`]));const r=this.varName||n.argName||jn(e.context,"x"),s=e.renaming;r!==n.argName&&ur(s,n.argName,r);const i=X(e.context,r,new st(n.argType)),a=n.resultType.valOfClosure(new Ee(n.argType,new $t(r))),o=new Ts(new vs(t.generateGoalId(),a,i,s));return t.addGoal([o]),new zn(t)}}class xs extends Ns{constructor(t,e){super(t),this.location=t,this.term=e}toString(){return`exact ${this.term.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.type,r=this.term.check(e.context,e.renaming,n);return r instanceof Un?r:(t.currentGoal.isComplete=!0,t.nextGoal(),new zn(t))}}class bs extends Ns{constructor(t,e,n){super(t),this.location=t,this.value=e,this.varName=n}toString(){return`exists ${this.varName||""}`}apply(t){const e=t.getCurrentGoal().result,n=e.type;if(!(n instanceof ce))return new Un(t.location,new _n([`Cannot use exists on non-product type: ${n.prettyPrint()}`]));const r=this.varName||n.carName||jn(e.context,"x"),s=e.renaming;r!==n.carName&&ur(s,n.carName,r);const i=this.value.check(e.context,e.renaming,n.carType);if(i instanceof Un)return i;const a=i.result.valOf(W(e.context)),o=X(e.context,r,new rt(n.carType,a)),c=n.cdrType.valOfClosure(a),u=new Ts(new vs(t.generateGoalId(),c,o,s));return t.addGoal([u]),new zn(t)}}class ks extends Ns{constructor(t,e){super(t),this.location=t,this.target=e}toString(){return`ind-nat ${this.target}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new Un(t.location,new _n([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof st))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof re))return new Un(t.location,new _n([`Cannot eliminate non-Nat type: ${r.prettyPrint()}`]));const s=this.generateNatMotive(e.context,e.type,this.target),i=this.eliminateNat(e.context,e.renaming,s);return t.addGoal(i.map(n=>new Ts(new vs(t.generateGoalId(),n,e.context,e.renaming)))),new zn(t)}generateNatMotive(t,e,n){const r=e.readBackType(t),s=new Map(t);s.delete(n);const i=W(s);return new oe(n,new Vn(i,n,r))}eliminateNat(t,e,n){return[lt(n,new se),new ae(jn(t,"n-1"),new re,new Qn(e=>new ae(jn(t,"ih"),lt(n,e),new Qn(t=>lt(n,new ie(e))))))]}}class $s extends Ns{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-list ${this.target} to prove ${this.motive.prettyPrint()}`:`ind-list ${this.target}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new Un(t.location,new _n([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof st))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof he))return new Un(t.location,new _n([`Cannot eliminate non-List type: ${r.prettyPrint()}`]));const s=r.entryType;let i;if(this.motive){const t=this.motive.check(e.context,e.renaming,new ae("xs",new he(s),new Vn(W(e.context),"xs",new Be)));if(t instanceof Un)return t;i=t.result.valOf(W(e.context))}else i=this.generateListMotive(e.context,e.type,this.target);const a=this.eliminateList(e.context,e.renaming,i,s);return t.addGoal(a.map(n=>new Ts(new vs(t.generateGoalId(),n,e.context,e.renaming)))),new zn(t)}generateListMotive(t,e,n){const r=e.readBackType(t),s=new Map(t);s.delete(n);const i=W(s);return new oe(n,new Vn(i,n,r))}eliminateList(t,e,n,r){return[lt(n,new le),new ae(jn(t,"x"),r,new Qn(e=>new ae(jn(t,"xs"),new he(r),new Qn(r=>new ae(jn(t,"ih"),lt(n,r),new Qn(t=>lt(n,new pe(e,r))))))))]}}class Ss extends Ns{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.length=r}toString(){return`ind-list ${this.target} to prove ${this.motive.prettyPrint()}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new Un(t.location,new _n([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof st))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof ye))return new Un(t.location,new _n([`Cannot eliminate non-Vec type: ${r.prettyPrint()}`]));const s=this.length.check(e.context,e.renaming,new re);if(s instanceof Un)return s;const[i,a]=[r.entryType,r.length];lr(e.context,this.location,new re,K(e.context,s.result),a);const o=this.motive.check(e.context,e.renaming,new ae("k",new re,new Qn(t=>new ae("es",new ye(i,t),new Qn(t=>new Ne)))));if(o instanceof Un)return o;{const n=o.result.valOf(W(e.context)),r=this.eliminateVec(e.context,e.renaming,n,i);return t.addGoal(r.map(n=>new Ts(new vs(t.generateGoalId(),n,e.context,e.renaming)))),new zn(t)}}eliminateVec(t,e,n,r){return[lt(lt(n,new se),new de),Tt(r,n)]}}class Ls extends Ns{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-equal ${this.target} with motive ${this.motive.prettyPrint()}`:`ind-equal ${this.target}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new Un(t.location,new _n([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof st))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof fe))return new Un(t.location,new _n([`Cannot eliminate non-Equal type: ${r.prettyPrint()}`]));const[s,i]=[r.type,r.from,r.to];let a;if(!this.motive)return new Un(this.location,new _n(["Motive required for = elimination (too complex for auto-generation)"]));{const t=this.motive.check(e.context,e.renaming,new ae("to",s,new Qn(t=>new ae("p",new fe(s,i,t),new Qn(t=>new Ne)))));if(t instanceof Un)return t;a=t.result.valOf(W(e.context))}const o=[lt(lt(a,i),new we(i))];return t.addGoal(o.map(n=>new Ts(new vs(t.generateGoalId(),n,e.context,e.renaming)))),new zn(t)}}class Os extends Ns{constructor(t){super(t),this.location=t}toString(){return"left"}apply(t){const e=t.getCurrentGoal().result;if(!(e.type.now()instanceof ge))return new Un(t.location,new _n([`"left" expected goal type to be Either, but got: ${e.type.prettyPrint()}`]));const n=e.type.leftType.now();return t.addGoal([new Ts(new vs(t.generateGoalId(),n,e.context,e.renaming))]),new zn(t)}}class As extends Ns{constructor(t){super(t),this.location=t}toString(){return"right"}apply(t){const e=t.getCurrentGoal().result;if(!(e.type.now()instanceof ge))return new Un(t.location,new _n([`"right" expected goal type to be Either, but got: ${e.type.prettyPrint()}`]));const n=e.type.rightType.now();return t.addGoal([new Ts(new vs(t.generateGoalId(),n,e.context,e.renaming))]),new zn(t)}}class Is extends Ns{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-either ${this.target} with motive ${this.motive.prettyPrint()}`:`ind-either ${this.target}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new Un(t.location,new _n([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof st))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof ge))return new Un(t.location,new _n([`Cannot eliminate non-Either type: ${r.prettyPrint()}`]));const[s,i]=[r.leftType,r.rightType];let a;if(this.motive){const t=this.motive.check(e.context,e.renaming,new ae("x",new ge(s,i),new Qn(t=>new Ne)));if(t instanceof Un)return t;a=t.result.valOf(W(e.context))}else a=this.generateEitherMotive(e.context,e.type,this.target);const o=new ae("x",s,new Qn(t=>lt(a,new ve(t)))),c=new ae("x",i,new Qn(t=>lt(a,new Te(t))));return t.addGoal([new Ts(new vs(t.generateGoalId(),o,e.context,e.renaming)),new Ts(new vs(t.generateGoalId(),c,e.context,e.renaming))]),new zn(t)}generateEitherMotive(t,e,n){const r=e.readBackType(t),s=new Map(t);s.delete(n);const i=W(s);return new oe(n,new Vn(i,n,r))}}class Bs extends Ns{constructor(t){super(t)}toString(){return"split"}apply(t){const e=t.getCurrentGoal().result;if(!(e.type.now()instanceof ce))return new Un(t.location,new _n([`"split" expected goal type to be Sigma, but got: ${e.type.prettyPrint()}`]));const n=e.type.now(),r=n.carType.now(),s=n.cdrType.valOfClosure(n);return t.addGoal([new Ts(new vs(t.generateGoalId(),r,e.context,e.renaming)),new Ts(new vs(t.generateGoalId(),s,e.context,e.renaming))]),new zn(t)}}class Cs extends Ns{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-absurd ${this.target} with motive ${this.motive.prettyPrint()}`:`ind-absurd ${this.target}`}apply(t){const e=t.getCurrentGoal().result,n=e.context.get(this.target);if(!n)return new Un(t.location,new _n([`target not found in current context: ${this.target}`]));let r;if(!(n instanceof st))throw new Error("Expected target to be a free variable");if(r=n.type.now(),!(r instanceof ke))return new Un(t.location,new _n([`Cannot eliminate non-Absurd type: ${r.prettyPrint()}`]));if(this.motive){const t=this.motive.check(e.context,e.renaming,new Ne);if(t instanceof Un)return t}return t.currentGoal.isComplete=!0,t.nextGoal(),new zn(t)}}function Rs(t,e){return[t,...e]}function Ms(t,e,n,r){return new ls(_s(t),e,n,r)}function qs(t,e,n,r){return new fs(_s(t),e,n,r)}function _s(t){return new V(t,!0)}function Gs(t){return new Mn(_s(t),t.source)}function zs(t){if(t instanceof G.Symbol)return t.value;if(t instanceof G.NumericLiteral)return t.value;if(t instanceof z.List)return zs(t.elements[0]);if(t instanceof G.Nil)return"()";{const e=t;throw new Error(`Expected a Element, but got: ${JSON.stringify(e)} (type: ${typeof e}, constructor: ${e?.constructor?.name})`)}}function Us(t,e){return new F(e.start,e.end,t)}function Hs(t,e){return Us(zs(t),e)}function Ds(t){const e=new _(t);return new H("",e.scanTokens()).parse()}class Fs{static parsePie(t){return Fs.parseElements(Ds(t)[0])}static parseElements(t){const e=zs(t);if("U"===e)return n=Us("U",t.location),new gr(_s(n));if("the"===e){const e=t.elements;return function(t,e,n){return new mr(_s(t),e,n)}(Us("the",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("Nat"===e)return function(t){return new vr(_s(t))}(Us("Nat",t.location));if("zero"===e)return function(t){return new Tr(_s(t))}(Us("zero",t.location));if("add1"===e)return function(t,e){return new Er(_s(t),e)}(Us("add1",t.location),this.parseElements(t.elements[1]));if("->"===e||"โ"===e){const e=t.elements;return function(t,e){return new kr(_s(t),e[0],e[1],e[2])}(Us("->",t.location),[this.parseElements(e[1]),this.parseElements(e[2]),e.slice(3).map(t=>this.parseElements(t))])}if("lambda"===e||"ฮป"===e){const e=t.elements,n=t.location,r=e[1],s=e[2];return function(t,e,n){return new Sr(_s(t),e,n)}(Us("ฮป",n),r.elements.map(e=>Gs(Hs(e,t.location))),this.parseElements(s))}if("Pi"===e||"ฮ"===e){const e=t.elements,n=e[1],r=e[2],s=n.elements[0],i=s.elements[0],a=s.elements[1],o=n.elements.slice(1).map(t=>{const e=t.elements[0],n=t.elements[1];return new qn(Gs(Hs(e,t.location)),this.parseElements(n))});return function(t,e,n){return new $r(_s(t),e,n)}(Us("ฮ",t.location),Rs(new qn(Gs(Hs(i,s.location)),this.parseElements(a)),o),this.parseElements(r))}if("Sigma"===e||"ฮฃ"===e){const e=t.elements,n=e[1],r=e[2],s=n.elements[0],i=s.elements[0],a=s.elements[1],o=n.elements.slice(1).map(t=>{const e=t.elements[0],n=t.elements[1];return new qn(Gs(Hs(e,t.location)),this.parseElements(n))});return function(t,e,n){return new Lr(_s(t),e,n)}(Us("ฮ",t.location),Rs(new qn(Gs(Hs(i,s.location)),this.parseElements(a)),o),this.parseElements(r))}if("Pair"===e){const e=t.elements;return function(t,e,n){return new Br(_s(t),e,n)}(Us("Pair",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("cons"===e){const e=t.elements;return function(t,e,n){return new Cr(_s(t),e,n)}(Us("Cons",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("car"===e)return function(t,e){return new Rr(_s(t),e)}(Us("car",t.location),this.parseElements(t.elements[1]));if("cdr"===e)return function(t,e){return new Mr(_s(t),e)}(Us("cdr",t.location),this.parseElements(t.elements[1]));if("which-Nat"===e){const e=t.elements;return function(t,e,n,r){return new Nr(_s(t),e,n,r)}(Us("which-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("iter-Nat"===e){const e=t.elements;return function(t,e,n,r){return new Pr(_s(t),e,n,r)}(Us("iter-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("rec-Nat"===e){const e=t.elements;return function(t,e,n,r){return new xr(_s(t),e,n,r)}(Us("rec-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("ind-Nat"===e){const e=t.elements;return function(t,e,n,r,s){return new br(_s(t),e,n,r,s)}(Us("ind-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("Atom"===e)return function(t){return new Ar(_s(t))}(Us("Atom",t.location));if("quote"===e)return function(t,e){return new Ir(_s(t),e)}(Us("Quote",t.location),zs(t.elements[1]));if("Trivial"===e)return function(t){return new qr(_s(t))}(Us("Trivial",t.location));if("sole"===e)return function(t){return new _r(_s(t))}(Us("sole",t.location));if("List"===e)return function(t,e){return new Ur(_s(t),e)}(Us("List",t.location),this.parseElements(t.elements[1]));if("nil"===e)return function(t){return new Gr(_s(t))}(Us("nil",t.location));if("::"===e){const e=t.elements;return function(t,e,n){return new Hr(_s(t),e,n)}(Us("::",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("rec-List"===e){const e=t.elements;return function(t,e,n,r){return new Dr(_s(t),e,n,r)}(Us("rec-List",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("ind-List"===e){const e=t.elements;return function(t,e,n,r,s){return new Fr(_s(t),e,n,r,s)}(Us("ind-List",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("="===e){const e=t.elements;return function(t,e,n,r){return new Xr(_s(t),e,n,r)}(Us("=",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("same"===e)return function(t,e){return new Kr(_s(t),e)}(Us("same",t.location),this.parseElements(t.elements[1]));if("replace"===e){const e=t.elements;return function(t,e,n,r){return new jr(_s(t),e,n,r)}(Us("replace",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("trans"===e){const e=t.elements;return function(t,e,n){return new Yr(_s(t),e,n)}(Us("trans",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("cong"===e){const e=t.elements;return function(t,e,n){return new Zr(_s(t),e,n)}(Us("cong",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("ind-="===e){const e=t.elements;return function(t,e,n,r){return new Jr(_s(t),e,n,r)}(Us("ind-=",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("symm"===e)return function(t,e){return new Wr(_s(t),e)}(Us("symm",t.location),this.parseElements(t.elements[1]));if("Vec"===e){const e=t.elements;return function(t,e,n){return new ts(_s(t),e,n)}(Us("Vec",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("vecnil"===e)return function(t){return new es(_s(t))}(Us("vecnil",t.location));if("vec::"===e){const e=t.elements;return function(t,e,n){return new ns(_s(t),e,n)}(Us("vec::",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("head"===e)return function(t,e){return new rs(_s(t),e)}(Us("head",t.location),this.parseElements(t.elements[1]));if("tail"===e)return function(t,e){return new ss(_s(t),e)}(Us("tail",t.location),this.parseElements(t.elements[1]));if("ind-Vec"===e){const e=t.elements;return function(t,e,n,r,s,i){return new is(_s(t),e,n,r,s,i)}(Us("ind-Vec",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]),this.parseElements(e[5]))}if("Either"===e){const e=t.elements;return function(t,e,n){return new as(_s(t),e,n)}(Us("Either",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("left"===e)return function(t,e){return new os(_s(t),e)}(Us("left",t.location),this.parseElements(t.elements[1]));if("right"===e)return function(t,e){return new cs(_s(t),e)}(Us("right",t.location),this.parseElements(t.elements[1]));if("ind-Either"===e){const e=t.elements;return function(t,e,n,r,s){return new us(_s(t),e,n,r,s)}(Us("ind-Either",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("Absurd"===e)return function(t){return new Vr(_s(t))}(Us("Absurd",t.location));if("ind-Absurd"===e){const e=t.elements;return function(t,e,n){return new Qr(_s(t),e,n)}(Us("ind-Absurd",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("TODO"===e)return function(t){return new hs(_s(t))}(Us("TODO",t.location));if(e.startsWith("ind-")&&t instanceof z.List&&t.elements[0]instanceof G.Symbol){const n=e.substring(4),r=t.elements;if(r.length<3)throw new Error(`Eliminator ${e} requires at least target and motive`);const s=this.parseElements(r[1]),i=this.parseElements(r[2]),a=r.slice(3).map(t=>this.parseElements(t));return function(t,e,n,r,s){return new ws(_s(t),e,n,r,s)}(Us(e,t.location),n,s,i,a)}if(t instanceof z.List&&t.elements.length>=3){const e=t.elements,n=e[0];if(n instanceof G.Symbol){const r=n.value;if(r&&r[0]===r[0].toUpperCase()&&r[0]!==r[0].toLowerCase()&&3===e.length){const n=e[1],s=e[2];if((n instanceof z.List||n instanceof G.Nil)&&(s instanceof z.List||s instanceof G.Nil)){let e=[];n instanceof z.List&&(e=(n.elements||[]).map(t=>this.parseElements(t)));let i=[];return s instanceof z.List&&(i=(s.elements||[]).map(t=>this.parseElements(t))),qs(Us(r,t.location),r,e,i)}}}return Ms(Us("App",t.location),this.parseElements(e[0]),this.parseElements(e[1]),e.slice(2).map(t=>this.parseElements(t)))}if(t instanceof z.List&&t.elements.length>1){const e=t.elements;return Ms(Us("App",t.location),this.parseElements(e[0]),this.parseElements(e[1]),e.slice(2).map(t=>this.parseElements(t)))}if(t instanceof z.List&&1===t.elements.length){const e=zs(t.elements[0]);return function(t,e,n){return new ys(_s(t),e,n)}(Us(e,t.location),e,[])}if(Xn(e))return function(t,e){return new Or(_s(t),e)}(Us(e,t.location),e);if(!isNaN(Number(e)))return function(t,e){return new zr(_s(t),Number(e))}(Us(e,t.location),e);var n;throw new Error("Unexpected element: "+t)}static parseToTactics(t){const e=zs(t);if("exact"===e)return n=Us("exact",t.location),r=this.parseElements(t.elements[1]),new xs(_s(n),r);if("intro"===e)return function(t,e){return new Ps(_s(t),e)}(Us("intro",t.location),t.elements[1].value);if("exists"===e)return function(t,e,n){return new bs(_s(t),e,n)}(Us("exists",t.location),this.parseElements(t.elements[1]),t.elements[2].value);if("elimNat"===e)return function(t,e){return new ks(_s(t),e)}(Us("elimNat",t.location),t.elements[1].value);if("elimList"===e){const e=t;return function(t,e,n){return new $s(_s(t),e,n)}(Us("elimList",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("elimVec"===e)return function(t,e,n,r){return new Ss(_s(t),e,n,r)}(Us("elimVec",t.location),t.elements[1].value,this.parseElements(t.elements[2]),this.parseElements(t.elements[3]));if("elimEqual"===e){const e=t;return function(t,e,n){return new Ls(_s(t),e,n)}(Us("elimEqual",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("left"===e)return function(t){return new Os(_s(t))}(Us("left",t.location));if("right"===e)return function(t){return new As(_s(t))}(Us("right",t.location));if("elimEither"===e){const e=t;return function(t,e,n){return new Is(_s(t),e,n)}(Us("elimEither",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("split"===e)return function(t){return new Bs(_s(t))}(Us("split",t.location));if("elimAbsurd"===e){const e=t;return function(t,e,n){return new Cs(_s(t),e,n)}(Us("elimAbsurd",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}var n,r;throw new Error("Unexpected tactic: "+t)}}class Vs{constructor(t,e,n){this.location=t,this.name=e,this.type=n}}class Qs{constructor(t,e,n){this.location=t,this.name=e,this.expr=n}}class Xs{constructor(t,e,n,r){this.location=t,this.type=e,this.left=n,this.right=r}}class Ks{constructor(t,e,n){this.location=t,this.name=e,this.tactics=n}}class js{static parseDeclaration(t){const e=zs(t);if("claim"===e){const e=t.elements;return new Vs(_s(Hs(e[0],t.location)),zs(e[1]),Fs.parseElements(e[2]))}if("define"===e){const e=t.elements;return new Qs(_s(Hs(e[0],t.location)),zs(e[1]),Fs.parseElements(e[2]))}if("check-same"===e){const e=t.elements;return new Xs(_s(Hs(e[0],t.location)),Fs.parseElements(e[1]),Fs.parseElements(e[2]),Fs.parseElements(e[3]))}if("define-tactically"===e){const e=t.elements;return new Ks(_s(Hs(e[0],t.location)),zs(e[1]),e[2].elements.map(t=>Fs.parseToTactics(t)))}if("data"===e){const e=t.elements,n=t.location,r=zs(e[1]),s=e[2].elements||[],i=e[3].elements||[],a=s.map(t=>{const e=t;return new qn(Gs(Hs(e.elements[0],e.location)),Fs.parseElements(e.elements[1]))}),o=i.map(t=>{const e=t;return new qn(Gs(Hs(e.elements[0],e.location)),Fs.parseElements(e.elements[1]))}),c=e[e.length-1],u=c instanceof G.Symbol,h=u?e.length-1:e.length,l=u?zs(c):void 0,p=[];for(let t=4;t<h;t++){const n=e[t],r=zs(n.elements[0]),s=n.elements[1];let i=[];s instanceof z.List?i=s.elements||[]:s instanceof G.Nil&&(i=[]);const a=n.elements[2],o=i.map(t=>{const e=t,n=e.elements[1],r=Fs.parseElements(n);return new qn(Gs(Hs(e.elements[0],e.location)),r)}),c=a,u=zs(c.elements[0]);if(c.elements.length<3)throw new Error(`Constructor return type must specify parameters and indices: (${u} (params...) (indices...))`);const h=c.elements[1];let l=[];h instanceof z.List?l=(h.elements||[]).map(t=>Fs.parseElements(t)):h instanceof G.Nil&&(l=[]);const f=c.elements[2];let w=[];f instanceof z.List?w=(f.elements||[]).map(t=>Fs.parseElements(t)):f instanceof G.Nil&&(w=[]);const y=qs(Hs(c.elements[0],c.location),u,l,w);p.push(new gs(_s(Hs(n.elements[0],n.location)),r,o,y))}return new ms(_s(Hs(e[0],n)),r,a,o,p,l)}return Fs.parseElements(t)}}class Ys{constructor(){this.currentState=null}startProof(t,e,n){const r=e.get(t);return r instanceof nt?(this.currentState=Es.initialize(e,r.type,n),new zn(`Started proof of ${t}\nCurrent goal: \n${r.type.readBackType(e).prettyPrint()}`)):new Un(n,new _n([`${t} is not a valid type or has already been proved`]))}applyTactic(t){if(!this.currentState)return new Un(t.location,new _n(["No proof has been initialized"]));const e=t.apply(this.currentState);if(e instanceof Un)return e;this.currentState=e.result;let n=`\nApplied tactic: ${t}`;const r=this.currentState.getCurrentGoal();if(this.currentState.isComplete())n+="\nAll goals have been solved!";else{const t=r.result;n+="\nCurrent goal: \n"+t.type.readBackType(t.context).prettyPrint()}return new zn(n)}}function Zs(t){return t.prettyPrint()}function Ws(t){if(!t.trim())return{diagnostics:[],summary:"Waiting for inputโฆ"};const e=[],n=function(t){return new Map(t)}(tt);try{const r=Ds(t);for(const t of r){const r=Js(n,js.parseDeclaration(t));if(r){e.push(r);break}}}catch(t){e.push(ei(t))}const r=0===e.length?"No issues detected.":e.some(t=>"error"===t.severity)?"Errors detected.":"Warnings detected.";return{diagnostics:e,summary:r,pretty:0===e.length?ii(n):void 0}}function Js(t,e){try{if(e instanceof Vs){const n=Y(t,e.name,e.location,e.type);return n instanceof zn?(si(t,n.result),null):ti(n)}if(e instanceof Qs){const n=Z(t,e.name,e.location,e.expr);return n instanceof zn?(si(t,n.result),null):ti(n)}if(e instanceof Xs){const n=function(t,e,n,r,s){const i=new Hn("tOut"),a=new Hn("tv"),o=new Hn("aOut"),c=new Hn("bOut"),u=new Hn("av"),h=new Hn("bv");return Dn([[i,()=>n.isType(t,new Map)],[a,()=>new zn(K(t,i.value))],[o,()=>r.check(t,new Map,a.value)],[c,()=>s.check(t,new Map,a.value)],[u,()=>new zn(K(t,o.value))],[h,()=>new zn(K(t,c.value))]],()=>lr(t,e,a.value,u.value,h.value))}(t,e.location,e.type,e.left,e.right);return n instanceof zn?null:ti(n)}if(e instanceof Ks)return function(t,e){const n=new Ys,r=n.startProof(e.name,t,e.location);if(r instanceof Un)return ti(r);for(const t of e.tactics){const e=n.applyTactic(t);if(e instanceof Un)return ti(e)}return null}(t,e);if(e instanceof ms){const n=function(t,e,n){if(t.has(n.name))return new Un(n.location,new _n([`Name already in use: ${n.name}`]));const[r,s]=n.normalizeConstructor(t,e);return new zn(r)}(t,new Map,e);return n instanceof zn?(si(t,n.result),null):ti(n)}{const n=function(t,e){const n=new Hn("outmeta");return Dn([[n,()=>e.synth(t,new Map)]],()=>{const e=K(t,n.value.type),r=K(t,n.value.expr);return new zn(new Ie(e.readBackType(t),xt(t,e,r)))})}(t,e);return n instanceof zn?null:ti(n)}}catch(t){return ei(t)}}function ti(t){const e=t.where.locationToSrcLoc();return{message:(n=t.message,n.message.map(t=>"string"==typeof t?t:t.prettyPrint()).join(" ")),startLineNumber:e.startLine,startColumn:Math.max(1,e.startColumn),endLineNumber:e.endLine??e.startLine,endColumn:Math.max(e.endColumn??e.startColumn+1,e.startColumn+1),severity:"error"};var n}function ei(t){if(t instanceof Error){const e=t.message||"Unknown error",n=function(t){const e=/Error message: (.*) at (.*):(\d+):(\d+)/s.exec(t);if(e){const[,t,,n,r]=e;return{message:ri(t),startLineNumber:Number(n),startColumn:Number(r),endLineNumber:Number(n),endColumn:Number(r)+1,severity:"error"}}const n=/(.*):(\d+):(\d+)(.*)/s.exec(t);if(n){const[,,e,r,s]=n;return{message:ri(t.replace(/^[^:]+:\d+:\d+/,"").trim()||s||"Error"),startLineNumber:Number(e),startColumn:Number(r),endLineNumber:Number(e),endColumn:Number(r)+1,severity:"error"}}return null}(e);return n??ni(e)}return ni("string"==typeof t?t:"Unknown error")}function ni(t){return{message:ri(t),startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:2,severity:"error"}}function ri(t){return t.replace(/^\[|\]$/g,"").replace(/\s+/g," ").trim()}function si(t,e){t.clear();for(const[n,r]of e)t.set(n,r)}function ii(t){const e=[];for(const[n,r]of t)if(r instanceof rt){const s=Zs(r.type.readBackType(t)),i=Zs(xt(t,r.type,r.value));e.push(`${n} : ${s}`),e.push(`${n} = ${i}`)}else if(r.type){const s=Zs(r.type.readBackType(t));e.push(`${n} : ${s}`)}return e.join("\n")}export{Ws as analyzePieSource};
//# sourceMappingURL=pie-worker-bundle.js.map
