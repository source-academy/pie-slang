var t;!function(t){t[t.INTEGER=1]="INTEGER",t[t.RATIONAL=2]="RATIONAL",t[t.REAL=3]="REAL",t[t.COMPLEX=4]="COMPLEX"}(t||(t={}));class e{constructor(t){this.result=t}}class n extends e{constructor(t,e){super(t),this.result=t,this.value=e}isSigned(){return!!this.result&&("+"===this.value[0]||"-"===this.value[0])}build(){return c.build(this.value)}}class r extends e{constructor(t,e,n){super(t),this.result=t,this.numerator=e,this.denominator=n}build(){return u.build(this.numerator,this.denominator)}}class s extends e{constructor(t,e,n,r){super(t),this.result=t,this.integer=e,this.decimal=n,this.exponent=r}build(){if(this.integer?.includes("inf"))return this.integer.includes("-")?h.NEG_INFINITY:h.INFINITY;if(this.integer?.includes("nan"))return h.NAN;const t=(this.exponent?this.exponent.build():h.INEXACT_ZERO).coerce();let e=Number((this.integer?this.integer:"0")+"."+(this.decimal?this.decimal:"0"));return e*=Math.pow(10,t),h.build(e)}}class i extends e{constructor(t,e,n,r){super(t),this.result=t,this.real=e,this.sign=n,this.imaginary=r}build(){const t=this.real?this.real.build():c.EXACT_ZERO,e=this.imaginary.build();return this.sign&&"-"===this.sign?l.build(t,e.negate()):l.build(t,e)}}function o(t){const e=new RegExp("^([+-]?)(\\d+)$").exec(t);return e?new n(!0,e[0]):new n(!1)}function a(e,c){const u=o(e);if(u.result&&c>=t.INTEGER)return u;const h=function(t){if(1!==(t.match(/\//g)||[]).length)return new r(!1);const e=t.split("/");if(2!==e.length)return new r(!1);const[n,s]=e,i=o(n),a=o(s);return i.result&&a.result?new r(!0,n,s):new r(!1)}(e);if(h.result&&c>=t.RATIONAL)return h;const l=function(e){function n(t){if(function(t){return"+inf.0"===t||"-inf.0"===t||"+nan.0"===t||"-nan.0"===t}(t))return new s(!0,t);const e=(t.match(/\./g)||[]).length;if(e>1)return new s(!1);if(0===e){const e=o(t);return new s(e.result,e.value)}const[n,r]=t.split("."),i=o(n),a=o(r),c=i.result||""===n,u=a.result||""===r;return"+"===n||"-"===n?""===r?new s(!1):new s(!0,`${n}0`,t):i.result&&u||c&&a.result?a.result&&a.isSigned()?new s(!1):new s(!0,i.value,a.value):new s(!1)}return 0===(e.match(/[eE]/g)||[]).length?n(e):function(e){const r=e.indexOf("e"),i=e.indexOf("E");if(-1===r&&-1===i)return new s(!1);const o=-1===r?i:r,c=e.substring(0,o),u=e.substring(o+1);if(""===c||""==u)return new s(!1);const h=n(c);if(!h.result)return new s(!1);const l=a(u,t.REAL);return l.result?new s(!0,h.integer,h.decimal,l):new s(!1)}(e)}(e);if(l.result&&c>=t.REAL)return l;const p=function(e){if((e.match(/i/g)||[]).length<1)return new i(!1);if("i"!==e[e.length-1])return new i(!1);const n=e.search(/(?<!^)[+-]/);if(-1===n){const n=a(e.slice(0,-1),t.REAL);return n.result?new i(!0,void 0,void 0,n):new i(!1)}const r=e.slice(0,n);let s=e.slice(n+1,-1);"+"!==s[0]&&"-"!==s[0]&&(s="+"+s);const o=a(r,t.REAL),c=a(s,t.REAL);return o.result&&c.result?new i(!0,o,e[n],c):new i(!1)}(e);return p.result&&c>=t.COMPLEX?p:new n(!1)}class c{constructor(e){this.numberType=t.INTEGER,this.value=e}static build(t,e=!1){const n=BigInt(t);return 0n===n?c.EXACT_ZERO:new c(n)}promote(e){switch(e){case t.INTEGER:return this;case t.RATIONAL:return u.build(this.value,1n,!0);case t.REAL:return h.build(this.coerce(),!0);case t.COMPLEX:return l.build(this,c.EXACT_ZERO,!0)}}equals(t){return t instanceof c&&this.value===t.value}greaterThan(t){return this.value>t.value}negate(){return this===c.EXACT_ZERO?this:c.build(-this.value)}multiplicativeInverse(){if(this===c.EXACT_ZERO)throw new Error("Division by zero");return u.build(1n,this.value,!1)}add(t){return c.build(this.value+t.value)}multiply(t){return c.build(this.value*t.value)}getBigInt(){return this.value}coerce(){return this.value>Number.MAX_SAFE_INTEGER?1/0:this.value<Number.MIN_SAFE_INTEGER?-1/0:Number(this.value)}toString(){return this.value.toString()}}c.EXACT_ZERO=new c(0n);class u{constructor(e,n){this.numberType=t.RATIONAL,this.numerator=e,this.denominator=n}static build(t,e,n=!1){return u.simplify(BigInt(t),BigInt(e),n)}static simplify(t,e,n=!1){const r=(t,e)=>0n===e?t:r(e,t.valueOf()%e.valueOf()),s=r(t,e),i=t<0n?-1n:1n,o=e<0n?-1n:1n,a=i*o;return t*=i,1n!==(e*=o)||n?new u(a*t/s,e/s):c.build(a*t)}getNumerator(){return this.numerator}getDenominator(){return this.denominator}promote(e){switch(e){case t.RATIONAL:return this;case t.REAL:return h.build(this.coerce(),!0);case t.COMPLEX:return l.build(this,c.EXACT_ZERO,!0);default:throw new Error("Unable to demote rational")}}equals(t){return t instanceof u&&this.numerator===t.numerator&&this.denominator===t.denominator}greaterThan(t){return this.numerator*t.denominator>t.numerator*this.denominator}negate(){return u.build(-this.numerator,this.denominator)}multiplicativeInverse(){if(0n===this.numerator)throw new Error("Division by zero");return u.build(this.denominator,this.numerator)}add(t){const e=this.numerator*t.denominator+t.numerator*this.denominator,n=this.denominator*t.denominator;return u.build(e,n)}multiply(t){const e=this.numerator*t.numerator,n=this.denominator*t.denominator;return u.build(e,n)}coerce(){const t=this.numerator<0n?-this.numerator:this.numerator;let e=this.denominator;const n=Number(t/e);if(n>Number.MAX_VALUE)return this.numerator<0n?-1/0:1/0;let r=t%e;for(;r>Number.MAX_SAFE_INTEGER||e>Number.MAX_SAFE_INTEGER;)r/=2n,e/=2n;const s=Number(r)/Number(e);return this.numerator<0n?-(n+s):n+s}toString(){return`${this.numerator}/${this.denominator}`}}class h{static build(t,e=!1){return t===1/0?h.INFINITY:t===-1/0?h.NEG_INFINITY:isNaN(t)?h.NAN:0===t?h.INEXACT_ZERO:-0===t?h.INEXACT_NEG_ZERO:new h(t)}constructor(e){this.numberType=t.REAL,this.value=e}promote(e){switch(e){case t.REAL:return this;case t.COMPLEX:return l.build(this,c.EXACT_ZERO,!0);default:throw new Error("Unable to demote real")}}equals(t){return t instanceof h&&this.value===t.value}greaterThan(t){return this.value>t.value}negate(){return h.build(-this.value)}multiplicativeInverse(){if(this===h.INEXACT_ZERO||this===h.INEXACT_NEG_ZERO)throw new Error("Division by zero");return h.build(1/this.value)}add(t){return h.build(this.value+t.value)}multiply(t){return h.build(this.value*t.value)}coerce(){return this.value}toString(){return this===h.INFINITY?"+inf.0":this===h.NEG_INFINITY?"-inf.0":this===h.NAN?"+nan.0":this.value.toString()}}h.INEXACT_ZERO=new h(0),h.INEXACT_NEG_ZERO=new h(-0),h.INFINITY=new h(1/0),h.NEG_INFINITY=new h(-1/0),h.NAN=new h(NaN);class l{static build(t,e,n=!1){return l.simplify(new l(t,e),n)}constructor(e,n){this.numberType=t.COMPLEX,this.real=e,this.imaginary=n}static simplify(t,e){return!e&&y(t.imaginary,c.EXACT_ZERO)?t.real:t}promote(e){if(e===t.COMPLEX)return this;throw new Error("Unable to demote complex")}negate(){return l.build(this.real.negate(),this.imaginary.negate())}equals(t){return y(this.real,t.real)&&y(this.imaginary,t.imaginary)}greaterThan(t){return w(this.real,t.real)&&w(this.imaginary,t.imaginary)}multiplicativeInverse(){const t=m(E(this.real,this.real),E(this.imaginary,this.imaginary));return l.build(E(t.multiplicativeInverse(),this.real),E(t.multiplicativeInverse(),this.imaginary.negate()))}add(t){return l.build(m(this.real,t.real),m(this.imaginary,t.imaginary))}multiply(t){const e=(n=E(this.real,t.real),r=E(this.imaginary,t.imaginary),m(n,function(t){return t.negate()}(r)));var n,r;const s=m(E(this.real,t.imaginary),E(this.imaginary,t.real));return l.build(e,s)}getReal(){return this.real}getImaginary(){return this.imaginary}coerce(){throw new Error("Cannot coerce a complex number to a javascript number")}toPolar(){const e=this.real.promote(t.REAL),n=this.imaginary.promote(t.REAL),r=h.build(Math.sqrt(e.coerce()*e.coerce()+n.coerce()*n.coerce())),s=h.build(Math.atan2(n.coerce(),e.coerce()));return p.build(r,s)}toString(){return`${this.real}+${this.imaginary}i`}}class p{constructor(t,e){this.magnitude=t,this.angle=e}static build(t,e){return new p(t,e)}toCartesian(){const t=h.build(this.magnitude.coerce()*Math.cos(this.angle.coerce())),e=h.build(this.magnitude.coerce()*Math.sin(this.angle.coerce()));return l.build(t,e)}}function f(e){switch(e.numberType){case t.INTEGER:return e;case t.RATIONAL:return 1n===e.getDenominator()?c.build(e.getNumerator()):e;case t.REAL:return e;case t.COMPLEX:return l.build(f(e.getReal()),f(e.getImaginary()))}}function d(t,e){return t.numberType>e.numberType?[t,e.promote(t.numberType)]:t.numberType<e.numberType?[t.promote(e.numberType),e]:[t,e]}function y(t,e){const[n,r]=d(t,e);return n.equals(r)}function w(t,e){const[n,r]=d(t,e);return n.greaterThan(r)}function m(t,e){const[n,r]=d(t,e);return f(n.add(r))}function E(t,e){const[n,r]=d(t,e);return f(n.multiply(r))}h.build(Math.PI),h.build(Math.E),h.build(Math.SQRT2),h.build(Math.LN2),h.build(Math.LN10),h.build(Math.LOG2E),h.build(Math.LOG10E),h.build(Math.SQRT1_2);let g=class t{constructor(t,e){this.start=t,this.end=e}merge(e){return new t(this.start,e.end)}};class T{constructor(t,e){this.line=t,this.column=e}}var N;function v(t,e){return t.split("\n")[e.line-1]}function I(t){return"^".padStart(t.column," ")}!function(t){t[t.LEFT_PAREN=0]="LEFT_PAREN",t[t.RIGHT_PAREN=1]="RIGHT_PAREN",t[t.LEFT_BRACKET=2]="LEFT_BRACKET",t[t.RIGHT_BRACKET=3]="RIGHT_BRACKET",t[t.DOT=4]="DOT",t[t.HASH_SEMICOLON=5]="HASH_SEMICOLON",t[t.IDENTIFIER=6]="IDENTIFIER",t[t.NUMBER=7]="NUMBER",t[t.BOOLEAN=8]="BOOLEAN",t[t.STRING=9]="STRING",t[t.IF=10]="IF",t[t.LET=11]="LET",t[t.COND=12]="COND",t[t.ELSE=13]="ELSE",t[t.DEFINE=14]="DEFINE",t[t.LAMBDA=15]="LAMBDA",t[t.APOSTROPHE=16]="APOSTROPHE",t[t.BACKTICK=17]="BACKTICK",t[t.COMMA=18]="COMMA",t[t.COMMA_AT=19]="COMMA_AT",t[t.QUOTE=20]="QUOTE",t[t.QUASIQUOTE=21]="QUASIQUOTE",t[t.UNQUOTE=22]="UNQUOTE",t[t.UNQUOTE_SPLICING=23]="UNQUOTE_SPLICING",t[t.SET=24]="SET",t[t.BEGIN=25]="BEGIN",t[t.DELAY=26]="DELAY",t[t.IMPORT=27]="IMPORT",t[t.EXPORT=28]="EXPORT",t[t.DEFINE_SYNTAX=29]="DEFINE_SYNTAX",t[t.SYNTAX_RULES=30]="SYNTAX_RULES",t[t.HASH_VECTOR=31]="HASH_VECTOR",t[t.VECTOR=32]="VECTOR",t[t.EOF=33]="EOF"}(N||(N={}));class _ extends SyntaxError{constructor(t,e){super(`Syntax error at (${e.line}:${e.column})\n${t}`),this.loc=e}toString(){return this.message}}let O=class extends _{constructor(t,e){super(v(t,e)+"\nUnexpected EOF",e),this.name="UnexpectedEOFError"}};class P extends _{constructor(t,e,n){super(v(t,e)+"\n"+I(e)+"\n"+`Unexpected '${n}'`,e),this.form=n,this.name="UnexpectedTokenError"}}class A extends _{constructor(t,e,n,r){super(v(t,e)+"\n"+I(e)+"\n"+`Expected '${r}' but got '${n}'`,e),this.form=n,this.expected=r,this.name="ExpectedTokenError"}}class S extends _{constructor(t,e,n,r){super(v(t,e)+"\n"+I(e)+"\n"+`Syntax '${n}' not allowed at Scheme §${r}`,e),this.token=n,this.name="DisallowedTokenError"}}class b extends _{constructor(t,e,n){super(v(t,e)+"\n"+I(e)+"\n"+`Syntax '${n}' not supported yet`,e),this.token=n,this.name="UnsupportedTokenError"}}class L{constructor(t){this.elements=t,this.location=new g(this.firstPos(),this.lastPos())}static build(t){if(0===t.length)throw new Error("Illegal empty group. This should never happen.");if(1===t.length){const n=t[0];if(x(n))return n;if((e=n).type!==N.IDENTIFIER&&e.type!==N.NUMBER&&e.type!==N.STRING&&e.type!==N.BOOLEAN)throw new A("",n.pos,n,"<data>");return new L(t)}var e;if(2===t.length){const e=t[0];if(R(e)&&function(t){return t.type===N.APOSTROPHE||t.type===N.BACKTICK||t.type===N.HASH_VECTOR||t.type===N.COMMA||t.type===N.COMMA_AT}(e))return new L(t)}const n=t[0],r=t[t.length-1];if(R(n)&&R(r)&&(i=r,(s=n).type===N.LEFT_PAREN&&i.type===N.RIGHT_PAREN||s.type===N.LEFT_BRACKET&&i.type===N.RIGHT_BRACKET))return new L(t);var s,i;const o=new L(t);throw new A("",o.location.start,o,"matching parentheses")}first(){return this.elements[0]}firstToken(){const t=this.first();return R(t)?t:t.firstToken()}firstPos(){return this.firstToken().pos}last(){return this.elements[this.elements.length-1]}lastToken(){const t=this.last();return R(t)?t:t.lastToken()}lastPos(){return this.lastToken().pos}isParenthesized(){const t=this.first();return R(t)&&(t.type===N.LEFT_PAREN||t.type===N.LEFT_BRACKET)}isSingleIdentifier(){return!this.isParenthesized()&&1===this.length()}unwrap(){return this.isParenthesized()?this.elements.slice(1,this.elements.length-1):this.elements}length(){return this.unwrap().length}toString(){return this.elements.map(t=>t.toString()).join(" ")}}function R(t){return t instanceof C}function x(t){return t instanceof L}class C{constructor(t,e,n,r,s,i,o){this.type=t,this.lexeme=e,this.literal=n,this.start=r,this.end=s,this.pos=new T(i,o),this.endPos=new T(i,o+e.length-1)}convertToken(){switch(this.type){case N.APOSTROPHE:return new C(N.QUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case N.BACKTICK:return new C(N.QUASIQUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case N.HASH_VECTOR:return new C(N.VECTOR,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case N.COMMA:return new C(N.UNQUOTE,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);case N.COMMA_AT:return new C(N.UNQUOTE_SPLICING,this.lexeme,this.literal,this.start,this.end,this.pos.line,this.pos.column);default:return this}}toString(){return`${this.lexeme}`}}class D extends SyntaxError{constructor(t,e,n){super(t),this.loc={line:e,column:n}}toString(){return this.message}}class k extends D{constructor(t,e,n){super(`Unexpected character '${n}' (${t}:${e})`,t,e),this.char=n,this.name="UnexpectedCharacterError"}}class $ extends D{constructor(t,e){super(`Unexpected EOF (${t}:${e})`,t,e),this.name="UnexpectedEOFError"}}const M=new Map([[".",N.DOT],["if",N.IF],["let",N.LET],["cond",N.COND],["else",N.ELSE],["set!",N.SET],["begin",N.BEGIN],["delay",N.DELAY],["quote",N.QUOTE],["export",N.EXPORT],["import",N.IMPORT],["define",N.DEFINE],["lambda",N.LAMBDA],["define-syntax",N.DEFINE_SYNTAX],["syntax-rules",N.SYNTAX_RULES]]);class U{constructor(t){this.start=0,this.current=0,this.line=1,this.col=0,this.source=t,this.tokens=[]}isAtEnd(){return this.current>=this.source.length}advance(){return this.col++,this.source.charAt(this.current++)}jump(){this.start=this.current,this.col++,this.current++}addToken(t,e=null){const n=this.source.substring(this.start,this.current);this.tokens.push(new C(t,n,e,this.start,this.current,this.line,this.col))}scanTokens(){for(;!this.isAtEnd();)this.start=this.current,this.scanToken();return this.tokens.push(new C(N.EOF,"",null,this.start,this.current,this.line,this.col)),this.tokens}scanToken(){const t=this.advance();switch(t){case"(":this.addToken(N.LEFT_PAREN);break;case")":this.addToken(N.RIGHT_PAREN);break;case"[":this.addToken(N.LEFT_BRACKET);break;case"]":this.addToken(N.RIGHT_BRACKET);break;case"'":this.addToken(N.APOSTROPHE);break;case"`":this.addToken(N.BACKTICK);break;case",":if(this.match("@")){this.addToken(N.COMMA_AT);break}this.addToken(N.COMMA);break;case"#":if(this.match("t")||this.match("f"))this.booleanToken();else if(this.match("|"))this.comment();else if(this.match(";"))this.addToken(N.HASH_SEMICOLON);else{if("("!==this.peek()&&"["!==this.peek())throw new k(this.line,this.col,t);this.addToken(N.HASH_VECTOR)}break;case";":for(;"\n"!=this.peek()&&!this.isAtEnd();)this.advance();break;case" ":case"\r":case"\t":break;case"\n":this.line++,this.col=0;break;case'"':this.stringToken();break;case"|":this.identifierTokenLoose();break;default:if(this.isDigit(t)||"-"===t||"+"===t||"."===t||"i"===t||"n"===t)this.identifierNumberToken();else{if(!this.isValidIdentifier(t))throw new k(this.line,this.col,t);this.identifierToken()}}}comment(){for(;("|"!=this.peek()||"#"!=this.peekNext())&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new $(this.line,this.col);this.jump(),this.jump()}identifierToken(){for(;this.isValidIdentifier(this.peek());)this.advance();this.addToken(this.checkKeyword())}identifierTokenLoose(){for(this.advance();"|"!=this.peek()&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new $(this.line,this.col);this.advance(),this.addToken(this.checkKeyword())}identifierNumberToken(){for(;this.isValidIdentifier(this.peek());)this.advance();const e=this.source.substring(this.start,this.current);a(e,t.COMPLEX).result?this.addToken(N.NUMBER,e):this.addToken(this.checkKeyword())}checkKeyword(){const t=this.source.substring(this.start,this.current);return M.has(t)?M.get(t):N.IDENTIFIER}stringToken(){for(;'"'!=this.peek()&&!this.isAtEnd();)"\n"===this.peek()&&(this.line++,this.col=0),this.advance();if(this.isAtEnd())throw new $(this.line,this.col);this.advance();const t=this.source.substring(this.start+1,this.current-1);this.addToken(N.STRING,t)}booleanToken(){this.addToken(N.BOOLEAN,"t"===this.peekPrev())}match(t){return!this.isAtEnd()&&(this.source.charAt(this.current)==t&&(this.current++,!0))}peek(){return this.isAtEnd()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}peekPrev(){return this.current-1<0?"\0":this.source.charAt(this.current-1)}isDigit(t){return t>="0"&&t<="9"}isSpecialSyntax(t){return"("===t||")"===t||"["===t||"]"===t||";"===t||"|"===t}isValidIdentifier(t){return!this.isWhitespace(t)&&!this.isSpecialSyntax(t)}isWhitespace(t){return" "===t||"\0"===t||"\n"===t||"\r"===t||"\t"===t}}var B,G;!function(t){class e{constructor(t,e){this.location=t,this.expressions=e}accept(t){return t.visitSequence(this)}equals(t){if(t instanceof e){if(this.expressions.length!==t.expressions.length)return!1;for(let e=0;e<this.expressions.length;e++)if(!this.expressions[e].equals(t.expressions[e]))return!1;return!0}return!1}}t.Sequence=e;class n{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitNumericLiteral(this)}equals(t){return t instanceof n&&this.value===t.value}}t.NumericLiteral=n;class r{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitBooleanLiteral(this)}equals(t){return t instanceof r&&this.value===t.value}}t.BooleanLiteral=r;class s{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitStringLiteral(this)}equals(t){return t instanceof s&&this.value===t.value}}t.StringLiteral=s;class i{constructor(t,e,n,r=void 0){this.location=t,this.params=n,this.rest=r,this.body=e}accept(t){return t.visitLambda(this)}equals(t){if(t instanceof i){if(this.params.length!==t.params.length)return!1;for(let e=0;e<this.params.length;e++)if(!this.params[e].equals(t.params[e]))return!1;if(this.rest&&t.rest){if(!this.rest.equals(t.rest))return!1}else if(this.rest||t.rest)return!1;return this.body.equals(t.body)}return!1}}t.Lambda=i;class o{constructor(t,e){this.location=t,this.name=e}accept(t){return t.visitIdentifier(this)}equals(t){return t instanceof o&&this.name===t.name}}t.Identifier=o;class a{constructor(t,e,n){this.location=t,this.name=e,this.value=n}accept(t){return t.visitDefinition(this)}equals(t){return t instanceof a&&(this.name.equals(t.name)&&this.value.equals(t.value))}}t.Definition=a;class c{constructor(t,e,n){this.location=t,this.operator=e,this.operands=n}accept(t){return t.visitApplication(this)}equals(t){if(t instanceof c){if(!this.operator.equals(t.operator))return!1;if(this.operands.length!==t.operands.length)return!1;for(let e=0;e<this.operands.length;e++)if(!this.operands[e].equals(t.operands[e]))return!1;return!0}return!1}}t.Application=c;class u{constructor(t,e,n,r){this.location=t,this.test=e,this.consequent=n,this.alternate=r}accept(t){return t.visitConditional(this)}equals(t){return t instanceof u&&(this.test.equals(t.test)&&this.consequent.equals(t.consequent)&&this.alternate.equals(t.alternate))}}t.Conditional=u;class h{constructor(t,e,n){this.location=t,this.car=e,this.cdr=n}accept(t){return t.visitPair(this)}equals(t){return t instanceof h&&(this.car.equals(t.car)&&this.cdr.equals(t.cdr))}}t.Pair=h;class l{constructor(t){this.location=t}accept(t){return t.visitNil(this)}equals(t){return t instanceof l}}t.Nil=l;class p{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitSymbol(this)}equals(t){return t instanceof p&&this.value===t.value}}t.Symbol=p;class f{constructor(t,e){this.location=t,this.value=e}accept(t){return t.visitSpliceMarker(this)}equals(t){return t instanceof f&&this.value.equals(t.value)}}t.SpliceMarker=f;class d{constructor(t,e,n){this.location=t,this.name=e,this.value=n}accept(t){return t.visitReassignment(this)}equals(t){return t instanceof d&&(this.name.equals(t.name)&&this.value.equals(t.value))}}t.Reassignment=d;class y{constructor(t,e,n){this.location=t,this.source=e,this.identifiers=n}accept(t){return t.visitImport(this)}equals(t){if(t instanceof y){if(!this.source.equals(t.source))return!1;if(this.identifiers.length!==t.identifiers.length)return!1;for(let e=0;e<this.identifiers.length;e++)if(!this.identifiers[e].equals(t.identifiers[e]))return!1;return!0}return!1}}t.Import=y;class w{constructor(t,e){this.location=t,this.definition=e}accept(t){return t.visitExport(this)}equals(t){return t instanceof w&&this.definition.equals(t.definition)}}t.Export=w;class m{constructor(t,e){this.location=t,this.elements=e}accept(t){return t.visitVector(this)}equals(t){if(t instanceof m){if(this.elements.length!==t.elements.length)return!1;for(let e=0;e<this.elements.length;e++)if(!this.elements[e].equals(t.elements[e]))return!1;return!0}return!1}}t.Vector=m;class E{constructor(t,e,n){this.location=t,this.name=e,this.transformer=n}accept(t){return t.visitDefineSyntax(this)}equals(t){return t instanceof E&&(this.name.equals(t.name)&&this.transformer.equals(t.transformer))}}t.DefineSyntax=E;class g{constructor(t,e,n){this.location=t,this.literals=e,this.rules=n}accept(t){return t.visitSyntaxRules(this)}equals(t){if(t instanceof g){if(this.literals.length!==t.literals.length)return!1;for(let e=0;e<this.literals.length;e++)if(!this.literals[e].equals(t.literals[e]))return!1;if(this.rules.length!==t.rules.length)return!1;for(let e=0;e<this.rules.length;e++)if(!this.rules[e][0].equals(t.rules[e][0])||!this.rules[e][1].equals(t.rules[e][1]))return!1;return!0}return!1}}t.SyntaxRules=g}(B||(B={})),function(t){class e{constructor(t,e,n,r,s=void 0){this.location=t,this.name=e,this.body=n,this.params=r,this.rest=s}accept(t){return t.visitFunctionDefinition(this)}equals(t){if(t instanceof e){if(this.params.length!==t.params.length)return!1;for(let e=0;e<this.params.length;e++)if(!this.params[e].equals(t.params[e]))return!1;if(this.rest&&t.rest){if(!this.rest.equals(t.rest))return!1}else if(this.rest||t.rest)return!1;return this.body.equals(t.body)}return!1}}t.FunctionDefinition=e;class n{constructor(t,e,n,r){this.location=t,this.identifiers=e,this.values=n,this.body=r}accept(t){return t.visitLet(this)}equals(t){if(t instanceof n){if(this.identifiers.length!==t.identifiers.length)return!1;for(let e=0;e<this.identifiers.length;e++)if(!this.identifiers[e].equals(t.identifiers[e]))return!1;if(this.values.length!==t.values.length)return!1;for(let e=0;e<this.values.length;e++)if(!this.values[e].equals(t.values[e]))return!1;return this.body.equals(t.body)}return!1}}t.Let=n;class r{constructor(t,e,n,r){this.location=t,this.predicates=e,this.consequents=n,this.catchall=r}accept(t){return t.visitCond(this)}equals(t){if(t instanceof r){if(this.predicates.length!==t.predicates.length)return!1;for(let e=0;e<this.predicates.length;e++)if(!this.predicates[e].equals(t.predicates[e]))return!1;if(this.consequents.length!==t.consequents.length)return!1;for(let e=0;e<this.consequents.length;e++)if(!this.consequents[e].equals(t.consequents[e]))return!1;return this.catchall&&t.catchall?this.catchall.equals(t.catchall):!this.catchall&&!t.catchall}return!1}}t.Cond=r;class s{constructor(t,e,n=void 0){this.location=t,this.elements=e,this.terminator=n}accept(t){return t.visitList(this)}equals(t){if(t instanceof s){if(this.elements.length!==t.elements.length)return!1;for(let e=0;e<this.elements.length;e++)if(!this.elements[e].equals(t.elements[e]))return!1;return this.terminator&&t.terminator?this.terminator.equals(t.terminator):!this.terminator&&!t.terminator}return!1}}t.List=s;class i{constructor(t,e){this.location=t,this.expressions=e}accept(t){return t.visitBegin(this)}equals(t){if(t instanceof i){if(this.expressions.length!==t.expressions.length)return!1;for(let e=0;e<this.expressions.length;e++)if(!this.expressions[e].equals(t.expressions[e]))return!1;return!0}return!1}}t.Begin=i;class o{constructor(t,e){this.location=t,this.expression=e}accept(t){return t.visitDelay(this)}equals(t){return t instanceof o&&this.expression.equals(t.expression)}}t.Delay=o}(G||(G={}));var H;!function(t){t[t.NONE=0]="NONE",t[t.QUOTE=1]="QUOTE",t[t.QUASIQUOTE=2]="QUASIQUOTE"}(H||(H={}));class F{constructor(t,e,n=1/0){this.current=0,this.quoteMode=H.NONE,this.source=t,this.tokens=e,this.chapter=n}advance(){return this.isAtEnd()||this.current++,this.previous()}isAtEnd(){return this.current>=this.tokens.length}previous(){return this.tokens[this.current-1]}peek(){return this.tokens[this.current]}validateChapter(t,e){if(this.chapter<e)throw new S(this.source,t.pos,t,this.chapter)}toLocation(t){return new g(t.pos,t.endPos)}destructureList(t,e=t=>{}){if(0===t.length)return[[],void 0];if(1===t.length)return e(t[0]),[[this.parseExpression(t[0])],void 0];const n=t.at(-2);if(R(n)&&n.type===N.DOT){const n=t.at(-1),r=t.slice(0,-2);return e(n),r.forEach(e),[r.map(this.parseExpression.bind(this)),this.parseExpression(n)]}const r=t;return r.forEach(e),[r.map(this.parseExpression.bind(this)),void 0]}grouping(t){const e=[];let n=!1;t&&(n=!0,e.push(t));do{const t=this.advance();switch(t.type){case N.LEFT_PAREN:case N.LEFT_BRACKET:const r=this.grouping(t);e.push(r);break;case N.RIGHT_PAREN:case N.RIGHT_BRACKET:if(!n)throw new P(this.source,t.pos,t);e.push(t),n=!1;break;case N.APOSTROPHE:case N.BACKTICK:case N.COMMA:case N.COMMA_AT:case N.HASH_VECTOR:let s;do{s=this.grouping()}while(!s);e.push(this.affect(t,s));break;case N.QUOTE:case N.QUASIQUOTE:case N.UNQUOTE:case N.UNQUOTE_SPLICING:case N.IDENTIFIER:case N.NUMBER:case N.BOOLEAN:case N.STRING:case N.DOT:case N.DEFINE:case N.IF:case N.ELSE:case N.COND:case N.LAMBDA:case N.LET:case N.SET:case N.BEGIN:case N.DELAY:case N.IMPORT:case N.EXPORT:case N.DEFINE_SYNTAX:case N.SYNTAX_RULES:e.push(t);break;case N.HASH_SEMICOLON:for(;!this.grouping(););break;case N.EOF:throw new O(this.source,t.pos);default:throw new P(this.source,t.pos,t)}}while(n);if(0!==e.length)try{return L.build(e)}catch(t){if(t instanceof A)throw new A(this.source,t.loc,t.form,t.expected);throw t}}affect(t,e){return L.build([t,e])}parseExpression(t){return R(t)?this.parseToken(t):t.isSingleIdentifier()?this.parseToken(t.unwrap()[0]):this.parseGroup(t)}parseToken(t){switch(t.type){case N.IDENTIFIER:return this.quoteMode===H.NONE?new B.Identifier(this.toLocation(t),t.lexeme):new B.Symbol(this.toLocation(t),t.lexeme);case N.NUMBER:return new B.NumericLiteral(this.toLocation(t),t.literal);case N.BOOLEAN:return new B.BooleanLiteral(this.toLocation(t),t.literal);case N.STRING:return new B.StringLiteral(this.toLocation(t),t.literal);default:if(this.quoteMode!==H.NONE||this.chapter>=5)return new B.Symbol(this.toLocation(t),t.lexeme);throw new P(this.source,t.pos,t)}}parseGroup(t){if(!t.isParenthesized())return this.parseAffectorGroup(t);switch(this.quoteMode){case H.NONE:return this.parseNormalGroup(t);case H.QUOTE:case H.QUASIQUOTE:return this.parseQuotedGroup(t)}}parseAffectorGroup(t){const[e,n]=t.unwrap();switch(e.type){case N.APOSTROPHE:case N.QUOTE:if(this.validateChapter(e,2),this.quoteMode!==H.NONE){const t=this.parseExpression(n),r=new B.Symbol(this.toLocation(e),"quote"),s=r.location.merge(t.location);return new G.List(s,[r,t])}this.quoteMode=H.QUOTE;const r=this.parseExpression(n);return this.quoteMode=H.NONE,r;case N.BACKTICK:case N.QUASIQUOTE:if(this.validateChapter(e,2),this.quoteMode!==H.NONE){const t=this.parseExpression(n),r=new B.Symbol(this.toLocation(e),"quasiquote"),s=r.location.merge(t.location);return new G.List(s,[r,t])}this.quoteMode=H.QUASIQUOTE;const s=this.parseExpression(n);return this.quoteMode=H.NONE,s;case N.COMMA:case N.UNQUOTE:this.validateChapter(e,2);const i=this.quoteMode;if(i===H.NONE)throw new b(this.source,e.pos,e);if(i===H.QUOTE){const t=this.parseExpression(n),r=new B.Symbol(this.toLocation(e),"unquote"),s=r.location.merge(t.location);return new G.List(s,[r,t])}this.quoteMode=H.NONE;const o=this.parseExpression(n);return this.quoteMode=i,o;case N.COMMA_AT:case N.UNQUOTE_SPLICING:this.validateChapter(e,2);const a=this.quoteMode;if(a===H.NONE)throw new P(this.source,e.pos,e);if(a===H.QUOTE){const t=this.parseExpression(n),r=new B.Symbol(this.toLocation(e),"unquote-splicing"),s=r.location.merge(t.location);return new G.List(s,[r,t])}this.quoteMode=H.NONE;const c=this.parseExpression(n);this.quoteMode=a;const u=this.toLocation(e).merge(c.location);return new B.SpliceMarker(u,c);case N.HASH_VECTOR:this.validateChapter(e,3);const h=this.quoteMode;this.quoteMode=H.QUOTE;const l=this.parseVector(t);return this.quoteMode=h,l;default:throw new P(this.source,e.pos,e)}}parseNormalGroup(t){if(0===t.length()){if(this.chapter>=5)return new B.Nil(t.location);throw new A(this.source,t.location.start,t,"non-empty group")}const e=t.unwrap()[0];if(R(e))switch(e.type){case N.LAMBDA:return this.validateChapter(e,1),this.parseLambda(t);case N.DEFINE:return this.validateChapter(e,1),this.parseDefinition(t);case N.IF:return this.validateChapter(e,1),this.parseConditional(t);case N.LET:return this.validateChapter(e,1),this.parseLet(t);case N.COND:return this.validateChapter(e,1),this.parseExtendedCond(t);case N.QUOTE:case N.APOSTROPHE:case N.QUASIQUOTE:case N.BACKTICK:case N.UNQUOTE:case N.COMMA:case N.UNQUOTE_SPLICING:case N.COMMA_AT:return this.validateChapter(e,2),this.parseAffectorGroup(t);case N.BEGIN:return this.validateChapter(e,3),this.parseBegin(t);case N.DELAY:return this.validateChapter(e,3),this.parseDelay(t);case N.SET:return this.validateChapter(e,3),this.parseSet(t);case N.DEFINE_SYNTAX:return this.validateChapter(e,5),this.parseDefineSyntax(t);case N.SYNTAX_RULES:throw new P(this.source,e.pos,e);case N.IMPORT:return this.validateChapter(e,1),this.parseImport(t);case N.EXPORT:return this.validateChapter(e,1),this.parseExport(t);case N.VECTOR:return this.validateChapter(e,3),this.parseAffectorGroup(t);default:return this.parseApplication(t)}return this.parseApplication(t)}parseQuotedGroup(t){if(0===t.length())return new B.Nil(t.location);if(1===t.length()){const e=[this.parseExpression(t.unwrap()[0])];return new G.List(t.location,e)}const e=t.unwrap(),[n,r]=this.destructureList(e);return new G.List(t.location,n,r)}parseLambda(t){if(t.length()<3)throw new A(this.source,t.location.start,t,"(lambda (<identifier>* . <rest-identifier>?) <body>+) | (lambda <rest-identifer> <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);let s,i=[];if(R(n)){if(n.type!==N.IDENTIFIER)throw new A(this.source,n.pos,n,"<rest-identifier>");s=new B.Identifier(this.toLocation(n),n.lexeme)}else{const t=n.unwrap();[i,s]=this.destructureList(t,t=>{if(!R(t))throw new A(this.source,t.pos,t,"<identifier>");if(t.type!==N.IDENTIFIER)throw new A(this.source,t.pos,t,"<identifier>")})}const o=r.map(this.parseExpression.bind(this));if(o.length<1)throw new A(this.source,t.location.start,t,"(lambda ... <body>+)");if(1===o.length)return new B.Lambda(t.location,o[0],i,s);const a=o.at(0).location.merge(o.at(-1).location),c=new B.Sequence(a,o);return new B.Lambda(t.location,c,i,s)}parseDefinition(t){if(t.length()<3)throw new A(this.source,t.location.start,t,"(define <identifier> <expr>) | (define (<identifier> <formals>) <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);let s,i,o=[],a=!1;if(x(n)){a=!0;const t=n.unwrap(),e=t[0],r=t.splice(1);if(!R(e))throw new A(this.source,e.location.start,e,"<identifier>");if(e.type!==N.IDENTIFIER)throw new A(this.source,e.pos,e,"<identifier>");s=new B.Identifier(this.toLocation(e),e.lexeme),[o,i]=this.destructureList(r,t=>{if(!R(t))throw new A(this.source,t.pos,t,"<identifier>");if(t.type!==N.IDENTIFIER)throw new A(this.source,t.pos,t,"<identifier>")})}else{if(n.type!==N.IDENTIFIER)throw new A(this.source,n.pos,n,"<identifier>");s=new B.Identifier(this.toLocation(n),n.lexeme),a=!1}if(r.length<1)throw new A(this.source,t.location.start,t,"(define ... <body>+)");if(a){const e=r.map(this.parseExpression.bind(this));if(1===e.length)return new G.FunctionDefinition(t.location,s,e[0],o,i);const n=e.at(0).location.merge(e.at(-1).location),a=new B.Sequence(n,e);return new G.FunctionDefinition(t.location,s,a,o,i)}if(r.length>1)throw new A(this.source,t.location.start,t,"(define <identifier> <expr>)");const c=this.parseExpression(r[0]);return new B.Definition(t.location,s,c)}parseConditional(t){if(t.length()<3||t.length()>4)throw new A(this.source,t.location.start,t,"(if <pred> <cons> <alt>?)");const e=t.unwrap(),n=e[1],r=e[2],s=t.length()>3?e[3]:void 0,i=this.parseExpression(n),o=this.parseExpression(r),a=s?this.parseExpression(s):new B.Identifier(t.location,"undefined");return new B.Conditional(t.location,i,o,a)}parseApplication(t){if(t.length()<1)throw new A(this.source,t.location.start,t,"(<func> <args>*)");const e=t.unwrap(),n=e[0],r=e.splice(1),s=this.parseExpression(n),i=[];for(const t of r)i.push(this.parseExpression(t));return new B.Application(t.location,s,i)}parseLet(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach(t=>{this.parseExpression(t)}),new G.Let(t.location,[],[],new B.Identifier(t.location,"undefined"))}if(t.length()<3)throw new A(this.source,t.location.start,t,"(let ((<identifier> <value>)*) <body>+)");const e=t.unwrap(),n=e[1],r=e.slice(2);if(!x(n))throw new A(this.source,n.pos,n,"((<identifier> <value>)*)");const s=[],i=[],o=n.unwrap();for(const t of o){if(!x(t))throw new A(this.source,t.pos,t,"(<identifier> <value>)");if(2!==t.length())throw new A(this.source,t.location.start,t,"(<identifier> <value>)");const[e,n]=t.unwrap();if(!R(e))throw new A(this.source,e.location.start,e,"<identifier>");if(e.type!==N.IDENTIFIER)throw new A(this.source,e.pos,e,"<identifier>");s.push(new B.Identifier(this.toLocation(e),e.lexeme)),i.push(this.parseExpression(n))}const a=r.map(this.parseExpression.bind(this));if(a.length<1)throw new A(this.source,t.location.start,t,"(let ... <body>+)");if(1===a.length)return new G.Let(t.location,s,i,a[0]);const c=a.at(0).location.merge(a.at(-1).location),u=new B.Sequence(c,a);return new G.Let(t.location,s,i,u)}parseExtendedCond(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach(t=>{this.parseExpression(t)}),new G.Cond(t.location,[],[],new B.Identifier(t.location,"undefined"))}if(t.length()<2)throw new A(this.source,t.location.start,t,"(cond (<pred> <body>*)* (else <val>)?)");const e=t.unwrap().splice(1),n=e.pop(),r=[],s=[];for(const t of e){if(!x(t))throw new A(this.source,t.pos,t,"(<pred> <body>*)");if(t.length()<1)throw new A(this.source,t.firstToken().pos,t.firstToken(),"(<pred> <body>*)");const[e,...n]=t.unwrap();if(R(e)&&e.type===N.ELSE)throw new A(this.source,e.pos,e,"<predicate>");const i=this.parseExpression(e),o=n.map(this.parseExpression.bind(this)),a=n.length<1?i.location:o.at(0).location.merge(o.at(-1).location),c=n.length<1?i:n.length<2?o[0]:new B.Sequence(a,o);r.push(i),s.push(c)}if(!x(n))throw new A(this.source,n.pos,n,"(<pred> <body>+) | (else <val>)");if(n.length()<2)throw new A(this.source,n.firstToken().pos,n.firstToken(),"(<pred> <body>+) | (else <val>)");const[i,...o]=n.unwrap();let a=!1;if(R(i)&&i.type===N.ELSE&&(a=!0,1!==o.length))throw new A(this.source,n.location.start,n,"(else <val>)");if(o.length<1)throw new A(this.source,n.location.start,n,"(<pred> <body>+)");const c=o.map(this.parseExpression.bind(this)),u=c.at(0).location.merge(c.at(-1).location),h=1===o.length?c[0]:new B.Sequence(u,c);if(a)return new G.Cond(t.location,r,s,h);const l=this.parseExpression(i);return r.push(l),s.push(h),new G.Cond(t.location,r,s)}parseSet(t){if(3!==t.length())throw new A(this.source,t.location.start,t,"(set! <identifier> <expr>)");const e=t.unwrap(),n=e[1],r=e[2];if(x(n))throw new A(this.source,n.location.start,n,"<identifier>");if(n.type!==N.IDENTIFIER)throw new A(this.source,n.pos,n,"<identifier>");const s=new B.Identifier(this.toLocation(n),n.lexeme),i=this.parseExpression(r);return new B.Reassignment(t.location,s,i)}parseBegin(t){if(t.length()<2)throw new A(this.source,t.location.start,t,"(begin <body>+)");const e=t.unwrap().slice(1),n=[];for(const t of e)n.push(this.parseExpression(t));return new G.Begin(t.location,n)}parseDelay(t){if(this.chapter>=5){return t.unwrap().slice(1).forEach(t=>{this.parseExpression(t)}),new G.Delay(t.location,new B.Identifier(t.location,"undefined"))}if(2!==t.length())throw new A(this.source,t.location.start,t,"(delay <expr>)");const e=t.unwrap()[1],n=this.parseExpression(e);return new G.Delay(t.location,n)}parseDefineSyntax(t){if(3!==t.length())throw new A(this.source,t.location.start,t,"(define-syntax <identifier> <transformer>)");const e=t.unwrap(),n=e[1],r=e[2];this.quoteMode=H.QUOTE;const s=this.parseExpression(n);if(this.quoteMode=H.NONE,!(s instanceof B.Symbol))throw new A(this.source,s.location.start,n,"<identifier>");if(!x(r))throw new A(this.source,r.pos,r,"<transformer>");if(r.length()<2)throw new A(this.source,r.firstToken().pos,r,"(syntax-rules ...)");const i=r.unwrap()[0];if(!R(r.unwrap()[0]))throw new A(this.source,r.firstToken().pos,i,"syntax-rules");if(i.type!==N.SYNTAX_RULES)throw new A(this.source,i.pos,i,"syntax-rules");const o=this.parseSyntaxRules(r);return new B.DefineSyntax(t.location,s,o)}isValidPattern(t){if(t instanceof G.List){if(void 0===t.terminator){if(t.elements.filter(t=>t instanceof B.Symbol&&"..."===t.value).length>1)return!1;const e=t.elements.findIndex(t=>t instanceof B.Symbol&&"..."===t.value);if(-1!=e&&0===e)return!1;for(const e of t.elements)if(!this.isValidPattern(e))return!1;return!0}{if(t.elements.filter(t=>t instanceof B.Symbol&&"..."===t.value).length>1)return!1;const e=t.elements.findIndex(t=>t instanceof B.Symbol&&"..."===t.value);if(-1!=e){if(0===e)return!1;if(e===t.elements.length-1)return!1}for(const e of t.elements)if(!this.isValidPattern(e))return!1;return this.isValidPattern(t.terminator)}}return t instanceof B.Symbol||t instanceof B.BooleanLiteral||t instanceof B.NumericLiteral||t instanceof B.StringLiteral||t instanceof B.Nil}isValidTemplate(t){if(t instanceof G.List){if(void 0===t.terminator){if(0===t.elements.length)return!1;if(2===t.elements.length&&t.elements[0]instanceof B.Symbol&&"..."===t.elements[0].value)return this.isValidTemplate(t.elements[1]);let e=!1;for(let n=0;n<t.elements.length;n++){const r=t.elements[n];if(r instanceof B.Symbol&&"..."===r.value){if(e){e=!1;continue}return!1}if(!this.isValidTemplate(r))return!1;e=!0}return!0}{if(0===t.elements.length)return!1;let e=!1;for(let n=0;n<t.elements.length;n++){const r=t.elements[n];if(r instanceof B.Symbol&&"..."===r.value){if(e){e=!1;continue}return!1}if(!this.isValidTemplate(r))return!1;e=!0}return this.isValidTemplate(t.terminator)}}return t instanceof B.Symbol||t instanceof B.BooleanLiteral||t instanceof B.NumericLiteral||t instanceof B.StringLiteral||t instanceof B.Nil}parseSyntaxRules(t){if(t.length()<3)throw new A(this.source,t.location.start,t,"(syntax-rules (<literal>*) <syntax-rule>+)");const e=t.unwrap(),n=e[1],r=e.slice(2),s=[];if(!x(n))throw new A(this.source,n.pos,n,"(<literal>*)");this.quoteMode=H.QUOTE;for(const t of n.unwrap()){if(!R(t))throw new A(this.source,t.location.start,t,"<literal>");const e=this.parseExpression(t);if(!(e instanceof B.Symbol))throw new A(this.source,t.pos,t,"<literal>");s.push(e)}const i=[];for(const t of r){if(!x(t))throw new A(this.source,t.pos,t,"(<pattern> <template>)");if(2!==t.length())throw new A(this.source,t.location.start,t,"(<pattern> <template>)");const[e,n]=t.unwrap(),r=this.parseExpression(e),s=this.parseExpression(n);if(!this.isValidPattern(r))throw new A(this.source,r.location.start,e,"<symbol> | <literal> | (<pattern>+) | (<pattern>+ ... <pattern>*) | (<pattern>+ ... <pattern>+ . <pattern>)");if(!this.isValidTemplate(s))throw new A(this.source,s.location.start,n,"<symbol> | <literal> | (<element>+) | (<element>+ . <template>) | (... <template>)");i.push([r,s])}return this.quoteMode=H.NONE,new B.SyntaxRules(t.location,s,i)}parseImport(t){if(3!==t.length())throw new A(this.source,t.firstToken().pos,t.firstToken(),'(import "<source>" (<identifier>*))');const e=t.unwrap(),n=e[1],r=e[2];if(!R(n))throw new A(this.source,n.location.start,n,'"<source>"');if(n.type!==N.STRING)throw new A(this.source,n.pos,n,'"<source>"');if(!x(r))throw new A(this.source,r.pos,r,"(<identifier>*)");const s=r.unwrap(),i=[];for(const t of s){if(!R(t))throw new A(this.source,t.location.start,t,"<identifier>");if(t.type!==N.IDENTIFIER)throw new A(this.source,t.pos,t,"<identifier>");i.push(new B.Identifier(this.toLocation(t),t.lexeme))}const o=new B.StringLiteral(this.toLocation(n),n.literal);return new B.Import(t.location,o,i)}parseExport(t){if(2!==t.length())throw new A(this.source,t.firstToken().pos,t.firstToken(),"(export (<definition>))");const e=t.unwrap()[1];if(!x(e))throw new A(this.source,e.pos,e,"(<definition>)");const n=this.parseExpression(e);if(!(n instanceof B.Definition||n instanceof G.FunctionDefinition))throw new A(this.source,e.location.start,e,"(<definition>)");return new B.Export(t.location,n)}parseVector(t){const e=t.unwrap()[1].unwrap().map(this.parseExpression.bind(this));return new B.Vector(t.location,e)}parse(t=!1){t&&(this.quoteMode=H.QUOTE,this.current=0);const e=[];for(;!this.isAtEnd()&&this.peek().type!==N.EOF;){const t=this.grouping();if(!t)continue;const n=this.parseExpression(t);e.push(n)}if(this.chapter>=5&&!t){return[...e.filter(t=>t instanceof B.Import),...this.parse(!0).filter(t=>!(t instanceof G.List&&t.elements&&t.elements[0]instanceof B.Symbol&&"import"===t.elements[0].value))]}return e}}class V{constructor(t,e,n,r,s){this.source=t,this.startLine=e,this.startColumn=n,this.endLine=r,this.endColumn=s}}class q{constructor(t,e,n){this.start=t,this.end=e,this.source=n}}class Y{constructor(t,e){this.syntax=t,this.forInfo=e}locationToSrcLoc(){return new V(this.syntax.source,this.syntax.start.line,this.syntax.start.column,this.syntax.end.line,this.syntax.end.column)}toString(){return`${this.syntax.source}:${this.syntax.start.line}:${this.syntax.start.column}`}}function K(t){return new Y(t.syntax,!1)}class z{constructor(t,e,n,r,s){this.id=t,this.type=e,this.context=n,this.renaming=r,this.term=s}clone(t={}){return new z(t.id??this.id,t.type??this.type,t.context??new Map(this.context),t.renaming??new Map(this.renaming),t.term??this.term)}addHypothesis(t,e){const n=tr(this.context,t);Q(this.context,n,new at(e))}getVariableType(t){const e=this.context.get(t);return e?.type}prettyPrintWithContext(){const t=Array.from(this.context.entries()).map(([t,e])=>`${t} : ${e.type.readBackType(this.context).prettyPrint()}`).join("\n  "),e=this.type.readBackType(this.context).prettyPrint();return t?`Context:\n  ${t}\n────────────────\nGoal: ${e}`:`Goal: ${e}`}}class j{constructor(t){this.goal=t,this.children=[],this.parent=null,this.isComplete=!1,this.childFocusIndex=-1}addChildren(t){t.forEach(t=>{t.parent=this}),this.children=t}extractTerm(){if(this.goal.term)return this.goal.term;if(0===this.children.length)return;const t=[];for(const e of this.children){const n=e.extractTerm();if(!n)return;t.push(n)}return this.termBuilder?this.termBuilder(t):1===t.length?t[0]:void 0}findById(t){if(this.goal.id===t)return this;for(const e of this.children){const n=e.findById(t);if(n)return n}return null}}class X{constructor(t,e){this.location=t,this.goalTree=e,this.proofHistory=[],this.goalIdCounter=0,this.pendingBranches=0,this.currentGoal=this.goalTree}static initialize(t,e,n){const r=new z("goal_0",e,new Map(t),new Map),s=new X(n,new j(r));return s.currentGoal=s.goalTree,s}generateGoalId(){return"goal_"+ ++this.goalIdCounter}isComplete(){return this.goalTree.isComplete}getCurrentGoal(){if(null===this.currentGoal)throw new Error("No current goal available.");return new Yn(this.currentGoal.goal)}visualizeTree(){return this.visualizeNode(this.goalTree,"",!0)}visualizeNode(t,e,n){let r=e+(n?"└── ":"├── ")+`${t.isComplete?"✓":t===this.currentGoal?"→":"○"} ${t.goal.id}`+"\n";const s=e+(n?"    ":"│   ");for(let e=0;e<t.children.length;e++){const n=e===t.children.length-1;r+=this.visualizeNode(t.children[e],s,n)}return r}addGoal(t){this.currentGoal.addChildren(t),this.currentGoal.childFocusIndex=0,this.currentGoal=t[0],t.length>1&&(this.pendingBranches=t.length)}nextGoal(){if(null===this.currentGoal.parent)return!0;const t=this.currentGoal.parent,e=this.nextGoalAux(t);return null===e||(this.currentGoal=e,!1)}nextGoalAux(t){return-1===t.childFocusIndex||t.childFocusIndex>=t.children.length-1?(t.isComplete=!0,null===t.parent?null:this.nextGoalAux(t.parent)):(t.childFocusIndex+=1,t.children[t.childFocusIndex])}previousGoal(){if(null===this.currentGoal.parent)throw new Error("No previous goal available at the root level.");const t=this.PreviousGoalAux(this.currentGoal);if(null===t)throw new Error("No previous goal found.");this.currentGoal=t}PreviousGoalAux(t){if(0===t.childFocusIndex)return t;{let e=!1,n=t.children[t.childFocusIndex-1];for(;!e;){if(-1===n.childFocusIndex)return e=!0,n;n=n.children[n.childFocusIndex]}}return null}}class J{constructor(){this.currentState=void 0}startProof(t,e,n){const r=e.get(t);return r instanceof at?(this.currentState=X.initialize(e,r.type,n),new Yn(`Started proof of ${t}\nCurrent goal: \n${r.type.readBackType(e).prettyPrint()}`)):new Kn(n,new Vn([`${t} is not a valid type or has already been proved`]))}applyTactic(t){if(!this.currentState)return new Kn(t.location,new Vn(["No proof has been initialized"]));const e=t.apply(this.currentState);if(e instanceof Kn)return e;this.currentState=e.result;let n=`\nApplied tactic: ${t}`;const r=this.currentState.getCurrentGoal();if(this.currentState.isComplete())n+="\nAll goals have been solved!";else{const t=r.result;n+="\nCurrent goal: \n"+t.type.readBackType(t.context).prettyPrint()}return new Yn(n)}}function Q(t,e,n){return new Map([...t,[e,n]])}function W(t,e){return e.valOf(rt(t))}function Z(t){const e=new Map;for(const[n,r]of t)r instanceof ut?e.set(n,["free",r.type.readBackType(t)]):r instanceof ct?e.set(n,["def",r.type.readBackType(t),bt(t,r.type,r.value)]):r instanceof at&&e.set(n,["claim",r.type.readBackType(t)]);return e}function tt(t,e,n,r){const s=new zn("typeOut");return jn([[new zn("_"),()=>function(t,e,n){return t.has(n)?new Kn(e,new Vn([`The name "${n}" is already in use in the context.`])):new Yn(!0)}(t,n,e)],[s,()=>r.isType(t,new Map)]],()=>new Yn(Q(t,e,new at(W(t,s.value)))))}function et(t,e){return t.delete(e),t}function nt(t,e,n,r){const s=new zn("typeOut"),i=new zn("exprOut");return jn([[s,()=>function(t,e,n){for(const[r,s]of t)if(r===n){if(s instanceof ct)return new Kn(e,new Vn([`The name "${n}" is already defined.`]));if(s instanceof at)return new Yn(s.type)}return new Kn(e,new Vn([`No claim: ${n}`]))}(t,n,e)],[i,()=>r.check(t,new Map,s.value)]],()=>new Yn(dt(et(t,e),e,s.value,W(t,i.value))))}function rt(t){if(0===t.size)return new Map;const e=t.entries(),n=new Map;for(const[t,r]of e)r instanceof ct?n.set(t,r.value):r instanceof ut?n.set(t,new Pe(r.type,new xt(t))):r instanceof ht&&n.set(t,r.type);return n}function st(t,e,n){for(const[e,r]of t)if(r instanceof ht&&e===n)return new Yn(r);return new Kn(e,new Vn([`No inductive type found for ${n} at ${e}`]))}const it=new Map;class ot{}let at=class extends ot{constructor(t){super(),this.type=t}};class ct extends ot{constructor(t,e){super(),this.type=t,this.value=e}}class ut extends ot{constructor(t){super(),this.type=t}}class ht extends ot{constructor(t,e){super(),this.name=t,this.type=e}}class lt extends ot{constructor(t,e,n){super(),this.name=t,this.constructorType=e,this.type=n}}function pt(t,e,n){if(0===t.size)throw new Error(`The context ${JSON.stringify(t)} is empty, but we are looking for ${n}`);for(const[e,r]of t.entries())if(!(r instanceof at)&&n===e)return new Yn(r instanceof ht?new Ae:r.type);throw new Error(`Unknown variable ${n}`)}function ft(t,e,n){if(t.has(e)){for(const[r]of t)if(r===e)return Q(t,e,new ut(n));throw new Error(`\n      ${e} is already bound in ${JSON.stringify(t)}\n    `)}return Q(t,e,new ut(n))}function dt(t,e,n,r){return Q(t,e,new ct(n,r))}function yt(t,e,n){return new Map([...t,[e,n]])}function wt(t,e){const n=t.now();if(n instanceof pe)return n.body.valOfClosure(e);if(n instanceof Pe){const t=n.type.now();if(t instanceof le)return new Pe(t.resultType.valOfClosure(e),new ne(n.neutral,new Lt(t.argType,e)))}throw new Error(`doApp: invalid input ${[n,e.now()]}`)}function mt(t,e,n,r){const s=t.now();if(s instanceof ue)return n;if(s instanceof he)return wt(r,mt(s.smaller,e,n,r));if(s instanceof Pe){if(s.type.now()instanceof ce)return new Pe(e,new kt(s.neutral,new Lt(e,n),new Lt(new le("n",new ce,new Qn(t=>e)),r)))}throw new Error(`invalid input for iterNat ${[t,e,n,r]}`)}function Et(t,e,n,r){const s=t.now();if(s instanceof ue)return n;if(s instanceof he)return wt(wt(r,s.smaller),Et(s.smaller,e,n,r));if(s instanceof Pe){if(s.type.now()instanceof ce)return new Pe(e,new $t(s.neutral,new Lt(e,n),new Lt(new le("n-1",new ce,new Qn(t=>new le("ih",e,new Qn(t=>e)))),r)))}throw new Error(`invalid input for recNat ${[t,e,n,r]}`)}function gt(t,e,n,r){const s=t.now();if(s instanceof ue)return n;if(s instanceof he)return wt(wt(r,s.smaller),gt(s.smaller,e,n,r));if(s instanceof Pe){if(s.type.now()instanceof ce)return new Pe(wt(e,t),new Mt(s.neutral,new Lt(new le("x",new ce,new Qn(t=>new Ae)),e),new Lt(wt(e,new ue),n),new Lt(new le("n-1",new ce,new Qn(t=>new le("ih",wt(e,t),new Qn(n=>wt(e,new he(t)))))),r)))}throw new Error(`invalid input for indNat ${[t,e,n,r]}`)}function Tt(t){const e=t.now();if(e instanceof de)return e.car;if(e instanceof Pe){const t=e.type.now();if(t instanceof fe){const n=t,r=e.neutral;return new Pe(n.carType,new Ut(r))}}throw new Error(`invalid input for car ${t}`)}function Nt(t){const e=t.now();if(e instanceof de)return e.cdr;if(e instanceof Pe){const n=e.type.now();if(n instanceof fe){const r=n,s=e.neutral;return new Pe(r.cdrType.valOfClosure(Tt(t)),new Bt(s))}}throw new Error(`invalid input for cdr ${t}`)}function vt(t,e,n,r){const s=t.now();if(s instanceof we)return n;if(s instanceof me)return wt(wt(wt(r,s.head),s.tail),vt(s.tail,e,n,r));if(s instanceof Pe){const i=s.type.now();if(i instanceof ye){const o=i.entryType,a=s.neutral,c=new le("xs",new ye(o),new Qn(t=>new Ae));return new Pe(wt(e,t),new Ht(a,new Lt(c,e),new Lt(wt(e,new we),n),new Lt(new le("h",o,new Qn(t=>new le("t",new ye(o),new Qn(n=>new le("ih",wt(e,n),new Qn(r=>wt(e,new me(t,n)))))))),r)))}}throw new Error(`invalid input for indList ${[s,e,n,r]}`)}function It(t,e,n,r){const s=t.now();if(s instanceof we)return n;if(s instanceof me){const t=s.head,i=s.tail;return wt(wt(wt(r,t),i),It(i,e,n,r))}if(s instanceof Pe){const t=s.type.now();if(t instanceof ye){const i=t.entryType,o=s.neutral;return new Pe(e,new Gt(o,new Lt(e,n),new Lt(new le("h",i,new Qn(t=>new le("t",new ye(i),new Qn(t=>new le("ih",e,new Qn(t=>e)))))),r)))}}throw new Error(`invalid input for recList ${[s,e,n,r]}`)}function _t(t){const e=t.now();if(e instanceof ve)return e.tail;if(e instanceof Pe&&e.type.now()instanceof Te&&e.type.now().length.now()instanceof he){const t=e.type.now();if(t instanceof Te){if(t.length.now()instanceof he)return new Pe(new Te(e.type.now().entryType,e.type.now().length.now().smaller),new Qt(e.neutral))}}throw new Error(`invalid input for tail ${t.prettyPrint()}`)}function Ot(t,e){return new le("k",new ce,new Qn(n=>new le("e",t,new Qn(r=>new le("es",new Te(t,n),new Qn(t=>new le("ih",wt(wt(e,n),t),new Qn(s=>wt(wt(e,new he(n)),new ve(r,t))))))))))}function Pt(t,e,n,r,s){const i=t.now(),o=e.now();if(i instanceof ue&&o instanceof Ne)return r;if(i instanceof he&&o instanceof ve)return wt(wt(wt(wt(s,i.smaller),o.head),_t(e)),Pt(i.smaller,o.tail,n,r,s));if(i instanceof Pe&&o instanceof Pe&&i.type.now()instanceof ce&&o.type.now()instanceof Te){const a=o.type.now().entryType;return new Pe(wt(wt(n,t),e),new Zt(i.neutral,o.neutral,new Lt(new le("k",new ce,new Qn(t=>new le("es",new Te(a,t),new Qn(t=>new Ae)))),n),new Lt(wt(wt(n,new ue),new Ne),r),new Lt(Ot(o.type.now().entryType,n),s)))}if(St(i,t)&&o instanceof Pe&&o.type.now()instanceof Te){const i=o.type.now().entryType;return new Pe(wt(wt(n,t),e),new Wt(new Lt(new ce,t),o.neutral,new Lt(new le("k",new ce,new Qn(t=>new le("es",new Te(i,t),new Qn(t=>new Ae)))),n),new Lt(wt(wt(n,new ce),new Ne),r),new Lt(Ot(i,n),s)))}throw new Error(`invalid input for indVec ${[t,e,n,r,s]}`)}function At(t,e,n,r,s,i){const o=e.now();if(o instanceof De){if(o.type!=t)throw new Error(`doEliminator: wrong eliminator used. Got constructor of type: ${o.type}; Expected: ${t}`);const e=o.index;if(e>=0&&e<r.length){let a=r[e];for(let t=0;t<o.args.length;t++){a=wt(a,o.args[t].now())}for(let e=0;e<o.recursive_args.length;e++){const c=o.recursive_args[e].now();a=wt(a,c);a=wt(a,At(t,c,n,r,s,i))}return a}}else if(o instanceof Pe){const a=o.type.now();if(a instanceof xe&&a.name===t){let c=n;for(const t of a.indices)c=wt(c,t);return c=wt(c,e),new Pe(c,new ee(t,o.neutral,new Lt(i||new le("x",a,new Qn(t=>new Ae)),n),r.map((t,e)=>new Lt(s&&s[e]?s[e]:a,t))))}}throw new Error(`doEliminator: invalid input for ${t}: ${[e,n,r]}`)}function St(t,e){const n=t.now(),r=e.now();return n instanceof ue&&r instanceof ue||n instanceof he&&r instanceof he&&St(n.smaller,r.smaller)}function bt(t,e,n){const r=e.now(),s=n.now();if(r instanceof Ae)return n.readBackType(t);if(r instanceof ce&&s instanceof ue)return new Ge;if(r instanceof ce&&s instanceof he)return new He(bt(t,new ce,s.smaller));if(r instanceof le){const e=tr(t,s instanceof pe?s.argName:r.argName);return new ze(e,bt(ft(t,e,r.argType),r.resultType.valOfClosure(new Pe(r.argType,new xt(e))),wt(s,new Pe(r.argType,new xt(e)))))}if(r instanceof fe){const e=Tt(n),s=Nt(n);return new Qe(bt(t,r.carType,e),bt(t,r.cdrType.valOfClosure(e),s))}if(r instanceof Se&&s instanceof ae)return new Xe(s.name);if(r instanceof be)return new an;if(r instanceof ye&&s instanceof we)return new en;if(r instanceof ye&&s instanceof me)return new Qe(bt(t,r.entryType,s.head),bt(t,new ye(r.entryType),s.tail));if(r instanceof Re&&s instanceof Pe)return new Me(new cn,s.neutral.readBackNeutral(t));if(r instanceof Ee&&s instanceof ge)return new ln(bt(t,r.type,s.value));if(r instanceof Te&&r.length.now()instanceof ue&&s instanceof Ne)return new gn;if(r instanceof Te&&r.length.now()instanceof he&&s instanceof ve)return r.length.now(),new En(bt(t,r.entryType,s.head),bt(t,new Te(r.entryType,r.length.now().smaller),s.tail));if(r instanceof Ie&&s instanceof _e)return new _n(bt(t,r.leftType,s.value));if(r instanceof Ie&&s instanceof Oe)return new On(bt(t,r.rightType,s.value));if(r instanceof xe&&s instanceof De){let e;for(const[n,r]of t)if(n===s.name&&r instanceof lt){e=r;break}if(!e)throw new Error(`Constructor ${s.name} not found in context`);const n=e.constructorType,i=n.resultType;let o=rt(t);for(let t=0;t<i.parameters.length;t++){const e=i.parameters[t];if(e instanceof bn){o=yt(o,e.name,r.parameters[t].now())}}for(let t=0;t<i.indices.length;t++){const e=i.indices[t];if(e instanceof bn){o=yt(o,e.name,r.indices[t].now())}}const a=e.type,c=[];a.indices.forEach(t=>{c.push(...rr(t))});const u=[];for(let e=0;e<s.args.length;e++){const r=bt(t,n.argTypes[e].valOf(o).now(),s.args[e]);if(u.push(r),e<c.length){o=yt(o,c[e],s.args[e].now())}}const h=[],l=s.args.length;for(let e=0;e<s.recursive_args.length;e++){const r=bt(t,n.rec_argTypes[e].valOf(o).now(),s.recursive_args[e]);h.push(r);const i=l+e;if(i<c.length){o=yt(o,c[i],s.recursive_args[e].now())}}return new xn(s.name,s.index,s.type,u,h)}if(s instanceof Pe)return s.neutral.readBackNeutral(t);throw new Error(`Cannot read back ${s.prettyPrint()} : ${r.prettyPrint()}`)}class Lt{constructor(t,e){this.type=t,this.value=e}}let Rt=class{constructor(){}toString(){return this.prettyPrint()}};class xt extends Rt{constructor(t){super(),this.name=t}readBackNeutral(t){return new bn(this.name)}prettyPrint(){return`N-${this.name}`}}let Ct=class extends Rt{constructor(t,e){super(),this.where=t,this.type=e}readBackNeutral(t){return new An(this.where,this.type.readBackType(t))}prettyPrint(){return"N-TODO"}},Dt=class extends Rt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new Fe(this.target.readBackNeutral(t),new Me(this.base.type.readBackType(t),bt(t,this.base.type,this.base.value)),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-WhichNat"}},kt=class extends Rt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new Ve(this.target.readBackNeutral(t),new Me(this.base.type.readBackType(t),bt(t,this.base.type,this.base.value)),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IterNat"}},$t=class extends Rt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new qe(this.target.readBackNeutral(t),new Me(this.base.type.readBackType(t),bt(t,this.base.type,this.base.value)),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-RecNat"}},Mt=class extends Rt{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}readBackNeutral(t){return new Ye(this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.base.type,this.base.value),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndNat"}},Ut=class extends Rt{constructor(t){super(),this.target=t}readBackNeutral(t){return new We(this.target.readBackNeutral(t))}prettyPrint(){return"N-Car"}},Bt=class extends Rt{constructor(t){super(),this.target=t}readBackNeutral(t){return new Ze(this.target.readBackNeutral(t))}prettyPrint(){return"N-Cdr"}},Gt=class extends Rt{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}readBackNeutral(t){return new rn(this.target.readBackNeutral(t),new Me(this.base.type.readBackType(t),bt(t,this.base.type,this.base.value)),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-RecList"}},Ht=class extends Rt{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}readBackNeutral(t){return new sn(this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.base.type,this.base.value),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndList"}},Ft=class extends Rt{constructor(t,e){super(),this.target=t,this.motive=e}readBackNeutral(t){return new un(new Me(new cn,this.target.readBackNeutral(t)),bt(t,this.motive.type,this.motive.value))}prettyPrint(){return"N-IndAbsurd"}},Vt=class extends Rt{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}readBackNeutral(t){return new pn(this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.base.type,this.base.value))}prettyPrint(){return"N-Replace"}};class qt extends Rt{constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new fn(this.target1.readBackNeutral(t),bt(t,this.target2.type,this.target2.value))}prettyPrint(){return"N-Trans1"}}class Yt extends Rt{constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new fn(bt(t,this.target1.type,this.target1.value),this.target2.readBackNeutral(t))}prettyPrint(){return"N-Trans2"}}class Kt extends Rt{constructor(t,e){super(),this.target1=t,this.target2=e}readBackNeutral(t){return new fn(this.target1.readBackNeutral(t),this.target2.readBackNeutral(t))}prettyPrint(){return"N-Trans12"}}let zt=class extends Rt{constructor(t,e){super(),this.target=t,this.func=e}readBackNeutral(t){const e=this.func.type;if(e instanceof le){const n=e.resultType;return new dn(this.target.readBackNeutral(t),n.valOfClosure(new Re).readBackType(t),bt(t,this.func.type,this.func.value))}throw new Error("Cong applied to non-Pi type.")}prettyPrint(){return"N-Cong"}},jt=class extends Rt{constructor(t){super(),this.target=t}readBackNeutral(t){return new yn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Symm"}},Xt=class extends Rt{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}readBackNeutral(t){return new wn(this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.base.type,this.base.value))}prettyPrint(){return"N-IndEqual"}},Jt=class extends Rt{constructor(t){super(),this.target=t}readBackNeutral(t){return new Tn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Head"}},Qt=class extends Rt{constructor(t){super(),this.target=t}readBackNeutral(t){return new Nn(this.target.readBackNeutral(t))}prettyPrint(){return"N-Tail"}};class Wt extends Rt{constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}readBackNeutral(t){return new vn(bt(t,this.length.type,this.length.value),this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.base.type,this.base.value),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndVec2"}}class Zt extends Rt{constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}readBackNeutral(t){return new vn(this.length.readBackNeutral(t),this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.base.type,this.base.value),bt(t,this.step.type,this.step.value))}prettyPrint(){return"N-IndVec12"}}let te=class extends Rt{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.baseLeft=n,this.baseRight=r}readBackNeutral(t){return new Pn(this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),bt(t,this.baseLeft.type,this.baseLeft.value),bt(t,this.baseRight.type,this.baseRight.value))}prettyPrint(){return"N-IndEither"}};class ee extends Rt{constructor(t,e,n,r){super(),this.typeName=t,this.target=e,this.motive=n,this.methods=r}readBackNeutral(t){return new Dn(this.typeName,this.target.readBackNeutral(t),bt(t,this.motive.type,this.motive.value),this.methods.map(e=>bt(t,e.type,e.value)))}prettyPrint(){return`N-GenericEliminator-${this.typeName}`}}let ne=class extends Rt{constructor(t,e){super(),this.operator=t,this.operand=e}readBackNeutral(t){return new Sn(this.operator.readBackNeutral(t),bt(t,this.operand.type,this.operand.value))}prettyPrint(){return"N-Application"}};class re{now(){return this}}class se{constructor(t,e){this.env=t,this.expr=e}undelay(){return this.expr.valOf(this.env).now()}toString(){return`DelayClosure(${this.env}, ${this.expr})`}}class ie{constructor(t){this.content=t}get(){return this.content}set(t){this.content=t}}class oe extends re{constructor(t){super(),this.val=t}now(){const t=this.val.get();if(t instanceof se){const e=t.undelay();return this.val.set(e),e}return t}readBackType(t){return this.now().readBackType(t)}prettyPrint(){return this.now().prettyPrint()}toString(){return`Delay(${this.val})`}}let ae=class extends re{constructor(t){super(),this.name=t}readBackType(t){throw new Error("No readBackType for Quote.")}prettyPrint(){return`'${this.name}`}toString(){return this.prettyPrint()}},ce=class extends re{constructor(){super()}readBackType(t){return new Be}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}},ue=class extends re{constructor(){super()}readBackType(t){throw new Error("No readBackType for Zero.")}prettyPrint(){return"zero"}toString(){return this.prettyPrint()}},he=class extends re{constructor(t){super(),this.smaller=t}readBackType(t){throw new Error("No readBackType for Add1.")}prettyPrint(){return`(add1 ${this.smaller.prettyPrint()})`}toString(){return this.prettyPrint()}},le=class extends re{constructor(t,e,n){super(),this.argName=t,this.argType=e,this.resultType=n}readBackType(t){const e=this.argType.readBackType(t),n=tr(t,this.argName),r=ft(t,n,this.argType);return new Ke(n,e,this.resultType.valOfClosure(new Pe(this.argType,new xt(n))).readBackType(r))}prettyPrint(){return`(Π ${this.argName} ${this.argType.prettyPrint()} ${this.resultType.prettyPrint()})`}toString(){return this.prettyPrint()}},pe=class extends re{constructor(t,e){super(),this.argName=t,this.body=e}readBackType(t){throw new Error("No readBackType for Lambda.")}prettyPrint(){return`(lambda ${this.argName} ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},fe=class extends re{constructor(t,e,n){super(),this.carName=t,this.carType=e,this.cdrType=n}readBackType(t){const e=this.carType.readBackType(t),n=tr(t,this.carName),r=ft(t,n,this.carType);return new Je(n,e,this.cdrType.valOfClosure(new Pe(this.carType,new xt(n))).readBackType(r))}prettyPrint(){return`(Σ ${this.carName} ${this.carType.prettyPrint()} ${this.cdrType.prettyPrint()})`}toString(){return this.prettyPrint()}},de=class extends re{constructor(t,e){super(),this.car=t,this.cdr=e}readBackType(t){throw new Error("No readBackType for Cons.")}prettyPrint(){return`(cons ${this.car.prettyPrint()} ${this.cdr.prettyPrint()})`}toString(){return this.prettyPrint()}},ye=class extends re{constructor(t){super(),this.entryType=t}readBackType(t){return new nn(this.entryType.readBackType(t))}prettyPrint(){return`(List ${this.entryType.prettyPrint()})`}toString(){return this.prettyPrint()}},we=class extends re{constructor(){super()}readBackType(t){throw new Error("No readBackType for Nil.")}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}},me=class extends re{constructor(t,e){super(),this.head=t,this.tail=e}readBackType(t){throw new Error("No readBackType for ListCons.")}prettyPrint(){return`(:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},Ee=class extends re{constructor(t,e,n){super(),this.type=t,this.from=e,this.to=n}readBackType(t){return new hn(this.type.readBackType(t),bt(t,this.type,this.from),bt(t,this.type,this.to))}prettyPrint(){return`(= ${this.type.prettyPrint()} ${this.from.prettyPrint()} ${this.to.prettyPrint()})`}toString(){return this.prettyPrint()}},ge=class extends re{constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Same.")}prettyPrint(){return`(same ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Te=class extends re{constructor(t,e){super(),this.entryType=t,this.length=e}readBackType(t){return new mn(this.entryType.readBackType(t),bt(t,new ce,this.length))}prettyPrint(){return`(Vec ${this.entryType.prettyPrint()} ${this.length.prettyPrint()})`}},Ne=class extends re{constructor(){super()}readBackType(t){throw new Error("No readBackType for VecNil.")}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}},ve=class extends re{constructor(t,e){super(),this.head=t,this.tail=e}readBackType(t){throw new Error("No readBackType for VecCons.")}prettyPrint(){return`(vec:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},Ie=class extends re{constructor(t,e){super(),this.leftType=t,this.rightType=e}readBackType(t){return new In(this.leftType.readBackType(t),this.rightType.readBackType(t))}prettyPrint(){return`(Either ${this.leftType.prettyPrint()} ${this.rightType.prettyPrint()})`}toString(){return this.prettyPrint()}},_e=class extends re{constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Left.")}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Oe=class extends re{constructor(t){super(),this.value=t}readBackType(t){throw new Error("No readBackType for Right.")}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}};class Pe extends re{constructor(t,e){super(),this.type=t,this.neutral=e}readBackType(t){return this.neutral.readBackNeutral(t)}prettyPrint(){return`(Neutral ${this.type.prettyPrint()} ${this.neutral.prettyPrint()})`}toString(){return this.prettyPrint()}}let Ae=class extends re{constructor(){super()}readBackType(t){return new Ue}prettyPrint(){return"U"}toString(){return this.prettyPrint()}},Se=class extends re{constructor(){super()}readBackType(t){return new je}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}},be=class extends re{constructor(){super()}readBackType(t){return new on}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}},Le=class extends re{constructor(){super()}readBackType(t){throw new Error("No readBackType for Sole.")}prettyPrint(){return"sole"}toString(){return this.prettyPrint()}},Re=class extends re{constructor(){super()}readBackType(t){return new cn}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}},xe=class extends re{constructor(t,e,n){super(),this.name=t,this.parameters=e,this.indices=n}readBackType(t){const e=t.get(this.name);let n=[];if(e&&e instanceof ht){const t=e.type;t instanceof Ce&&(n=t.indexTypes)}return new Ln(this.name,this.parameters.map(e=>e.readBackType(t)),this.indices.map((e,r)=>{const s=n[r]?.now();if(!(e instanceof oe)){const n=e.now();if(s)return bt(t,s,n);if(n instanceof Pe)return n.neutral.readBackNeutral(t);throw new Error(`Cannot read back index without type: ${n.prettyPrint()}`)}{const n=e.val.get();if(!(n instanceof se)){const e=n;if(s)return bt(t,s,e);if(e instanceof Pe)return e.neutral.readBackNeutral(t);throw new Error(`Cannot read back index without type: ${e.prettyPrint()}`)}try{const r=e.now();return s?bt(t,s,r):r instanceof Pe?r.neutral.readBackNeutral(t):n.expr}catch{return n.expr}}}))}prettyPrint(){return`InductiveType ${this.name}`}toString(){return this.prettyPrint()}},Ce=class extends re{constructor(t,e,n){super(),this.name=t,this.parameterTypes=e,this.indexTypes=n}readBackType(t){return new Rn(this.name,this.parameterTypes.map(e=>e.readBackType(t)),this.indexTypes.map(e=>e.readBackType(t)))}prettyPrint(){return`InductiveType ${this.name}`}toString(){return this.prettyPrint()}},De=class extends re{constructor(t,e,n,r,s){super(),this.name=t,this.type=e,this.args=n,this.index=r,this.recursive_args=s}readBackType(t){throw new Error("No readBackType for Constructor.")}prettyPrint(){const t=this.args.map(t=>t.prettyPrint()).join(" ");return`(${this.name}${t.length>0?" "+t:""})`}toString(){return this.prettyPrint()}},ke=class extends re{constructor(t,e,n,r,s,i,o,a){super(),this.name=t,this.index=e,this.type=n,this.argTypes=r,this.rec_argTypes=s,this.resultType=i,this.argNames=o,this.rec_argNames=a}readBackType(t){throw Error("Method not implemented")}prettyPrint(){return`ConstructorType (${this.argTypes.map(t=>t.prettyPrint()).join(" ")})`}};class $e{toLazy(t){return new oe(new ie(new se(t,this)))}}let Me=class extends $e{constructor(t,e){super(),this.type=t,this.expr=e}valOf(t){return this.expr.valOf(t)}prettyPrint(){return`(the ${this.type.prettyPrint()} ${this.expr.prettyPrint()})`}toString(){return this.prettyPrint()}},Ue=class extends $e{valOf(t){return new Ae}prettyPrint(){return"U"}toString(){return this.prettyPrint()}},Be=class extends $e{valOf(t){return new ce}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}},Ge=class extends $e{valOf(t){return new ue}prettyPrint(){return"0"}toString(){return this.prettyPrint()}},He=class extends $e{constructor(t){super(),this.n=t}valOf(t){return new he(this.n.toLazy(t))}prettyPrint(){const t=Number(this.n.prettyPrint());return isNaN(t)?`(add1 ${this.n.prettyPrint()})`:`${t+1}`}toString(){return this.prettyPrint()}},Fe=class extends $e{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return function(t,e,n,r){const s=t.now();if(s instanceof ue)return n;if(s instanceof he)return wt(r,s.smaller);if(s instanceof Pe&&s.type.now()instanceof ce)return new Pe(e,new Dt(s.neutral,new Lt(e,n),new Lt(new le("n",new ce,new Qn(t=>e)),r)));throw new Error(`invalid input for whichNat ${[t,e,n,r]}`)}(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(which-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Ve=class extends $e{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return mt(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(iter-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},qe=class extends $e{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return Et(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(rec-Nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Ye=class extends $e{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}valOf(t){return gt(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(ind-Nat ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},Ke=class extends $e{constructor(t,e,n){super(),this.name=t,this.type=e,this.body=n}valOf(t){const e=this.type.toLazy(t);return new le(this.name,e,new Jn(t,this.name,this.body))}prettyPrint(){return`(Π (${this.name} ${this.type.prettyPrint()}) \n          ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},ze=class extends $e{constructor(t,e){super(),this.param=t,this.body=e}valOf(t){return new pe(this.param,new Jn(t,this.param,this.body))}prettyPrint(){return`(λ (${this.param}) ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},je=class extends $e{valOf(t){return new Se}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}},Xe=class extends $e{constructor(t){super(),this.sym=t}valOf(t){return new ae(this.sym)}prettyPrint(){return`'${this.sym}`}toString(){return this.prettyPrint()}},Je=class extends $e{constructor(t,e,n){super(),this.name=t,this.type=e,this.body=n}valOf(t){const e=this.type.toLazy(t);return new fe(this.name,e,new Jn(t,this.name,this.body))}prettyPrint(){return`(Σ (${this.name} ${this.type.prettyPrint()}) \n              ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}},Qe=class extends $e{constructor(t,e){super(),this.first=t,this.second=e}valOf(t){const e=this.first.toLazy(t),n=this.second.toLazy(t);return new de(e,n)}prettyPrint(){return`(cons ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}},We=class extends $e{constructor(t){super(),this.pair=t}valOf(t){return Tt(this.pair.toLazy(t))}prettyPrint(){return`(car ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}},Ze=class extends $e{constructor(t){super(),this.pair=t}valOf(t){return Nt(this.pair.toLazy(t))}prettyPrint(){return`(cdr ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}},tn=class extends $e{constructor(t,e){super(),this.head=t,this.tail=e}valOf(t){const e=this.head.toLazy(t),n=this.tail.toLazy(t);return new me(e,n)}prettyPrint(){return`(:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},en=class extends $e{valOf(t){return new we}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}},nn=class extends $e{constructor(t){super(),this.elemType=t}valOf(t){return new ye(this.elemType.toLazy(t))}prettyPrint(){return`(List ${this.elemType.prettyPrint()})`}toString(){return this.prettyPrint()}},rn=class extends $e{constructor(t,e,n){super(),this.target=t,this.base=e,this.step=n}valOf(t){return It(this.target.toLazy(t),this.base.type.toLazy(t),this.base.expr.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(rec-List ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},sn=class extends $e{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.base=n,this.step=r}valOf(t){return vt(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`(ind-List ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}},on=class extends $e{valOf(t){return new be}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}},an=class extends $e{valOf(t){return new Le}prettyPrint(){return"sole"}toString(){return this.prettyPrint()}},cn=class extends $e{valOf(t){return new Re}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}},un=class extends $e{constructor(t,e){super(),this.target=t,this.motive=e}valOf(t){return function(t,e){const n=t.now();if(n instanceof Pe&&n.type.now()instanceof Re)return new Pe(e,new Ft(n.neutral,new Lt(new Ae,e)));throw new Error(`invalid input for indAbsurd ${[t,e]}`)}(this.target.toLazy(t),this.motive.toLazy(t))}prettyPrint(){return`(ind-Absurd \n              ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()})`}toString(){return this.prettyPrint()}},hn=class extends $e{constructor(t,e,n){super(),this.type=t,this.left=e,this.right=n}valOf(t){return new Ee(this.type.toLazy(t),this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(= ${this.type.prettyPrint()} \n              ${this.left.prettyPrint()} \n              ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},ln=class extends $e{constructor(t){super(),this.type=t}valOf(t){return new ge(this.type.toLazy(t))}prettyPrint(){return`(same ${this.type.prettyPrint()})`}toString(){return this.prettyPrint()}},pn=class extends $e{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof ge)return n;if(r instanceof Pe){const t=r.type.now();if(t instanceof Ee){const s=r.neutral,i=t.type,o=t.from,a=t.to;return new Pe(wt(e,a),new Vt(s,new Lt(new le("x",i,new Qn(t=>new Ae)),e),new Lt(wt(e,o),n)))}}throw new Error(`invalid input for replace ${[t,e,n]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t))}prettyPrint(){return`(replace ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}},fn=class extends $e{constructor(t,e){super(),this.left=t,this.right=e}valOf(t){return function(t,e){const n=t.now(),r=e.now();if(n instanceof ge&&r instanceof ge)return new ge(n.value);if(n instanceof ge&&r instanceof Pe){const t=r.type.now();if(t instanceof Ee){const e=n.value,s=t.to,i=t.type,o=r.neutral;return new Pe(new Ee(i,e,s),new Yt(new Lt(new Ee(i,e,e),new ge(e)),o))}}else if(n instanceof Pe&&r instanceof ge){const t=n.type.now();if(t instanceof Ee){const e=t.from,s=r.value,i=t.type,o=n.neutral;return new Pe(new Ee(i,e,s),new qt(o,new Lt(new Ee(i,s,s),new ge(s))))}}else if(n instanceof Pe&&r instanceof Pe){const t=n.type.now(),e=r.type.now();if(t instanceof Ee&&e instanceof Ee){const s=t.from,i=e.to,o=t.type,a=n.neutral,c=r.neutral;return new Pe(new Ee(o,s,i),new Kt(a,c))}}throw new Error(`invalid input for do-trans: ${[t,e]}`)}(this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(trans ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},dn=class extends $e{constructor(t,e,n){super(),this.target=t,this.base=e,this.fun=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof ge)return new ge(wt(n,r.value));if(r instanceof Pe){const t=r.type.now();if(t instanceof Ee){const s=t.type,i=t.from,o=t.to,a=r.neutral;return new Pe(new Ee(e,wt(n,i),wt(n,o)),new zt(a,new Lt(new le("x",s,new Qn(t=>e)),n)))}}throw new Error(`invalid input for cong ${[t,e,n]}`)}(this.target.toLazy(t),this.base.toLazy(t),this.fun.toLazy(t))}prettyPrint(){return`(cong ${this.target.prettyPrint()} ${this.fun.prettyPrint()})`}toString(){return this.prettyPrint()}},yn=class extends $e{constructor(t){super(),this.equality=t}valOf(t){return function(t){const e=t.now();if(e instanceof ge)return new ge(e.value);if(e instanceof Pe){const t=e.type.now();if(t instanceof Ee)return new Pe(new Ee(t.type,t.to,t.from),new jt(e.neutral))}throw new Error(`invalid input for symm ${t}`)}(this.equality.toLazy(t))}prettyPrint(){return`(symm ${this.equality.prettyPrint()})`}toString(){return this.prettyPrint()}},wn=class extends $e{constructor(t,e,n){super(),this.target=t,this.motive=e,this.base=n}valOf(t){return function(t,e,n){const r=t.now();if(r instanceof ge)return n;if(r instanceof Pe){const s=r.type.now();if(s instanceof Ee){const i=s.type,o=s.from,a=s.to,c=r.neutral;return new Pe(wt(wt(e,a),t),new Xt(c,new Lt(new le("to",i,new Qn(t=>new le("p",new Ee(i,o,t),new Qn(t=>new Ae)))),e),new Lt(wt(wt(e,o),new ge(o)),n)))}}throw new Error(`invalid input for indEqual ${[t,e,n]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t))}prettyPrint(){return`(ind-= ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}},mn=class extends $e{constructor(t,e){super(),this.type=t,this.length=e}valOf(t){return new Te(this.type.toLazy(t),this.length.toLazy(t))}prettyPrint(){return`(Vec ${this.type.prettyPrint()} ${this.length.prettyPrint()})`}toString(){return this.prettyPrint()}},En=class extends $e{constructor(t,e){super(),this.head=t,this.tail=e}valOf(t){return new ve(this.head.toLazy(t),this.tail.toLazy(t))}prettyPrint(){return`(vec:: ${this.head.prettyPrint()} ${this.tail.prettyPrint()})`}toString(){return this.prettyPrint()}},gn=class extends $e{valOf(t){return new Ne}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}},Tn=class extends $e{constructor(t){super(),this.vec=t}valOf(t){return function(t){const e=t.now();if(e instanceof ve)return e.head;if(e instanceof Pe){const t=e.type.now();if(t instanceof Te&&t.length.now()instanceof he)return new Pe(t.entryType,new Jt(e.neutral))}throw new Error(`invalid input for head ${t}`)}(this.vec.toLazy(t))}prettyPrint(){return`(head ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}},Nn=class extends $e{constructor(t){super(),this.vec=t}valOf(t){return _t(this.vec.toLazy(t))}prettyPrint(){return`(tail ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}},vn=class extends $e{constructor(t,e,n,r,s){super(),this.length=t,this.target=e,this.motive=n,this.base=r,this.step=s}valOf(t){return Pt(this.length.toLazy(t),this.target.toLazy(t),this.motive.toLazy(t),this.base.toLazy(t),this.step.toLazy(t))}prettyPrint(){return`ind-Vec ${this.length.prettyPrint()}\n              ${this.target.prettyPrint()}\n              ${this.motive.prettyPrint()}\n              ${this.base.prettyPrint()}\n              ${this.step.prettyPrint()}`}toString(){return this.prettyPrint()}},In=class extends $e{constructor(t,e){super(),this.left=t,this.right=e}valOf(t){return new Ie(this.left.toLazy(t),this.right.toLazy(t))}prettyPrint(){return`(Either ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}},_n=class extends $e{constructor(t){super(),this.value=t}valOf(t){return new _e(this.value.toLazy(t))}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},On=class extends $e{constructor(t){super(),this.value=t}valOf(t){return new Oe(this.value.toLazy(t))}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}},Pn=class extends $e{constructor(t,e,n,r){super(),this.target=t,this.motive=e,this.baseLeft=n,this.baseRight=r}valOf(t){return function(t,e,n,r){const s=t.now();if(s instanceof _e)return wt(n,s.value);if(s instanceof Oe)return wt(r,s.value);if(s instanceof Pe){const i=s.type.now();if(i instanceof Ie){const o=i.leftType,a=i.rightType,c=new le("x",new Ie(o,a),new Qn(t=>new Ae));return new Pe(wt(e,t),new te(s.neutral,new Lt(c,e),new Lt(new le("x",o,new Qn(t=>wt(e,new _e(t)))),n),new Lt(new le("x",a,new Qn(t=>wt(e,new Oe(t)))),r)))}}throw new Error(`invalid input for indEither: ${[t,e,n,r]}`)}(this.target.toLazy(t),this.motive.toLazy(t),this.baseLeft.toLazy(t),this.baseRight.toLazy(t))}prettyPrint(){return`(ind-Either ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.baseLeft.prettyPrint()} \n              ${this.baseRight.prettyPrint()})`}toString(){return this.prettyPrint()}},An=class extends $e{constructor(t,e){super(),this.loc=t,this.type=e}valOf(t){return new Pe(this.type.toLazy(t),new Ct(this.loc,this.type.toLazy(t)))}prettyPrint(){return`TODO ${this.type.prettyPrint()}`}toString(){return this.prettyPrint()}},Sn=class extends $e{constructor(t,e){super(),this.fun=t,this.arg=e}valOf(t){return wt(this.fun.toLazy(t),this.arg.toLazy(t))}prettyPrint(){return`(${this.fun.prettyPrint()} ${this.arg.prettyPrint()})`}toString(){return this.prettyPrint()}};class bn extends $e{constructor(t){super(),this.name=t}valOf(t){if(Wn(this.name))return function(t,e){if(t.has(e))return t.get(e);throw new Error(`Variable ${e} not found in environment`)}(t,this.name);throw new Error(`${this.name} is not a valid variable name`)}prettyPrint(){return this.name}toString(){return this.prettyPrint()}}let Ln=class extends $e{valOf(t){return new xe(this.typeName,this.parameters.map(e=>e.toLazy(t)),this.indices.map(e=>e.toLazy(t)))}constructor(t,e,n){super(),this.typeName=t,this.parameters=e,this.indices=n}prettyPrint(){return`${this.typeName}${this.parameters.length>0?" "+this.parameters.map(t=>t.prettyPrint()).join(" "):""}${this.indices.length>0?" "+this.indices.map(t=>t.prettyPrint()).join(" "):""}`}toString(){return this.prettyPrint()}},Rn=class extends $e{valOf(t){return new Ce(this.typeName,this.parameterTypes.map(e=>e.toLazy(t)),this.indexTypes.map(e=>e.toLazy(t)))}constructor(t,e,n){super(),this.typeName=t,this.parameterTypes=e,this.indexTypes=n}prettyPrint(){return`${this.typeName}${this.parameterTypes.length>0?" "+this.parameterTypes.map(t=>t.prettyPrint()).join(" "):""}${this.indexTypes.length>0?" "+this.indexTypes.map(t=>t.prettyPrint()).join(" "):""}`}};class xn extends $e{constructor(t,e,n,r,s){super(),this.name=t,this.index=e,this.type=n,this.args=r,this.recursive_args=s}valOf(t){return new De(this.name,this.type,this.args.map(e=>e.toLazy(t)),this.index,this.recursive_args.map(e=>e.toLazy(t)))}prettyPrint(){const t=this.args.map(t=>t.prettyPrint()).join(" ");return`(${this.name}${t.length>0?" "+t:""})`}}class Cn extends $e{constructor(t,e,n,r,s,i,o,a){super(),this.name=t,this.index=e,this.type=n,this.argTypes=r,this.rec_argTypes=s,this.resultType=i,this.argNames=o,this.rec_argNames=a}valOf(t){return new ke(this.name,this.index,this.type,this.argTypes.map(e=>e.toLazy(t)),this.rec_argTypes.map(e=>e.toLazy(t)),this.resultType.toLazy(t),this.argNames,this.rec_argNames)}prettyPrint(){return`ConstructorType ${this.name} : ${this.argTypes.map(t=>t.prettyPrint()).join(" -> ")} -> ${this.resultType.prettyPrint()}`}}class Dn extends $e{constructor(t,e,n,r,s,i){super(),this.typeName=t,this.target=e,this.motive=n,this.methods=r,this.methodTypes=s,this.motiveType=i}valOf(t){return At(this.typeName,this.target.toLazy(t),this.motive.toLazy(t),this.methods.map(e=>e.toLazy(t)),this.methodTypes?this.methodTypes.map(e=>e.toLazy(t)):void 0,this.motiveType?this.motiveType.toLazy(t):void 0)}prettyPrint(){const t=this.methods.map(t=>t.prettyPrint()).join(" ");return`(ind-${this.typeName} ${this.target.prettyPrint()} ${this.motive.prettyPrint()} ${t})`}}const kn={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},$n={"₀":"0","₁":"1","₂":"2","₃":"3","₄":"4","₅":"5","₆":"6","₇":"7","₈":"8","₉":"9"};function Mn(t,e){if(t.some(t=>t===e)){return Un(t,function(t){const[e,n]=Gn(t,t.length-1);return[e,n]}(e))}return e}function Un(t,e){const n=function([t,e]){const n=function(t){const e=t.toString().split("").map(t=>kn[t]||t).join("");return e}(e);return t+n}(e);return t.map(t=>t.toString()).includes(n.toString())?Un(t,function(t){return[t[0],t[1]+1]}(e)):n}function Bn(t){const e=t.split("").map(t=>$n[t]||t).join("");return parseInt(e,10)||1}function Gn(t,e){return e<0?[t,0]:(n=t[e],Object.keys($n).includes(n)?Gn(t,e-1):[t.substring(0,e+1),Bn(t.substring(e+1))]);var n}class Hn{constructor(t,e){this.location=t,this.varName=e}prettyPrint(){return`${this.varName}`}}class Fn{constructor(t,e){this.binder=t,this.type=e}prettyPrint(){return`${this.binder.prettyPrint()} : ${this.type.prettyPrint()}`}findNames(){return this.binder.varName}}class Vn{constructor(t){this.message=t}toString(){return this.message.map(t=>"string"==typeof t?t:t.prettyPrint()).join(" ")}}class qn{}class Yn extends qn{constructor(t){super(),this.result=t}}class Kn extends qn{constructor(t,e){super(),this.where=t,this.message=e}}class zn{constructor(t,e=void 0){this.name=t,this.value=e}}function jn(t,e){for(const[e,n]of t){const t=n();if(!(t instanceof Yn)){if(t instanceof Kn)throw new Error(`Error: ${t.message.toString()} at ${t.where}`);throw new Error("Internal error: expected go/stop, got "+typeof t)}e.value=t.result}return e()}class Xn{constructor(){}}class Jn extends Xn{constructor(t,e,n){super(),this.env=t,this.varName=e,this.expr=n}valOfClosure(t){return this.expr.valOf(yt(this.env,this.varName,t))}prettyPrint(){return`(CLOS ${this.varName} ${this.expr.prettyPrint()})`}toString(){return this.prettyPrint()}}class Qn extends Xn{constructor(t){super(),this.proc=t}valOfClosure(t){return this.proc(t)}prettyPrint(){return this.proc.toString()}toString(){return this.prettyPrint()}}function Wn(t){return!("U"===(e=t)||"Nat"===e||"zero"===e||"add1"===e||"which-Nat"===e||"iter-Nat"===e||"rec-Nat"===e||"ind-Nat"===e||"->"===e||"→"===e||"Π"===e||"λ"===e||"Pi"===e||"∏"===e||"lambda"===e||"quote"===e||"Atom"===e||"car"===e||"cdr"===e||"cons"===e||"Σ"===e||"Sigma"===e||"Pair"===e||"Trivial"===e||"sole"===e||"List"===e||"::"===e||"nil"===e||"rec-List"===e||"ind-List"===e||"Absurd"===e||"ind-Absurd"===e||"="===e||"same"===e||"replace"===e||"trans"===e||"cong"===e||"symm"===e||"ind-="===e||"Vec"===e||"vecnil"===e||"vec::"===e||"head"===e||"tail"===e||"ind-Vec"===e||"Either"===e||"left"===e||"right"===e||"ind-Either"===e||"TODO"===e||"the"===e)&&isNaN(Number(t));var e}function Zn(t){return Array.from(t.keys())}function tr(t,e){return Mn(Zn(t),e)}function er(t,e,n){return Mn(Zn(t).concat(e.findNames()),n)}function nr(t){return[t.binder.varName].concat(t.type.findNames())}function rr(t){const e=[];return sr(t,e),e}function sr(t,e){if(t instanceof oe){const n=t.val.get();if(n instanceof se)return void ir(n.expr,e);t=n}const n=t.now();n instanceof Pe&&n.neutral instanceof xt?e.includes(n.neutral.name)||e.push(n.neutral.name):n instanceof he?sr(n.smaller,e):n instanceof xe&&(n.parameters.forEach(t=>sr(t,e)),n.indices.forEach(t=>sr(t,e)))}function ir(t,e){t instanceof bn?e.includes(t.name)||e.push(t.name):t instanceof He?ir(t.n,e):t instanceof Ln&&(t.parameters.forEach(t=>ir(t,e)),t.indices.forEach(t=>ir(t,e)))}function or(t,e){return hr(0,new Map,new Map,t,e)}const ar=-1;function cr(t,e,n){return t.set(e,n)}function ur(t,e){return e.has(t)?e.get(t):ar}function hr(t,e,n,r,s){if(r instanceof bn&&s instanceof bn){const t=r.name,i=s.name;if(Wn(t)&&Wn(i)){const r=ur(t,e),s=ur(i,n);return r!==ar&&s!==ar?r===s:r===ar&&s===ar&&t===i}return!1}if(r instanceof Xe&&s instanceof Xe)return r.sym===s.sym;if(r instanceof Ke&&s instanceof Ke)return hr(t,e,n,r.type,s.type)&&hr(t+1,cr(e,r.name,t),cr(n,s.name,t),r.body,s.body);if(r instanceof Je&&s instanceof Je)return hr(t,e,n,r.type,s.type)&&hr(t+1,cr(e,r.name,t),cr(n,s.name,t),r.body,s.body);if(r instanceof ze&&s instanceof ze)return hr(t+1,cr(e,r.param,t),cr(n,s.param,t),r.body,s.body);if(r instanceof Me&&s instanceof Me&&r.type instanceof cn&&s.type instanceof cn)return!0;if(r instanceof Sn&&s instanceof Sn)return hr(t,e,n,r.fun,s.fun)&&hr(t,e,n,r.arg,s.arg);if(r instanceof Ue&&s instanceof Ue||r instanceof Be&&s instanceof Be||r instanceof Ge&&s instanceof Ge||r instanceof je&&s instanceof je||r instanceof cn&&s instanceof cn||r instanceof an&&s instanceof an||r instanceof en&&s instanceof en||r instanceof gn&&s instanceof gn||r instanceof on&&s instanceof on)return!0;if(r instanceof Me&&s instanceof Me)return hr(t,e,n,r.type,s.type)&&hr(t,e,n,r.expr,s.expr);if(r instanceof nn&&s instanceof nn)return hr(t,e,n,r.elemType,s.elemType);if(r instanceof He&&s instanceof He)return hr(t,e,n,r.n,s.n);if(r instanceof Fe&&s instanceof Fe)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof Ve&&s instanceof Ve)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof qe&&s instanceof qe)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof Ye&&s instanceof Ye)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof Qe&&s instanceof Qe)return hr(t,e,n,r.first,s.first)&&hr(t,e,n,r.second,s.second);if(r instanceof We&&s instanceof We)return hr(t,e,n,r.pair,s.pair);if(r instanceof Ze&&s instanceof Ze)return hr(t,e,n,r.pair,s.pair);if(r instanceof tn&&s instanceof tn)return hr(t,e,n,r.head,s.head)&&hr(t,e,n,r.tail,s.tail);if(r instanceof rn&&s instanceof rn)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof sn&&s instanceof sn)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof un&&s instanceof un)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive);if(r instanceof hn&&s instanceof hn)return hr(t,e,n,r.type,s.type)&&hr(t,e,n,r.left,s.left)&&hr(t,e,n,r.right,s.right);if(r instanceof ln&&s instanceof ln)return hr(t,e,n,r.type,s.type);if(r instanceof pn&&s instanceof pn)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive)&&hr(t,e,n,r.base,s.base);if(r instanceof fn&&s instanceof fn)return hr(t,e,n,r.left,s.left)&&hr(t,e,n,r.right,s.right);if(r instanceof dn&&s instanceof dn)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.fun,s.fun);if(r instanceof yn&&s instanceof yn)return hr(t,e,n,r.equality,s.equality);if(r instanceof wn&&s instanceof wn)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive)&&hr(t,e,n,r.base,s.base);if(r instanceof mn&&s instanceof mn)return hr(t,e,n,r.type,s.type)&&hr(t,e,n,r.length,s.length);if(r instanceof En&&s instanceof En)return hr(t,e,n,r.head,s.head)&&hr(t,e,n,r.tail,s.tail);if(r instanceof Tn&&s instanceof Tn)return hr(t,e,n,r.vec,s.vec);if(r instanceof Nn&&s instanceof Nn)return hr(t,e,n,r.vec,s.vec);if(r instanceof vn&&s instanceof vn)return hr(t,e,n,r.length,s.length)&&hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive)&&hr(t,e,n,r.base,s.base)&&hr(t,e,n,r.step,s.step);if(r instanceof In&&s instanceof In)return hr(t,e,n,r.left,s.left)&&hr(t,e,n,r.right,s.right);if(r instanceof _n&&s instanceof _n)return hr(t,e,n,r.value,s.value);if(r instanceof On&&s instanceof On)return hr(t,e,n,r.value,s.value);if(r instanceof Pn&&s instanceof Pn)return hr(t,e,n,r.target,s.target)&&hr(t,e,n,r.motive,s.motive)&&hr(t,e,n,r.baseLeft,s.baseLeft)&&hr(t,e,n,r.baseRight,s.baseRight);if(r instanceof An&&s instanceof An)return function(t,e){return t.startLine===e.startLine&&t.startColumn===e.startColumn&&t.endLine===e.endLine&&t.endColumn===e.endColumn}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */(r.loc,s.loc)&&hr(t,e,n,r.type,s.type);if(r instanceof Ln&&s instanceof Ln){if(r.typeName!==s.typeName)return!1;if(r.parameters.length!==s.parameters.length)return!1;if(r.indices.length!==s.indices.length)return!1;for(let i=0;i<r.parameters.length;i++)if(!hr(t,e,n,r.parameters[i],s.parameters[i]))return!1;for(let i=0;i<r.indices.length;i++)if(!hr(t,e,n,r.indices[i],s.indices[i]))return!1;return!0}return!1}var lr,pr,fr,dr,yr,wr,mr,Er,gr,Tr,Nr,vr,Ir,_r,Or,Pr,Ar,Sr,br,Lr,Rr,xr,Cr,Dr,kr,$r,Mr,Ur,Br,Gr,Hr,Fr,Vr,qr,Yr,Kr,zr,jr,Xr,Jr,Qr,Wr,Zr,ts,es,ns,rs,ss,is,os,as,cs,us,hs,ls,ps,fs,ds;function ys(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(t);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(n[r[s]]=t[r[s]])}return n}function ws(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ms(t){return this instanceof ms?(this.v=t,this):new ms(t)}function Es(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(t,e||[]),i=[];return r=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",function(t){return function(e){return Promise.resolve(e).then(t,u)}}),r[Symbol.asyncIterator]=function(){return this},r;function o(t,e){s[t]&&(r[t]=function(e){return new Promise(function(n,r){i.push([t,e,n,r])>1||a(t,e)})},e&&(r[t]=e(r[t])))}function a(t,e){try{(n=s[t](e)).value instanceof ms?Promise.resolve(n.value.v).then(c,u):h(i[0][2],n)}catch(t){h(i[0][3],t)}var n}function c(t){a("next",t)}function u(t){a("throw",t)}function h(t,e){t(e),i.shift(),i.length&&a(i[0][0],i[0][1])}}function gs(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,n=t[Symbol.asyncIterator];return n?n.call(t):(t=ws(t),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);function r(n){e[n]=t[n]&&function(e){return new Promise(function(r,s){(function(t,e,n,r){Promise.resolve(r).then(function(e){t({value:e,done:n})},e)})(r,s,(e=t[n](e)).done,e.value)})}}}!function(t){t.OUTCOME_UNSPECIFIED="OUTCOME_UNSPECIFIED",t.OUTCOME_OK="OUTCOME_OK",t.OUTCOME_FAILED="OUTCOME_FAILED",t.OUTCOME_DEADLINE_EXCEEDED="OUTCOME_DEADLINE_EXCEEDED"}(lr||(lr={})),function(t){t.LANGUAGE_UNSPECIFIED="LANGUAGE_UNSPECIFIED",t.PYTHON="PYTHON"}(pr||(pr={})),function(t){t.SCHEDULING_UNSPECIFIED="SCHEDULING_UNSPECIFIED",t.SILENT="SILENT",t.WHEN_IDLE="WHEN_IDLE",t.INTERRUPT="INTERRUPT"}(fr||(fr={})),function(t){t.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",t.STRING="STRING",t.NUMBER="NUMBER",t.INTEGER="INTEGER",t.BOOLEAN="BOOLEAN",t.ARRAY="ARRAY",t.OBJECT="OBJECT",t.NULL="NULL"}(dr||(dr={})),function(t){t.API_SPEC_UNSPECIFIED="API_SPEC_UNSPECIFIED",t.SIMPLE_SEARCH="SIMPLE_SEARCH",t.ELASTIC_SEARCH="ELASTIC_SEARCH"}(yr||(yr={})),function(t){t.AUTH_TYPE_UNSPECIFIED="AUTH_TYPE_UNSPECIFIED",t.NO_AUTH="NO_AUTH",t.API_KEY_AUTH="API_KEY_AUTH",t.HTTP_BASIC_AUTH="HTTP_BASIC_AUTH",t.GOOGLE_SERVICE_ACCOUNT_AUTH="GOOGLE_SERVICE_ACCOUNT_AUTH",t.OAUTH="OAUTH",t.OIDC_AUTH="OIDC_AUTH"}(wr||(wr={})),function(t){t.HTTP_IN_UNSPECIFIED="HTTP_IN_UNSPECIFIED",t.HTTP_IN_QUERY="HTTP_IN_QUERY",t.HTTP_IN_HEADER="HTTP_IN_HEADER",t.HTTP_IN_PATH="HTTP_IN_PATH",t.HTTP_IN_BODY="HTTP_IN_BODY",t.HTTP_IN_COOKIE="HTTP_IN_COOKIE"}(mr||(mr={})),function(t){t.PHISH_BLOCK_THRESHOLD_UNSPECIFIED="PHISH_BLOCK_THRESHOLD_UNSPECIFIED",t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_HIGH_AND_ABOVE="BLOCK_HIGH_AND_ABOVE",t.BLOCK_HIGHER_AND_ABOVE="BLOCK_HIGHER_AND_ABOVE",t.BLOCK_VERY_HIGH_AND_ABOVE="BLOCK_VERY_HIGH_AND_ABOVE",t.BLOCK_ONLY_EXTREMELY_HIGH="BLOCK_ONLY_EXTREMELY_HIGH"}(Er||(Er={})),function(t){t.UNSPECIFIED="UNSPECIFIED",t.BLOCKING="BLOCKING",t.NON_BLOCKING="NON_BLOCKING"}(gr||(gr={})),function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.MODE_DYNAMIC="MODE_DYNAMIC"}(Tr||(Tr={})),function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.AUTO="AUTO",t.ANY="ANY",t.NONE="NONE",t.VALIDATED="VALIDATED"}(Nr||(Nr={})),function(t){t.THINKING_LEVEL_UNSPECIFIED="THINKING_LEVEL_UNSPECIFIED",t.LOW="LOW",t.MEDIUM="MEDIUM",t.HIGH="HIGH",t.MINIMAL="MINIMAL"}(vr||(vr={})),function(t){t.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",t.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",t.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",t.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",t.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",t.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",t.HARM_CATEGORY_IMAGE_HATE="HARM_CATEGORY_IMAGE_HATE",t.HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT="HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT",t.HARM_CATEGORY_IMAGE_HARASSMENT="HARM_CATEGORY_IMAGE_HARASSMENT",t.HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT="HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT",t.HARM_CATEGORY_JAILBREAK="HARM_CATEGORY_JAILBREAK"}(Ir||(Ir={})),function(t){t.HARM_BLOCK_METHOD_UNSPECIFIED="HARM_BLOCK_METHOD_UNSPECIFIED",t.SEVERITY="SEVERITY",t.PROBABILITY="PROBABILITY"}(_r||(_r={})),function(t){t.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",t.BLOCK_NONE="BLOCK_NONE",t.OFF="OFF"}(Or||(Or={})),function(t){t.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",t.STOP="STOP",t.MAX_TOKENS="MAX_TOKENS",t.SAFETY="SAFETY",t.RECITATION="RECITATION",t.LANGUAGE="LANGUAGE",t.OTHER="OTHER",t.BLOCKLIST="BLOCKLIST",t.PROHIBITED_CONTENT="PROHIBITED_CONTENT",t.SPII="SPII",t.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",t.IMAGE_SAFETY="IMAGE_SAFETY",t.UNEXPECTED_TOOL_CALL="UNEXPECTED_TOOL_CALL",t.IMAGE_PROHIBITED_CONTENT="IMAGE_PROHIBITED_CONTENT",t.NO_IMAGE="NO_IMAGE",t.IMAGE_RECITATION="IMAGE_RECITATION",t.IMAGE_OTHER="IMAGE_OTHER"}(Pr||(Pr={})),function(t){t.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",t.NEGLIGIBLE="NEGLIGIBLE",t.LOW="LOW",t.MEDIUM="MEDIUM",t.HIGH="HIGH"}(Ar||(Ar={})),function(t){t.HARM_SEVERITY_UNSPECIFIED="HARM_SEVERITY_UNSPECIFIED",t.HARM_SEVERITY_NEGLIGIBLE="HARM_SEVERITY_NEGLIGIBLE",t.HARM_SEVERITY_LOW="HARM_SEVERITY_LOW",t.HARM_SEVERITY_MEDIUM="HARM_SEVERITY_MEDIUM",t.HARM_SEVERITY_HIGH="HARM_SEVERITY_HIGH"}(Sr||(Sr={})),function(t){t.URL_RETRIEVAL_STATUS_UNSPECIFIED="URL_RETRIEVAL_STATUS_UNSPECIFIED",t.URL_RETRIEVAL_STATUS_SUCCESS="URL_RETRIEVAL_STATUS_SUCCESS",t.URL_RETRIEVAL_STATUS_ERROR="URL_RETRIEVAL_STATUS_ERROR",t.URL_RETRIEVAL_STATUS_PAYWALL="URL_RETRIEVAL_STATUS_PAYWALL",t.URL_RETRIEVAL_STATUS_UNSAFE="URL_RETRIEVAL_STATUS_UNSAFE"}(br||(br={})),function(t){t.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",t.SAFETY="SAFETY",t.OTHER="OTHER",t.BLOCKLIST="BLOCKLIST",t.PROHIBITED_CONTENT="PROHIBITED_CONTENT",t.IMAGE_SAFETY="IMAGE_SAFETY",t.MODEL_ARMOR="MODEL_ARMOR",t.JAILBREAK="JAILBREAK"}(Lr||(Lr={})),function(t){t.TRAFFIC_TYPE_UNSPECIFIED="TRAFFIC_TYPE_UNSPECIFIED",t.ON_DEMAND="ON_DEMAND",t.PROVISIONED_THROUGHPUT="PROVISIONED_THROUGHPUT"}(Rr||(Rr={})),function(t){t.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",t.TEXT="TEXT",t.IMAGE="IMAGE",t.AUDIO="AUDIO"}(xr||(xr={})),function(t){t.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",t.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",t.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",t.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH"}(Cr||(Cr={})),function(t){t.TUNING_MODE_UNSPECIFIED="TUNING_MODE_UNSPECIFIED",t.TUNING_MODE_FULL="TUNING_MODE_FULL",t.TUNING_MODE_PEFT_ADAPTER="TUNING_MODE_PEFT_ADAPTER"}(Dr||(Dr={})),function(t){t.ADAPTER_SIZE_UNSPECIFIED="ADAPTER_SIZE_UNSPECIFIED",t.ADAPTER_SIZE_ONE="ADAPTER_SIZE_ONE",t.ADAPTER_SIZE_TWO="ADAPTER_SIZE_TWO",t.ADAPTER_SIZE_FOUR="ADAPTER_SIZE_FOUR",t.ADAPTER_SIZE_EIGHT="ADAPTER_SIZE_EIGHT",t.ADAPTER_SIZE_SIXTEEN="ADAPTER_SIZE_SIXTEEN",t.ADAPTER_SIZE_THIRTY_TWO="ADAPTER_SIZE_THIRTY_TWO"}(kr||(kr={})),function(t){t.JOB_STATE_UNSPECIFIED="JOB_STATE_UNSPECIFIED",t.JOB_STATE_QUEUED="JOB_STATE_QUEUED",t.JOB_STATE_PENDING="JOB_STATE_PENDING",t.JOB_STATE_RUNNING="JOB_STATE_RUNNING",t.JOB_STATE_SUCCEEDED="JOB_STATE_SUCCEEDED",t.JOB_STATE_FAILED="JOB_STATE_FAILED",t.JOB_STATE_CANCELLING="JOB_STATE_CANCELLING",t.JOB_STATE_CANCELLED="JOB_STATE_CANCELLED",t.JOB_STATE_PAUSED="JOB_STATE_PAUSED",t.JOB_STATE_EXPIRED="JOB_STATE_EXPIRED",t.JOB_STATE_UPDATING="JOB_STATE_UPDATING",t.JOB_STATE_PARTIALLY_SUCCEEDED="JOB_STATE_PARTIALLY_SUCCEEDED"}($r||($r={})),function(t){t.TUNING_TASK_UNSPECIFIED="TUNING_TASK_UNSPECIFIED",t.TUNING_TASK_I2V="TUNING_TASK_I2V",t.TUNING_TASK_T2V="TUNING_TASK_T2V",t.TUNING_TASK_R2V="TUNING_TASK_R2V"}(Mr||(Mr={})),function(t){t.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",t.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",t.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",t.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH",t.MEDIA_RESOLUTION_ULTRA_HIGH="MEDIA_RESOLUTION_ULTRA_HIGH"}(Ur||(Ur={})),function(t){t.COLLECTION="COLLECTION"}(Br||(Br={})),function(t){t.FEATURE_SELECTION_PREFERENCE_UNSPECIFIED="FEATURE_SELECTION_PREFERENCE_UNSPECIFIED",t.PRIORITIZE_QUALITY="PRIORITIZE_QUALITY",t.BALANCED="BALANCED",t.PRIORITIZE_COST="PRIORITIZE_COST"}(Gr||(Gr={})),function(t){t.ENVIRONMENT_UNSPECIFIED="ENVIRONMENT_UNSPECIFIED",t.ENVIRONMENT_BROWSER="ENVIRONMENT_BROWSER"}(Hr||(Hr={})),function(t){t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",t.BLOCK_NONE="BLOCK_NONE"}(Fr||(Fr={})),function(t){t.DONT_ALLOW="DONT_ALLOW",t.ALLOW_ADULT="ALLOW_ADULT",t.ALLOW_ALL="ALLOW_ALL"}(Vr||(Vr={})),function(t){t.auto="auto",t.en="en",t.ja="ja",t.ko="ko",t.hi="hi",t.zh="zh",t.pt="pt",t.es="es"}(qr||(qr={})),function(t){t.MASK_MODE_DEFAULT="MASK_MODE_DEFAULT",t.MASK_MODE_USER_PROVIDED="MASK_MODE_USER_PROVIDED",t.MASK_MODE_BACKGROUND="MASK_MODE_BACKGROUND",t.MASK_MODE_FOREGROUND="MASK_MODE_FOREGROUND",t.MASK_MODE_SEMANTIC="MASK_MODE_SEMANTIC"}(Yr||(Yr={})),function(t){t.CONTROL_TYPE_DEFAULT="CONTROL_TYPE_DEFAULT",t.CONTROL_TYPE_CANNY="CONTROL_TYPE_CANNY",t.CONTROL_TYPE_SCRIBBLE="CONTROL_TYPE_SCRIBBLE",t.CONTROL_TYPE_FACE_MESH="CONTROL_TYPE_FACE_MESH"}(Kr||(Kr={})),function(t){t.SUBJECT_TYPE_DEFAULT="SUBJECT_TYPE_DEFAULT",t.SUBJECT_TYPE_PERSON="SUBJECT_TYPE_PERSON",t.SUBJECT_TYPE_ANIMAL="SUBJECT_TYPE_ANIMAL",t.SUBJECT_TYPE_PRODUCT="SUBJECT_TYPE_PRODUCT"}(zr||(zr={})),function(t){t.EDIT_MODE_DEFAULT="EDIT_MODE_DEFAULT",t.EDIT_MODE_INPAINT_REMOVAL="EDIT_MODE_INPAINT_REMOVAL",t.EDIT_MODE_INPAINT_INSERTION="EDIT_MODE_INPAINT_INSERTION",t.EDIT_MODE_OUTPAINT="EDIT_MODE_OUTPAINT",t.EDIT_MODE_CONTROLLED_EDITING="EDIT_MODE_CONTROLLED_EDITING",t.EDIT_MODE_STYLE="EDIT_MODE_STYLE",t.EDIT_MODE_BGSWAP="EDIT_MODE_BGSWAP",t.EDIT_MODE_PRODUCT_IMAGE="EDIT_MODE_PRODUCT_IMAGE"}(jr||(jr={})),function(t){t.FOREGROUND="FOREGROUND",t.BACKGROUND="BACKGROUND",t.PROMPT="PROMPT",t.SEMANTIC="SEMANTIC",t.INTERACTIVE="INTERACTIVE"}(Xr||(Xr={})),function(t){t.ASSET="ASSET",t.STYLE="STYLE"}(Jr||(Jr={})),function(t){t.INSERT="INSERT",t.REMOVE="REMOVE",t.REMOVE_STATIC="REMOVE_STATIC",t.OUTPAINT="OUTPAINT"}(Qr||(Qr={})),function(t){t.OPTIMIZED="OPTIMIZED",t.LOSSLESS="LOSSLESS"}(Wr||(Wr={})),function(t){t.SUPERVISED_FINE_TUNING="SUPERVISED_FINE_TUNING",t.PREFERENCE_TUNING="PREFERENCE_TUNING"}(Zr||(Zr={})),function(t){t.STATE_UNSPECIFIED="STATE_UNSPECIFIED",t.STATE_PENDING="STATE_PENDING",t.STATE_ACTIVE="STATE_ACTIVE",t.STATE_FAILED="STATE_FAILED"}(ts||(ts={})),function(t){t.STATE_UNSPECIFIED="STATE_UNSPECIFIED",t.PROCESSING="PROCESSING",t.ACTIVE="ACTIVE",t.FAILED="FAILED"}(es||(es={})),function(t){t.SOURCE_UNSPECIFIED="SOURCE_UNSPECIFIED",t.UPLOADED="UPLOADED",t.GENERATED="GENERATED",t.REGISTERED="REGISTERED"}(ns||(ns={})),function(t){t.TURN_COMPLETE_REASON_UNSPECIFIED="TURN_COMPLETE_REASON_UNSPECIFIED",t.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",t.RESPONSE_REJECTED="RESPONSE_REJECTED",t.NEED_MORE_INPUT="NEED_MORE_INPUT"}(rs||(rs={})),function(t){t.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",t.TEXT="TEXT",t.IMAGE="IMAGE",t.VIDEO="VIDEO",t.AUDIO="AUDIO",t.DOCUMENT="DOCUMENT"}(ss||(ss={})),function(t){t.VAD_SIGNAL_TYPE_UNSPECIFIED="VAD_SIGNAL_TYPE_UNSPECIFIED",t.VAD_SIGNAL_TYPE_SOS="VAD_SIGNAL_TYPE_SOS",t.VAD_SIGNAL_TYPE_EOS="VAD_SIGNAL_TYPE_EOS"}(is||(is={})),function(t){t.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",t.ACTIVITY_START="ACTIVITY_START",t.ACTIVITY_END="ACTIVITY_END"}(os||(os={})),function(t){t.START_SENSITIVITY_UNSPECIFIED="START_SENSITIVITY_UNSPECIFIED",t.START_SENSITIVITY_HIGH="START_SENSITIVITY_HIGH",t.START_SENSITIVITY_LOW="START_SENSITIVITY_LOW"}(as||(as={})),function(t){t.END_SENSITIVITY_UNSPECIFIED="END_SENSITIVITY_UNSPECIFIED",t.END_SENSITIVITY_HIGH="END_SENSITIVITY_HIGH",t.END_SENSITIVITY_LOW="END_SENSITIVITY_LOW"}(cs||(cs={})),function(t){t.ACTIVITY_HANDLING_UNSPECIFIED="ACTIVITY_HANDLING_UNSPECIFIED",t.START_OF_ACTIVITY_INTERRUPTS="START_OF_ACTIVITY_INTERRUPTS",t.NO_INTERRUPTION="NO_INTERRUPTION"}(us||(us={})),function(t){t.TURN_COVERAGE_UNSPECIFIED="TURN_COVERAGE_UNSPECIFIED",t.TURN_INCLUDES_ONLY_ACTIVITY="TURN_INCLUDES_ONLY_ACTIVITY",t.TURN_INCLUDES_ALL_INPUT="TURN_INCLUDES_ALL_INPUT"}(hs||(hs={})),function(t){t.SCALE_UNSPECIFIED="SCALE_UNSPECIFIED",t.C_MAJOR_A_MINOR="C_MAJOR_A_MINOR",t.D_FLAT_MAJOR_B_FLAT_MINOR="D_FLAT_MAJOR_B_FLAT_MINOR",t.D_MAJOR_B_MINOR="D_MAJOR_B_MINOR",t.E_FLAT_MAJOR_C_MINOR="E_FLAT_MAJOR_C_MINOR",t.E_MAJOR_D_FLAT_MINOR="E_MAJOR_D_FLAT_MINOR",t.F_MAJOR_D_MINOR="F_MAJOR_D_MINOR",t.G_FLAT_MAJOR_E_FLAT_MINOR="G_FLAT_MAJOR_E_FLAT_MINOR",t.G_MAJOR_E_MINOR="G_MAJOR_E_MINOR",t.A_FLAT_MAJOR_F_MINOR="A_FLAT_MAJOR_F_MINOR",t.A_MAJOR_G_FLAT_MINOR="A_MAJOR_G_FLAT_MINOR",t.B_FLAT_MAJOR_G_MINOR="B_FLAT_MAJOR_G_MINOR",t.B_MAJOR_A_FLAT_MINOR="B_MAJOR_A_FLAT_MINOR"}(ls||(ls={})),function(t){t.MUSIC_GENERATION_MODE_UNSPECIFIED="MUSIC_GENERATION_MODE_UNSPECIFIED",t.QUALITY="QUALITY",t.DIVERSITY="DIVERSITY",t.VOCALIZATION="VOCALIZATION"}(ps||(ps={})),function(t){t.PLAYBACK_CONTROL_UNSPECIFIED="PLAYBACK_CONTROL_UNSPECIFIED",t.PLAY="PLAY",t.PAUSE="PAUSE",t.STOP="STOP",t.RESET_CONTEXT="RESET_CONTEXT"}(fs||(fs={})),function(t){t.PAGED_ITEM_BATCH_JOBS="batchJobs",t.PAGED_ITEM_MODELS="models",t.PAGED_ITEM_TUNING_JOBS="tuningJobs",t.PAGED_ITEM_FILES="files",t.PAGED_ITEM_CACHED_CONTENTS="cachedContents",t.PAGED_ITEM_FILE_SEARCH_STORES="fileSearchStores",t.PAGED_ITEM_DOCUMENTS="documents"}(ds||(ds={})),"function"==typeof SuppressedError&&SuppressedError;
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
let Ts=function(){const{crypto:t}=globalThis;if(null==t?void 0:t.randomUUID)return Ts=t.randomUUID.bind(t),t.randomUUID();const e=new Uint8Array(1),n=t?()=>t.getRandomValues(e)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(+t^n()&15>>+t/4).toString(16))};
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
function Ns(t){return"object"==typeof t&&null!==t&&("name"in t&&"AbortError"===t.name||"message"in t&&String(t.message).includes("FetchRequestCanceledException"))}const vs=t=>{if(t instanceof Error)return t;if("object"==typeof t&&null!==t){try{if("[object Error]"===Object.prototype.toString.call(t)){const e=new Error(t.message,t.cause?{cause:t.cause}:{});return t.stack&&(e.stack=t.stack),t.cause&&!e.cause&&(e.cause=t.cause),t.name&&(e.name=t.name),e}}catch(t){}try{return new Error(JSON.stringify(t))}catch(t){}}return new Error(t)};
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Is extends Error{}class _s extends Is{constructor(t,e,n,r){super(`${_s.makeMessage(t,e,n)}`),this.status=t,this.headers=r,this.error=e}static makeMessage(t,e,n){const r=(null==e?void 0:e.message)?"string"==typeof e.message?e.message:JSON.stringify(e.message):e?JSON.stringify(e):n;return t&&r?`${t} ${r}`:t?`${t} status code (no body)`:r||"(no status code or body)"}static generate(t,e,n,r){if(!t||!r)return new Ps({message:n,cause:vs(e)});const s=e;return 400===t?new Ss(t,s,n,r):401===t?new bs(t,s,n,r):403===t?new Ls(t,s,n,r):404===t?new Rs(t,s,n,r):409===t?new xs(t,s,n,r):422===t?new Cs(t,s,n,r):429===t?new Ds(t,s,n,r):t>=500?new ks(t,s,n,r):new _s(t,s,n,r)}}class Os extends _s{constructor({message:t}={}){super(void 0,void 0,t||"Request was aborted.",void 0)}}class Ps extends _s{constructor({message:t,cause:e}){super(void 0,void 0,t||"Connection error.",void 0),e&&(this.cause=e)}}class As extends Ps{constructor({message:t}={}){super({message:null!=t?t:"Request timed out."})}}class Ss extends _s{}class bs extends _s{}class Ls extends _s{}class Rs extends _s{}class xs extends _s{}class Cs extends _s{}class Ds extends _s{}class ks extends _s{}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const $s=/^[a-z][a-z0-9+.-]*:/i;let Ms=t=>(Ms=Array.isArray,Ms(t));const Us=Ms;const Bs="0.0.1";const Gs=()=>{var t,e,n,r,s;const i="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===i)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bs,"X-Stainless-OS":Fs(Deno.build.os),"X-Stainless-Arch":Hs(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:null!==(e=null===(t=Deno.version)||void 0===t?void 0:t.deno)&&void 0!==e?e:"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===i)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bs,"X-Stainless-OS":Fs(null!==(n=globalThis.process.platform)&&void 0!==n?n:"unknown"),"X-Stainless-Arch":Hs(null!==(r=globalThis.process.arch)&&void 0!==r?r:"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":null!==(s=globalThis.process.version)&&void 0!==s?s:"unknown"};const o=function(){if("undefined"==typeof navigator||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const t=n.exec(navigator.userAgent);if(t){return{browser:e,version:`${t[1]||0}.${t[2]||0}.${t[3]||0}`}}}return null}();return o?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${o.browser}`,"X-Stainless-Runtime-Version":o.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const Hs=t=>"x32"===t?"x32":"x86_64"===t||"x64"===t?"x64":"arm"===t?"arm":"aarch64"===t||"arm64"===t?"arm64":t?`other:${t}`:"unknown",Fs=t=>(t=t.toLowerCase()).includes("ios")?"iOS":"android"===t?"Android":"darwin"===t?"MacOS":"win32"===t?"Windows":"freebsd"===t?"FreeBSD":"openbsd"===t?"OpenBSD":"linux"===t?"Linux":t?`Other:${t}`:"Unknown";let Vs;function qs(...t){const e=globalThis.ReadableStream;if(void 0===e)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...t)}function Ys(t){let e=Symbol.asyncIterator in t?t[Symbol.asyncIterator]():t[Symbol.iterator]();return qs({start(){},async pull(t){const{done:n,value:r}=await e.next();n?t.close():t.enqueue(r)},async cancel(){var t;await(null===(t=e.return)||void 0===t?void 0:t.call(e))}})}function Ks(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const t=await e.read();return(null==t?void 0:t.done)&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
const zs=({headers:t,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),js=()=>{var t;if("undefined"==typeof File){const{process:e}=globalThis,n="string"==typeof(null===(t=null==e?void 0:e.versions)||void 0===t?void 0:t.node)&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(n?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Xs(t,e,n){return js(),new File(t,null!=e?e:"unknown_file",n)}const Js=t=>null!=t&&"object"==typeof t&&"number"==typeof t.size&&"string"==typeof t.type&&"function"==typeof t.text&&"function"==typeof t.slice&&"function"==typeof t.arrayBuffer;
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */async function Qs(t){var e,n,r,s,i;let o=[];if("string"==typeof t||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)o.push(t);else if(Js(t))o.push(t instanceof Blob?t:await t.arrayBuffer());else{if(!(t=>null!=t&&"object"==typeof t&&"function"==typeof t[Symbol.asyncIterator])(t)){const e=null===(i=null==t?void 0:t.constructor)||void 0===i?void 0:i.name;throw new Error(`Unexpected data type: ${typeof t}${e?`; constructor: ${e}`:""}${function(t){if("object"!=typeof t||null===t)return"";const e=Object.getOwnPropertyNames(t);return`; props: [${e.map(t=>`"${t}"`).join(", ")}]`}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */(t)}`)}try{for(var a,c=!0,u=gs(t);!(e=(a=await u.next()).done);c=!0){s=a.value,c=!1;const t=s;o.push(...await Qs(t))}}catch(t){n={error:t}}finally{try{c||e||!(r=u.return)||await r.call(u)}finally{if(n)throw n.error}}}return o}class Ws{constructor(t){this._client=t}}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
function Zs(t){return t.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}Ws._key=[];const ti=Object.freeze(Object.create(null)),ei=(t=Zs)=>function(e,...n){if(1===e.length)return e[0];let r=!1;const s=[],i=e.reduce((e,i,o)=>{var a,c,u;/[?#]/.test(i)&&(r=!0);const h=n[o];let l=(r?encodeURIComponent:t)(""+h);return o!==n.length&&(null==h||"object"==typeof h&&h.toString===(null===(u=Object.getPrototypeOf(null!==(c=Object.getPrototypeOf(null!==(a=h.hasOwnProperty)&&void 0!==a?a:ti))&&void 0!==c?c:ti))||void 0===u?void 0:u.toString))&&(l=h+"",s.push({start:e.length+i.length,length:l.length,error:`Value of type ${Object.prototype.toString.call(h).slice(8,-1)} is not a valid path parameter`})),e+i+(o===n.length?"":l)},""),o=i.split(/[?#]/,1)[0],a=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let c;for(;null!==(c=a.exec(o));)s.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(s.sort((t,e)=>t.start-e.start),s.length>0){let t=0;const e=s.reduce((e,n)=>{const r=" ".repeat(n.start-t),s="^".repeat(n.length);return t=n.start+n.length,e+r+s},"");throw new Is(`Path parameters result in path with invalid segments:\n${s.map(t=>t.error).join("\n")}\n${i}\n${e}`)}return i},ni=ei(Zs);
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
class ri extends Ws{create(t,e){var n;const{api_version:r=this._client.apiVersion}=t,s=ys(t,["api_version"]);if("model"in s&&"agent_config"in s)throw new Is("Invalid request: specified `model` and `agent_config`. If specifying `model`, use `generation_config`.");if("agent"in s&&"generation_config"in s)throw new Is("Invalid request: specified `agent` and `generation_config`. If specifying `agent`, use `agent_config`.");return this._client.post(ni`/${r}/interactions`,Object.assign(Object.assign({body:s},e),{stream:null!==(n=t.stream)&&void 0!==n&&n}))}delete(t,e={},n){const{api_version:r=this._client.apiVersion}=null!=e?e:{};return this._client.delete(ni`/${r}/interactions/${t}`,n)}cancel(t,e={},n){const{api_version:r=this._client.apiVersion}=null!=e?e:{};return this._client.post(ni`/${r}/interactions/${t}/cancel`,n)}get(t,e={},n){var r;const s=null!=e?e:{},{api_version:i=this._client.apiVersion}=s,o=ys(s,["api_version"]);return this._client.get(ni`/${i}/interactions/${t}`,Object.assign(Object.assign({query:o},n),{stream:null!==(r=null==e?void 0:e.stream)&&void 0!==r&&r}))}}ri._key=Object.freeze(["interactions"]);class si extends ri{}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let ii,oi;function ai(t){let e;return(null!=ii?ii:(e=new globalThis.TextEncoder,ii=e.encode.bind(e)))(t)}function ci(t){let e;return(null!=oi?oi:(e=new globalThis.TextDecoder,oi=e.decode.bind(e)))(t)}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class ui{constructor(){this.buffer=new Uint8Array,this.carriageReturnIndex=null}decode(t){if(null==t)return[];const e=t instanceof ArrayBuffer?new Uint8Array(t):"string"==typeof t?ai(t):t;this.buffer=function(t){let e=0;for(const n of t)e+=n.length;const n=new Uint8Array(e);let r=0;for(const e of t)n.set(e,r),r+=e.length;return n}([this.buffer,e]);const n=[];let r;for(;null!=(r=hi(this.buffer,this.carriageReturnIndex));){if(r.carriage&&null==this.carriageReturnIndex){this.carriageReturnIndex=r.index;continue}if(null!=this.carriageReturnIndex&&(r.index!==this.carriageReturnIndex+1||r.carriage)){n.push(ci(this.buffer.subarray(0,this.carriageReturnIndex-1))),this.buffer=this.buffer.subarray(this.carriageReturnIndex),this.carriageReturnIndex=null;continue}const t=null!==this.carriageReturnIndex?r.preceding-1:r.preceding,e=ci(this.buffer.subarray(0,t));n.push(e),this.buffer=this.buffer.subarray(r.index),this.carriageReturnIndex=null}return n}flush(){return this.buffer.length?this.decode("\n"):[]}}function hi(t,e){for(let n=null!=e?e:0;n<t.length;n++){if(10===t[n])return{preceding:n,index:n+1,carriage:!1};if(13===t[n])return{preceding:n,index:n+1,carriage:!0}}return null}function li(t){for(let e=0;e<t.length-1;e++){if(10===t[e]&&10===t[e+1])return e+2;if(13===t[e]&&13===t[e+1])return e+2;if(13===t[e]&&10===t[e+1]&&e+3<t.length&&13===t[e+2]&&10===t[e+3])return e+4}return-1}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */ui.NEWLINE_CHARS=new Set(["\n","\r"]),ui.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const pi={off:0,error:200,warn:300,info:400,debug:500},fi=(t,e,n)=>{var r,s;if(t)return r=pi,s=t,Object.prototype.hasOwnProperty.call(r,s)?t:void Ei(n).warn(`${e} was set to ${JSON.stringify(t)}, expected one of ${JSON.stringify(Object.keys(pi))}`)};function di(){}function yi(t,e,n){return!e||pi[t]>pi[n]?di:e[t].bind(e)}const wi={error:di,warn:di,info:di,debug:di};let mi=new WeakMap;function Ei(t){var e;const n=t.logger,r=null!==(e=t.logLevel)&&void 0!==e?e:"off";if(!n)return wi;const s=mi.get(n);if(s&&s[0]===r)return s[1];const i={error:yi("error",n,r),warn:yi("warn",n,r),info:yi("info",n,r),debug:yi("debug",n,r)};return mi.set(n,[r,i]),i}const gi=t=>(t.options&&(t.options=Object.assign({},t.options),delete t.options.headers),t.headers&&(t.headers=Object.fromEntries((t.headers instanceof Headers?[...t.headers]:Object.entries(t.headers)).map(([t,e])=>[t,"x-goog-api-key"===t.toLowerCase()||"authorization"===t.toLowerCase()||"cookie"===t.toLowerCase()||"set-cookie"===t.toLowerCase()?"***":e]))),"retryOfRequestLogID"in t&&(t.retryOfRequestLogID&&(t.retryOf=t.retryOfRequestLogID),delete t.retryOfRequestLogID),t);
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Ti{constructor(t,e,n){this.iterator=t,this.controller=e,this.client=n}static fromSSEResponse(t,e,n){let r=!1;const s=n?Ei(n):console;return new Ti(function(){return Es(this,arguments,function*(){var n,i,o,a;if(r)throw new Is("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let c=!1;try{try{for(var u,h=!0,l=gs(function(t,e){return Es(this,arguments,function*(){var n,r,s,i;if(!t.body){if(e.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new Is("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new Is("Attempted to iterate over a response with no body")}const o=new Ni,a=new ui,c=Ks(t.body);try{for(var u,h=!0,l=gs(function(t){return Es(this,arguments,function*(){var e,n,r,s;let i=new Uint8Array;try{for(var o,a=!0,c=gs(t);!(e=(o=yield ms(c.next())).done);a=!0){s=o.value,a=!1;const t=s;if(null==t)continue;const e=t instanceof ArrayBuffer?new Uint8Array(t):"string"==typeof t?ai(t):t;let n,r=new Uint8Array(i.length+e.length);for(r.set(i),r.set(e,i.length),i=r;-1!==(n=li(i));)yield yield ms(i.slice(0,n)),i=i.slice(n)}}catch(t){n={error:t}}finally{try{a||e||!(r=c.return)||(yield ms(r.call(c)))}finally{if(n)throw n.error}}i.length>0&&(yield yield ms(i))})}(c));!(n=(u=yield ms(l.next())).done);h=!0){i=u.value,h=!1;const t=i;for(const e of a.decode(t)){const t=o.decode(e);t&&(yield yield ms(t))}}}catch(t){r={error:t}}finally{try{h||n||!(s=l.return)||(yield ms(s.call(l)))}finally{if(r)throw r.error}}for(const t of a.flush()){const e=o.decode(t);e&&(yield yield ms(e))}})}(t,e));!(n=(u=yield ms(l.next())).done);h=!0){a=u.value,h=!1;const t=a;if(!c)if(t.data.startsWith("[DONE]"))c=!0;else try{yield yield ms(JSON.parse(t.data))}catch(e){throw s.error("Could not parse message into JSON:",t.data),s.error("From chunk:",t.raw),e}}}catch(t){i={error:t}}finally{try{h||n||!(o=l.return)||(yield ms(o.call(l)))}finally{if(i)throw i.error}}c=!0}catch(t){if(Ns(t))return yield ms(void 0);throw t}finally{c||e.abort()}})},e,n)}static fromReadableStream(t,e,n){let r=!1;return new Ti(function(){return Es(this,arguments,function*(){var n,s,i,o;if(r)throw new Is("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{try{for(var c,u=!0,h=gs(function(){return Es(this,arguments,function*(){var e,n,r,s;const i=new ui,o=Ks(t);try{for(var a,c=!0,u=gs(o);!(e=(a=yield ms(u.next())).done);c=!0){s=a.value,c=!1;const t=s;for(const e of i.decode(t))yield yield ms(e)}}catch(t){n={error:t}}finally{try{c||e||!(r=u.return)||(yield ms(r.call(u)))}finally{if(n)throw n.error}}for(const t of i.flush())yield yield ms(t)})}());!(n=(c=yield ms(h.next())).done);u=!0){o=c.value,u=!1;const t=o;a||t&&(yield yield ms(JSON.parse(t)))}}catch(t){s={error:t}}finally{try{u||n||!(i=h.return)||(yield ms(i.call(h)))}finally{if(s)throw s.error}}a=!0}catch(t){if(Ns(t))return yield ms(void 0);throw t}finally{a||e.abort()}})},e,n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const t=[],e=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();t.push(r),e.push(r)}return r.shift()}});return[new Ti(()=>r(t),this.controller,this.client),new Ti(()=>r(e),this.controller,this.client)]}toReadableStream(){const t=this;let e;return qs({async start(){e=t[Symbol.asyncIterator]()},async pull(t){try{const{value:n,done:r}=await e.next();if(r)return t.close();const s=ai(JSON.stringify(n)+"\n");t.enqueue(s)}catch(e){t.error(e)}},async cancel(){var t;await(null===(t=e.return)||void 0===t?void 0:t.call(e))}})}}class Ni{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(t){if(t.endsWith("\r")&&(t=t.substring(0,t.length-1)),!t){if(!this.event&&!this.data.length)return null;const t={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],t}if(this.chunks.push(t),t.startsWith(":"))return null;let[e,n,r]=function(t,e){const n=t.indexOf(e);if(-1!==n)return[t.substring(0,n),e,t.substring(n+e.length)];return[t,"",""]}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */(t,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===e?this.event=r:"data"===e&&this.data.push(r),null}}async function vi(t,e){const{response:n,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,o=await(async()=>{var r;if(e.options.stream)return Ei(t).debug("response",n.status,n.url,n.headers,n.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(n,e.controller,t):Ti.fromSSEResponse(n,e.controller,t);if(204===n.status)return null;if(e.options.__binaryResponse)return n;const s=n.headers.get("content-type"),i=null===(r=null==s?void 0:s.split(";")[0])||void 0===r?void 0:r.trim();if((null==i?void 0:i.includes("application/json"))||(null==i?void 0:i.endsWith("+json"))){return await n.json()}return await n.text()})();return Ei(t).debug(`[${r}] response parsed`,gi({retryOfRequestLogID:s,url:n.url,status:n.status,body:o,durationMs:Date.now()-i})),o}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Ii extends Promise{constructor(t,e,n=vi){super(t=>{t(null)}),this.responsePromise=e,this.parseResponse=n,this.client=t}_thenUnwrap(t){return new Ii(this.client,this.responsePromise,async(e,n)=>t(await this.parseResponse(e,n),n))}asResponse(){return this.responsePromise.then(t=>t.response)}async withResponse(){const[t,e]=await Promise.all([this.parse(),this.asResponse()]);return{data:t,response:e}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(t=>this.parseResponse(this.client,t))),this.parsedPromise}then(t,e){return this.parse().then(t,e)}catch(t){return this.parse().catch(t)}finally(t){return this.parse().finally(t)}}
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const _i=Symbol("brand.privateNullableHeaders");function*Oi(t){if(!t)return;if(_i in t){const{values:e,nulls:n}=t;yield*e.entries();for(const t of n)yield[t,null];return}let e,n=!1;t instanceof Headers?e=t.entries():Us(t)?e=t:(n=!0,e=Object.entries(null!=t?t:{}));for(let t of e){const e=t[0];if("string"!=typeof e)throw new TypeError("expected header name to be a string");const r=Us(t[1])?t[1]:[t[1]];let s=!1;for(const t of r)void 0!==t&&(n&&!s&&(s=!0,yield[e,null]),yield[e,t])}}const Pi=t=>{const e=new Headers,n=new Set;for(const r of t){const t=new Set;for(const[s,i]of Oi(r)){const r=s.toLowerCase();t.has(r)||(e.delete(s),t.add(r)),null===i?(e.delete(s),n.add(r)):(e.append(s,i),n.delete(r))}}return{[_i]:!0,values:e,nulls:n}},Ai=t=>{var e,n,r,s,i,o;return void 0!==globalThis.process?null!==(r=null===(n=null===(e=globalThis.process.env)||void 0===e?void 0:e[t])||void 0===n?void 0:n.trim())&&void 0!==r?r:void 0:void 0!==globalThis.Deno?null===(o=null===(i=null===(s=globalThis.Deno.env)||void 0===s?void 0:s.get)||void 0===i?void 0:i.call(s,t))||void 0===o?void 0:o.trim():void 0};
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
var Si;class bi{constructor(t){var e,n,r,s,i,o,a,{baseURL:c=Ai("GEMINI_NEXT_GEN_API_BASE_URL"),apiKey:u=(null!==(e=Ai("GEMINI_API_KEY"))&&void 0!==e?e:null),apiVersion:h="v1beta"}=t,l=ys(t,["baseURL","apiKey","apiVersion"]);const p=Object.assign(Object.assign({apiKey:u,apiVersion:h},l),{baseURL:c||"https://generativelanguage.googleapis.com"});this.baseURL=p.baseURL,this.timeout=null!==(n=p.timeout)&&void 0!==n?n:bi.DEFAULT_TIMEOUT,this.logger=null!==(r=p.logger)&&void 0!==r?r:console;const f="warn";this.logLevel=f,this.logLevel=null!==(i=null!==(s=fi(p.logLevel,"ClientOptions.logLevel",this))&&void 0!==s?s:fi(Ai("GEMINI_NEXT_GEN_API_LOG"),"process.env['GEMINI_NEXT_GEN_API_LOG']",this))&&void 0!==i?i:f,this.fetchOptions=p.fetchOptions,this.maxRetries=null!==(o=p.maxRetries)&&void 0!==o?o:2,this.fetch=null!==(a=p.fetch)&&void 0!==a?a:
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new GeminiNextGenAPIClient({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),this.encoder=zs,this._options=p,this.apiKey=u,this.apiVersion=h,this.clientAdapter=p.clientAdapter}withOptions(t){return new this.constructor(Object.assign(Object.assign(Object.assign({},this._options),{baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,apiVersion:this.apiVersion}),t))}baseURLOverridden(){return"https://generativelanguage.googleapis.com"!==this.baseURL}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:t,nulls:e}){if(!t.has("authorization")&&!t.has("x-goog-api-key")&&!(this.apiKey&&t.get("x-goog-api-key")||e.has("x-goog-api-key")))throw new Error('Could not resolve authentication method. Expected the apiKey to be set. Or for the "x-goog-api-key" headers to be explicitly omitted')}async authHeaders(t){const e=Pi([t.headers]);if(!e.values.has("authorization")&&!e.values.has("x-goog-api-key"))return this.apiKey?Pi([{"x-goog-api-key":this.apiKey}]):this.clientAdapter.isVertexAI()?Pi([await this.clientAdapter.getAuthHeaders()]):void 0}stringifyQuery(t){return Object.entries(t).filter(([t,e])=>void 0!==e).map(([t,e])=>{if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return`${encodeURIComponent(t)}=${encodeURIComponent(e)}`;if(null===e)return`${encodeURIComponent(t)}=`;throw new Is(`Cannot stringify type ${typeof e}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${Bs}`}defaultIdempotencyKey(){return`stainless-node-retry-${Ts()}`}makeStatusError(t,e,n,r){return _s.generate(t,e,n,r)}buildURL(t,e,n){const r=!this.baseURLOverridden()&&n||this.baseURL,s=(t=>$s.test(t))(t)?new URL(t):new URL(r+(r.endsWith("/")&&t.startsWith("/")?t.slice(1):t)),i=this.defaultQuery();return function(t){if(!t)return!0;for(const e in t)return!1;return!0}(i)||(e=Object.assign(Object.assign({},i),e)),"object"==typeof e&&e&&!Array.isArray(e)&&(s.search=this.stringifyQuery(e)),s.toString()}async prepareOptions(t){if(this.clientAdapter&&this.clientAdapter.isVertexAI()&&!t.path.startsWith(`/${this.apiVersion}/projects/`)){const e=t.path.slice(this.apiVersion.length+1);t.path=`/${this.apiVersion}/projects/${this.clientAdapter.getProject()}/locations/${this.clientAdapter.getLocation()}${e}`}}async prepareRequest(t,{url:e,options:n}){}get(t,e){return this.methodRequest("get",t,e)}post(t,e){return this.methodRequest("post",t,e)}patch(t,e){return this.methodRequest("patch",t,e)}put(t,e){return this.methodRequest("put",t,e)}delete(t,e){return this.methodRequest("delete",t,e)}methodRequest(t,e,n){return this.request(Promise.resolve(n).then(n=>Object.assign({method:t,path:e},n)))}request(t,e=null){return new Ii(this,this.makeRequest(t,e,void 0))}async makeRequest(t,e,n){var r,s,i;const o=await t,a=null!==(r=o.maxRetries)&&void 0!==r?r:this.maxRetries;null==e&&(e=a),await this.prepareOptions(o);const{req:c,url:u,timeout:h}=await this.buildRequest(o,{retryCount:a-e});await this.prepareRequest(c,{url:u,options:o});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),p=void 0===n?"":`, retryOf: ${n}`,f=Date.now();if(Ei(this).debug(`[${l}] sending request`,gi({retryOfRequestLogID:n,method:o.method,url:u,options:o,headers:c.headers})),null===(s=o.signal)||void 0===s?void 0:s.aborted)throw new Os;const d=new AbortController,y=await this.fetchWithTimeout(u,c,h,d).catch(vs),w=Date.now();if(y instanceof globalThis.Error){const t=`retrying, ${e} attempts remaining`;if(null===(i=o.signal)||void 0===i?void 0:i.aborted)throw new Os;const r=Ns(y)||/timed? ?out/i.test(String(y)+("cause"in y?String(y.cause):""));if(e)return Ei(this).info(`[${l}] connection ${r?"timed out":"failed"} - ${t}`),Ei(this).debug(`[${l}] connection ${r?"timed out":"failed"} (${t})`,gi({retryOfRequestLogID:n,url:u,durationMs:w-f,message:y.message})),this.retryRequest(o,e,null!=n?n:l);if(Ei(this).info(`[${l}] connection ${r?"timed out":"failed"} - error; no more retries left`),Ei(this).debug(`[${l}] connection ${r?"timed out":"failed"} (error; no more retries left)`,gi({retryOfRequestLogID:n,url:u,durationMs:w-f,message:y.message})),r)throw new As;throw new Ps({cause:y})}const m=`[${l}${p}] ${c.method} ${u} ${y.ok?"succeeded":"failed"} with status ${y.status} in ${w-f}ms`;if(!y.ok){const t=await this.shouldRetry(y);if(e&&t){const t=`retrying, ${e} attempts remaining`;return await async function(t){var e,n;if(null===t||"object"!=typeof t)return;if(t[Symbol.asyncIterator])return void await(null===(n=(e=t[Symbol.asyncIterator]()).return)||void 0===n?void 0:n.call(e));const r=t.getReader(),s=r.cancel();r.releaseLock(),await s}(y.body),Ei(this).info(`${m} - ${t}`),Ei(this).debug(`[${l}] response error (${t})`,gi({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:w-f})),this.retryRequest(o,e,null!=n?n:l,y.headers)}const r=t?"error; no more retries left":"error; not retryable";Ei(this).info(`${m} - ${r}`);const s=await y.text().catch(t=>vs(t).message),i=(t=>{try{return JSON.parse(t)}catch(t){return}})(s),a=i?void 0:s;Ei(this).debug(`[${l}] response error (${r})`,gi({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,message:a,durationMs:Date.now()-f}));throw this.makeStatusError(y.status,i,a,y.headers)}return Ei(this).info(m),Ei(this).debug(`[${l}] response start`,gi({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:w-f})),{response:y,options:o,controller:d,requestLogID:l,retryOfRequestLogID:n,startTime:f}}async fetchWithTimeout(t,e,n,r){const s=e||{},{signal:i,method:o}=s,a=ys(s,["signal","method"]);i&&i.addEventListener("abort",()=>r.abort());const c=setTimeout(()=>r.abort(),n),u=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||"object"==typeof a.body&&null!==a.body&&Symbol.asyncIterator in a.body,h=Object.assign(Object.assign(Object.assign({signal:r.signal},u?{duplex:"half"}:{}),{method:"GET"}),a);o&&(h.method=o.toUpperCase());try{return await this.fetch.call(void 0,t,h)}finally{clearTimeout(c)}}async shouldRetry(t){const e=t.headers.get("x-should-retry");return"true"===e||"false"!==e&&(408===t.status||(409===t.status||(429===t.status||t.status>=500)))}async retryRequest(t,e,n,r){var s;let i;const o=null==r?void 0:r.get("retry-after-ms");if(o){const t=parseFloat(o);Number.isNaN(t)||(i=t)}const a=null==r?void 0:r.get("retry-after");if(a&&!i){const t=parseFloat(a);i=Number.isNaN(t)?Date.parse(a)-Date.now():1e3*t}if(!(i&&0<=i&&i<6e4)){const n=null!==(s=t.maxRetries)&&void 0!==s?s:this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(e,n)}var c;return await(c=i,new Promise(t=>setTimeout(t,c))),this.makeRequest(t,e-1,n)}calculateDefaultRetryTimeoutMillis(t,e){const n=e-t;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}async buildRequest(t,{retryCount:e=0}={}){var n,r,s;const i=Object.assign({},t),{method:o,path:a,query:c,defaultBaseURL:u}=i,h=this.buildURL(a,c,u);"timeout"in i&&((t,e)=>{if("number"!=typeof e||!Number.isInteger(e))throw new Is(`${t} must be an integer`);if(e<0)throw new Is(`${t} must be a positive integer`)})("timeout",i.timeout),i.timeout=null!==(n=i.timeout)&&void 0!==n?n:this.timeout;const{bodyHeaders:l,body:p}=this.buildBody({options:i}),f=await this.buildHeaders({options:t,method:o,bodyHeaders:l,retryCount:e});return{req:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({method:o,headers:f},i.signal&&{signal:i.signal}),globalThis.ReadableStream&&p instanceof globalThis.ReadableStream&&{duplex:"half"}),p&&{body:p}),null!==(r=this.fetchOptions)&&void 0!==r?r:{}),null!==(s=i.fetchOptions)&&void 0!==s?s:{}),url:h,timeout:i.timeout}}async buildHeaders({options:t,method:e,bodyHeaders:n,retryCount:r}){let s={};this.idempotencyHeader&&"get"!==e&&(t.idempotencyKey||(t.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=t.idempotencyKey);const i=await this.authHeaders(t);let o=Pi([s,Object.assign(Object.assign({Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r)},t.timeout?{"X-Stainless-Timeout":String(Math.trunc(t.timeout/1e3))}:{}),null!=Vs?Vs:Vs=Gs()),this._options.defaultHeaders,n,t.headers,i]);return this.validateHeaders(o),o.values}buildBody({options:{body:t,headers:e}}){if(!t)return{bodyHeaders:void 0,body:void 0};const n=Pi([e]);return ArrayBuffer.isView(t)||t instanceof ArrayBuffer||t instanceof DataView||"string"==typeof t&&n.values.has("content-type")||globalThis.Blob&&t instanceof globalThis.Blob||t instanceof FormData||t instanceof URLSearchParams||globalThis.ReadableStream&&t instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:t}:"object"==typeof t&&(Symbol.asyncIterator in t||Symbol.iterator in t&&"next"in t&&"function"==typeof t.next)?{bodyHeaders:void 0,body:Ys(t)}:this.encoder({body:t,headers:n})}}bi.DEFAULT_TIMEOUT=6e4;class Li extends bi{constructor(){super(...arguments),this.interactions=new si(this)}}function Ri(t,e){if(Array.isArray(e)&&"TODO"===e[0]){const[t,n,r,s]=e;r.valOf(new Map)}}function xi(t,e){t.forInfo&&Ri(0,e)}function Ci(t,e){const n=t.get(e);return n||e}function Di(t,e,n){return new Map([[e,n],...t])}function ki(t,e,n,r){const s=n.readBackType(t),i=r.readBackType(t);return or(s,i)?new Yn(void 0):new Kn(e,new Vn([`Expected ${i} but got ${s}`]))}function $i(t,e,n,r,s){return or(bt(t,n,r),bt(t,n,s))?new Yn(void 0):new Kn(e,new Vn([`The terms ${r.prettyPrint()} and ${s.prettyPrint()} are not the same ${n.prettyPrint()}.`]))}function Mi(t){return Ui(t.split(""))}function Ui(t){return 0===t.length||(e=t[0],!(!/^[a-zA-Z]$/.test(e)&&"-"!==t[0])&&Ui(t.slice(1)));var e}function Bi(t,e,n){return new Mo(t.location,t,e,n)}Si=Li,Li.GeminiNextGenAPIClient=Si,Li.GeminiNextGenAPIClientError=Is,Li.APIError=_s,Li.APIConnectionError=Ps,Li.APIConnectionTimeoutError=As,Li.APIUserAbortError=Os,Li.NotFoundError=Rs,Li.ConflictError=xs,Li.RateLimitError=Ds,Li.BadRequestError=Ss,Li.AuthenticationError=bs,Li.InternalServerError=ks,Li.PermissionDeniedError=Ls,Li.UnprocessableEntityError=Cs,Li.toFile=async function(t,e,n){if(js(),(t=>null!=t&&"object"==typeof t&&"string"==typeof t.name&&"number"==typeof t.lastModified&&Js(t))(t=await t))return t instanceof File?t:Xs([await t.arrayBuffer()],t.name);if((t=>null!=t&&"object"==typeof t&&"string"==typeof t.url&&"function"==typeof t.blob)(t)){const r=await t.blob();return e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()),Xs(await Qs(r),e,n)}const r=await Qs(t);if(e||(e=function(t){return("object"==typeof t&&null!==t&&("name"in t&&t.name&&String(t.name)||"url"in t&&t.url&&String(t.url)||"filename"in t&&t.filename&&String(t.filename)||"path"in t&&t.path&&String(t.path))||"").split(/[\\/]/).pop()||void 0}(t)),!(null==n?void 0:n.type)){const t=r.find(t=>"object"==typeof t&&"type"in t&&t.type);"string"==typeof t&&(n=Object.assign(Object.assign({},n),{type:t}))}return Xs(r,e,n)},Li.Interactions=si;class Gi{static synthNat(t,e){return new Yn(new Me(new Ue,new Be))}static synthUniverse(t,e,n){return new Kn(n,new Vn(["U is a type, but it does not have a type."]))}static synthArrow(t,e,n,r,s,i){if(0===i.length){const n=er(t,s,"x"),i=new zn("Aout"),o=new zn("Bout");return jn([[i,()=>r.check(t,e,new Ae)],[o,()=>s.check(ft(t,n,W(t,i.value)),e,new Ae)]],()=>new Yn(new Me(new Ue,new Ke(n,i.value,o.value))))}{const[o,...a]=i,c=er(t,Bi(s,o,a),"x"),u=new zn("Aout"),h=new zn("tout");return jn([[u,()=>r.check(t,e,new Ae)],[h,()=>new Qi(K(n),s,o,a).check(ft(t,c,W(t,u.value)),e,new Ae)]],()=>new Yn(new Me(new Ue,new Ke(c,u.value,h.value))))}}static synthPi(t,e,n,r,s){if(1===r.length){const[n,i]=[r[0].binder,r[0].type],o=tr(t,n.varName),a=(n.location,new zn("Aout")),c=new zn("Bout");return jn([[a,()=>i.check(t,e,new Ae)],[c,()=>s.check(ft(t,o,W(t,a.value)),Di(e,n.varName,o),new Ae)]],()=>(Ri(0,["binding-site",a.value]),new Yn(new Me(new Ue,new Ke(o,a.value,c.value)))))}if(r.length>1){const[i,...o]=r,[a,c]=[i.binder,i.type],u=(a.location,a.varName),h=tr(t,u),l=new zn("Aout"),p=new zn("Bout");return jn([[l,()=>c.check(t,e,new Ae)],[p,()=>new Wi(K(n),o,s).check(ft(t,h,W(t,l.value)),Di(e,u,h),new Ae)]],()=>(Ri(0,["binding-site",l.value]),new Yn(new Me(new Ue,new Ke(h,l.value,p.value)))))}throw new Error("Invalid number of binders in Pi type")}static synthZero(t,e){return new Yn(new Me(new Be,new Ge))}static synthAdd1(t,e,n){const r=new zn("nout");return jn([[r,()=>n.check(t,e,new ce)]],()=>new Yn(new Me(new Be,new He(r.value))))}static synthWhichNat(t,e,n,r,s){const i=new zn("tgtout"),o=new zn("bout"),a=new zn("sout"),c=tr(t,"n_minus_1");return jn([[i,()=>n.check(t,e,new ce)],[o,()=>r.synth(t,e)],[a,()=>s.check(t,e,new le(c,new ce,new Jn(rt(t),c,o.value.type)))]],()=>new Yn(new Me(o.value.type,new Fe(i.value,new Me(o.value.type,o.value.expr),a.value))))}static synthIterNat(t,e,n,r,s){const i=new zn("tgtout"),o=new zn("bout"),a=new zn("sout");return jn([[i,()=>n.check(t,e,new ce)],[o,()=>r.synth(t,e)],[a,()=>s.check(t,e,(()=>{const e=tr(t,"old");return W(t,new Ke(e,o.value.type,o.value.type))})())]],()=>new Yn(new Me(o.value.type,new Ve(i.value,new Me(o.value.type,o.value.expr),a.value))))}static synthRecNat(t,e,n,r,s){const i=new zn("tgtout"),o=new zn("bout"),a=new zn("sout");return jn([[i,()=>n.check(t,e,new ce)],[o,()=>r.synth(t,e)],[a,()=>s.check(t,e,(()=>{const e=tr(t,"n_minus_1"),n=tr(t,"old");return W(t,new Ke(e,new Be,new Ke(n,o.value.type,o.value.type)))})())]],()=>new Yn(new Me(o.value.type,new qe(i.value,new Me(o.value.type,o.value.expr),a.value))))}static synthIndNat(t,e,n,r,s,i){const o=new zn("tgtout"),a=new zn("motout"),c=new zn("motval"),u=new zn("bout"),h=new zn("sout");return jn([[o,()=>n.check(t,e,new ce)],[a,()=>r.check(t,e,new le("n",new ce,new Qn(t=>new Ae)))],[c,()=>new Yn(W(t,a.value))],[u,()=>s.check(t,e,wt(c.value,new ue))],[h,()=>i.check(t,e,new le("n-1",new ce,new Qn(t=>new le("x",wt(c.value,t),new Qn(e=>wt(c.value,new he(t)))))))]],()=>new Yn(new Me(new Sn(a.value,o.value),new Ye(o.value,a.value,u.value,h.value))))}static synthAtom(t,e){return new Yn(new Me(new Ue,new je))}static synthPair(t,e,n,r){const s=tr(t,"a"),i=new zn("Aout"),o=new zn("Dout");return jn([[i,()=>n.check(t,e,new Ae)],[o,()=>r.check(ft(t,s,W(t,i.value)),e,new Ae)]],()=>new Yn(new Me(new Ue,new Je(s,i.value,o.value))))}static synthSigma(t,e,n,r,s){if(1===r.length){const[n,i]=[r[0].binder,r[0].type],o=tr(t,n.varName),a=(n.location,new zn("Aout")),c=new zn("Dout");return jn([[a,()=>i.check(t,e,new Ae)],[c,()=>s.check(ft(t,o,W(t,a.value)),Di(e,n.varName,o),new Ae)]],()=>(Ri(0,["binding-site",a.value]),new Yn(new Me(new Ue,new Je(o,a.value,c.value)))))}if(r.length>1){const[i,...o]=r,[a,c]=[i.binder,i.type],u=(a.location,a.varName),h=tr(t,u),l=new zn("Aout"),p=new zn("Dout");return jn([[l,()=>c.check(t,e,new Ae)],[p,()=>new to(K(n),o,s).check(ft(t,h,W(t,l.value)),Di(e,u,h),new Ae)]],()=>(Ri(0,["binding-site",l.value]),new Yn(new Me(new Ue,new Je(h,l.value,p.value)))))}throw new Error("Invalid number of binders in Sigma type")}static synthCar(t,e,n,r){const s=new zn("p_rst");return jn([[s,()=>r.synth(t,e)]],()=>{const e=W(t,s.value.type);return e instanceof fe?new Yn(new Me(e.carType.readBackType(t),new We(s.value.expr))):new Kn(n,new Vn([`car requires a Pair type, but was used as a: ${e}.`]))})}static synthCdr(t,e,n,r){const s=new zn("pout");return jn([[s,()=>r.synth(t,e)]],()=>{const e=W(t,s.value.type);if(e instanceof fe){const[n,r,i]=[e.carName,e.carType,e.cdrType];return new Yn(new Me(i.valOfClosure(Tt(W(t,s.value.expr))).readBackType(t),new Ze(s.value.expr)))}return new Kn(n,new Vn([`cdr requires a Pair type, but was used as a: ${e}.`]))})}static synthQuote(t,e,n,r){return Mi(r)?new Yn(new Me(new je,new Xe(r))):new Kn(n,new Vn([`Invalid atom: ${r}. Atoms consist of letters and hyphens.`]))}static synthTrivial(t,e){return new Yn(new Me(new Ue,new on))}static synthSole(t,e){return new Yn(new Me(new on,new an))}static synthIndList(t,e,n,r,s,i,o){const a=new zn("tgtout"),c=new zn("motout"),u=new zn("motval"),h=new zn("bout"),l=new zn("sout");return jn([[a,()=>r.synth(t,e)]],()=>{const[r,p]=[a.value.type,a.value.expr],f=W(t,r);if(f instanceof ye){const n=f.entryType;return jn([[c,()=>s.check(t,e,new le("xs",new ye(n),new Jn(rt(t),"xs",new Ue)))],[u,()=>new Yn(W(t,c.value))],[h,()=>i.check(t,e,wt(u.value,new we))],[l,()=>o.check(t,e,new le("e",n,new Qn(t=>new le("es",new ye(n),new Qn(e=>new le("ih",wt(u.value,e),new Qn(n=>wt(u.value,new me(t,e)))))))))]],()=>new Yn(new Me(new Sn(c.value,p),new sn(p,c.value,h.value,l.value))))}return new Kn(n,new Vn([`Not a List: ${f.readBackType(t)}.`]))})}static synthRecList(t,e,n,r,s,i){const o=new zn("tgtout");return jn([[o,()=>r.synth(t,e)]],()=>{const[r,a]=[o.value.type,o.value.expr],c=W(t,r);if(c instanceof ye){const n=c.entryType,r=new zn("bout"),o=new zn("btval"),u=new zn("sout");return jn([[r,()=>s.synth(t,e)],[o,()=>new Yn(W(t,r.value.type))],[u,()=>i.check(t,e,new le("e",n,new Qn(t=>new le("es",new ye(n),new Qn(t=>new le("ih",o.value,new Qn(t=>o.value)))))))]],()=>new Yn(new Me(r.value.type,new rn(a,new Me(r.value.type,r.value.expr),u.value))))}return new Kn(n,new Vn([`Not a List: ${c.readBackType(t)}.`]))})}static synthList(t,e,n){const r=new zn("Eout");return jn([[r,()=>n.entryType.check(t,e,new Ae)]],()=>new Yn(new Me(new Ue,new nn(r.value))))}static synthListCons(t,e,n,r){const s=new zn("eout"),i=new zn("esout");return jn([[s,()=>n.synth(t,e)],[i,()=>r.check(t,e,W(t,new nn(s.value.type)))]],()=>new Yn(new Me(new nn(s.value.type),new tn(s.value.expr,i.value))))}static synthAbsurd(t,e,n){return new Yn(new Me(new Ue,new cn))}static synthIndAbsurd(t,e,n){const r=new zn("tgtout"),s=new zn("motout");return jn([[r,()=>n.target.check(t,e,new Re)],[s,()=>n.motive.check(t,e,new Ae)]],()=>new Yn(new Me(s.value,new un(r.value,s.value))))}static synthEqual(t,e,n,r,s){const i=new zn("Aout"),o=new zn("Av"),a=new zn("from_out"),c=new zn("to_out");return jn([[i,()=>n.check(t,e,new Ae)],[o,()=>new Yn(W(t,i.value))],[a,()=>r.check(t,e,o.value)],[c,()=>s.check(t,e,o.value)]],()=>new Yn(new Me(new Ue,new hn(i.value,a.value,c.value))))}static synthReplace(t,e,n,r,s,i){const o=new zn("tgt_rst"),a=new zn("motout"),c=new zn("bout");return jn([[o,()=>r.synth(t,e)]],()=>{const r=W(t,o.value.type);if(r instanceof Ee){const[n,u,h]=[r.type,r.from,r.to];return jn([[a,()=>s.check(t,e,new le("x",n,new Qn(t=>new Ae)))],[c,()=>i.check(t,e,wt(W(t,a.value),u))]],()=>new Yn(new Me(wt(W(t,a.value),h).readBackType(t),new pn(o.value.expr,a.value,c.value))))}return new Kn(n,new Vn([`Expected an expression with = type, but the type was: ${o.value.type}.`]))})}static synthTrans(t,e,n,r,s){const i=new zn("p1_rst"),o=new zn("p2_rst");return jn([[i,()=>r.synth(t,e)],[o,()=>s.synth(t,e)]],()=>{const e=W(t,i.value.type),r=W(t,o.value.type);if(e instanceof Ee&&r instanceof Ee){const[s,a,c]=[e.type,e.from,e.to],[u,h,l]=[r.type,r.from,r.to];return jn([[new zn("_"),()=>ki(t,n,s,u)],[new zn("_"),()=>$i(t,n,s,c,h)]],()=>new Yn(new Me(new Ee(s,a,l).readBackType(t),new fn(i.value.expr,o.value.expr))))}return new Kn(n,new Vn([`Expected =, got ${e} and ${r}.`]))})}static synthCong(t,e,n,r,s){const i=new zn("bout"),o=new zn("f_rst");return jn([[i,()=>r.synth(t,e)],[o,()=>s.synth(t,e)]],()=>{const e=W(t,i.value.type),r=W(t,o.value.type);if(e instanceof Ee){const[s,a,c]=[e.type,e.from,e.to];if(r instanceof le){const[e,u,h]=[r.argName,r.argType,r.resultType],l=new zn("ph"),p=new zn("Cv"),f=new zn("fv");return jn([[l,()=>ki(t,n,s,u)],[p,()=>new Yn(h.valOfClosure(a))],[f,()=>new Yn(W(t,o.value.expr))]],()=>new Yn(new Me(new hn(p.value.readBackType(t),bt(t,p.value,wt(f.value,a)),bt(t,p.value,wt(f.value,c))),new dn(i.value.expr,p.value.readBackType(t),o.value.expr))))}return new Kn(n,new Vn([`Expected a function type, got ${r.readBackType(t)}.`]))}return new Kn(n,new Vn([`Expected an = type, got ${e.readBackType(t)}.`]))})}static synthSymm(t,e,n,r){const s=new zn("eout");return jn([[s,()=>r.synth(t,e)]],()=>{const e=W(t,s.value.type);if(e instanceof Ee){const[n,r,i]=[e.type,e.from,e.to];return new Yn(new Me(new Ee(n,i,r).readBackType(t),new yn(s.value.expr)))}return new Kn(n,new Vn([`Expected an = type, got ${e.readBackType(t)}.`]))})}static synthIndEqual(t,e,n,r,s,i){const o=new zn("tgtout"),a=new zn("motout"),c=new zn("motv"),u=new zn("baseout");return jn([[o,()=>r.synth(t,e)]],()=>{const r=W(t,o.value.type);if(r instanceof Ee){const[n,h,l]=[r.type,r.from,r.to];return jn([[a,()=>s.check(t,e,new le("to",n,new Qn(t=>new le("p",new Ee(n,h,t),new Qn(t=>new Ae)))))],[c,()=>new Yn(W(t,a.value))],[u,()=>i.check(t,e,wt(wt(c.value,h),new ge(h)))]],()=>new Yn(new Me(wt(wt(c.value,l),W(t,o.value.expr)).readBackType(t),new wn(o.value.expr,a.value,u.value))))}return new Kn(n,new Vn([`Expected evidence of equality, got ${r.readBackType(t)}.`]))})}static synthVec(t,e,n,r){const s=new zn("tout"),i=new zn("lenout");return jn([[s,()=>n.check(t,e,new Ae)],[i,()=>r.check(t,e,new ce)]],()=>new Yn(new Me(new Ue,new mn(s.value,i.value))))}static synthHead(t,e,n,r){const s=new zn("vout");return jn([[s,()=>r.synth(t,e)]],()=>{const e=W(t,s.value.type).now();if(e instanceof Te){const[r,i]=[e.entryType,e.length];return i.now()instanceof he?new Yn(new Me(r.readBackType(t),new Tn(s.value.expr))):new Kn(n,new Vn([`Expected a Vec with add1 at the top of the length, got ${bt(t,new ce,i)}.`]))}return new Kn(n,new Vn([`Expected a Vec, got ${e.readBackType(t)}.`]))})}static synthTail(t,e,n,r){const s=new zn("vout");return jn([[s,()=>r.synth(t,e)]],()=>{const e=W(t,s.value.type).now();if(e instanceof Te){const[r,i]=[e.entryType,e.length],o=i.now();if(o instanceof he){const e=o.smaller;return new Yn(new Me(new mn(r.readBackType(t),bt(t,new ce,e)),new Nn(s.value.expr)))}return new Kn(n,new Vn([`Expected a Vec with add1 at the top of the length, got ${bt(t,new ce,i)}.`]))}return new Kn(n,new Vn([`Expected a Vec, got ${e.readBackType(t)}.`]))})}static synthIndVec(t,e,n,r,s,i,o,a){const c=new zn("lenout"),u=new zn("lenv"),h=new zn("vecout"),l=new zn("motout"),p=new zn("motval"),f=new zn("bout"),d=new zn("sout");return jn([[c,()=>r.check(t,e,new ce)],[u,()=>new Yn(W(t,c.value))],[h,()=>s.synth(t,e)]],()=>{const r=W(t,h.value.type);if(r instanceof Te){const[s,y]=[r.entryType,r.length];return jn([[new zn("_"),()=>$i(t,n,new ce,u.value,y)],[l,()=>i.check(t,e,new le("k",new ce,new Qn(t=>new le("es",new Te(s,t),new Qn(t=>new Ae)))))],[p,()=>new Yn(W(t,l.value))],[f,()=>o.check(t,e,wt(wt(p.value,new ue),new Ne))],[d,()=>a.check(t,e,Ot(s,p.value))]],()=>new Yn(new Me(new Sn(new Sn(l.value,c.value),h.value.expr),new vn(c.value,h.value.expr,l.value,f.value,d.value))))}return new Kn(n,new Vn([`Expected a Vec, got ${r.readBackType(t)}.`]))})}static synthEither(t,e,n,r){const s=new zn("Lout"),i=new zn("Rout");return jn([[s,()=>n.check(t,e,new Ae)],[i,()=>r.check(t,e,new Ae)]],()=>new Yn(new Me(new Ue,new In(s.value,i.value))))}static synthIndEither(t,e,n,r,s,i,o){const a=new zn("tgtout"),c=new zn("motout"),u=new zn("motval"),h=new zn("lout"),l=new zn("rout");return jn([[a,()=>r.synth(t,e)]],()=>{const r=W(t,a.value.type);if(r instanceof Ie){const[n,p]=[r.leftType,r.rightType];return jn([[c,()=>s.check(t,e,new le("x",new Ie(n,p),new Qn(t=>new Ae)))],[u,()=>new Yn(W(t,c.value))],[h,()=>i.check(t,e,new le("x",n,new Qn(t=>wt(u.value,new _e(t)))))],[l,()=>o.check(t,e,new le("x",p,new Qn(t=>wt(u.value,new Oe(t)))))]],()=>new Yn(new Me(new Sn(c.value,a.value.expr),new Pn(a.value.expr,c.value,h.value,l.value))))}return new Kn(n,new Vn([`Expected an Either, but got a ${r.readBackType(t)}.`]))})}static synthThe(t,e,n,r){const s=new zn("t_out"),i=new zn("e_out");return jn([[s,()=>n.isType(t,e)],[i,()=>r.check(t,e,W(t,s.value))]],()=>new Yn(new Me(s.value,i.value)))}static synthApplication(t,e,n,r,s,i){if(r instanceof eo){if(t.get(r.name)instanceof lt)return new Ho(n,r.name,[s,...i]),new Kn(n,new Vn([`Constructor ${r.name} requires a type annotation. Use (the Type (${r.name} ...))`]))}if(0===i.length){const i=new zn("fout");return jn([[i,()=>r.synth(t,e)]],()=>{const r=W(t,i.value.type);if(r instanceof le){const[n,o,a]=[r.argName,r.argType,r.resultType],c=new zn("argout");return jn([[c,()=>s.check(t,e,o)]],()=>new Yn(new Me(a.valOfClosure(W(t,c.value)).readBackType(t),new Sn(i.value.expr,c.value))))}return new Kn(n,new Vn([`Not a function type: ${r.readBackType(t)}.`]))})}{const o=new zn("appout");return jn([[o,()=>new Mo(K(n),r,s,i.slice(0,i.length-1)).synth(t,e)]],()=>{const r=W(t,o.value.type);if(r instanceof le){const[n,s,a]=[r.argName,r.argType,r.resultType],c=new zn("fout");return jn([[c,()=>i[i.length-1].check(t,e,s)]],()=>new Yn(new Me(a.valOfClosure(W(t,c.value)).readBackType(t),new Sn(o.value.expr,c.value))))}return new Kn(n,new Vn([`Not a function type: ${r.readBackType(t)}.`]))})}}static synthName(t,e,n,r){const s=Ci(e,r),i=new zn("x_tv");return jn([[i,()=>pt(t,0,s)]],()=>{const e=t.get(s);if(e instanceof ct&&Ri(0,"definition"),e instanceof ht){const n=e.type;return new Yn(new Me(new Ue,new Ln(n.name,n.parameterTypes.map(e=>e.readBackType(t)),n.indexTypes.map(e=>e.readBackType(t)))))}return new Yn(new Me(i.value.readBackType(t),new bn(s)))})}static synthNumber(t,e,n,r){if(0===r)return new Yn(new Me(new Be,new Ge));if(r>0){const s=new zn("n_1_out");return jn([[s,()=>new lo(n,r-1).check(t,e,new ce)]],()=>new Yn(new Me(new Be,new He(s.value))))}return new Kn(n,new Vn([`Expected a positive number, got ${r}.`]))}static synthGeneralEliminator(t,e,n){const r=st(t,n.location,n.typeName);if(r instanceof Kn)return r;const s=r.result.type,i=n.target.synth(t,e);if(i instanceof Kn)return i;const o=i.result,a=W(t,o.type);if(!(a instanceof xe)||a.name!==n.typeName)return new Kn(n.location,new Vn([`Expected type ${n.typeName}, got ${a.readBackType(t)}`]));let c=s.indexTypes;const u=(e,n)=>{if(e>=c.length)return new le("target",new xe(a.name,a.parameters,n),new Qn(t=>new Ae));const r=c[e];return new le(tr(t,"idx"),r,new Qn(t=>u(e+1,[...n,t])))},h=u(0,[]),l=n.motive.check(t,e,h);if(l instanceof Kn)return l;const p=l.result,f=W(t,p),d=h.readBackType(t),y=this.getConstructorTypesForDatatype(t,n.typeName);if(n.methods.length!==y.length)return new Kn(n.location,new Vn([`Expected ${y.length} methods, got ${n.methods.length}`]));let w=t;if(y.length>0){const t=y[0].core;for(let e=0;e<t.resultType.parameters.length&&e<a.parameters.length;e++){const n=t.resultType.parameters[e];n instanceof bn&&(w=ft(w,n.name,a.parameters[e]))}}const m=[],E=[];for(let r=0;r<n.methods.length;r++){const s=this.generateMethodTypeForConstructor(w,y[r].core,bt(t,h,f),a.parameters);E.push(s);const i=n.methods[r].check(t,e,W(w,s));if(i instanceof Kn)return i;m.push(i.result)}let g=f;for(const t of a.indices)g=wt(g,t);g=wt(g,W(t,o.expr));const T=new Dn(n.typeName,o.expr,p,m,E,d);return new Yn(new Me(g.readBackType(t),T))}static getConstructorTypesForDatatype(t,e){const n=[];for(const[r,s]of t)if(s instanceof lt){s.constructorType.type===e&&n.push({core:s.constructorType,resultTypeValue:s.type})}return n.sort((t,e)=>t.core.index-e.core.index)}static generateMethodTypeForConstructor(t,e,n,r){let s=n;for(const t of e.resultType.indices)s=new Sn(s,t);const i=new xn(e.name,e.index,e.type,e.argNames.map(t=>new bn(t)),e.rec_argNames.map(t=>new bn(t)));s=new Sn(s,i);for(let r=e.rec_argTypes.length-1;r>=0;r--){const i=e.rec_argTypes[r];if(!(i instanceof Ln))throw new Error("not recursive arg");{let o=n;for(const t of i.indices){o=new Sn(o,t)}const a=e.rec_argNames[r],c=new bn(a);o=new Sn(o,c);const u=tr(t,"ih");s=new Ke(u,o,s)}}for(let t=e.rec_argTypes.length-1;t>=0;t--){const n=e.rec_argTypes[t],r=e.rec_argNames[t];s=new Ke(r,n,s)}for(let t=e.argTypes.length-1;t>=0;t--){const n=e.argTypes[t],r=e.argNames[t];s=new Ke(r,n,s)}return s}}class Hi{constructor(t){this.location=t}isType(t,e){const n=new zn("ok"),r=this.getType(t,e);return jn([[n,()=>r]],()=>(xi(this.location,["is-type",n.value]),new Yn(n.value)))}getType(t,e){const n=this.check(t,e,new Ae);if(n instanceof Yn)return n;if(n instanceof Kn){if(this instanceof eo&&Wn(this.name)){const e=new zn("other-tv");return jn([[e,()=>pt(t,this.location,this.name)]],()=>new Kn(this.location,new Vn([`Expected U, but given ${e.value.readBackType(t)}`])))}return new Kn(this.location,new Vn(["not a type"]))}throw new Error("Invalid checkType")}check(t,e,n){const r=new zn("ok"),s=this.checkOut(t,e,n);return jn([[r,()=>s]],()=>new Yn(r.value))}synth(t,e){const n=new zn("ok");return jn([[n,()=>this.synthHelper(t,e)]],()=>(xi(this.location,["is-type",n.value.type]),new Yn(n.value)))}checkOut(t,e,n){const r=new zn("theT");return jn([[r,()=>this.synth(t,e)],[new zn("_"),()=>ki(t,this.location,W(t,r.value.type),n)]],()=>new Yn(r.value.expr))}}class Fi extends Hi{constructor(t,e,n){super(t),this.location=t,this.type=e,this.value=n}synthHelper(t,e){return Gi.synthThe(t,e,this.type,this.value)}findNames(){return this.type.findNames().concat(this.value.findNames())}prettyPrint(){return`(the ${this.type.prettyPrint()} ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class Vi extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthUniverse(t,e,this.location)}findNames(){return[]}getType(t,e){return new Yn(new Ue)}prettyPrint(){return"U"}toString(){return this.prettyPrint()}}class qi extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthNat(t,e)}findNames(){return[]}getType(t,e){return new Yn(new Be)}prettyPrint(){return"Nat"}toString(){return this.prettyPrint()}}class Yi extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthZero(t,e)}findNames(){return[]}prettyPrint(){return"zero"}toString(){return this.prettyPrint()}}class Ki extends Hi{constructor(t,e){super(t),this.location=t,this.base=e}synthHelper(t,e){return Gi.synthAdd1(t,e,this.base)}findNames(){return this.base.findNames()}prettyPrint(){return`(add1 ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class zi extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return Gi.synthWhichNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(which-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class ji extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return Gi.synthIterNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(iter-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Xi extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return Gi.synthRecNat(t,e,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(rec-nat ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Ji extends Hi{constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.base=r,this.step=s}synthHelper(t,e){return Gi.synthIndNat(t,e,this.target,this.motive,this.base,this.step)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(ind-nat ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class Qi extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.arg1=e,this.arg2=n,this.args=r}synthHelper(t,e){return Gi.synthArrow(t,e,this.location,this.arg1,this.arg2,this.args)}findNames(){return this.arg1.findNames().concat(this.arg2.findNames()).concat(this.args.flatMap(t=>t.findNames()))}getType(t,e){const[n,r,s]=[this.arg1,this.arg2,this.args];if(0===s.length){const s=er(t,r,"x"),i=new zn("Aout"),o=new zn("Bout");return jn([[i,()=>n.isType(t,e)],[o,()=>r.isType(ft(t,s,W(t,i.value)),e)]],()=>new Yn(new Ke(s,i.value,o.value)))}{const[i,...o]=s,a=er(t,Bi(r,i,o),"x"),c=new zn("Aout"),u=new zn("tout");return jn([[c,()=>n.isType(t,e)],[u,()=>new Qi(K(this.location),r,i,o).isType(ft(t,a,W(t,c.value)),e)]],()=>new Yn(new Ke(a,c.value,u.value)))}}prettyPrint(){return`(-> ${this.arg1.prettyPrint()} ${this.arg2.prettyPrint()} ${this.args.map(t=>t.prettyPrint()).join(" ")})`}toString(){return this.prettyPrint()}}class Wi extends Hi{constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){return Gi.synthPi(t,e,this.location,this.binders,this.body)}findNames(){return this.binders.flatMap(t=>nr(t)).concat(this.body.findNames())}getType(t,e){const[n,r]=[this.binders,this.body];if(1===n.length){const[s,i]=[n[0].binder,n[0].type],o=tr(t,s.varName),a=(s.location,new zn("Aout")),c=new zn("Aoutv"),u=new zn("Bout");return jn([[a,()=>i.isType(t,e)],[c,()=>new Yn(W(t,a.value))],[u,()=>r.isType(ft(t,o,c.value),Di(e,s.varName,o))]],()=>(Ri(0,["binding-site",a.value]),new Yn(new Ke(o,a.value,u.value))))}if(n.length>1){const[s,...i]=n,[o,a]=[s.binder.varName,s.type],c=tr(t,o),u=(s.binder.location,new zn("Aout")),h=new zn("Aoutv"),l=new zn("Bout");return jn([[u,()=>a.isType(t,e)],[h,()=>new Yn(W(t,u.value))],[l,()=>new Wi(K(this.location),i,r).isType(ft(t,c,h.value),Di(e,s.binder.varName,c))]],()=>(Ri(0,["binding-site",u.value]),new Yn(new Ke(c,u.value,l.value))))}throw new Error("Invalid number of binders in Pi type")}prettyPrint(){return`(Π ${this.binders.map(t=>`(${t.binder.varName} ${t.type.prettyPrint()})`).join(" ")} \n            ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class Zi extends Hi{constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){throw new Error('Cannot synthesize a lambda expression: Try to add explicit type annotation using "the"')}findNames(){return this.binders.map(t=>t.varName).concat(this.body.findNames())}checkOut(t,e,n){if(1===this.binders.length){const r=this.body,s=this.binders[0],i=s.varName,o=s.location,a=n.now();if(a instanceof le){const n=a.argType,s=a.resultType,o=Ci(e,i),c=new zn("bout");return jn([[c,()=>r.check(ft(t,o,n),Di(e,i,o),s.valOfClosure(new Pe(n,new xt(o))))]],()=>(Ri(0,["binding-site",n.readBackType(t)]),new Yn(new ze(o,c.value))))}return new Kn(o,new Vn([`Not a function type: ${a.readBackType(t)}.`]))}return new Zi(this.location,[this.binders[0]],new Zi(K(this.location),this.binders.slice(1),this.body)).check(t,e,n)}prettyPrint(){return`(lambda ${this.binders.map(t=>t.varName).join(" ")} ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class to extends Hi{constructor(t,e,n){super(t),this.location=t,this.binders=e,this.body=n}synthHelper(t,e){return Gi.synthSigma(t,e,this.location,this.binders,this.body)}findNames(){return this.binders.flatMap(t=>nr(t)).concat(this.body.findNames())}getType(t,e){const[n,r]=[this.binders,this.body];if(1===n.length){const[s,i]=[n[0].binder,n[0].type],o=s.varName,a=tr(t,o),c=(s.location,new zn("Aout")),u=new zn("Aoutv"),h=new zn("Dout");return jn([[c,()=>i.isType(t,e)],[u,()=>new Yn(W(t,c.value))],[h,()=>r.isType(ft(t,a,u.value),Di(e,o,a))]],()=>(Ri(0,["binding-site",c.value]),new Yn(new Je(a,c.value,h.value))))}if(n.length>1){const[[s,i],...o]=[[n[0].binder,n[0].type],n[1],...n.slice(2)],a=s.varName,c=tr(t,a),u=(s.location,new zn("Aout")),h=new zn("Aoutv"),l=new zn("Dout");return jn([[u,()=>i.isType(t,e)],[h,()=>new Yn(W(t,u.value))],[l,()=>new to(this.location,o,r).isType(ft(t,a,h.value),Di(e,a,c))]],()=>(Ri(0,["binding-site",u.value]),new Yn(new Je(c,u.value,l.value))))}throw new Error("Invalid number of binders in Sigma type")}prettyPrint(){return`(Σ ${this.binders.map(t=>`(${t.binder.varName} ${t.type.prettyPrint()})`).join(" ")} \n            ${this.body.prettyPrint()})`}toString(){return this.prettyPrint()}}class eo extends Hi{constructor(t,e){super(t),this.location=t,this.name=e}synthHelper(t,e){return Gi.synthName(t,e,this.location,this.name)}findNames(){return[this.name]}prettyPrint(){return this.name}toString(){return this.prettyPrint()}}class no extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthAtom(t,e)}findNames(){return[]}getType(t,e){return new Yn(new je)}prettyPrint(){return"Atom"}toString(){return this.prettyPrint()}}class ro extends Hi{constructor(t,e){super(t),this.location=t,this.name=e}synthHelper(t,e){return Gi.synthQuote(t,e,this.location,this.name)}findNames(){return[]}prettyPrint(){return`'${this.name}`}toString(){return this.prettyPrint()}}class so extends Hi{constructor(t,e,n){super(t),this.location=t,this.first=e,this.second=n}synthHelper(t,e){return Gi.synthPair(t,e,this.first,this.second)}findNames(){return this.first.findNames().concat(this.second.findNames())}getType(t,e){const n=new zn("Aout"),r=new zn("Dout"),s=er(t,this.second,"x");return jn([[n,()=>this.first.isType(t,e)],[r,()=>this.second.isType(ft(t,s,W(t,n.value)),e)]],()=>new Yn(new Je(s,n.value,r.value)))}prettyPrint(){return`(Pair ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}}class io extends Hi{constructor(t,e,n){super(t),this.location=t,this.first=e,this.second=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.first.findNames().concat(this.second.findNames())}checkOut(t,e,n){const r=n.now();if(r instanceof fe){const n=r.carType,s=r.cdrType,i=new zn("aout"),o=new zn("dout");return jn([[i,()=>this.first.check(t,e,n)],[o,()=>this.second.check(t,e,s.valOfClosure(W(t,i.value)))]],()=>new Yn(new Qe(i.value,o.value)))}return new Kn(this.location,new Vn([`cons requires a Pair or Σ type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(cons ${this.first.prettyPrint()} ${this.second.prettyPrint()})`}toString(){return this.prettyPrint()}}class oo extends Hi{constructor(t,e){super(t),this.location=t,this.pair=e}synthHelper(t,e){return Gi.synthCar(t,e,this.location,this.pair)}findNames(){return this.pair.findNames()}prettyPrint(){return`(car ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}}class ao extends Hi{constructor(t,e){super(t),this.location=t,this.pair=e}synthHelper(t,e){return Gi.synthCdr(t,e,this.location,this.pair)}findNames(){return this.pair.findNames()}prettyPrint(){return`(cdr ${this.pair.prettyPrint()})`}toString(){return this.prettyPrint()}}class co extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthTrivial(t,e)}findNames(){return[]}getType(t,e){return new Yn(new on)}prettyPrint(){return"Trivial"}toString(){return this.prettyPrint()}}class uo extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthSole(t,e)}findNames(){return[]}prettyPrint(){return"Sole"}}class ho extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.now();return r instanceof ye?new Yn(new en):new Kn(this.location,new Vn([`nil requires a List type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return"nil"}toString(){return this.prettyPrint()}}let lo=class extends Hi{constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){return Gi.synthNumber(t,e,this.location,this.value)}findNames(){return[]}prettyPrint(){return`${this.value}`}toString(){return this.prettyPrint()}};class po extends Hi{constructor(t,e){super(t),this.location=t,this.entryType=e}synthHelper(t,e){return Gi.synthList(t,e,this)}findNames(){return this.entryType.findNames()}getType(t,e){const n=new zn("Eout");return jn([[n,()=>this.entryType.isType(t,e)]],()=>new Yn(new nn(n.value)))}prettyPrint(){return`(List ${this.entryType.prettyPrint()})`}toString(){return this.prettyPrint()}}class fo extends Hi{constructor(t,e,n){super(t),this.location=t,this.x=e,this.xs=n}synthHelper(t,e){return Gi.synthListCons(t,e,this.x,this.xs)}findNames(){return this.x.findNames().concat(this.xs.findNames())}prettyPrint(){return`(:: ${this.x.prettyPrint()} ${this.xs.prettyPrint()})`}toString(){return this.prettyPrint()}}class yo extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.base=n,this.step=r}synthHelper(t,e){return Gi.synthRecList(t,e,this.location,this.target,this.base,this.step)}findNames(){return this.target.findNames().concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(rec-list ${this.target.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class wo extends Hi{constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.base=r,this.step=s}synthHelper(t,e){return Gi.synthIndList(t,e,this.location,this.target,this.motive,this.base,this.step)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`(ind-list ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()} \n              ${this.step.prettyPrint()})`}toString(){return this.prettyPrint()}}class mo extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){return Gi.synthAbsurd(t,e,this)}findNames(){return[]}getType(t,e){return new Yn(new cn)}prettyPrint(){return"Absurd"}toString(){return this.prettyPrint()}}class Eo extends Hi{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}synthHelper(t,e){return Gi.synthIndAbsurd(t,e,this)}findNames(){return this.target.findNames().concat(this.motive.findNames())}prettyPrint(){return`(ind-Absurd \n              ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()})`}toString(){return this.prettyPrint()}}class go extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.type=e,this.left=n,this.right=r}synthHelper(t,e){return Gi.synthEqual(t,e,this.type,this.left,this.right)}findNames(){return this.type.findNames().concat(this.left.findNames()).concat(this.right.findNames())}getType(t,e){const[n,r,s]=[this.type,this.left,this.right],i=new zn("Aout"),o=new zn("Av"),a=new zn("from_out"),c=new zn("to_out");return jn([[i,()=>n.isType(t,e)],[o,()=>new Yn(W(t,i.value))],[a,()=>r.check(t,e,o.value)],[c,()=>s.check(t,e,o.value)]],()=>new Yn(new hn(i.value,a.value,c.value)))}prettyPrint(){return`(= ${this.type.prettyPrint()} \n              ${this.left.prettyPrint()} \n              ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class To extends Hi{constructor(t,e){super(t),this.location=t,this.type=e}findNames(){return this.type.findNames()}synthHelper(t,e){throw new Error("Method not implemented.")}checkOut(t,e,n){const r=n.now();if(r instanceof Ee){const n=r.type,s=r.from,i=r.to,o=new zn("cout"),a=new zn("val");return jn([[o,()=>this.type.check(t,e,n)],[a,()=>new Yn(W(t,o.value))],[new zn("_"),()=>$i(t,this.type.location,n,s,a.value)],[new zn("_"),()=>$i(t,this.type.location,n,i,a.value)]],()=>new Yn(new ln(o.value)))}return new Kn(this.location,new Vn([`same requires an Equal type, but encounter: ${r.readBackType(t)}.`]))}prettyPrint(){return`(same ${this.type.prettyPrint()})`}toString(){return this.prettyPrint()}}class No extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.base=r}synthHelper(t,e){return Gi.synthReplace(t,e,this.location,this.target,this.motive,this.base)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames())}prettyPrint(){return`(replace ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class vo extends Hi{synthHelper(t,e){return Gi.synthTrans(t,e,this.location,this.left,this.right)}constructor(t,e,n){super(t),this.location=t,this.left=e,this.right=n}findNames(){return this.left.findNames().concat(this.right.findNames())}prettyPrint(){return`(trans ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class Io extends Hi{constructor(t,e,n){super(t),this.location=t,this.target=e,this.fun=n}synthHelper(t,e){return Gi.synthCong(t,e,this.location,this.target,this.fun)}findNames(){return this.target.findNames().concat(this.fun.findNames())}prettyPrint(){return`(cong ${this.target.prettyPrint()} ${this.fun.prettyPrint()})`}toString(){return this.prettyPrint()}}class _o extends Hi{constructor(t,e){super(t),this.location=t,this.equality=e}synthHelper(t,e){return Gi.synthSymm(t,e,this.location,this.equality)}findNames(){return this.equality.findNames()}prettyPrint(){return`(symm ${this.equality.prettyPrint()})`}toString(){return this.prettyPrint()}}class Oo extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.base=r}synthHelper(t,e){return Gi.synthIndEqual(t,e,this.location,this.target,this.motive,this.base)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.base.findNames())}prettyPrint(){return`(ind-= ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.base.prettyPrint()})`}toString(){return this.prettyPrint()}}class Po extends Hi{constructor(t,e,n){super(t),this.location=t,this.type=e,this.length=n}synthHelper(t,e){return Gi.synthVec(t,e,this.type,this.length)}findNames(){return this.type.findNames().concat(this.length.findNames())}getType(t,e){const n=new zn("Eout"),r=new zn("lenout");return jn([[n,()=>this.type.isType(t,e)],[r,()=>this.length.check(t,e,new ce)]],()=>new Yn(new mn(n.value,r.value)))}prettyPrint(){return`(Vec ${this.type.prettyPrint()} ${this.length.prettyPrint()})`}toString(){return this.prettyPrint()}}class Ao extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.now();if(r instanceof Te){return r.length.now()instanceof ue?new Yn(new gn):new Kn(this.location,new Vn([`vecnil requires a Vec type with length ZERO, but was used as a: \n          ${bt(t,new ce,r.length)}.`]))}return new Kn(this.location,new Vn([`vecnil requires a Vec type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return"vecnil"}toString(){return this.prettyPrint()}}class So extends Hi{constructor(t,e,n){super(t),this.location=t,this.x=e,this.xs=n}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.x.findNames().concat(this.xs.findNames())}checkOut(t,e,n){const r=n.now();if(r instanceof Te){const n=r.length.now();if(n instanceof he){const s=new zn("hout"),i=new zn("tout"),o=n.smaller;return jn([[s,()=>this.x.check(t,e,r.entryType)],[i,()=>this.xs.check(t,e,new Te(r.entryType,o))]],()=>new Yn(new En(s.value,i.value)))}return new Kn(this.location,new Vn([`vec:: requires a Vec type with length Add1, but was used with a: \n          ${bt(t,new ce,r.length)}.`]))}return new Kn(this.location,new Vn([`vec:: requires a Vec type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(vec:: ${this.x.prettyPrint()} ${this.xs.prettyPrint()})`}toString(){return this.prettyPrint()}}class bo extends Hi{constructor(t,e){super(t),this.location=t,this.vec=e}synthHelper(t,e){return Gi.synthHead(t,e,this.location,this.vec)}findNames(){return this.vec.findNames()}prettyPrint(){return`(head ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}}class Lo extends Hi{constructor(t,e){super(t),this.location=t,this.vec=e}synthHelper(t,e){return Gi.synthTail(t,e,this.location,this.vec)}findNames(){return this.vec.findNames()}prettyPrint(){return`(tail ${this.vec.prettyPrint()})`}toString(){return this.prettyPrint()}}class Ro extends Hi{constructor(t,e,n,r,s,i){super(t),this.location=t,this.length=e,this.target=n,this.motive=r,this.base=s,this.step=i}synthHelper(t,e){return Gi.synthIndVec(t,e,this.location,this.length,this.target,this.motive,this.base,this.step)}findNames(){return this.length.findNames().concat(this.target.findNames()).concat(this.motive.findNames()).concat(this.base.findNames()).concat(this.step.findNames())}prettyPrint(){return`ind-Vec ${this.length.prettyPrint()}\n              ${this.target.prettyPrint()}\n              ${this.motive.prettyPrint()}\n              ${this.base.prettyPrint()}\n              ${this.step.prettyPrint()}`}toString(){return this.prettyPrint()}}class xo extends Hi{constructor(t,e,n){super(t),this.location=t,this.left=e,this.right=n}synthHelper(t,e){return Gi.synthEither(t,e,this.left,this.right)}findNames(){return this.left.findNames().concat(this.right.findNames())}getType(t,e){const n=new zn("Lout"),r=new zn("Rout");return jn([[n,()=>this.left.isType(t,e)],[r,()=>this.right.isType(t,e)]],()=>new Yn(new In(n.value,r.value)))}prettyPrint(){return`(Either ${this.left.prettyPrint()} ${this.right.prettyPrint()})`}toString(){return this.prettyPrint()}}class Co extends Hi{constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.value.findNames()}checkOut(t,e,n){const r=n.now();if(r instanceof Ie){const n=new zn("lout");return jn([[n,()=>this.value.check(t,e,r.leftType)]],()=>new Yn(new _n(n.value)))}return new Kn(this.location,new Vn([`left requires an Either type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(left ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class Do extends Hi{constructor(t,e){super(t),this.location=t,this.value=e}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return this.value.findNames()}checkOut(t,e,n){const r=n.now();if(r instanceof Ie){const n=new zn("rout");return jn([[n,()=>this.value.check(t,e,r.rightType)]],()=>new Yn(new On(n.value)))}return new Kn(this.location,new Vn([`right requires an Either type, but was used as a: ${r.readBackType(t)}.`]))}prettyPrint(){return`(right ${this.value.prettyPrint()})`}toString(){return this.prettyPrint()}}class ko extends Hi{constructor(t,e,n,r,s){super(t),this.location=t,this.target=e,this.motive=n,this.baseLeft=r,this.baseRight=s}synthHelper(t,e){return Gi.synthIndEither(t,e,this.location,this.target,this.motive,this.baseLeft,this.baseRight)}findNames(){return this.target.findNames().concat(this.motive.findNames()).concat(this.baseLeft.findNames()).concat(this.baseRight.findNames())}prettyPrint(){return`(ind-Either ${this.target.prettyPrint()} \n              ${this.motive.prettyPrint()} \n              ${this.baseLeft.prettyPrint()} \n              ${this.baseRight.prettyPrint()})`}toString(){return this.prettyPrint()}}class $o extends Hi{constructor(t){super(t),this.location=t}synthHelper(t,e){throw new Error("Method not implemented.")}findNames(){return[]}checkOut(t,e,n){const r=n.readBackType(t);return xi(this.location,["TODO",Z(t),r,e]),new Yn(new An(this.location.locationToSrcLoc(),r))}prettyPrint(){return"TODO"}toString(){return this.prettyPrint()}}class Mo extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.func=e,this.arg=n,this.args=r}synthHelper(t,e){return Gi.synthApplication(t,e,this.location,this.func,this.arg,this.args)}findNames(){return this.func.findNames().concat(this.arg.findNames()).concat(this.args.flatMap(t=>t.findNames()))}prettyPrint(){return`(${this.func.prettyPrint()} ${this.arg.prettyPrint()} ${this.args.map(t=>t.prettyPrint()).join(" ")})`}toString(){return this.prettyPrint()}getType(t,e){if(this.func instanceof eo){const n=this.func.name;if(t.get(n)instanceof ht){const r=[this.arg,...this.args];return new Bo(this.location,n,[],r).getType(t,e)}}return super.getType(t,e)}checkOut(t,e,n){if(this.func instanceof eo){const r=this.func.name;if(t.get(r)instanceof lt){return new Ho(this.location,r,[this.arg,...this.args]).checkOut(t,e,n)}}return super.checkOut(t,e,n)}}class Uo extends Hi{constructor(t,e,n,r){super(t),this.location=t,this.name=e,this.paramType=n,this.indicesType=r}findNames(){throw new Error("Method not implemented.")}prettyPrint(){throw new Error("Method not implemented.")}synthHelper(t,e){throw new Error("Method not implemented.")}getType(t,e){let n=t,r=e;const s=[],i=[];for(let t=0;t<this.paramType.length;t++){const e=tr(n,this.paramType[t].binder.varName),i=this.paramType[t].type.isType(n,r);if(r=Di(r,this.paramType[t].binder.varName,e),i instanceof Kn)return i;n=ft(n,e,W(n,i.result)),s.push(i.result)}for(let t=0;t<this.indicesType.length;t++){const e=tr(n,this.indicesType[t].binder.varName),s=this.indicesType[t].type.isType(n,r);if(r=Di(r,this.indicesType[t].binder.varName,e),s instanceof Kn)return s;n=ft(n,e,W(n,s.result)),i.push(s.result)}return new Yn(new Rn(this.name,s,i))}}class Bo extends Hi{findNames(){throw new Error("Method not implemented.")}prettyPrint(){throw new Error("Method not implemented.")}synthHelper(t,e){throw new Error("Method not implemented.")}constructor(t,e,n,r){super(t),this.location=t,this.name=e,this.params=n,this.indices=r}getType(t,e){const n=st(t,this.location,this.name);if(n instanceof Kn)return n;const r=n.result.type;if(this.params.length!==r.parameterTypes.length||this.indices.length!==r.indexTypes.length)return new Kn(this.location,new Vn(["Parameter/index count mismatch for type "+this.name]));const s=[];for(let n=0;n<this.params.length;n++){const i=this.params[n].check(t,e,r.parameterTypes[n].now());if(i instanceof Kn)return i;s.push(i.result)}const i=[];for(let n=0;n<this.indices.length;n++){const s=this.indices[n].check(t,e,r.indexTypes[n].now());if(s instanceof Kn)return s;i.push(s.result)}return new Yn(new Ln(this.name,s,i))}checkOut(t,e,n){const r=n.now();if(r instanceof Ae)return this.getType(t,e);const s=[],i=[];if(!(r instanceof Ce))return new Kn(this.location,new Vn(["target type is not user defined inductive type, or use the wrong type"]));const o=r,a=o.parameterTypes,c=o.indexTypes;if(this.params.length!=a.length||this.indices.length!=c.length)return new Kn(this.location,new Vn(["the number of parameters/indices is inconsistent in constructor"]));for(let n=0;n<this.params.length;n++){const r=this.params[n].check(t,e,a[n].now());if(r instanceof Kn)return Kn;s.push(r.result)}for(let n=0;n<this.indices.length;n++){const r=this.indices[n].check(t,e,c[n].now());if(r instanceof Kn)return Kn;i.push(r.result)}return new Yn(new Ln(this.name,s,i))}}class Go extends Hi{constructor(t,e,n,r,s){super(t),this.location=t,this.typeName=e,this.target=n,this.motive=r,this.methods=s}findNames(){return[this.typeName].concat(this.target.findNames()).concat(this.motive.findNames()).concat(this.methods.flatMap(t=>t.findNames()))}prettyPrint(){const t=this.methods.map(t=>t.prettyPrint()).join(" ");return`(ind-${this.typeName} ${this.target.prettyPrint()} ${this.motive.prettyPrint()} ${t})`}synthHelper(t,e){return Gi.synthGeneralEliminator(t,e,this)}}class Ho extends Hi{constructor(t,e,n){super(t),this.location=t,this.constructorName=e,this.args=n}findNames(){return[this.constructorName].concat(this.args.flatMap(t=>t.findNames()))}prettyPrint(){const t=this.args.map(t=>t.prettyPrint()).join(" ");return`(${this.constructorName}${t.length>0?" "+t:""})`}synthHelper(t,e){throw new Error("Method not implemented.")}checkOut(t,e,n){const r=t.get(this.constructorName);if(!(r&&r instanceof lt))return new Kn(this.location,new Vn([`Unknown constructor: ${this.constructorName}`]));const s=r.constructorType,i=n.now();if(!(i instanceof xe))return new Kn(this.location,new Vn(["Expected inductive type constructor"]));const o=t.get(s.type);if(!(o&&o instanceof ht))return new Kn(this.location,new Vn([`Unknown inductive type: ${s.type}`]));const a=s.resultType;let c=t;for(let t=0;t<a.parameters.length;t++){const e=a.parameters[t];if(e instanceof bn){const n=e.name,r=i.parameters[t].now();c=dt(c,n,new Ae,r)}}for(let t=0;t<a.indices.length;t++){const e=a.indices[t];if(e instanceof bn){const n=e.name,r=i.indices[t].now();c=dt(c,n,o.type.indexTypes[t].now(),r)}}const u=r.type,h=[];u.indices.forEach(t=>{h.push(...rr(t))});const l=[],p=[],f=[...s.argTypes,...s.rec_argTypes];if(this.args.length!==f.length)return new Kn(this.location,new Vn([`Constructor ${this.constructorName} expects ${f.length} arguments, but got ${this.args.length}`]));for(let t=0;t<s.argTypes.length;t++){const n=W(c,s.argTypes[t]),r=this.args[t].check(c,e,n);if(r instanceof Kn)return r;const i=r.result;if(l.push(i),t<h.length){c=dt(c,h[t],n,W(c,i))}}const d=s.argTypes.length;for(let t=0;t<s.rec_argTypes.length;t++){const n=W(c,s.rec_argTypes[t]),r=this.args[t+d].check(c,e,n);if(r instanceof Kn)return r;const i=r.result;p.push(i);const o=d+t;if(o<h.length){c=dt(c,h[o],n,W(c,i))}}return new Yn(new xn(this.constructorName,s.index,s.type,l,p))}}function Fo(t,e){return t instanceof eo&&t.name===e||t instanceof Bo&&t.name===e}class Vo{constructor(t,e,n,r,s,i){this.location=t,this.name=e,this.parameters=n,this.indices=r,this.constructors=s,this.eliminatorName=i}normalizeConstructor(t,e){const n=new Uo(this.location,this.name,this.parameters,this.indices).isType(t,e);if(n instanceof Kn)throw new Error(n.message.toString());const r=n.result;let s=t,i=e;for(const t of this.parameters){const e=t.binder.varName,n=t.type.isType(s,i);if(n instanceof Kn)throw new Error(n.message.toString());const r=n.result,o=tr(s,e);s=ft(s,o,W(s,r)),i=Di(i,e,o)}const o=W(s,r);s=Q(s,this.name,new ht(this.name,o));const a=[];for(let t=0;t<this.constructors.length;t++)a.push(this.constructors[t].checkValid(s,i,o,t));let c=t,u=e;return c=Q(c,this.name,new ht(this.name,o)),a.forEach(t=>{const e=tr(c,t.name),n=W(s,t.resultType);c=Q(c,e,new lt(e,t,n)),u=Di(u,t.name,e)}),[c,u]}}class qo{constructor(t,e,n,r){this.location=t,this.name=e,this.args=n,this.returnType=r}checkValid(t,e,n,r){let s=t,i=e;const o=[],a=[],c=[],u=[];for(let t=0;t<this.args.length;t++){const e=this.args[t].binder.varName,n=tr(s,e),r=this.args[t].type.isType(s,i);if(r instanceof Kn)throw new Error(r.message.toString());const h=r.result;Fo(this.args[t].type,this.returnType.name)?(a.push(h),u.push(n)):(o.push(h),c.push(n)),s=ft(s,n,W(s,h)),i=Di(i,e,n)}const h=this.returnType.check(s,i,n);if(h instanceof Kn)throw new Error(h.message.toString());const l=h.result;return new Cn(this.name,r,this.returnType.name,o,a,l,c,u)}}class Yo{constructor(t){this.location=t}requiresNoBranches(){return!0}checkPendingBranches(t){return this.requiresNoBranches()&&t.pendingBranches>0?new Kn(this.location,new Vn([`Expected 'then' block to handle subgoal branch. ${t.pendingBranches} branch(es) remaining. Use (then ...) to group tactics for each subgoal.`])):new Yn(null)}}class Ko extends Yo{constructor(t,e){super(t),this.location=t,this.varName=e}getName(){return"intro"}toString(){return`intro ${this.varName||""}`}apply(t){const e=t.currentGoal.goal,n=e.type;if(!(n instanceof le))return new Kn(t.location,new Vn([`Cannot introduce a variable for non-function type: ${n.prettyPrint()}`]));const r=this.varName||n.argName||tr(e.context,"x"),s=e.renaming;r!==n.argName&&Di(s,n.argName,r);const i=Q(e.context,r,new ut(n.argType)),o=n.resultType.valOfClosure(new Pe(n.argType,new xt(r))),a=new j(new z(t.generateGoalId(),o,i,s)),c=r;return t.currentGoal.termBuilder=t=>new ze(c,t[0]),t.addGoal([a]),new Yn(t)}}class zo extends Yo{constructor(t,e){super(t),this.location=t,this.term=e}toString(){return`exact ${this.term.prettyPrint()}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.type,s=this.term.check(n.context,n.renaming,r);return s instanceof Kn?s:(t.currentGoal.goal.term=s.result,t.currentGoal.isComplete=!0,t.nextGoal(),new Yn(t))}}class jo extends Yo{constructor(t,e,n){super(t),this.location=t,this.value=e,this.varName=n}toString(){return`exists ${this.varName||""}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.type;if(!(r instanceof fe))return new Kn(t.location,new Vn([`Cannot use exists on non-product type: ${r.prettyPrint()}`]));const s=this.varName||r.carName||tr(n.context,"x"),i=n.renaming;s!==r.carName&&Di(i,r.carName,s);const o=this.value.check(n.context,n.renaming,r.carType);if(o instanceof Kn)return o;const a=o.result,c=a.valOf(rt(n.context)),u=Q(n.context,s,new ct(r.carType,c)),h=r.cdrType.valOfClosure(c);t.currentGoal.termBuilder=t=>new Qe(a,t[0]);const l=new j(new z(t.generateGoalId(),h,u,i));return t.addGoal([l]),new Yn(t)}}class Xo extends Yo{constructor(t,e){super(t),this.location=t,this.target=e}toString(){return`ind-nat ${this.target}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.context.get(this.target);if(!r)return new Kn(t.location,new Vn([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof ut))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof ce))return new Kn(t.location,new Vn([`Cannot eliminate non-Nat type: ${s.prettyPrint()}`]));const i=this.generateNatMotive(n.context,n.type,this.target),o=new le(this.target,new ce,new Qn(()=>new Ae)),a=bt(n.context,o,i),c=this.target;t.currentGoal.termBuilder=t=>new Ye(new bn(c),a,t[0],t[1]);const u=this.eliminateNat(n.context,n.renaming,i);return t.addGoal(u.map(e=>new j(new z(t.generateGoalId(),e,n.context,n.renaming)))),new Yn(t)}generateNatMotive(t,e,n){const r=e.readBackType(t),s=new Map(t);s.delete(n);const i=rt(s);return new pe(n,new Jn(i,n,r))}eliminateNat(t,e,n){return[wt(n,new ue),new le(tr(t,"n-1"),new ce,new Qn(e=>new le(tr(t,"ih"),wt(n,e),new Qn(t=>wt(n,new he(e))))))]}}class Jo extends Yo{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-list ${this.target} to prove ${this.motive.prettyPrint()}`:`ind-list ${this.target}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.context.get(this.target);if(!r)return new Kn(t.location,new Vn([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof ut))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof ye))return new Kn(t.location,new Vn([`Cannot eliminate non-List type: ${s.prettyPrint()}`]));const i=s.entryType;let o,a;const c=new le("xs",new ye(i),new Qn(t=>new Ae));if(this.motive){const t=this.motive.check(n.context,n.renaming,c);if(t instanceof Kn)return t;a=t.result,o=a.valOf(rt(n.context))}else o=this.generateListMotive(n.context,n.type,this.target),a=bt(n.context,c,o);const u=this.target;t.currentGoal.termBuilder=t=>new sn(new bn(u),a,t[0],t[1]);const h=this.eliminateList(n.context,n.renaming,o,i);return t.addGoal(h.map(e=>new j(new z(t.generateGoalId(),e,n.context,n.renaming)))),new Yn(t)}generateListMotive(t,e,n){const r=e.readBackType(t),s=new Map(t);s.delete(n);const i=rt(s);return new pe(n,new Jn(i,n,r))}eliminateList(t,e,n,r){return[wt(n,new we),new le(tr(t,"x"),r,new Qn(e=>new le(tr(t,"xs"),new ye(r),new Qn(r=>new le(tr(t,"ih"),wt(n,r),new Qn(t=>wt(n,new me(e,r))))))))]}}class Qo extends Yo{constructor(t,e,n,r){super(t),this.location=t,this.target=e,this.motive=n,this.length=r}toString(){return`ind-list ${this.target} to prove ${this.motive.prettyPrint()}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.context.get(this.target);if(!r)return new Kn(t.location,new Vn([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof ut))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof Te))return new Kn(t.location,new Vn([`Cannot eliminate non-Vec type: ${s.prettyPrint()}`]));const i=this.length.check(n.context,n.renaming,new ce);if(i instanceof Kn)return i;const[o,a]=[s.entryType,s.length];$i(n.context,this.location,new ce,W(n.context,i.result),a);const c=this.motive.check(n.context,n.renaming,new le("k",new ce,new Qn(t=>new le("es",new Te(o,t),new Qn(t=>new Ae)))));if(c instanceof Kn)return c;{const e=c.result,r=e.valOf(rt(n.context)),s=i.result,a=this.target;t.currentGoal.termBuilder=t=>new vn(s,new bn(a),e,t[0],t[1]);const u=this.eliminateVec(n.context,n.renaming,r,o);return t.addGoal(u.map(e=>new j(new z(t.generateGoalId(),e,n.context,n.renaming)))),new Yn(t)}}eliminateVec(t,e,n,r){return[wt(wt(n,new ue),new Ne),Ot(r,n)]}}class Wo extends Yo{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-equal ${this.target} with motive ${this.motive.prettyPrint()}`:`ind-equal ${this.target}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.context.get(this.target);if(!r)return new Kn(t.location,new Vn([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof ut))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof Ee))return new Kn(t.location,new Vn([`Cannot eliminate non-Equal type: ${s.prettyPrint()}`]));const[i,o]=[s.type,s.from,s.to];let a,c;if(!this.motive)return new Kn(this.location,new Vn(["Motive required for = elimination (too complex for auto-generation)"]));{const t=this.motive.check(n.context,n.renaming,new le("to",i,new Qn(t=>new le("p",new Ee(i,o,t),new Qn(t=>new Ae)))));if(t instanceof Kn)return t;c=t.result,a=c.valOf(rt(n.context))}const u=this.target;t.currentGoal.termBuilder=t=>new wn(new bn(u),c,t[0]);const h=[wt(wt(a,o),new ge(o))];return t.addGoal(h.map(e=>new j(new z(t.generateGoalId(),e,n.context,n.renaming)))),new Yn(t)}}class Zo extends Yo{constructor(t){super(t),this.location=t}toString(){return"go-Left"}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result;if(!(n.type.now()instanceof Ie))return new Kn(t.location,new Vn([`"go-Left" expected goal type to be Either, but got: ${n.type.prettyPrint()}`]));const r=n.type.leftType.now();return t.currentGoal.termBuilder=t=>new _n(t[0]),t.addGoal([new j(new z(t.generateGoalId(),r,n.context,n.renaming))]),new Yn(t)}}class ta extends Yo{constructor(t){super(t),this.location=t}toString(){return"go-Right"}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result;if(!(n.type.now()instanceof Ie))return new Kn(t.location,new Vn([`"go-Right" expected goal type to be Either, but got: ${n.type.prettyPrint()}`]));const r=n.type.rightType.now();return t.currentGoal.termBuilder=t=>new On(t[0]),t.addGoal([new j(new z(t.generateGoalId(),r,n.context,n.renaming))]),new Yn(t)}}class ea extends Yo{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-Either ${this.target} with motive ${this.motive.prettyPrint()}`:`ind-Either ${this.target}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.context.get(this.target);if(!r)return new Kn(t.location,new Vn([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof ut))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof Ie))return new Kn(t.location,new Vn([`Cannot eliminate non-Either type: ${s.prettyPrint()}`]));const[i,o]=[s.leftType,s.rightType];let a,c;const u=new le("x",new Ie(i,o),new Qn(t=>new Ae));if(this.motive){const t=this.motive.check(n.context,n.renaming,u);if(t instanceof Kn)return t;c=t.result,a=c.valOf(rt(n.context))}else a=this.generateEitherMotive(n.context,n.type,this.target),c=bt(n.context,u,a);const h=this.target;t.currentGoal.termBuilder=t=>new Pn(new bn(h),c,t[0],t[1]);const l=new le("x",i,new Qn(t=>wt(a,new _e(t)))),p=new le("x",o,new Qn(t=>wt(a,new Oe(t))));return t.addGoal([new j(new z(t.generateGoalId(),l,n.context,n.renaming)),new j(new z(t.generateGoalId(),p,n.context,n.renaming))]),new Yn(t)}generateEitherMotive(t,e,n){const r=e.readBackType(t),s=new Map(t);s.delete(n);const i=rt(s);return new pe(n,new Jn(i,n,r))}}class na extends Yo{constructor(t){super(t)}toString(){return"split-Pair"}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result;if(!(n.type.now()instanceof fe))return new Kn(t.location,new Vn([`"split-Pair" expected goal type to be Sigma, but got: ${n.type.prettyPrint()}`]));const r=n.type.now(),s=r.carType.now(),i=r.cdrType.valOfClosure(r);return t.currentGoal.termBuilder=t=>new Qe(t[0],t[1]),t.addGoal([new j(new z(t.generateGoalId(),s,n.context,n.renaming)),new j(new z(t.generateGoalId(),i,n.context,n.renaming))]),new Yn(t)}}class ra extends Yo{constructor(t,e,n){super(t),this.location=t,this.target=e,this.motive=n}toString(){return this.motive?`ind-Absurd ${this.target} with motive ${this.motive.prettyPrint()}`:`ind-Absurd ${this.target}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.context.get(this.target);if(!r)return new Kn(t.location,new Vn([`target not found in current context: ${this.target}`]));let s;if(!(r instanceof ut))throw new Error("Expected target to be a free variable");if(s=r.type.now(),!(s instanceof Re))return new Kn(t.location,new Vn([`Cannot eliminate non-Absurd type: ${s.prettyPrint()}`]));const i=n.type.readBackType(n.context),o=this.target;if(this.motive){const t=this.motive.check(n.context,n.renaming,new Ae);if(t instanceof Kn)return t}return t.currentGoal.goal.term=new un(new bn(o),i),t.currentGoal.isComplete=!0,t.nextGoal(),new Yn(t)}}class sa extends Yo{constructor(t,e){super(t),this.location=t,this.tactics=e}requiresNoBranches(){return!1}toString(){return`then (${this.tactics.map(t=>t.toString()).join(", ")})`}apply(t){t.pendingBranches>0&&t.pendingBranches--;const e=t.pendingBranches;t.pendingBranches=0;for(const e of this.tactics){const n=e.apply(t);if(n instanceof Kn)return n;t=n.result}return t.pendingBranches=e,0===t.pendingBranches&&t.nextGoal(),new Yn(t)}}class ia extends Yo{constructor(t,e){super(t),this.location=t,this.funcExpr=e}toString(){return`apply ${this.funcExpr.prettyPrint()}`}apply(t){const e=this.checkPendingBranches(t);if(e instanceof Kn)return e;const n=t.getCurrentGoal().result,r=n.type,s=this.funcExpr.synth(n.context,n.renaming);if(s instanceof Kn)return s;const i=s.result,o=i.expr,a=i.type.valOf(rt(n.context));if(!(a instanceof le))return new Kn(this.location,new Vn([`Cannot apply non-function type: ${a.prettyPrint()}`]));const c=a.argType,u=new Pe(c,new xt(tr(n.context,"x"))),h=a.resultType.valOfClosure(u);try{$i(n.context,this.location,new Ae,h,r)}catch{return new Kn(this.location,new Vn([`Function result type ${h.prettyPrint()} does not match goal type ${r.prettyPrint()}`]))}t.currentGoal.termBuilder=t=>new Sn(o,t[0]);const l=new j(new z(t.generateGoalId(),c,n.context,n.renaming));return t.addGoal([l]),new Yn(t)}}function oa(t,e){return[t,...e]}function aa(t,e,n,r){return new Mo(ua(t),e,n,r)}function ca(t,e,n,r){return new Bo(ua(t),e,n,r)}function ua(t){return new Y(t,!0)}function ha(t){return new Hn(ua(t),t.source)}function la(t){if(t instanceof B.Symbol)return t.value;if(t instanceof B.NumericLiteral)return t.value;if(t instanceof G.List)return la(t.elements[0]);if(t instanceof B.Nil)return"()";throw new Error("Unexpected element type in getValue: "+t)}function pa(t,e){return new q(e.start,e.end,t)}function fa(t,e){return pa(la(t),e)}function da(t){const e=new U(t);return new F("",e.scanTokens()).parse()}class ya{static parsePie(t){return ya.parseElements(da(t)[0])}static parseElements(t){const e=la(t);if("U"===e)return n=pa("U",t.location),new Vi(ua(n));if("the"===e){const e=t.elements;return function(t,e,n){return new Fi(ua(t),e,n)}(pa("the",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("Nat"===e)return function(t){return new qi(ua(t))}(pa("Nat",t.location));if("zero"===e)return function(t){return new Yi(ua(t))}(pa("zero",t.location));if("add1"===e)return function(t,e){return new Ki(ua(t),e)}(pa("add1",t.location),this.parseElements(t.elements[1]));if("->"===e||"→"===e){const e=t.elements;return function(t,e){return new Qi(ua(t),e[0],e[1],e[2])}(pa("->",t.location),[this.parseElements(e[1]),this.parseElements(e[2]),e.slice(3).map(t=>this.parseElements(t))])}if("lambda"===e||"λ"===e){const e=t.elements,n=t.location,r=e[1],s=e[2];return function(t,e,n){return new Zi(ua(t),e,n)}(pa("λ",n),r.elements.map(e=>ha(fa(e,t.location))),this.parseElements(s))}if("Pi"===e||"Π"===e){const e=t.elements,n=e[1],r=e[2],s=n.elements[0],i=s.elements[0],o=s.elements[1],a=n.elements.slice(1).map(t=>{const e=t.elements[0],n=t.elements[1];return new Fn(ha(fa(e,t.location)),this.parseElements(n))});return function(t,e,n){return new Wi(ua(t),e,n)}(pa("Π",t.location),oa(new Fn(ha(fa(i,s.location)),this.parseElements(o)),a),this.parseElements(r))}if("Sigma"===e||"Σ"===e){const e=t.elements,n=e[1],r=e[2],s=n.elements[0],i=s.elements[0],o=s.elements[1],a=n.elements.slice(1).map(t=>{const e=t.elements[0],n=t.elements[1];return new Fn(ha(fa(e,t.location)),this.parseElements(n))});return function(t,e,n){return new to(ua(t),e,n)}(pa("Π",t.location),oa(new Fn(ha(fa(i,s.location)),this.parseElements(o)),a),this.parseElements(r))}if("Pair"===e){const e=t.elements;return function(t,e,n){return new so(ua(t),e,n)}(pa("Pair",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("cons"===e){const e=t.elements;return function(t,e,n){return new io(ua(t),e,n)}(pa("Cons",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("car"===e)return function(t,e){return new oo(ua(t),e)}(pa("car",t.location),this.parseElements(t.elements[1]));if("cdr"===e)return function(t,e){return new ao(ua(t),e)}(pa("cdr",t.location),this.parseElements(t.elements[1]));if("which-Nat"===e){const e=t.elements;return function(t,e,n,r){return new zi(ua(t),e,n,r)}(pa("which-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("iter-Nat"===e){const e=t.elements;return function(t,e,n,r){return new ji(ua(t),e,n,r)}(pa("iter-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("rec-Nat"===e){const e=t.elements;return function(t,e,n,r){return new Xi(ua(t),e,n,r)}(pa("rec-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("ind-Nat"===e){const e=t.elements;return function(t,e,n,r,s){return new Ji(ua(t),e,n,r,s)}(pa("ind-Nat",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("Atom"===e)return function(t){return new no(ua(t))}(pa("Atom",t.location));if("quote"===e)return function(t,e){return new ro(ua(t),e)}(pa("Quote",t.location),la(t.elements[1]));if("Trivial"===e)return function(t){return new co(ua(t))}(pa("Trivial",t.location));if("sole"===e)return function(t){return new uo(ua(t))}(pa("sole",t.location));if("List"===e)return function(t,e){return new po(ua(t),e)}(pa("List",t.location),this.parseElements(t.elements[1]));if("nil"===e)return function(t){return new ho(ua(t))}(pa("nil",t.location));if("::"===e){const e=t.elements;return function(t,e,n){return new fo(ua(t),e,n)}(pa("::",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("rec-List"===e){const e=t.elements;return function(t,e,n,r){return new yo(ua(t),e,n,r)}(pa("rec-List",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("ind-List"===e){const e=t.elements;return function(t,e,n,r,s){return new wo(ua(t),e,n,r,s)}(pa("ind-List",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("="===e){const e=t.elements;return function(t,e,n,r){return new go(ua(t),e,n,r)}(pa("=",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("same"===e)return function(t,e){return new To(ua(t),e)}(pa("same",t.location),this.parseElements(t.elements[1]));if("replace"===e){const e=t.elements;return function(t,e,n,r){return new No(ua(t),e,n,r)}(pa("replace",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("trans"===e){const e=t.elements;return function(t,e,n){return new vo(ua(t),e,n)}(pa("trans",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("cong"===e){const e=t.elements;return function(t,e,n){return new Io(ua(t),e,n)}(pa("cong",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("ind-="===e){const e=t.elements;return function(t,e,n,r){return new Oo(ua(t),e,n,r)}(pa("ind-=",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]))}if("symm"===e)return function(t,e){return new _o(ua(t),e)}(pa("symm",t.location),this.parseElements(t.elements[1]));if("Vec"===e){const e=t.elements;return function(t,e,n){return new Po(ua(t),e,n)}(pa("Vec",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("vecnil"===e)return function(t){return new Ao(ua(t))}(pa("vecnil",t.location));if("vec::"===e){const e=t.elements;return function(t,e,n){return new So(ua(t),e,n)}(pa("vec::",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("head"===e)return function(t,e){return new bo(ua(t),e)}(pa("head",t.location),this.parseElements(t.elements[1]));if("tail"===e)return function(t,e){return new Lo(ua(t),e)}(pa("tail",t.location),this.parseElements(t.elements[1]));if("ind-Vec"===e){const e=t.elements;return function(t,e,n,r,s,i){return new Ro(ua(t),e,n,r,s,i)}(pa("ind-Vec",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]),this.parseElements(e[5]))}if("Either"===e){const e=t.elements;return function(t,e,n){return new xo(ua(t),e,n)}(pa("Either",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("left"===e)return function(t,e){return new Co(ua(t),e)}(pa("left",t.location),this.parseElements(t.elements[1]));if("right"===e)return function(t,e){return new Do(ua(t),e)}(pa("right",t.location),this.parseElements(t.elements[1]));if("ind-Either"===e){const e=t.elements;return function(t,e,n,r,s){return new ko(ua(t),e,n,r,s)}(pa("ind-Either",t.location),this.parseElements(e[1]),this.parseElements(e[2]),this.parseElements(e[3]),this.parseElements(e[4]))}if("Absurd"===e)return function(t){return new mo(ua(t))}(pa("Absurd",t.location));if("ind-Absurd"===e){const e=t.elements;return function(t,e,n){return new Eo(ua(t),e,n)}(pa("ind-Absurd",t.location),this.parseElements(e[1]),this.parseElements(e[2]))}if("TODO"===e)return function(t){return new $o(ua(t))}(pa("TODO",t.location));if(e.startsWith("ind-")&&t instanceof G.List&&t.elements[0]instanceof B.Symbol){const n=e.substring(4),r=t.elements;if(r.length<3)throw new Error(`Eliminator ${e} requires at least target and motive`);const s=this.parseElements(r[1]),i=this.parseElements(r[2]),o=r.slice(3).map(t=>this.parseElements(t));return function(t,e,n,r,s){return new Go(ua(t),e,n,r,s)}(pa(e,t.location),n,s,i,o)}if(t instanceof G.List&&t.elements.length>=3){const e=t.elements,n=e[0];if(n instanceof B.Symbol){const r=n.value;if(r&&r[0]===r[0].toUpperCase()&&r[0]!==r[0].toLowerCase()&&3===e.length){const n=e[1],s=e[2];if((n instanceof G.List||n instanceof B.Nil)&&(s instanceof G.List||s instanceof B.Nil)){let e=[];n instanceof G.List&&(e=(n.elements||[]).map(t=>this.parseElements(t)));let i=[];return s instanceof G.List&&(i=(s.elements||[]).map(t=>this.parseElements(t))),ca(pa(r,t.location),r,e,i)}}}return aa(pa("App",t.location),this.parseElements(e[0]),this.parseElements(e[1]),e.slice(2).map(t=>this.parseElements(t)))}if(t instanceof G.List&&t.elements.length>1){const e=t.elements;return aa(pa("App",t.location),this.parseElements(e[0]),this.parseElements(e[1]),e.slice(2).map(t=>this.parseElements(t)))}if(t instanceof G.List&&1===t.elements.length){const e=la(t.elements[0]);return function(t,e,n){return new Ho(ua(t),e,n)}(pa(e,t.location),e,[])}if(Wn(e))return function(t,e){return new eo(ua(t),e)}(pa(e,t.location),e);if(!isNaN(Number(e)))return function(t,e){return new lo(ua(t),Number(e))}(pa(e,t.location),e);var n;throw new Error("Unexpected element: "+t)}static parseToTactics(t){const e=la(t);if("exact"===e)return n=pa("exact",t.location),r=this.parseElements(t.elements[1]),new zo(ua(n),r);if("intro"===e)return function(t,e){return new Ko(ua(t),e)}(pa("intro",t.location),t.elements[1].value);if("exists"===e)return function(t,e,n){return new jo(ua(t),e,n)}(pa("exists",t.location),this.parseElements(t.elements[1]),t.elements[2].value);if("elim-Nat"===e)return function(t,e){return new Xo(ua(t),e)}(pa("elim-Nat",t.location),t.elements[1].value);if("elim-List"===e){const e=t;return function(t,e,n){return new Jo(ua(t),e,n)}(pa("elim-List",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("elim-Vec"===e)return function(t,e,n,r){return new Qo(ua(t),e,n,r)}(pa("elim-Vec",t.location),t.elements[1].value,this.parseElements(t.elements[2]),this.parseElements(t.elements[3]));if("elim-Equal"===e){const e=t;return function(t,e,n){return new Wo(ua(t),e,n)}(pa("elim-Equal",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("go-Left"===e)return function(t){return new Zo(ua(t))}(pa("go-Left",t.location));if("go-Right"===e)return function(t){return new ta(ua(t))}(pa("go-Right",t.location));if("elim-Either"===e){const e=t;return function(t,e,n){return new ea(ua(t),e,n)}(pa("elim-Either",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("split-Pair"===e)return function(t){return new na(ua(t))}(pa("split-Pair",t.location));if("elim-Absurd"===e){const e=t;return function(t,e,n){return new ra(ua(t),e,n)}(pa("elim-Absurd",t.location),e.elements[1].value,e.elements[2]?this.parseElements(e.elements[2]):void 0)}if("then"===e){const e=t.elements.slice(1).map(t=>this.parseToTactics(t));return function(t,e){return new sa(ua(t),e)}(pa("then",t.location),e)}if("apply"===e)return function(t,e){return new ia(ua(t),e)}(pa("apply",t.location),this.parseElements(t.elements[1]));var n,r;throw new Error("Unexpected tactic: "+t)}}class wa{constructor(t,e,n){this.location=t,this.name=e,this.type=n}}class ma{constructor(t,e,n){this.location=t,this.name=e,this.expr=n}}class Ea{constructor(t,e,n,r){this.location=t,this.type=e,this.left=n,this.right=r}}class ga{constructor(t,e,n){this.location=t,this.name=e,this.tactics=n}}class Ta{static parseDeclaration(t){const e=la(t);if("claim"===e){const e=t.elements,n=la(e[1]);if(!Wn(n))throw new Error(`'${n}' is a keyword and cannot be used as a variable name`);return new wa(ua(fa(e[0],t.location)),n,ya.parseElements(e[2]))}if("define"===e){const e=t.elements,n=la(e[1]);if(!Wn(n))throw new Error(`'${n}' is a keyword and cannot be used as a variable name`);return new ma(ua(fa(e[0],t.location)),n,ya.parseElements(e[2]))}if("check-same"===e){const e=t.elements;return new Ea(ua(fa(e[0],t.location)),ya.parseElements(e[1]),ya.parseElements(e[2]),ya.parseElements(e[3]))}if("define-tactically"===e){const e=t.elements,n=la(e[1]);if(!Wn(n))throw new Error(`'${n}' is a keyword and cannot be used as a variable name`);return new ga(ua(fa(e[0],t.location)),n,e[2].elements.map(t=>ya.parseToTactics(t)))}if("data"===e){const e=t.elements,n=t.location,r=la(e[1]),s=e[2].elements||[],i=e[3].elements||[],o=s.map(t=>{const e=t;return new Fn(ha(fa(e.elements[0],e.location)),ya.parseElements(e.elements[1]))}),a=i.map(t=>{const e=t;return new Fn(ha(fa(e.elements[0],e.location)),ya.parseElements(e.elements[1]))}),c=e[e.length-1],u=c instanceof B.Symbol,h=u?e.length-1:e.length,l=u?la(c):void 0,p=[];for(let t=4;t<h;t++){const n=e[t],r=la(n.elements[0]),s=n.elements[1];let i=[];s instanceof G.List?i=s.elements||[]:s instanceof B.Nil&&(i=[]);const o=n.elements[2],a=i.map(t=>{const e=t,n=e.elements[1],r=ya.parseElements(n);return new Fn(ha(fa(e.elements[0],e.location)),r)}),c=o,u=la(c.elements[0]);if(c.elements.length<3)throw new Error(`Constructor return type must specify parameters and indices: (${u} (params...) (indices...))`);const h=c.elements[1];let l=[];h instanceof G.List?l=(h.elements||[]).map(t=>ya.parseElements(t)):h instanceof B.Nil&&(l=[]);const f=c.elements[2];let d=[];f instanceof G.List?d=(f.elements||[]).map(t=>ya.parseElements(t)):f instanceof B.Nil&&(d=[]);const y=ca(fa(c.elements[0],c.location),u,l,d);p.push(new qo(ua(fa(n.elements[0],n.location)),r,a,y))}return new Vo(ua(fa(e[0],n)),r,o,a,p,l)}return ya.parseElements(t)}}function Na(t){return t.prettyPrint()}function va(t){if(!t.trim())return{diagnostics:[],summary:"Waiting for input…"};const e=[],n=function(t){return new Map(t)}(it);let r="";try{const s=da(t);for(const t of s){const s=Ia(n,Ta.parseDeclaration(t));if(s.diagnostic){e.push(s.diagnostic);break}s.message&&(r+=s.message)}}catch(t){e.push(Oa(t))}const s=0===e.length?"No issues detected.":e.some(t=>"error"===t.severity)?"Errors detected.":"Warnings detected.";let i;if(0===e.length){const t=function(t){const e=[];for(const[n,r]of t)if(r instanceof ct){const s=Na(r.type.readBackType(t)),i=Na(bt(t,r.type,r.value));e.push(`${n} : ${s}`),e.push(`${n} = ${i}`)}else if(r.type){const s=Na(r.type.readBackType(t));e.push(`${n} : ${s}`)}return e.join("\n")}(n);i=r?r+"\n"+t:t}return{diagnostics:e,summary:s,pretty:i,messages:r||void 0}}function Ia(t,e){try{if(e instanceof wa){const n=tt(t,e.name,e.location,e.type);return n instanceof Yn?(Sa(t,n.result),{diagnostic:null}):{diagnostic:_a(n)}}if(e instanceof ma){const n=nt(t,e.name,e.location,e.expr);return n instanceof Yn?(Sa(t,n.result),{diagnostic:null}):{diagnostic:_a(n)}}if(e instanceof Ea){const n=function(t,e,n,r,s){const i=new zn("tOut"),o=new zn("tv"),a=new zn("aOut"),c=new zn("bOut"),u=new zn("av"),h=new zn("bv");return jn([[i,()=>n.isType(t,new Map)],[o,()=>new Yn(W(t,i.value))],[a,()=>r.check(t,new Map,o.value)],[c,()=>s.check(t,new Map,o.value)],[u,()=>new Yn(W(t,a.value))],[h,()=>new Yn(W(t,c.value))]],()=>$i(t,e,o.value,u.value,h.value))}(t,e.location,e.type,e.left,e.right);return n instanceof Yn?{diagnostic:null}:{diagnostic:_a(n)}}if(e instanceof ga){const n=function(t,e,n,r,s=!1){const i=new J;let o="";const a=i.startProof(e,t,n);if(a instanceof Kn)return a;s&&(o+=a.result+"\n");for(const t of r){const e=i.applyTactic(t);if(e instanceof Kn)return e;s&&(o+=e.result)}if(!i.currentState||!i.currentState.isComplete()){const t=i.currentState?.getCurrentGoal();let e="";return t instanceof Yn&&(e=`\n\n${t.result.prettyPrintWithContext()}`),new Kn(n,new Vn([`Proof incomplete. Not all goals have been solved.${e}`]))}const c=t.get(e);if(!(c instanceof at))return new Kn(n,new Vn([`${e} is not a valid claim`]));const u=c.type,h=i.currentState?.goalTree,l=h?.extractTerm();if(l){const n=W(t,l),r=dt(et(t,e),e,u,n);return new Yn({context:r,message:o})}return i.currentState.isComplete()?new Kn(n,new Vn([`Failed to extract proof term for '${e}'.`])):new Kn(n,new Vn([`Proof incomplete. Cannot extract proof term for '${e}'.`]))}(t,e.name,e.location,e.tactics);return n instanceof Yn?(Sa(t,n.result.context),{diagnostic:null,message:n.result.message}):{diagnostic:_a(n)}}if(e instanceof Vo){const n=function(t,e,n){if(t.has(n.name))return new Kn(n.location,new Vn([`Name already in use: ${n.name}`]));const[r]=n.normalizeConstructor(t,e);return new Yn(r)}(t,new Map,e);return n instanceof Yn?(Sa(t,n.result),{diagnostic:null}):{diagnostic:_a(n)}}{const n=function(t,e){const n=new zn("outmeta");return jn([[n,()=>e.synth(t,new Map)]],()=>{const e=W(t,n.value.type),r=W(t,n.value.expr);return new Yn(new Me(e.readBackType(t),bt(t,e,r)))})}(t,e);return n instanceof Yn?{diagnostic:null}:{diagnostic:_a(n)}}}catch(t){return{diagnostic:Oa(t)}}}function _a(t){const e=t.where.locationToSrcLoc();return{message:(n=t.message,n.message.map(t=>"string"==typeof t?t:t.prettyPrint()).join(" ")),startLineNumber:e.startLine,startColumn:Math.max(1,e.startColumn),endLineNumber:e.endLine??e.startLine,endColumn:Math.max(e.endColumn??e.startColumn+1,e.startColumn+1),severity:"error"};var n}function Oa(t){if(t instanceof Error){const e=t.message||"Unknown error",n=function(t){const e=/Error message: (.*) at (.*):(\d+):(\d+)/s.exec(t);if(e){const[,t,,n,r]=e;return{message:Aa(t),startLineNumber:Number(n),startColumn:Number(r),endLineNumber:Number(n),endColumn:Number(r)+1,severity:"error"}}const n=/(.*):(\d+):(\d+)(.*)/s.exec(t);if(n){const[,,e,r,s]=n;return{message:Aa(t.replace(/^[^:]+:\d+:\d+/,"").trim()||s||"Error"),startLineNumber:Number(e),startColumn:Number(r),endLineNumber:Number(e),endColumn:Number(r)+1,severity:"error"}}return null}(e);return n??Pa(e)}return Pa("string"==typeof t?t:"Unknown error")}function Pa(t){return{message:Aa(t),startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:2,severity:"error"}}function Aa(t){return t.replace(/^\[|\]$/g,"").replace(/\s+/g," ").trim()}function Sa(t,e){t.clear();for(const[n,r]of e)t.set(n,r)}export{va as analyzePieSource};
//# sourceMappingURL=pie-worker-bundle.js.map
