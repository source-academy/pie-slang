{"version":3,"file":"app-bundle.js","sources":["lsp/lsp-client-bundle.js","app.js"],"sourcesContent":["class e{constructor(e,t){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.debouncedContextInfo=null,this.diagnostics=[],this.contextInfoCallback=null,this.monaco=e,this.editor=t}setContextInfoCallback(e){this.contextInfoCallback=e}async start(){this.worker=new Worker(\"lsp/pie-lsp-worker-bundle.js\"),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error(\"LSP Worker error:\",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce(()=>{if(!this.worker)return;const t=e.getValue();this.worker.postMessage({type:\"validate\",source:t})},220),this.debouncedContextInfo=this.debounce(()=>{this.requestContextInfo()},100);const t=this.editor?.onDidChangeModelContent?.(()=>{this.debouncedValidate&&this.debouncedValidate(),this.debouncedContextInfo&&this.debouncedContextInfo()});t&&this.disposables.push(t);const n=this.editor?.onDidChangeCursorPosition?.(()=>{this.debouncedContextInfo&&this.debouncedContextInfo()});n&&this.disposables.push(n);const i=this.monaco.languages.registerHoverProvider(\"pie\",{provideHover:(e,t)=>this.provideHover(e,t)});this.disposables.push(i);const s=this.monaco.languages.registerCompletionItemProvider(\"pie\",{provideCompletionItems:(e,t)=>this.provideCompletionItems(e,t)});this.disposables.push(s);const o=this.monaco.languages.registerDefinitionProvider(\"pie\",{provideDefinition:(e,t)=>this.provideDefinition(e,t)});this.disposables.push(o),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach(e=>{e&&\"function\"==typeof e.dispose&&e.dispose()}),this.disposables=[],this.debouncedValidate=null,this.debouncedContextInfo=null,this.diagnostics=[],this.contextInfoCallback=null,this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&(\"validation-result\"===e.type?this.updateDiagnostics(e.diagnostics??[]):\"validation-error\"===e.type?this.updateDiagnostics([{severity:\"error\",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]):\"context-info-result\"===e.type&&this.contextInfoCallback&&this.contextInfoCallback(e.contextLines,e.inTacticalProof,e.proofInfo))}requestContextInfo(){if(!this.worker)return;const e=this.editor?.getModel?.(),t=this.editor?.getPosition?.();if(!e||!t)return;const n=e.getValue();this.worker.postMessage({type:\"context-info\",source:n,line:t.lineNumber-1,column:t.column-1})}updateDiagnostics(e){this.diagnostics=e;const t=this.editor?.getModel?.();if(!t)return;const n=e.map(e=>{const t=this.ensurePositiveNumber(e.startLine,1),n=this.ensurePositiveNumber(e.endLine,t),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:t,startColumn:i,endLineNumber:n,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:\"warning\"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}});this.monaco.editor.setModelMarkers(t,\"pie-lsp\",n)}async provideHover(e,t){if(!this.worker)return null;const n=this.diagnostics.find(e=>{const n=this.ensurePositiveNumber(e.startLine,t.lineNumber),i=this.ensurePositiveNumber(e.endLine,n),s=this.ensurePositiveNumber(e.startColumn,1),o=this.ensurePositiveNumber(e.endColumn,s+1);return!(t.lineNumber<n||t.lineNumber>i)&&(!(t.lineNumber===n&&t.column<s)&&!(t.lineNumber===i&&t.column>o))});if(n){const e=this.ensurePositiveNumber(n.startLine,t.lineNumber),i=this.ensurePositiveNumber(n.endLine,e),s=this.ensurePositiveNumber(n.startColumn,1),o=this.ensurePositiveNumber(n.endColumn,s+1);return{contents:[{value:`**${\"warning\"===n.severity?\"Warning\":\"Error\"}**\\n\\n${n.message}`}],range:{startLineNumber:e,startColumn:s,endLineNumber:i,endColumn:o}}}return new Promise(n=>{const i=e=>{const t=e.data;if(\"hover-result\"===t.type){if(this.worker?.removeEventListener(\"message\",i),!t.hoverInfo)return void n(null);const e=t.hoverInfo;let s=`**${e.title}**\\n\\n${e.summary}`;e.details&&(s+=`\\n\\n${e.details}`),e.examples&&(s+=`\\n\\n**Examples:**\\n\\`\\`\\`pie\\n${e.examples}\\n\\`\\`\\``),n({contents:[{value:s}]})}};if(this.worker){this.worker.addEventListener(\"message\",i);const n=e.getValue();this.worker.postMessage({type:\"hover\",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener(\"message\",i),n(null)},1e3)})}async provideCompletionItems(e,t){return this.worker?new Promise(n=>{const i=e=>{const s=e.data;if(\"completion-result\"===s.type){this.worker?.removeEventListener(\"message\",i);const e=s.wordRange,o=e?{startLineNumber:t.lineNumber,startColumn:e.start+1,endLineNumber:t.lineNumber,endColumn:e.end+1}:{startLineNumber:t.lineNumber,startColumn:t.column,endLineNumber:t.lineNumber,endColumn:t.column},r=s.completions.map(e=>{let t=this.monaco.languages.CompletionItemKind.Text;switch(e.kind){case\"Keyword\":t=this.monaco.languages.CompletionItemKind.Keyword;break;case\"Function\":t=this.monaco.languages.CompletionItemKind.Function;break;case\"Variable\":t=this.monaco.languages.CompletionItemKind.Variable;break;case\"TypeParameter\":t=this.monaco.languages.CompletionItemKind.Class;break;case\"Value\":t=this.monaco.languages.CompletionItemKind.Value;break;case\"Snippet\":t=this.monaco.languages.CompletionItemKind.Snippet}return{label:e.label,kind:t,detail:e.detail,insertText:e.label,range:o}});n({suggestions:r})}};if(this.worker){this.worker.addEventListener(\"message\",i);const n=e.getValue();this.worker.postMessage({type:\"completion\",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener(\"message\",i),n({suggestions:[]})},1e3)}):{suggestions:[]}}async provideDefinition(e,t){return this.worker?new Promise(n=>{const i=t=>{const s=t.data;\"definition-result\"===s.type&&(this.worker?.removeEventListener(\"message\",i),s.location?n({uri:e.uri,range:{startLineNumber:s.location.line+1,startColumn:s.location.startColumn+1,endLineNumber:s.location.line+1,endColumn:s.location.endColumn+1}}):n(null))};if(this.worker){this.worker.addEventListener(\"message\",i);const n=e.getValue();this.worker.postMessage({type:\"definition\",source:n,line:t.lineNumber-1,column:t.column-1})}setTimeout(()=>{this.worker?.removeEventListener(\"message\",i),n(null)},1e3)}):null}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,\"pie-lsp\",[])}ensurePositiveNumber(e,t){return\"number\"!=typeof e||Number.isNaN(e)||e<1?t:e}debounce(e,t){let n=null;return()=>{null!==n&&window.clearTimeout(n),n=window.setTimeout(()=>{n=null,e()},t)}}}const t=e=>e.replace(/\\s+/g,\" \").replace(/\\(\\s+/g,\"(\").replace(/\\s+\\)/g,\")\"),n=e=>{const n=e.split(\"\\n\");let i=!1;const s=[];for(const e of n){const t=e.trim();\"\"===t?(i||s.push(\"\"),i=!0):(s.push(t),i=!1)}let o=0;return s.map(t).flatMap(e=>{const t=(e.match(/\\(/g)||[]).length,n=(e.match(/\\)/g)||[]).length,i=\" \".repeat(2*o)+e;return o+=t-n,i}).join(\"\\n\")};function i(e){e.languages.register({id:\"pie\"}),e.languages.setLanguageConfiguration(\"pie\",{comments:{lineComment:\";\",blockComment:[\"#|\",\"|#\"]},brackets:[[\"(\",\")\"]],autoClosingPairs:[{open:\"(\",close:\")\"}],surroundingPairs:[{open:\"(\",close:\")\"}],indentationRules:{increaseIndentPattern:/^\\s*\\(.*[^)]$/,decreaseIndentPattern:/^\\s*\\)/},onEnterRules:[{beforeText:/^\\s*\\(.*[^)]$/,action:{indentAction:e.languages.IndentAction.Indent}},{beforeText:/^\\s*\\(.*$/,afterText:/^\\s*\\)/,action:{indentAction:e.languages.IndentAction.IndentOutdent}},{beforeText:/^.*$/,afterText:/^\\s*\\)/,action:{indentAction:e.languages.IndentAction.Outdent}}]}),e.languages.registerDocumentFormattingEditProvider(\"pie\",{provideDocumentFormattingEdits:e=>[{range:e.getFullModelRange(),text:n(e.getValue())}]}),e.languages.registerDocumentRangeFormattingEditProvider(\"pie\",{provideDocumentRangeFormattingEdits:(e,t)=>[{range:t,text:n(e.getValueInRange(t))}]}),e.languages.setMonarchTokensProvider(\"pie\",{defaultToken:\"\",tokenPostfix:\".pie\",keywords:[\"lambda\",\"λ\",\"Pi\",\"Π\",\"Sigma\",\"Σ\",\"define\",\"claim\",\"the\",\"check-same\",\"define-tactically\",\"TODO\",\"U\",\"Nat\",\"Atom\",\"List\",\"Vec\",\"Either\",\"zero\",\"add1\",\"nil\",\"cons\",\"car\",\"cdr\",\"ind-Nat\",\"rec-Nat\",\"iter-Nat\",\"ind-List\",\"rec-List\",\"ind-Vec\",\"rec-Vec\",\"ind-=\",\"replace\",\"trans\",\"cong\",\"symm\",\"same\",\"left\",\"right\",\"ind-Either\",\"vecnil\",\"vec::\",\"which-Nat\",\"quote\",\"Pair\",\"Trivial\",\"sole\",\"::\",\"Absurd\",\"ind-Absurd\",\"=\",\"head\",\"tail\",\"Either\",\"->\",\"→\",\"exact\",\"intro\",\"exists\",\"elim-Nat\",\"elim-List\",\"elim-Vec\",\"elim-Equal\",\"elim-Either\",\"elim-Absurd\",\"split-Pair\",\"then\",\"apply\",\"go-Left\",\"go-Right\"],operators:[],symbols:/[=><!~?:&|+\\-*/^%]+/,tokenizer:{root:[{include:\"@whitespace\"},[/\\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\\b/,\"keyword\"],[/[a-zA-Z][a-zA-Z0-9\\-_!?*+=<>λΠΣ→]*/,{cases:{\"@keywords\":\"keyword\",\"@default\":\"identifier\"}}],[/\\d+/,\"number\"],[/\"([^\"\\\\]|\\\\.)*$/,\"string.invalid\"],[/\"/,\"string\",\"@string\"],[/'[a-zA-Z][a-zA-Z0-9\\-_!?*+=<>]*/,\"string.quoted\"],[/[()[\\]]/,\"@brackets\"],[/@symbols/,{cases:{\"@operators\":\"operator\",\"@default\":\"\"}}]],whitespace:[[/[ \\t\\r\\n]+/,\"white\"],[/;.*$/,\"comment\"],[/#\\|/,\"comment\",\"@comment\"]],comment:[[/[^#|]+/,\"comment\"],[/\\|#/,\"comment\",\"@pop\"],[/[#|]/,\"comment\"]],string:[[/[^\\\\\"]+/,\"string\"],[/\\\\./,\"string.escape\"],[/\"/,\"string\",\"@pop\"]]}})}export{e as PieLanguageClient,n as format,i as registerPieLanguage};\n//# sourceMappingURL=lsp-client-bundle.js.map\n","import { PieLanguageClient, registerPieLanguage } from './lsp/lsp-client-bundle.js';\n\n// Extend Window interface to include Monaco globals\nconst examples = {\n  'Hello World': `(claim zero Nat)\n(define zero zero)\n\n(claim add1zero Nat)\n(define add1zero (add1 zero))`,\n\n  'Natural Number Addition': `(claim +\n  (→ Nat Nat Nat))\n\n(claim step-plus\n  (→ Nat Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1)))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus)))\n\n(claim result Nat)\n(define result (+ 2 3))`,\n\n  'List Length': `(claim length\n  (Π ((E U))\n    (→ (List E) Nat)))\n\n(claim step-length\n  (Π ((E U))\n    (→ E (List E) Nat Nat)))\n\n(define step-length\n  (λ (E)\n    (λ (e es length-es)\n      (add1 length-es))))\n\n(define length\n  (λ (E)\n    (λ (es)\n      (rec-List es\n        0\n        (step-length E)))))\n\n(claim my-list (List Nat))\n(define my-list (:: 1 (:: 2 (:: 3 nil))))\n\n(claim list-len Nat)\n(define list-len (length Nat my-list))`,\n\n  'Either Type': `(claim either-swap\n  (Pi ((A U) (B U))\n    (-> (Either A B)\n        (Either B A))))\n\n(define either-swap\n  (lambda (A B)\n    (lambda (e)\n      (ind-Either e\n        (lambda (x) (Either B A))\n        (lambda (a) (right a))\n        (lambda (b) (left b))))))\n\n(claim test-either (Either Nat Nat))\n(define test-either (left zero))\n\n(claim swapped (Either Nat Nat))\n(define swapped (either-swap Nat Nat test-either))`,\n\n  'Vector Map': `(claim vec-map\n  (Π ((A U) (B U) (n Nat))\n     (-> (-> A B) (Vec A n)\n         (Vec B n))))\n\n(define vec-map\n  (λ (A B n)\n    (λ (f vs)\n      (ind-Vec n vs\n        (λ (k xs) (Vec B k))\n        vecnil\n        (λ (k x xs ih) (vec:: (f x) ih))))))\n\n(claim nat-vec (Vec Nat 3))\n(define nat-vec (vec:: 1 (vec:: 2 (vec:: 3 vecnil))))\n\n(claim add1-fn (-> Nat Nat))\n(define add1-fn (λ (n) (add1 n)))\n\n(claim incremented-vec (Vec Nat 3))\n(define incremented-vec (vec-map Nat Nat 3 add1-fn nat-vec))`,\n  'Tactics: Even or Odd': `\n(claim +\n  (→ Nat Nat\n    Nat))\n\n(claim step-plus\n  (→ Nat\n    Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1 ) ))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus )))\n\n(claim double\n  (→ Nat\n    Nat))\n\n(define double\n  (λ (n)\n    (iter-Nat n\n      0\n      (+ 2))))\n\n(claim Even\n  (→ Nat\n    U ))\n\n(define Even\n  (λ (n)\n    (Σ ((half Nat))\n      (= Nat n (double half )))))\n\n(claim Odd\n  (→ Nat\n    U ))\n\n(define Odd\n  (λ (n)\n    (Σ ((half Nat))\n      (= Nat n (add1 (double half )))))) \n\n(claim zero-is-even\n  (Even 0))\n\n(define zero-is-even\n  (cons 0\n    (same 0)))\n\n(claim add1-even->odd\n  (Π ((n Nat))\n    (→ (Even n)\n    (Odd (add1 n)))))\n\n(define add1-even->odd\n  (λ (n en)\n    (cons (car en)\n    (cong (cdr en) (+ 1)))))\n\n(claim add1-odd->even\n  (Π ((n Nat))\n    (→ (Odd n)\n      (Even (add1 n)))))\n\n(define add1-odd->even\n  (λ (n on)\n    (cons (add1 (car on))\n      (cong (cdr on) (+ 1)))))\n\n(claim even-or-odd\n  (Π ((n Nat))\n    (Either (Even n) (Odd n))))\n\n;; This is the proof in The Little Typer\n;; (claim mot-even-or-odd\n;;   (→ Nat U )) \n\n;; (define mot-even-or-odd\n;;   (λ (k) (Either (Even k) (Odd k))))\n\n;; (claim step-even-or-odd\n;;   (Π ((n-1 Nat))\n;;      (→ (mot-even-or-odd n-1)\n;;      (mot-even-or-odd (add1 n-1)))))\n\n;; (define step-even-or-odd\n;;   (λ (n-1)\n;;     (λ (e-or-on-1)\n;;        (ind-Either e-or-on-1\n;;     (λ (e-or-on-1)\n;;        (mot-even-or-odd (add1 n-1)))\n;;        (λ (en-1)\n;;          (right\n;;            (add1-even->odd\n;;              n-1 en-1)))\n;;        (λ (on-1)\n;;          (left\n;;            (add1-odd->even\n;;              n-1 on-1)))))))\n\n;; (define even-or-odd\n;;   (λ (n)\n;;     (ind-Nat n\n;;        mot-even-or-odd\n;;        (left zero-is-even)\n;;        step-even-or-odd)))\n\n\n;; This is the proof using our new tactic system\n(define-tactically even-or-odd\n  ((intro n)\n  (elim-Nat n)\n  (then\n    (exact (left zero-is-even)))\n  (then\n    (intro n-1)\n    (intro e-or-on-1)\n    (elim-Either e-or-on-1)\n    (then\n      (intro xr)\n      (go-Right)\n      (exact (add1-even->odd n-1 xr)))\n    (then\n      (intro xl)\n      (go-Left)\n      (exact (add1-odd->even n-1 xl))))))`,\n\n  'Inductive Type: Less Than': `;; Define Less Than relation using our new inductive type definiton\n    (data Less-Than () ((j Nat) (k Nat))\n      (zero-smallest ((n Nat)) (Less-Than () (zero (add1 n))))\n      (add1-smaller ((j Nat) (k Nat) (j<k (Less-Than () (j k)))) (Less-Than () ((add1 j) (add1 k))))\n      ind-Less-Than)\n\n    (claim proof-0<1 (Less-Than () (zero (add1 zero))))\n    (define proof-0<1 (zero-smallest zero))\n\n    (claim proof-1<2 (Less-Than () ((add1 zero) (add1 (add1 zero)))))\n    (define proof-1<2 (add1-smaller zero (add1 zero) proof-0<1))\n\n    (claim extract-smaller\n      (Pi ((j Nat) (k Nat))\n        (-> (Less-Than () (j k)) Nat)))\n    (define extract-smaller\n      (lambda (j k proof)\n        (ind-Less-Than proof\n          (lambda (j-idx k-idx p) Nat)\n          (lambda (n) zero)\n          (lambda (j-arg k-arg j<k-arg ih) (add1 ih)))))\n\n    (claim result Nat)\n    (define result (extract-smaller zero (add1 zero) proof-0<1))\n    `,\n  'Inductive Type: Subtype': `\n(data Subtype () ((T1 U) (T2 U))\n  (refl ((T U))\n    (Subtype () (T T)))\n  (trans ((T1 U) (T2 U) (T3 U)\n          (p1 (Subtype () (T1 T2)))\n          (p2 (Subtype () (T2 T3))))\n    (Subtype () (T1 T3)))\n  ;; Generic injection: if there exists a function A -> B, then A <: B\n  (inject ((A U) (B U) (f (-> A B)))\n    (Subtype () (A B)))\n  ind-Subtype)\n\n(claim coerce\n  (Pi ((A U) (B U))\n    (-> (Subtype () (A B)) A B)))\n(define coerce\n  (lambda (A B proof val)\n    ((ind-Subtype proof\n      (lambda (t1 t2 sub) (-> t1 t2))\n      (lambda (TT x) x)\n      (lambda (T11 T22 T33 p1 p2 ih1 ih2 x)\n        (ih2 (ih1 x)))\n      (lambda (AA BB ff x) (ff x))\n      )\n      val)))\n\n(data Even () ((n Nat))\n  (zero-even ()\n    (Even () (zero)))\n  (add2-even ((k Nat) (k-even (Even () (k))))\n    (Even () ((add1 (add1 k)))))\n  ind-Even)\n\n(claim even-to-nat\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define even-to-nat\n  (lambda (n proof)\n    (ind-Even proof\n      (lambda (m ev) Nat)\n      zero\n      (lambda (k prev ih) (add1 (add1 ih))))))\n\n(claim even-subtype-nat\n  (Pi ((n Nat))\n    (Subtype () ((Even () (n)) Nat))))\n(define even-subtype-nat\n  (lambda (n)\n    (inject (Even () (n)) Nat (even-to-nat n))))\n\n(claim + (-> Nat Nat Nat))\n(define +\n  (lambda (a b)\n    (rec-Nat a\n      b\n      (lambda (pred ih) (add1 ih)))))\n\n(claim double (-> Nat Nat))\n(define double\n  (lambda (n)\n    (+ n n)))\n\n;; Use Even with double\n(claim double-even\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define double-even\n  (lambda (n ev)\n    (double (coerce (Even () (n)) Nat\n                    (even-subtype-nat n)\n                    ev))))\n\n\n(claim even-four (Even () ((add1 (add1 (add1 (add1 zero)))))))\n(define even-four\n  (add2-even (add1 (add1 zero))\n    (add2-even zero\n      (zero-even))))\n\n(claim result2 Nat)\n(define result2 (double-even (add1 (add1 (add1 (add1 zero)))) even-four))\n        `\n};\n\nconst defaultSource = examples['Hello World'];\n\nconst previewSummary = document.getElementById('preview-summary');\nconst previewOutput = document.getElementById('preview-output');\n\nlet diagnosticsWorker = null;\nlet lspClient = null;\nlet monacoApi = null;\n\n// Store the latest context info for display\nlet latestContextInfo = {\n  contextLines: [],\n  inTacticalProof: false,\n  proofInfo: null\n};\n\n// Store the latest diagnostics status\nlet latestDiagnosticsStatus = { hasErrors: false, message: '' };\n\nfunction setSummary(message, tone = 'neutral') {\n  if (previewSummary) {\n    previewSummary.textContent = message;\n    previewSummary.dataset.tone = tone;\n  }\n}\n\nfunction setStatus(message) {\n  if (status) {\n    status.textContent = message;\n  }\n}\n\n// Convert ANSI color codes to HTML spans with appropriate CSS classes\nfunction ansiToHtml(text) {\n  // ANSI escape code regex\n  const ansiRegex = /\\x1b\\[(\\d+)m/g;\n\n  // Map ANSI codes to CSS classes\n  const codeToClass = {\n    '0': '',           // Reset\n    '1': 'ansi-bright',\n    '2': 'ansi-dim',\n    '32': 'ansi-green',\n    '33': 'ansi-yellow',\n    '36': 'ansi-cyan',\n  };\n\n  let result = '';\n  let lastIndex = 0;\n  let openSpans = 0;\n  let match;\n\n  while ((match = ansiRegex.exec(text)) !== null) {\n    // Add text before this escape code\n    const textBefore = text.slice(lastIndex, match.index);\n    result += escapeHtml(textBefore);\n\n    const code = match[1];\n    if (code === '0') {\n      // Reset: close all open spans\n      while (openSpans > 0) {\n        result += '</span>';\n        openSpans--;\n      }\n    } else {\n      const className = codeToClass[code];\n      if (className) {\n        result += `<span class=\"${className}\">`;\n        openSpans++;\n      }\n    }\n\n    lastIndex = match.index + match[0].length;\n  }\n\n  // Add remaining text\n  result += escapeHtml(text.slice(lastIndex));\n\n  // Close any remaining open spans\n  while (openSpans > 0) {\n    result += '</span>';\n    openSpans--;\n  }\n\n  return result;\n}\n\n// Escape HTML special characters\nfunction escapeHtml(text) {\n  return text\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nfunction renderPreviewText(text, tone) {\n  if (tone) {\n    previewOutput.dataset.tone = tone;\n  } else {\n    delete previewOutput.dataset.tone;\n  }\n\n  if (text === undefined) {\n    previewOutput.textContent = 'Program is empty.';\n  } else {\n    // Check if text contains ANSI codes\n    if (text.includes('\\x1b[')) {\n      previewOutput.innerHTML = ansiToHtml(text);\n    } else {\n      previewOutput.textContent = text;\n    }\n  }\n}\n\n// Render combined context info and diagnostics\nfunction renderContextInfo() {\n  if (!latestContextInfo) {\n    return;\n  }\n\n  const lines = [];\n\n  if (latestContextInfo.inTacticalProof && latestContextInfo.proofInfo) {\n    // Inside a tactical proof - show proof state prominently\n    lines.push('═══════════════════════════════════');\n    lines.push('');\n    lines.push(latestContextInfo.proofInfo);\n    lines.push('');\n    lines.push('═══════════════════════════════════');\n\n    if (latestContextInfo.contextLines.length > 0) {\n      lines.push('Global Context:');\n      lines.push('───────────────────────────────────');\n      for (const line of latestContextInfo.contextLines) {\n        lines.push(`  ${line}`);\n      }\n    }\n  } else {\n    // Normal context display\n    if (latestContextInfo.contextLines.length > 0) {\n      lines.push('Context:');\n      lines.push('───────────────────────────────────');\n      for (const line of latestContextInfo.contextLines) {\n        lines.push(`  ${line}`);\n      }\n    } else {\n      lines.push('(No definitions before cursor)');\n    }\n  }\n\n  // Show the combined output\n  const tone = latestDiagnosticsStatus.hasErrors ? 'error' : 'success';\n  renderPreviewText(lines.join('\\n'), tone);\n}\n\n// Callback for context info updates\nconst handleContextInfoUpdate = (\n  contextLines,\n  inTacticalProof,\n  proofInfo\n) => {\n  latestContextInfo = { contextLines, inTacticalProof, proofInfo };\n  renderContextInfo();\n};\n\nfunction applyDiagnostics(monaco, editor, payload) {\n  const { diagnostics, pretty } = payload;\n  const model = editor.getModel();\n\n  if (!model) return;\n\n  const markers = diagnostics.map((d) => ({\n    startLineNumber: d.startLineNumber,\n    startColumn: d.startColumn,\n    endLineNumber: d.endLineNumber,\n    endColumn: d.endColumn,\n    message: d.message,\n    severity: d.severity === 'warning'\n      ? monaco.MarkerSeverity.Warning\n      : monaco.MarkerSeverity.Error\n  }));\n\n  monaco.editor.setModelMarkers(model, 'pie-playground', markers);\n\n  if (diagnostics.length === 0) {\n    setSummary('SUCCESS', 'success');\n    latestDiagnosticsStatus = { hasErrors: false, message: pretty?.trim() ?? '' };\n    // Trigger context info display with success status\n    renderContextInfo();\n    return;\n  }\n\n  const primary = diagnostics[0];\n  const tone = primary.severity === 'warning' ? 'warning' : 'error';\n  const label = tone === 'warning' ? 'WARNING' : 'ERROR';\n\n  setSummary(label, tone);\n  const location = `Line ${primary.startLineNumber}, Col ${primary.startColumn}`;\n  latestDiagnosticsStatus = { hasErrors: true, message: `${location}\\n${primary.message}` };\n  renderPreviewText(`${location}\\n${primary.message}`, tone);\n}\n\nfunction initializeDiagnostics(editor) {\n  if (!('Worker' in window)) {\n    setSummary('Diagnostics unavailable in this browser.', 'warning');\n    return null;\n  }\n\n  const worker = new Worker('diagnostics-worker.js', { type: 'module' });\n  worker.onmessage = event => {\n    const { type, payload } = event.data;\n    if (type === 'diagnostics' && monacoApi) {\n      applyDiagnostics(monacoApi, editor, payload);\n    }\n  };\n\n  worker.onerror = (error) => {\n    console.error('Worker error event:', error);\n    console.error('Error details:', {\n      message: error.message,\n      filename: error.filename,\n      lineno: error.lineno,\n      colno: error.colno\n    });\n    setSummary('Diagnostics worker crashed.', 'error');\n    renderPreviewText(\n      `Worker failed to load. Check browser console for details.\\nError: ${error.message || 'Unknown error'}`,\n      'error'\n    );\n  };\n\n  return worker;\n}\n\nasync function initializeLSP(monacoLib, editor) {\n  try {\n    if (lspClient && lspClient.isRunning()) {\n      await lspClient.stop();\n    }\n\n    lspClient = new PieLanguageClient(monacoLib, editor);\n\n    // Set up the context info callback\n    lspClient.setContextInfoCallback(handleContextInfoUpdate);\n\n    await lspClient.start();\n    console.log('LSP client initialized successfully');\n\n    // Request initial context info\n    lspClient.requestContextInfo();\n  } catch (error) {\n    console.error('Failed to initialize LSP client:', error);\n    setSummary('LSP features unavailable', 'warning');\n  }\n}\n\nfunction initializeEditor(monaco) {\n  // Register Pie language\n  registerPieLanguage(monaco);\n\n  const editor = monaco.editor.create(document.getElementById('editor'), {\n    value: defaultSource,\n    language: 'pie',\n    theme: 'vs-dark',\n    automaticLayout: true,\n    minimap: {\n      enabled: false\n    },\n    scrollbar: {\n      vertical: 'auto',\n      horizontal: 'auto',\n      useShadows: false,\n      verticalScrollbarSize: 6,\n      verticalSliderSize: 4\n    },\n    tabSize: 2,\n    padding: { top: 16 },\n    fontSize: 14,\n    fontFamily: \"Menlo, 'Fira Code', 'JetBrains Mono', monospace\",\n    smoothScrolling: true\n  });\n\n  renderPreviewText(defaultSource.trim());\n  setSummary('Ready for analysis.', 'neutral');\n\n  const debounced = debounce((text) => {\n    if (text.trim().length === 0) {\n      setSummary('Waiting for input…', 'neutral');\n      renderPreviewText(undefined);\n    } else {\n      setSummary('Running checks…', 'warning');\n      renderPreviewText('Analyzing…');\n    }\n  }, 120);\n\n  const queueDiagnostics = debounce((text) => {\n    setSummary('Running checks…', 'warning');\n    if (diagnosticsWorker) {\n      diagnosticsWorker.postMessage({\n        type: 'analyze',\n        payload: { source: text }\n      });\n    }\n  }, 220);\n\n  editor.onDidChangeModelContent(() => {\n    const content = editor.getValue();\n    debounced(content);\n    queueDiagnostics(content);\n  });\n\n  editor.onDidBlurEditorWidget(() => {\n    setStatus(\"Idle\");\n  });\n\n  editor.addCommand(\n    monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyF,\n    () => editor.getAction(\"editor.action.formatDocument\").run(),\n  );\n\n  return editor;\n}\n\nfunction initializeExamplePicker(editor) {\n  const picker = document.getElementById('example-picker');\n\n  if (!picker) return;\n\n  // Populate the dropdown\n  Object.keys(examples).forEach(name => {\n    const option = document.createElement('option');\n    option.value = name;\n    option.textContent = name;\n    picker.appendChild(option);\n  });\n\n  // Set initial value\n  picker.value = 'Hello World';\n\n  // Handle selection\n  picker.addEventListener('change', (e) => {\n    const exampleName = e.target.value;\n    if (exampleName && examples[exampleName]) {\n      editor.setValue(examples[exampleName]);\n    }\n  });\n}\n\nasync function boot() {\n  if (!window.require) {\n    console.error('Monaco loader not available');\n    return;\n  }\n\n  window.require.config({\n    paths: {\n      vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.55.1/min/vs'\n    }\n  });\n\n  window.require(['vs/editor/editor.main'], async () => {\n    monacoApi = window.monaco;\n    const editor = initializeEditor(monacoApi);\n    diagnosticsWorker = initializeDiagnostics(editor);\n    initializeExamplePicker(editor);\n\n    // Initialize LSP\n    if (monacoApi) {\n      await initializeLSP(monacoApi, editor);\n    }\n\n    if (diagnosticsWorker) {\n      diagnosticsWorker.postMessage({\n        type: 'analyze',\n        payload: { source: editor.getValue() }\n      });\n    }\n\n    window.__pieEditor = editor;\n  });\n}\n\nfunction debounce(fn, delay) {\n  let handle;\n  return function debounced(...args) {\n    window.clearTimeout(handle);\n    handle = window.setTimeout(() => fn.apply(this, args), delay);\n  };\n}\n\nboot();\n\ndocument.addEventListener(\"DOMContentLoaded\", function () {\n  const downloadBtn = document.getElementById(\"download-btn\");\n  const formatBtn = document.getElementById(\"format-btn\");\n\n  downloadBtn.addEventListener(\"click\", function () {\n    const editor = window.__pieEditor;\n    if (!editor) {\n      // todo: when refactored with react; use proper modal\n      // ugly alert for now...\n      return alert(\"Editor not initialised yet.\");\n    }\n\n    const sourceCode = editor.getValue();\n    const blob = new Blob([sourceCode], { type: \"text/plain\" });\n    const url = URL.createObjectURL(blob);\n\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = \"program.pie\";\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  });\n\n  formatBtn.addEventListener(\"click\", function () {\n    const editor = window.__pieEditor;\n    if (!editor) {\n      return alert(\"Editor not initialised yet.\");\n    }\n\n    editor.getAction(\"editor.action.formatDocument\").run();\n  });\n});\n"],"names":["e","constructor","t","this","worker","disposables","debouncedValidate","debouncedContextInfo","diagnostics","contextInfoCallback","monaco","editor","setContextInfoCallback","start","Worker","onmessage","handleWorkerMessage","data","onerror","console","error","getModel","debounce","getValue","postMessage","type","source","requestContextInfo","onDidChangeModelContent","push","n","onDidChangeCursorPosition","i","languages","registerHoverProvider","provideHover","s","registerCompletionItemProvider","provideCompletionItems","o","registerDefinitionProvider","provideDefinition","stop","clearMarkers","forEach","dispose","terminate","isRunning","updateDiagnostics","severity","startLine","startColumn","endLine","endColumn","message","contextLines","inTacticalProof","proofInfo","getPosition","line","lineNumber","column","map","ensurePositiveNumber","startLineNumber","endLineNumber","MarkerSeverity","Warning","Error","setModelMarkers","find","contents","value","range","Promise","removeEventListener","hoverInfo","title","summary","details","examples","addEventListener","setTimeout","wordRange","end","r","completions","CompletionItemKind","Text","kind","Keyword","Function","Variable","Class","Value","Snippet","label","detail","insertText","suggestions","location","uri","Number","isNaN","window","clearTimeout","replace","split","trim","flatMap","match","length","repeat","join","defaultSource","previewSummary","document","getElementById","previewOutput","diagnosticsWorker","lspClient","monacoApi","latestContextInfo","latestDiagnosticsStatus","hasErrors","setSummary","tone","textContent","dataset","escapeHtml","text","renderPreviewText","undefined","includes","innerHTML","ansiRegex","codeToClass","result","lastIndex","openSpans","exec","slice","index","code","className","ansiToHtml","renderContextInfo","lines","handleContextInfoUpdate","initializeDiagnostics","event","payload","pretty","model","markers","d","primary","applyDiagnostics","filename","lineno","colno","initializeEditor","register","id","setLanguageConfiguration","comments","lineComment","blockComment","brackets","autoClosingPairs","open","close","surroundingPairs","indentationRules","increaseIndentPattern","decreaseIndentPattern","onEnterRules","beforeText","action","indentAction","IndentAction","Indent","afterText","IndentOutdent","Outdent","registerDocumentFormattingEditProvider","provideDocumentFormattingEdits","getFullModelRange","registerDocumentRangeFormattingEditProvider","provideDocumentRangeFormattingEdits","getValueInRange","setMonarchTokensProvider","defaultToken","tokenPostfix","keywords","operators","symbols","tokenizer","root","include","cases","whitespace","comment","string","registerPieLanguage","create","language","theme","automaticLayout","minimap","enabled","scrollbar","vertical","horizontal","useShadows","verticalScrollbarSize","verticalSliderSize","tabSize","padding","top","fontSize","fontFamily","smoothScrolling","debounced","queueDiagnostics","content","onDidBlurEditorWidget","status","addCommand","KeyMod","CtrlCmd","Shift","KeyCode","KeyF","getAction","run","fn","delay","handle","args","apply","async","require","config","paths","vs","picker","Object","keys","name","option","createElement","appendChild","exampleName","target","setValue","initializeExamplePicker","monacoLib","PieLanguageClient","log","initializeLSP","__pieEditor","boot","downloadBtn","formatBtn","alert","sourceCode","blob","Blob","url","URL","createObjectURL","a","href","download","body","click","removeChild","revokeObjectURL"],"mappings":"AAAA,MAAMA,EAAE,WAAAC,CAAYD,EAAEE,GAAGC,KAAKC,OAAO,KAAKD,KAAKE,YAAY,GAAGF,KAAKG,kBAAkB,KAAKH,KAAKI,qBAAqB,KAAKJ,KAAKK,YAAY,GAAGL,KAAKM,oBAAoB,KAAKN,KAAKO,OAAOV,EAAEG,KAAKQ,OAAOT,CAAC,CAAC,sBAAAU,CAAuBZ,GAAGG,KAAKM,oBAAoBT,CAAC,CAAC,WAAMa,GAAQV,KAAKC,OAAO,IAAIU,OAAO,gCAAgCX,KAAKC,OAAOW,UAAUf,IAAIG,KAAKa,oBAAoBhB,EAAEiB,OAAOd,KAAKC,OAAOc,QAAQlB,IAAImB,QAAQC,MAAM,oBAAoBpB,IAAI,MAAMA,EAAEG,KAAKQ,QAAQU,aAAa,IAAIrB,EAAE,OAAOG,KAAKG,kBAAkBH,KAAKmB,SAAS,KAAK,IAAInB,KAAKC,OAAO,OAAO,MAAMF,EAAEF,EAAEuB,WAAWpB,KAAKC,OAAOoB,YAAY,CAACC,KAAK,WAAWC,OAAOxB,KAAK,KAAKC,KAAKI,qBAAqBJ,KAAKmB,SAAS,KAAKnB,KAAKwB,sBAAsB,KAAK,MAAMzB,EAAEC,KAAKQ,QAAQiB,0BAA0B,KAAKzB,KAAKG,mBAAmBH,KAAKG,oBAAoBH,KAAKI,sBAAsBJ,KAAKI,yBAAyBL,GAAGC,KAAKE,YAAYwB,KAAK3B,GAAG,MAAM4B,EAAE3B,KAAKQ,QAAQoB,4BAA4B,KAAK5B,KAAKI,sBAAsBJ,KAAKI,yBAAyBuB,GAAG3B,KAAKE,YAAYwB,KAAKC,GAAG,MAAME,EAAE7B,KAAKO,OAAOuB,UAAUC,sBAAsB,MAAM,CAACC,aAAa,CAACnC,EAAEE,IAAIC,KAAKgC,aAAanC,EAAEE,KAAKC,KAAKE,YAAYwB,KAAKG,GAAG,MAAMI,EAAEjC,KAAKO,OAAOuB,UAAUI,+BAA+B,MAAM,CAACC,uBAAuB,CAACtC,EAAEE,IAAIC,KAAKmC,uBAAuBtC,EAAEE,KAAKC,KAAKE,YAAYwB,KAAKO,GAAG,MAAMG,EAAEpC,KAAKO,OAAOuB,UAAUO,2BAA2B,MAAM,CAACC,kBAAkB,CAACzC,EAAEE,IAAIC,KAAKsC,kBAAkBzC,EAAEE,KAAKC,KAAKE,YAAYwB,KAAKU,GAAGpC,KAAKG,mBAAmBH,KAAKG,mBAAmB,CAAC,UAAMoC,GAAOvC,KAAKwC,eAAexC,KAAKE,YAAYuC,QAAQ5C,IAAIA,GAAG,mBAAmBA,EAAE6C,SAAS7C,EAAE6C,YAAY1C,KAAKE,YAAY,GAAGF,KAAKG,kBAAkB,KAAKH,KAAKI,qBAAqB,KAAKJ,KAAKK,YAAY,GAAGL,KAAKM,oBAAoB,KAAKN,KAAKC,SAASD,KAAKC,OAAO0C,YAAY3C,KAAKC,OAAO,KAAK,CAAC,SAAA2C,GAAY,OAAO,OAAO5C,KAAKC,MAAM,CAAC,mBAAAY,CAAoBhB,GAAGA,IAAI,sBAAsBA,EAAEyB,KAAKtB,KAAK6C,kBAAkBhD,EAAEQ,aAAa,IAAI,qBAAqBR,EAAEyB,KAAKtB,KAAK6C,kBAAkB,CAAC,CAACC,SAAS,QAAQC,UAAU,EAAEC,YAAY,EAAEC,QAAQ,EAAEC,UAAU,EAAEC,QAAQtD,EAAEoB,SAAS,wBAAwBpB,EAAEyB,MAAMtB,KAAKM,qBAAqBN,KAAKM,oBAAoBT,EAAEuD,aAAavD,EAAEwD,gBAAgBxD,EAAEyD,WAAW,CAAC,kBAAA9B,GAAqB,IAAIxB,KAAKC,OAAO,OAAO,MAAMJ,EAAEG,KAAKQ,QAAQU,aAAanB,EAAEC,KAAKQ,QAAQ+C,gBAAgB,IAAI1D,IAAIE,EAAE,OAAO,MAAM4B,EAAE9B,EAAEuB,WAAWpB,KAAKC,OAAOoB,YAAY,CAACC,KAAK,eAAeC,OAAOI,EAAE6B,KAAKzD,EAAE0D,WAAW,EAAEC,OAAO3D,EAAE2D,OAAO,GAAG,CAAC,iBAAAb,CAAkBhD,GAAGG,KAAKK,YAAYR,EAAE,MAAME,EAAEC,KAAKQ,QAAQU,aAAa,IAAInB,EAAE,OAAO,MAAM4B,EAAE9B,EAAE8D,IAAI9D,IAAI,MAAME,EAAEC,KAAK4D,qBAAqB/D,EAAEkD,UAAU,GAAGpB,EAAE3B,KAAK4D,qBAAqB/D,EAAEoD,QAAQlD,GAAG8B,EAAE7B,KAAK4D,qBAAqB/D,EAAEmD,YAAY,GAAG,MAAM,CAACa,gBAAgB9D,EAAEiD,YAAYnB,EAAEiC,cAAcnC,EAAEuB,UAAUlD,KAAK4D,qBAAqB/D,EAAEqD,UAAUrB,EAAE,GAAGsB,QAAQtD,EAAEsD,QAAQL,SAAS,YAAYjD,EAAEiD,SAAS9C,KAAKO,OAAOwD,eAAeC,QAAQhE,KAAKO,OAAOwD,eAAeE,SAASjE,KAAKO,OAAOC,OAAO0D,gBAAgBnE,EAAE,UAAU4B,EAAE,CAAC,kBAAMK,CAAanC,EAAEE,GAAG,IAAIC,KAAKC,OAAO,OAAO,KAAK,MAAM0B,EAAE3B,KAAKK,YAAY8D,KAAKtE,IAAI,MAAM8B,EAAE3B,KAAK4D,qBAAqB/D,EAAEkD,UAAUhD,EAAE0D,YAAY5B,EAAE7B,KAAK4D,qBAAqB/D,EAAEoD,QAAQtB,GAAGM,EAAEjC,KAAK4D,qBAAqB/D,EAAEmD,YAAY,GAAGZ,EAAEpC,KAAK4D,qBAAqB/D,EAAEqD,UAAUjB,EAAE,GAAG,QAAQlC,EAAE0D,WAAW9B,GAAG5B,EAAE0D,WAAW5B,GAAO9B,EAAE0D,aAAa9B,GAAG5B,EAAE2D,OAAOzB,GAAMlC,EAAE0D,aAAa5B,GAAG9B,EAAE2D,OAAOtB,KAAM,GAAGT,EAAE,CAAC,MAAM9B,EAAEG,KAAK4D,qBAAqBjC,EAAEoB,UAAUhD,EAAE0D,YAAY5B,EAAE7B,KAAK4D,qBAAqBjC,EAAEsB,QAAQpD,GAAGoC,EAAEjC,KAAK4D,qBAAqBjC,EAAEqB,YAAY,GAAGZ,EAAEpC,KAAK4D,qBAAqBjC,EAAEuB,UAAUjB,EAAE,GAAG,MAAM,CAACmC,SAAS,CAAC,CAACC,MAAM,KAAK,YAAY1C,EAAEmB,SAAS,UAAU,gBAAgBnB,EAAEwB,YAAYmB,MAAM,CAACT,gBAAgBhE,EAAEmD,YAAYf,EAAE6B,cAAcjC,EAAEqB,UAAUd,GAAG,CAAC,OAAO,IAAImC,QAAQ5C,IAAI,MAAME,EAAEhC,IAAI,MAAME,EAAEF,EAAEiB,KAAK,GAAG,iBAAiBf,EAAEuB,KAAK,CAAC,GAAGtB,KAAKC,QAAQuE,oBAAoB,UAAU3C,IAAI9B,EAAE0E,UAAU,YAAY9C,EAAE,MAAM,MAAM9B,EAAEE,EAAE0E,UAAU,IAAIxC,EAAE,KAAKpC,EAAE6E,cAAc7E,EAAE8E,UAAU9E,EAAE+E,UAAU3C,GAAG,OAAOpC,EAAE+E,WAAW/E,EAAEgF,WAAW5C,GAAG,iCAAiCpC,EAAEgF,oBAAoBlD,EAAE,CAACyC,SAAS,CAAC,CAACC,MAAMpC,KAAK,GAAG,GAAGjC,KAAKC,OAAO,CAACD,KAAKC,OAAO6E,iBAAiB,UAAUjD,GAAG,MAAMF,EAAE9B,EAAEuB,WAAWpB,KAAKC,OAAOoB,YAAY,CAACC,KAAK,QAAQC,OAAOI,EAAE6B,KAAKzD,EAAE0D,WAAW,EAAEC,OAAO3D,EAAE2D,OAAO,GAAG,CAACqB,WAAW,KAAK/E,KAAKC,QAAQuE,oBAAoB,UAAU3C,GAAGF,EAAE,OAAO,MAAM,CAAC,4BAAMQ,CAAuBtC,EAAEE,GAAG,OAAOC,KAAKC,OAAO,IAAIsE,QAAQ5C,IAAI,MAAME,EAAEhC,IAAI,MAAMoC,EAAEpC,EAAEiB,KAAK,GAAG,sBAAsBmB,EAAEX,KAAK,CAACtB,KAAKC,QAAQuE,oBAAoB,UAAU3C,GAAG,MAAMhC,EAAEoC,EAAE+C,UAAU5C,EAAEvC,EAAE,CAACgE,gBAAgB9D,EAAE0D,WAAWT,YAAYnD,EAAEa,MAAM,EAAEoD,cAAc/D,EAAE0D,WAAWP,UAAUrD,EAAEoF,IAAI,GAAG,CAACpB,gBAAgB9D,EAAE0D,WAAWT,YAAYjD,EAAE2D,OAAOI,cAAc/D,EAAE0D,WAAWP,UAAUnD,EAAE2D,QAAQwB,EAAEjD,EAAEkD,YAAYxB,IAAI9D,IAAI,IAAIE,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBC,KAAK,OAAOxF,EAAEyF,MAAM,IAAI,UAAUvF,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBG,QAAQ,MAAM,IAAI,WAAWxF,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBI,SAAS,MAAM,IAAI,WAAWzF,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBK,SAAS,MAAM,IAAI,gBAAgB1F,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBM,MAAM,MAAM,IAAI,QAAQ3F,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBO,MAAM,MAAM,IAAI,UAAU5F,EAAEC,KAAKO,OAAOuB,UAAUsD,mBAAmBQ,QAAQ,MAAM,CAACC,MAAMhG,EAAEgG,MAAMP,KAAKvF,EAAE+F,OAAOjG,EAAEiG,OAAOC,WAAWlG,EAAEgG,MAAMvB,MAAMlC,KAAKT,EAAE,CAACqE,YAAYd,GAAG,GAAG,GAAGlF,KAAKC,OAAO,CAACD,KAAKC,OAAO6E,iBAAiB,UAAUjD,GAAG,MAAMF,EAAE9B,EAAEuB,WAAWpB,KAAKC,OAAOoB,YAAY,CAACC,KAAK,aAAaC,OAAOI,EAAE6B,KAAKzD,EAAE0D,WAAW,EAAEC,OAAO3D,EAAE2D,OAAO,GAAG,CAACqB,WAAW,KAAK/E,KAAKC,QAAQuE,oBAAoB,UAAU3C,GAAGF,EAAE,CAACqE,YAAY,MAAM,OAAO,CAACA,YAAY,GAAG,CAAC,uBAAM1D,CAAkBzC,EAAEE,GAAG,OAAOC,KAAKC,OAAO,IAAIsE,QAAQ5C,IAAI,MAAME,EAAE9B,IAAI,MAAMkC,EAAElC,EAAEe,KAAK,sBAAsBmB,EAAEX,OAAOtB,KAAKC,QAAQuE,oBAAoB,UAAU3C,GAAGI,EAAEgE,SAAStE,EAAE,CAACuE,IAAIrG,EAAEqG,IAAI5B,MAAM,CAACT,gBAAgB5B,EAAEgE,SAASzC,KAAK,EAAER,YAAYf,EAAEgE,SAASjD,YAAY,EAAEc,cAAc7B,EAAEgE,SAASzC,KAAK,EAAEN,UAAUjB,EAAEgE,SAAS/C,UAAU,KAAKvB,EAAE,QAAQ,GAAG3B,KAAKC,OAAO,CAACD,KAAKC,OAAO6E,iBAAiB,UAAUjD,GAAG,MAAMF,EAAE9B,EAAEuB,WAAWpB,KAAKC,OAAOoB,YAAY,CAACC,KAAK,aAAaC,OAAOI,EAAE6B,KAAKzD,EAAE0D,WAAW,EAAEC,OAAO3D,EAAE2D,OAAO,GAAG,CAACqB,WAAW,KAAK/E,KAAKC,QAAQuE,oBAAoB,UAAU3C,GAAGF,EAAE,OAAO,OAAO,IAAI,CAAC,YAAAa,GAAe,MAAM3C,EAAEG,KAAKQ,QAAQU,aAAarB,GAAGG,KAAKO,OAAOC,OAAO0D,gBAAgBrE,EAAE,UAAU,GAAG,CAAC,oBAAA+D,CAAqB/D,EAAEE,GAAG,MAAM,iBAAiBF,GAAGsG,OAAOC,MAAMvG,IAAIA,EAAE,EAAEE,EAAEF,CAAC,CAAC,QAAAsB,CAAStB,EAAEE,GAAG,IAAI4B,EAAE,KAAK,MAAM,KAAK,OAAOA,GAAG0E,OAAOC,aAAa3E,GAAGA,EAAE0E,OAAOtB,WAAW,KAAKpD,EAAE,KAAK9B,KAAKE,GAAG,EAAE,MAAMA,EAAEF,GAAGA,EAAE0G,QAAQ,OAAO,KAAKA,QAAQ,SAAS,KAAKA,QAAQ,SAAS,KAAK5E,EAAE9B,IAAI,MAAM8B,EAAE9B,EAAE2G,MAAM,MAAM,IAAI3E,GAAE,EAAG,MAAMI,EAAE,GAAG,IAAI,MAAMpC,KAAK8B,EAAE,CAAC,MAAM5B,EAAEF,EAAE4G,OAAO,KAAK1G,GAAG8B,GAAGI,EAAEP,KAAK,IAAIG,GAAE,IAAKI,EAAEP,KAAK3B,GAAG8B,GAAE,EAAG,CAAC,IAAIO,EAAE,EAAE,OAAOH,EAAE0B,IAAI5D,GAAG2G,QAAQ7G,IAAI,MAAME,GAAGF,EAAE8G,MAAM,QAAQ,IAAIC,OAAOjF,GAAG9B,EAAE8G,MAAM,QAAQ,IAAIC,OAAO/E,EAAE,IAAIgF,OAAO,EAAEzE,GAAGvC,EAAE,OAAOuC,GAAGrC,EAAE4B,EAAEE,IAAIiF,KAAK,OCGzrN,MAAMjC,EAAW,CACf,cAAe,8FAMf,0BAA2B,4OAmB3B,cAAe,2bA0Bf,cAAe,+aAmBf,aAAc,ggBAqBd,uBAAwB,uuEAoIxB,4BAA6B,07BAyB7B,0BAA2B,66DAqFvBkC,EAAgBlC,EAAS,eAEzBmC,EAAiBC,SAASC,eAAe,mBACzCC,EAAgBF,SAASC,eAAe,kBAE9C,IAAIE,EAAoB,KACpBC,EAAY,KACZC,EAAY,KAGZC,EAAoB,CACtBnE,aAAc,GACdC,iBAAiB,EACjBC,UAAW,MAITkE,EAA0B,CAAEC,WAAW,GAE3C,SAASC,EAAWvE,EAASwE,EAAO,WAC9BX,IACFA,EAAeY,YAAczE,EAC7B6D,EAAea,QAAQF,KAAOA,EAElC,CAgEA,SAASG,EAAWC,GAClB,OAAOA,EACJxB,QAAQ,KAAM,SACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,UACdA,QAAQ,KAAM,SACnB,CAEA,SAASyB,EAAkBD,EAAMJ,GAC3BA,EACFR,EAAcU,QAAQF,KAAOA,SAEtBR,EAAcU,QAAQF,UAGlBM,IAATF,EACFZ,EAAcS,YAAc,oBAGxBG,EAAKG,SAAS,MAChBf,EAAcgB,UA5EpB,SAAoBJ,GAElB,MAAMK,EAAY,gBAGZC,EAAc,CAClB,EAAK,GACL,EAAK,cACL,EAAK,WACL,GAAM,aACN,GAAM,cACN,GAAM,aAGR,IAGI1B,EAHA2B,EAAS,GACTC,EAAY,EACZC,EAAY,EAGhB,KAA0C,QAAlC7B,EAAQyB,EAAUK,KAAKV,KAAiB,CAG9CO,GAAUR,EADSC,EAAKW,MAAMH,EAAW5B,EAAMgC,QAG/C,MAAMC,EAAOjC,EAAM,GACnB,GAAa,MAATiC,EAEF,KAAOJ,EAAY,GACjBF,GAAU,UACVE,QAEG,CACL,MAAMK,EAAYR,EAAYO,GAC1BC,IACFP,GAAU,gBAAgBO,MAC1BL,IAEJ,CAEAD,EAAY5B,EAAMgC,MAAQhC,EAAM,GAAGC,MACrC,CAMA,IAHA0B,GAAUR,EAAWC,EAAKW,MAAMH,IAGzBC,EAAY,GACjBF,GAAU,UACVE,IAGF,OAAOF,CACT,CAwBgCQ,CAAWf,GAErCZ,EAAcS,YAAcG,CAGlC,CAGA,SAASgB,IACP,IAAKxB,EACH,OAGF,MAAMyB,EAAQ,GAEd,GAAIzB,EAAkBlE,iBAAmBkE,EAAkBjE,WAQzD,GANA0F,EAAMtH,KAAK,uCACXsH,EAAMtH,KAAK,IACXsH,EAAMtH,KAAK6F,EAAkBjE,WAC7B0F,EAAMtH,KAAK,IACXsH,EAAMtH,KAAK,uCAEP6F,EAAkBnE,aAAawD,OAAS,EAAG,CAC7CoC,EAAMtH,KAAK,mBACXsH,EAAMtH,KAAK,uCACX,IAAK,MAAM8B,KAAQ+D,EAAkBnE,aACnC4F,EAAMtH,KAAK,KAAK8B,IAEpB,OAGA,GAAI+D,EAAkBnE,aAAawD,OAAS,EAAG,CAC7CoC,EAAMtH,KAAK,YACXsH,EAAMtH,KAAK,uCACX,IAAK,MAAM8B,KAAQ+D,EAAkBnE,aACnC4F,EAAMtH,KAAK,KAAK8B,IAEpB,MACEwF,EAAMtH,KAAK,kCAKf,MAAMiG,EAAOH,EAAwBC,UAAY,QAAU,UAC3DO,EAAkBgB,EAAMlC,KAAK,MAAOa,EACtC,CAGA,MAAMsB,EAA0B,CAC9B7F,EACAC,EACAC,KAEAiE,EAAoB,CAAEnE,eAAcC,kBAAiBC,aACrDyF,KAwCF,SAASG,EAAsB1I,GAC7B,KAAM,WAAY6F,QAEhB,OADAqB,EAAW,2CAA4C,WAChD,KAGT,MAAMzH,EAAS,IAAIU,OAAO,wBAAyB,CAAEW,KAAM,WAuB3D,OAtBArB,EAAOW,UAAYuI,IACjB,MAAM7H,KAAEA,EAAI8H,QAAEA,GAAYD,EAAMrI,KACnB,gBAATQ,GAA0BgG,GA9ClC,SAA0B/G,EAAQC,EAAQ4I,GACxC,MAAM/I,YAAEA,EAAWgJ,OAAEA,GAAWD,EAC1BE,EAAQ9I,EAAOU,WAErB,IAAKoI,EAAO,OAEZ,MAAMC,EAAUlJ,EAAYsD,IAAK6F,IAAC,CAChC3F,gBAAiB2F,EAAE3F,gBACnBb,YAAawG,EAAExG,YACfc,cAAe0F,EAAE1F,cACjBZ,UAAWsG,EAAEtG,UACbC,QAASqG,EAAErG,QACXL,SAAyB,YAAf0G,EAAE1G,SACRvC,EAAOwD,eAAeC,QACtBzD,EAAOwD,eAAeE,SAK5B,GAFA1D,EAAOC,OAAO0D,gBAAgBoF,EAAO,iBAAkBC,GAE5B,IAAvBlJ,EAAYuG,OAKd,OAJAc,EAAW,UAAW,WACtBF,EAA0B,CAAEC,WAAW,EAAOtE,QAASkG,GAAQ5C,QAAU,SAEzEsC,IAIF,MAAMU,EAAUpJ,EAAY,GACtBsH,EAA4B,YAArB8B,EAAQ3G,SAAyB,UAAY,QAG1D4E,EAFuB,YAATC,EAAqB,UAAY,QAE7BA,GAClB,MAAM1B,EAAW,QAAQwD,EAAQ5F,wBAAwB4F,EAAQzG,cACjEwE,EAA0B,CAAEC,WAAW,EAAMtE,QAAS,GAAG8C,MAAawD,EAAQtG,WAC9E6E,EAAkB,GAAG/B,MAAawD,EAAQtG,UAAWwE,EACvD,CAYM+B,CAAiBpC,EAAW9G,EAAQ4I,IAIxCnJ,EAAOc,QAAWE,IAChBD,QAAQC,MAAM,sBAAuBA,GACrCD,QAAQC,MAAM,iBAAkB,CAC9BkC,QAASlC,EAAMkC,QACfwG,SAAU1I,EAAM0I,SAChBC,OAAQ3I,EAAM2I,OACdC,MAAO5I,EAAM4I,QAEfnC,EAAW,8BAA+B,SAC1CM,EACE,qEAAqE/G,EAAMkC,SAAW,kBACtF,UAIGlD,CACT,CAwBA,SAAS6J,EAAiBvJ,IDnlBsqN,SAAWV,GAAGA,EAAEiC,UAAUiI,SAAS,CAACC,GAAG,QAAQnK,EAAEiC,UAAUmI,yBAAyB,MAAM,CAACC,SAAS,CAACC,YAAY,IAAIC,aAAa,CAAC,KAAK,OAAOC,SAAS,CAAC,CAAC,IAAI,MAAMC,iBAAiB,CAAC,CAACC,KAAK,IAAIC,MAAM,MAAMC,iBAAiB,CAAC,CAACF,KAAK,IAAIC,MAAM,MAAME,iBAAiB,CAACC,sBAAsB,gBAAgBC,sBAAsB,UAAUC,aAAa,CAAC,CAACC,WAAW,gBAAgBC,OAAO,CAACC,aAAanL,EAAEiC,UAAUmJ,aAAaC,SAAS,CAACJ,WAAW,YAAYK,UAAU,SAASJ,OAAO,CAACC,aAAanL,EAAEiC,UAAUmJ,aAAaG,gBAAgB,CAACN,WAAW,OAAOK,UAAU,SAASJ,OAAO,CAACC,aAAanL,EAAEiC,UAAUmJ,aAAaI,aAAaxL,EAAEiC,UAAUwJ,uCAAuC,MAAM,CAACC,+BAA+B1L,GAAG,CAAC,CAACyE,MAAMzE,EAAE2L,oBAAoBzD,KAAKpG,EAAE9B,EAAEuB,gBAAgBvB,EAAEiC,UAAU2J,4CAA4C,MAAM,CAACC,oCAAoC,CAAC7L,EAAEE,IAAI,CAAC,CAACuE,MAAMvE,EAAEgI,KAAKpG,EAAE9B,EAAE8L,gBAAgB5L,QAAQF,EAAEiC,UAAU8J,yBAAyB,MAAM,CAACC,aAAa,GAAGC,aAAa,OAAOC,SAAS,CAAC,SAAS,IAAI,KAAK,IAAI,QAAQ,IAAI,SAAS,QAAQ,MAAM,aAAa,oBAAoB,OAAO,IAAI,MAAM,OAAO,OAAO,MAAM,SAAS,OAAO,OAAO,MAAM,OAAO,MAAM,MAAM,UAAU,UAAU,WAAW,WAAW,WAAW,UAAU,UAAU,QAAQ,UAAU,QAAQ,OAAO,OAAO,OAAO,OAAO,QAAQ,aAAa,SAAS,QAAQ,YAAY,QAAQ,OAAO,UAAU,OAAO,KAAK,SAAS,aAAa,IAAI,OAAO,OAAO,SAAS,KAAK,IAAI,QAAQ,QAAQ,SAAS,WAAW,YAAY,WAAW,aAAa,cAAc,cAAc,aAAa,OAAO,QAAQ,UAAU,YAAYC,UAAU,GAAGC,QAAQ,sBAAsBC,UAAU,CAACC,KAAK,CAAC,CAACC,QAAQ,eAAe,CAAC,8EAA8E,WAAW,CAAC,qCAAqC,CAACC,MAAM,CAAC,YAAY,UAAU,WAAW,gBAAgB,CAAC,MAAM,UAAU,CAAC,kBAAkB,kBAAkB,CAAC,IAAI,SAAS,WAAW,CAAC,kCAAkC,iBAAiB,CAAC,UAAU,aAAa,CAAC,WAAW,CAACA,MAAM,CAAC,aAAa,WAAW,WAAW,OAAOC,WAAW,CAAC,CAAC,aAAa,SAAS,CAAC,OAAO,WAAW,CAAC,MAAM,UAAU,aAAaC,QAAQ,CAAC,CAAC,SAAS,WAAW,CAAC,MAAM,UAAU,QAAQ,CAAC,OAAO,YAAYC,OAAO,CAAC,CAAC,UAAU,UAAU,CAAC,MAAM,iBAAiB,CAAC,IAAI,SAAS,WAAW,CCqlB/9RC,CAAoBlM,GAEpB,MAAMC,EAASD,EAAOC,OAAOkM,OAAOzF,SAASC,eAAe,UAAW,CACrE7C,MAAO0C,EACP4F,SAAU,MACVC,MAAO,UACPC,iBAAiB,EACjBC,QAAS,CACPC,SAAS,GAEXC,UAAW,CACTC,SAAU,OACVC,WAAY,OACZC,YAAY,EACZC,sBAAuB,EACvBC,mBAAoB,GAEtBC,QAAS,EACTC,QAAS,CAAEC,IAAK,IAChBC,SAAU,GACVC,WAAY,kDACZC,iBAAiB,IAGnB3F,EAAkBjB,EAAcN,QAChCiB,EAAW,sBAAuB,WAElC,MAAMkG,EAAYzM,EAAU4G,IACC,IAAvBA,EAAKtB,OAAOG,QACdc,EAAW,qBAAsB,WACjCM,OAAkBC,KAElBP,EAAW,kBAAmB,WAC9BM,EAAkB,gBAEnB,KAEG6F,EAAmB1M,EAAU4G,IACjCL,EAAW,kBAAmB,WAC1BN,GACFA,EAAkB/F,YAAY,CAC5BC,KAAM,UACN8H,QAAS,CAAE7H,OAAQwG,MAGtB,KAiBH,OAfAvH,EAAOiB,wBAAwB,KAC7B,MAAMqM,EAAUtN,EAAOY,WACvBwM,EAAUE,GACVD,EAAiBC,KAGnBtN,EAAOuN,sBAAsB,KA/R/B,IAAmB5K,IAgSL,OA/RR6K,SACFA,OAAOpG,YAAczE,KAiSvB3C,EAAOyN,WACL1N,EAAO2N,OAAOC,QAAU5N,EAAO2N,OAAOE,MAAQ7N,EAAO8N,QAAQC,KAC7D,IAAM9N,EAAO+N,UAAU,gCAAgCC,OAGlDhO,CACT,CA6DA,SAASW,EAASsN,EAAIC,GACpB,IAAIC,EACJ,OAAO,YAAsBC,GAC3BvI,OAAOC,aAAaqI,GACpBA,EAAStI,OAAOtB,WAAW,IAAM0J,EAAGI,MAAM7O,KAAM4O,GAAOF,EACzD,CACF,EAxCAI,iBACOzI,OAAO0I,SAKZ1I,OAAO0I,QAAQC,OAAO,CACpBC,MAAO,CACLC,GAAI,8DAIR7I,OAAO0I,QAAQ,CAAC,yBAA0BD,UACxCxH,EAAYjB,OAAO9F,OACnB,MAAMC,EAASsJ,EAAiBxC,GAChCF,EAAoB8B,EAAsB1I,GAxC9C,SAAiCA,GAC/B,MAAM2O,EAASlI,SAASC,eAAe,kBAElCiI,IAGLC,OAAOC,KAAKxK,GAAUpC,QAAQ6M,IAC5B,MAAMC,EAAStI,SAASuI,cAAc,UACtCD,EAAOlL,MAAQiL,EACfC,EAAO3H,YAAc0H,EACrBH,EAAOM,YAAYF,KAIrBJ,EAAO9K,MAAQ,cAGf8K,EAAOrK,iBAAiB,SAAWjF,IACjC,MAAM6P,EAAc7P,EAAE8P,OAAOtL,MACzBqL,GAAe7K,EAAS6K,IAC1BlP,EAAOoP,SAAS/K,EAAS6K,MAG/B,CAkBIG,CAAwBrP,GAGpB8G,SArIRwH,eAA6BgB,EAAWtP,GACtC,IACM6G,GAAaA,EAAUzE,mBACnByE,EAAU9E,OAGlB8E,EAAY,IAAI0I,EAAkBD,EAAWtP,GAG7C6G,EAAU5G,uBAAuBwI,SAE3B5B,EAAU3G,QAChBM,QAAQgP,IAAI,uCAGZ3I,EAAU7F,oBACZ,CAAE,MAAOP,GACPD,QAAQC,MAAM,mCAAoCA,GAClDyG,EAAW,2BAA4B,UACzC,CACF,CAkHYuI,CAAc3I,EAAW9G,GAG7B4G,GACFA,EAAkB/F,YAAY,CAC5BC,KAAM,UACN8H,QAAS,CAAE7H,OAAQf,EAAOY,cAI9BiF,OAAO6J,YAAc1P,KA5BrBQ,QAAQC,MAAM,8BA8BlB,CAUAkP,GAEAlJ,SAASnC,iBAAiB,mBAAoB,WAC5C,MAAMsL,EAAcnJ,SAASC,eAAe,gBACtCmJ,EAAYpJ,SAASC,eAAe,cAE1CkJ,EAAYtL,iBAAiB,QAAS,WACpC,MAAMtE,EAAS6F,OAAO6J,YACtB,IAAK1P,EAGH,OAAO8P,MAAM,+BAGf,MAAMC,EAAa/P,EAAOY,WACpBoP,EAAO,IAAIC,KAAK,CAACF,GAAa,CAAEjP,KAAM,eACtCoP,EAAMC,IAAIC,gBAAgBJ,GAE1BK,EAAI5J,SAASuI,cAAc,KACjCqB,EAAEC,KAAOJ,EACTG,EAAEE,SAAW,cACb9J,SAAS+J,KAAKvB,YAAYoB,GAC1BA,EAAEI,QACFhK,SAAS+J,KAAKE,YAAYL,GAC1BF,IAAIQ,gBAAgBT,EACtB,GAEAL,EAAUvL,iBAAiB,QAAS,WAClC,MAAMtE,EAAS6F,OAAO6J,YACtB,IAAK1P,EACH,OAAO8P,MAAM,+BAGf9P,EAAO+N,UAAU,gCAAgCC,KACnD,EACF"}