class e{constructor(e,n){this.worker=null,this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.monaco=e,this.editor=n}async start(){this.worker=new Worker(new URL("./pie-lsp-worker-bundle.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("LSP Worker error:",e)};const e=this.editor?.getModel?.();if(!e)return;this.debouncedValidate=this.debounce(()=>{if(!this.worker)return;const n=e.getValue();this.worker.postMessage({type:"validate",source:n})},220);const n=this.editor?.onDidChangeModelContent?.(()=>{this.debouncedValidate&&this.debouncedValidate()});n&&this.disposables.push(n);const t=this.monaco.languages.registerHoverProvider("pie",{provideHover:(e,n)=>this.provideHover(e,n)});this.disposables.push(t);const i=this.monaco.languages.registerCompletionItemProvider("pie",{provideCompletionItems:(e,n)=>this.provideCompletionItems(e,n)});this.disposables.push(i);const a=this.monaco.languages.registerDefinitionProvider("pie",{provideDefinition:(e,n)=>this.provideDefinition(e,n)});this.disposables.push(a),this.debouncedValidate&&this.debouncedValidate()}async stop(){this.clearMarkers(),this.disposables.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}),this.disposables=[],this.debouncedValidate=null,this.diagnostics=[],this.worker&&(this.worker.terminate(),this.worker=null)}isRunning(){return null!==this.worker}handleWorkerMessage(e){e&&("validation-result"===e.type?this.updateDiagnostics(e.diagnostics??[]):"validation-error"===e.type&&this.updateDiagnostics([{severity:"error",startLine:1,startColumn:1,endLine:1,endColumn:2,message:e.error}]))}updateDiagnostics(e){this.diagnostics=e;const n=this.editor?.getModel?.();if(!n)return;const t=e.map(e=>{const n=this.ensurePositiveNumber(e.startLine,1),t=this.ensurePositiveNumber(e.endLine,n),i=this.ensurePositiveNumber(e.startColumn,1);return{startLineNumber:n,startColumn:i,endLineNumber:t,endColumn:this.ensurePositiveNumber(e.endColumn,i+1),message:e.message,severity:"warning"===e.severity?this.monaco.MarkerSeverity.Warning:this.monaco.MarkerSeverity.Error}});this.monaco.editor.setModelMarkers(n,"pie-lsp",t)}async provideHover(e,n){if(!this.worker)return null;const t=this.diagnostics.find(e=>{const t=this.ensurePositiveNumber(e.startLine,n.lineNumber),i=this.ensurePositiveNumber(e.endLine,t),a=this.ensurePositiveNumber(e.startColumn,1),o=this.ensurePositiveNumber(e.endColumn,a+1);return!(n.lineNumber<t||n.lineNumber>i)&&(!(n.lineNumber===t&&n.column<a)&&!(n.lineNumber===i&&n.column>o))});if(t){const e=this.ensurePositiveNumber(t.startLine,n.lineNumber),i=this.ensurePositiveNumber(t.endLine,e),a=this.ensurePositiveNumber(t.startColumn,1),o=this.ensurePositiveNumber(t.endColumn,a+1);return{contents:[{value:`**${"warning"===t.severity?"Warning":"Error"}**\n\n${t.message}`}],range:{startLineNumber:e,startColumn:a,endLineNumber:i,endColumn:o}}}return new Promise(t=>{const i=e=>{const n=e.data;if("hover-result"===n.type){if(this.worker?.removeEventListener("message",i),!n.hoverInfo)return void t(null);const e=n.hoverInfo;let a=`**${e.title}**\n\n${e.summary}`;e.details&&(a+=`\n\n${e.details}`),e.examples&&(a+=`\n\n**Examples:**\n\`\`\`pie\n${e.examples}\n\`\`\``),t({contents:[{value:a}]})}};if(this.worker){this.worker.addEventListener("message",i);const t=e.getValue();this.worker.postMessage({type:"hover",source:t,line:n.lineNumber-1,column:n.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),t(null)},1e3)})}async provideCompletionItems(e,n){return this.worker?new Promise(t=>{const i=e=>{const a=e.data;if("completion-result"===a.type){this.worker?.removeEventListener("message",i);const e=a.wordRange,o=e?{startLineNumber:n.lineNumber,startColumn:e.start+1,endLineNumber:n.lineNumber,endColumn:e.end+1}:{startLineNumber:n.lineNumber,startColumn:n.column,endLineNumber:n.lineNumber,endColumn:n.column},r=a.completions.map(e=>{let n=this.monaco.languages.CompletionItemKind.Text;switch(e.kind){case"Keyword":n=this.monaco.languages.CompletionItemKind.Keyword;break;case"Function":n=this.monaco.languages.CompletionItemKind.Function;break;case"Variable":n=this.monaco.languages.CompletionItemKind.Variable;break;case"TypeParameter":n=this.monaco.languages.CompletionItemKind.Class;break;case"Value":n=this.monaco.languages.CompletionItemKind.Value;break;case"Snippet":n=this.monaco.languages.CompletionItemKind.Snippet}return{label:e.label,kind:n,detail:e.detail,insertText:e.label,range:o}});t({suggestions:r})}};if(this.worker){this.worker.addEventListener("message",i);const t=e.getValue();this.worker.postMessage({type:"completion",source:t,line:n.lineNumber-1,column:n.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),t({suggestions:[]})},1e3)}):{suggestions:[]}}async provideDefinition(e,n){return this.worker?new Promise(t=>{const i=n=>{const a=n.data;"definition-result"===a.type&&(this.worker?.removeEventListener("message",i),a.location?t({uri:e.uri,range:{startLineNumber:a.location.line+1,startColumn:a.location.startColumn+1,endLineNumber:a.location.line+1,endColumn:a.location.endColumn+1}}):t(null))};if(this.worker){this.worker.addEventListener("message",i);const t=e.getValue();this.worker.postMessage({type:"definition",source:t,line:n.lineNumber-1,column:n.column-1})}setTimeout(()=>{this.worker?.removeEventListener("message",i),t(null)},1e3)}):null}clearMarkers(){const e=this.editor?.getModel?.();e&&this.monaco.editor.setModelMarkers(e,"pie-lsp",[])}ensurePositiveNumber(e,n){return"number"!=typeof e||Number.isNaN(e)||e<1?n:e}debounce(e,n){let t=null;return()=>{null!==t&&window.clearTimeout(t),t=window.setTimeout(()=>{t=null,e()},n)}}}const n={"Hello World":"(claim zero Nat)\n(define zero zero)\n\n(claim add1zero Nat)\n(define add1zero (add1 zero))","Natural Number Addition":"(claim +\n  (→ Nat Nat Nat))\n\n(claim step-plus\n  (→ Nat Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1)))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus)))\n\n(claim result Nat)\n(define result (+ 2 3))","List Length":"(claim length\n  (Π ((E U))\n    (→ (List E) Nat)))\n\n(claim step-length\n  (Π ((E U))\n    (→ E (List E) Nat Nat)))\n\n(define step-length\n  (λ (E)\n    (λ (e es length-es)\n      (add1 length-es))))\n\n(define length\n  (λ (E)\n    (λ (es)\n      (rec-List es\n        0\n        (step-length E)))))\n\n(claim my-list (List Nat))\n(define my-list (:: 1 (:: 2 (:: 3 nil))))\n\n(claim list-len Nat)\n(define list-len (length Nat my-list))","Either Type":"(claim either-swap\n  (Pi ((A U) (B U))\n    (-> (Either A B)\n        (Either B A))))\n\n(define either-swap\n  (lambda (A B)\n    (lambda (e)\n      (ind-Either e\n        (lambda (x) (Either B A))\n        (lambda (a) (right a))\n        (lambda (b) (left b))))))\n\n(claim test-either (Either Nat Nat))\n(define test-either (left zero))\n\n(claim swapped (Either Nat Nat))\n(define swapped (either-swap Nat Nat test-either))","Vector Map":"(claim vec-map\n  (Π ((A U) (B U) (n Nat))\n     (-> (-> A B) (Vec A n)\n         (Vec B n))))\n\n(define vec-map\n  (λ (A B n)\n    (λ (f vs)\n      (ind-Vec n vs\n        (λ (k xs) (Vec B k))\n        vecnil\n        (λ (k x xs ih) (vec:: (f x) ih))))))\n\n(claim nat-vec (Vec Nat 3))\n(define nat-vec (vec:: 1 (vec:: 2 (vec:: 3 vecnil))))\n\n(claim add1-fn (-> Nat Nat))\n(define add1-fn (λ (n) (add1 n)))\n\n(claim incremented-vec (Vec Nat 3))\n(define incremented-vec (vec-map Nat Nat 3 add1-fn nat-vec))","Tactics: Even or Odd":"\n(claim +\n  (→ Nat Nat\n    Nat))\n\n(claim step-plus\n  (→ Nat\n    Nat))\n\n(define step-plus\n  (λ (n-1)\n    (add1 n-1 ) ))\n\n(define +\n  (λ (n j)\n    (iter-Nat n\n      j\n      step-plus )))\n\n(claim double\n  (→ Nat\n    Nat))\n\n(define double\n  (λ (n)\n    (iter-Nat n\n      0\n      (+ 2))))\n\n(claim Even\n  (→ Nat\n    U ))\n\n(define Even\n  (λ (n)\n    (Σ ((half Nat))\n      (= Nat n (double half )))))\n\n(claim Odd\n  (→ Nat\n    U ))\n\n(define Odd\n  (λ (n)\n    (Σ ((haf Nat))\n      (= Nat n (add1 (double haf )))))) \n\n(claim zero-is-even\n  (Even 0))\n\n(define zero-is-even\n  (cons 0\n    (same 0)))\n\n(claim add1-even->odd\n  (Π ((n Nat))\n    (→ (Even n)\n    (Odd (add1 n)))))\n\n(define add1-even->odd\n  (λ (n en)\n    (cons (car en)\n    (cong (cdr en) (+ 1)))))\n\n(claim add1-odd->even\n  (Π ((n Nat))\n    (→ (Odd n)\n      (Even (add1 n)))))\n\n(define add1-odd->even\n  (λ (n on)\n    (cons (add1 (car on))\n      (cong (cdr on) (+ 1)))))\n\n(claim even-or-odd\n  (Π ((n Nat))\n    (Either (Even n) (Odd n))))\n\n;; This is the proof in The Little Typer\n;; (claim mot-even-or-odd\n;;   (→ Nat U )) \n\n;; (define mot-even-or-odd\n;;   (λ (k) (Either (Even k) (Odd k))))\n\n;; (claim step-even-or-odd\n;;   (Π ((n-1 Nat))\n;;      (→ (mot-even-or-odd n-1)\n;;      (mot-even-or-odd (add1 n-1)))))\n\n;; (define step-even-or-odd\n;;   (λ (n-1)\n;;     (λ (e-or-on-1)\n;;        (ind-Either e-or-on-1\n;;     (λ (e-or-on-1)\n;;        (mot-even-or-odd (add1 n-1)))\n;;        (λ (en-1)\n;;          (right\n;;            (add1-even->odd\n;;              n-1 en-1)))\n;;        (λ (on-1)\n;;          (left\n;;            (add1-odd->even\n;;              n-1 on-1)))))))\n\n;; (define even-or-odd\n;;   (λ (n)\n;;     (ind-Nat n\n;;        mot-even-or-odd\n;;        (left zero-is-even)\n;;        step-even-or-odd)))\n\n\n;; This is the proof using our new tactic system\n(define-tactically even-or-odd\n  ((intro n)\n  (elim-Nat n)\n  (then\n    (exact (left zero-is-even)))\n  (then\n    (intro n-1)\n    (intro e-or-on-1)\n    (elim-Either e-or-on-1)\n    (then\n      (intro xr)\n      (go-Right)\n      (exact (add1-even->odd n-1 xr)))\n    (then\n      (intro xl)\n      (go-Left)\n      (exact (add1-odd->even n-1 xl))))))","Inductive Type: Less Than":";; Define Less Than relation using our new inductive type definiton\n    (data Less-Than () ((j Nat) (k Nat))\n      (zero-smallest ((n Nat)) (Less-Than () (zero (add1 n))))\n      (add1-smaller ((j Nat) (k Nat) (j<k (Less-Than () (j k)))) (Less-Than () ((add1 j) (add1 k))))\n      ind-Less-Than)\n\n    (claim proof-0<1 (Less-Than () (zero (add1 zero))))\n    (define proof-0<1 (zero-smallest zero))\n\n    (claim proof-1<2 (Less-Than () ((add1 zero) (add1 (add1 zero)))))\n    (define proof-1<2 (add1-smaller zero (add1 zero) proof-0<1))\n\n    (claim extract-smaller\n      (Pi ((j Nat) (k Nat))\n        (-> (Less-Than () (j k)) Nat)))\n    (define extract-smaller\n      (lambda (j k proof)\n        (ind-Less-Than proof\n          (lambda (j-idx k-idx p) Nat)\n          (lambda (n) zero)\n          (lambda (j-arg k-arg j<k-arg ih) (add1 ih)))))\n\n    (claim result Nat)\n    (define result (extract-smaller zero (add1 zero) proof-0<1))\n    ","Inductive Type: Subtype":"\n(data Subtype () ((T1 U) (T2 U))\n  (refl ((T U))\n    (Subtype () (T T)))\n  (trans ((T1 U) (T2 U) (T3 U)\n          (p1 (Subtype () (T1 T2)))\n          (p2 (Subtype () (T2 T3))))\n    (Subtype () (T1 T3)))\n  ;; Generic injection: if there exists a function A -> B, then A <: B\n  (inject ((A U) (B U) (f (-> A B)))\n    (Subtype () (A B)))\n  ind-Subtype)\n\n(claim coerce\n  (Pi ((A U) (B U))\n    (-> (Subtype () (A B)) A B)))\n(define coerce\n  (lambda (A B proof val)\n    ((ind-Subtype proof\n      (lambda (t1 t2 sub) (-> t1 t2))\n      (lambda (TT x) x)\n      (lambda (T11 T22 T33 p1 p2 ih1 ih2 x)\n        (ih2 (ih1 x)))\n      (lambda (AA BB ff x) (ff x))\n      )\n      val)))\n\n(data Even () ((n Nat))\n  (zero-even ()\n    (Even () (zero)))\n  (add2-even ((k Nat) (k-even (Even () (k))))\n    (Even () ((add1 (add1 k)))))\n  ind-Even)\n\n(claim even-to-nat\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define even-to-nat\n  (lambda (n proof)\n    (ind-Even proof\n      (lambda (m ev) Nat)\n      zero\n      (lambda (k prev ih) (add1 (add1 ih))))))\n\n(claim even-subtype-nat\n  (Pi ((n Nat))\n    (Subtype () ((Even () (n)) Nat))))\n(define even-subtype-nat\n  (lambda (n)\n    (inject (Even () (n)) Nat (even-to-nat n))))\n\n(claim + (-> Nat Nat Nat))\n(define +\n  (lambda (a b)\n    (rec-Nat a\n      b\n      (lambda (pred ih) (add1 ih)))))\n\n(claim double (-> Nat Nat))\n(define double\n  (lambda (n)\n    (+ n n)))\n\n;; Use Even with double\n(claim double-even\n  (Pi ((n Nat))\n    (-> (Even () (n)) Nat)))\n(define double-even\n  (lambda (n ev)\n    (double (coerce (Even () (n)) Nat\n                    (even-subtype-nat n)\n                    ev))))\n\n\n(claim even-four (Even () ((add1 (add1 (add1 (add1 zero)))))))\n(define even-four\n  (add2-even (add1 (add1 zero))\n    (add2-even zero\n      (zero-even))))\n\n(claim result2 Nat)\n(define result2 (double-even (add1 (add1 (add1 (add1 zero)))) even-four))\n        "},t=n["Hello World"],i=document.getElementById("preview-summary"),a=document.getElementById("preview-output");let o=null,r=null,s=null;function d(e,n="neutral"){i&&(i.textContent=e,i.dataset.tone=n)}function l(e,n){n?a.dataset.tone=n:delete a.dataset.tone,a.textContent=void 0===e?"Program is empty.":e}function c(e){if(!("Worker"in window))return d("Diagnostics unavailable in this browser.","warning"),null;const n=new Worker("diagnostics-worker.js",{type:"module"});return n.onmessage=n=>{const{type:t,payload:i}=n.data;"diagnostics"===t&&s&&function(e,n,t){const{diagnostics:i,pretty:a}=t,o=n.getModel();if(!o)return;const r=i.map(n=>({startLineNumber:n.startLineNumber,startColumn:n.startColumn,endLineNumber:n.endLineNumber,endColumn:n.endColumn,message:n.message,severity:"warning"===n.severity?e.MarkerSeverity.Warning:e.MarkerSeverity.Error}));if(e.editor.setModelMarkers(o,"pie-playground",r),0===i.length)return d("SUCCESS","success"),void l(a?.trim()??void 0,"success");const s=i[0],c="warning"===s.severity?"warning":"error";d("warning"===c?"WARNING":"ERROR",c),l(`Line ${s.startLineNumber}, Col ${s.startColumn}\n${s.message}`,c)}(s,e,i)},n.onerror=e=>{console.error("Worker error event:",e),console.error("Error details:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno}),d("Diagnostics worker crashed.","error"),l(`Worker failed to load. Check browser console for details.\nError: ${e.message||"Unknown error"}`,"error")},n}function m(e,n){let t;return function(...i){window.clearTimeout(t),t=window.setTimeout(()=>e.apply(this,i),n)}}!async function(){window.require?(window.require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.55.1/min/vs"}}),window.require(["vs/editor/editor.main"],async()=>{s=window.monaco;const i=function(e){!function(e){e.languages.register({id:"pie"}),e.languages.setLanguageConfiguration("pie",{comments:{lineComment:";",blockComment:["#|","|#"]},brackets:[["(",")"]],autoClosingPairs:[{open:"(",close:")"}],surroundingPairs:[{open:"(",close:")"}],indentationRules:{increaseIndentPattern:/^\s*\(.*[^)]$/,decreaseIndentPattern:/^\s*\)/},onEnterRules:[{beforeText:/^\s*\(.*[^)]$/,action:{indentAction:e.languages.IndentAction.Indent}},{beforeText:/^\s*\(.*$/,afterText:/^\s*\)/,action:{indentAction:e.languages.IndentAction.IndentOutdent}},{beforeText:/^.*$/,afterText:/^\s*\)/,action:{indentAction:e.languages.IndentAction.Outdent}}]}),e.languages.setMonarchTokensProvider("pie",{defaultToken:"",tokenPostfix:".pie",keywords:["lambda","λ","Pi","Π","Sigma","Σ","define","claim","the","check-same","define-tactically","TODO","U","Nat","Atom","List","Vec","Either","zero","add1","nil","cons","car","cdr","ind-Nat","rec-Nat","iter-Nat","ind-List","rec-List","ind-Vec","rec-Vec","ind-=","replace","trans","cong","symm","same","left","right","ind-Either","vecnil","vec::","which-Nat","quote","Pair","Trivial","sole","::","Absurd","ind-Absurd","=","head","tail","Either","->","→"],operators:[],symbols:/[=><!~?:&|+\-*/^%]+/,tokenizer:{root:[{include:"@whitespace"},[/\((?:lambda|λ|Pi|Π|Sigma|Σ|define|claim|the|check-same|define-tactically)\b/,"keyword"],[/[a-zA-Z][a-zA-Z0-9\-_!?*+=<>λΠΣ→]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d+/,"number"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string"],[/'[a-zA-Z][a-zA-Z0-9\-_!?*+=<>]*/,"string.quoted"],[/[()[\]]/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}]],whitespace:[[/[ \t\r\n]+/,"white"],[/;.*$/,"comment"],[/#\|/,"comment","@comment"]],comment:[[/[^#|]+/,"comment"],[/\|#/,"comment","@pop"],[/[#|]/,"comment"]],string:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]]}})}(e);const n=e.editor.create(document.getElementById("editor"),{value:t,language:"pie",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},scrollbar:{vertical:"auto",horizontal:"auto",useShadows:!1,verticalScrollbarSize:6,verticalSliderSize:4},padding:{top:16},fontSize:14,fontFamily:"Menlo, 'Fira Code', 'JetBrains Mono', monospace",smoothScrolling:!0});l(t.trim()),d("Ready for analysis.","neutral");const i=m(e=>{0===e.trim().length?(d("Waiting for input…","neutral"),l(void 0)):(d("Running checks…","warning"),l("Analyzing…"))},120),a=m(e=>{d("Running checks…","warning"),o&&o.postMessage({type:"analyze",payload:{source:e}})},220);return n.onDidChangeModelContent(()=>{const e=n.getValue();i(e),a(e)}),n}(s);o=c(i),function(e){const t=document.getElementById("example-picker");t&&(Object.keys(n).forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}),t.value="Hello World",t.addEventListener("change",t=>{const i=t.target.value;i&&n[i]&&e.setValue(n[i])}))}(i),s&&await async function(n,t){try{r&&r.isRunning()&&await r.stop(),r=new e(n,t),await r.start(),console.log("LSP client initialized successfully")}catch(e){console.error("Failed to initialize LSP client:",e),d("LSP features unavailable","warning")}}(s,i),o&&o.postMessage({type:"analyze",payload:{source:i.getValue()}}),window.__pieEditor=i})):console.error("Monaco loader not available")}();
//# sourceMappingURL=app.js.map
